<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin — Join Requests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Tailwind + Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <!-- Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- School context -->
    <script src="../somapappv1multischool/js/context.js"></script>
  </head>

  <body class="bg-slate-100 p-4">
    <h1 class="text-2xl font-bold mb-4">
      <i class="fas fa-user-check mr-2"></i>Student Join Requests
    </h1>
    <div class="flex gap-2 mb-4">
      <button
        class="filter-btn bg-slate-800 text-white px-3 py-1 rounded"
        data-filter="all"
      >
        All
      </button>

      <button
        class="filter-btn bg-indigo-600 text-white px-3 py-1 rounded"
        data-filter="referred"
      >
        Parent Referred
      </button>

      <button
        class="filter-btn bg-gray-500 text-white px-3 py-1 rounded"
        data-filter="direct"
      >
        Direct / Public
      </button>
    </div>

    <div id="list" class="space-y-4"></div>

    <script>
      /* ---------------- Firebase Init ---------------- */
      let activeFilter = "all";
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };

      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          activeFilter = btn.dataset.filter;

          document
            .querySelectorAll(".filter-btn")
            .forEach((b) => b.classList.remove("ring", "ring-2", "ring-white"));

          btn.classList.add("ring", "ring-2", "ring-white");

          // Force re-render
          schoolRef("joinApprovalsPending").once("value").then(renderList);
        });
      });

      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      function schoolRef(path) {
        return db.ref(SOMAP.P(path));
      }

      /* ---------------- Load Pending Join Requests ---------------- */
      const listEl = document.getElementById("list");

      schoolRef("joinApprovalsPending").on("value", renderList);

      function renderList(snap) {
        listEl.innerHTML = "";
        const data = snap.val() || {};

        Object.entries(data).forEach(([key, r]) => {
          if (r.approvalType !== "JOIN_REQUEST" || r.status !== "pending")
            return;

          const isReferred = !!r.referral?.code;
          if (activeFilter === "referred" && !isReferred) return;
          if (activeFilter === "direct" && isReferred) return;

          const card = document.createElement("div");
          card.className = "bg-white rounded shadow p-4";

          card.innerHTML = `
      <div class="flex justify-between">
        <div>
          <h3 class="font-semibold text-lg">
            ${r.studentSnapshot.firstName} ${r.studentSnapshot.lastName}
          </h3>
          <p class="text-sm text-gray-600">
            Class: ${r.studentSnapshot.classLevel} | Year: ${r.academicYear}
          </p>
          <p class="text-sm">
            Parent: ${r.parentSnapshot.name} (${r.parentSnapshot.phone})
          </p>
          ${
            r.referral?.code
              ? `<p class="text-xs text-indigo-600">
                  <i class="fas fa-link mr-1"></i>
                  Referral (Parent): ${r.referral.code}
                </p>`
              : `<p class="text-xs text-gray-400 italic">
                  Direct / Public Join
                </p>`
          }
        </div>
        <div class="flex gap-2">
          <button class="approve bg-green-600 text-white px-3 py-1 rounded"
            data-key="${key}">
            <i class="fas fa-check"></i> Approve
          </button>
          <button class="reject bg-yellow-500 text-white px-3 py-1 rounded"
            data-key="${key}">
            <i class="fas fa-ban"></i> Reject
          </button>
          <button class="delete bg-red-600 text-white px-3 py-1 rounded"
            data-key="${key}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `;

          listEl.appendChild(card);
        });

        attachActions();
      }
      /* ---------------- Actions ---------------- */
      function attachActions() {
        document.querySelectorAll(".approve").forEach((btn) => {
          btn.onclick = async () => {
            const key = btn.dataset.key;
            approveRequest(key);
          };
        });

        document.querySelectorAll(".reject").forEach((btn) => {
          btn.onclick = async () => {
            const key = btn.dataset.key;
            await schoolRef(`joinApprovalsPending/${key}`).update({
              status: "rejected",
              updatedAt: Date.now(),
            });
            Swal.fire("Rejected", "Request marked as rejected.", "info");
          };
        });

        document.querySelectorAll(".delete").forEach((btn) => {
          btn.onclick = async () => {
            const key = btn.dataset.key;
            const ok = confirm("Delete this join request?");
            if (!ok) return;
            await schoolRef(`joinApprovalsPending/${key}`).remove();
          };
        });
      }
      async function resolveParentByReferralCode(referralCode) {
        if (!referralCode) return null;

        const snap = await schoolRef("parents")
          .orderByChild("referralCode")
          .equalTo(referralCode)
          .once("value");

        if (!snap.exists()) return null;

        const parentNode = Object.values(snap.val())[0];
        return parentNode.phone || null;
      }

      /* ---------------- Approve Logic ---------------- */
      async function approveRequest(key) {
        const snap = await schoolRef(`joinApprovalsPending/${key}`).get();
        if (!snap.exists()) return;

        const r = snap.val();

        const studentRef = schoolRef("students").push();
        const studentId = studentRef.key;

        // Resolve referral (if any)
        let referredByParentPhone = null;

        if (r.referral?.code) {
          referredByParentId = await resolveParentByReferralCode(
            r.referral.code
          );
        }

        // Save student
        await studentRef.set({
          firstName: r.studentSnapshot.firstName,
          lastName: r.studentSnapshot.lastName,
          classLevel: r.studentSnapshot.classLevel,
          academicYear: r.academicYear,

          parent: {
            name: r.parentSnapshot.name,
            phone: r.parentSnapshot.phone,
          },

          referral: r.referral?.code
            ? {
                code: r.referral.code,
                referredByPhone: referredByParentId,
                resolved: !!referredByParentId,
              }
            : null,

          createdAt: Date.now(),
          source: "join-approval",
        });

        // If referral resolved → add to parent's referral list
        if (referredByParentId) {
          await schoolRef(
            `parentReferrals/${referredByParentId}/${studentId}`
          ).set({
            studentName:
              r.studentSnapshot.firstName + " " + r.studentSnapshot.lastName,
            classLevel: r.studentSnapshot.classLevel,
            academicYear: r.academicYear,
            joinedAt: Date.now(),
          });
        }

        await schoolRef(`joinApprovalsPending/${key}`).update({
          status: "approved",
          studentId,
          approvedAt: Date.now(),
        });

        Swal.fire("Approved", "Student added successfully.", "success");
      }
    </script>
  </body>
</html>
