<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin â€” Join Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind + Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- School context -->
  <script src="../somapappv1multischool/js/context.js"></script>
</head>

<body class="bg-slate-100 p-4">

  <h1 class="text-2xl font-bold mb-4">
    <i class="fas fa-user-check mr-2"></i>Student Join Requests
  </h1>

  <div id="list" class="space-y-4"></div>

<script>
/* ---------------- Firebase Init ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
  authDomain: "somaptestt.firebaseapp.com",
  databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
  projectId: "somaptestt",
  storageBucket: "somaptestt.appspot.com",
  messagingSenderId: "105526245138",
  appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function schoolRef(path){
  return db.ref(SOMAP.P(path));
}

/* ---------------- Load Pending Join Requests ---------------- */
const listEl = document.getElementById("list");

schoolRef("joinApprovalsPending").on("value", snap => {
  listEl.innerHTML = "";
  const data = snap.val() || {};

  Object.entries(data).forEach(([key, r]) => {
    if (r.approvalType !== "JOIN_REQUEST" || r.status !== "pending") return;

    const card = document.createElement("div");
    card.className = "bg-white rounded shadow p-4";

    card.innerHTML = `
      <div class="flex justify-between">
        <div>
          <h3 class="font-semibold text-lg">
            ${r.studentSnapshot.firstName} ${r.studentSnapshot.lastName}
          </h3>
          <p class="text-sm text-gray-600">
            Class: ${r.studentSnapshot.classLevel} | Year: ${r.academicYear}
          </p>
          <p class="text-sm">
            Parent: ${r.parentSnapshot.name} (${r.parentSnapshot.phone})
          </p>
          ${r.referral?.code ? `<p class="text-xs text-indigo-600">Referral: ${r.referral.code}</p>` : ""}
        </div>
        <div class="flex gap-2">
          <button class="approve bg-green-600 text-white px-3 py-1 rounded"
            data-key="${key}">
            <i class="fas fa-check"></i> Approve
          </button>
          <button class="reject bg-yellow-500 text-white px-3 py-1 rounded"
            data-key="${key}">
            <i class="fas fa-ban"></i> Reject
          </button>
          <button class="delete bg-red-600 text-white px-3 py-1 rounded"
            data-key="${key}">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    `;

    listEl.appendChild(card);
  });

  attachActions();
});

/* ---------------- Actions ---------------- */
function attachActions(){

  document.querySelectorAll(".approve").forEach(btn=>{
    btn.onclick = async ()=>{
      const key = btn.dataset.key;
      approveRequest(key);
    };
  });

  document.querySelectorAll(".reject").forEach(btn=>{
    btn.onclick = async ()=>{
      const key = btn.dataset.key;
      await schoolRef(`joinApprovalsPending/${key}`)
        .update({ status: "rejected", updatedAt: Date.now() });
      Swal.fire("Rejected","Request marked as rejected.","info");
    };
  });

  document.querySelectorAll(".delete").forEach(btn=>{
    btn.onclick = async ()=>{
      const key = btn.dataset.key;
      const ok = confirm("Delete this join request?");
      if (!ok) return;
      await schoolRef(`joinApprovalsPending/${key}`).remove();
    };
  });
}

/* ---------------- Approve Logic ---------------- */
async function approveRequest(key){
  const snap = await schoolRef(`joinApprovalsPending/${key}`).get();
  if (!snap.exists()) return;

  const r = snap.val();

  const studentRef = schoolRef("students").push();
  const studentId = studentRef.key;

  await studentRef.set({
    firstName: r.studentSnapshot.firstName,
    lastName: r.studentSnapshot.lastName,
    classLevel: r.studentSnapshot.classLevel,
    academicYear: r.academicYear,
    parentName: r.parentSnapshot.name,
    parentPhone: r.parentSnapshot.phone,
    referralCode: r.referral?.code || null,
    createdAt: Date.now(),
    source: "join-approval"
  });

  await schoolRef(`joinApprovalsPending/${key}`)
    .update({
      status: "approved",
      studentId,
      approvedAt: Date.now()
    });

  Swal.fire("Approved","Student added successfully.","success");
}
</script>

</body>
</html>
