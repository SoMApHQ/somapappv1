<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SoMAp â€” Student Join Form</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <!-- Alerts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- School context -->
    <script src="somapappv1multischool/js/context.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <style>
      body {
        min-height: 100vh;
        background: linear-gradient(180deg, #020617, #0b1220);
        color: #e5e7eb;
        font-family: Inter, system-ui, Arial;
      }
      .glass {
        background: rgba(15, 23, 42, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 1rem;
      }
      input,
      select {
        background: #020617;
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 0.5rem;
        padding: 0.6rem;
        color: #fff;
        width: 100%;
      }
      label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: #94a3b8;
      }
      .btn {
        background: linear-gradient(120deg, #6366f1, #0ea5e9);
        padding: 0.8rem;
        border-radius: 0.75rem;
        font-weight: 700;
      }
      textarea {
        background: #020617;
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 0.5rem;
        padding: 0.6rem;
        color: #fff;
        width: 100%;
      }
    </style>
  </head>

  <body class="p-4 md:p-8">
    <main class="max-w-4xl mx-auto space-y-6">
      <!-- HEADER -->
      <section class="glass p-6 relative">
        <div class="mb-4 md:mb-0 md:absolute md:right-6 md:top-6">
          <select
            id="langSwitcher"
            class="bg-slate-900 border border-slate-600 rounded-md px-3 py-1 text-sm"
          >
            <option value="sw">Kiswahili</option>
            <option value="en">English</option>
          </select>
        </div>

        <h1 class="text-3xl font-extrabold" data-i18n="title">
          Student Admission Request
        </h1>
        <p class="text-slate-300 mt-1" data-i18n="subtitle">
          Submit details below. Admission requires admin approval.
        </p>
      </section>

      <!-- DOWNLOAD -->
      <!-- <section class="glass p-6">
        <h2 class="font-bold mb-2" data-i18n="download_title">
          Download School Joining Form
        </h2>
        <p class="text-sm text-slate-300 mb-3" data-i18n="download_note">
          Download, fill manually, then upload the completed form below.
        </p>
      </section> -->

      <!-- FORM -->
      <form id="joinForm" class="glass p-6 space-y-6">
        <!-- STUDENT -->
        <section>
          <h2 class="font-bold mb-4" data-i18n="student_details">
            Student Details
          </h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label data-i18n="first_name"></label
              ><input id="firstName" required />
            </div>
            <div>
              <label data-i18n="last_name"></label
              ><input id="lastName" required />
            </div>
            <div>
              <label data-i18n="class_applying"></label>
              <select id="classLevel" required>
                <option value="">Select</option>
                <option>Baby Class</option>
                <option>Middle Class</option>
                <option>Pre Unit Class</option>
                <option>Class 1</option>
                <option>Class 2</option>
                <option>Class 3</option>
                <option>Class 4</option>
                <option>Class 5</option>
                <option>Class 6</option>
                <option>Class 7</option>
              </select>
            </div>
            <div>
              <label data-i18n="academic_year"></label
              ><input id="academicYear" value="2026" required />
            </div>
          </div>
          <div>
            <label data-i18n="Gender">Gender *</label>
            <select id="gender" required>
              <option value="">Select</option>
              <option data-i18n="Male_gender">Male</option>
              <option data-i18n="Female_gender">Female</option>
            </select>
          </div>

          <div>
            <label data-i18n="date_of_birth">Date of Birth *</label>
            <input type="date" id="dob" required />
          </div>

          <div>
            <label data-i18n="birth_certificate_no"
              >Birth Certificate Number *</label
            >
            <input id="birthCertNumber" />
          </div>

          <div class="md:col-span-2">
            <label data-i18n="residential_address">Residential Address *</label>
            <textarea id="residentialAddress"></textarea>
          </div>

          <div class="md:col-span-2">
            <label data-i18n="health_problem">Health Problem (optional)</label>
            <textarea id="healthProblem"></textarea>
          </div>
        </section>

        <!-- PARENT -->
        <section>
          <h2 class="font-bold mb-4" data-i18n="parent_details">
            Parent / Guardian
          </h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label data-i18n="parent_name"></label
              ><input id="parentName" required />
            </div>
            <div>
              <label data-i18n="phone_number"></label
              ><input id="parentPhone" required />
            </div>
          </div>
        </section>

        <!-- REFERRAL -->
        <section>
          <h2 class="font-bold mb-2" data-i18n="referral">Referral</h2>
          <label data-i18n="referral_code"></label>
          <input id="referralCode" />
        </section>

        <!-- DOCS -->
        <!-- DOCUMENTS -->
        <section>
          <h2 class="font-bold mb-4 text-white" data-i18n="documents">
            Documents
          </h2>

          <div class="grid md:grid-cols-2 gap-4">
            <!-- Passport Photo -->
            <div>
              <label data-i18n="doc_passport">Passport Photo *</label>
              <p
                class="text-xs text-slate-400 mb-1"
                data-i18n="doc_passport_help"
              >
                Recent passport-size photograph of the student
              </p>
              <input type="file" id="passportPhoto" accept="image/*" required />
            </div>

            <!-- Birth Certificate -->
            <div>
              <label data-i18n="doc_birth">Birth Certificate *</label>
              <p class="text-xs text-slate-400 mb-1" data-i18n="doc_birth_help">
                Copy of birth certificate (image or PDF)
              </p>
              <input
                type="file"
                id="birthCert"
                accept="image/*,application/pdf"
                required
              />
            </div>

            <!-- Report Card -->
            <div>
              <label data-i18n="doc_report">Previous Report Card *</label>
              <p
                class="text-xs text-slate-400 mb-1"
                data-i18n="doc_report_help"
              >
                Latest academic report from previous school
              </p>
              <input
                type="file"
                id="reportCard"
                accept="image/*,application/pdf"
                required
              />
            </div>

            <!-- Medical -->
            <div class="md:col-span-2">
              <label data-i18n="doc_medical"
                >Medical Documents (optional)</label
              >
              <p
                class="text-xs text-slate-400 mb-1"
                data-i18n="doc_medical_help"
              >
                Medical report or special health information (if any)
              </p>
              <input
                type="file"
                id="medicalDocs"
                accept="image/*,application/pdf"
              />
            </div>
          </div>
        </section>

        <button id="submitBtn" class="btn w-full text-lg" type="submit">
          <span data-i18n="submit"></span>
        </button>
      </form>
    </main>

    <script>
      /* ---------------- Firebase Init ---------------- */
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.database();

      /* School-safe ref */
      function schoolRef(path) {
        return db.ref(SOMAP.P(path));
      }

      /* Auto referral from URL */
      const refParam = new URLSearchParams(location.search).get("ref");
      if (refParam) {
        referralCode.value = refParam;
        referralCode.readOnly = true;
      }
      /* ===== FILE UPLOAD HELPER ===== */
      async function uploadFile(inputId, folder, joinId) {
        const el = document.getElementById(inputId);
        if (!el || !el.files.length) return null;

        const fd = new FormData();
        fd.append("file", el.files[0]);
        fd.append("upload_preset", "somap_unsigned");
        fd.append("folder", `joinRequests/${joinId}/${folder}`);

        const res = await fetch(
          "https://api.cloudinary.com/v1_1/dg7vnrkgd/auto/upload",
          { method: "POST", body: fd },
        );
        const json = await res.json();
        return json.secure_url || null;
      }

      function calcAge(dob) {
        if (!dob) return "";
        const diff = Date.now() - new Date(dob).getTime();
        return Math.floor(diff / (1000 * 60 * 60 * 24 * 365.25));
      }

     
      async function generateAnnexJoiningPDF(documents) {
        const officialPdfBytes = await fetch(
          "assets/Socrates_School_Joining_Form.pdf",
        ).then((res) => res.arrayBuffer());

        const officialPdf = await PDFLib.PDFDocument.load(officialPdfBytes);
        const newPdf = await PDFLib.PDFDocument.create();

        const officialPages = await newPdf.copyPages(
          officialPdf,
          officialPdf.getPageIndices(),
        );
        officialPages.forEach((p) => newPdf.addPage(p));

        const annexPage = newPdf.addPage([595, 842]);
        const font = await newPdf.embedFont(PDFLib.StandardFonts.Helvetica);
        function write(text, x, y, size = 11, underline = false) {
          const txt = String(text || "");
          annexPage.drawText(txt, { x, y, size, font });

          if (underline && txt) {
            const textWidth = font.widthOfTextAtSize(txt, size);
            annexPage.drawLine({
              start: { x, y: y - 2 },
              end: { x: x + textWidth, y: y - 2 },
              thickness: 1,
            });
          }
        }
        function drawLine(x, y, width) {
          annexPage.drawLine({
            start: { x, y },
            end: { x: x + width, y },
            thickness: 1,
          });
        }

        const fullName = `${firstName.value} ${lastName.value}`;
        const age = calcAge(dob.value);

        write("SOCRATES PRE AND PRIMARY SCHOOL", 150, 810, 14);
   

        write("1. MAELEZO YA MWANAFUNZI", 50, 740, 12);

    
        write("Jina:", 50, 710);
        drawLine(120, 708, 300);
        write(fullName, 120, 710);

        write("Jinsia:", 50, 690);
        drawLine(120, 688, 150);
        write(gender.value, 120, 690);

      
        write("Umri:", 50, 670);
        drawLine(120, 668, 100);
        write(age, 120, 670);

        write("Darasa:", 50, 650);
        drawLine(120, 648, 200);
        write(classLevel.value, 120, 650);

        write("Makazi:", 50, 630);
        drawLine(120, 628, 300);
        write(residentialAddress.value, 120, 630);


        write("Birth Cert No:", 50, 610);
        drawLine(160, 608, 250);
        write(birthCertNumber.value, 160, 610);


        write("Tatizo la Kiafya:", 50, 590);
        drawLine(200, 588, 250);
        write(healthProblem.value || "Hakuna", 200, 590);

        // Student Passport Photo (PNG + JPG)
        if (documents.passportPhotoUrl) {
          const imgBytes = await fetch(documents.passportPhotoUrl).then((r) =>
            r.arrayBuffer(),
          );
          let img;

          try {
            img = await newPdf.embedJpg(imgBytes);
          } catch {
            img = await newPdf.embedPng(imgBytes);
          }

          annexPage.drawImage(img, { x: 400, y: 650, width: 120, height: 120 });
        }
        if (documents.passportPhotoUrl) {
          const imgBytes = await fetch(documents.passportPhotoUrl).then((r) =>
            r.arrayBuffer(),
          );
          let img;
          try {
            img = await newPdf.embedJpg(imgBytes);
          } catch {
            img = await newPdf.embedPng(imgBytes);
          }

          annexPage.drawImage(img, { x: 400, y: 650, width: 120, height: 120 });
        }

        write("2. MAELEZO YA MZAZI / MLEZI", 50, 540, 12);
        write(`Jina: ${parentName.value}`, 50, 510);
        write(`Simu: ${parentPhone.value}`, 50, 490);

        write("3. KIAPO CHA MZAZI / MLEZI", 50, 450, 12);
        annexPage.drawText(
          `Mimi mzazi/mlezi wa ${fullName} nimeridhia mwanangu kujiunga na shule ya Socrates Pre and Primary School.`,
          { x: 50, y: 420, size: 11, font, maxWidth: 500 },
        );

        write("Jina: ____________________", 50, 360);
        write("Sahihi: ____________________", 50, 330);
        write("Tarehe: ____________________", 50, 300);

        const pdfBytes = await newPdf.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });

        // Auto-download for parent
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Socrates_Joining_Form_${fullName}.pdf`;
        link.click();

        // Return blob for upload
        return blob;
      }
      /* ===== Upload Generated PDF to Cloudinary ===== */
      async function uploadGeneratedPdf(pdfBlob, joinId) {
        const fd = new FormData();
        fd.append("file", pdfBlob);
        fd.append("upload_preset", "somap_unsigned");
        fd.append("folder", `joinRequests/${joinId}/generatedForm`);

        const res = await fetch(
          "https://api.cloudinary.com/v1_1/dg7vnrkgd/auto/upload",
          { method: "POST", body: fd },
        );

        const json = await res.json();
        return json.secure_url;
      }

      /* Submit */
      joinForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (submitBtn.dataset.submitting === "true") return;
        submitBtn.dataset.submitting = "true";
        submitBtn.disabled = true;

        //  LOADING POPUP
        Swal.fire({
          title: "Submitting Application",
          text: "Generating official joining form. Please wait...",
          allowOutsideClick: false,
          allowEscapeKey: false,
          didOpen: () => Swal.showLoading(),
        });

        try {
          const joinRef = db.ref("joinApprovalsPending").push();
          const joinId = joinRef.key;

          // Upload files
          const documents = {
            passportPhotoUrl: await uploadFile(
              "passportPhoto",
              "passport",
              joinId,
            ),
            birthCertUrl: await uploadFile("birthCert", "birthCert", joinId),
            reportCardUrl: await uploadFile("reportCard", "reportCard", joinId),
            medicalDocsUrl: await uploadFile("medicalDocs", "medical", joinId),
          };

          // Generate PDF + download for parent
          const generatedPdfBlob = await generateAnnexJoiningPDF(documents);

          // Upload generated PDF
          const joiningPdfUrl = await uploadGeneratedPdf(
            generatedPdfBlob,
            joinId,
          );
          documents.joiningLetterUrl = joiningPdfUrl; //

          // Save Firebase record
          await joinRef.set({
            approvalType: "JOIN_REQUEST",
            status: "pending",
            academicYear: academicYear.value.trim(),

            studentSnapshot: {
              firstName: firstName.value.trim(),
              lastName: lastName.value.trim(),
              gender: gender.value,
              dob: dob.value,
              birthCertNumber: birthCertNumber.value.trim(),
              residentialAddress: residentialAddress.value.trim(),
              healthProblem: healthProblem.value.trim(),
              classLevel: classLevel.value,
            },

            parentSnapshot: {
              name: parentName.value.trim(),
              phone: parentPhone.value.trim(),
            },

            referral: referralCode.value
              ? {
                  code: referralCode.value.trim(),
                  referredByParentId: null,
                  resolved: false,
                }
              : null,

            documents,

            source: {
              channel: referralCode.value ? "parent-referral" : "public",
              submittedVia: "join.html",
            },

            createdAt: Date.now(),
            updatedAt: Date.now(),
          });

          joinForm.reset();

          // SUCCESS POPUP
          Swal.fire({
            icon: "success",
            title: "Submitted Successfully",
            html: "Application sent to school.<br><b>Official Joining Form Generated & Downloaded.</b>",
            confirmButtonText: "OK",
          }).then(() => location.reload());
        } catch (err) {
          console.error("JOIN ERROR:", err);

          Swal.fire({
            icon: "error",
            title: "Submission Failed",
            text: err.message || "Could not submit application.",
          });

          submitBtn.disabled = false;
        }
      });

      /* ---------------- i18n ---------------- */
      const i18n = {
        en: {
          title: "Student Admission Request",
          subtitle:
            "Welcome! Please complete the form below to initiate the admission process. Submitted applications will be reviewed by the school, and further guidance will be provided accordingly.",

          download_title: "Download School Joining Form",
          download_note:
            "The system will automatically generate the official joining form after submission.",
          download_btn: "Download School Form",
          student_details: "Student Details",
          parent_details: "Parent / Guardian",
          referral: "Referral",
          documents: "Documents",
          first_name: "First Name *",
          last_name: "Last Name *",
          class_applying: "Class Applying *",
          academic_year: "Academic Year *",
          parent_name: "Parent Name *",
          phone_number: "Phone Number *",
          referral_code: "Referral Code (optional)",
          submit: "Submit Application",
          doc_passport: "Passport Photo *",
          doc_passport_help: "Recent passport-size photograph of the student",

          doc_birth: "Birth Certificate *",
          doc_birth_help: "Copy of birth certificate (image or PDF)",

          doc_report: "Previous Report Card *",
          doc_report_help: "Latest academic report from previous school",

          doc_joining: "Completed School Joining Form *",
          doc_joining_help:
            "Download, fill, sign, and upload the official school form",

          doc_medical: "Medical Documents (optional)",
          doc_medical_help:
            "Medical report or special health information (if any)",
        },
        gender: "Gender",
        Male_gender: "Male",
        Female_gender: "Female",
        birth_certificate_no: "Birth Certificate Number",
        residential_address: "Residential Address",
        health_problem: "Health Problem",
        sw: {
          title: "Ombi la Kujiunga na Shule",
          subtitle:
            "Karibu! Tafadhali jaza fomu hii kuanzisha mchakato wa udahili. Maombi yaliyowasilishwa yatapitiwa na shule, na maelekezo zaidi yatatolewa kadri inavyohitajika.",

          download_title: "Pakua Fomu ya Kujiunga",
          download_note: "Pakua, jaza, kisha pakia fomu.",
          download_btn: "Pakua Fomu",
          student_details: "Taarifa za Mwanafunzi",
          parent_details: "Mzazi / Mlezi",
          referral: "Rufaa",
          documents: "Nyaraka",
          first_name: "Jina la Kwanza *",
          last_name: "Jina la Mwisho *",
          class_applying: "Darasa *",
          academic_year: "Mwaka *",
          parent_name: "Jina la Mzazi *",
          phone_number: "Simu *",
          referral_code: "Msimbo wa Rufaa",
          submit: "Tuma Ombi",
          doc_passport: "Picha ya Pasipoti *",
          doc_passport_help:
            "Picha ya hivi karibuni ya mwanafunzi (saizi ya pasipoti)",

          doc_birth: "Cheti cha Kuzaliwa *",
          doc_birth_help: "Nakala ya cheti cha kuzaliwa (picha au PDF)",

          doc_report: "Ripoti ya Masomo ya Awali *",
          doc_report_help: "Ripoti ya mwisho kutoka shule ya awali",

          doc_joining: "Fomu ya Kujiunga na Shule Iliyokamilika *",
          doc_joining_help:
            "Pakua, jaza, saini, kisha pakia fomu rasmi ya shule",

          doc_medical: "Nyaraka za Afya (hiari)",
          doc_medical_help: "Ripoti ya afya au taarifa maalum (ikiwa ipo)",
          gender: "Jinsia",
          Male_gender: "Wakiume",
          Female_gender: "Wakike",
          birth_certificate_no: "Namba Ya Cheti Chakuzaliwa",
          residential_address: "Makazi",
          health_problem: "Tatizo La Kiafya",
        },
      };
      function applyLang(l) {
        document.querySelectorAll("[data-i18n]").forEach((e) => {
          const k = e.dataset.i18n;
          if (i18n[l][k]) e.textContent = i18n[l][k];
        });
        localStorage.setItem("joinLang", l);
      }
      const saved = localStorage.getItem("joinLang") || "sw";
      langSwitcher.value = saved;
      applyLang(saved);
      langSwitcher.onchange = (e) => applyLang(e.target.value);
    </script>
  </body>
</html>
