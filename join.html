<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp â€” Student Join Form</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- School context -->
  <script src="somapappv1multischool/js/context.js"></script>

  <style>
    body{
      min-height:100vh;
      background:linear-gradient(180deg,#020617,#0b1220);
      color:#e5e7eb;
      font-family:Inter,system-ui,Arial;
    }
    .glass{background:rgba(15,23,42,.85);border:1px solid rgba(148,163,184,.25);border-radius:1rem;}
    input,select,textarea{background:#020617;border:1px solid rgba(148,163,184,.3);border-radius:.5rem;padding:.6rem;color:#fff;width:100%}
    label{font-size:.7rem;text-transform:uppercase;letter-spacing:.12em;color:#94a3b8}
    .btn{background:linear-gradient(120deg,#6366f1,#0ea5e9);padding:.8rem;border-radius:.75rem;font-weight:700}
  </style>
</head>

<body class="p-4 md:p-8">

<main class="max-w-4xl mx-auto space-y-6">

  <section class="glass p-6">
    <h1 class="text-3xl font-extrabold text-white">Student Admission Request</h1>
    <p class="text-slate-300 mt-1">Submit details below. Admission requires admin approval.</p>
  </section>

  <form id="joinForm" class="glass p-6 space-y-6">

    <!-- STUDENT -->
    <section>
      <h2 class="font-bold mb-4 text-white">Student Details</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label>First Name *</label>
          <input id="firstName" name="firstName" required>
        </div>
        <div>
          <label>Last Name *</label>
          <input id="lastName" name="lastName" required>
        </div>
        <div>
          <label>Class Applying *</label>
          <select id="classLevel" name="classLevel" required>
            <option value="">Select</option>
            <option>Baby Class</option>
            <option>Middle Class</option>
            <option>Pre Unit Class</option>
            <option>Class 1</option>
            <option>Class 2</option>
            <option>Class 3</option>
            <option>Class 4</option>
            <option>Class 5</option>
            <option>Class 6</option>
            <option>Class 7</option>
          </select>
        </div>
        <div>
          <label>Academic Year *</label>
          <input id="academicYear" name="academicYear" value="2026" required>
        </div>
      </div>
    </section>

    <!-- PARENT -->
    <section>
      <h2 class="font-bold mb-4 text-white">Parent / Guardian</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label>Parent Name *</label>
          <input id="parentName" name="parentName" required>
        </div>
        <div>
          <label>Phone Number *</label>
          <input id="parentPhone" name="parentPhone" required>
        </div>
      </div>
    </section>

    <!-- REFERRAL -->
    <section>
      <h2 class="font-bold mb-2 text-white">Referral</h2>
      <label>Referral Code (optional)</label>
      <input id="referralCode" name="referralCode" placeholder="Auto-filled if link used">
    </section>

    <!-- DOCUMENTS -->
    <section>
      <h2 class="font-bold mb-4 text-white">Documents</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label>Passport Photo *</label>
          <input type="file" id="passportPhoto" accept="image/*" required>
        </div>
        <div>
          <label>Birth Certificate *</label>
          <input type="file" id="birthCert" accept="image/*,application/pdf" required>
        </div>
        <div>
          <label>Report Card *</label>
          <input type="file" id="reportCard" accept="image/*,application/pdf" required>
        </div>
        <div>
          <label>Joining Letter *</label>
          <input type="file" id="joiningLetter" accept="image/*,application/pdf" required>
        </div>
        <div class="md:col-span-2">
          <label>Medical Documents (optional)</label>
          <input type="file" id="medicalDocs" accept="image/*,application/pdf">
        </div>
      </div>
    </section>

    <button id="submitJoin" class="btn w-full text-lg text-white" type="submit">
      <i class="fas fa-paper-plane mr-2"></i>Submit Application
    </button>

  </form>
</main>

<script>
/* ---------------- Firebase Init ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
  authDomain: "somaptestt.firebaseapp.com",
  databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
  projectId: "somaptestt",
  storageBucket: "somaptestt.appspot.com",
  messagingSenderId: "105526245138",
  appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
};

if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();
window.db = db;

/* ---------------- Helpers ---------------- */
function schoolRef(path){ return db.ref(SOMAP.P(path)); }

const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dg7vnrkgd/auto/upload";
const CLOUDINARY_PRESET = "somap_unsigned";

/* Auto referral */
const params = new URLSearchParams(window.location.search);
const ref = params.get("ref");
if (ref){
  referralCode.value = ref;
  referralCode.readOnly = true;
}

/* Upload */
async function uploadFile(inputId, folder, key){
  const el = document.getElementById(inputId);
  if (!el || !el.files.length) return null;
  const fd = new FormData();
  fd.append("file", el.files[0]);
  fd.append("upload_preset", CLOUDINARY_PRESET);
  fd.append("folder", `joiningDocs/${key}/${folder}`);
  const r = await fetch(CLOUDINARY_URL,{method:"POST",body:fd});
  const j = await r.json();
  return j.secure_url || null;
}

/* Referral validation */
async function resolveReferral(code){
  if (!code) return null;
  const snap = await db.ref(`parentsIndex/referralCodes/${code}`).get();
  return snap.exists() ? snap.val() : null;
}

/* Duplicate merge */
async function findDuplicate(phone, classLevel, year){
  const snap = await schoolRef("approvalsPending").get();
  const all = snap.val() || {};
  for (const [id,r] of Object.entries(all)){
    if (
      r.approvalType==="JOIN_REQUEST" &&
      r.parentSnapshot?.phone===phone &&
      r.studentSnapshot?.classLevel===classLevel &&
      r.academicYear===year
    ) return id;
  }
  return null;
}

/* Submit */
joinForm.addEventListener("submit", async e=>{
  e.preventDefault();
  submitJoin.disabled = true;

  try{
    const year = academicYear.value.trim();
    const cls = classLevel.value;
    const phone = parentPhone.value.trim();

    const refCode = referralCode.value.trim() || null;
    const referredBy = refCode ? await resolveReferral(refCode) : null;

    const dup = await findDuplicate(phone,cls,year);
    const refNode = dup ? schoolRef(`approvalsPending/${dup}`) : schoolRef("approvalsPending").push();
    const key = refNode.key;
    const now = Date.now();

    const docs = {
      passportPhotoUrl: await uploadFile("passportPhoto","passport",key),
      birthCertUrl: await uploadFile("birthCert","birthCert",key),
      reportCardUrl: await uploadFile("reportCard","reportCard",key),
      joiningLetterUrl: await uploadFile("joiningLetter","joiningLetter",key),
      medicalDocsUrl: await uploadFile("medicalDocs","medical",key)
    };

    await refNode.update({
      approvalType:"JOIN_REQUEST",
      status:"pending",
      academicYear:year,
      ...(dup?{}:{createdAt:now}),
      updatedAt:now,
      studentSnapshot:{
        firstName:firstName.value.trim(),
        lastName:lastName.value.trim(),
        classLevel:cls
      },
      parentSnapshot:{
        name:parentName.value.trim(),
        phone
      },
      referral:{
        code:refCode,
        referredBy:referredBy||null,
        verified:Boolean(referredBy)
      },
      documents:docs,
      source:{channel:referredBy?"parent-referral":"public",submittedVia:"join.html"}
    });

    Swal.fire("Submitted","Application sent for review.","success")
      .then(()=>location.reload());

  }catch(err){
    console.error(err);
    Swal.fire("Error","Submission failed.","error");
    submitJoin.disabled=false;
  }
});
</script>

</body>
</html>
