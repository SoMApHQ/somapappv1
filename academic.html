<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Academics & Exams</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase compat (v9 compat libs) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <!-- Your Firebase config wrapper (exports window.db, window.storage) -->
  <script src="firebase.js"></script>
  <!-- Multi-school Context -->
  <script src="somapappv1multischool/js/context.js"></script>
  <!-- Year Context -->
  <script src="Todashboardhtml/yearContext.js"></script>
  <script type="module">
    import { SUBJECTS_BY_CLASS, getSubjectsForClass, canonSubject, canonClass } from './js/modules/subjects.js';
    window.SomapSubjects = { SUBJECTS_BY_CLASS, getSubjectsForClass, canonSubject, canonClass };
  </script>

  <style>
    .sticky-th th { position: sticky; top:0; background:#fff; z-index:2; }
    .scroll-shadow { box-shadow: inset 0 10px 8px -10px rgba(2,6,23,0.12); }
    #chartSubjects, #chartTop10 { max-width:100%; height:260px; display:block; }
    .bg-white.rounded-2xl.p-4 { overflow:hidden; }
    .min-w-table { min-width:1200px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1200px; height: 80vh; overflow-y: auto; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">
  <!-- Top bar -->
  <header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="staff.html" class="px-3 py-2 rounded-lg bg-white border text-sm flex items-center gap-2">
          <span style="font-size:18px;">←</span> Back
        </a>
        <div>
          <h1 class="text-lg font-semibold">SoMAp — Academic & Exams Module</h1>
          <p class="text-xs text-slate-500">Scores • Rankings • Reports</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnOpenScoresheet" class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm flex items-center gap-2">
          <i class="fas fa-table"></i> Scoresheet
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Controls -->
    <section class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3">
      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">School Branch</label>
        <input id="schoolBranch" class="mt-1 w-full border rounded px-2 py-2 text-sm" placeholder="Socrates — Main (optional)">
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Class</label>
        <select id="classSelect" class="mt-1 w-full border rounded px-2 py-2 text-sm" disabled></select>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Stream</label>
        <input id="streamInput" class="mt-1 w-full border rounded px-2 py-2 text-sm" placeholder="A / B / Red">
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Exam Type</label>
        <select id="examType" class="mt-1 w-full border rounded px-2 py-2 text-sm">
          <option>Monthly</option>
          <option>Midterm 1</option>
          <option>End Term</option>
          <option>Midterm 2</option>
          <option>Annual</option>
        </select>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Month</label>
        <select id="monthSelect" class="mt-1 w-full border rounded px-2 py-2 text-sm">
          <option value="01">January</option><option value="02">February</option><option value="03">March</option>
          <option value="04">April</option><option value="05">May</option><option value="06">June</option>
          <option value="07">July</option><option value="08">August</option><option value="09">September</option>
          <option value="10">October</option><option value="11">November</option><option value="12">December</option>
        </select>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Academic Year</label>
        <select id="yearSelect" data-somap-year-select class="mt-1 w-full border rounded px-2 py-2 text-sm bg-white"></select>
      </div>
    </section>

    <!-- KPI + Charts -->
    <section class="mt-6 grid lg:grid-cols-12 gap-4">
      <div class="lg:col-span-5 grid grid-cols-2 sm:grid-cols-3 gap-4">
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-blue-500">
          <p class="text-xs text-slate-500">Top Student</p>
          <h3 id="kpiTopStudent" class="text-lg font-semibold mt-1 text-blue-600">–</h3>
          <p id="kpiTopScore" class="text-xs text-slate-500">–</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-red-500">
          <p class="text-xs text-slate-500">Bottom Student</p>
          <h3 id="kpiBottomStudent" class="text-lg font-semibold mt-1 text-red-600">–</h3>
          <p id="kpiBottomScore" class="text-xs text-slate-500">–</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-purple-500">
          <p class="text-xs text-slate-500">Class Max</p>
          <h3 id="kpiClassMax" class="text-lg font-semibold mt-1 text-purple-600">–</h3>
          <p class="text-xs text-slate-500">Highest overall avg</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-indigo-500">
          <p class="text-xs text-slate-500">Class Grade</p>
          <h3 id="kpiClassGrade" class="text-lg font-semibold mt-1 text-indigo-600">–</h3>
          <p class="text-xs text-slate-500">Avg grade</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-green-500">
          <p class="text-xs text-slate-500">% Present</p>
          <h3 id="kpiPresent" class="text-lg font-semibold mt-1 text-green-600">–</h3>
          <p class="text-xs text-slate-500">Attendance</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-red-500">
          <p class="text-xs text-slate-500">% Absent</p>
          <h3 id="kpiAbsent" class="text-lg font-semibold mt-1 text-red-600">–</h3>
          <p class="text-xs text-slate-500">Attendance</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-yellow-500">
          <p class="text-xs text-slate-500">Fee: Required</p>
          <h3 id="kpiFeeRequired" class="text-lg font-semibold mt-1 text-yellow-600">–</h3>
          <p class="text-xs text-slate-500">Class/year</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-green-500">
          <p class="text-xs text-slate-500">Fee: Paid</p>
          <h3 id="kpiFeePaid" class="text-lg font-semibold mt-1 text-green-600">–</h3>
          <p class="text-xs text-slate-500">Aggregated</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-red-500">
          <p class="text-xs text-slate-500">Fee: Balance</p>
          <h3 id="kpiFeeBalance" class="text-lg font-semibold mt-1 text-red-600">–</h3>
          <p class="text-xs text-slate-500">Outstanding</p>
        </div>
      </div>

      <div class="lg:col-span-7 grid gap-4">
        <div class="bg-white rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between">
            <p class="text-sm font-medium">Subject Performance (Class)</p>
            <div class="text-xs text-slate-500">Average per subject</div>
          </div>
          <canvas id="chartSubjects" class="mt-3"></canvas>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between">
            <p class="text-sm font-medium">Student Averages (Top 10)</p>
            <div class="text-xs text-slate-500">Overall %</div>
          </div>
          <canvas id="chartTop10" class="mt-3"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal for Scoresheet -->
  <div id="scoresheetModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <iframe id="scoresheetFrame" src="Toacademichtml/scoresheet.html" style="width: 100%; height: 90%; border: none;"></iframe>
    </div>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    const SomapSub = () => window.SomapSubjects || {};

    // Attempt/grade helpers (inline; do not import other files)
    function isNumber(n){ return Number.isFinite(n) && !Number.isNaN(n); }
    function attemptedItem(item){
      const score = Number(item?.score);
      const max   = Number(item?.max);
      return isNumber(score) && isNumber(max) && max > 0 && score > 0;
    }
    function studentPercentFrom(subjects){
      let s = 0, m = 0, count = 0;
      for (const it of (subjects || [])){
        const score = Number(it?.score);
        const max   = Number(it?.max);
        if (attemptedItem({score,max})){
          s += score; m += max; count++;
        }
      }
      if (m <= 0 || count === 0) return { pct: 0, total: 0, max: 0, attemptedCount: 0 };
      return { pct: (s * 100) / m, total: s, max: m, attemptedCount: count };
    }
    // Unified grading
    function gradeFromPercent(p){
      const x = Math.max(0, Math.min(100, Number(p)||0));
      if (x >= 80.5) return 'A';
      if (x >= 60.5) return 'B';
      if (x >= 40.5) return 'C';
      if (x >= 20.5) return 'D';
      return 'F';
    }

    const EXAM_KEYS = {
      'Monthly': 'monthly',
      'Midterm 1': 'midterm1',
      'End Term': 'endterm',
      'Midterm 2': 'midterm2',
      'Annual': 'annual'
    };

    const MONTH_KEYS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const MONTH_LABELS = {
      '1':'Jan','01':'Jan',January:'Jan',
      '2':'Feb','02':'Feb',February:'Feb',
      '3':'Mar','03':'Mar',March:'Mar',
      '4':'Apr','04':'Apr',April:'Apr',
      '5':'May','05':'May',May:'May',
      '6':'Jun','06':'Jun',June:'Jun',
      '7':'Jul','07':'Jul',July:'Jul',
      '8':'Aug','08':'Aug',August:'Aug',
      '9':'Sep','09':'Sep',September:'Sep',
      '10':'Oct',October:'Oct',
      '11':'Nov',November:'Nov',
      '12':'Dec',December:'Dec'
    };

    function monthVariants(mon){
      const set = new Set();
      const raw = String(mon || '').trim();
      if (raw) set.add(raw);
      const stripped = raw.replace(/^0+/, '') || raw;
      if (stripped) set.add(stripped);
      const canonical = MONTH_LABELS[raw] || MONTH_LABELS[stripped];
      if (canonical){
        set.add(canonical);
        set.add(canonical.toLowerCase());
        set.add(canonical.toUpperCase());
        const idx = MONTH_KEYS.indexOf(canonical);
        if (idx >= 0) set.add(String(idx + 1).padStart(2,'0'));
        if (idx >= 0) set.add(String(idx + 1));
        const full = {
          Jan:'January', Feb:'February', Mar:'March', Apr:'April', May:'May', Jun:'June',
          Jul:'July', Aug:'August', Sep:'September', Oct:'October', Nov:'November', Dec:'December'
        }[canonical];
        if (full){
          set.add(full);
          set.add(full.toLowerCase());
          set.add(full.toUpperCase());
        }
      }
      return Array.from(set).filter(Boolean);
    }

    function getSubjectList(className, year){
      const api = SomapSub();
      const cls = api.canonClass ? api.canonClass(className) : (className || '');
      const subjects = api.getSubjectsForClass ? api.getSubjectsForClass(cls, year) : [];
      const list = Array.isArray(subjects) ? subjects : [];
      return list.map(label => api.canonSubject ? api.canonSubject(label) : label);
    }

    function letterGrade(pct) {
      if (typeof gradeFromPercent === 'function') return gradeFromPercent(pct);
      const p = Number(pct);
      if (p >= 80.5) return 'A';
      if (p >= 60.5) return 'B';
      if (p >= 40.5) return 'C';
      if (p >= 20.5) return 'D';
      return 'F';
    }

    function computePercent(pairs){
      const fn = (typeof percent === 'function') ? percent : window.Grading?.percent;
      if (fn) return fn(pairs);
      let s = 0, m = 0;
      (pairs || []).forEach(it => {
        const rawScore = it?.score;
        const rawMax = it?.max;
        const sc = Number(rawScore);
        const mx = Number(rawMax);
        if (!Number.isFinite(mx) || mx <= 0) return;
        const missing = rawScore === '' || rawScore === null || rawScore === undefined || Number.isNaN(sc);
        if (missing || sc < 0) return;
        s += sc; m += mx;
      });
      return m > 0 ? (s * 100) / m : 0;
    }

    /* ---------- STATE ---------- */
    const state = {
      students: [], attendance: {}, fees: {}, scores: {}, subjectList: [],
      rowsByAdm: {}, className: '', stream: '', month: '', year: '', examKey: '', schoolBranch: '',
      assignedClass: ''
    };

    /* ---------- ELEMENTS ---------- */
    const classSelect = document.getElementById('classSelect');
    const streamInput = document.getElementById('streamInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const examType = document.getElementById('examType');
    const schoolBranch = document.getElementById('schoolBranch');

    const subjectsChartCtx = document.getElementById('chartSubjects');
    const top10ChartCtx = document.getElementById('chartTop10');
    let subjectsChart = null, top10Chart = null;

    const kpiTopStudent = document.getElementById('kpiTopStudent');
    const kpiTopScore = document.getElementById('kpiTopScore');
    const kpiBottomStudent = document.getElementById('kpiBottomStudent');
    const kpiBottomScore = document.getElementById('kpiBottomScore');
    const kpiClassMax = document.getElementById('kpiClassMax');
    const kpiClassGrade = document.getElementById('kpiClassGrade');
    const kpiPresent = document.getElementById('kpiPresent');
    const kpiAbsent = document.getElementById('kpiAbsent');
    const kpiFeeRequired = document.getElementById('kpiFeeRequired');
    const kpiFeePaid = document.getElementById('kpiFeePaid');
    const kpiFeeBalance = document.getElementById('kpiFeeBalance');

    /* ---------- Firebase DB helper ---------- */
    function getDB() {
      if (window && window.db) return window.db;
      if (!window.firebase) {
        console.error('Firebase not loaded; ensure firebase.js is present and provides window.db');
        return null;
      }
      if (!firebase.apps.length) {
        const cfg = {
          apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
          authDomain: "somaptestt.firebaseapp.com",
          databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
          projectId: "somaptestt",
          storageBucket: "somaptestt.appspot.com",
          messagingSenderId: "105526245138",
          appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
        };
        firebase.initializeApp(cfg);
      }
      return firebase.database();
    }

    /* ---------- Multi-school Helper ---------- */
    // Initialize current school and guard
    const currentSchool = window.SOMAP && SOMAP.getSchool();
    if (!currentSchool || !currentSchool.id) {
       window.location.href = "somapappv1multischool/multischool.html";
    }

    function schoolRef(subPath) {
       const db = getDB();
       if (!db) return null;
       return db.ref(SOMAP.P(subPath));
    }
    
    // Update dashboard header with school name
    document.addEventListener('DOMContentLoaded', () => {
        if (currentSchool && currentSchool.name) {
            const h1 = document.querySelector('h1');
            if (h1) h1.textContent += ` · ${currentSchool.name}`;
            const sbInput = document.getElementById('schoolBranch');
            if (sbInput && !sbInput.value) sbInput.value = currentSchool.name;
        }
    });

    /* ---------- Parse class from Gmail ---------- */
    function parseClassFromEmail(email) {
      const emailPrefix = email.split('@')[0].toLowerCase();
      const classMap = {
        'ssbabyclass': 'Baby Class',
        'ssmiddleclass': 'Middle Class',
        'sspreunit': 'Pre-Unit',
        'ssclass1ab': 'Class 1',
        'ssclass2ab': 'Class 2',
        'ssclass3': 'Class 3',
        'ssclass4': 'Class 4',
        'ssclass5': 'Class 5',
        'ssclass6': 'Class 6',
        'ssclass7': 'Class 7'
      };
      for (const [key, className] of Object.entries(classMap)) {
        if (emailPrefix.includes(key)) {
          return SomapSub().canonClass ? SomapSub().canonClass(className) : className;
        }
      }
      return null;
    }

    /* ---------- Populate class dropdown (locked to assigned class) ---------- */
    function populateClasses(assignedClass) {
      if(!classSelect) return;
      const opts = Object.keys(SomapSub().SUBJECTS_BY_CLASS || {});
      const assignedCanonical = SomapSub().canonClass ? SomapSub().canonClass(assignedClass) : assignedClass;
      if (assignedCanonical && opts.includes(assignedCanonical)) {
        classSelect.innerHTML = `<option value="${assignedCanonical}">${assignedCanonical}</option>`;
        classSelect.value = assignedCanonical;
        classSelect.disabled = true;
      } else {
        classSelect.innerHTML = '<option value="">Select Class…</option>' + opts.map(c => `<option>${c}</option>`).join('');
        classSelect.disabled = false;
      }
    }

    /* ---------- Robust student loader ---------- */
    async function fetchStudents(className, stream) {
      const db = getDB();
      if (!db) return [];
      const tryPaths = ['students', 'Students', 'StudentsList', 'Students_List', 'studentList', 'studentlist', 'attendance', 'school', 'schoolerp'];
      for (const p of tryPaths) {
        try {
          const snap = await db.ref(p).get();
          if (snap && snap.exists && snap.exists()) {
            const data = snap.val();
            const arr = [];
            if (Array.isArray(data)) {
              data.forEach((item, idx) => {
                if (item) {
                  const adm = item.adm || item.admissionNumber || item.admNo || ('A' + idx);
                  arr.push(normalizeStudentRecord(adm, item));
                }
              });
            } else {
              Object.keys(data).forEach(k => {
                const s = data[k] || {};
                if (typeof s === 'object' && (s.name || s.fullName || s.firstName || s.adm || s.admissionNumber || s.admissionNo || s.feeDue || s.feePaid)) {
                  const adm = s.adm || s.admissionNumber || s.admNo || s.admission || k;
                  arr.push(normalizeStudentRecord(adm, s));
                }
              });
            }
            const selectedCanon = SomapSub().canonClass ? SomapSub().canonClass(className) : className;
            const filtered = arr.filter(x => {
              const studentCanon = SomapSub().canonClass ? SomapSub().canonClass(x.class) : x.class;
              const classMatches = !selectedCanon ||
                (studentCanon && studentCanon.toLowerCase() === (selectedCanon || '').toLowerCase()) ||
                (String(studentCanon || '').toLowerCase().includes(String(selectedCanon || '').toLowerCase())) ||
                (String(selectedCanon || '').toLowerCase().includes(String(studentCanon || '').toLowerCase()));
              const normalizedStream = String(x.stream || '').toUpperCase().replace(/[\s-]/g, '');
              const normalizedInputStream = (stream || '').toUpperCase().replace(/[\s-]/g, '');
              const streamMatches = !stream || normalizedStream.includes(normalizedInputStream);
              return classMatches && streamMatches;
            });
            filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            if (filtered.length) return filtered;
          }
        } catch (err) {
          console.warn('fetchStudents trying', p, err && err.message);
        }
      }
      return [];
    }

    function normalizeStudentRecord(admKey, s) {
      const name = [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ').trim() || s.name || s.fullName || ('Student ' + admKey);
      let sClass = s.class || s.currentClass || s.level || s.className || s.grade || s.classLevel || '';
      if (sClass && SomapSub().canonClass) {
        sClass = SomapSub().canonClass(sClass);
      }
      const sStream = s.stream || s.streamName || s.section || '';
      const feeDue = Number(s.totalFee || s.feePerYear || s.feeDue || s.required || s.debt || 0);
      let feePaid = Number(s.paid || s.feePaid || s.totalPaid || s.paidAmount || s.credit || 0);
      if (s.payments && typeof s.payments === 'object') {
        feePaid = Object.values(s.payments).reduce((sum, p) => sum + Number(p.amount || 0), 0);
      }
      const balance = Number(s.balance || Math.max(0, feeDue - feePaid) || 0);
      return { adm: admKey, name, class: sClass, stream: sStream, feeDue, feePaid, balance, meta: s };
    }

    /* ---------- Attendance + fees + scores fetchers ---------- */
    async function fetchAttendance(year, month, className) {
      const db = getDB();
      if (!db) return {};
      const refPath = `/attendance/${year}/${month}/${className}`;
      try {
        const snap = await db.ref(refPath).get();
        const out = {};
        if (snap && snap.exists && snap.exists()) {
          const val = snap.val();
          Object.keys(val).forEach(adm => {
            const a = val[adm] || {};
            out[adm] = { present: Number(a.present || a.daysPresent || 0), absent: Number(a.absent || a.daysAbsent || 0), days: Number(a.days || (Number(a.present || 0) + Number(a.absent || 0))) };
          });
        }
        return out;
      } catch (e) { console.warn('fetchAttendance', e && e.message); return {}; }
    }

    async function fetchFees(year, className) {
      const db = getDB();
      if (!db) return {};
      const refPath = `/fees/${year}/${className}`;
      try {
        const snap = await db.ref(refPath).get();
        const out = {};
        if (snap && snap.exists && snap.exists()) {
          const val = snap.val();
          Object.keys(val).forEach(adm => {
            const f = val[adm] || {};
            const required = Number(f.required || f.expected || f.total || 0);
            const paid = Number(f.paid || f.paidAmount || 0);
            out[adm] = { required, paid, balance: Math.max(0, required - paid) };
          });
        }
        return out;
      } catch (e) { console.warn('fetchFees', e && e.message); return {}; }
    }

    async function fetchScores({ year, className, examKey, month }) {
      const db = getDB();
      if (!db) return {};

      // 1. Build tolerant class key candidates: "Class 3" ↔ "3"
      const classCandidates = [];
      if (className) {
        const cls = String(className).trim();
        classCandidates.push(cls);

        const match = cls.match(/(\d+)/);
        if (match) {
          const num = match[1];
          const numericKey = num;
          const withPrefix = `Class ${num}`;

          if (!classCandidates.includes(numericKey)) classCandidates.push(numericKey);
          if (!classCandidates.includes(withPrefix)) classCandidates.push(withPrefix);
        }
      }

      const variants = monthVariants(month);
      const paths = [];

      classCandidates.forEach(clsKey => {
        const base = `/scores/${year}/${clsKey}`;
        variants.forEach(v => {
          paths.push(`${base}/${examKey}/${v}`);
          paths.push(`${base}/${examKey.toLowerCase()}/${v}`);
          paths.push(`${base}/${examKey.toUpperCase()}/${v}`);
          paths.push(`${base}/${v}`); // when examKey level is missing
        });
      });

      const out = {};

      for (const refPath of paths) {
        try {
          const snap = await db.ref(refPath).get();
          console.log('[academic.fetchScores] trying', refPath, snap && snap.exists && snap.exists());

          if (snap && snap.exists && snap.exists()) {
            const val = snap.val() || {};

            Object.keys(val).forEach(adm => {
              out[adm] = out[adm] || {};
              const subjObj = val[adm] || {};
              Object.keys(subjObj).forEach(sub => {
                const o = subjObj[sub] || {};
                const canonicalLabel = SomapSub().canonSubject
                  ? SomapSub().canonSubject(sub)
                  : sub;
                const labelKey = canonicalLabel || sub;
                const entry = {
                  score: Number(o.score || 0),
                  max: Number(o.max || 100),
                };
                out[adm][labelKey] = entry;
                if (!out[adm][sub]) out[adm][sub] = entry;
              });
            });

            if (Object.keys(out).length) break;
          }
        } catch (e) {
          console.warn('[academic.fetchScores] error on', refPath, e);
        }
      }

      if (!Object.keys(out).length) {
        console.warn(
          '[academic.fetchScores] NO DATA for',
          { year, className, examKey, month, classCandidates, pathsTried: paths }
        );
      }

      return out;
    }

    function studentAveragePercent(student){
      const scores = state.scores[student.adm] || {};
      const pairs = (state.subjectList || []).map(sub => {
        const entry = scores[sub] || {};
        return { score: entry.score, max: entry.max };
      });
      return studentPercentFrom(pairs);
    }

    /* ---------- Load sequence (main entry) ---------- */
    async function loadAll() {
      // 1. Guard: Check if authentication is complete
      if (!state.assignedClass) return; 

      // 2. Guard: Check if critical elements exist
      if (!classSelect || !yearSelect || !monthSelect || !examType) return;

      const selectedClass = classSelect.value;
      const selectedYear  = yearSelect.value;
      const selectedMonth = monthSelect.value;
      const selectedExam  = examType.value;

      // 3. Guard: Check if all filters have values
      if (!selectedClass || !selectedYear || !selectedMonth || !selectedExam) {
        console.warn('[academic.loadAll] Incomplete filters, aborting', {
          selectedClass, selectedYear, selectedMonth, selectedExam
        });
        return;
      }

      const selectedClassValue = SomapSub().canonClass ? SomapSub().canonClass(selectedClass) : selectedClass;
      if (selectedClassValue !== state.assignedClass) {
        alert('NOT YOUR CLASS BUDDY! You are restricted to ' + state.assignedClass);
        classSelect.value = state.assignedClass;
        return;
      }

      state.className = selectedClassValue;
      
      // Update state directly from selects
      state.year = selectedYear;
      state.month = selectedMonth;
      state.examKey = EXAM_KEYS[selectedExam] || 'monthly';
      state.schoolBranch = (schoolBranch && schoolBranch.value) ? schoolBranch.value.trim() : '';
      
      let inputStream = (streamInput && streamInput.value) ? streamInput.value.trim() : '';

      const classNumMatch = state.className.match(/\d+/);
      const classNum = classNumMatch ? classNumMatch[0] : '';
      const effectiveStream = inputStream.replace(/class/i, '').replace(classNum, '').trim().toUpperCase();
      state.stream = effectiveStream;

      state.subjectList = getSubjectList(state.className, state.year);

      state.students = await fetchStudents(state.className, state.stream);
      state.attendance = await fetchAttendance(state.year, state.month, state.className) || {};
      state.fees = await fetchFees(state.year, state.className) || {};
      state.scores = await fetchScores({ year: state.year, className: state.className, examKey: state.examKey, month: state.month }) || {};

      updateKPIs();
      drawCharts();
    }

    /* ---------- Authentication and class lock ---------- */
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      const safeEmail = user.email.replace('.', '_');
      const db = getDB();
      db.ref('users/' + safeEmail).once('value').then(snap => {
        const ud = snap.val() || {};
        if (ud.role !== 'teacher') {
          alert('Unauthorized: only teachers allowed');
          firebase.auth().signOut();
          window.location.href = 'index.html';
          return;
        }
        // Parse class from email or use Firebase user data
        const derivedClass = parseClassFromEmail(user.email) || ud.class || ud.classLevel || '';
        state.assignedClass = SomapSub().canonClass ? SomapSub().canonClass(derivedClass) : derivedClass;
        if (!state.assignedClass || !Object.keys(SomapSub().SUBJECTS_BY_CLASS || {}).includes(state.assignedClass)) {
          alert('Invalid or no class assigned. Contact administrator.');
          firebase.auth().signOut();
          window.location.href = 'index.html';
          return;
        }
        // Lock dropdown to assigned class
        populateClasses(state.assignedClass);
        classSelect.value = state.assignedClass;
        
        // Ensure yearSelect exists before setting value
        if (yearSelect) {
            yearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            // Populate years, e.g., current year +/- 1
            [currentYear - 1, currentYear, currentYear + 1].forEach(y => {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if(y === currentYear) opt.selected = true;
                yearSelect.appendChild(opt);
            });
            yearSelect.value = currentYear.toString();
        }
        
        // Wait for DOM to stabilize before initial load
        setTimeout(() => {
          loadAll();
        }, 0);
      });
    });

    /* ---------- Computation: totals/averages/positions/grades ---------- */
    function updateKPIs() {
      const list = Object.values(state.students).map(s => {
        const sum = studentAveragePercent(s);
        return { name: s.name, avg: sum.pct, attemptedCount: sum.attemptedCount };
      });
      const contributors = list.filter(x => (x.attemptedCount || 0) > 0);
      if (contributors.length === 0) {
        ['kpiTopStudent', 'kpiTopScore', 'kpiBottomStudent', 'kpiBottomScore', 'kpiClassMax', 'kpiClassGrade', 'kpiPresent', 'kpiAbsent', 'kpiFeeRequired', 'kpiFeePaid', 'kpiFeeBalance'].forEach(id => document.getElementById(id).textContent = '-');
        return;
      }
      const sorted = contributors.slice().sort((a, b) => b.avg - a.avg);
      const top = sorted[0];
      const bottom = sorted[sorted.length - 1];
      kpiTopStudent.textContent = top.name || '–';
      kpiTopScore.textContent = (top.avg || 0).toFixed(2) + '%';
      kpiBottomStudent.textContent = bottom.name || '–';
      kpiBottomScore.textContent = (bottom.avg || 0).toFixed(2) + '%';
      kpiClassMax.textContent = (top.avg || 0).toFixed(2) + '%';
      const classAvg = sorted.reduce((s, x) => s + (x.avg || 0), 0) / sorted.length;
      kpiClassGrade.textContent = gradeFromPercent(classAvg);

      let sumPresent = 0, sumAbsent = 0, sumDays = 0;
      state.students.forEach(s => {
        const att = state.attendance[s.adm] || { present: 0, absent: 0, days: 0 };
        sumPresent += att.present;
        sumAbsent += att.absent;
        sumDays += att.days || (att.present + att.absent);
      });
      const pctPresent = sumDays ? (sumPresent / sumDays) * 100 : 0;
      const pctAbsent = sumDays ? (sumAbsent / sumDays) * 100 : 0;
      kpiPresent.textContent = pctPresent.toFixed(1) + '%';
      kpiAbsent.textContent = pctAbsent.toFixed(1) + '%';

      let totalReq = 0, totalPaid = 0, totalBal = 0;
      state.students.forEach(s => {
        const fee = state.fees[s.adm] || { required: s.feeDue || 0, paid: s.feePaid || 0, balance: s.balance || 0 };
        totalReq += fee.required || 0;
        totalPaid += fee.paid || 0;
        totalBal += fee.balance || 0;
      });
      kpiFeeRequired.textContent = money(totalReq);
      kpiFeePaid.textContent = money(totalPaid);
      kpiFeeBalance.textContent = money(totalBal);
    }

    /* ---------- Charts (bounded) ---------- */
    function drawCharts() {
      const MAX_LABELS = 50;
      const subjects = state.subjectList || [];
      const avgPerSubject = subjects.map(sub => {
        let sum = 0, cnt = 0;
        state.students.forEach(s => {
          const entry = state.scores[s.adm]?.[sub] || {};
          const rawScore = entry.score;
          const rawMax = entry.max;
          const sc = Number(rawScore);
          const mx = Number(rawMax);
          const attempted = attemptedItem({ score: sc, max: mx });
          if (!attempted) return;
          sum += (sc * 100) / mx;
          cnt++;
        });
        return cnt ? sum / cnt : 0;
      });

      const topList = state.students.map(s => {
        const sum = studentAveragePercent(s);
        return { name: s.name, avg: sum.pct, attemptedCount: sum.attemptedCount };
      }).filter(x => (x.attemptedCount || 0) > 0).sort((a, b) => b.avg - a.avg).slice(0, 10);

      try { if (subjectsChart) { subjectsChart.destroy(); subjectsChart = null; } } catch (e) {}
      try { if (top10Chart) { top10Chart.destroy(); top10Chart = null; } } catch (e) {}

      const subjectsToShow = subjects.slice(0, MAX_LABELS);
      const avgToShow = avgPerSubject.slice(0, MAX_LABELS);

      subjectsChart = new Chart(subjectsChartCtx, {
        type: 'bar',
        data: { labels: subjectsToShow, datasets: [{ label: 'Average %', data: avgToShow, backgroundColor: '#4B5EAA' }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 }, x: { ticks: { autoSkip: true, maxTicksLimit: 12 } } } }
      });

      top10Chart = new Chart(top10ChartCtx, {
        type: 'bar',
        data: { labels: topList.map(x => x.name), datasets: [{ label: 'Overall %', data: topList.map(x => x.avg), backgroundColor: '#6B7280' }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 }, x: { ticks: { autoSkip: true } } } }
      });
    }

    /* ---------- Small helpers ---------- */
    function money(n) { n = Number(n || 0); return new Intl.NumberFormat('en-TZ', { style: 'currency', currency: 'TZS', maximumFractionDigits: 0 }).format(n); }

    /* ---------- Load on change ---------- */
    classSelect.addEventListener('change', () => {
      const selected = SomapSub().canonClass ? SomapSub().canonClass(classSelect.value) : classSelect.value;
      if (selected !== state.assignedClass) {
        alert('NOT YOUR CLASS BUDDY! You are restricted to ' + state.assignedClass);
        classSelect.value = state.assignedClass;
        return;
      }
      loadAll();
    });
    streamInput.addEventListener('change', loadAll);
    monthSelect.addEventListener('change', loadAll);
    yearSelect.addEventListener('change', loadAll);
    examType.addEventListener('change', loadAll);
    schoolBranch.addEventListener('change', loadAll);

    // --- SCORESHEET: simple, robust wiring ---
    const scoresheetModal = document.getElementById('scoresheetModal');
    const scoresheetFrame = document.getElementById('scoresheetFrame');
    const closeModal = document.getElementById('closeModal');
    const btnOpenScoresheet = document.getElementById('btnOpenScoresheet');

    function openScoresheetModal() {
      if (!scoresheetModal || !scoresheetFrame) {
        console.warn('Scoresheet modal elements not found.');
        return;
      }

      const yearSelect = document.getElementById('yearSelect');
      const classSelect = document.getElementById('classSelect');
      const streamInput = document.getElementById('streamInput');
      const examTypeSelect = document.getElementById('examType');
      const monthSelect = document.getElementById('monthSelect');

      const year = (yearSelect && yearSelect.value) || new Date().getFullYear().toString();
      const className = classSelect && classSelect.value;
      const stream = streamInput && streamInput.value;
      const examType = examTypeSelect && examTypeSelect.value;
      const month = monthSelect && monthSelect.value;

      if (!className) { alert('Please select a class first.'); return; }
      if (!examType) { alert('Please select an exam type (monthly, midterm, etc.).'); return; }
      if (!month) { alert('Please select a month.'); return; }
      if (!year) { alert('Please select a year.'); return; }

      const yearSpan = document.getElementById('selectedYear');
      const classSpan = document.getElementById('scoresheetClass');
      const streamSpan = document.getElementById('scoresheetStream');
      const examTypeSpan = document.getElementById('scoresheetExamType');
      const monthSpan = document.getElementById('scoresheetMonth');

      if (yearSpan) yearSpan.innerText = year;
      if (classSpan) classSpan.innerText = className;
      if (streamSpan) streamSpan.innerText = stream || '';
      if (examTypeSpan) examTypeSpan.innerText = examType;
      if (monthSpan) monthSpan.innerText = month;

      const queryParams = new URLSearchParams({
        year,
        class: className,
        stream: stream || '',
        examType,
        month
      });

      scoresheetFrame.src = `Toacademichtml/scoresheet.html?${queryParams.toString()}`;
      scoresheetModal.style.display = 'block';
    }

    if (btnOpenScoresheet) {
      btnOpenScoresheet.addEventListener('click', (event) => {
        event.preventDefault();
        openScoresheetModal();
      });
    }

    if (closeModal) {
      closeModal.addEventListener('click', () => {
        if (scoresheetModal) scoresheetModal.style.display = 'none';
      });
    }

    window.addEventListener('click', (event) => {
      if (scoresheetModal && event.target === scoresheetModal) {
        scoresheetModal.style.display = 'none';
      }
    });
  </script>
  <script src="./js/modules/grading.js"></script>
  <script>
    const { percent, gradeFromPercent: gradingGradeFromPercent, letterAndPercent } = window.Grading;
  </script>
</body>
</html>
