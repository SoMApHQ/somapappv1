<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SoMAp — Academics & Exams</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Firebase compat (v9 compat libs) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <!-- Your Firebase config wrapper (exports window.db, window.storage) -->
  <script src="firebase.js"></script>
  <!-- Multi-school Context -->
  <script src="somapappv1multischool/js/context.js"></script>
  <!-- Year Context -->
  <script src="Todashboardhtml/yearContext.js"></script>
  <script>
    /** Anchor year for class progression (Class 3 2025 → Class 4 2026) */
    const SOMAP_DEFAULT_YEAR = 2025;
    const CLASS_ORDER = ['Baby Class','Middle Class','Pre Unit Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
    function normalizeClassNameForEnrollment(name) {
      const s = String(name || '').trim();
      if (!s) return 'Unknown';
      const low = s.toLowerCase();
      if (low.includes('baby')) return 'Baby Class';
      if (low.includes('middle')) return 'Middle Class';
      if (low.includes('pre') || low.includes('nursery') || low.includes('unit')) return 'Pre Unit Class';
      const m = low.match(/class\s*(\d+)/) || low.match(/\b(\d+)\b/);
      if (m) return `Class ${parseInt(m[1], 10)}`;
      return s.replace(/\s+/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }
    function shiftClassForYear(baseClass, deltaYears) {
      const normalized = normalizeClassNameForEnrollment(baseClass);
      const idx = CLASS_ORDER.findIndex(c => c.toLowerCase() === normalized.toLowerCase());
      if (idx < 0) return normalized || 'Unknown';
      const next = idx + Number(deltaYears || 0);
      if (next < 0) return 'Pre-Admission';
      if (next >= CLASS_ORDER.length) return 'GRADUATED';
      return CLASS_ORDER[next];
    }
  </script>
  <script type="module">
    import { SUBJECTS_BY_CLASS, getSubjectsForClass, canonSubject, canonClass } from './js/modules/subjects.js';
    window.SomapSubjects = { SUBJECTS_BY_CLASS, getSubjectsForClass, canonSubject, canonClass };
  </script>

  <style>
    .sticky-th th { position: sticky; top:0; background:#fff; z-index:2; }
    .scroll-shadow { box-shadow: inset 0 10px 8px -10px rgba(2,6,23,0.12); }
    #chartSubjects, #chartTop10 { max-width:100%; height:260px; display:block; }
    .bg-white.rounded-2xl.p-4 { overflow:hidden; }
    .min-w-table { min-width:1200px; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
    .modal-content { background-color: #fff; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 1200px; height: 80vh; overflow-y: auto; }
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
    .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
  </style>
</head>
<body class="bg-gray-50 text-slate-800">
  <!-- Top bar -->
  <header class="bg-white border-b sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <a href="staff.html" class="px-3 py-2 rounded-lg bg-white border text-sm flex items-center gap-2">
          <span style="font-size:18px;">←</span> Back
        </a>
        <div>
          <h1 class="text-lg font-semibold">SoMAp — Academic & Exams Module</h1>
          <p class="text-xs text-slate-500">Scores • Rankings • Reports</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnOpenScoresheet" class="px-3 py-2 rounded-lg bg-indigo-600 text-white text-sm flex items-center gap-2">
          <i class="fas fa-table"></i> Scoresheet
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- Controls -->
    <section class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-3">
      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">School Branch</label>
        <input id="schoolBranch" class="mt-1 w-full border rounded px-2 py-2 text-sm" placeholder="Socrates — Main (optional)">
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Class</label>
        <select id="classSelect" class="mt-1 w-full border rounded px-2 py-2 text-sm" disabled></select>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Stream</label>
        <input id="streamInput" class="mt-1 w-full border rounded px-2 py-2 text-sm" placeholder="A / B / Red">
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Exam Type</label>
        <select id="examType" class="mt-1 w-full border rounded px-2 py-2 text-sm">
          <option>Monthly</option>
          <option>Midterm 1</option>
          <option>End Term</option>
          <option>Midterm 2</option>
          <option>Annual</option>
        </select>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Month</label>
        <select id="monthSelect" class="mt-1 w-full border rounded px-2 py-2 text-sm">
          <option value="01">January</option><option value="02">February</option><option value="03">March</option>
          <option value="04">April</option><option value="05">May</option><option value="06">June</option>
          <option value="07">July</option><option value="08">August</option><option value="09">September</option>
          <option value="10">October</option><option value="11">November</option><option value="12">December</option>
        </select>
      </div>

      <div class="bg-white rounded-2xl p-4 shadow">
        <label class="text-xs text-slate-500">Academic Year</label>
        <select id="yearSelect" data-somap-year-select class="mt-1 w-full border rounded px-2 py-2 text-sm bg-white"></select>
      </div>
    </section>

    <section id="transferHubHost" class="mt-6"></section>

    <!-- KPI + Charts -->
    <section class="mt-6 grid lg:grid-cols-12 gap-4">
      <div class="lg:col-span-5 grid grid-cols-2 sm:grid-cols-3 gap-4">
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-blue-500">
          <p class="text-xs text-slate-500">Top Student</p>
          <h3 id="kpiTopStudent" class="text-lg font-semibold mt-1 text-blue-600">–</h3>
          <p id="kpiTopScore" class="text-xs text-slate-500">–</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-red-500">
          <p class="text-xs text-slate-500">Bottom Student</p>
          <h3 id="kpiBottomStudent" class="text-lg font-semibold mt-1 text-red-600">–</h3>
          <p id="kpiBottomScore" class="text-xs text-slate-500">–</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-purple-500">
          <p class="text-xs text-slate-500">Class Max</p>
          <h3 id="kpiClassMax" class="text-lg font-semibold mt-1 text-purple-600">–</h3>
          <p class="text-xs text-slate-500">Highest overall avg</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-indigo-500">
          <p class="text-xs text-slate-500">Class Grade</p>
          <h3 id="kpiClassGrade" class="text-lg font-semibold mt-1 text-indigo-600">–</h3>
          <p class="text-xs text-slate-500">Avg grade</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-green-500">
          <p class="text-xs text-slate-500">% Present</p>
          <h3 id="kpiPresent" class="text-lg font-semibold mt-1 text-green-600">–</h3>
          <p class="text-xs text-slate-500">Attendance</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-red-500">
          <p class="text-xs text-slate-500">% Absent</p>
          <h3 id="kpiAbsent" class="text-lg font-semibold mt-1 text-red-600">–</h3>
          <p class="text-xs text-slate-500">Attendance</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-yellow-500">
          <p class="text-xs text-slate-500">Fee: Required</p>
          <h3 id="kpiFeeRequired" class="text-lg font-semibold mt-1 text-yellow-600">–</h3>
          <p class="text-xs text-slate-500">Class/year</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-green-500">
          <p class="text-xs text-slate-500">Fee: Paid</p>
          <h3 id="kpiFeePaid" class="text-lg font-semibold mt-1 text-green-600">–</h3>
          <p class="text-xs text-slate-500">Aggregated</p>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow border-l-4 border-red-500">
          <p class="text-xs text-slate-500">Fee: Balance</p>
          <h3 id="kpiFeeBalance" class="text-lg font-semibold mt-1 text-red-600">–</h3>
          <p class="text-xs text-slate-500">Outstanding</p>
        </div>
      </div>

      <div class="lg:col-span-7 grid gap-4">
        <div class="bg-white rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between">
            <p class="text-sm font-medium">Subject Performance (Class)</p>
            <div class="text-xs text-slate-500">Average per subject</div>
          </div>
          <canvas id="chartSubjects" class="mt-3"></canvas>
        </div>
        <div class="bg-white rounded-2xl p-4 shadow">
          <div class="flex items-center justify-between">
            <p class="text-sm font-medium">Student Averages (Top 10)</p>
            <div class="text-xs text-slate-500">Overall %</div>
          </div>
          <canvas id="chartTop10" class="mt-3"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal for Scoresheet -->
  <div id="scoresheetModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeModal">&times;</span>
      <iframe id="scoresheetFrame" src="Toacademichtml/scoresheet.html" style="width: 100%; height: 90%; border: none;"></iframe>
    </div>
  </div>

  <script src="js/academic-transfer.js?v=20260218b"></script>
  <script>
    /* ---------- CONFIG ---------- */
    const SomapSub = () => window.SomapSubjects || {};

    // Attempt/grade helpers (inline; do not import other files)
    function isNumber(n){ return Number.isFinite(n) && !Number.isNaN(n); }
    function attemptedItem(item){
      const score = Number(item?.score);
      const max   = Number(item?.max);
      return isNumber(score) && isNumber(max) && max > 0 && score > 0;
    }
    function studentPercentFrom(subjects){
      let s = 0, m = 0, count = 0;
      for (const it of (subjects || [])){
        const score = Number(it?.score);
        const max   = Number(it?.max);
        if (attemptedItem({score,max})){
          s += score; m += max; count++;
        }
      }
      if (m <= 0 || count === 0) return { pct: 0, total: 0, max: 0, attemptedCount: 0 };
      return { pct: (s * 100) / m, total: s, max: m, attemptedCount: count };
    }
    // Unified grading
    function gradeFromPercent(p){
      const x = Math.max(0, Math.min(100, Number(p)||0));
      if (x >= 80.5) return 'A';
      if (x >= 60.5) return 'B';
      if (x >= 40.5) return 'C';
      if (x >= 20.5) return 'D';
      return 'F';
    }

    const EXAM_KEYS = {
      'Monthly': 'monthly',
      'Midterm 1': 'midterm1',
      'End Term': 'endterm',
      'Midterm 2': 'midterm2',
      'Annual': 'annual'
    };

    const MONTH_KEYS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const MONTH_LABELS = {
      '1':'Jan','01':'Jan',January:'Jan',
      '2':'Feb','02':'Feb',February:'Feb',
      '3':'Mar','03':'Mar',March:'Mar',
      '4':'Apr','04':'Apr',April:'Apr',
      '5':'May','05':'May',May:'May',
      '6':'Jun','06':'Jun',June:'Jun',
      '7':'Jul','07':'Jul',July:'Jul',
      '8':'Aug','08':'Aug',August:'Aug',
      '9':'Sep','09':'Sep',September:'Sep',
      '10':'Oct',October:'Oct',
      '11':'Nov',November:'Nov',
      '12':'Dec',December:'Dec'
    };

    function monthVariants(mon){
      const set = new Set();
      const raw = String(mon || '').trim();
      if (raw) set.add(raw);
      const stripped = raw.replace(/^0+/, '') || raw;
      if (stripped) set.add(stripped);
      const canonical = MONTH_LABELS[raw] || MONTH_LABELS[stripped];
      if (canonical){
        set.add(canonical);
        set.add(canonical.toLowerCase());
        set.add(canonical.toUpperCase());
        const idx = MONTH_KEYS.indexOf(canonical);
        if (idx >= 0) set.add(String(idx + 1).padStart(2,'0'));
        if (idx >= 0) set.add(String(idx + 1));
        const full = {
          Jan:'January', Feb:'February', Mar:'March', Apr:'April', May:'May', Jun:'June',
          Jul:'July', Aug:'August', Sep:'September', Oct:'October', Nov:'November', Dec:'December'
        }[canonical];
        if (full){
          set.add(full);
          set.add(full.toLowerCase());
          set.add(full.toUpperCase());
        }
      }
      return Array.from(set).filter(Boolean);
    }

    function getSubjectList(className, year){
      const api = SomapSub();
      const cls = api.canonClass ? api.canonClass(className) : (className || '');
      const subjects = api.getSubjectsForClass ? api.getSubjectsForClass(cls, year) : [];
      const list = Array.isArray(subjects) ? subjects : [];
      return list.map(label => api.canonSubject ? api.canonSubject(label) : label);
    }

    function letterGrade(pct) {
      if (typeof gradeFromPercent === 'function') return gradeFromPercent(pct);
      const p = Number(pct);
      if (p >= 80.5) return 'A';
      if (p >= 60.5) return 'B';
      if (p >= 40.5) return 'C';
      if (p >= 20.5) return 'D';
      return 'F';
    }

    function computePercent(pairs){
      const fn = (typeof percent === 'function') ? percent : window.Grading?.percent;
      if (fn) return fn(pairs);
      let s = 0, m = 0;
      (pairs || []).forEach(it => {
        const rawScore = it?.score;
        const rawMax = it?.max;
        const sc = Number(rawScore);
        const mx = Number(rawMax);
        if (!Number.isFinite(mx) || mx <= 0) return;
        const missing = rawScore === '' || rawScore === null || rawScore === undefined || Number.isNaN(sc);
        if (missing || sc < 0) return;
        s += sc; m += mx;
      });
      return m > 0 ? (s * 100) / m : 0;
    }

    /* ---------- STATE ---------- */
    const state = {
      students: [], attendance: {}, fees: {}, scores: {}, subjectList: [],
      rowsByAdm: {}, className: '', stream: '', month: '', year: '', examKey: '', schoolBranch: '',
      assignedClass: ''
    };

    /* ---------- ELEMENTS ---------- */
    const classSelect = document.getElementById('classSelect');
    const streamInput = document.getElementById('streamInput');
    const monthSelect = document.getElementById('monthSelect');
    const yearSelect = document.getElementById('yearSelect');
    const examType = document.getElementById('examType');
    const schoolBranch = document.getElementById('schoolBranch');

    const subjectsChartCtx = document.getElementById('chartSubjects');
    const top10ChartCtx = document.getElementById('chartTop10');
    let subjectsChart = null, top10Chart = null;

    const kpiTopStudent = document.getElementById('kpiTopStudent');
    const kpiTopScore = document.getElementById('kpiTopScore');
    const kpiBottomStudent = document.getElementById('kpiBottomStudent');
    const kpiBottomScore = document.getElementById('kpiBottomScore');
    const kpiClassMax = document.getElementById('kpiClassMax');
    const kpiClassGrade = document.getElementById('kpiClassGrade');
    const kpiPresent = document.getElementById('kpiPresent');
    const kpiAbsent = document.getElementById('kpiAbsent');
    const kpiFeeRequired = document.getElementById('kpiFeeRequired');
    const kpiFeePaid = document.getElementById('kpiFeePaid');
    const kpiFeeBalance = document.getElementById('kpiFeeBalance');

    /* ---------- Firebase DB helper ---------- */
    function getDB() {
      if (window && window.db) return window.db;
      if (!window.firebase) {
        console.error('Firebase not loaded; ensure firebase.js is present and provides window.db');
        return null;
      }
      if (!firebase.apps.length) {
        const cfg = {
          apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
          authDomain: "somaptestt.firebaseapp.com",
          databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
          projectId: "somaptestt",
          storageBucket: "somaptestt.appspot.com",
          messagingSenderId: "105526245138",
          appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
        };
        firebase.initializeApp(cfg);
      }
      return firebase.database();
    }

    /* ---------- Multi-school Helper ---------- */
    // Initialize current school and guard
    const currentSchool = window.SOMAP && SOMAP.getSchool();
    if (!currentSchool || !currentSchool.id) {
       window.location.href = "somapappv1multischool/multischool.html";
    }
    const currentSchoolId = String(currentSchool?.id || '').trim();
    const isSocrates = currentSchoolId === 'socrates-school';

    function schoolRef(subPath) {
       const db = getDB();
       if (!db) return null;
       return db.ref(SOMAP.P(subPath));
    }

    function normalizedPath(path) {
      return String(path || '').replace(/^\/+/, '');
    }
    function buildCandidateDbPaths(path) {
      const clean = normalizedPath(path);
      const scoped = SOMAP?.P ? SOMAP.P(clean) : clean;
      const candidates = [scoped];
      if (isSocrates && clean !== scoped) candidates.push(clean);
      return candidates;
    }
    async function readFirstExisting(paths) {
      const db = getDB();
      if (!db) return null;
      for (const rawPath of (paths || [])) {
        for (const candidatePath of buildCandidateDbPaths(rawPath)) {
          try {
            const snap = await db.ref(candidatePath).get();
            if (snap && snap.exists && snap.exists()) {
              return { snap, path: candidatePath };
            }
          } catch (err) {
            console.warn('[academic] read failed', candidatePath, err?.message || err);
          }
        }
      }
      return null;
    }

    async function scopedOrSocratesLegacy(scopedSubPath, legacyPath) {
      const schoolRefPath = SOMAP?.P ? SOMAP.P(scopedSubPath) : scopedSubPath;
      const db = getDB();
      if (!db) return { exists: () => false, val: () => null };
      try {
        const snap = await db.ref(schoolRefPath).get();
        if (snap && snap.exists && snap.exists()) return snap;
        if (isSocrates && legacyPath) {
          const legSnap = await db.ref(legacyPath).get();
          return legSnap || { exists: () => false, val: () => null };
        }
        return { exists: () => false, val: () => null };
      } catch (e) {
        return { exists: () => false, val: () => null };
      }
    }
    
    // Update dashboard header with school name
    document.addEventListener('DOMContentLoaded', () => {
        if (currentSchool && currentSchool.name) {
            const h1 = document.querySelector('h1');
            if (h1) h1.textContent += ` · ${currentSchool.name}`;
            const sbInput = document.getElementById('schoolBranch');
            if (sbInput && !sbInput.value) sbInput.value = currentSchool.name;
        }
    });

    /* ---------- Parse class from Gmail ---------- */
    function parseClassFromEmail(email) {
      const emailPrefix = email.split('@')[0].toLowerCase();
      const classMap = {
        'ssbabyclass': 'Baby Class',
        'ssmiddleclass': 'Middle Class',
        'sspreunit': 'Pre-Unit',
        'ssclass1ab': 'Class 1',
        'ssclass2ab': 'Class 2',
        'ssclass3': 'Class 3',
        'ssclass4': 'Class 4',
        'ssclass5': 'Class 5',
        'ssclass6': 'Class 6',
        'ssclass7': 'Class 7'
      };
      for (const [key, className] of Object.entries(classMap)) {
        if (emailPrefix.includes(key)) {
          return SomapSub().canonClass ? SomapSub().canonClass(className) : className;
        }
      }
      return null;
    }

    /* ---------- Populate class dropdown (locked to assigned class for teachers) ---------- */
    function populateClasses(assignedClass) {
      if(!classSelect) return;
      const opts = Object.keys(SomapSub().SUBJECTS_BY_CLASS || {});
      const assignedCanonical = assignedClass ? (SomapSub().canonClass ? SomapSub().canonClass(assignedClass) : assignedClass) : null;
      if (assignedCanonical && opts.includes(assignedCanonical)) {
        classSelect.innerHTML = `<option value="${assignedCanonical}">${assignedCanonical}</option>`;
        classSelect.value = assignedCanonical;
        classSelect.disabled = true;
      } else {
        classSelect.innerHTML = '<option value="">Select Class…</option>' + opts.map(c => `<option>${c}</option>`).join('');
        classSelect.disabled = false;
      }
    }

    /* ---------- Student loader: SAME logic as classattendance (load ALL, filter in UI) ---------- */
    function flattenEnrollmentsForLookup(raw) {
      if (!raw || typeof raw !== 'object') return {};
      const flat = {};
      function add(id, entry) {
        if (id && entry && typeof entry === 'object') flat[id] = Object.assign(flat[id] || {}, entry);
      }
      Object.entries(raw).forEach(([key, value]) => {
        if (!value || typeof value !== 'object') return;
        if (value.studentId || value.id || value.className || value.classLevel || value.class || value.grade) {
          add(value.id || value.studentId || key, value);
          return;
        }
        Object.entries(value).forEach(([stuId, stuVal]) => {
          const entry = (stuVal && typeof stuVal === 'object') ? { ...stuVal } : {};
          if (!entry.className && !entry.classLevel && !entry.class && !entry.grade) entry.className = key;
          add(entry.id || entry.studentId || stuId, entry);
        });
      });
      return flat;
    }
    function buildEnrollmentIndex(enrollments) {
      const flat = flattenEnrollmentsForLookup(enrollments);
      const byId = {};
      const byAdmission = {};
      Object.entries(flat).forEach(([key, value]) => {
        if (!value || typeof value !== 'object') return;
        const admission = value.admissionNumber || value.admissionNo || value.admNo || '';
        if (admission && !byAdmission[admission]) byAdmission[admission] = value;
        if (!byId[key]) byId[key] = value;
      });
      return { byId, byAdmission };
    }
    function lookupEnrollment(index, studentId, admissionNo) {
      if (!index) return {};
      if (studentId && index.byId?.[studentId]) return index.byId[studentId];
      if (admissionNo && index.byId?.[admissionNo]) return index.byId[admissionNo];
      if (admissionNo && index.byAdmission?.[admissionNo]) return index.byAdmission[admissionNo];
      return {};
    }
    const getEnrollmentClassFromRecord = (e) => (e && typeof e === 'object') ? (e.className || e.classLevel || e.class || e.grade || '') : '';
    const getStudentClassFromRecord = (s) => (s && typeof s === 'object') ? (s.className || s.classLevel || s.class || s.grade || s.gradeLevel || 'Unknown') : 'Unknown';
    function inferAdmissionYear(s) {
      const sources = [s?.createdTs, s?.admissionTs, s?.createdAt, s?.admissionDate, s?.admissionYear, s?.admYear];
      for (const v of sources) {
        if (v == null) continue;
        const y = typeof v === 'number' ? new Date(v).getFullYear() : (/^\d{4}$/.test(String(v).trim()) ? Number(v) : null);
        if (Number.isFinite(y)) return y;
      }
      return null;
    }
    function normalizeYearValue(y) { const n = Number(y); return Number.isFinite(n) ? String(n) : String(SOMAP_DEFAULT_YEAR); }

    function canonicalClassKey(str) {
      const api = window.SomapSubjects || {};
      const canonical = api.canonClass ? api.canonClass(str) : str;
      const norm = String(canonical || '').toUpperCase().replace(/[\s\-\._]/g, '');
      if (!norm) return '';
      return norm.replace(/(19|20)\d{2}$/, '').replace(/^(CLASS|GRADE|STD|STREAM)/gi, '');
    }
    function classMatches(target, actual) {
      if (!target || !actual) return false;
      const t = canonicalClassKey(target);
      const a = canonicalClassKey(actual);
      if (t && a && t === a) return true;
      const tLead = (t.match(/^\d+/) || [''])[0];
      const aLead = (a.match(/^\d+/) || [''])[0];
      if ((tLead === '1' || tLead === '2') && (aLead === '1' || aLead === '2')) return tLead === aLead;
      return false;
    }

    /** Load ALL students for year (no class filter) - same as classattendance loadStudentsFromDb */
    async function loadAllStudentsFromDb(yearOverride) {
      if (!getDB()) return [];
      const year = normalizeYearValue(yearOverride ?? state.year ?? yearSelect?.value ?? new Date().getFullYear());
      const delta = Number(year) - SOMAP_DEFAULT_YEAR;
      const tryPaths = ['students', 'Students', 'StudentsList', 'Students_List'];

      const [anchorSnap, yearSnap] = await Promise.all([
        scopedOrSocratesLegacy(`enrollments/${SOMAP_DEFAULT_YEAR}`, `enrollments/${SOMAP_DEFAULT_YEAR}`).catch(() => null),
        scopedOrSocratesLegacy(`enrollments/${year}`, `enrollments/${year}`).catch(() => null)
      ]);
      const anchorIndex = buildEnrollmentIndex(anchorSnap?.exists?.() ? anchorSnap.val() : {});
      const yearIndex = buildEnrollmentIndex(yearSnap?.exists?.() ? yearSnap.val() : {});

      for (const p of tryPaths) {
        try {
          const snap = await scopedOrSocratesLegacy(p, p);
          if (!snap?.exists?.()) continue;
          const data = snap.val() || {};
          const roster = Object.keys(data).map((k) => {
            const s = data[k] || {};
            if (String(s.status || '').toLowerCase() === 'shifted') return null;
            const name = [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ').trim() || s.name || s.fullName || '';
            const admissionNo = s.admissionNumber || s.admNo || s.admissionNo || '';
            const anchorEnroll = lookupEnrollment(anchorIndex, k, admissionNo);
            const yearEnroll = lookupEnrollment(yearIndex, k, admissionNo);
            const yearClass = getEnrollmentClassFromRecord(yearEnroll);
            const anchorClass = getEnrollmentClassFromRecord(anchorEnroll);
            const studentClass = getStudentClassFromRecord(s);
            const baseClass = anchorClass || studentClass || 'Unknown';
            const hasAnchor = anchorEnroll && typeof anchorEnroll === 'object' && Object.keys(anchorEnroll).length > 0;
            const oldAdmission = Number.isFinite(inferAdmissionYear(s)) && inferAdmissionYear(s) <= SOMAP_DEFAULT_YEAR;
            const shouldShift = hasAnchor || oldAdmission;
            const lastTransfer = s.lastClassTransfer || s.meta?.lastClassTransfer;
            const transferYear = lastTransfer?.effectiveDate ? new Date(String(lastTransfer.effectiveDate) + 'T12:00:00').getFullYear() : null;
            const transferClass = lastTransfer?.toClass || '';

            let computedClass = yearClass;
            if (!computedClass && transferClass && Number(transferYear) === Number(year)) computedClass = transferClass;
            if (!computedClass) {
              computedClass = shouldShift ? shiftClassForYear(baseClass, delta) : baseClass;
            }
            const finalClass = normalizeClassNameForEnrollment(computedClass || 'Unknown');
            if (String(finalClass).trim().toUpperCase() === 'GRADUATED') return null;

            const feeDue = Number(s.totalFee || s.feePerYear || s.feeDue || 0);
            let feePaid = Number(s.feesPaid || s.feePaid || s.paidAmount || 0);
            if (s.payments && typeof s.payments === 'object') feePaid = Object.values(s.payments).reduce((sum, p) => sum + Number(p.amount || 0), 0);
            const balance = Number(s.balance || Math.max(0, feeDue - feePaid) || 0);

            return {
              id: k,
              adm: admissionNo || k,
              admissionNo,
              name,
              class: finalClass,
              stream: s.stream || s.streamName || s.section || '',
              feeDue,
              feePaid,
              balance,
              parentContact: s.parentContact || s.parentPhone || s.guardianPhone || '',
              meta: s
            };
          }).filter(Boolean);
          roster.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
          return roster;
        } catch (e) { console.warn('[academic] loadStudents path', p, e?.message); }
      }
      return [];
    }

    /** Filter by class/stream - uses classMatches for all classes (Pre-Unit, Pre Unit Class, Class 1, etc.) */
    async function fetchStudents(className, stream, yearOverride) {
      const all = await loadAllStudentsFromDb(yearOverride);
      if (!className && !stream) return all;
      const normalizedStream = (stream || '').toUpperCase().replace(/[\s-]/g, '');
      return all.filter((s) => {
        const classOk = !className || classMatches(className, s.class);
        const streamOk = !stream || String(s.stream || '').toUpperCase().replace(/[\s-]/g, '').includes(normalizedStream);
        return classOk && streamOk;
      });
    }

    function normalizeStudentRecord(admKey, s) {
      const name = [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ').trim() || s.name || s.fullName || ('Student ' + admKey);
      let sClass = s.class || s.currentClass || s.level || s.className || s.grade || s.classLevel || '';
      if (sClass && SomapSub().canonClass) {
        sClass = SomapSub().canonClass(sClass);
      }
      const sStream = s.stream || s.streamName || s.section || '';
      const feeDue = Number(s.totalFee || s.feePerYear || s.feeDue || s.required || s.debt || 0);
      let feePaid = Number(s.paid || s.feePaid || s.totalPaid || s.paidAmount || s.credit || 0);
      if (s.payments && typeof s.payments === 'object') {
        feePaid = Object.values(s.payments).reduce((sum, p) => sum + Number(p.amount || 0), 0);
      }
      const balance = Number(s.balance || Math.max(0, feeDue - feePaid) || 0);
      return {
        id: String(s._id || s.studentId || s.id || admKey),
        adm: String(admKey),
        admissionNo: String(s.admissionNumber || s.admissionNo || s.admNo || admKey),
        name,
        class: sClass,
        stream: sStream,
        feeDue,
        feePaid,
        balance,
        status: s.status || '',
        parentContact: s.parentContact || s.parentPhone || s.guardianPhone || s.phone || '',
        meta: s
      };
    }

    /* ---------- Attendance + fees + scores fetchers ---------- */
    async function fetchAttendance(year, month, className) {
      if (!getDB()) return {};
      const refPath = `attendance/${year}/${month}/${className}`;
      try {
        const found = await readFirstExisting([refPath]);
        const out = {};
        if (found?.snap && found.snap.exists && found.snap.exists()) {
          const val = found.snap.val();
          Object.keys(val).forEach(adm => {
            const a = val[adm] || {};
            out[adm] = { present: Number(a.present || a.daysPresent || 0), absent: Number(a.absent || a.daysAbsent || 0), days: Number(a.days || (Number(a.present || 0) + Number(a.absent || 0))) };
          });
        }
        return out;
      } catch (e) { console.warn('fetchAttendance', e && e.message); return {}; }
    }

    async function fetchFees(year, className) {
      if (!getDB()) return {};
      const refPath = `fees/${year}/${className}`;
      try {
        const found = await readFirstExisting([refPath]);
        const out = {};
        if (found?.snap && found.snap.exists && found.snap.exists()) {
          const val = found.snap.val();
          Object.keys(val).forEach(adm => {
            const f = val[adm] || {};
            const required = Number(f.required || f.expected || f.total || 0);
            const paid = Number(f.paid || f.paidAmount || 0);
            out[adm] = { required, paid, balance: Math.max(0, required - paid) };
          });
        }
        return out;
      } catch (e) { console.warn('fetchFees', e && e.message); return {}; }
    }

    async function fetchScores({ year, className, examKey, month }) {
      if (!getDB()) return {};

      // 1. Build tolerant class key candidates: "Class 3" ↔ "3"
      const classCandidates = [];
      if (className) {
        const cls = String(className).trim();
        classCandidates.push(cls);

        const match = cls.match(/(\d+)/);
        if (match) {
          const num = match[1];
          const numericKey = num;
          const withPrefix = `Class ${num}`;

          if (!classCandidates.includes(numericKey)) classCandidates.push(numericKey);
          if (!classCandidates.includes(withPrefix)) classCandidates.push(withPrefix);
        }
      }

      const variants = monthVariants(month);
      const paths = [];

      classCandidates.forEach(clsKey => {
        const base = `/scores/${year}/${clsKey}`;
        variants.forEach(v => {
          paths.push(`${base}/${examKey}/${v}`);
          paths.push(`${base}/${examKey.toLowerCase()}/${v}`);
          paths.push(`${base}/${examKey.toUpperCase()}/${v}`);
          paths.push(`${base}/${v}`); // when examKey level is missing
        });
      });

      const out = {};

      for (const refPath of paths) {
        try {
          const found = await readFirstExisting([refPath]);
          const snap = found?.snap || null;
          console.log('[academic.fetchScores] trying', refPath, Boolean(snap && snap.exists && snap.exists()));

          if (snap && snap.exists && snap.exists()) {
            const val = snap.val() || {};

            Object.keys(val).forEach(adm => {
              out[adm] = out[adm] || {};
              const subjObj = val[adm] || {};
              Object.keys(subjObj).forEach(sub => {
                const o = subjObj[sub] || {};
                const canonicalLabel = SomapSub().canonSubject
                  ? SomapSub().canonSubject(sub)
                  : sub;
                const labelKey = canonicalLabel || sub;
                const entry = {
                  score: Number(o.score || 0),
                  max: Number(o.max || 100),
                };
                out[adm][labelKey] = entry;
                if (!out[adm][sub]) out[adm][sub] = entry;
              });
            });

            if (Object.keys(out).length) break;
          }
        } catch (e) {
          console.warn('[academic.fetchScores] error on', refPath, e);
        }
      }

      if (!Object.keys(out).length) {
        console.warn(
          '[academic.fetchScores] NO DATA for',
          { year, className, examKey, month, classCandidates, pathsTried: paths }
        );
      }

      return out;
    }

    function studentAveragePercent(student){
      const scores = state.scores[student.adm] || {};
      const pairs = (state.subjectList || []).map(sub => {
        const entry = scores[sub] || {};
        return { score: entry.score, max: entry.max };
      });
      return studentPercentFrom(pairs);
    }

    /* ---------- Load sequence (main entry) ---------- */
    async function loadAll() {
      // 1. Guard: Check if critical elements exist
      if (!classSelect || !yearSelect || !monthSelect || !examType) return;

      const selectedClass = classSelect.value;
      const selectedYear  = yearSelect.value;
      const selectedMonth = monthSelect.value;
      const selectedExam  = examType.value;

      // 3. Guard: Check if all filters have values
      if (!selectedClass || !selectedYear || !selectedMonth || !selectedExam) {
        console.warn('[academic.loadAll] Incomplete filters, aborting', {
          selectedClass, selectedYear, selectedMonth, selectedExam
        });
        return;
      }

      const selectedClassValue = SomapSub().canonClass ? SomapSub().canonClass(selectedClass) : selectedClass;
      if (state.assignedClass && selectedClassValue !== state.assignedClass) {
        alert('NOT YOUR CLASS BUDDY! You are restricted to ' + state.assignedClass);
        classSelect.value = state.assignedClass;
        return;
      }

      state.className = selectedClassValue;
      
      // Update state directly from selects
      state.year = selectedYear;
      state.month = selectedMonth;
      state.examKey = EXAM_KEYS[selectedExam] || 'monthly';
      state.schoolBranch = (schoolBranch && schoolBranch.value) ? schoolBranch.value.trim() : '';
      
      let inputStream = (streamInput && streamInput.value) ? streamInput.value.trim() : '';

      const classNumMatch = state.className.match(/\d+/);
      const classNum = classNumMatch ? classNumMatch[0] : '';
      const effectiveStream = inputStream.replace(/class/i, '').replace(classNum, '').trim().toUpperCase();
      state.stream = effectiveStream;

      state.subjectList = getSubjectList(state.className, state.year);

      console.log('[ACADEMIC] loadAll start', {
        className: state.className,
        year: state.year,
        examScopeLabel: selectedExam,
        examScope: state.examKey,
        monthLabel: state.month
      });

      state.students = await fetchStudents(state.className, state.stream, state.year);
      initTransferHubIfReady();
      if (transferHub?.refresh) transferHub.refresh();
      state.attendance = await fetchAttendance(state.year, state.month, state.className) || {};
      state.fees = await fetchFees(state.year, state.className) || {};

      console.log('[ACADEMIC] fetching scores...');
      const newScores = await fetchScores({ year: state.year, className: state.className, examKey: state.examKey, month: state.month }) || {};

      console.log('[ACADEMIC] scores loaded', {
        studentCount: Object.keys(newScores || {}).length,
        rosterCount: state.students.length
      });

      if (newScores && Object.keys(newScores).length) {
        state.scores = newScores;
      }

      updateKPIs();
      drawCharts();
    }

    /* ---------- Authentication and class lock ---------- */
    firebase.auth().onAuthStateChanged(user => {
      if (!user) {
        window.location.href = 'index.html';
        return;
      }
      const safeEmail = user.email.replace('.', '_');
      const db = getDB();
      db.ref('users/' + safeEmail).once('value').then(snap => {
        const ud = snap.val() || {};
        const allowedRoles = ['teacher', 'admin', 'head', 'academic'];
        if (!allowedRoles.includes(String(ud.role || '').toLowerCase())) {
          alert('Unauthorized: teachers, admins, and academic staff only');
          firebase.auth().signOut();
          window.location.href = 'index.html';
          return;
        }
        // Parse class from email or use Firebase user data (teachers get locked to class; admin/head can pick any)
        const role = String(ud.role || '').toLowerCase();
        const isTeacherOnly = role === 'teacher';
        const derivedClass = parseClassFromEmail(user.email) || ud.class || ud.classLevel || '';
        state.assignedClass = SomapSub().canonClass ? SomapSub().canonClass(derivedClass) : derivedClass;
        if (isTeacherOnly && (!state.assignedClass || !Object.keys(SomapSub().SUBJECTS_BY_CLASS || {}).includes(state.assignedClass))) {
          alert('Invalid or no class assigned. Contact administrator.');
          firebase.auth().signOut();
          window.location.href = 'index.html';
          return;
        }
        // Lock dropdown to assigned class for teachers only; admin/head can select any class
        populateClasses(isTeacherOnly ? state.assignedClass : null);
        classSelect.value = state.assignedClass || (classSelect.options.length ? classSelect.options[0].value : '');
        
        // Ensure yearSelect uses yearContext (2025 anchor; Class 3 2025 → Class 4 2026)
        if (yearSelect) {
            const ctxYear = window.somapYearContext?.getSelectedYear?.() || new Date().getFullYear().toString();
            yearSelect.innerHTML = '';
            const currentYear = new Date().getFullYear();
            for (let y = currentYear - 2; y <= currentYear + 2; y++) {
                const opt = document.createElement('option');
                opt.value = String(y);
                opt.textContent = y;
                yearSelect.appendChild(opt);
            }
            yearSelect.value = ctxYear;
            yearSelect.dataset.somapYearManualLock = '1';
            yearSelect.addEventListener('change', () => {
                if (window.somapYearContext?.setSelectedYear) window.somapYearContext.setSelectedYear(yearSelect.value);
            });
        }
        
        // Wait for DOM to stabilize before initial load
        setTimeout(() => {
          initTransferHubIfReady();
          loadAll();
        }, 0);
      });
    });

    /* ---------- Computation: totals/averages/positions/grades ---------- */
    function updateKPIs() {
      const list = Object.values(state.students).map(s => {
        const sum = studentAveragePercent(s);
        return { name: s.name, avg: sum.pct, attemptedCount: sum.attemptedCount };
      });
      const contributors = list.filter(x => (x.attemptedCount || 0) > 0);
      if (contributors.length === 0) {
        ['kpiTopStudent', 'kpiTopScore', 'kpiBottomStudent', 'kpiBottomScore', 'kpiClassMax', 'kpiClassGrade', 'kpiPresent', 'kpiAbsent', 'kpiFeeRequired', 'kpiFeePaid', 'kpiFeeBalance'].forEach(id => document.getElementById(id).textContent = '-');
        return;
      }
      const sorted = contributors.slice().sort((a, b) => b.avg - a.avg);
      const top = sorted[0];
      const bottom = sorted[sorted.length - 1];
      kpiTopStudent.textContent = top.name || '–';
      kpiTopScore.textContent = (top.avg || 0).toFixed(2) + '%';
      kpiBottomStudent.textContent = bottom.name || '–';
      kpiBottomScore.textContent = (bottom.avg || 0).toFixed(2) + '%';
      kpiClassMax.textContent = (top.avg || 0).toFixed(2) + '%';
      const classAvg = sorted.reduce((s, x) => s + (x.avg || 0), 0) / sorted.length;
      kpiClassGrade.textContent = gradeFromPercent(classAvg);

      let sumPresent = 0, sumAbsent = 0, sumDays = 0;
      state.students.forEach(s => {
        const att = state.attendance[s.adm] || { present: 0, absent: 0, days: 0 };
        sumPresent += att.present;
        sumAbsent += att.absent;
        sumDays += att.days || (att.present + att.absent);
      });
      const pctPresent = sumDays ? (sumPresent / sumDays) * 100 : 0;
      const pctAbsent = sumDays ? (sumAbsent / sumDays) * 100 : 0;
      kpiPresent.textContent = pctPresent.toFixed(1) + '%';
      kpiAbsent.textContent = pctAbsent.toFixed(1) + '%';

      let totalReq = 0, totalPaid = 0, totalBal = 0;
      state.students.forEach(s => {
        const fee = state.fees[s.adm] || { required: s.feeDue || 0, paid: s.feePaid || 0, balance: s.balance || 0 };
        totalReq += fee.required || 0;
        totalPaid += fee.paid || 0;
        totalBal += fee.balance || 0;
      });
      kpiFeeRequired.textContent = money(totalReq);
      kpiFeePaid.textContent = money(totalPaid);
      kpiFeeBalance.textContent = money(totalBal);
    }

    /* ---------- Charts (bounded) ---------- */
    function drawCharts() {
      const MAX_LABELS = 50;
      const subjects = state.subjectList || [];
      const avgPerSubject = subjects.map(sub => {
        let sum = 0, cnt = 0;
        state.students.forEach(s => {
          const entry = state.scores[s.adm]?.[sub] || {};
          const rawScore = entry.score;
          const rawMax = entry.max;
          const sc = Number(rawScore);
          const mx = Number(rawMax);
          const attempted = attemptedItem({ score: sc, max: mx });
          if (!attempted) return;
          sum += (sc * 100) / mx;
          cnt++;
        });
        return cnt ? sum / cnt : 0;
      });

      const topList = state.students.map(s => {
        const sum = studentAveragePercent(s);
        return { name: s.name, avg: sum.pct, attemptedCount: sum.attemptedCount };
      }).filter(x => (x.attemptedCount || 0) > 0).sort((a, b) => b.avg - a.avg).slice(0, 10);

      try { if (subjectsChart) { subjectsChart.destroy(); subjectsChart = null; } } catch (e) {}
      try { if (top10Chart) { top10Chart.destroy(); top10Chart = null; } } catch (e) {}

      const subjectsToShow = subjects.slice(0, MAX_LABELS);
      const avgToShow = avgPerSubject.slice(0, MAX_LABELS);

      subjectsChart = new Chart(subjectsChartCtx, {
        type: 'bar',
        data: { labels: subjectsToShow, datasets: [{ label: 'Average %', data: avgToShow, backgroundColor: '#4B5EAA' }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 }, x: { ticks: { autoSkip: true, maxTicksLimit: 12 } } } }
      });

      top10Chart = new Chart(top10ChartCtx, {
        type: 'bar',
        data: { labels: topList.map(x => x.name), datasets: [{ label: 'Overall %', data: topList.map(x => x.avg), backgroundColor: '#6B7280' }] },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, max: 100 }, x: { ticks: { autoSkip: true } } } }
      });
    }

    /* ---------- Small helpers ---------- */
    function money(n) { n = Number(n || 0); return new Intl.NumberFormat('en-TZ', { style: 'currency', currency: 'TZS', maximumFractionDigits: 0 }).format(n); }
    let transferHub = null;
    function initTransferHubIfReady() {
      if (transferHub || !window.SomapClassTransfer || !(state.className || state.assignedClass)) return;
      transferHub = window.SomapClassTransfer.mount({
        hostId: 'transferHubHost',
        schoolId: currentSchoolId,
        schoolName: currentSchool?.name || 'School',
        getDB,
        getContext: () => ({
          className: state.className || state.assignedClass || '',
          year: String(state.year || yearSelect?.value || new Date().getFullYear()),
          students: Array.isArray(state.students) ? state.students : []
        }),
        onSaved: () => loadAll()
      });
    }

    /* ---------- Load on change ---------- */
    classSelect.addEventListener('change', () => {
      if (state.assignedClass) {
        const selected = SomapSub().canonClass ? SomapSub().canonClass(classSelect.value) : classSelect.value;
        if (selected !== state.assignedClass) {
          alert('NOT YOUR CLASS BUDDY! You are restricted to ' + state.assignedClass);
          classSelect.value = state.assignedClass;
          return;
        }
      }
      loadAll();
    });
    streamInput.addEventListener('change', loadAll);
    monthSelect.addEventListener('change', loadAll);
    yearSelect.addEventListener('change', loadAll);
    examType.addEventListener('change', loadAll);
    schoolBranch.addEventListener('change', loadAll);

    // --- SCORESHEET: simple, robust wiring ---
    const scoresheetModal = document.getElementById('scoresheetModal');
    const scoresheetFrame = document.getElementById('scoresheetFrame');
    const closeModal = document.getElementById('closeModal');
    const btnOpenScoresheet = document.getElementById('btnOpenScoresheet');

    function openScoresheetModal() {
      if (!scoresheetModal || !scoresheetFrame) {
        console.warn('Scoresheet modal elements not found.');
        return;
      }

      const yearSelect = document.getElementById('yearSelect');
      const classSelect = document.getElementById('classSelect');
      const streamInput = document.getElementById('streamInput');
      const examTypeSelect = document.getElementById('examType');
      const monthSelect = document.getElementById('monthSelect');

      const year = (yearSelect && yearSelect.value) || new Date().getFullYear().toString();
      const className = classSelect && classSelect.value;
      const stream = streamInput && streamInput.value;
      const examType = examTypeSelect && examTypeSelect.value;
      const month = monthSelect && monthSelect.value;

      if (!className) { alert('Please select a class first.'); return; }
      if (!examType) { alert('Please select an exam type (monthly, midterm, etc.).'); return; }
      if (!month) { alert('Please select a month.'); return; }
      if (!year) { alert('Please select a year.'); return; }

      const yearSpan = document.getElementById('selectedYear');
      const classSpan = document.getElementById('scoresheetClass');
      const streamSpan = document.getElementById('scoresheetStream');
      const examTypeSpan = document.getElementById('scoresheetExamType');
      const monthSpan = document.getElementById('scoresheetMonth');

      if (yearSpan) yearSpan.innerText = year;
      if (classSpan) classSpan.innerText = className;
      if (streamSpan) streamSpan.innerText = stream || '';
      if (examTypeSpan) examTypeSpan.innerText = examType;
      if (monthSpan) monthSpan.innerText = month;

      const queryParams = new URLSearchParams({
        year,
        class: className,
        stream: stream || '',
        examType,
        month
      });

      scoresheetFrame.src = `Toacademichtml/scoresheet.html?${queryParams.toString()}`;
      scoresheetModal.style.display = 'block';
    }

    if (btnOpenScoresheet) {
      btnOpenScoresheet.addEventListener('click', (event) => {
        event.preventDefault();
        openScoresheetModal();
      });
    }

    if (closeModal) {
      closeModal.addEventListener('click', () => {
        if (scoresheetModal) scoresheetModal.style.display = 'none';
      });
    }

    window.addEventListener('click', (event) => {
      if (scoresheetModal && event.target === scoresheetModal) {
        scoresheetModal.style.display = 'none';
      }
    });
  </script>
  <script src="./js/modules/grading.js"></script>
  <script>
    const { percent, gradeFromPercent: gradingGradeFromPercent, letterAndPercent } = window.Grading;
  </script>
</body>
</html>
