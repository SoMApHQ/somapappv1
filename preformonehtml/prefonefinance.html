<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SoMAp — Pre‑Form One Finance</title>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <!-- Shared logic (year selection, helpers) -->
  <script src="prefonecommon.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Poppins', 'Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            somap: {
              midnight: '#020617',
              ocean: '#0ea5e9',
              orchid: '#8b5cf6',
              mint: '#34d399',
              amber: '#fbbf24',
            },
          },
          boxShadow: {
            neon: '0 20px 60px -28px rgba(14,165,233,.7)',
          },
        },
      },
    };
  </script>
  <style>
    body{
      background: radial-gradient(circle at 20% -10%, rgba(79, 70, 229, 0.35), rgba(15, 23, 42, 0.96) 62%);
      min-height:100vh;color:#e2e8f0;font-family:'Inter',system-ui,sans-serif
    }
    .glass{background:rgba(15,23,42,.82);border-radius:1.75rem;border:1px solid rgba(148,163,184,.22);backdrop-filter:blur(16px);box-shadow:0 30px 80px -45px rgba(8,47,73,.85)}
    .stat{position:relative;border-radius:1.35rem;padding:1.35rem;background:linear-gradient(135deg, rgba(20,184,166,.22), rgba(59,130,246,.24));border:1px solid rgba(148,163,184,.28);box-shadow:0 25px 65px -50px rgba(20,184,166,.9);transition:transform .18s ease,border-color .2s ease, box-shadow .2s ease}
    .stat:hover{transform:translateY(-6px);border-color:rgba(96,165,250,.55);box-shadow:0 35px 80px -50px rgba(59,130,246,.75)}
    .pill{padding:.35rem .85rem;border-radius:999px;font-size:.75rem;font-weight:600;letter-spacing:.02em}
    .paid{background:rgba(34,197,94,.22);color:#86efac;border:1px solid rgba(34,197,94,.4)}
    .partial{background:rgba(250,204,21,.18);color:#facc15;border:1px solid rgba(250,204,21,.38)}
    .overdue{background:rgba(248,113,113,.2);color:#fca5a5;border:1px solid rgba(248,113,113,.45)}
    .pending{background:rgba(56,189,248,.18);color:#7dd3fc;border:1px solid rgba(56,189,248,.38)}
    .chip{display:inline-flex;align-items:center;gap:.35rem;border-radius:999px;padding:.3rem .85rem;border:1px solid rgba(148,163,184,.24);background:rgba(148,163,184,.12);font-size:.75rem;color:rgba(226,232,240,.85);letter-spacing:.02em;text-transform:uppercase}
    .chip.over{border-color:rgba(248,113,113,.45);background:rgba(248,113,113,.12);color:#fca5a5}
    .chip.soon{border-color:rgba(250,204,21,.4);background:rgba(250,204,21,.12);color:#facc15}
    .chip.good{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.14);color:#bbf7d0}
    .chip.wait{border-color:rgba(59,130,246,.4);background:rgba(59,130,246,.14);color:#bfdbfe}
    table thead th{text-transform:uppercase;letter-spacing:.04em;font-size:.68rem}
    table tbody td{border-bottom:1px solid rgba(148,163,184,.12)}
    table tfoot td{background:rgba(59,130,246,.12);border-top:1px solid rgba(59,130,246,.35)}
    .backdrop{display:none;position:fixed;inset:0;z-index:50;background:rgba(2,6,23,.65);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:1.5rem}
    .card{width:100%;max-width:460px;border-radius:1.5rem;background:rgba(15,23,42,.95);border:1px solid rgba(148,163,184,.25);box-shadow:0 35px 90px -45px rgba(14,165,233,.75);color:#e2e8f0}
    .card.wide{max-width:620px}
    .card input,.card select,.card textarea{background:rgba(30,41,59,.65);border:1px solid rgba(148,163,184,.28);border-radius:.9rem;color:#e2e8f0;width:100%}
    .card input:focus,.card select:focus{outline:none;border-color:rgba(14,165,233,.6);box-shadow:0 0 0 1px rgba(14,165,233,.25)}
  </style>
</head>
<body class="relative min-h-screen overflow-x-hidden">
  <!-- lighting -->
  <div class="pointer-events-none absolute inset-0 -z-10">
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_80%_20%,rgba(99,102,241,0.24),transparent_40%)]"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_15%_25%,rgba(14,165,233,0.16),transparent_35%)]"></div>
    <div class="absolute inset-0 bg-[linear-gradient(140deg,rgba(2,6,23,0.85),rgba(15,23,42,0.95))]"></div>
  </div>

  <main class="relative mx-auto flex w-full max-w-7xl flex-col gap-10 px-4 py-10 sm:px-6 lg:px-10">
    <header class="flex flex-col gap-6 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <span class="inline-flex items-center gap-2 rounded-full border border-sky-500/30 bg-sky-500/10 px-3 py-1 text-xs font-semibold uppercase tracking-[0.3em] text-sky-200/80">
          <i class="fas fa-coins text-sky-300"></i> Finance Desk
        </span>
        <h1 class="mt-4 text-3xl font-semibold text-slate-100 sm:text-4xl">Pre‑Form One — Finance Control Room</h1>
        <p class="mt-2 max-w-2xl text-sm text-slate-400 sm:text-base">Track collections, balances, and expenses with a calm, glass dashboard.
        </p>
      </div>
      <a href="prefonedashboard.html" class="inline-flex items-center gap-2 rounded-full border border-slate-500/40 bg-slate-900/40 px-4 py-2 text-sm font-medium text-slate-200 transition hover:border-sky-400/60 hover:bg-slate-900/70 hover:text-white">
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
      </a>
    </header>

    <!-- KPIs -->
    <section class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-5">
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Total Due</span><p id="totalDue" class="mt-2 text-2xl font-semibold text-sky-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Projected invoices.</p></article>
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Collected</span><p id="collected" class="mt-2 text-2xl font-semibold text-emerald-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Payments posted.</p></article>
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Outstanding</span><p id="outstanding" class="mt-2 text-2xl font-semibold text-amber-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Balances for follow‑up.</p></article>
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Expenses</span><p id="expensesTotal" class="mt-2 text-2xl font-semibold text-rose-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Approved spending.</p></article>
      <article class="stat"><span class="text-xs uppercase tracking-widest text-slate-300">Net Balance</span><p id="netBal" class="mt-2 text-2xl font-semibold text-indigo-100">TSh 0</p><p class="mt-4 text-xs text-slate-400">Collections − Expenses.</p></article>
    </section>

    <!-- Learners -->
    <section class="glass px-6 py-8 sm:px-8 sm:py-10">
      <div class="flex flex-col gap-5 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-white">Learner Collections</h2>
          <p class="mt-1 text-sm text-slate-400">Monitor fees per child, highlight debtors, and export registers.</p>
        </div>
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
          <label class="text-xs font-semibold uppercase tracking-widest text-slate-400 sm:text-right">Filter Cohort</label>
          <select id="classFilter" class="w-full rounded-full border border-slate-500/40 bg-slate-900/50 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 sm:w-56" onchange="renderTable()">
            <option value="">All Pre‑Form One</option>
            <option>September Joiners</option>
            <option>October Joiners</option>
            <option>November Joiners</option>
          </select>
        </div>
      </div>

      <div class="mt-6 flex flex-col gap-3 md:flex-row md:flex-wrap md:items-center md:justify-between">
        <button id="debtorsBtn" onclick="toggleDebtors()" class="inline-flex items-center gap-2 rounded-full border border-amber-400/50 bg-amber-500/15 px-4 py-2 text-sm font-medium text-amber-200 transition hover:border-amber-300 hover:bg-amber-500/25">
          <i class="fas fa-exclamation-triangle"></i>
          <span id="debtorsToggleLabel">Show Debtors</span>
        </button>
        <div class="flex flex-wrap gap-2">
          <button onclick="exportMainCSV()" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/15 px-4 py-2 text-sm font-medium text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-400/25"><i class="fas fa-file-csv"></i> Main CSV</button>
          <button onclick="exportMainPDF()" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-400/15 px-4 py-2 text-sm font-medium text-rose-100 transition hover:border-rose-300 hover:bg-rose-400/25"><i class="fas fa-file-pdf"></i> Main PDF</button>
          <button onclick="exportDebtorsCSV()" class="inline-flex items-center gap-2 rounded-full border border-amber-400/40 bg-amber-400/15 px-4 py-2 text-sm font-medium text-amber-100 transition hover:border-amber-300 hover:bg-amber-400/25"><i class="fas fa-file-csv"></i> Debtors CSV</button>
          <button onclick="exportDebtorsPDF()" class="inline-flex items-center gap-2 rounded-full border border-orange-400/40 bg-orange-400/15 px-4 py-2 text-sm font-medium text-orange-100 transition hover:border-orange-300 hover:bg-orange-400/25"><i class="fas fa-file-pdf"></i> Debtors PDF</button>
        </div>
      </div>

      <div class="mt-6 hidden items-center gap-2 text-slate-400" id="loadLine"><i class="fas fa-circle-notch fa-spin"></i><span>Loading learners…</span></div>

      <div id="debtorAlert" class="mt-6 hidden rounded-3xl border border-rose-500/40 bg-rose-900/40 p-5 text-sm text-rose-100 shadow-lg shadow-rose-900/30"></div>

      <div class="mt-4 overflow-x-auto rounded-3xl border border-slate-500/30 bg-slate-900/35">
        <table class="min-w-full text-left text-sm text-slate-100">
          <thead class="border-b border-slate-500/30 bg-slate-900/60 text-xs text-slate-300">
            <tr>
              <th class="px-5 py-4">ADM No</th>
              <th class="px-5 py-4">Full Name</th>
              <th class="px-5 py-4">Parent Contact</th>
              <th class="px-5 py-4">Total Fee</th>
              <th class="px-5 py-4">Payment Plan</th>
              <th class="px-5 py-4">Paid</th>
              <th class="px-5 py-4">Balance</th>
              <th class="px-5 py-4">Debt Till</th>
              <th class="px-5 py-4">Status</th>
              <th class="px-5 py-4 text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="financeBody" class="divide-y divide-slate-500/15"></tbody>
          <tfoot id="financeTotals"></tfoot>
        </table>
      </div>
    </section>

    <!-- Expenses -->
    <section class="glass px-6 py-8 sm:px-8 sm:py-10">
      <div class="flex flex-col gap-4 lg:flex-row lg:items-start lg:justify-between">
        <div>
          <h2 class="text-xl font-semibold text-white">Operations Expenses</h2>
          <p class="mt-1 text-sm text-slate-400">Log daily spending and export a clean register.</p>
        </div>
        <form id="expenseForm" class="flex w-full flex-col gap-3 rounded-2xl border border-slate-500/30 bg-slate-900/30 p-4 md:w-auto md:flex-row md:items-center md:gap-4">
          <select id="expenseCategory" class="w-full rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 md:w-44" required>
            <option value="">Category</option>
            <option>STATIONERY</option>
            <option>TRANSPORT</option>
            <option>PURCHASES</option>
            <option>SIL</option>
            <option>MAINTENANCE</option>
            <option>BOOKS</option>
            <option>EMERGENCY</option>
            <option>MISCELLANEOUS</option>
          </select>
          <input id="expenseDescription" type="text" placeholder="Description" class="w-full rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 md:w-56" required />
          <input id="expenseAmount" type="number" min="1" placeholder="Amount" class="w-full rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-100 outline-none transition focus:border-sky-400 focus:ring-1 focus:ring-sky-500 md:w-40" required />
          <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-full border border-indigo-400/40 bg-indigo-500/20 px-4 py-2 text-sm font-semibold text-indigo-100 transition hover:border-indigo-300 hover:bg-indigo-500/30 md:w-auto"><i class="fas fa-plus-circle"></i> Add Expense</button>
        </form>
      </div>

      <div class="mt-6 flex flex-wrap gap-2">
        <button onclick="exportExpenseCSV()" class="inline-flex items-center gap-2 rounded-full border border-emerald-400/40 bg-emerald-400/15 px-4 py-2 text-sm font-medium text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-400/25"><i class="fas fa-file-csv"></i> Expenses CSV</button>
        <button onclick="exportExpensePDF()" class="inline-flex items-center gap-2 rounded-full border border-rose-400/40 bg-rose-400/15 px-4 py-2 text-sm font-medium text-rose-100 transition hover:border-rose-300 hover:bg-rose-400/25"><i class="fas fa-file-pdf"></i> Expenses PDF</button>
      </div>

      <div class="mt-8 overflow-x-auto rounded-3xl border border-slate-500/30 bg-slate-900/35">
        <table class="min-w-full text-left text-sm text-slate-100">
          <thead class="border-b border-slate-500/30 bg-slate-900/60 text-xs text-slate-300">
            <tr>
              <th class="px-5 py-4">Category</th>
              <th class="px-5 py-4">Description</th>
              <th class="px-5 py-4">Amount</th>
              <th class="px-5 py-4">Date</th>
            </tr>
          </thead>
          <tbody id="expenseBody" class="divide-y divide-slate-500/15"></tbody>
          <tfoot id="expenseTotals"></tfoot>
        </table>
      </div>
    </section>
  </main>

  <!-- Payment Modal -->
  <div id="paymentModal" class="backdrop">
    <div class="card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white"><i class="fas fa-money-check mr-2 text-sky-300"></i> Add Payment</h2>
        <button type="button" class="text-slate-400 transition hover:text-white" onclick="closeModal('paymentModal')"><i class="fas fa-times text-lg"></i></button>
      </div>
      <form id="paymentForm" class="mt-6 space-y-4">
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Amount Received</label>
          <input id="paymentAmount" type="number" min="1" class="px-4 py-3 text-sm" placeholder="Enter amount" required />
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Received On</label>
          <input id="paymentDate" type="date" class="px-4 py-3 text-sm" required />
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Payment Method</label>
          <select id="paymentMethod" class="px-4 py-3 text-sm">
            <option>Cash</option>
            <option>MPesa</option>
            <option>Airtel Money</option>
            <option>TigoPesa</option>
            <option>Bank Transfer</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Reference Code</label>
          <input id="paymentReference" type="text" class="px-4 py-3 text-sm" placeholder="MPESA/Bank/Receipt code" />
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Collector (who received)</label>
          <input id="paymentCollector" type="text" class="px-4 py-3 text-sm" placeholder="e.g., Faith / Mr. Mussa" />
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Notes (optional)</label>
          <textarea id="paymentNote" rows="2" class="px-4 py-3 text-sm" placeholder="Reference, receipt #, etc."></textarea>
        </div>
        <div class="flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
          <button type="button" onclick="closeModal('paymentModal')" class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-500/40 px-4 py-2 text-sm font-medium text-slate-300 transition hover:border-slate-300 hover:text-white">Cancel</button>
          <button type="submit" class="inline-flex items-center justify-center gap-2 rounded-full border border-sky-400/40 bg-sky-500/25 px-5 py-2 text-sm font-semibold text-sky-100 transition hover:border-sky-300 hover:bg-sky-500/35"><i class="fas fa-save"></i> Save Payment</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Payment Modal -->
  <div id="editPaymentModal" class="backdrop">
    <div class="card p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white"><i class="fas fa-pen-to-square mr-2 text-amber-300"></i> Edit Payment</h2>
        <button type="button" class="text-slate-400 transition hover:text-white" onclick="closeModal('editPaymentModal')"><i class="fas fa-times text-lg"></i></button>
      </div>
      <form id="editPaymentForm" class="mt-6 space-y-4">
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Chagua Malipo</label>
          <select id="editPaymentSelect" class="px-4 py-3 text-sm">
            <option value="">--</option>
          </select>
          <p id="editNoPayments" class="mt-2 text-xs font-medium text-rose-300 hidden">Hakuna malipo ya kuhariri kwa mwanafunzi huyu.</p>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Kiasi kipya</label>
            <input id="editPaymentAmount" type="number" min="1" class="px-4 py-3 text-sm" placeholder="Ingiza kiasi" required />
          </div>
          <div>
            <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Tarehe</label>
            <input id="editPaymentDate" type="date" class="px-4 py-3 text-sm" required />
          </div>
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div>
            <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Njia</label>
            <select id="editPaymentMethod" class="px-4 py-3 text-sm">
              <option>Cash</option>
              <option>MPesa</option>
              <option>Airtel Money</option>
              <option>TigoPesa</option>
              <option>Bank Transfer</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Mkusanyaji</label>
            <input id="editPaymentCollector" type="text" class="px-4 py-3 text-sm" placeholder="Aliyepokea" />
          </div>
        </div>
        <div>
          <label class="mb-2 block text-xs font-semibold uppercase tracking-widest text-slate-400">Maelezo</label>
          <textarea id="editPaymentNote" rows="2" class="px-4 py-3 text-sm" placeholder="Kumbukumbu, risiti, n.k."></textarea>
        </div>
        <div class="flex flex-col-reverse gap-3 sm:flex-row sm:justify-between">
          <button type="button" onclick="closeModal('editPaymentModal')" class="inline-flex items-center justify-center gap-2 rounded-full border border-slate-500/40 px-4 py-2 text-sm font-medium text-slate-300 transition hover:border-slate-300 hover:text-white">Cancel</button>
          <div class="flex flex-col-reverse gap-3 sm:flex-row">
            <button type="button" onclick="deleteAllPayments()" class="inline-flex items-center justify-center gap-2 rounded-full border border-rose-400/50 bg-rose-500/20 px-4 py-2 text-sm font-semibold text-rose-100 transition hover:border-rose-300 hover:bg-rose-500/30"><i class="fas fa-trash-alt"></i> Delete All Payments</button>
            <button id="editPaymentSubmit" type="submit" class="inline-flex items-center justify-center gap-2 rounded-full border border-amber-400/40 bg-amber-500/25 px-5 py-2 text-sm font-semibold text-amber-100 transition hover:border-amber-300 hover:bg-amber-500/35"><i class="fas fa-save"></i> Update Payment</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="detailsModal" class="backdrop">
    <div class="card wide p-6">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-white"><i class="fas fa-user-circle mr-2 text-indigo-300"></i> Student Finance Details</h2>
        <button type="button" class="text-slate-400 transition hover:text-white" onclick="closeModal('detailsModal')"><i class="fas fa-times text-lg"></i></button>
      </div>
      <div id="detailsContent" class="mt-6 space-y-3 text-sm text-slate-300"></div>
    </div>
  </div>

  <script>
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3",
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- State ---
    let financeData = [];
    let expensesCache = [];
    let showingDebtors = false;
    let selectedAdm = '';
    let selectedPaymentId = '';
    const todayStr = () => new Date().toISOString().split('T')[0];
    const resolveYear = () => {
      if (typeof window.currentYear === 'number' && !Number.isNaN(window.currentYear)) {
        return window.currentYear;
      }
      const storedYear = typeof localStorage !== 'undefined'
        ? parseInt(localStorage.getItem('prefone_year'), 10)
        : Number.NaN;
      if (!Number.isNaN(storedYear)) {
        return storedYear;
      }
      return new Date().getFullYear();
    };

    const DAY_MS = 24 * 60 * 60 * 1000;
    const fmt = (v) => `TSh ${Number(v||0).toLocaleString()}`;
    const safe = (v='') => String(v).replace(/<[^>]*>/g,'');
    const toDateOrNull = (value) => {
      if(!value) return null;
      const d = new Date(value);
      return Number.isNaN(d.getTime()) ? null : d;
    };
    const formatLocalDate = (value) => {
      const d = value instanceof Date ? value : toDateOrNull(value);
      return d ? d.toLocaleDateString('en-GB') : '--';
    };
    const timeValue = (value) => {
      const d = toDateOrNull(value);
      return d ? d.getTime() : 0;
    };
    const statusMeta = {
      cleared: { label:'UMESHALIPA', pillClass:'paid', rowClass:'bg-emerald-500/10 border border-emerald-400/25', balanceClass:'text-emerald-200' },
      overdue: { label:'LIPA SASA', pillClass:'overdue', rowClass:'bg-rose-500/20 border border-rose-400/30', balanceClass:'text-rose-200' },
      dueSoon: { label:'KARIBIA', pillClass:'partial', rowClass:'bg-amber-500/15 border border-amber-400/25', balanceClass:'text-amber-200' },
      pending: { label:'BADO', pillClass:'pending', rowClass:'bg-sky-500/15 border border-sky-400/25', balanceClass:'text-sky-200' },
    };

    // --- Helpers: flexible school path detection (handles naming variations) ---
    async function detectPrefoneBase(){
      const year = resolveYear();
      try{
        const schoolsSnap = await db.ref('/schools').once('value');
        const schools = schoolsSnap.val() || {};
        // Try exact known key first
        let key = Object.keys(schools).find(k => k === 'Socrates School Preform one');
        if(!key){
          // Try fuzzy match: contains 'preform' and 'one'
          key = Object.keys(schools).find(k => /pre\s*form\s*one|preform\s*one/i.test(k));
        }
        if(!key){
          // Last resort: any key containing 'pre' and 'one'
          key = Object.keys(schools).find(k => /pre/i.test(k) && /one/i.test(k)) || 'Socrates School Preform one';
        }
        return `/schools/${key}/${year}`;
      }catch(e){
        console.warn('School detection failed, using default key.', e);
        return `/schools/Socrates School Preform one/${year}`;
      }
    }

    // --- Auth: sign in anonymously if rules require auth ---
    function ensureAuth(){
      return new Promise((resolve)=>{
        const done = ()=> resolve();
        firebase.auth().onAuthStateChanged(u=> u ? done() : null);
        firebase.auth().signInAnonymously().catch(()=>{}).finally(()=>{
          // Give onAuthStateChanged a tick; also resolve after short delay as fallback
          setTimeout(done, 600);
        });
      });
    }

    // --- Loaders ---
    async function loadAll(){
      document.getElementById('loadLine').classList.remove('hidden');
      await ensureAuth();
      const base = await detectPrefoneBase();
      await Promise.all([loadFinance(base), loadExpenses(base)]);
      document.getElementById('loadLine').classList.add('hidden');
    }

    async function resolveDataBase(base){
      const candidates = [];
      const baseTrimmed = base.replace(/\/\d{4}$/, '');
      candidates.push(base);
      if(baseTrimmed !== base){
        candidates.push(baseTrimmed);
      }
      for(const candidate of candidates){
        const snap = await db.ref(`${candidate}/students`).once('value');
        const val = snap.val() || {};
        if(Object.keys(val).length){
          return { base: candidate, students: val };
        }
      }
      return { base, students: {} };
    }

    async function loadFinance(base){
      try{
        const resolved = await resolveDataBase(base);
        const val = resolved.students;
        const list = Object.entries(val);
        let due=0, coll=0;

        financeData = list.map(([adm, s])=>{
          const payments = Object.entries(s.payments || {}).map(([id,p])=>({
            id,
            amount: Number(p.amount||0),
            date: p.date || todayStr(),
            method: p.method || 'Cash',
            note: p.note || '',
            collector: p.collector || p.recorder || '',
          }));
          payments.sort((a,b)=> timeValue(b.date) - timeValue(a.date));
          const paid = payments.reduce((t,p)=>t+Number(p.amount||0),0);
          const totalFee = Number(s.totalFee || s.required || 0);
          const rawBalance = totalFee - paid;
          const bal = rawBalance > 0 ? rawBalance : 0;
          const overPay = rawBalance < 0 ? Math.abs(rawBalance) : 0;
          due += totalFee; coll += paid;

          const planStartRaw = s.reportingDate || s.planStart || s.joinDate || s.registrationDate || null;
          const planStart = toDateOrNull(planStartRaw);
          const plan = planStart ? `Kuanzia ${formatLocalDate(planStart)}` : 'Mpango Kamili';

          const dueCandidates = [
            s.nextDueDate, s.nextDue, s.dueDate, s.expectedDueDate, s.debtDueDate,
            s.planDueDate, s.paymentDueDate, s.nextPaymentDate, s.nextPaymentDue
          ];
          let dueDate = dueCandidates.map(toDateOrNull).find(Boolean) || null;
          if(!dueDate && planStart){
            dueDate = new Date(planStart.getTime());
            dueDate.setMonth(dueDate.getMonth()+1);
          }

          const now = new Date();
          let statusKey = 'pending';
          let chipCls = 'chip wait';
          let debtLabel = '';
          let debtDays = null;

          if(bal <= 0){
            statusKey = 'cleared';
            chipCls = 'chip good';
            debtLabel = overPay>0 ? `Umezidi kulipa ${fmt(overPay)}` : 'Umeshalipa ada yote';
          }else if(dueDate){
            const diffMs = dueDate.getTime() - now.getTime();
            if(diffMs < 0){
              const overdueDays = Math.max(1, Math.ceil(Math.abs(diffMs)/DAY_MS));
              statusKey = 'overdue';
              chipCls = 'chip over';
              debtLabel = `Umepitisha deni siku ${overdueDays}`;
              debtDays = -overdueDays;
            }else if(diffMs <= 7*DAY_MS){
              const daysLeft = Math.max(1, Math.ceil(diffMs/DAY_MS));
              const floorDays = Math.floor(diffMs/DAY_MS);
              statusKey = 'dueSoon';
              chipCls = 'chip soon';
              debtLabel = floorDays <= 0 ? 'Lipia leo' : (daysLeft === 1 ? 'Malipo ni kesho' : `Siku ${daysLeft} kabla ya malipo`);
              debtDays = daysLeft;
            }else{
              const daysLeft = Math.ceil(diffMs/DAY_MS);
              statusKey = 'pending';
              chipCls = 'chip wait';
              debtLabel = `Lipa kabla ya ${formatLocalDate(dueDate)}`;
              debtDays = daysLeft;
            }
          }else{
            statusKey = bal>0 ? 'pending' : 'cleared';
            chipCls = bal>0 ? 'chip wait' : 'chip good';
            debtLabel = bal>0 ? 'Weka tarehe ya malipo' : 'Umeshalipa ada yote';
          }

          const meta = statusMeta[statusKey] || statusMeta.pending;
          const name = `${s.firstName||s.firstname||''} ${s.lastName||s.lastname||''}`.trim() || (s.name||'Unnamed Learner');
          const contact = s.parentContact || s.parentPhone || s.guardianPhone || s.phone || '';

          return {
            adm,
            name,
            contact,
            totalFee,
            plan,
            paid,
            bal,
            debtTill:`<span class="${chipCls}">${safe(debtLabel)}</span>`,
            debtText: debtLabel,
            statusKey,
            statusLabel: meta.label,
            statusClass: meta.pillClass,
            rowToneClass: meta.rowClass,
            balanceClass: meta.balanceClass,
            cohort: s.cohort || s.batch || '',
            photoUrl: s.photoUrl || '',
            rawDebtInfo:{ label:debtLabel, dueDate: dueDate ? dueDate.toISOString() : null, days: debtDays, status: statusKey, overPay },
            payments,
          }
        });

        // KPIs
        const expBase = resolved.base || base;
        const baseExpSnap = await db.ref(`${expBase}/expenses`).once('value');
        const expArr = Object.values(baseExpSnap.val()||{});
        const expTotal = expArr.reduce((t, ex)=>t+Number(ex.amount||0),0);
        document.getElementById('totalDue').textContent = fmt(due);
        document.getElementById('collected').textContent = fmt(coll);
        document.getElementById('outstanding').textContent = fmt(Math.max(0, due-coll));
        document.getElementById('expensesTotal').textContent = fmt(expTotal);
        document.getElementById('netBal').textContent = fmt(coll-expTotal);

        renderTable();
      }catch(err){
        console.error(err);
        Swal.fire('Error', 'Failed to load finance data. Check DB path and rules.\n'+err.message, 'error');
      }
    }

    async function loadExpenses(base){
      try{
        const resolved = await resolveDataBase(base);
        const snap = await db.ref(`${resolved.base}/expenses`).once('value');
        const val = snap.val() || {};
        const list = Object.entries(val).map(([k,v])=>({
          id:k,
          category: v.category||'--',
          description: v.description||'--',
          amount: Number(v.amount||0),
          date: v.date || todayStr(),
        }));
        expensesCache = list;
        renderExpenses();
      }catch(err){
        console.error(err);
        Swal.fire('Error', 'Failed to load expenses. '+err.message, 'error');
      }
    }

    // --- Renderers ---
    function visibleRows(){
      const cohort = document.getElementById('classFilter').value;
      return financeData.filter(r=>{
        const okDebtors = showingDebtors ? r.bal>0 : true;
        const okCohort = cohort ? (String(r.cohort).toLowerCase()===cohort.toLowerCase()) : true;
        return okDebtors && okCohort;
      });
    }

    function renderTable(){
      const tbody = document.getElementById('financeBody');
      const tfoot = document.getElementById('financeTotals');
      tbody.innerHTML = ''; tfoot.innerHTML='';
      renderDebtorBanner();

      const rows = visibleRows();
      let tFee=0, tPaid=0, tBal=0;

      if(!rows.length){
        tbody.innerHTML = `<tr><td colspan="10" class="px-5 py-6 text-center text-sm text-slate-400">No learners found for this view.</td></tr>`;
      }else{
        rows.forEach(row=>{
          tFee += row.totalFee; tPaid += row.paid; tBal += row.bal;
          tbody.insertAdjacentHTML('beforeend', `
            <tr class="transition ${row.rowToneClass||''} hover:bg-slate-900/55">
              <td class="px-5 py-4 font-semibold text-slate-200">${row.adm}</td>
              <td class="px-5 py-4">${safe(row.name)}</td>
              <td class="px-5 py-4">${safe(row.contact)}</td>
              <td class="px-5 py-4">${fmt(row.totalFee)}</td>
              <td class="px-5 py-4 text-xs text-slate-400">${safe(row.plan)}</td>
              <td class="px-5 py-4 text-emerald-200">${fmt(row.paid)}</td>
              <td class="px-5 py-4 ${row.balanceClass||'text-amber-200'} font-semibold">${fmt(row.bal)}</td>
              <td class="px-5 py-4">${row.debtTill}</td>
              <td class="px-5 py-4"><span class="pill ${row.statusClass}">${row.statusLabel}</span></td>
              <td class="px-5 py-4 text-right">
                <div class="flex flex-wrap justify-end gap-2">
                  <button class="inline-flex items-center gap-1 rounded-full border border-slate-500/40 px-3 py-1 text-xs font-semibold text-slate-200 transition hover:border-slate-300 hover:text-white" onclick="viewDetails('${row.adm}')"><i class="fas fa-eye"></i> Tazama</button>
                  <button class="inline-flex items-center gap-1 rounded-full border border-amber-400/50 bg-amber-500/15 px-3 py-1 text-xs font-semibold text-amber-100 transition hover:border-amber-300 hover:bg-amber-500/25" onclick="openEditPayments('${row.adm}')"><i class="fas fa-pen"></i> Hariri</button>
                  <button class="inline-flex items-center gap-1 rounded-full border border-emerald-400/50 bg-emerald-500/15 px-3 py-1 text-xs font-semibold text-emerald-100 transition hover:border-emerald-300 hover:bg-emerald-500/25" onclick="openPaymentModal('${row.adm}')"><i class="fas fa-money-bill"></i> Lipa</button>
                </div>
              </td>
            </tr>`);
        });
      }

      const totalBalanceClass = tBal>0 ? 'text-rose-200' : 'text-emerald-200';
      tfoot.innerHTML = `
        <tr class="text-sm font-semibold text-slate-200">
          <td colspan="3" class="px-5 py-4 uppercase tracking-widest text-slate-300">Totals (${rows.length} learners)</td>
          <td class="px-5 py-4">${fmt(tFee)}</td>
          <td class="px-5 py-4 text-center text-slate-500">--</td>
          <td class="px-5 py-4 text-emerald-200">${fmt(tPaid)}</td>
          <td class="px-5 py-4 ${totalBalanceClass}">${fmt(tBal)}</td>
          <td class="px-5 py-4 text-center text-slate-500">--</td>
          <td class="px-5 py-4 text-center text-slate-500">--</td>
          <td class="px-5 py-4 text-right text-slate-500">--</td>
        </tr>`;
    }

    function renderDebtorBanner(){
      const alertBox = document.getElementById('debtorAlert');
      if(!alertBox) return;
      const overdue = financeData
        .filter(r=>r.statusKey==='overdue' && r.bal>0)
        .sort((a,b)=>b.bal - a.bal);
      if(!overdue.length){
        alertBox.classList.add('hidden');
        alertBox.innerHTML = '';
        return;
      }
      const rowsHtml = overdue.slice(0,7).map(r=>`
        <div class="flex flex-wrap items-center gap-3 rounded-2xl border border-rose-400/30 bg-rose-500/20 px-3 py-2 text-xs sm:text-sm">
          <span class="font-semibold text-rose-50">${safe(r.adm)}</span>
          <span class="flex-1 text-rose-100" title="${safe(r.name)}">${safe(r.name)}</span>
          <span class="text-rose-200" title="${safe(r.contact||'--')}">${safe(r.contact||'--')}</span>
          <span class="font-semibold text-rose-50">${fmt(r.bal)}</span>
          <span class="text-rose-200">${safe(r.rawDebtInfo.label)}</span>
        </div>`).join('');
      const extra = overdue.length>7 ? `<p class="text-xs text-rose-200/80">+${overdue.length-7} wanafunzi zaidi wana deni la kufuatiliwa zaidi.</p>` : '';
      alertBox.classList.remove('hidden');
      alertBox.innerHTML = `
        <div class="flex flex-col gap-3">
          <div class="flex items-center gap-3 text-rose-100">
            <i class="fas fa-bullhorn text-rose-200 text-lg"></i>
            <p class="text-base font-semibold uppercase tracking-wide">SEND HOME HAS NOT PAID FEE</p>
          </div>
          <div class="grid gap-2">
            ${rowsHtml}
          </div>
          ${extra}
        </div>`;
    }

    function renderExpenses(){
      const tbody = document.getElementById('expenseBody');
      const tfoot = document.getElementById('expenseTotals');
      tbody.innerHTML=''; tfoot.innerHTML='';
      if(!expensesCache.length){
        tbody.innerHTML = `<tr><td colspan="4" class="px-5 py-6 text-center text-sm text-slate-400">No expenses recorded yet.</td></tr>`;
        return;
      }
      let total=0;
      expensesCache.forEach(ex=>{
        total += ex.amount;
        tbody.insertAdjacentHTML('beforeend', `
          <tr class="transition hover:bg-slate-900/45">
            <td class="px-5 py-4">${safe(ex.category)}</td>
            <td class="px-5 py-4 text-slate-300">${safe(ex.description)}</td>
            <td class="px-5 py-4 text-rose-200">${fmt(ex.amount)}</td>
            <td class="px-5 py-4">${safe(ex.date)}</td>
          </tr>`);
      });
      tfoot.innerHTML = `
        <tr class="text-sm font-semibold text-slate-200">
          <td colspan="2" class="px-5 py-4 uppercase tracking-widest text-slate-300">Total Expenses</td>
          <td class="px-5 py-4 text-rose-200">${fmt(total)}</td>
          <td class="px-5 py-4 text-right text-slate-500">--</td>
        </tr>`;
    }

    // --- Modals ---
    function openPaymentModal(adm){
      selectedAdm = adm;
      selectedPaymentId = '';
      document.getElementById('paymentDate').value = todayStr();
      document.getElementById('paymentModal').style.display='flex';
    }
    function closeModal(id){
      const el = document.getElementById(id);
      if(el) el.style.display='none';
      if(id==='editPaymentModal'){
        selectedPaymentId = '';
        toggleEditInputs(true);
      }
    }

    function toggleEditInputs(disabled){
      ['editPaymentAmount','editPaymentDate','editPaymentMethod','editPaymentCollector','editPaymentNote','editPaymentSubmit'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.disabled = !!disabled;
      });
    }

    function fillEditPaymentForm(payment){
      if(!payment){
        toggleEditInputs(true);
        selectedPaymentId = '';
        return;
      }
      selectedPaymentId = payment.id;
      document.getElementById('editPaymentAmount').value = payment.amount;
      document.getElementById('editPaymentDate').value = payment.date || todayStr();
      document.getElementById('editPaymentMethod').value = payment.method || 'Cash';
      document.getElementById('editPaymentCollector').value = payment.collector || '';
      document.getElementById('editPaymentNote').value = payment.note || '';
      toggleEditInputs(false);
    }

    function openEditPayments(adm){
      selectedAdm = adm;
      selectedPaymentId = '';
      const form = document.getElementById('editPaymentForm');
      const select = document.getElementById('editPaymentSelect');
      const notice = document.getElementById('editNoPayments');
      if(form) form.reset();
      toggleEditInputs(true);

      const row = financeData.find(r=>r.adm===adm);
      if(!row || !row.payments.length){
        if(select){
          select.innerHTML = `<option value="">Hakuna malipo</option>`;
          select.disabled = true;
        }
        if(notice) notice.classList.remove('hidden');
        document.getElementById('editPaymentModal').style.display='flex';
        return;
      }

      if(select){
        const options = row.payments.map(p=>`<option value="${p.id}">${fmt(p.amount)} - ${formatLocalDate(p.date)} - ${safe(p.method||'Cash')}</option>`).join('');
        select.innerHTML = `<option value="">Chagua malipo ya kurekebisha</option>${options}`;
        select.disabled = false;
        select.value = row.payments[0].id;
      }
      if(notice) notice.classList.add('hidden');
      fillEditPaymentForm(row.payments[0]);
      document.getElementById('editPaymentModal').style.display='flex';
    }

    document.getElementById('paymentForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const amount = Number(document.getElementById('paymentAmount').value);
      const method = document.getElementById('paymentMethod').value;
      const reference = (document.getElementById('paymentReference').value || '').trim();
      const note = document.getElementById('paymentNote').value;
      const date = document.getElementById('paymentDate').value;
      const collector = document.getElementById('paymentCollector').value;
      if(!amount || amount<=0) return Swal.fire('Error','Enter amount','error');
      if(!date) return Swal.fire('Error','Select the date received','error');

      const row = financeData.find(r=>r.adm===selectedAdm);
      if(row && row.totalFee>0 && (row.paid + amount) > row.totalFee){
        return Swal.fire('Angalizo','THIS IS MORE THAN WHAT THE CHILD SHOULD PAY.','warning');
      }

      try{
        const base = await detectPrefoneBase();
        const studentSnap = await db.ref(`${base}/students/${selectedAdm}`).once('value');
        const student = studentSnap.val() || {};
        const totalRequired = Number(student.totalFee || student.required || row?.totalFee || 0);
        const totalPaidBefore = row ? Number(row.paid || 0) : Object.values(student.payments || {}).reduce((sum,p)=>sum+Number(p.amount||0),0);
        const newBalance = Math.max(0, totalRequired - Math.min(totalRequired, totalPaidBefore + amount));
        const fullName = row?.name || `${student.firstName || student.firstname || ''} ${student.lastName || student.lastname || ''}`.trim() || selectedAdm;
        const parentContact = row?.contact || student.parentContact || student.parentPhone || student.guardianPhone || student.phone || '--';
        let recordedBy = 'unknown';
        try{
          if(window.currentUserEmail) recordedBy = window.currentUserEmail;
          else if(firebase.auth){
            const user = firebase.auth().currentUser;
            if(user && user.email) recordedBy = user.email;
          }
        }catch(_){}
        if(!recordedBy || recordedBy === 'unknown') recordedBy = collector || 'unknown';
        const timestamp = date ? new Date(date).getTime() : Date.now();

        const pendingRef = db.ref('approvalsPending').push();
        await pendingRef.set({
          approvalId: pendingRef.key,
          sourceModule: 'prefonefinance',
          studentAdm: selectedAdm,
          studentName: fullName,
          className: student.classLevel || student.class || student.grade || '',
          parentContact,
          amountPaidNow: amount,
          paymentMethod: method,
          paymentReferenceCode: reference || 'N/A',
          datePaid: timestamp,
          recordedBy,
          status: 'pending',
          notes: note,
          totalRequired,
          totalPaidBefore,
          newBalanceAfterThis: newBalance,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          modulePayload: {
            basePath: base,
            admission: selectedAdm,
            payment: { amount, method, note, date, collector, reference, recordedBy, timestamp },
            breakdown: [
              { label: 'Collector', value: collector || 'Not set' },
              { label: 'Received On', value: date ? formatLocalDate(date) : new Date(timestamp).toLocaleDateString('en-GB') },
              { label: 'Fee (Year)', value: fmt(totalRequired) },
              { label: 'Paid Before', value: fmt(totalPaidBefore) },
              { label: 'Balance After Approval', value: fmt(newBalance) },
            ],
          },
        });

        Swal.fire('Submitted','Payment sent to admin for approval.','success');
        closeModal('paymentModal');
        e.target.reset();
        await loadFinance(base);
      }catch(err){
        Swal.fire('Error','Failed to add payment: '+err.message,'error');
      }
    });

    document.getElementById('editPaymentSelect').addEventListener('change', (e)=>{
      const row = financeData.find(r=>r.adm===selectedAdm);
      if(!row) return;
      const payment = row.payments.find(p=>p.id===e.target.value);
      if(!payment){
        selectedPaymentId = '';
        toggleEditInputs(true);
        return;
      }
      fillEditPaymentForm(payment);
    });

    document.getElementById('editPaymentForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!selectedAdm || !selectedPaymentId){
        return Swal.fire('Error','Chagua malipo ya kuhariri kwanza.','error');
      }
      const amount = Number(document.getElementById('editPaymentAmount').value);
      const date = document.getElementById('editPaymentDate').value;
      const method = document.getElementById('editPaymentMethod').value;
      const collector = document.getElementById('editPaymentCollector').value;
      const note = document.getElementById('editPaymentNote').value;
      if(!amount || amount<=0) return Swal.fire('Error','Enter amount','error');
      if(!date) return Swal.fire('Error','Select the date received','error');

      const row = financeData.find(r=>r.adm===selectedAdm);
      if(!row){
        return Swal.fire('Error','Learner not found in the current list. Reload and try again.','error');
      }
      const original = row.payments.find(p=>p.id===selectedPaymentId);
      if(!original){
        return Swal.fire('Error','Payment record missing. Reload and try again.','error');
      }
      const projected = row.paid - Number(original.amount||0) + amount;
      if(row.totalFee>0 && projected > row.totalFee){
        return Swal.fire('Angalizo','THIS IS MORE THAN WHAT THE CHILD SHOULD PAY.','warning');
      }

      try{
        const base = await detectPrefoneBase();
        await db.ref(`${base}/students/${selectedAdm}/payments/${selectedPaymentId}`).update({ amount, method, date, collector, note });
        await db.ref(`${base}/students/${selectedAdm}`).update({ updatedAt: Date.now() });
        Swal.fire('Success','Payment updated','success');
        closeModal('editPaymentModal');
        e.target.reset();
        await loadFinance(base);
      }catch(err){
        Swal.fire('Error','Failed to update payment: '+err.message,'error');
      }
    });

    async function deleteAllPayments(){
      if(!selectedAdm){
        return Swal.fire('Error','No student selected.','error');
      }
      const row = financeData.find(r=>r.adm===selectedAdm);
      if(!row){
        return Swal.fire('Error','Student not found.','error');
      }

      const result = await Swal.fire({
        title: 'ARE YOU SURE?',
        html: `<p class="text-slate-300">Delete ALL payment records for <strong>${safe(row.name)}</strong>?</p><p class="text-rose-300 mt-2">This will reset their paid amount to TSh 0 and cannot be undone!</p>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f43f5e',
        cancelButtonColor: '#475569',
        confirmButtonText: 'Yes, Delete All',
        cancelButtonText: 'Cancel',
        background: 'rgba(15,23,42,0.95)',
        color: '#e2e8f0',
      });

      if(!result.isConfirmed) return;

      try{
        const base = await detectPrefoneBase();
        await db.ref(`${base}/students/${selectedAdm}/payments`).remove();
        await db.ref(`${base}/students/${selectedAdm}`).update({ updatedAt: Date.now() });
        Swal.fire({
          title: 'Deleted!',
          text: 'All payment records have been deleted. You can now start fresh.',
          icon: 'success',
          background: 'rgba(15,23,42,0.95)',
          color: '#e2e8f0',
        });
        closeModal('editPaymentModal');
        await loadFinance(base);
      }catch(err){
        Swal.fire('Error','Failed to delete payments: '+err.message,'error');
      }
    }

    function viewDetails(adm){
      const row = financeData.find(r=>r.adm===adm); if(!row) return;
      const items = (row.payments||[]).map(p=>`
        <li class="grid grid-cols-4 gap-2 rounded-xl border border-slate-600/30 bg-slate-900/50 px-3 py-2 text-xs">
          <span>${new Date(p.date||todayStr()).toLocaleDateString('en-GB')}</span>
          <span class="font-semibold text-emerald-200">${fmt(p.amount)}</span>
          <span class="text-slate-300">${safe(p.method||'Cash')}</span>
          <span class="text-slate-400 truncate" title="${safe(p.collector||p.note||'')}">${safe(p.collector||p.note||'')}</span>
        </li>`).join('');
      const history = items? `<h3 class="pt-4 text-xs font-semibold uppercase tracking-widest text-slate-400">Recent Payments</h3><ul class="mt-2 space-y-2">${items}</ul>` : '<p class="pt-4 text-xs text-slate-500">No payments recorded yet.</p>';
      document.getElementById('detailsContent').innerHTML = `
        <p><strong class="text-slate-200">ADM:</strong> ${safe(row.adm)}</p>
        <p><strong class="text-slate-200">Name:</strong> ${safe(row.name)}</p>
        <p><strong class="text-slate-200">Contact:</strong> ${safe(row.contact||'--')}</p>
        <p><strong class="text-slate-200">Total Fee:</strong> ${fmt(row.totalFee)}</p>
        <p><strong class="text-slate-200">Paid:</strong> ${fmt(row.paid)}</p>
        <p><strong class="text-slate-200">Balance:</strong> ${fmt(row.bal)}</p>
        <p><strong class="text-slate-200">Hali ya Ada:</strong> ${safe(row.statusLabel)}</p>
        <p><strong class="text-slate-200">Maelezo ya Deni:</strong> ${safe(row.rawDebtInfo.label)}</p>
        ${row.rawDebtInfo.dueDate ? `<p><strong class="text-slate-200">Mpango wa Malipo:</strong> ${formatLocalDate(row.rawDebtInfo.dueDate)}</p>` : ''}
        ${row.photoUrl? `<img src="${row.photoUrl}" alt="Learner photo" class="mt-4 h-28 w-28 rounded-2xl object-cover">` : ''}
        ${history}`;
      document.getElementById('detailsModal').style.display='flex';
    }

    // --- Expenses submit ---
    document.getElementById('expenseForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const category = document.getElementById('expenseCategory').value;
      const description = document.getElementById('expenseDescription').value;
      const amount = parseInt(document.getElementById('expenseAmount').value,10);
      if(!category || !description || !amount) return Swal.fire('Error','Fill all fields','error');
      try{
        const base = await detectPrefoneBase();
        await db.ref(`${base}/expenses`).push({ category, description, amount, date: todayStr() });
        Swal.fire('Success','Expense added','success');
        e.target.reset();
        await loadExpenses(base);
        await loadFinance(base);
      }catch(err){
        Swal.fire('Error','Failed to add expense: '+err.message,'error');
      }
    });

    // --- Toggles ---
    function toggleDebtors(){
      showingDebtors = !showingDebtors;
      document.getElementById('debtorsToggleLabel').textContent = showingDebtors? 'Show All Learners' : 'Show Debtors';
      renderTable();
    }

    // --- Exports (now with totals rows) ---
    function mainRows(){
      return visibleRows().map(r=>({
        ADM: r.adm,
        Name: r.name,
        Contact: r.contact,
        TotalFee: r.totalFee,
        Plan: r.plan,
        Paid: r.paid,
        Balance: r.bal,
        DebtTill: r.rawDebtInfo.label,
        Status: r.statusLabel,
      }));
    }

    function exportMainCSV(){
      const rows = mainRows();
      const totals = rows.reduce((a,r)=>({
        fee:a.fee+(+r.TotalFee||0), paid:a.paid+(+r.Paid||0), bal:a.bal+(+r.Balance||0)
      }),{fee:0,paid:0,bal:0});
      const csv = Papa.unparse([
        Object.keys(rows[0]||{ADM:'ADM',Name:'Name',Contact:'Contact',TotalFee:0,Plan:'',Paid:0,Balance:0,DebtTill:'',Status:''}),
        ...rows.map(r=>Object.values(r)),
        ['TOTALS','','',totals.fee,'',totals.paid,totals.bal,'',''],
      ]);
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='preform_finance.csv'; a.click();
    }

    function exportMainPDF(){
      const { jsPDF } = window.jspdf; const doc = new jsPDF('landscape');
      const rows = mainRows();
      const totals = rows.reduce((a,r)=>({
        fee:a.fee+(+r.TotalFee||0), paid:a.paid+(+r.Paid||0), bal:a.bal+(+r.Balance||0)
      }),{fee:0,paid:0,bal:0});
      doc.setFontSize(12); doc.text('Pre‑Form One Finance Register', 14, 14);
      doc.autoTable({
        startY: 18,
        head: [['ADM No','Full Name','Parent Contact','Total Fee','Plan','Paid','Balance','Debt Till','Status']],
        body: rows.map(r=>[
          r.ADM, r.Name, r.Contact, fmt(r.TotalFee), r.Plan, fmt(r.Paid), fmt(r.Balance), r.DebtTill, r.Status
        ]),
        foot: [['TOTALS','','', fmt(totals.fee),'', fmt(totals.paid), fmt(totals.bal),'','']],
        styles: { fontSize: 8 }, headStyles: { fillColor: [15,23,42] }, footStyles:{ fillColor:[30,41,59], textColor: [226,232,240] }
      });
      doc.save('preform_finance.pdf');
    }

    function exportDebtorsCSV(){
      const rows = visibleRows().filter(r=>r.bal>0).map(r=>({ADM:r.adm,Name:r.name,Contact:r.contact,Balance:r.bal,DebtTill:r.rawDebtInfo.label}));
      const totalBal = rows.reduce((t,r)=>t+(+r.Balance||0),0);
      const csv = Papa.unparse([
        ['ADM','Name','Contact','Balance','DebtTill'],
        ...rows.map(r=>[r.ADM,r.Name,r.Contact,r.Balance,r.DebtTill]),
        ['TOTALS','','', totalBal,'']
      ]);
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='preform_debtors.csv'; a.click();
    }

    function exportDebtorsPDF(){
      const { jsPDF } = window.jspdf; const doc = new jsPDF('landscape');
      const rows = visibleRows().filter(r=>r.bal>0).map(r=>[r.adm, r.name, r.contact, fmt(r.bal), r.rawDebtInfo.label]);
      const totalBal = visibleRows().filter(r=>r.bal>0).reduce((t,r)=>t+r.bal,0);
      doc.setFontSize(12); doc.text('Pre‑Form One Debtors List', 14, 14);
      doc.autoTable({
        startY:18,
        head:[['ADM No','Full Name','Parent Contact','Balance','Debt Till']],
        body: rows,
        foot: [['TOTALS','','', fmt(totalBal), '']],
        styles:{ fontSize:8 }, headStyles:{ fillColor:[88,28,135] }, footStyles:{ fillColor:[51,65,85], textColor:[226,232,240] }
      });
      doc.save('preform_debtors.pdf');
    }

    function exportExpenseCSV(){
      const rows = expensesCache.map(e=>[e.category,e.description,e.amount,e.date]);
      const total = expensesCache.reduce((t,e)=>t+e.amount,0);
      if(!rows.length) return Swal.fire('Info','No expenses to export yet.','info');
      const csv = Papa.unparse([
        ['Category','Description','Amount','Date'],
        ...rows,
        ['TOTAL','','', total]
      ]);
      const blob = new Blob([csv], {type:'text/csv'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='preform_expenses.csv'; a.click();
    }

    function exportExpensePDF(){
      const rows = expensesCache.map(e=>[e.category, e.description, fmt(e.amount), e.date]);
      const total = expensesCache.reduce((t,e)=>t+e.amount,0);
      if(!rows.length) return Swal.fire('Info','No expenses to export yet.','info');
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      doc.setFontSize(12); doc.text('Pre‑Form One Expense Register', 14, 14);
      doc.autoTable({
        startY:18,
        head:[['Category','Description','Amount','Date']],
        body: rows,
        foot:[['TOTAL','', fmt(total), '']],
        styles:{ fontSize:9 }, headStyles:{ fillColor:[15,23,42] }, footStyles:{ fillColor:[30,41,59], textColor:[226,232,240] }
      });
      doc.save('preform_expenses.pdf');
    }

    // Boot
    loadAll();
  </script>
</body>
</html>
