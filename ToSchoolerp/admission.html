<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp — Admissions</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background:#f8fafc; color:#0f172a; }
    .modal { display:none; position:fixed; inset:0; width:100%; height:100%; background-color: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px; border-radius:10px; width:95%; max-width:920px; height:90vh; overflow-y:auto; margin-top:20px; }
    .close { position:absolute; top:10px; right:16px; font-size:24px; cursor:pointer; }
    table { width:100%; border-collapse:collapse; } 
    th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
    thead th { background:#eef2ff; color:#0b69ff; }
    .hidden { display:none !important; }
    .block { display:block !important; }
    .student-card { background:#fff; border:1px solid #e6e9ef; border-radius:8px; padding:10px; margin-bottom:10px; }
    .hint { font-size:12px; color:#6b7280; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:.5rem .85rem; border-radius:.5rem; }
  </style>

  <script>
  /** Year range + anchor **/
  const SOMAP_ALLOWED_YEARS = Array.from({length: 20}, (_,i)=>2023+i); // 2023..2042
  const SOMAP_DEFAULT_YEAR = 2025;

  /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
  const CLASS_ORDER = ['Baby Class','Middle Class','Pre Unit Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
  const L = s => String(s||'').trim().toLowerCase();

  /** Shift a base class by delta years relative to anchor (2025). */
  function shiftClass(baseClass, deltaYears){
    const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
    if (i<0) return baseClass||'';
    const j = i + Number(deltaYears||0);
    if (j < 0) return 'PRE-ADMISSION';
    if (j >= CLASS_ORDER.length) return 'GRADUATED';
    return CLASS_ORDER[j];
  }
  </script>

  <script>
  /** Reuse shared year context if present, else create a light fallback. */
  window.somapYearContext = window.somapYearContext || (function(){
    let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR)+'';
    const listeners = new Set();
    return {
      getSelectedYear(){ return selected; },
      setSelectedYear(y){
        y = String(y);
        if (selected===y) return;
        selected = y;
        try{ sessionStorage.setItem('somap_selected_year', y); }catch(_e){}
        listeners.forEach(fn=>{ try{ fn(y); }catch(err){ console.error(err); } });
      },
      onYearChanged(fn){ if (typeof fn==='function') listeners.add(fn); }
    };
  })();
  </script>
</head>
<body class="bg-gray-50 p-4">

  <!-- Back to Dashboard -->
  <div class="mb-4">
    <a href="../schoolerp.html" class="text-indigo-600 hover:underline flex items-center gap-2 mb-4">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Admissions Content -->
  <div class="bg-white rounded-lg shadow p-4">
    <div id="somapYearWrap" style="display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;">
      <label class="text-xs font-semibold">Academic Year</label>
      <select data-somap-year-select class="border rounded px-2 py-1 text-sm"></select>
      <span class="text-xs text-slate-600">Working year: <b id="somapYearHint">--</b></span>
    </div>

    <script>
    (function initYearSelector(){
      const sel = document.querySelector('[data-somap-year-select]');
      const hint = document.getElementById('somapYearHint');
      if (!sel) return;
      sel.innerHTML = SOMAP_ALLOWED_YEARS.map(y=>`<option value="${y}">${y}</option>`).join('');
      const current = window.somapYearContext.getSelectedYear();
      sel.value = current;
      if (hint) hint.textContent = current;
      sel.addEventListener('change', e=>{
        const y = String(e.target.value);
        window.somapYearContext.setSelectedYear(y);
        if (hint) hint.textContent = y;
      });
    })();
    </script>

    <div class="space-y-4">
      <div>
        <h3 class="font-medium text-gray-800">New Applications</h3>
        <p class="text-sm text-gray-500 mb-3">Review and process new student applications.</p>
        <div class="flex justify-between">
          <span class="text-sm font-medium text-green-600">New applications (joining forms)</span>
          <a href="./newapplications.html" class="text-sm text-indigo-600 hover:underline">View all</a>
        </div>
      </div>

      <div>
        <h3 class="font-medium text-gray-800">Quick Admission</h3>
        <p class="text-sm text-gray-500 mb-3">Register a new student directly.</p>
        <button id="openRegistrationModal" class="w-full md:w-1/2 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition cursor-pointer">
          Create New Admission
        </button>
<a href="admin-join-approvals.html"
   class="relative btn bg-amber-500 text-white hover:bg-amber-600">
  <i class="fas fa-user-plus"></i>
  Join Requests

  <!-- Badge -->
  <span id="joinBadge"
        class="hidden absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full">
    0
  </span>
</a>



        <p class="hint mt-2">Admission number auto-fills when the form opens.</p>
      </div>

      <div>
        <h3 class="font-medium text-gray-800">Transfer Requests</h3>
        <p class="text-sm text-gray-500 mb-2">Students requesting transfer in/out</p>
        <div class="flex justify-between">
          <span class="text-sm font-medium text-yellow-600">3 pending requests</span>
          <a href="javascript:void(0)" class="text-sm text-indigo-600 hover:underline">View all</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Registration Modal -->
  <div id="registrationModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <span id="closeModal" class="close" title="Close">&times;</span>
     <h2 id="modalTitle" class="text-2xl font-semibold text-indigo-600 mb-4">Student Registration</h2>

      <form id="registrationForm" enctype="multipart/form-data" novalidate class="space-y-4">
          <input type="hidden" id="recordKey" name="recordKey" />
        <!-- BASIC INFO -->
        <div class="section">
          <h3 class="font-semibold">Basic Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="firstName" class="block text-sm text-gray-600">First Name *</label>
              <input type="text" id="firstName" name="firstName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="middleName" class="block text-sm text-gray-600">Middle Name</label>
              <input type="text" id="middleName" name="middleName" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="lastName" class="block text-sm text-gray-600">Last Name *</label>
              <input type="text" id="lastName" name="lastName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="gender" class="block text-sm text-gray-600">Gender *</label>
              <select id="gender" name="gender" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select gender</option>
                <option>Male</option>
                <option>Female</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label for="dob" class="block text-sm text-gray-600">Date of Birth *</label>
              <input type="date" id="dob" name="dob" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="admissionNumber" class="block text-sm text-gray-600">Admission Number (Auto-generated)</label>
              <input type="text" id="admissionNumber" name="admissionNumber" readonly class="border p-2 rounded w-full bg-gray-100"/>
            </div>
            <div>
              <label for="feePerYear" class="block text-sm text-gray-600">Fee Per Year (Tsh) *</label>
              <input type="number" id="feePerYear" name="feePerYear" placeholder="e.g., 600000" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="paymentPlan" class="block text-sm text-gray-600">Payment Plan *</label>
              <select id="paymentPlan" name="paymentPlan" required class="border p-2 rounded w-full">
                <option value="">-- Select Payment Plan --</option>
                <option value="monthly">Monthly (Jan–Oct)</option>
                <option value="6-instalments">6 Instalments</option>
                <option value="2-instalments">2 Instalments</option>
                <option value="yearly">Full Year at Once</option>
                <option value="other">Other (as agreed)</option>
              </select>
            </div>
            <div>
              <label for="pupilId" class="block text-sm text-gray-600">Pupil’s ID</label>
              <input type="text" id="pupilId" name="pupilId" placeholder="Pupil's ID" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="birthCertNumber" class="block text-sm text-gray-600">Birth Certificate Number</label>
              <input type="text" id="birthCertNumber" name="birthCertNumber" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="religion" class="block text-sm text-gray-600">Religion</label>
              <input type="text" id="religion" name="religion" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="tribe" class="block text-sm text-gray-600">Tribe / Ethnicity</label>
              <input type="text" id="tribe" name="tribe" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- JOINING FORM PAYMENT -->
        <div class="section">
          <h3 class="font-semibold">Joining Form Payment</h3>
          <p class="text-xs text-gray-500 mb-2">
            This payment must be approved in Dashboard -> Approvals before the student is fully registered.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="paymentReference" class="block text-sm text-gray-600">Payment reference *</label>
              <input id="paymentReference" name="paymentReference" required
                     placeholder="MPesa ref / receipt no"
                     class="border p-2 rounded w-full"/>
            </div>

            <div>
              <label for="paymentReceivedBy" class="block text-sm text-gray-600">Payment received by *</label>
              <input id="paymentReceivedBy" name="paymentReceivedBy" required
                     placeholder="Staff name"
                     class="border p-2 rounded w-full"/>
            </div>

            <div>
              <label for="amountPaid" class="block text-sm text-gray-600">Amount paid (TZS) *</label>
              <input type="number" id="amountPaid" name="amountPaid" required value="7000"
                     class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- SCHOOL INFO -->
        <div class="section">
          <h3 class="font-semibold">School Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="schoolName" class="block text-sm text-gray-600">School Name *</label>
              <input type="text" id="schoolName" name="schoolName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
  <label for="classLevel" class="block text-sm text-gray-600">Class Level *</label>
  <select id="classLevel" name="classLevel" required class="border p-2 rounded w-full">
    <option value="" disabled selected>Select class</option>
    <option>Baby Class</option>
    <option>Pre Unit Class</option>
    <option>Middle Class</option>
    <option>Class 1</option>
    <option>Class 2</option>
    <option>Class 3</option>
    <option>Class 4</option>
    <option>Class 5</option>
    <option>Class 6</option>
    <option>Class 7</option>
  </select>
</div>
            <div>
              <label for="stream" class="block text-sm text-gray-600">Stream</label>
              <input type="text" id="stream" name="stream" placeholder="e.g., 4B" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="academicYear" class="block text-sm text-gray-600">Current Academic Year *</label>
              <input type="text" id="academicYear" name="academicYear" placeholder="e.g., 2025" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="academicTrack" class="block text-sm text-gray-600">Academic Track</label>
              <input type="text" id="academicTrack" name="academicTrack" placeholder="e.g., NECTA / SFNA" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="boardingStatus" class="block text-sm text-gray-600">Boarding or Day Scholar *</label>
              <select id="boardingStatus" name="boardingStatus" required class="border p-2 rounded w-full">
                <option value="" disabled selected>Select status</option>
                <option>Boarding</option>
                <option>Day Scholar</option>
              </select>
            </div>
            <div>
              <label for="shiftedFrom" class="block text-sm text-gray-600">Shifted From (for transfer-ins)</label>
              <input type="text" id="shiftedFrom" name="shiftedFrom" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- PARENT/GUARDIAN -->
        <div class="section">
          <h3 class="font-semibold">Parent / Guardian Details</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="primaryParentName" class="block text-sm text-gray-600">Primary Parent Name *</label>
              <input type="text" id="primaryParentName" name="primaryParentName" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="primaryParentContact" class="block text-sm text-gray-600">Primary Parent Contact *</label>
              <input type="text" id="primaryParentContact" name="primaryParentContact" placeholder="+255 7xx xxx xxx" required class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="secondaryGuardian" class="block text-sm text-gray-600">Secondary Guardian (if any)</label>
              <input type="text" id="secondaryGuardian" name="secondaryGuardian" class="border p-2 rounded w-full"/>
            </div>
            <div>
              <label for="relationshipToStudent" class="block text-sm text-gray-600">Relationship to Student</label>
              <input type="text" id="relationshipToStudent" name="relationshipToStudent" class="border p-2 rounded w-full"/>
            </div>
            <div class="md:col-span-2">
              <label for="residentialAddress" class="block text-sm text-gray-600">Residential Address *</label>
              <textarea id="residentialAddress" name="residentialAddress" required class="border p-2 rounded w-full h-20"></textarea>
            </div>
            <div class="md:col-span-2">
              <label for="employmentStatus" class="block text-sm text-gray-600">Employment Status (if needed)</label>
              <input type="text" id="employmentStatus" name="employmentStatus" class="border p-2 rounded w-full"/>
            </div>
          </div>
        </div>

        <!-- FILES -->
        <div class="section">
          <h3 class="font-semibold">Photos & Attachments</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="passportPhoto" class="block text-sm text-gray-600">Passport Photo Upload *</label>
              <input type="file" id="passportPhoto" name="passportPhoto" accept="image/*" class="border p-2 rounded w-full"/>
<div id="passportPreview" class="mt-2 hint"></div>
            </div>
            <div>
              <label for="birthCertUpload" class="block text-sm text-gray-600">Birth Certificate Upload *</label>
              <input type="file" id="birthCertUpload" name="birthCertUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
<div id="birthCertPreview" class="mt-2 hint"></div>
            </div>
            <div>
              <label for="reportCardUpload" class="block text-sm text-gray-600">Report Card (First Term, Ongoing) *</label>
              <input type="file" id="reportCardUpload" name="reportCardUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
<div id="reportCardPreview" class="mt-2 hint"></div>
            <div>
              <label for="joiningLetterUpload" class="block text-sm text-gray-600">Joining or Transfer Letter (PDF/Image) *</label>
              <input type="file" id="joiningLetterUpload" name="joiningLetterUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
<div id="joiningLetterPreview" class="mt-2 hint"></div>
            </div>
            <div class="md:col-span-2">
              <label for="medicalDocsUpload" class="block text-sm text-gray-600">Medical Documents (if applicable)</label>
              <input type="file" id="medicalDocsUpload" name="medicalDocsUpload" accept="image/*,application/pdf" class="border p-2 rounded w-full"/>
<div id="medicalDocsPreview" class="mt-2 hint"></div>
            </div>
          </div>
        </div>

        <div class="flex gap-2">
  <button type="submit" id="registerBtn" class="flex-1 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
    Register Student
  </button>
  <button type="button" id="cancelEditBtn" class="flex-1 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 hidden">
    Cancel
  </button>
</div>

      <!-- Quick search (live) -->
      <div class="mt-8">
        <h3 class="font-semibold">Search Students</h3>
        <input type="text" id="search-box" placeholder="Search by name or ID" class="border p-2 rounded w-64 mt-2"/>
        <div id="student-list" class="mt-4"></div>
      </div>
    </div>
  </div>

  <!-- Third-party libraries (CSV + PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDKs (compat) + your config -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script> <!-- Adjusted path to firebase.js in root -->
  <script src="../js/joining-helpers.js"></script>
  <script src="./pushtoadmission.js"></script>
  <!-- Cloudinary Upload Library -->
  <script src="https://widget.cloudinary.com/v2.0/global/all.js"></script>

  <!-- Admissions Logic -->
 <!-- Admissions Logic (extended with Edit functionality) -->
  <script type="module">
    import {
      resolveEffectiveFinance,
      readPlan,
      readClassConfig,
      setStudentFeeOverride
    } from '../js/financeplans.js';

    document.addEventListener('DOMContentLoaded', function() {
  console.log('admission.editable.html loaded'); // Debug log to confirm script execution

  // ---- Password for restricted actions ----
  const ACTION_PASSWORD = 'REHEMam!'; // Hardcoded password for Edit/Delete
  const SHIFT_REPORT_PATH = SOMAP.P('shiftReports');

  // ---- Modal open/close ----
  const openModalBtn = document.getElementById('openRegistrationModal');
  const closeModalBtn = document.getElementById('closeModal');
  const modal = document.getElementById('registrationModal');
  const form = document.getElementById('registrationForm');
  const registerBtn = document.getElementById('registerBtn');
  const cancelEditBtn = document.getElementById('cancelEditBtn');
  const modalTitle = document.getElementById('modalTitle');
  /* =========================================================
   JOIN APPROVAL → ADMISSION PREFILL HOOK
   ========================================================= */
/* JOIN APPROVAL → ADMISSION PREFILL HOOK */





  // Debug: Check if elements are found
  if (!openModalBtn) console.error('openRegistrationModal button not found');
  if (!modal) console.error('registrationModal not found');
  if (!closeModalBtn) console.error('closeModal button not found');
  if (!form) console.error('registrationForm not found');
  if (!registerBtn) console.error('registerBtn not found');

  let editingKey = null;      // When set -> form is in EDIT mode
  let editingStudent = null;  // Currently loaded student object (for keeping old URLs)

  if (openModalBtn && modal) {
    openModalBtn.addEventListener('click', function() {
      console.log('Create New Admission button clicked'); // Debug log
      clearForm();
      document.getElementById('admissionNumber').value = `AUTO-${Date.now()}`;
      openModal();
    });
  }

  if (closeModalBtn) closeModalBtn.addEventListener('click', closeRegistrationModal);
  if (modal) {
    window.addEventListener('click', (e) => {
      if (e.target === modal) closeRegistrationModal();
    });
  }

function openModal() {
  const modal = document.getElementById('registrationModal');
  if (!modal) {
    console.error('registrationModal not found');
    return;
  }
  modal.style.display = 'block';
  checkFormValidity();
  if (typeof queueRender === 'function') queueRender();
}

  window.somapOpenAdmissionModal = openModal;


  function clearForm() {
   
    form.reset();
    editingKey = null;
    editingStudent = null;
    document.getElementById('recordKey').value = '';
    modalTitle.textContent = 'Student Registration';
    registerBtn.textContent = 'Register Student';
    cancelEditBtn.classList.add('hidden');
    // Clear previews
    ['passportPreview', 'birthCertPreview', 'reportCardPreview', 'joiningLetterPreview', 'medicalDocsPreview'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = '';
    });
    const amountPaid = document.getElementById('amountPaid');
    if (amountPaid) amountPaid.value = '7000';
    const paymentReference = document.getElementById('paymentReference');
    if (paymentReference) paymentReference.value = '';
    const paymentReceivedBy = document.getElementById('paymentReceivedBy');
    if (paymentReceivedBy) paymentReceivedBy.value = '';
  }
// =========================================================
// JOIN APPROVAL → ADMISSION PREFILL (FIXED)
// =========================================================
(function prefillFromJoinApproval() {
  const params = new URLSearchParams(window.location.search);
  if (params.get("from") !== "joinApproval") return;

  const raw = sessionStorage.getItem("somap_pending_admission");
  if (!raw) return;

  let payload;
  try {
    payload = JSON.parse(raw);
  } catch {
    console.warn("Invalid join approval payload");
    return;
  }

  clearForm();
  openModal();
clearForm();
openModal();

// Delay filling until modal DOM is ready
setTimeout(() => {

  if (payload.student) {
    document.getElementById("firstName").value =
      payload.student.firstName || "";

    document.getElementById("lastName").value =
      payload.student.lastName || "";

    document.getElementById("classLevel").value =
      payload.student.classLevel || "";

    document.getElementById("gender").value =
      payload.student.gender || "";

    document.getElementById("dob").value =
      payload.student.dob || "";
  }

  if (payload.parent) {
    document.getElementById("primaryParentName").value =
      payload.parent.name || "";

    document.getElementById("primaryParentContact").value =
      payload.parent.phone || "";
  }

  if (payload.academicYear) {
    document.getElementById("academicYear").value = payload.academicYear;
  }

  document.getElementById("admissionNumber").value =
    `AUTO-${Date.now()}`;

  window.__SOMAP_REFERRAL__ = payload.referral || null;
  window.__SOMAP_APPROVAL_KEY__ = payload.approvalKey || null;

  checkFormValidity();
  console.log("✅ Prefill completed");

}, 500); // <-- CRITICAL FIX



  function closeRegistrationModal() {
    console.log('Closing modal'); // Debug log
    if (modal) modal.style.display = 'none';
    clearForm();
    if (registerBtn) registerBtn.disabled = true;
  }

  window.somapCloseAdmissionModal = closeRegistrationModal;

  // ---- Resolve Firebase handles gracefully ----
  const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
  const storage = window.storage || (window.firebase && firebase.storage ? firebase.storage() : null);

  const currentSchool = window.SOMAP && SOMAP.getSchool();
  if (!currentSchool || !currentSchool.id) {
    window.location.href = "../somapappv1multischool/multischool.html";
  }
  window.currentSchoolId = currentSchool?.id;

  function schoolRef(subPath) {
    return db.ref(SOMAP.P(subPath));
  }

  if (!db) {
    console.error('Firebase Realtime Database not available. Ensure ../firebase.js and Firebase SDKs are loaded.');
  }
  if (!storage) {
    console.warn('Firebase Storage not available. File uploads will be skipped.');
  }

  const getWorkingYear = () => window.somapYearContext?.getSelectedYear?.() || SOMAP_DEFAULT_YEAR;
  const resolveSchoolId = () => {
    if (window.currentSchoolId) return window.currentSchoolId;
    const params = new URLSearchParams(window.location.search || '');
    const fromQuery = params.get('school') || params.get('schoolId');
    const stored = (typeof localStorage !== 'undefined') ? localStorage.getItem('somap_school') : '';
    const normalized = (fromQuery || stored || '').trim();
    if (normalized) window.currentSchoolId = normalized;
    return normalized || 'socrates';
  };
  const withSchool = (path) => {
    const trimmed = String(path || '').replace(/^\/+/, '');
    return SOMAP.P(trimmed);
  };

  let cachedStudents = [];
  const cachedStudentsById = new Map();
  let shiftReports = {};
  let anchorEnrollments = {};
  let yearEnrollments = {};
  let anchorEnrollRef = null;
  let yearEnrollRef = null;
  let renderGeneration = 0;
  const planLabelCache = new Map();
  const currencyFormatter = new Intl.NumberFormat('en-US', { minimumFractionDigits: 0 });

  const queueRender = () => {
    renderSearchList(cachedStudents).catch(err => console.error('Render error', err));
  };
  window.somapRenderAdmissionList = queueRender;

  function resolveClassForStudentYear(studentKey, fallbackClass, targetYear) {
    const override = yearEnrollments[studentKey] || {};
    if (override && (override.className || override.classLevel)) {
      return override.className || override.classLevel;
    }
    const anchor = anchorEnrollments[studentKey] || {};
    const baseClass = anchor.className || anchor.classLevel || fallbackClass || '';
    const delta = Number(targetYear) - SOMAP_DEFAULT_YEAR;
    return shiftClass(baseClass, delta);
  }

  async function planLabelFor(planId, year) {
    if (!planId) return '';
    const key = `${year}::${planId}`;
    if (planLabelCache.has(key)) return planLabelCache.get(key);
    try {
      const plan = await readPlan(planId, { year });
      const label = plan?.name || planId;
      planLabelCache.set(key, label);
      return label;
    } catch (err) {
      console.warn('Failed to load plan details', planId, err);
      return planId;
    }
  }

async function syncFinanceAfterUpsert(studentKey, studentData) {
  if (!studentKey || !studentData) return;

  const workingYear = getWorkingYear();
  const className = studentData.classLevel || studentData.className || '';
  if (!className) return;

  try {
    /* =====================================================
       EXISTING LOGIC — KEEP (fee override decision)
       ===================================================== */
    const classCfg = await readClassConfig(className, { year: workingYear });
    const defaultFee =
      classCfg && classCfg.feePerYear !== undefined
        ? Number(classCfg.feePerYear)
        : null;

    const enteredFee = Number(studentData.feePerYear);

    if (defaultFee !== null && Number.isFinite(enteredFee)) {
      const sameFee = Math.round(enteredFee) === Math.round(defaultFee);
      if (sameFee) {
        await setStudentFeeOverride(
          studentKey,
          null,
          false,
          { by: 'admissions', year: workingYear }
        );
      } else {
        await setStudentFeeOverride(
          studentKey,
          enteredFee,
          true,
          { by: 'admissions', year: workingYear }
        );
      }
    }

    /* =====================================================
       NEW LOGIC — PERSIST RESOLVED FEE TO STUDENT RECORD
       ===================================================== */

    // Resolve the effective fee using finance engine
    const finance = await resolveEffectiveFinance(
      studentKey,
      className,
      { year: workingYear }
    );

    const resolvedFee = Number(finance?.fee || 0);

    // Read current student record to preserve paid amounts
    const snap = await schoolRef(`students/${studentKey}`).once('value');
    const existing = snap.val() || {};

    const paid =
      Number(existing.feesPaid) ||
      Number(existing.feePaid) ||
      Number(existing.paidAmount) ||
      0;

    const balance = resolvedFee - paid;

    // Persist canonical values for ALL downstream pages
    await schoolRef(`students/${studentKey}`).update({
      feePerYear: resolvedFee,
      balance: balance,
      feeResolvedAt: Date.now(),
      feeResolvedYear: workingYear
    });

  } catch (err) {
    console.warn('Finance sync failed', studentKey, err);
  }
}




  function attachYearEnrollmentListener(year) {
    if (!db) return;
    const yearStr = String(year);
    if (yearEnrollRef) yearEnrollRef.off();
    yearEnrollRef = schoolRef(`enrollments/${yearStr}`);
    yearEnrollRef.on('value', (snap) => {
      yearEnrollments = snap.val() || {};
      queueRender();
    });
  }

  // ---- Required fields -> enable/disable register ----
  const requiredFields = [
    'firstName', 'lastName', 'gender', 'dob',
    'schoolName', 'classLevel', 'academicYear', 'boardingStatus',
    'primaryParentName', 'primaryParentContact', 'residentialAddress',
    'feePerYear', 'paymentPlan',
    'paymentReference', 'paymentReceivedBy', 'amountPaid'
  ];
  const requiredFiles = ['passportPhoto', 'birthCertUpload', 'reportCardUpload', 'joiningLetterUpload'];

  function checkFormValidity() {
    const fieldsOk = requiredFields.every(id => {
      const el = document.getElementById(id);
      return el && String(el.value || '').trim() !== '';
    });
    // When editing, files are OPTIONAL. When creating new, files are required.
    const fromJoin = !!window.__SOMAP_APPROVAL_KEY__;
const filesOk = editingKey || fromJoin ? true : requiredFiles.every(id => {

      const el = document.getElementById(id);
      return el && el.files && el.files.length > 0;
    });
    if (registerBtn) {
      registerBtn.disabled = !(fieldsOk && filesOk);
      console.log('Form validity:', { fieldsOk, filesOk }); // Debug log
    }
  }

  [...requiredFields, ...requiredFiles].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', checkFormValidity);
      if (el.type === 'file') el.addEventListener('change', checkFormValidity);
    }
  });
  if (registerBtn) registerBtn.disabled = true;

  // ---- Utils ----
  function escapeHtml(text) {
    if (text === undefined || text === null) return '';
    return String(text).replace(/[&<>\"]/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[m]));
  }

  // ---- Password check for restricted actions ----
  function restrictAction(actionName) {
    const input = prompt(`Enter password to ${actionName} this student record:`);
    if (input === ACTION_PASSWORD) {
      return true;
    } else {
      alert('Incorrect password. Action cancelled.');
      console.log(`${actionName} action blocked: Incorrect password`);
      return false;
    }
  }

  // Upload: If editing and no new file selected, KEEP existingUrl
  async function uploadMaybe(inputId, folder, newKey, existingUrl) {
    const el = document.getElementById(inputId);
    if (!el || !el.files || el.files.length === 0) {
      console.log(`No new file for ${inputId}, keeping:`, existingUrl); // Debug log
      return existingUrl || null;
    }

    try {
      const file = el.files[0];
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "somap_unsigned"); // Update if your preset differs
      formData.append("folder", "studentDocs/" + newKey + "/" + folder);

      const res = await fetch("https://api.cloudinary.com/v1_1/dg7vnrkgd/auto/upload", {
        method: "POST",
        body: formData
      });
      const data = await res.json();

      if (data.secure_url) {
        console.log(`Uploaded ${inputId} to Cloudinary:`, data.secure_url); // Debug log
        return data.secure_url;
      } else {
        console.error("Cloudinary upload failed:", data);
        return existingUrl || null;
      }
    } catch (err) {
      console.error(`Upload error for ${inputId}:`, err);
      return existingUrl || null;
    }
  }

  // ---- Registration submit (create OR update) ----
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (registerBtn) registerBtn.disabled = true;
      console.log('Form submitted'); // Debug log

      const fd = new FormData(form);
      const studentData = {
        firstName: fd.get('firstName'),
        middleName: fd.get('middleName') || '',
        lastName: fd.get('lastName'),
        gender: fd.get('gender'),
        dob: fd.get('dob'),
        admissionNumber: fd.get('admissionNumber') || `AUTO-${Date.now()}`,
        pupilId: fd.get('pupilId') || '',
        birthCertNumber: fd.get('birthCertNumber') || '',
        religion: fd.get('religion') || '',
        tribe: fd.get('tribe') || '',
        schoolName: fd.get('schoolName'),
        classLevel: fd.get('classLevel'),
        stream: fd.get('stream') || '',
        academicYear: fd.get('academicYear'),
        academicTrack: fd.get('academicTrack') || '',
        boardingStatus: fd.get('boardingStatus'),
        shiftedFrom: fd.get('shiftedFrom') || '',
        primaryParentName: fd.get('primaryParentName'),
        primaryParentContact: fd.get('primaryParentContact'),
        secondaryGuardian: fd.get('secondaryGuardian') || '',
        relationshipToStudent: fd.get('relationshipToStudent') || '',
        residentialAddress: fd.get('residentialAddress'),
        employmentStatus: fd.get('employmentStatus') || '',
        feePerYear: Number(fd.get('feePerYear') || 0),
        paymentPlan: fd.get('paymentPlan'),
      };

      try {
        if (!db) throw new Error('Database not available');

        const joiningGate = await checkJoiningApplicationGate(studentData);
        if (joiningGate) {
          alert("This child already has a verified joining form for this class and year. Go to 'New Applications' and import instead of direct admission.");
          if (registerBtn) registerBtn.disabled = false;
          return;
        }

        // Duplicate check: Look for existing student with same parent contact + name + dob + class + admission number
        let duplicate = false;
        const dupQuery = schoolRef('students').orderByChild('primaryParentContact').equalTo(studentData.primaryParentContact);
        const dupSnap = await dupQuery.once('value');
        console.log('Duplicate check: Matches=', dupSnap.numChildren(), 'Ignored self=', editingKey ? `Yes (${editingKey})` : 'N/A'); // Debug log
        dupSnap.forEach(child => {
          const s = child.val();
          const key = child.key;
          if (s) {
            const sameIdentity = (
              (s.firstName || '') === studentData.firstName &&
              (s.lastName || '') === studentData.lastName &&
              (s.dob || '') === studentData.dob &&
              (s.classLevel || '') === studentData.classLevel &&
              (s.admissionNumber || '') === studentData.admissionNumber
            );
            if (sameIdentity) {
              // If creating new -> any match is duplicate. If editing -> ignore self
              if (!editingKey || (editingKey && editingKey !== key)) duplicate = true;
            }
          }
        });

        if (duplicate) {
          alert("Duplicate student detected (same name, DOB, class, parent contact, or admission number). Update aborted.");
          if (registerBtn) registerBtn.disabled = false;
          return;
        }

        if (!editingKey) {
          // CREATE NEW (pending approval)
          const reservedStudentKey = schoolRef('students').push().key;
          const year = Number(studentData.academicYear || getWorkingYear());
          const paymentReference = fd.get('paymentReference') || '';
          const paymentReceivedBy = fd.get('paymentReceivedBy') || '';
          const amountPaid = Number(fd.get('amountPaid') || 7000);

          // AUTO-IMPORT JOIN DOCUMENTS
          if (window.__SOMAP_APPROVAL_KEY__) {
            const joinSnap = await schoolRef(
              `joinApprovalsPending/${window.__SOMAP_APPROVAL_KEY__}`
            ).once("value");

            const joinData = joinSnap.val();
            if (joinData?.documents) {
              studentData.passportPhotoUrl = joinData.documents.passportPhotoUrl || null;
              studentData.birthCertUrl = joinData.documents.birthCertUrl || null;
              studentData.reportCardUrl = joinData.documents.reportCardUrl || null;
              studentData.joiningLetterUrl =
                joinData.documents.generatedJoiningFormUrl ||
                joinData.documents.joiningLetterUrl || null;
              studentData.medicalDocsUrl = joinData.documents.medicalDocsUrl || null;
            }
          }

          // Upload files (all required for new registration)
          console.log('Creating admission draft, uploading files for key:', reservedStudentKey);
           // Debug log
          studentData.passportPhotoUrl =
            studentData.passportPhotoUrl ||
            await uploadMaybe("passportPhoto", "passport", reservedStudentKey, null);

          studentData.birthCertUrl =
            studentData.birthCertUrl ||
            await uploadMaybe("birthCertUpload", "birthCert", reservedStudentKey, null);

          studentData.reportCardUrl =
            studentData.reportCardUrl ||
            await uploadMaybe("reportCardUpload", "reportCard", reservedStudentKey, null);

          studentData.joiningLetterUrl =
            studentData.joiningLetterUrl ||
            await uploadMaybe("joiningLetterUpload", "joiningLetter", reservedStudentKey, null);

          studentData.medicalDocsUrl =
            studentData.medicalDocsUrl ||
            await uploadMaybe("medicalDocsUpload", "medicalDocs", reservedStudentKey, null);

          const documents = {
            passportPhotoUrl: studentData.passportPhotoUrl || null,
            birthCertUrl: studentData.birthCertUrl || null,
            reportCardUrl: studentData.reportCardUrl || null,
            joiningLetterUrl: studentData.joiningLetterUrl || null,
            medicalDocsUrl: studentData.medicalDocsUrl || null
          };

          const draftRef = schoolRef(`admissionsPending/${year}`).push();
          const draftId = draftRef.key;

          await draftRef.set({
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            status: 'pending_approval',
            reservedStudentKey,
            studentData,
            documents,
            payment: {
              reference: paymentReference,
              receivedBy: paymentReceivedBy,
              amount: amountPaid
            },
            referral: window.__SOMAP_REFERRAL__ || null
          });

          const approvalRef = schoolRef('approvalsPending').push();
          await approvalRef.set({
            approvalId: approvalRef.key,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            datePaid: Date.now(),
            status: 'pending',
            sourceModule: 'admission',
            source: 'Admission (Joining Fee)',
            forYear: year,
            academicYear: year,
            studentName: `${studentData.firstName} ${studentData.middleName || ''} ${studentData.lastName}`.replace(/\s+/g, ' ').trim(),
            studentAdm: studentData.admissionNumber,
            className: studentData.classLevel,
            parentContact: studentData.primaryParentContact,
            amountPaidNow: amountPaid,
            recordedBy: paymentReceivedBy,
            paymentReferenceCode: paymentReference,
            modulePayload: {
              admissionDraftId: draftId,
              year,
              reservedStudentKey
            }
          });

          alert('Submitted for approval. Go to Dashboard -> Approvals to approve this admission payment.');
          closeRegistrationModal();
        } else {
          // UPDATE existing
          if (!restrictAction('Edit')) {
            if (registerBtn) registerBtn.disabled = false;
            return;
          }
          const keyToUpdate = editingKey;
          // Use existing student data URLs as defaults
          const existing = editingStudent || {};
          console.log('Updating student, checking files for key:', keyToUpdate); // Debug log
          studentData.passportPhotoUrl = await uploadMaybe("passportPhoto", "passport", keyToUpdate, existing.passportPhotoUrl || null);
          studentData.birthCertUrl = await uploadMaybe("birthCertUpload", "birthCert", keyToUpdate, existing.birthCertUrl || null);
          studentData.reportCardUrl = await uploadMaybe("reportCardUpload", "reportCard", keyToUpdate, existing.reportCardUrl || null);
          studentData.joiningLetterUrl = await uploadMaybe("joiningLetterUpload", "joiningLetter", keyToUpdate, existing.joiningLetterUrl || null);
          studentData.medicalDocsUrl = await uploadMaybe("medicalDocsUpload", "medicalDocs", keyToUpdate, existing.medicalDocsUrl || null);
          // Do an update (preserves existing createdAt if present)
          await schoolRef(`students/${keyToUpdate}`).update({ ...studentData, updatedAt: firebase.database.ServerValue.TIMESTAMP });
          await syncFinanceAfterUpsert(keyToUpdate, studentData);
          // Clean up unused files after update
          await cleanupUnusedFiles(keyToUpdate);
          // Fetch fresh data from Firebase to ensure latest state
          const updatedSnap = await schoolRef(`students/${keyToUpdate}`).once('value');
          const updatedStudent = { key: keyToUpdate, ...updatedSnap.val() };
          if (confirm('✅ Changes saved! Stay in edit mode?')) {
            populateFormWithStudent(updatedStudent); // Reload form with fresh data
            console.log('Reloaded with:', updatedStudent); // Debug log
          } else {
            closeRegistrationModal();
          }
        }
      } catch (err) {
        console.error('Registration/Update error:', err);
        alert('❌ Error saving student: ' + (err.message || err));
        if (registerBtn) registerBtn.disabled = false;
      }
    });
  }

  // ---- Live cache + rendering for search (and edit buttons) ----
  if (db) {
  schoolRef('students').on('value', (snapshot) => {
      const raw = snapshot.val() || {};
      cachedStudentsById.clear();
      cachedStudents = Object.entries(raw).map(([key, s]) => {
        const rec = { key, ...(s || {}) };
        cachedStudentsById.set(key, rec);
        return rec;
      });
      queueRender();
    });
  db.ref(SHIFT_REPORT_PATH).on('value', (snapshot) => {
      shiftReports = snapshot.exists() ? snapshot.val() : {};
      queueRender();
    });
  anchorEnrollRef = schoolRef(`enrollments/${SOMAP_DEFAULT_YEAR}`);
    anchorEnrollRef.on('value', (snapshot) => {
      anchorEnrollments = snapshot.val() || {};
      queueRender();
    });
    attachYearEnrollmentListener(getWorkingYear());
  }

  window.somapYearContext.onYearChanged((newYear) => {
    planLabelCache.clear();
    attachYearEnrollmentListener(newYear);
    const selectEl = document.querySelector('[data-somap-year-select]');
    const hintEl = document.getElementById('somapYearHint');
    if (selectEl) selectEl.value = String(newYear);
    if (hintEl) hintEl.textContent = String(newYear);
    queueRender();
  });

  queueRender();

  async function renderSearchList(students) {
    const searchList = document.getElementById('student-list');
    const searchBox = document.getElementById('search-box');
    if (!searchList) return;
    const term = (searchBox ? searchBox.value || '' : '').toLowerCase().trim();
    const currentYear = String(getWorkingYear());
    const yearHasEnrollments = yearEnrollments && Object.keys(yearEnrollments).length > 0;
    const scopedStudents = yearHasEnrollments
      ? students.filter((s) => yearEnrollments[s.key])
      : students.filter((s) => !s.academicYear || String(s.academicYear) === currentYear);
    const filtered = !term ? scopedStudents : scopedStudents.filter((s) => {
      const full = `${s.firstName || ''} ${s.middleName || ''} ${s.lastName || ''}`.toLowerCase();
      return (
        full.includes(term) ||
        (String(s.pupilId || '').toLowerCase().includes(term)) ||
        (String(s.admissionNumber || '').toLowerCase().includes(term))
      );
    });
    searchList.innerHTML = '';
    if (!filtered.length) {
      searchList.innerHTML = '<div class="text-sm text-slate-500">No students match the current filter or year.</div>';
      return;
    }

    const currentYear = getWorkingYear();
    const generation = ++renderGeneration;
    const enriched = await Promise.all(filtered.map(async (stu) => {
      const fallbackClass = stu.classLevel || stu.className || '';
      const displayClass = resolveClassForStudentYear(stu.key, fallbackClass, currentYear) || fallbackClass || 'N/A';
      const anchorClass = anchorEnrollments[stu.key]?.className || anchorEnrollments[stu.key]?.classLevel || fallbackClass;
      let finance = { fee: 0, planId: null, feeOverride: null };
      try {
        finance = await resolveEffectiveFinance(stu.key, displayClass, { anchorClass, year: currentYear });
      } catch (err) {
        console.error('resolveEffectiveFinance error', stu.key, err);
      }
      let planLabel = '';
      try {
        planLabel = await planLabelFor(finance.planId, currentYear);
      } catch (err) {
        console.warn('Plan label fetch failed', finance.planId, err);
      }
      const isOverrideLocked = finance.feeOverride && (finance.feeOverride.locked !== false);
      const formattedFee = currencyFormatter.format(Number(finance.fee || 0));
      const feeLabel = `TSh ${formattedFee}${isOverrideLocked ? ' (override)' : ''}`;
      const classLabel = displayClass === 'GRADUATED' ? `Graduated (${currentYear})` : displayClass;
      return { stu, finance, feeLabel, classLabel, planLabel };
    }));

    if (generation !== renderGeneration) return;

    enriched.forEach(({ stu, finance, feeLabel, classLabel, planLabel }) => {
      const div = document.createElement('div');
      div.className = 'student-card';
      const shiftInfo = (shiftReports && shiftReports[stu.key]) ? shiftReports[stu.key] : null;
      const shiftStatus = shiftInfo && shiftInfo.status ? String(shiftInfo.status).toLowerCase() : null;
      const showShiftButton = shiftInfo && shiftStatus !== 'shifted';
      const shiftButtonHtml = showShiftButton ? `<button class="btn shift-btn bg-amber-100 text-amber-800 px-3 py-1 rounded" data-key="${stu.key}">Shift</button>` : '';
      const shiftSummaryHtml = shiftInfo ? `
        <div class="mt-2 text-xs ${shiftStatus === 'shifted' ? 'text-emerald-600' : 'text-amber-600'}">
          Shift status: ${escapeHtml((shiftStatus || 'pending').toUpperCase())}
          ${shiftInfo.flaggedAbsences ? ` • ${escapeHtml(String(shiftInfo.flaggedAbsences))} absent days` : ''}
          ${shiftInfo.dateShifted ? ` • Date: ${escapeHtml(shiftInfo.dateShifted)}` : ''}
          ${shiftInfo.reason ? ` • Reason: ${escapeHtml(shiftInfo.reason)}` : ''}
        </div>
      ` : '';
      const studentFullName = `${stu.firstName || ''} ${stu.middleName || ''} ${stu.lastName || ''}`.replace(/\s+/g, ' ').trim();
      const planDisplay = planLabel || (finance.planId ? finance.planId : 'Class default');
      div.innerHTML = `
        <div class="flex justify-between items-start">
          <div>
            <strong>${escapeHtml(studentFullName || 'Unnamed Student')}</strong><br>
            Admission: ${escapeHtml(stu.admissionNumber || stu.pupilId || 'N/A')}<br>
            Class (${escapeHtml(String(currentYear))}): ${escapeHtml(classLabel || 'N/A')}<br>
            Fee (${escapeHtml(String(currentYear))}): ${escapeHtml(feeLabel)}<br>
            Plan: ${escapeHtml(planDisplay)}
          </div>
          <div class="flex gap-2">
            <button class="btn edit-btn bg-yellow-100 text-yellow-800 px-3 py-1 rounded" data-key="${stu.key}">Edit</button>
            <button class="btn delete-btn bg-red-100 text-red-800 px-3 py-1 rounded" data-key="${stu.key}">Delete</button>
            ${shiftButtonHtml}
          </div>
        </div>
        ${stu.passportPhotoUrl ? `<img src="${stu.passportPhotoUrl}" alt="Passport" style="width:80px; height:80px; margin-top:8px; border-radius:6px;" />` : ''}
        <div style="margin-top:6px;">
          ${stu.birthCertUrl ? `<a href="${stu.birthCertUrl}" download target="_blank" class="text-indigo-600 hover:underline">Birth Cert</a> | ` : ''}
          ${stu.reportCardUrl ? `<a href="${stu.reportCardUrl}" download target="_blank" class="text-indigo-600 hover:underline">Report Card</a> | ` : ''}
          ${stu.joiningLetterUrl ? `<a href="${stu.joiningLetterUrl}" download target="_blank" class="text-indigo-600 hover:underline">Joining Letter</a> | ` : ''}
          ${stu.medicalDocsUrl ? `<a href="${stu.medicalDocsUrl}" download target="_blank" class="text-indigo-600 hover:underline">Medical Docs</a>` : ''}
        </div>
        ${shiftSummaryHtml}
      `;
      searchList.appendChild(div);
    });

    // Attach listeners to edit/delete buttons with password check
    document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => {
      const key = e.currentTarget.getAttribute('data-key');
      if (restrictAction('Edit')) {
        startEditForKey(key);
      }
    }));
    document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => {
      const key = e.currentTarget.getAttribute('data-key');
      if (restrictAction('Delete')) {
        doDeleteKey(key);
      }
    }));
    document.querySelectorAll('.shift-btn').forEach(btn => btn.addEventListener('click', (e) => {
      const key = e.currentTarget.getAttribute('data-key');
      if (!key) return;
      if (!shiftReports || !shiftReports[key]) {
        alert('No shift alert recorded for this student.');
        return;
      }
      if (restrictAction('Shift')) {
        doShiftKey(key);
      }
    }));
  }

  // Search input
  const searchBox = document.getElementById('search-box');
  if (searchBox) searchBox.addEventListener('input', queueRender);

  // ---- Edit flow ----
  function startEditForKey(key) {
    const student = cachedStudents.find(s => s.key === key);
    if (!student) return alert('Student not found locally. Please refresh.');
    editingKey = key;
    editingStudent = student;
    document.getElementById('recordKey').value = key;
    modalTitle.textContent = 'Edit Student — ' + (student.firstName || '') + ' ' + (student.lastName || '');
    registerBtn.textContent = 'Save Changes';
    cancelEditBtn.classList.remove('hidden');
    // Populate fields
    populateFormWithStudent(student);
    openModal();
  }

  if (cancelEditBtn) {
    cancelEditBtn.addEventListener('click', () => {
      clearForm();
      modal.style.display = 'none';
    });
  }

  // Helper: Set innerHTML to link only if URL exists
  function setIf(id, url, label) {
    const el = document.getElementById(id);
    if (!el) return;
    if (url) {
      el.innerHTML = `<a href="${url}" download target="_blank" class="text-indigo-600 hover:underline">${label}</a>`;
    } else {
      el.innerHTML = '';
    }
  }

  function populateFormWithStudent(s) {
    try {
      // Map all form fields by their IDs
      const map = [
        'firstName', 'middleName', 'lastName', 'gender', 'dob',
        'admissionNumber', 'pupilId', 'classLevel', 'feePerYear',
        'primaryParentName', 'primaryParentContact', 'secondaryGuardian',
        'relationshipToStudent', 'residentialAddress', 'employmentStatus',
        'schoolName', 'academicYear', 'academicTrack', 'boardingStatus',
        'shiftedFrom', 'birthCertNumber', 'religion', 'tribe', 'stream'
      ];

      map.forEach(k => {
        const el = document.getElementById(k);
        if (el) el.value = s[k] || '';
      });

      // File previews
      setIf('passportPreview', s.passportPhotoUrl, 'Current Passport Photo');
      setIf('birthCertPreview', s.birthCertUrl, 'Current Birth Certificate');
      setIf('reportCardPreview', s.reportCardUrl, 'Current Report Card');
      setIf('joiningLetterPreview', s.joiningLetterUrl, 'Current Joining Letter');
      setIf('medicalDocsPreview', s.medicalDocsUrl, 'Current Medical Docs');

      checkFormValidity();
    } catch (err) {
      console.error('populateForm error', err);
    }
  }

  // ---- Delete flow (with cleanup) ----
  async function doShiftKey(key) {
    try {
      const shiftInfo = shiftReports ? shiftReports[key] : null;
      if (!shiftInfo) {
        alert('No shift alert details found for this student.');
        return;
      }
      const snap = await schoolRef(`students/${key}`).get();
      if (!snap.exists()) {
        alert('Student record not found or already shifted.');
        return;
      }
      const studentData = snap.val() || {};
      const balance = Number(studentData.balance || studentData.outstandingBalance || shiftInfo.balance || 0);
      const nowIso = new Date().toISOString();
      const shiftDate = shiftInfo.dateShifted || nowIso.slice(0, 10);
      const updates = {};
      updates[SOMAP.P(`shiftedStudents/${key}`)] = {
        ...studentData,
        status: 'shifted',
        shiftedAt: shiftDate,
        outstandingBalance: balance,
        shiftReport: {
          ...shiftInfo,
          status: 'shifted',
          adminShiftedAt: nowIso,
          outstandingBalance: balance
        }
      };
      updates[SOMAP.P(`students/${key}`)] = null;
      updates[`${SHIFT_REPORT_PATH}/${key}/status`] = 'shifted';
      updates[`${SHIFT_REPORT_PATH}/${key}/adminShiftedAt`] = nowIso;
      updates[`${SHIFT_REPORT_PATH}/${key}/outstandingBalance`] = balance;
      updates[`${SHIFT_REPORT_PATH}/${key}/statusNote`] = 'Shifted to hub';
      await db.ref().update(updates);
      alert('Student shifted to SHIFTED HUB successfully.');
    } catch (err) {
      console.error('Shift student error', err);
      alert('Failed to shift student: ' + (err && err.message ? err.message : err));
    }
  }

  async function doDeleteKey(key) {
    if (!confirm('Delete this student record? This action cannot be undone.')) return;
    try {
      await schoolRef(`students/${key}`).remove();
      await cleanupUnusedFiles(key); // Clean up files after deletion
      alert('✅ Student deleted.');
    } catch (err) {
      console.error('Delete error', err);
      alert('Error deleting: ' + (err.message || err));
    }
  }

  // ---- Cleanup unused Cloudinary files ----
  async function cleanupUnusedFiles(studentKey) {
    try {
      const res = await fetch(`https://api.cloudinary.com/v1_1/dg7vnrkgd/resources/search?expression=asset_folder:studentDocs/${studentKey}`, {
        headers: { Authorization: 'Basic ' + btoa('576157272218857:jZZ8MeNIiOloY5PBRIJXAEfJihs') }
      });
      const data = await res.json();
      const student = cachedStudents.find(s => s.key === studentKey) || {};
      const currentUrls = [student.passportPhotoUrl, student.birthCertUrl, student.reportCardUrl, student.joiningLetterUrl, student.medicalDocsUrl].filter(Boolean);
      const toDelete = data.resources.filter(asset => !currentUrls.some(url => url.includes(asset.public_id)));
      if (toDelete.length) {
        await fetch(`https://api.cloudinary.com/v1_1/dg7vnrkgd/resources/by_public_id`, {
          method: 'DELETE',
          headers: { Authorization: 'Basic ' + btoa('576157272218857:jZZ8MeNIiOloY5PBRIJXAEfJihs') },
          body: JSON.stringify({ public_ids: toDelete.map(asset => asset.public_id) })
        });
        console.log('Deleted unused files:', toDelete.length);
      } else {
        console.log('No unused files to delete for key:', studentKey);
      }
    } catch (err) {
      console.error('Cleanup error:', err);
    }
  }

  // ---- Joining form gate: block direct admission if a verified joining application exists ----
  async function checkJoiningApplicationGate(studentData) {
    try {
      const year = getWorkingYear();
      const snap = await db.ref(withSchool(`joiningApplications/${year}`)).get();
      const entries = snap.val() || {};
      const normalizedPhone = String(studentData.primaryParentContact || '').replace(/\s+/g, '');
      for (const [id, app] of Object.entries(entries)) {
        if (!app) continue;
        const statusOk = ['paid_form_issued', 'awaiting_admission', 'admitted'].includes(app.status);
        const phoneMatch = String(app.parentPhone || '').replace(/\s+/g, '') === normalizedPhone;
        const classMatch = L(app.classLevel) === L(studentData.classLevel);
        if (app.paymentVerificationStatus === 'verified' && statusOk && phoneMatch && classMatch) {
          return { id, app };
        }
      }
      return null;
    } catch (err) {
      console.warn('Joining form gate check failed', err);
      return null;
    }
  }

  // ---- Connectivity sanity check ----
  if (db) {
    schoolRef('z_test_write').set({ ok: true, ts: Date.now() })
      .then(() => console.log('DB test write OK'))
      .catch(err => console.warn('DB test write failed (ignore if rules block):', err.message));
  }
});
(function initJoinRequestBadge(){
  if (!window.db || !window.SOMAP) {
    console.warn('Join badge skipped: Firebase or SOMAP not ready');
    return;
  }

  const badge = document.getElementById('joinBadge');
  if (!badge) return;

  const ref = window.db.ref(SOMAP.P('joinApprovalsPending'));

  ref.on('value', snap => {
    const all = snap.val() || {};
    let count = 0;

    Object.values(all).forEach(r => {
          if (
            r &&
            r.status === 'pending' &&
            (!r.approvalType || r.approvalType === 'JOIN_REQUEST')
          ) {
            count++;
          }

    });

    if (count > 0) {
      badge.textContent = count;
      badge.classList.remove('hidden');
    } else {
      badge.classList.add('hidden');
    }
  });
})();
function renderReferralBadge(record) {
  if (record?.referral?.code && record?.referral?.verified === true) {
    return `<span class="badge badge-referral">REFERRED</span>`;
  }

  if (record?.referral?.code && record?.referral?.verified !== true) {
    return `<span class="badge badge-unverified">REFERRAL (UNVERIFIED)</span>`;
  }

  return `<span class="badge badge-public">PUBLIC</span>`;
}

</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('openRegistrationModal');
  const modal = document.getElementById('registrationModal');
  const closeBtn = document.getElementById('closeModal');
  if (!modal) return;

  if (btn) {
    btn.addEventListener('click', () => {
      if (typeof window.somapOpenAdmissionModal === 'function') {
        window.somapOpenAdmissionModal();
        if (typeof window.somapRenderAdmissionList === 'function') {
          window.somapRenderAdmissionList();
        }
      } else {
        modal.style.display = 'block';
        // auto admission number
        const adm = document.getElementById('admissionNumber');
        if (adm && !adm.value) adm.value = `AUTO-${Date.now()}`;
      }
    });
  }

  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      if (typeof window.somapCloseAdmissionModal === 'function') {
        window.somapCloseAdmissionModal();
      } else {
        modal.style.display = 'none';
      }
    });
  }

  window.addEventListener('click', (e) => {
    if (e.target !== modal) return;
    if (typeof window.somapCloseAdmissionModal === 'function') {
      window.somapCloseAdmissionModal();
    } else {
      modal.style.display = 'none';
    }
  });
});
</script>
</body>
</html>

