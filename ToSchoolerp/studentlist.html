<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp â€” Students List</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background:#f8fafc; color:#0f172a; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
    thead th { background:#eef2ff; color:#0b69ff; }
    .hidden { display:none !important; }
    .block { display:block !important; }
    .student-card { background:#fff; border:1px solid #e6e9ef; border-radius:8px; padding:10px; margin-bottom:10px; }
    .hint { font-size:12px; color:#6b7280; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:.5rem .85rem; border-radius:.5rem; }
    .modal { display:none; position:fixed; inset:0; width:100%; height:100%;
             background-color: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px;
      border-radius:10px; width:95%; max-width:920px; height:90vh; overflow-y:auto; margin-top:20px; }
    .close { position:absolute; top:10px; right:16px; font-size:24px; cursor:pointer; }
  </style>

  <script>
  /** Anchor year for class progression **/
  const SOMAP_DEFAULT_YEAR = 2025;

  /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
  const CLASS_ORDER = ['Baby Class','Middle Class','Pre Unit Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
  const L = s => String(s||'').trim().toLowerCase();

  /** Shift a base class by delta years relative to anchor (2025). */
  function shiftClass(baseClass, deltaYears){
    const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
    if (i<0) return baseClass||'';
    const j = i + Number(deltaYears||0);
    if (j < 0) return 'PRE-ADMISSION';
    if (j >= CLASS_ORDER.length) return 'GRADUATED';
    return CLASS_ORDER[j];
  }
  </script>
</head>
<body class="bg-gray-50 p-4">

  <!-- Back to Dashboard -->
  <div class="mb-4">
    <a href="../schoolerp.html" class="text-indigo-600 hover:underline flex items-center gap-2 mb-4">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Students List Content -->
  <div class="bg-white rounded-lg shadow p-4">
    <h3 class="font-medium text-gray-800">Student List</h3>
    <p class="text-sm text-gray-500 mb-1">Filter by class and download the list.</p>
    <p class="text-xs text-slate-600 mb-3" id="currentSchoolLabel"></p>

    <div id="somapYearWrap" style="display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;">
      <label class="text-xs font-semibold">Academic Year</label>
      <select data-somap-year-select class="border rounded px-2 py-1 text-sm"></select>
      <span class="text-xs text-slate-600">Working year: <b id="somapYearHint">--</b></span>
    </div>

    <!-- Student Count Card -->
    <div id="studentCountCard" class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg p-6 mb-4 text-white" style="display:none;">
      <h4 class="text-lg font-semibold mb-4">Student Statistics</h4>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Total Students</div>
          <div class="text-2xl font-bold" id="countTotal">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Boys</div>
          <div class="text-2xl font-bold" id="countBoys">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Girls</div>
          <div class="text-2xl font-bold" id="countGirls">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Unknown Gender</div>
          <div class="text-2xl font-bold" id="countUnknown">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Current Class Filter</div>
          <div class="text-lg font-semibold" id="countClassFilter">All Classes</div>
        </div>
      </div>
    </div>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="student-list-class" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="">All Classes</option>
        <option>Baby Class</option>
        <option>Middle Class</option>
        <option>Pre Unit Class</option>
        <option>Class 1</option>
        <option>Class 2</option>
        <option>Class 3</option>
        <option>Class 4</option>
        <option>Class 5</option>
        <option>Class 6</option>
        <option>Class 7</option>
      </select>

      <div class="ml-auto flex gap-2">
        <button id="downloadCsvBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="downloadPdfBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="student-list-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Date of Registration</th>
            <th>Passport Photo</th>
            <th>Parent Contact</th>
            <th>Fee Total</th>
            <th>Paid Amount</th>
            <th>Debt</th>
            <th>Payment Plan</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="studentListBody">
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">School Reports</h3>
    <p class="text-sm text-gray-500 mb-3">Download reports per school, class, month, term, year.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="school-report-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-school">Per School</option>
        <option value="per-class">Per Class</option>
        <option value="per-month">Per Month</option>
        <option value="per-term">Per Term</option>
        <option value="per-year">Per Year</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="schoolDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="schoolDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="school-report-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="schoolReportBody"></tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">Report Forms</h3>
    <p class="text-sm text-gray-500 mb-3">Download report forms with student details.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="report-form-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-student">Per Student</option>
        <option value="per-class">Per Class</option>
        <option value="per-term">Per Term</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="reportDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="reportDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="report-form-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="reportFormBody"></tbody>
      </table>
    </div>
  </div>

   <!-- Third-party libraries (CSV + PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDKs (compat) + your config -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script> <!-- Adjusted path to firebase.js in root -->
    <!-- Students List Logic -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const db = window.db || (window.firebase && window.firebase.database ? window.firebase.database() : null);
        if (!db) {
          console.error("Firebase Realtime Database not available. Ensure ../firebase.js and Firebase SDKs are loaded.");
          return;
        }

        const SOMAP = window.SOMAP;
        if (!SOMAP?.getSchool?.() || !SOMAP?.P) {
          window.location.href = "../somapappv1multischool/multischool.html";
          return;
        }
        const school = SOMAP.getSchool();
        if (!school?.id) {
          window.location.href = "../somapappv1multischool/multischool.html";
          return;
        }

        const schoolLabel = document.getElementById("currentSchoolLabel");
        if (schoolLabel) schoolLabel.textContent = `Current school: ${school.name || school.id}`;

        const yearSelect = document.querySelector("[data-somap-year-select]");
        const yearHint = document.getElementById("somapYearHint");
        const classFilter = document.getElementById("student-list-class");
        const studentsBody = document.getElementById("studentListBody");
        const countCard = document.getElementById("studentCountCard");
        const downloadCsvBtn = document.getElementById("downloadCsvBtn");
        const downloadPdfBtn = document.getElementById("downloadPdfBtn");

        if (yearSelect && window.somapYearContext?.attachYearDropdown) {
          window.somapYearContext.attachYearDropdown(yearSelect);
        }

        let lastAllRows = [];
        let workingYear = String(window.somapYearContext?.getSelectedYear?.() || new Date().getFullYear());
        let loadToken = 0;

        function schoolRef(path) {
          return db.ref(SOMAP.P(path));
        }

        function isObject(value) {
          return !!value && typeof value === "object";
        }

        function norm(value) {
          return String(value ?? "").trim();
        }

        function isPlaceholder(value) {
          const raw = norm(value).toLowerCase();
          return !raw || ["n/a", "na", "null", "undefined", "-", "--"].includes(raw);
        }

        function asYear(value) {
          if (value == null || value === "") return null;
          if (typeof value === "number" && Number.isFinite(value)) {
            if (value >= 2000 && value <= 2100) return Math.trunc(value);
            if (value > 1000000000000) return new Date(value).getFullYear();
            return null;
          }
          const raw = norm(value);
          if (/^\d{4}$/.test(raw)) return Number(raw);
          const asNum = Number(raw);
          if (Number.isFinite(asNum) && asNum > 1000000000000) return new Date(asNum).getFullYear();
          const d = new Date(raw);
          return Number.isNaN(d.getTime()) ? null : d.getFullYear();
        }

        function isDeletedLike(record) {
          if (!isObject(record)) return false;
          if (record.deleted === true || record.isDeleted === true) return true;
          const status = norm(record.status || record.state).toLowerCase();
          return ["deleted", "inactive", "removed", "archived"].includes(status);
        }

        function truthyMapKeys(obj) {
          const keys = [];
          Object.entries(obj || {}).forEach(([k, v]) => {
            if (!v) return;
            if (v === true) {
              keys.push(k);
              return;
            }
            if (isObject(v) && !isDeletedLike(v)) {
              keys.push(k);
            }
          });
          return keys;
        }

        function enrollmentKeys(enrollments) {
          const keys = [];
          Object.entries(enrollments || {}).forEach(([k, v]) => {
            if (!v || isDeletedLike(v)) return;
            if (v === true) {
              keys.push(k);
              return;
            }
            const sid = norm(v.studentId || v.studentKey || v.studentRef || v.id || k);
            if (!isPlaceholder(sid)) keys.push(sid);
          });
          return keys;
        }

        function enrollmentIndexByStudent(enrollments) {
          const index = {};
          Object.entries(enrollments || {}).forEach(([k, v]) => {
            if (!v || isDeletedLike(v)) return;
            if (v === true) {
              const key = norm(k);
              if (!isPlaceholder(key)) index[key] = {};
              return;
            }
            const sid = norm(v.studentId || v.studentKey || v.studentRef || v.id || k);
            if (!isPlaceholder(sid) && !index[sid]) index[sid] = v;
          });
          return index;
        }

        function baseIndexByStudent(baseStudents) {
          const index = {};
          Object.entries(baseStudents || {}).forEach(([k, v]) => {
            if (!isObject(v) || isDeletedLike(v)) return;
            const keys = [
              k,
              v.studentId,
              v.id,
              v.admissionNo,
              v.admissionNumber,
              v.pupilId,
              v.adm
            ].map((x) => norm(x)).filter((x) => !isPlaceholder(x));
            keys.forEach((key) => {
              if (!index[key]) index[key] = v;
            });
          });
          return index;
        }

        function pick(...values) {
          for (const v of values) {
            if (!isPlaceholder(v)) return norm(v);
          }
          return "";
        }

        function composeName(base, enr, roster) {
          const direct = pick(
            roster?.fullName, roster?.name,
            enr?.fullName, enr?.name,
            base?.fullName, base?.name
          );
          if (!isPlaceholder(direct)) return direct;
          const joined = `${pick(roster?.firstName, enr?.firstName, base?.firstName)} ${pick(roster?.middleName, enr?.middleName, base?.middleName)} ${pick(roster?.lastName, enr?.lastName, base?.lastName)}`
            .replace(/\s+/g, " ")
            .trim();
          return isPlaceholder(joined) ? "" : joined;
        }

        function rosterIndexByStudent(roster) {
          const index = {};
          Object.entries(roster || {}).forEach(([k, v]) => {
            if (!v || isDeletedLike(v)) return;
            const key = norm(k);
            if (isPlaceholder(key)) return;
            if (v === true) {
              if (!index[key]) index[key] = {};
              return;
            }
            if (!index[key]) index[key] = v;
          });
          return index;
        }

        function admissionYearOf(base, enr) {
          const candidates = [
            enr?.admissionYear, base?.admissionYear, enr?.registrationYear, base?.registrationYear,
            enr?.registeredYear, base?.registeredYear, enr?.year, base?.year,
            enr?.regDate, base?.regDate, enr?.dateOfRegistration, base?.dateOfRegistration,
            enr?.createdAt, base?.createdAt, enr?.timestamp, base?.timestamp
          ];
          for (const c of candidates) {
            const y = asYear(c);
            if (Number.isFinite(y)) return y;
          }
          return null;
        }

        function formatDate(value) {
          if (isPlaceholder(value)) return "N/A";
          const n = Number(value);
          const d = Number.isFinite(n) ? new Date(n) : new Date(value);
          if (Number.isNaN(d.getTime())) return "N/A";
          return d.toLocaleDateString();
        }

        function escapeHtml(str) {
          return String(str || "").replace(/[&<>"']/g, (m) => ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            "\"": "&quot;",
            "'": "&#039;"
          }[m]));
        }

        function getFilterValue() {
          const v = norm(classFilter?.value || "");
          return !v || v === "All Classes" ? "" : v;
        }

        function normalizeGender(value) {
          const g = norm(value).toLowerCase();
          if (["male", "m", "boy"].includes(g)) return "male";
          if (["female", "f", "girl"].includes(g)) return "female";
          return "unknown";
        }

        function updateClassFilterOptions(rows) {
          if (!classFilter) return;
          const classes = Array.from(new Set((rows || []).map((r) => r.className).filter((x) => !isPlaceholder(x)))).sort();
          const options = ["All Classes", ...classes];
          const current = classFilter.value || "All Classes";
          classFilter.innerHTML = "";
          options.forEach((label) => {
            const o = document.createElement("option");
            o.value = label;
            o.textContent = label;
            classFilter.appendChild(o);
          });
          classFilter.value = options.includes(current) ? current : "All Classes";
        }

        function renderTable(rows) {
          if (!studentsBody) return;
          if (!rows.length) {
            studentsBody.innerHTML = `<tr><td colspan="11" class="text-center text-sm text-slate-500 py-4">No students for ${escapeHtml(workingYear)} yet.</td></tr>`;
            return;
          }
          const frag = document.createDocumentFragment();
          rows.forEach((row) => {
            const tr = document.createElement("tr");
            const photoCell = row.photoUrl
              ? `<img src="${escapeHtml(row.photoUrl)}" alt="photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px"/>`
              : "N/A";
            const viewUrl = row.id ? `generateid.html?key=${encodeURIComponent(row.id)}` : "#";
            tr.innerHTML = `
              <td>${escapeHtml(row.admissionNo)}</td>
              <td>${escapeHtml(row.fullName)}</td>
              <td>${escapeHtml(row.className)}</td>
              <td>${escapeHtml(row.regDate)}</td>
              <td>${photoCell}</td>
              <td>${escapeHtml(row.parentContact || "N/A")}</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>
                <a href="${viewUrl}" target="_blank" class="py-1 px-2 border rounded text-indigo-600 inline-block" title="Open student profile">
                  <i class="fas fa-eye"></i>
                </a>
              </td>
            `;
            frag.appendChild(tr);
          });
          studentsBody.replaceChildren(frag);
        }

        function renderCounts(filteredRows) {
          const boys = filteredRows.filter((r) => r.gender === "male").length;
          const girls = filteredRows.filter((r) => r.gender === "female").length;
          const unknown = filteredRows.length - boys - girls;
          const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = String(value);
          };
          setText("countTotal", filteredRows.length);
          setText("countBoys", boys);
          setText("countGirls", girls);
          setText("countUnknown", unknown);
          setText("countClassFilter", getFilterValue() || "All Classes");
          if (countCard) countCard.style.display = "block";
        }

        function renderFromCache() {
          const fv = getFilterValue();
          const rows = fv ? lastAllRows.filter((r) => r.className === fv) : lastAllRows;
          renderCounts(rows);
          renderTable(rows);
        }

        async function loadStudents(yearOverride) {
          const thisLoad = ++loadToken;
          workingYear = String(yearOverride || window.somapYearContext?.getSelectedYear?.() || new Date().getFullYear());
          if (yearHint) yearHint.textContent = workingYear;
          if (yearSelect && yearSelect.value !== workingYear) yearSelect.value = workingYear;
          if (studentsBody) {
            studentsBody.innerHTML = `<tr><td colspan="11" class="text-center text-sm text-slate-500 py-4">Loading students for ${escapeHtml(workingYear)}...</td></tr>`;
          }

          try {
            const [studentsSnap, enrollSnap, rosterSnap, gradSnap] = await Promise.all([
              schoolRef("students").once("value"),
              schoolRef(`years/${workingYear}/enrollments`).once("value"),
              schoolRef(`years/${workingYear}/students`).once("value"),
              schoolRef(`years/${workingYear}/graduated`).once("value")
            ]);
            if (thisLoad !== loadToken) return;

            const baseStudents = studentsSnap.val() || {};
            const enrollments = enrollSnap.val() || {};
            const yearRoster = rosterSnap.val() || {};
            const graduated = gradSnap.val() || {};
            const baseByStudent = baseIndexByStudent(baseStudents);
            const enrollmentByStudent = enrollmentIndexByStudent(enrollments);
            const rosterByStudent = rosterIndexByStudent(yearRoster);

            const rosterIds = truthyMapKeys(yearRoster);
            const enrolledIds = enrollmentKeys(enrollments);
            const candidateIds = rosterIds.length ? rosterIds : (enrolledIds.length ? enrolledIds : Object.keys(baseStudents || {}));
            console.info("[studentlist] source counts", {
              year: workingYear,
              base: Object.keys(baseStudents || {}).length,
              roster: rosterIds.length,
              enrollments: enrolledIds.length,
              graduated: truthyMapKeys(graduated).length,
              candidates: candidateIds.length
            });

            const yearNum = Number(workingYear);
            const graduatedIds = new Set(truthyMapKeys(graduated));
            const deduped = Array.from(new Set(candidateIds.map((v) => norm(v)).filter(Boolean)));
            const rows = [];

            deduped.forEach((id) => {
              const base = isObject(baseByStudent[id]) ? baseByStudent[id] : {};
              const enr = isObject(enrollmentByStudent[id]) ? enrollmentByStudent[id] : {};
              const roster = isObject(rosterByStudent[id]) ? rosterByStudent[id] : {};

              if (isDeletedLike(base) || isDeletedLike(enr) || isDeletedLike(roster)) return;
              if (graduatedIds.has(id)) return;

              const admissionYear = admissionYearOf(base, enr) || asYear(roster?.admissionYear) || asYear(roster?.registrationYear) || asYear(roster?.year);
              if (!rosterIds.length && !enrolledIds.length && Number.isFinite(yearNum) && Number.isFinite(admissionYear) && admissionYear > yearNum) {
                return;
              }

              const admissionNo = pick(roster.admissionNo, roster.admissionNumber, enr.admissionNo, enr.admissionNumber, base.admissionNo, base.admissionNumber, base.pupilId, base.adm, id);
              const fullName = composeName(base, enr, roster);
              const className = pick(roster.className, roster.class, roster.currentClass, enr.className, enr.class, enr.currentClass, base.className, base.class, base.currentClass) || "Unassigned";
              const parentContact = pick(roster.parentContact, roster.parentPhone, roster.phone, enr.parentContact, enr.parentPhone, enr.phone, base.parentContact, base.parentPhone, base.phone);
              const photoUrl = pick(roster.photoUrl, roster.passportPhotoUrl, roster.passportPhotoURL, enr.photoUrl, enr.passportPhotoUrl, enr.passportPhotoURL, base.photoUrl, base.passportPhotoUrl, base.passportPhotoURL);
              const regDateRaw = pick(roster.regDate, roster.dateOfRegistration, roster.registeredAt, roster.createdAt, roster.timestamp, enr.regDate, enr.dateOfRegistration, enr.registeredAt, enr.createdAt, enr.timestamp, base.regDate, base.dateOfRegistration, base.registeredAt, base.createdAt, base.timestamp);
              const gender = normalizeGender(pick(roster.gender, enr.gender, base.gender));

              if (isPlaceholder(admissionNo) || isPlaceholder(fullName)) return;

              rows.push({
                id: pick(base.studentId, base.id, id),
                admissionNo,
                fullName,
                className,
                regDate: formatDate(regDateRaw),
                photoUrl: isPlaceholder(photoUrl) ? "" : photoUrl,
                parentContact: isPlaceholder(parentContact) ? "" : parentContact,
                gender
              });
            });

            rows.sort((a, b) => {
              const classCmp = a.className.localeCompare(b.className);
              if (classCmp) return classCmp;
              return a.fullName.localeCompare(b.fullName);
            });
            console.info("[studentlist] rendered rows", { year: workingYear, rows: rows.length });

            lastAllRows = rows;
            updateClassFilterOptions(rows);
            renderFromCache();
          } catch (err) {
            console.error("Failed loading students list", err);
            if (thisLoad !== loadToken) return;
            lastAllRows = [];
            updateClassFilterOptions([]);
            renderFromCache();
          }
        }

        function getFilteredRows() {
          const fv = getFilterValue();
          return fv ? lastAllRows.filter((r) => r.className === fv) : lastAllRows.slice();
        }

        function downloadCsv() {
          const rows = getFilteredRows();
          if (!rows.length) {
            alert("No students to download for the current filter and year.");
            return;
          }
          const lines = [["Admission No", "Full Name", "Class", "Date of Registration", "Parent Contact", "Gender"]];
          rows.forEach((r) => {
            lines.push([r.admissionNo, r.fullName, r.className, r.regDate, r.parentContact || "N/A", r.gender]);
          });
          const csv = lines
            .map((line) => line.map((v) => `"${String(v ?? "").replace(/"/g, "\"\"")}"`).join(","))
            .join("\n");
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const a = document.createElement("a");
          a.href = URL.createObjectURL(blob);
          a.download = `students_${workingYear}.csv`;
          a.click();
          URL.revokeObjectURL(a.href);
        }

        function downloadPdf() {
          const rows = getFilteredRows();
          if (!rows.length) {
            alert("No students to download for the current filter and year.");
            return;
          }
          const jsPDFCtor = window.jspdf?.jsPDF;
          if (!jsPDFCtor) {
            alert("PDF library is unavailable.");
            return;
          }
          const doc = new jsPDFCtor({ orientation: "landscape" });
          doc.text(`Students List - ${workingYear}`, 14, 12);
          doc.autoTable({
            startY: 16,
            head: [["Admission No", "Full Name", "Class", "Date of Registration", "Parent Contact", "Gender"]],
            body: rows.map((r) => [r.admissionNo, r.fullName, r.className, r.regDate, r.parentContact || "N/A", r.gender])
          });
          doc.save(`students_${workingYear}.pdf`);
        }

        classFilter?.addEventListener("change", renderFromCache);
        downloadCsvBtn?.addEventListener("click", (e) => {
          e.preventDefault();
          downloadCsv();
        });
        downloadPdfBtn?.addEventListener("click", (e) => {
          e.preventDefault();
          downloadPdf();
        });

        if (window.somapYearContext?.onYearChanged) {
          window.somapYearContext.onYearChanged((year) => loadStudents(String(year || "")));
        }
        loadStudents(workingYear);
      });
    </script>
</body>
</html>


