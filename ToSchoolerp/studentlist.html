<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp â€” Students List</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background:#f8fafc; color:#0f172a; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
    thead th { background:#eef2ff; color:#0b69ff; }
    .hidden { display:none !important; }
    .block { display:block !important; }
    .student-card { background:#fff; border:1px solid #e6e9ef; border-radius:8px; padding:10px; margin-bottom:10px; }
    .hint { font-size:12px; color:#6b7280; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:.5rem .85rem; border-radius:.5rem; }
    .modal { display:none; position:fixed; inset:0; width:100%; height:100%;
             background-color: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px;
      border-radius:10px; width:95%; max-width:920px; height:90vh; overflow-y:auto; margin-top:20px; }
    .close { position:absolute; top:10px; right:16px; font-size:24px; cursor:pointer; }
  </style>

  <script>
  /** Anchor year for class progression **/
  const SOMAP_DEFAULT_YEAR = 2025;

  /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
  const CLASS_ORDER = ['Baby Class','Middle Class','Pre Unit Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
  const L = s => String(s||'').trim().toLowerCase();

  /** Shift a base class by delta years relative to anchor (2025). */
  function shiftClass(baseClass, deltaYears){
    const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
    if (i<0) return baseClass||'';
    const j = i + Number(deltaYears||0);
    if (j < 0) return 'PRE-ADMISSION';
    if (j >= CLASS_ORDER.length) return 'GRADUATED';
    return CLASS_ORDER[j];
  }
  </script>
</head>
<body class="bg-gray-50 p-4">

  <!-- Back to Dashboard -->
  <div class="mb-4">
    <a href="../schoolerp.html" class="text-indigo-600 hover:underline flex items-center gap-2 mb-4">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Students List Content -->
  <div class="bg-white rounded-lg shadow p-4">
    <h3 class="font-medium text-gray-800">Student List</h3>
    <p class="text-sm text-gray-500 mb-1">Filter by class and download the list.</p>
    <p class="text-xs text-slate-600 mb-3" id="currentSchoolLabel"></p>

    <div id="somapYearWrap" style="display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;">
      <label class="text-xs font-semibold">Academic Year</label>
      <select data-somap-year-select class="border rounded px-2 py-1 text-sm"></select>
      <span class="text-xs text-slate-600">Working year: <b id="somapYearHint">--</b></span>
    </div>

    <!-- Student Count Card -->
    <div id="studentCountCard" class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg p-6 mb-4 text-white" style="display:none;">
      <h4 class="text-lg font-semibold mb-4">Student Statistics</h4>
    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Total Students</div>
          <div class="text-2xl font-bold" id="countTotal">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Boys</div>
          <div class="text-2xl font-bold" id="countBoys">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Girls</div>
          <div class="text-2xl font-bold" id="countGirls">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Unknown Gender</div>
          <div class="text-2xl font-bold" id="countUnknown">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Current Class Filter</div>
          <div class="text-lg font-semibold" id="countClassFilter">All Classes</div>
        </div>
      </div>
    </div>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="student-list-class" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="">All Classes</option>
        <option>Baby Class</option>
        <option>Middle Class</option>
        <option>Pre Unit Class</option>
        <option>Class 1</option>
        <option>Class 2</option>
        <option>Class 3</option>
        <option>Class 4</option>
        <option>Class 5</option>
        <option>Class 6</option>
        <option>Class 7</option>
      </select>

      <div class="ml-auto flex gap-2">
        <button id="downloadCsvBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="downloadPdfBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="student-list-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Date of Registration</th>
            <th>Passport Photo</th>
            <th>Parent Contact</th>
            <th>Fee Total</th>
            <th>Paid Amount</th>
            <th>Debt</th>
            <th>Payment Plan</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="studentListBody">
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">School Reports</h3>
    <p class="text-sm text-gray-500 mb-3">Download reports per school, class, month, term, year.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="school-report-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-school">Per School</option>
        <option value="per-class">Per Class</option>
        <option value="per-month">Per Month</option>
        <option value="per-term">Per Term</option>
        <option value="per-year">Per Year</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="schoolDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="schoolDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="school-report-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="schoolReportBody"></tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">Report Forms</h3>
    <p class="text-sm text-gray-500 mb-3">Download report forms with student details.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="report-form-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-student">Per Student</option>
        <option value="per-class">Per Class</option>
        <option value="per-term">Per Term</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="reportDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="reportDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="report-form-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="reportFormBody"></tbody>
      </table>
    </div>
  </div>

   <!-- Third-party libraries (CSV + PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDKs (compat) + your config -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script> <!-- Adjusted path to firebase.js in root -->

    <!-- Students List Logic -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const db = window.db || (window.firebase && window.firebase.database ? window.firebase.database() : null);
        if (!db) {
          console.error("Firebase Realtime Database not available. Ensure ../firebase.js and Firebase SDKs are loaded.");
          return;
        }

        const SOMAP = window.SOMAP;
        if (!SOMAP?.getSchool?.()) {
          window.location.href = "../somapappv1multischool/multischool.html";
          return;
        }
        if (!SOMAP?.P) {
          console.error("Missing SOMAP path helper; redirecting to school selector.");
          window.location.href = "../somapappv1multischool/multischool.html";
          return;
        }
        const school = SOMAP.getSchool();
        if (!school?.id) {
          window.location.href = "../somapappv1multischool/multischool.html";
          return;
        }
        const schoolLabel = document.getElementById("currentSchoolLabel");
        if (schoolLabel) {
          const schoolName = school.name || school.id;
          schoolLabel.textContent = `Current school: ${schoolName}`;
        }

        const yearSelect = document.querySelector("[data-somap-year-select]");
        const yearHint = document.getElementById("somapYearHint");
        if (yearSelect && window.somapYearContext?.attachYearDropdown) {
          window.somapYearContext.attachYearDropdown(yearSelect);
        }

        const classFilter = document.getElementById("student-list-class");
        const studentsBody = document.getElementById("studentListBody");
        const downloadCsvBtn = document.getElementById("downloadCsvBtn");
        const countCard = document.getElementById("studentCountCard");

        let lastAllRows = [];
        let studentRecords = {};
        let studentsRef = null;
        let studentsHandler = null;
        let selectedYear = SOMAP_DEFAULT_YEAR;

          const getYear = () => String(window.somapYearContext?.getSelectedYear?.() || SOMAP_DEFAULT_YEAR);
          const updateYearUI = (yearOverride) => {
            const year = String(yearOverride ?? getYear());
            selectedYear = year;
            if (yearHint) yearHint.textContent = year;
            if (yearSelect && yearSelect.value !== year) yearSelect.value = year;
            return year;
          };

        function schoolRef(path) {
          return db.ref(SOMAP.P(path));
        }

        function attachStudentsListener() {
          detachStudentsListener();
          studentsRef = schoolRef("students");
          studentsHandler = (snapshot) => {
            studentRecords = snapshot.val() || {};
            renderForYear();
          };
          studentsRef.on("value", studentsHandler, (err) => {
            console.error("Student list listener error:", err);
          });
        }

        function detachStudentsListener() {
          if (studentsRef && studentsHandler) {
            studentsRef.off("value", studentsHandler);
          }
          studentsRef = null;
          studentsHandler = null;
        }

        function renderForYear(yearOverride) {
          const currentYear = updateYearUI(yearOverride);
          const rows = normalizeStudents(studentRecords, currentYear);
          lastAllRows = rows;
          renderAll(rows, currentYear);
        }

        function selectBestYearBlob(student, currentYear) {
          const numericYear = Number(currentYear);
          if (!Number.isFinite(numericYear)) return null;
          const entries = [];
          const collect = (source) => {
            if (!source || typeof source !== "object") return;
            Object.entries(source).forEach(([year, value]) => {
              if (!value) return;
              const parsed = Number(year);
              if (!Number.isFinite(parsed) || parsed > numericYear) return;
              entries.push({ year: parsed, value });
            });
          };
          collect(student.years);
          collect(student.yearData);
          if (!entries.length) return null;
          entries.sort((a, b) => b.year - a.year);
          return entries[0];
        }

        function normalizeStudents(rawObj, currentYear) {
          const arr = [];
          const numericCurrentYear = Number(currentYear) || Number(SOMAP_DEFAULT_YEAR);
          for (const [key, s] of Object.entries(rawObj || {})) {
            if (!s) continue;
            const admissionNo = s.admissionNo || s.adm || s.admission || key;
            if (!admissionNo || admissionNo === "N/A") continue;
            const fullName = (s.fullName || s.name || "").toString().trim();
            if (!fullName || fullName === "N/A") continue;

            let matchedYear = null;
            let yearBlob = null;
            const best = selectBestYearBlob(s, currentYear);
            if (best) {
              matchedYear = Number(best.year);
              yearBlob = best.value;
            }
            if (!Number.isFinite(matchedYear)) {
              const fallbackYear = Number(s.academicYear || s.year || s.registeredYear || s.registrationYear);
              if (Number.isFinite(fallbackYear) && fallbackYear <= numericCurrentYear) {
                matchedYear = fallbackYear;
              }
            }
            if (!Number.isFinite(matchedYear) || matchedYear > numericCurrentYear) continue;
            if (!yearBlob) {
              yearBlob = s;
            }

            let klass = (yearBlob.class || yearBlob.currentClass || yearBlob.klass || s.class || s.currentClass || s.klass || "").toString().trim();
            if (!klass || klass === "N/A") continue;
            if (klass.toUpperCase() === "GRADUATED") continue;

            let gender = (yearBlob.gender || s.gender || "").toString().trim().toLowerCase();
            let parentContact = (yearBlob.parentContact || s.parentContact || s.phone || s.parentPhone || "").toString().trim();

            const status = (yearBlob.status || yearBlob.state || s.status || s.state || "").toString().trim().toLowerCase();
            const badStatus = ["archived", "graduated", "transferred", "left", "deleted"].includes(status);
            if (badStatus) continue;

            const isPriorClassSeven =
              Number.isFinite(matchedYear) &&
              Number.isFinite(numericCurrentYear) &&
              matchedYear < numericCurrentYear &&
              klass.toUpperCase() === "CLASS 7";
            if (isPriorClassSeven) continue;

            arr.push({
              id: s.studentId || s.id || key,
              admissionNo: admissionNo.toString().trim(),
              fullName,
              class: klass,
              gender,
              parentContact,
              matchedYear,
              raw: s,
            });
          }
          const map = new Map();
          for (const row of arr) {
            const dedupeKey = row.admissionNo || `${row.fullName}__${row.parentContact}`;
            if (!map.has(dedupeKey)) map.set(dedupeKey, row);
          }
          return Array.from(map.values()).sort((a, b) => {
            const classCompare = a.class.localeCompare(b.class);
            if (classCompare !== 0) return classCompare;
            return a.fullName.localeCompare(b.fullName);
          });
        }

        function filterRowsByYear(rows, year) {
          const numericYear = Number(year);
          if (!Number.isFinite(numericYear)) return [];
          const actualYear = new Date().getFullYear();
          const includePrevious = numericYear >= actualYear;
          const previousYear = numericYear - 1;
          return rows.filter((row) => {
            if (!row || typeof row.matchedYear !== "number") return false;
            if (row.matchedYear === numericYear) return true;
            if (includePrevious && row.matchedYear === previousYear) return true;
            return false;
          });
        }

        function getFilterValue() {
          const value = (classFilter?.value || "").trim();
          if (!value || value === "All Classes") return "";
          return value;
        }

        function renderAll(allRows = lastAllRows, currentYear = selectedYear) {
          const rows = Array.isArray(allRows) ? allRows : [];
          lastAllRows = rows;
          const yearFiltered = filterRowsByYear(rows, currentYear);
          const filterValue = getFilterValue();
          const filtered = filterValue ? yearFiltered.filter((row) => row.class === filterValue) : yearFiltered;
          const boys = filtered.filter((row) => ["male", "m", "boy"].includes(row.gender)).length;
          const girls = filtered.filter((row) => ["female", "f", "girl"].includes(row.gender)).length;
          const unknown = Math.max(0, filtered.length - boys - girls);
          requestAnimationFrame(() => {
            setText("countTotal", filtered.length);
            setText("countBoys", boys);
            setText("countGirls", girls);
            setText("countUnknown", unknown);
            setText("countClassFilter", filterValue || "All Classes");
            if (countCard) countCard.style.display = "block";
            renderTableRows(filtered);
            populateClassDropdown(rows);
          });
        }

        function setText(id, value) {
          const el = document.getElementById(id);
          if (el) el.textContent = String(value ?? "");
        }

        function renderTableRows(rows) {
          if (!studentsBody) return;
          if (!rows.length) {
            studentsBody.innerHTML = `<tr><td colspan="11" class="text-center text-sm text-slate-500 py-4">No students for ${escapeHtml(getYear())} yet.</td></tr>`;
            return;
          }
          const frag = document.createDocumentFragment();
          for (const row of rows) {
            const regDate = formatDate(row.raw?.timestamp || row.raw?.createdAt || row.raw?.registeredAt);
            const photo = row.raw?.passportPhotoUrl || row.raw?.passportPhotoURL || "https://via.placeholder.com/50";
            const viewUrl = row.id ? `generateid.html?key=${encodeURIComponent(row.id)}` : "#";
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHtml(row.admissionNo)}</td>
              <td>${escapeHtml(row.fullName)}</td>
              <td>${escapeHtml(row.class)}</td>
              <td>${escapeHtml(regDate)}</td>
              <td><img src="${escapeHtml(photo)}" alt="photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px"/></td>
              <td>${escapeHtml(row.parentContact)}</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>N/A</td>
              <td>
                <a href="${viewUrl}" target="_blank" class="py-1 px-2 border rounded text-indigo-600 inline-block" title="Open student profile">
                  <i class="fas fa-eye"></i>
                </a>
              </td>
            `;
            frag.appendChild(tr);
          }
          studentsBody.replaceChildren(frag);
        }

        function populateClassDropdown(allRows) {
          if (!classFilter) return;
          const classes = Array.from(new Set(allRows.map((row) => row.class).filter(Boolean))).sort();
          const newOptions = ["All Classes", ...classes];
          const existing = Array.from(classFilter.options).map((opt) => opt.value);
          const same = existing.length === newOptions.length && existing.every((value, index) => value === newOptions[index]);
          if (same) return;
          classFilter.innerHTML = "";
          newOptions.forEach((value) => {
            const option = document.createElement("option");
            option.value = value;
            option.textContent = value;
            classFilter.appendChild(option);
          });
          const current = classFilter.value;
          classFilter.value = newOptions.includes(current) ? current : "All Classes";
        }

        function escapeHtml(str) {
          return String(str || "").replace(/[&<>"']/g, (match) => ({
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#039;",
          }[match]));
        }

        function formatDate(value) {
          if (!value) return "N/A";
          const date = new Date(Number(value));
          if (Number.isNaN(date.getTime())) return "N/A";
          return date.toLocaleDateString();
        }

        function getFilteredRows(thisRows = lastAllRows) {
          if (!Array.isArray(thisRows)) return [];
          const yearRows = filterRowsByYear(thisRows, selectedYear);
          const filterValue = getFilterValue();
          return filterValue ? yearRows.filter((row) => row.class === filterValue) : yearRows;
        }

        function downloadCsv() {
          const rows = getFilteredRows();
          if (!rows.length) {
            alert("No students to download for the current filter and year.");
            return;
          }
          const header = ["Admission No", "Full Name", "Class", "Parent Contact"];
          const lines = [header];
          for (const row of rows) {
            const phone = row.parentContact ? `\t${row.parentContact}` : "";
            lines.push([row.admissionNo, row.fullName, row.class, phone]);
          }
          const csv = lines
            .map((line) => line.map((value) => `"${String(value ?? "").replace(/"/g, '""')}"`).join(","))
            .join("\n");
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `students_${getYear()}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        }

          classFilter?.addEventListener("change", () => renderAll(lastAllRows, selectedYear));
          downloadCsvBtn?.addEventListener("click", (event) => {
            event.preventDefault();
            downloadCsv();
          });

          const startListeners = () => {
            try {
              attachStudentsListener();
            } catch (err) {
              console.error("Failed to attach student roster listener", err);
            }
          };

          if (window.somapYearContext?.onYearChanged) {
            window.somapYearContext.onYearChanged((year) => {
              renderForYear(year);
            });
          } else {
            renderForYear();
          }
          startListeners();
        });
      </script>

</body>
</html>

