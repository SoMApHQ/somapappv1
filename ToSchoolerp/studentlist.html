<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SoMAp â€” Students List</title>

  <!-- Icons + Tailwind -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>

  <style>
    body { font-family: Inter, system-ui, Arial; background:#f8fafc; color:#0f172a; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:8px; border:1px solid #e6e9ef; text-align:left; font-size:13px; }
    thead th { background:#eef2ff; color:#0b69ff; }
    .hidden { display:none !important; }
    .block { display:block !important; }
    .student-card { background:#fff; border:1px solid #e6e9ef; border-radius:8px; padding:10px; margin-bottom:10px; }
    .hint { font-size:12px; color:#6b7280; }
    .btn { display:inline-flex; align-items:center; gap:8px; padding:.5rem .85rem; border-radius:.5rem; }
    .modal { display:none; position:fixed; inset:0; width:100%; height:100%;
             background-color: rgba(0,0,0,0.5); z-index:1000; }
    .modal-content { position:relative; background:#fff; margin:0 auto; padding:20px;
      border-radius:10px; width:95%; max-width:920px; height:90vh; overflow-y:auto; margin-top:20px; }
    .close { position:absolute; top:10px; right:16px; font-size:24px; cursor:pointer; }
  </style>

  <script>
  /** Anchor year for class progression **/
  const SOMAP_DEFAULT_YEAR = 2025;

  /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
  const CLASS_ORDER = ['Baby Class','Middle Class','Pre Unit Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
  const L = s => String(s||'').trim().toLowerCase();

  /** Shift a base class by delta years relative to anchor (2025). */
  function shiftClass(baseClass, deltaYears){
    const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
    if (i<0) return baseClass||'';
    const j = i + Number(deltaYears||0);
    if (j < 0) return 'PRE-ADMISSION';
    if (j >= CLASS_ORDER.length) return 'GRADUATED';
    return CLASS_ORDER[j];
  }
  </script>
</head>
<body class="bg-gray-50 p-4">

  <!-- Back to Dashboard -->
  <div class="mb-4">
    <a href="../schoolerp.html" class="text-indigo-600 hover:underline flex items-center gap-2 mb-4">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
  </div>

  <!-- Students List Content -->
  <div class="bg-white rounded-lg shadow p-4">
    <h3 class="font-medium text-gray-800">Student List</h3>
    <p class="text-sm text-gray-500 mb-1">Filter by class and download the list.</p>
    <p class="text-xs text-slate-600 mb-3" id="currentSchoolLabel"></p>

    <div id="somapYearWrap" style="display:flex;gap:.5rem;align-items:center;margin-bottom:1rem;">
      <label class="text-xs font-semibold">Academic Year</label>
      <select data-somap-year-select class="border rounded px-2 py-1 text-sm"></select>
      <span class="text-xs text-slate-600">Working year: <b id="somapYearHint">--</b></span>
    </div>

    <!-- Student Count Card -->
    <div id="studentCountCard" class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-lg shadow-lg p-6 mb-4 text-white" style="display:none;">
      <h4 class="text-lg font-semibold mb-4">Student Statistics</h4>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Total Students</div>
          <div class="text-2xl font-bold" id="countTotal">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Boys</div>
          <div class="text-2xl font-bold" id="countBoys">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Girls</div>
          <div class="text-2xl font-bold" id="countGirls">0</div>
        </div>
        <div class="bg-white/20 rounded-lg p-4 backdrop-blur-sm">
          <div class="text-sm opacity-90 mb-1">Current Class Filter</div>
          <div class="text-lg font-semibold" id="countClassFilter">All Classes</div>
        </div>
      </div>
    </div>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="student-list-class" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="">All Classes</option>
        <option>Baby Class</option>
        <option>Middle Class</option>
        <option>Pre Unit Class</option>
        <option>Class 1</option>
        <option>Class 2</option>
        <option>Class 3</option>
        <option>Class 4</option>
        <option>Class 5</option>
        <option>Class 6</option>
        <option>Class 7</option>
      </select>

      <div class="ml-auto flex gap-2">
        <button id="downloadCsvBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="downloadPdfBtn" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="student-list-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Date of Registration</th>
            <th>Passport Photo</th>
            <th>Parent Contact</th>
            <th>Fee Total</th>
            <th>Paid Amount</th>
            <th>Debt</th>
            <th>Payment Plan</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody id="studentListBody">
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">School Reports</h3>
    <p class="text-sm text-gray-500 mb-3">Download reports per school, class, month, term, year.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="school-report-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-school">Per School</option>
        <option value="per-class">Per Class</option>
        <option value="per-month">Per Month</option>
        <option value="per-term">Per Term</option>
        <option value="per-year">Per Year</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="schoolDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="schoolDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="school-report-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="schoolReportBody"></tbody>
      </table>
    </div>

    <hr class="my-6">

    <h3 class="font-medium text-gray-800 mt-4">Report Forms</h3>
    <p class="text-sm text-gray-500 mb-3">Download report forms with student details.</p>

    <div class="mb-3 md:flex md:items-center md:gap-3">
      <select id="report-form-type" class="w-full md:w-1/3 p-2 border rounded-lg mb-2 md:mb-0">
        <option value="per-student">Per Student</option>
        <option value="per-class">Per Class</option>
        <option value="per-term">Per Term</option>
      </select>
      <div class="ml-auto flex gap-2">
        <button id="reportDownloadCsv" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-csv"></i> Download CSV
        </button>
        <button id="reportDownloadPdf" class="py-2 px-4 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
          <i class="fa-solid fa-file-pdf"></i> Download PDF
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="report-form-table" class="min-w-full text-sm">
        <thead>
          <tr>
            <th>Admission No</th>
            <th>Full Name</th>
            <th>Class</th>
            <th>Parents Contact</th>
            <th>Fee Per Year</th>
            <th>Paid Amount</th>
            <th>Debt</th>
          </tr>
        </thead>
        <tbody id="reportFormBody"></tbody>
      </table>
    </div>
  </div>

   <!-- Third-party libraries (CSV + PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDKs (compat) + your config -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script> <!-- Adjusted path to firebase.js in root -->

  <!-- Students List Logic -->
  <script type="module">
    import { resolveEffectiveFinance, readPlan } from '../js/financeplans.js';

    document.addEventListener('DOMContentLoaded', () => {
      const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
      if (!db) {
        console.error('Firebase Realtime Database not available. Ensure ../firebase.js and Firebase SDKs are loaded.');
        return;
      }

      const school = window.SOMAP?.getSchool?.();
      if (!school || !school.id) {
        window.location.href = '../somapappv1multischool/multischool.html';
        return;
      }
      if (!window.SOMAP?.P) {
        console.error('Missing SOMAP path helper; redirecting to school selector.');
        window.location.href = '../somapappv1multischool/multischool.html';
        return;
      }
      window.currentSchoolId = school.id;
      const schoolRef = (subPath) => db.ref(window.SOMAP.P(subPath));
      const isSocrates = school.id === 'socrates-school';
      const schoolLabel = document.getElementById('currentSchoolLabel');
      if (schoolLabel) {
        const schoolName = school.name || school.id;
        schoolLabel.textContent = `Current school: ${schoolName}`;
      }

      const pickRefWithLegacy = async (scopedSubPath, legacyPath) => {
        const scopedRef = schoolRef(scopedSubPath);
        if (!isSocrates || !legacyPath) return scopedRef;
        try {
          const snap = await scopedRef.get();
          if (snap.exists()) return scopedRef;
        } catch (err) {
          console.warn('Scoped read failed; falling back to legacy path.', err);
        }
        return db.ref(legacyPath);
      };

      const mergeSnapshots = (scopedSnap, legacySnap) => {
        if (!isSocrates) return scopedSnap?.val?.() || {};
        const scopedVal = scopedSnap && scopedSnap.exists() ? (scopedSnap.val() || {}) : {};
        const legacyVal = legacySnap && legacySnap.exists() ? (legacySnap.val() || {}) : {};
        return { ...legacyVal, ...scopedVal };
      };

      const elements = {
        listBody: document.getElementById('studentListBody'),
        schoolReportBody: document.getElementById('schoolReportBody'),
        reportFormBody: document.getElementById('reportFormBody'),
        classFilter: document.getElementById('student-list-class'),
        downloadCsvBtn: document.getElementById('downloadCsvBtn'),
        downloadPdfBtn: document.getElementById('downloadPdfBtn'),
        schoolDownloadCsv: document.getElementById('schoolDownloadCsv'),
        schoolDownloadPdf: document.getElementById('schoolDownloadPdf'),
        reportDownloadCsv: document.getElementById('reportDownloadCsv'),
        reportDownloadPdf: document.getElementById('reportDownloadPdf'),
      };

      const currencyFormatter = new Intl.NumberFormat('en-US', { minimumFractionDigits: 0 });
      const fmtCurrency = (value) => `TSh ${currencyFormatter.format(Number(value) || 0)}`;
      const normalize = (value) => String(value || '').trim().toLowerCase();
      const yearSelect = document.querySelector('[data-somap-year-select]');
      const yearHint = document.getElementById('somapYearHint');
      const getWorkingYear = () => {
        const fromCtx = window.somapYearContext?.getSelectedYear?.();
        return String(fromCtx || SOMAP_DEFAULT_YEAR);
      };
      if (yearSelect && window.somapYearContext?.attachYearDropdown) {
        window.somapYearContext.attachYearDropdown(yearSelect);
      }

      const state = {
        students: new Map(),
        scopedStudents: new Map(),
        legacyStudents: new Map(),
        anchorEnrollments: {},
        yearEnrollments: {},
        yearStudentIndex: {},
        ledger: {},
        planCache: new Map(),
        latestRecords: [],
        latestYear: getWorkingYear(),
        renderToken: 0,
        yearEnrollRef: null,
        legacyYearEnrollRef: null,
        yearStudentsRef: null,
        anchorEnrollRef: null,
        legacyAnchorEnrollRef: null,
        ledgerRef: null,
        legacyLedgerRef: null,
        studentsRef: null,
        legacyStudentsRef: null,
      };
      const queueRender = () => {
        renderAllTables().catch((err) => console.error('Render error', err));
      };
      const updateYearUI = (year) => {
        const yearStr = String(year || SOMAP_DEFAULT_YEAR);
        if (yearHint) yearHint.textContent = yearStr;
        if (yearSelect && yearSelect.value !== yearStr) yearSelect.value = yearStr;
      };
      window.somapYearContext?.onYearChanged?.(async (year) => {
        const yearStr = String(year || SOMAP_DEFAULT_YEAR);
        updateYearUI(yearStr);
        state.planCache.clear();
        await attachYearListeners(yearStr);
        state.latestYear = yearStr;
        queueRender();
      });
      updateYearUI(getWorkingYear());
      if (!state.yearEnrollRef) {
        attachYearListeners(getWorkingYear()).catch((err) => console.error('Year listener attach failed', err));
      }

      function resolveClassForYear(studentId, fallbackClass, year) {
        const override = state.yearEnrollments[studentId] || {};
        if (override && (override.className || override.classLevel)) {
          return override.className || override.classLevel;
        }
        const anchor = state.anchorEnrollments[studentId] || {};
        const baseClass = anchor.className || anchor.classLevel || fallbackClass || '';
        const delta = Number(year) - SOMAP_DEFAULT_YEAR;
        return shiftClass(baseClass, delta);
      }

      async function planLabelFor(planId, year) {
        if (!planId) return '';
        const key = `${year}::${planId}`;
        if (state.planCache.has(key)) return state.planCache.get(key);
        try {
          const plan = await readPlan(planId, { year });
          const label = plan?.name || planId;
          state.planCache.set(key, label);
          return label;
        } catch (err) {
          console.warn('Plan lookup failed', planId, err);
          return planId;
        }
      }

      function sumPayments(ledgerEntry) {
        if (!ledgerEntry || typeof ledgerEntry !== 'object') return 0;
        const source = ledgerEntry.payments || ledgerEntry.entries || ledgerEntry.records || ledgerEntry;
        return Object.values(source || {}).reduce((total, entry) => {
          const amount = Number(entry?.amount ?? entry?.value ?? entry?.paid ?? entry?.total ?? 0);
          return Number.isFinite(amount) && amount > 0 ? total + amount : total;
        }, 0);
      }

      function escapeHtml(text) {
        if (text === undefined || text === null) return '';
        return String(text).replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
      }

      async function attachYearListeners(year) {
        const yearStr = String(year);
        if (state.yearEnrollRef) state.yearEnrollRef.off();
        if (state.ledgerRef) state.ledgerRef.off();
        if (state.yearStudentsRef) state.yearStudentsRef.off();

        const scopedYearEnrollRef = schoolRef(`enrollments/${yearStr}`);
        const legacyYearEnrollRef = isSocrates ? db.ref(`enrollments/${yearStr}`) : null;
        if (state.yearEnrollRef) state.yearEnrollRef.off();
        if (state.legacyYearEnrollRef) state.legacyYearEnrollRef.off();
        state.yearEnrollRef = scopedYearEnrollRef;
        state.legacyYearEnrollRef = legacyYearEnrollRef;
        state.yearEnrollRef.on('value', (snap) => {
          state.yearEnrollRef._lastSnap = snap;
          state.yearEnrollments = mergeSnapshots(snap, state.legacyYearEnrollRef?._lastSnap);
          queueRender();
        });
        if (state.legacyYearEnrollRef) {
          state.legacyYearEnrollRef.on('value', (snap) => {
            state.legacyYearEnrollRef._lastSnap = snap;
            state.yearEnrollments = mergeSnapshots(state.yearEnrollRef?._lastSnap, snap);
            queueRender();
          });
        }

        const scopedLedgerRef = schoolRef(`financeLedgers/${yearStr}`);
        const legacyLedgerRef = isSocrates ? db.ref(`financeLedgers/${yearStr}`) : null;
        if (state.ledgerRef) state.ledgerRef.off();
        if (state.legacyLedgerRef) state.legacyLedgerRef.off();
        state.ledgerRef = scopedLedgerRef;
        state.legacyLedgerRef = legacyLedgerRef;
        state.ledgerRef.on('value', (snap) => {
          state.ledgerRef._lastSnap = snap;
          state.ledger = mergeSnapshots(snap, state.legacyLedgerRef?._lastSnap);
          queueRender();
        });
        if (state.legacyLedgerRef) {
          state.legacyLedgerRef.on('value', (snap) => {
            state.legacyLedgerRef._lastSnap = snap;
            state.ledger = mergeSnapshots(state.ledgerRef?._lastSnap, snap);
            queueRender();
          });
        }

        // Year student index (scoped only)
        state.yearStudentsRef = schoolRef(`years/${yearStr}/students`);
        state.yearStudentsRef.on('value', (snap) => {
          state.yearStudentIndex = snap.val() || {};
          queueRender();
        });
      }

      (async () => {
        try {
          const scopedRef = schoolRef('students');
          const legacyRef = isSocrates ? db.ref('students') : null;
          if (state.studentsRef) state.studentsRef.off();
          if (state.legacyStudentsRef) state.legacyStudentsRef.off();
          state.studentsRef = scopedRef;
          state.legacyStudentsRef = legacyRef;
          const rebuildMerged = () => {
            const merged = mergeSnapshots(state.studentsRef?._lastSnap, state.legacyStudentsRef?._lastSnap);
            state.students.clear();
            Object.entries(merged).forEach(([key, value]) => {
              state.students.set(key, { key, ...(value || {}) });
            });
            queueRender();
          };
          state.studentsRef.on('value', (snapshot) => {
            state.studentsRef._lastSnap = snapshot;
            state.scopedStudents.clear();
            Object.entries(snapshot.val() || {}).forEach(([key, value]) => {
              state.scopedStudents.set(key, { key, ...(value || {}) });
            });
            rebuildMerged();
          });
          if (state.legacyStudentsRef) {
            state.legacyStudentsRef.on('value', (snapshot) => {
              state.legacyStudentsRef._lastSnap = snapshot;
              state.legacyStudents.clear();
              Object.entries(snapshot.val() || {}).forEach(([key, value]) => {
                state.legacyStudents.set(key, { key, ...(value || {}), _legacy: true });
              });
              rebuildMerged();
            });
          }
        } catch (err) {
          console.error('Failed to attach students listener', err);
        }
      })();

      (async () => {
        try {
          const scopedAnchorRef = schoolRef(`enrollments/${SOMAP_DEFAULT_YEAR}`);
          const legacyAnchorRef = isSocrates ? db.ref(`enrollments/${SOMAP_DEFAULT_YEAR}`) : null;
          if (state.anchorEnrollRef) state.anchorEnrollRef.off();
          if (state.legacyAnchorEnrollRef) state.legacyAnchorEnrollRef.off();
          state.anchorEnrollRef = scopedAnchorRef;
          state.legacyAnchorEnrollRef = legacyAnchorRef;
          const updateAnchor = () => {
            state.anchorEnrollments = mergeSnapshots(state.anchorEnrollRef?._lastSnap, state.legacyAnchorEnrollRef?._lastSnap);
            queueRender();
          };
          state.anchorEnrollRef.on('value', (snapshot) => {
            state.anchorEnrollRef._lastSnap = snapshot;
            updateAnchor();
          });
          if (state.legacyAnchorEnrollRef) {
            state.legacyAnchorEnrollRef.on('value', (snapshot) => {
              state.legacyAnchorEnrollRef._lastSnap = snapshot;
              updateAnchor();
            });
          }
        } catch (err) {
          console.error('Failed to attach anchor enrollment listener', err);
        }
      })();

      if (elements.classFilter) {
        elements.classFilter.addEventListener('change', queueRender);
      }

      [
        [elements.downloadCsvBtn, () => downloadCSV('student-list')],
        [elements.downloadPdfBtn, () => downloadPDF('student-list')],
        [elements.schoolDownloadCsv, () => downloadCSV('school-reports')],
        [elements.schoolDownloadPdf, () => downloadPDF('school-reports')],
        [elements.reportDownloadCsv, () => downloadCSV('report-forms')],
        [elements.reportDownloadPdf, () => downloadPDF('report-forms')],
      ].forEach(([btn, handler]) => {
        if (btn) btn.addEventListener('click', handler);
      });

      queueRender();

      async function renderAllTables() {
        const listBody = elements.listBody;
        const schoolReportBody = elements.schoolReportBody;
        const reportFormBody = elements.reportFormBody;
        if (!listBody || !schoolReportBody || !reportFormBody) return;

        const year = getWorkingYear();
        state.latestYear = year;
        const generation = ++state.renderToken;

        const studentsArray = Array.from(state.students.values());
        const legacyArray = Array.from(state.legacyStudents.values());
        const scopedArray = Array.from(state.scopedStudents.values());
        const hasIndex = state.yearStudentIndex && Object.keys(state.yearStudentIndex).length > 0;
        const scopedInYear = hasIndex ? scopedArray.filter((stu) => state.yearStudentIndex[stu.key]) : scopedArray;
        const visibleStudents = hasIndex
          ? (isSocrates ? scopedInYear.concat(legacyArray) : scopedInYear)
          : (isSocrates ? legacyArray : []);
        const records = await Promise.all(visibleStudents.map(async (stu) => {
          const fallbackClass = stu.classLevel || stu.className || '';
          const resolvedClass = resolveClassForYear(stu.key, fallbackClass, year) || fallbackClass || 'N/A';
          const anchorClass = state.anchorEnrollments[stu.key]?.className || state.anchorEnrollments[stu.key]?.classLevel || fallbackClass;
          let finance = { fee: 0, planId: null, feeOverride: null };
          try {
            finance = await resolveEffectiveFinance(stu.key, resolvedClass, { anchorClass, year });
          } catch (err) {
            console.error('resolveEffectiveFinance error', stu.key, err);
          }
          const planLabel = await planLabelFor(finance.planId, year);
          const ledgerEntry = state.ledger?.[stu.key] || {};
          const paidAmount = sumPayments(ledgerEntry);
          const feeValue = Number(finance.fee || 0);
          const debtAmount = Math.max(0, feeValue - paidAmount);
          const fullName = `${stu.firstName || ''} ${stu.middleName || ''} ${stu.lastName || ''}`.replace(/\s+/g, ' ').trim();
          const registrationDate = stu.timestamp
            ? new Date(stu.timestamp).toLocaleDateString()
            : (stu.createdAt ? new Date(stu.createdAt).toLocaleDateString() : 'N/A');
          const photoURL = stu.passportPhotoUrl || stu.passportPhotoURL || 'https://via.placeholder.com/50';
          const isOverrideLocked = finance.feeOverride && (finance.feeOverride.locked !== false);
          const feeSource = isOverrideLocked ? 'Override' : 'Class default';
          return {
            key: stu.key,
            admissionNo: stu.admissionNumber || 'N/A',
            fullName: fullName || 'N/A',
            classLabel: resolvedClass === 'GRADUATED' ? `Graduated (${year})` : resolvedClass,
            rawClass: resolvedClass,
            registrationDate,
            photoURL,
            contact: stu.primaryParentContact || 'N/A',
            fee: feeValue,
            paid: paidAmount,
            debt: debtAmount,
            planId: finance.planId || null,
            planLabel,
            isGraduated: resolvedClass === 'GRADUATED',
            feeSource,
            gender: stu.gender || stu.sex || '',
          };
        }));

        if (generation !== state.renderToken) return;

        state.latestRecords = records;

        const filterValue = elements.classFilter ? elements.classFilter.value || '' : '';
        const filteredRecords = records.filter((rec) => {
          if (rec.isGraduated) return false;
          if (!filterValue) return true;
          return normalize(rec.classLabel) === normalize(filterValue);
        });

        // Update student count card
        const activeRecordsForCount = records.filter((rec) => !rec.isGraduated);
        let boysCount = 0;
        let girlsCount = 0;
        
        // Count boys and girls from filtered records (or all if no filter)
        const recordsToCount = filterValue ? filteredRecords : activeRecordsForCount;
        recordsToCount.forEach((rec) => {
          // Get gender from the record (already included when building records)
          const gender = String(rec.gender || '').trim().toLowerCase();
          if (gender.startsWith('m')) boysCount++;
          else if (gender.startsWith('f')) girlsCount++;
        });

        // Update count card display
        const countCard = document.getElementById('studentCountCard');
        const countTotal = document.getElementById('countTotal');
        const countBoys = document.getElementById('countBoys');
        const countGirls = document.getElementById('countGirls');
        const countClassFilter = document.getElementById('countClassFilter');
        
        if (countCard && countTotal && countBoys && countGirls && countClassFilter) {
          countCard.style.display = 'block';
          if (filterValue) {
            // When a class is selected, show count for that class
            countTotal.textContent = filteredRecords.length;
            countClassFilter.textContent = filterValue;
          } else {
            // When showing all classes, show total count
            countTotal.textContent = activeRecordsForCount.length;
            countClassFilter.textContent = 'All Classes';
          }
          countBoys.textContent = boysCount;
          countGirls.textContent = girlsCount;
        }

        const buildRow = (rec) => `
  <td>${escapeHtml(rec.admissionNo)}</td>
  <td>${escapeHtml(rec.fullName)}</td>
  <td>${escapeHtml(rec.classLabel)}</td>
  <td>${escapeHtml(rec.registrationDate)}</td>
  <td><img src="${escapeHtml(rec.photoURL)}" alt="photo" style="width:50px;height:50px;object-fit:cover;border-radius:4px"/></td>
  <td>${escapeHtml(rec.contact)}</td>
  <td>${escapeHtml(fmtCurrency(rec.fee))}</td>
  <td>${escapeHtml(fmtCurrency(rec.paid))}</td>
  <td>${escapeHtml(fmtCurrency(rec.debt))}</td>
  <td>${escapeHtml(rec.planLabel || rec.planId || 'Class default')}</td>
  <td>
    <a href="generateid.html?key=${encodeURIComponent(rec.key)}" target="_blank"
       class="py-1 px-2 border rounded text-indigo-600 inline-block" title="Open details & generate ID">
      <i class="fas fa-eye"></i>
    </a>
  </td>
`;

        listBody.innerHTML = '';
        if (!filteredRecords.length) {
          listBody.innerHTML = `<tr><td colspan="11" class="text-center text-sm text-slate-500 py-4">No students for ${escapeHtml(String(year))} yet.</td></tr>`;
        } else {
          filteredRecords.forEach((rec) => {
            const tr = document.createElement('tr');
            tr.innerHTML = buildRow(rec);
            listBody.appendChild(tr);
          });
        }

        const simpleRow = (rec) => `
          <td>${escapeHtml(rec.admissionNo)}</td>
          <td>${escapeHtml(rec.fullName)}</td>
          <td>${escapeHtml(rec.classLabel)}</td>
          <td>${escapeHtml(rec.contact)}</td>
          <td>${escapeHtml(fmtCurrency(rec.fee))}</td>
          <td>${escapeHtml(fmtCurrency(rec.paid))}</td>
          <td>${escapeHtml(fmtCurrency(rec.debt))}</td>
        `;

        const activeRecords = records.filter((rec) => !rec.isGraduated);

        [schoolReportBody, reportFormBody].forEach((tbody) => {
          tbody.innerHTML = '';
          if (!activeRecords.length) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-sm text-slate-500 py-4">No student data for ${escapeHtml(String(year))}.</td></tr>`;
          } else {
            activeRecords.forEach((rec) => {
              const tr = document.createElement('tr');
              tr.innerHTML = simpleRow(rec);
              tbody.appendChild(tr);
            });
          }
        });
      }

      function getRecordsForExport(kind) {
        const year = state.latestYear || getWorkingYear();
        const filterValue = elements.classFilter ? elements.classFilter.value || '' : '';
        let records = state.latestRecords.filter((rec) => !rec.isGraduated);
        if (!records.length) return { year, records: [] };
        if (kind === 'student-list' && filterValue) {
          records = records.filter((rec) => normalize(rec.classLabel) === normalize(filterValue));
        }
        return { year, records };
      }

      function downloadCSV(kind) {
        const { year, records } = getRecordsForExport(kind);
        if (!records.length) {
          alert('No data to download for the selected year.');
          return;
        }
        if (!window.Papa) {
          alert('CSV library not loaded.');
          return;
        }
        const rows = records.map((rec) => ({
          'Admission No': rec.admissionNo,
          'Full Name': rec.fullName,
          'Class': rec.classLabel,
          'Date of Registration': rec.registrationDate,
          'Parent Contact': rec.contact,
          'Fee Total': rec.fee,
          'Paid Amount': rec.paid,
          'Debt': rec.debt,
          'Payment Plan': rec.planLabel || rec.planId || 'Class default',
          'Fee Source': rec.feeSource,
        }));
        const csv = window.Papa.unparse(rows);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${kind}_${year}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function downloadPDF(kind) {
        const { year, records } = getRecordsForExport(kind);
        if (!records.length) {
          alert('No data to download for the selected year.');
          return;
        }
        const jsPDFLib = window.jspdf?.jsPDF;
        if (!jsPDFLib) {
          alert('jsPDF not loaded');
          return;
        }
        const doc = new jsPDFLib({ orientation: 'landscape' });
        doc.setFontSize(14);
        doc.text(`${kind.replace('-', ' ')} Report (${year})`, 14, 10);
        const body = records.map((rec) => [
          rec.admissionNo,
          rec.fullName,
          rec.classLabel,
          rec.registrationDate,
          rec.contact,
          fmtCurrency(rec.fee),
          fmtCurrency(rec.paid),
          fmtCurrency(rec.debt),
          rec.planLabel || rec.planId || 'Class default',
        ]);
        doc.autoTable({
          head: [['Admission No','Full Name','Class','Date of Registration','Parent Contact','Fee Total','Paid Amount','Debt','Payment Plan']],
          body,
          startY: 18,
          styles: { fontSize: 8 },
        });
        doc.save(`${kind}_${year}.pdf`);
      }
    });
  </script>
</body>
</html>
