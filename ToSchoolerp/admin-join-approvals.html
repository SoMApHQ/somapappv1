<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SoMAp — Join Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body {
      background: #f8fafc;
      font-family: Inter, system-ui, Arial;
    }
    .card {
      background: white;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
    }
  </style>
</head>

<body class="p-4 md:p-8">

  <!-- HEADER -->
  <div class="mb-6 flex justify-between items-center">
    <h1 class="text-2xl font-bold text-slate-800">
      Join Requests (Pending Approval)
    </h1>
    <a href="admission.html"
       class="text-indigo-600 hover:underline flex items-center gap-2">
      <i class="fas fa-arrow-left"></i> Back to Admissions
    </a>
  </div>

  <!-- LIST -->
  <div id="approvalsList" class="space-y-4">
    <p class="text-slate-500">Loading join requests…</p>
  </div>

  <script>
    /* ---------------- Firebase Init ---------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    const db = firebase.database();
    const listEl = document.getElementById("approvalsList");

    /* ---------------- Helpers ---------------- */
    function esc(v) {
      return String(v || "").replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;",
        '"': "&quot;", "'": "&#039;"
      }[m]));
    }

    /* ---------------- Load Join Requests ---------------- */
    db.ref("joinApprovalsPending").on("value", snap => {
      const data = snap.val() || {};
      listEl.innerHTML = "";

      const entries = Object.entries(data).filter(([_, r]) =>
        r &&
        r.approvalType === "JOIN_REQUEST" &&
        r.status === "pending"
      );

      if (!entries.length) {
        listEl.innerHTML = `
          <div class="text-slate-500">
            No pending join requests.
          </div>
        `;
        return;
      }

      entries.forEach(([id, r]) => {
        const student = r.studentSnapshot || {};
        const parent = r.parentSnapshot || {};
        const docs = r.documents || {};
        const referral = r.referral || null;

        listEl.innerHTML += `
          <div class="card p-4">
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-semibold text-lg">
                  ${esc(student.firstName)} ${esc(student.lastName)}
                </h3>
                <p class="text-sm text-slate-600">
                  Class: <b>${esc(student.classLevel)}</b>
                </p>
                <p class="text-sm text-slate-600">
                  Academic Year: ${esc(r.academicYear)}
                </p>
                <p class="text-sm text-slate-600">
                  Parent: ${esc(parent.name)} (${esc(parent.phone)})
                </p>

                ${
                  referral?.code
                    ? `<p class="text-xs mt-1 text-indigo-600">
                         <i class="fas fa-link mr-1"></i>
                         Referred (Code: ${esc(referral.code)})
                       </p>`
                    : `<p class="text-xs mt-1 text-slate-400 italic">
                         Direct / Public Join
                       </p>`
                }
              </div>

              <div class="flex gap-2">
                <button
                  class="px-3 py-1 text-sm rounded bg-green-600 text-white"
                  onclick="approveRequest('${id}')">
                  Approve
                </button>
                <button
                  class="px-3 py-1 text-sm rounded bg-red-600 text-white"
                  onclick="rejectRequest('${id}')">
                  Reject
                </button>
              </div>
            </div>

            <div class="mt-3 text-sm">
              <b>Documents:</b>
              <div class="flex flex-wrap gap-3 mt-1">
                ${docs.passportPhotoUrl ? `<a href="${docs.passportPhotoUrl}" target="_blank" class="text-indigo-600 underline">Passport</a>` : ""}
                ${docs.birthCertUrl ? `<a href="${docs.birthCertUrl}" target="_blank" class="text-indigo-600 underline">Birth Cert</a>` : ""}
                ${docs.reportCardUrl ? `<a href="${docs.reportCardUrl}" target="_blank" class="text-indigo-600 underline">Report Card</a>` : ""}
                ${docs.joiningLetterUrl ? `<a href="${docs.joiningLetterUrl}" target="_blank" class="text-indigo-600 underline">Joining Letter</a>` : ""}
                ${docs.medicalDocsUrl ? `<a href="${docs.medicalDocsUrl}" target="_blank" class="text-indigo-600 underline">Medical</a>` : ""}
              </div>
            </div>
          </div>
        `;
      });
    });

    /* ---------------- Actions ---------------- */

    async function approveRequest(id) {
      const confirm = await Swal.fire({
        title: "Approve join request?",
        text: "This will open the admission form with details pre-filled.",
        icon: "question",
        showCancelButton: true,
        confirmButtonText: "Approve & Continue",
      });

      if (!confirm.isConfirmed) return;

      const snap = await db.ref(`joinApprovalsPending/${id}`).once("value");
      if (!snap.exists()) return;

      const r = snap.val();

      // Store data temporarily for admission.html
      sessionStorage.setItem(
        "somap_pending_admission",
        JSON.stringify({
          approvalKey: id,
          student: r.studentSnapshot,
          parent: r.parentSnapshot,
          academicYear: r.academicYear,
          referral: r.referral || null
        })
      );

      // Mark approved-for-admission
      await db.ref(`joinApprovalsPending/${id}`).update({
        status: "approved_for_admission",
        approvedAt: Date.now(),
      });

      // Redirect to admission page
      window.location.href = "admission.html?from=joinApproval";
    }

    async function rejectRequest(id) {
      const ok = await Swal.fire({
        title: "Reject join request?",
        input: "text",
        inputLabel: "Reason (optional)",
        showCancelButton: true,
        confirmButtonText: "Reject",
      });

      if (!ok.isConfirmed) return;

      await db.ref(`joinApprovalsPending/${id}`).update({
        status: "rejected",
        rejectionReason: ok.value || null,
        rejectedAt: Date.now(),
      });

      Swal.fire("Rejected", "Request rejected.", "success");
    }
  </script>
</body>
</html>
