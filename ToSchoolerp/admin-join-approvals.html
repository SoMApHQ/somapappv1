<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SoMAp — Admissions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons -->
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- Alerts -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background:#f8fafc; font-family:Inter,system-ui,Arial }
    .card { background:white; border-radius:.75rem; border:1px solid #e5e7eb }
  </style>
</head>

<body class="p-6">

<!-- ================= HEADER ================= -->
<div class="mb-6">
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-slate-800">Admissions</h1>
    <a href="admission.html"
      class="text-indigo-600 hover:underline flex items-center gap-2">
      <i class="fas fa-arrow-left"></i> Back to Admissions
    </a>
  </div>

  <!-- Tabs -->
  <div class="mt-4 flex gap-6 border-b">
    <button id="tabPending"
      class="pb-2 border-b-2 border-indigo-600 text-indigo-600 font-medium">
      Awaiting Approval
    </button>
    <button id="tabAdmitted"
      class="pb-2 text-slate-500 hover:text-slate-800">
      Admitted
    </button>
  </div>
</div>

<!-- ================= PENDING VIEW ================= -->
<div id="pendingView">
  <div id="approvalsList" class="space-y-4">
    <p class="text-slate-500">Loading join requests…</p>
  </div>
</div>

<!-- ================= ADMITTED VIEW ================= -->
<div id="admittedView" class="hidden">

  <div class="card p-4 mb-4">
    <div class="flex flex-wrap gap-3 items-end">

      <div>
        <label class="text-xs text-slate-500">Referral Code</label>
        <select id="filterReferral"
          class="border rounded px-2 py-1 text-sm">
          <option value="">All</option>
        </select>
      </div>

      <div>
        <label class="text-xs text-slate-500">From Date</label>
        <input type="date" id="filterFrom"
          class="border rounded px-2 py-1 text-sm">
      </div>

      <div>
        <label class="text-xs text-slate-500">To Date</label>
        <input type="date" id="filterTo"
          class="border rounded px-2 py-1 text-sm">
      </div>

      <div class="ml-auto flex gap-2">
        <button onclick="exportCSV()"
          class="px-3 py-1 bg-slate-800 text-white rounded text-sm">
          Export CSV
        </button>
      </div>

    </div>
  </div>

  <div class="card overflow-x-auto">
    <table class="w-full text-sm">
      <thead class="bg-slate-100 border-b">
        <tr>
          <th class="p-2 text-left">Name</th>
          <th class="p-2">Class</th>
          <th class="p-2">Parent</th>
          <th class="p-2">Referral</th>
          <th class="p-2">Joined</th>
        </tr>
      </thead>
      <tbody id="admittedTable"></tbody>
    </table>
  </div>

</div>

<!-- ================= SCRIPTS ================= -->
<script>
/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
  authDomain: "somaptestt.firebaseapp.com",
  databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
  projectId: "somaptestt",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------- Helpers ---------- */
function esc(v){return String(v||"").replace(/[&<>"']/g,m=>(
{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m]))}

const pendingView = document.getElementById("pendingView");
const admittedView = document.getElementById("admittedView");
const tabPending = document.getElementById("tabPending");
const tabAdmitted = document.getElementById("tabAdmitted");

tabPending.onclick = () => {
  pendingView.classList.remove("hidden");
  admittedView.classList.add("hidden");
};
tabAdmitted.onclick = () => {
  admittedView.classList.remove("hidden");
  pendingView.classList.add("hidden");
  loadAdmitted();
};

/* ---------- PENDING (UNCHANGED LOGIC) ---------- */
db.ref("joinApprovalsPending").on("value", snap => {
  const list = document.getElementById("approvalsList");
  list.innerHTML = "";
  Object.entries(snap.val()||{}).forEach(([id,r])=>{
    if(r.status!=="pending") return;
    list.innerHTML += `
      <div class="card p-4">
        <b>${esc(r.studentSnapshot.firstName)} ${esc(r.studentSnapshot.lastName)}</b>
        <div class="text-sm text-slate-600">
          Class ${esc(r.studentSnapshot.classLevel)} •
          ${r.referral?.code ? "Referral "+esc(r.referral.code) : "Direct"}
        </div>
      </div>`;
  });
});

/* ---------- ADMITTED ---------- */
let admittedCache = [];

function loadAdmitted(){
  db.ref("admittedStudents").once("value", snap=>{
    admittedCache = Object.values(snap.val()||{});
    populateReferralFilter();
    renderAdmitted();
  });
}

function populateReferralFilter(){
  const sel = document.getElementById("filterReferral");
  sel.innerHTML = `<option value="">All</option>`;
  [...new Set(admittedCache.map(r=>r.referral?.code).filter(Boolean))]
    .forEach(c=> sel.innerHTML += `<option>${c}</option>`);
}

document.querySelectorAll("#filterReferral,#filterFrom,#filterTo")
  .forEach(el=>el.onchange=renderAdmitted);

function renderAdmitted(){
  const ref = filterReferral.value;
  const from = filterFrom.value ? new Date(filterFrom.value).getTime() : 0;
  const to = filterTo.value ? new Date(filterTo.value).getTime()+86400000 : Infinity;

  const tbody = document.getElementById("admittedTable");
  tbody.innerHTML = "";

  admittedCache.filter(r=>{
    const t = r.joinedAt||0;
    return (!ref||r.referral?.code===ref) && t>=from && t<=to;
  }).forEach(r=>{
    tbody.innerHTML += `
      <tr class="border-t">
        <td class="p-2">${esc(r.student.firstName)} ${esc(r.student.lastName)}</td>
        <td class="p-2 text-center">${esc(r.student.classLevel)}</td>
        <td class="p-2">${esc(r.parent.name)}</td>
        <td class="p-2 text-indigo-600">${esc(r.referral?.code||"—")}</td>
        <td class="p-2 text-center">
          ${new Date(r.joinedAt).toLocaleDateString()}
        </td>
      </tr>`;
  });
}

/* ---------- CSV EXPORT (FILTERED) ---------- */
function exportCSV(){
  const rows=[["Name","Class","Parent","Referral","Joined"]];
  document.querySelectorAll("#admittedTable tr").forEach(tr=>{
    rows.push([...tr.children].map(td=>td.innerText));
  });
  const blob=new Blob([rows.map(r=>r.join(",")).join("\n")],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="admitted_students.csv";
  a.click();
}
</script>

</body>
</html>
