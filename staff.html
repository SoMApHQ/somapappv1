<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SoMApV2 - Teacher Command Center</title>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="firebase.js"></script>
    <script src="Todashboardhtml/yearContext.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
      :root {
        --glass-bg: rgba(15, 23, 42, 0.78);
        --glass-border: rgba(148, 163, 184, 0.28);
        --glass-shadow: 0 45px 90px -42px rgba(2, 6, 23, 0.85);
        --glass-card-hover: rgba(99, 102, 241, 0.25);
        --brand-primary: #6366f1;
        --brand-secondary: #22d3ee;
        --brand-accent: #f59e0b;
        --success: #34d399;
        --danger: #f87171;
        --text-primary: #e2e8f0;
        --text-muted: rgba(148, 163, 184, 0.78);
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
        color: var(--text-primary);
        background: radial-gradient(
            1400px 900px at -10% -25%,
            rgba(14, 165, 233, 0.28),
            transparent 55%
          ),
          radial-gradient(
            1200px 800px at 110% -10%,
            rgba(99, 102, 241, 0.26),
            transparent 52%
          ),
          radial-gradient(
            1000px 900px at 50% 120%,
            rgba(20, 184, 166, 0.16),
            transparent 62%
          ),
          linear-gradient(180deg, #020617 0%, #0b1220 42%, #101b2f 100%);
        background-color: #020617;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        color-scheme: dark;
      }
      a {
        color: var(--brand-secondary);
      }
      .sidebar {
        position: fixed;
        inset: 0 auto 0 0;
        height: 100vh;
        width: 0;
        overflow: hidden;
        background: linear-gradient(
          200deg,
          rgba(2, 6, 23, 0.92),
          rgba(30, 58, 138, 0.58)
        );
        border-right: 1px solid rgba(30, 41, 59, 0.6);
        box-shadow: 20px 0 70px -40px rgba(2, 6, 23, 0.8);
        transition: width 0.35s ease;
        z-index: 70;
        backdrop-filter: blur(14px);
      }
      .sidebar.expanded {
        width: 280px;
      }
      .sidebar .item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        margin-bottom: 6px;
        color: rgba(226, 232, 240, 0.95);
        border-radius: 16px;
        border: 1px solid transparent;
        background: rgba(148, 163, 184, 0.08);
        transition: background 0.22s ease, transform 0.22s ease,
          border-color 0.22s ease;
        cursor: pointer;
      }
      .sidebar .item:hover {
        background: rgba(99, 102, 241, 0.24);
        border-color: rgba(99, 102, 241, 0.35);
        transform: translateX(6px);
      }
      .sidebar .item span {
        font-weight: 600;
        letter-spacing: 0.02em;
      }
      .sidebar .footer {
        margin-top: auto;
        padding: 18px;
        color: rgba(203, 213, 225, 0.72);
        font-size: 13px;
      }
      #menu-dots {
        position: fixed;
        top: 22px;
        left: 22px;
        z-index: 80;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 56px;
        height: 56px;
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.38);
        background: linear-gradient(
          135deg,
          rgba(30, 64, 175, 0.78),
          rgba(15, 118, 110, 0.7)
        );
        color: var(--text-primary);
        box-shadow: 0 18px 40px -20px rgba(15, 23, 42, 0.9);
        transition: transform 0.22s ease, box-shadow 0.22s ease;
      }
      #menu-dots:hover {
        transform: scale(1.06);
        box-shadow: 0 24px 55px -24px rgba(99, 102, 241, 0.55);
      }
      .main {
        transition: margin-left 0.35s ease;
        margin-left: 0;
        padding: 52px 32px 88px;
        min-height: 100vh;
        color: var(--text-primary);
      }
      .main.shifted {
        margin-left: 280px;
      }
      .glass-card {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        border-radius: 30px;
        box-shadow: var(--glass-shadow);
        backdrop-filter: blur(22px);
        color: var(--text-primary);
        position: relative;
        overflow: hidden;
      }
      .glass-card::before {
        content: "";
        position: absolute;
        inset: -40% auto auto -40%;
        width: 220px;
        height: 220px;
        background: radial-gradient(
          circle at center,
          rgba(99, 102, 241, 0.2),
          transparent 70%
        );
        opacity: 0.6;
        pointer-events: none;
      }
      .hero-card::after {
        content: "";
        position: absolute;
        inset: auto -18% -42% auto;
        width: 320px;
        height: 320px;
        background: radial-gradient(
          circle at center,
          rgba(34, 211, 238, 0.18),
          transparent 72%
        );
        opacity: 0.75;
        transform: rotate(24deg);
        pointer-events: none;
      }
      .metric-card {
        position: relative;
        padding: 26px;
        border-radius: 28px;
        background: linear-gradient(
          145deg,
          rgba(15, 23, 42, 0.92),
          rgba(30, 41, 59, 0.62)
        );
        border: 1px solid rgba(99, 102, 241, 0.22);
        transition: transform 0.2s ease, box-shadow 0.25s ease,
          border-color 0.22s ease;
        cursor: pointer;
      }
      .metric-card:hover {
        transform: translateY(-6px);
        border-color: rgba(99, 102, 241, 0.45);
        box-shadow: 0 28px 60px -32px rgba(99, 102, 241, 0.55);
      }
      .metric-card::after {
        content: "";
        position: absolute;
        inset: auto auto -130px -48px;
        width: 240px;
        height: 240px;
        background: radial-gradient(
          circle at center,
          rgba(79, 70, 229, 0.28),
          transparent 68%
        );
        pointer-events: none;
      }
      .metric-label {
        font-size: 13px;
        letter-spacing: 0.09em;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 700;
      }
      .metric-value {
        font-size: 38px;
        font-weight: 800;
        color: #f8fafc;
        text-shadow: 0 8px 32px rgba(15, 23, 42, 0.55);
      }
      .metric-sub {
        font-size: 14px;
        color: rgba(203, 213, 225, 0.78);
      }
      .quick-link {
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 20px;
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.22);
        background: rgba(15, 23, 42, 0.66);
        box-shadow: 0 25px 55px -30px rgba(2, 6, 23, 0.8);
        transition: transform 0.22s ease, box-shadow 0.22s ease,
          border-color 0.2s ease;
        cursor: pointer;
      }
      .quick-link:hover {
        transform: translateY(-5px);
        border-color: rgba(34, 211, 238, 0.35);
        box-shadow: 0 32px 68px -32px rgba(56, 189, 248, 0.45);
      }
      .quick-link .icon {
        width: 44px;
        height: 44px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        font-size: 18px;
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.8),
          rgba(34, 197, 94, 0.6)
        );
        color: #f8fafc;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.25);
        color: rgba(226, 232, 240, 0.95);
        font-weight: 700;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .tag {
        display: inline-flex;
        align-items: center;
        padding: 5px 12px;
        border-radius: 999px;
        font-size: 12px;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        background: rgba(14, 116, 144, 0.28);
        color: rgba(226, 232, 240, 0.9);
        font-weight: 600;
      }
      .slim-scroll {
        scrollbar-width: thin;
        scrollbar-color: rgba(148, 163, 184, 0.6) transparent;
      }
      .slim-scroll::-webkit-scrollbar {
        width: 6px;
      }
      .slim-scroll::-webkit-scrollbar-track {
        background: transparent;
      }
      .slim-scroll::-webkit-scrollbar-thumb {
        background-color: rgba(148, 163, 184, 0.6);
        border-radius: 999px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        color: inherit;
      }
      th {
        text-align: left;
        font-size: 12px;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: rgba(148, 163, 184, 0.75);
        padding-bottom: 12px;
      }
      td {
        padding: 12px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.22);
        font-size: 14px;
        color: rgba(226, 232, 240, 0.92);
      }
      tr:last-child td {
        border-bottom: none;
      }
      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 11px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.04em;
      }
      .status-pill.present {
        background: rgba(52, 211, 153, 0.22);
        color: rgba(226, 252, 240, 0.95);
      }
      .status-pill.absent {
        background: rgba(248, 113, 113, 0.22);
        color: rgba(254, 226, 226, 0.95);
      }
      .status-pill.special {
        background: rgba(251, 191, 36, 0.2);
        color: rgba(255, 237, 213, 0.95);
      }
      .alert-card {
        display: flex;
        gap: 16px;
        padding: 20px 24px;
        border-radius: 22px;
        border: 1px solid rgba(248, 113, 113, 0.32);
        background: linear-gradient(
          135deg,
          rgba(248, 113, 113, 0.24),
          rgba(127, 29, 29, 0.22)
        );
        box-shadow: 0 26px 60px -32px rgba(248, 113, 113, 0.45);
      }
      .alert-card + .alert-card {
        margin-top: 16px;
      }
      .alert-card .alert-type {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        font-size: 18px;
        font-weight: 700;
        background: rgba(254, 226, 226, 0.2);
        color: rgba(254, 226, 226, 0.95);
      }
      .empty-state {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px;
        border-radius: 20px;
        border: 1px dashed rgba(148, 163, 184, 0.45);
        color: rgba(148, 163, 184, 0.85);
        font-size: 14px;
        background: rgba(15, 23, 42, 0.6);
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(2, 6, 23, 0.72);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 90;
        padding: 20px;
        backdrop-filter: blur(12px);
      }
      .modal.show {
        display: flex;
      }
      .modal-card {
        background: rgba(15, 23, 42, 0.96);
        border-radius: 26px;
        border: 1px solid rgba(148, 163, 184, 0.28);
        box-shadow: 0 40px 70px -42px rgba(2, 6, 23, 0.85);
        max-width: 640px;
        width: 100%;
        padding: 30px;
        position: relative;
        color: var(--text-primary);
        backdrop-filter: blur(18px);
      }
      .close-btn {
        position: absolute;
        top: 20px;
        right: 22px;
        width: 38px;
        height: 38px;
        border-radius: 12px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        display: grid;
        place-items: center;
        font-size: 16px;
        cursor: pointer;
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.82),
          rgba(14, 165, 233, 0.76)
        );
        color: #f8fafc;
        box-shadow: 0 18px 36px -22px rgba(30, 64, 175, 0.65);
      }
      .toast {
        position: fixed;
        right: 24px;
        bottom: 24px;
        background: rgba(15, 23, 42, 0.94);
        color: rgba(226, 232, 240, 0.98);
        padding: 12px 18px;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.28);
        box-shadow: 0 18px 45px -26px rgba(2, 6, 23, 0.9);
        display: none;
        z-index: 95;
        font-size: 14px;
      }
      .responsibility-card {
        border-radius: 28px;
        border: 1px solid rgba(148, 163, 184, 0.36);
        background: linear-gradient(
          135deg,
          rgba(15, 23, 42, 0.9),
          rgba(30, 41, 59, 0.82)
        );
        color: rgba(226, 232, 240, 0.95);
        box-shadow: 0 32px 70px -38px rgba(2, 6, 23, 0.7);
      }
      .responsibility-card h2 {
        color: #f1f5f9;
      }
      .responsibility-card .task {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      }
      .responsibility-card .task:last-child {
        border-bottom: none;
      }
      .responsibility-card .task input {
        margin-top: 4px;
      }
      .responsibility-card .task label {
        font-size: 14px;
        line-height: 1.45;
        color: rgba(226, 232, 240, 0.9);
      }
      .responsibility-meta {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.2em;
        color: rgba(148, 163, 184, 0.75);
      }
      .responsibility-card .badge {
        background: rgba(99, 102, 241, 0.28);
        color: rgba(224, 231, 255, 0.92);
      }
      .dark-dashboard .text-slate-900,
      .dark-dashboard .text-slate-800 {
        color: #f8fafc !important;
      }
      .dark-dashboard .text-slate-700,
      .dark-dashboard .text-gray-700 {
        color: rgba(226, 232, 240, 0.9) !important;
      }
      .dark-dashboard .text-slate-500,
      .dark-dashboard .text-gray-500 {
        color: var(--text-muted) !important;
      }
      .dark-dashboard .text-slate-300 {
        color: rgba(203, 213, 225, 0.92) !important;
      }
      .dark-dashboard .bg-white,
      .dark-dashboard .bg-white\/70,
      .dark-dashboard .bg-white\/80,
      .dark-dashboard .bg-slate-50,
      .dark-dashboard [class*="bg-white/"] {
        background-color: rgba(15, 23, 42, 0.72) !important;
        color: var(--text-primary);
      }
      .dark-dashboard .border,
      .dark-dashboard .border-white\/60,
      .dark-dashboard .border-white\/70 {
        border-color: rgba(148, 163, 184, 0.28) !important;
      }
      .dark-dashboard .shadow,
      .dark-dashboard .shadow-lg {
        box-shadow: 0 25px 60px -32px rgba(2, 6, 23, 0.75) !important;
      }
      @media (max-width: 768px) {
        .main {
          padding: 110px 18px 80px;
        }
        .metric-card {
          padding: 22px;
          border-radius: 24px;
        }
        .metric-value {
          font-size: 32px;
        }
        .quick-link {
          flex-direction: row;
          align-items: center;
        }
        .quick-link .icon {
          width: 36px;
          height: 36px;
          border-radius: 12px;
        }
      }
    </style>
  </head>
  <body class="antialiased dark-dashboard">
    <button id="menu-dots" aria-label="Toggle navigation">
      <i class="fas fa-grip-vertical"></i>
    </button>

    <nav id="sidebar" class="sidebar" aria-hidden="true">
      <div class="flex flex-col h-full pt-10">
        <div class="px-6 pb-6">
          <div class="flex flex-col items-center gap-3 text-white">
            <img
              src="images/somap-logo.png.jpg"
              alt="SoMAp"
              class="w-20 h-20 rounded-full shadow-lg border border-white/30"
            />
            <p class="text-lg font-semibold text-white/90">SoMAp Teacher</p>
            <p class="text-sm text-white/70 text-center leading-snug">
              Command center to keep your class sharp, safe, and financially on
              track.
            </p>
          </div>
        </div>
        <div class="flex-1 overflow-y-auto slim-scroll px-4">
          <p class="text-white/60 text-xs uppercase tracking-[0.3em] px-4 mb-3">
            Navigate
          </p>
          <div class="space-y-2">
            <div class="item" onclick="navigateTo('academic')">
              <i class="fas fa-book-open"></i><span>Academic Workspace</span>
            </div>
            <div class="item" onclick="navigateTo('classattendance')">
              <i class="fas fa-list-check"></i><span>Class Attendance</span>
            </div>
            <div class="item" onclick="navigateTo('responsibilities')">
              <i class="fas fa-clipboard-check"></i
              ><span>Daily Responsibilities</span>
            </div>
            <div class="item" onclick="navigateTo('discipline')">
              <i class="fas fa-exclamation-triangle"></i><span>Discipline</span>
            </div>
            <div class="item" onclick="navigateTo('studentlist')">
              <i class="fas fa-users"></i><span>Students</span>
            </div>
            <div class="item" onclick="navigateTo('finance')">
              <i class="fas fa-sack-dollar"></i><span>Class Finance</span>
            </div>
            <div class="item" onclick="navigateTo('books')">
              <i class="fas fa-book"></i><span>Class Books</span>
            </div>
            <div
              id="prefone-entry"
              class="item hidden"
              onclick="navigateTo('prefone')"
            >
              <i class="fas fa-graduation-cap text-sky-200"></i
              ><span>Preform One Hub</span>
            </div>
            <div
              id="graduation-item"
              class="item hidden"
              onclick="window.location.href='Tostaffhtml/graduation.html'"
            >
              <i class="fas fa-chess-king text-amber-300"></i
              ><span>Graduation Suite</span>
            </div>
            <div
              class="item"
              onclick="window.location.href='transporthtml/transport.html'"
            >
              <i class="fas fa-bus"></i><span>Transport Hub</span>
            </div>
          </div>
          <div class="mt-6 pt-6 border-t border-white/20">
            <div class="item" onclick="logout()">
              <i class="fas fa-right-from-bracket"></i><span>Logout</span>
            </div>
          </div>
        </div>
        <div class="footer">
          <div class="text-xs uppercase tracking-wide mb-2 text-white/60">
            Version
          </div>
          <div>SoMApV2.1 Command</div>
        </div>
      </div>
    </nav>

    <main id="main" class="main">
      <div class="hero-card glass-card p-8 mb-8">
        <div
          class="flex flex-col xl:flex-row xl:items-center xl:justify-between gap-8"
        >
          <div class="space-y-4 max-w-2xl">
            <span class="tag">Teacher Command Center</span>
            <h1 class="text-3xl lg:text-4xl font-bold">
              Hello, <span id="teacher-name">Teacher</span>
            </h1>
            <p class="text-lg text-slate-600">
              You are leading
              <span class="font-semibold text-slate-900" id="hero-class">-</span
              >. Let us keep every learner seen, supported, and ready.
            </p>
            <div class="flex flex-wrap gap-3 text-sm text-slate-600">
              <span class="badge bg-white/80 text-indigo-700"
                ><i class="fas fa-calendar-day"></i
                ><span id="hero-date" class="ml-2">-</span></span
              >
              <span class="badge bg-white/80 text-indigo-700"
                ><i class="fas fa-clock"></i
                ><span id="hero-clock" class="ml-2">-</span></span
              >
              <span class="badge bg-white/80 text-indigo-700"
                ><i class="fas fa-children"></i
                ><span id="hero-enrollment" class="ml-2">- students</span></span
              >
            </div>
          </div>
          <div class="w-full max-w-md space-y-4">
            <div class="glass-card p-4 flex items-center gap-4">
              <div
                class="w-12 h-12 rounded-2xl bg-gradient-to-r from-sky-400 to-indigo-500 text-white grid place-items-center text-xl"
              >
                <i class="fas fa-user-shield"></i>
              </div>
              <div class="flex-1">
                <div id="user-badge" class="text-sm text-slate-600"></div>
                <div class="text-xs text-slate-500 mt-1">
                  Signed in via SoMAp secure auth
                </div>
              </div>
              <button
                id="speech-toggle"
                class="ml-auto px-3 py-2 rounded-full bg-white shadow hidden"
              >
                <i class="fas fa-volume-up"></i>
              </button>
            </div>
            <div class="glass-card p-4">
              <label
                class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-500 block mb-2"
                >Academic Year</label
              >
              <select
                data-somap-year-select
                class="w-full rounded-xl border border-white/60 bg-white/80 px-3 py-2 text-sm font-semibold text-slate-800 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-300/60"
              ></select>
              <p class="mt-2 text-xs text-slate-500">
                Switching the year refreshes all teacher modules to that
                academic cycle.
              </p>
            </div>
            <div class="glass-card p-4">
              <label
                class="text-xs font-semibold text-slate-500 uppercase tracking-widest block mb-2"
                for="student-search"
                >Search students or guardians</label
              >
              <div class="relative">
                <i
                  class="fas fa-magnifying-glass text-slate-400 absolute inset-y-0 left-3 flex items-center"
                ></i>
                <input
                  id="student-search"
                  type="search"
                  placeholder="Search by name, admission, parent or phone..."
                  class="w-full pl-10 pr-4 py-3 rounded-xl border border-white/60 bg-white/70 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-transparent transition"
                />
              </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
              <button class="quick-link" data-link="classattendance">
                <div
                  class="icon bg-gradient-to-r from-sky-400 to-indigo-500 text-white"
                >
                  <i class="fas fa-clipboard-check"></i>
                </div>
                <div>
                  <p class="text-sm font-semibold text-slate-800">
                    Rapid Roll Call
                  </p>
                  <p class="text-xs text-slate-500">
                    Open class attendance grid
                  </p>
                </div>
              </button>
              <button class="quick-link" data-link="finance">
                <div
                  class="icon bg-gradient-to-r from-amber-400 to-rose-500 text-white"
                >
                  <i class="fas fa-sack-dollar"></i>
                </div>
                <div>
                  <p class="text-sm font-semibold text-slate-800">
                    Fees Console
                  </p>
                  <p class="text-xs text-slate-500">
                    Track collections and balances
                  </p>
                </div>
              </button>
              <button class="quick-link" data-link="responsibilities">
                <div
                  class="icon bg-gradient-to-r from-slate-900 to-slate-700 text-white"
                >
                  <i class="fas fa-clipboard-list"></i>
                </div>
                <div>
                  <p class="text-sm font-semibold text-slate-800">
                    Responsibility Log
                  </p>
                  <p class="text-xs text-slate-500">
                    Update daily duties before 4:00 PM
                  </p>
                </div>
              </button>
              <button
                id="prefone-quick"
                class="quick-link hidden"
                data-link="prefone"
              >
                <div
                  class="icon bg-gradient-to-r from-emerald-400 to-sky-500 text-white"
                >
                  <i class="fas fa-seedling"></i>
                </div>
                <div>
                  <p class="text-sm font-semibold text-slate-800">
                    Preform One Data
                  </p>
                  <p class="text-xs text-slate-500">
                    Books, journals, lesson plans
                  </p>
                </div>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4 mb-6">
        <div class="glass-card metric-card" data-link="classattendance">
          <div class="metric-label">Present Today</div>
          <div id="summary-present" class="metric-value mt-2">-</div>
          <div id="present-subtext" class="metric-sub mt-1">
            Awaiting roll call
          </div>
          <div
            class="mt-6 text-xs uppercase tracking-widest text-indigo-500 font-semibold"
          >
            Open daily attendance
          </div>
        </div>
        <div class="glass-card metric-card" data-link="classattendance">
          <div class="metric-label">Absent Today</div>
          <div id="summary-absent" class="metric-value mt-2">-</div>
          <div id="absent-subtext" class="metric-sub mt-1">
            No absentees recorded
          </div>
          <div
            class="mt-6 text-xs uppercase tracking-widest text-rose-500 font-semibold"
          >
            Investigate reasons
          </div>
        </div>
        <div class="glass-card metric-card" data-link="followups">
          <div class="metric-label">Follow-up Alerts</div>
          <div id="summary-alerts" class="metric-value mt-2">-</div>
          <div class="metric-sub mt-1 text-slate-500" id="alerts-subtext">
            All pupils accounted for
          </div>
          <div
            class="mt-6 text-xs uppercase tracking-widest text-amber-500 font-semibold"
          >
            Review priority list
          </div>
        </div>
        <div class="glass-card metric-card" data-link="finance">
          <div class="metric-label">Outstanding Fees</div>
          <div id="summary-outstanding" class="metric-value mt-2">-</div>
          <div id="outstanding-subtext" class="metric-sub mt-1">
            Waiting on finance data
          </div>
          <div
            class="mt-6 text-xs uppercase tracking-widest text-emerald-500 font-semibold"
          >
            Open finance workspace
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-5 gap-4 mb-8">
        <div class="glass-card metric-card">
          <div class="metric-label">Class Population</div>
          <div id="summary-total" class="metric-value mt-2">-</div>
          <div class="metric-sub mt-1" id="population-subtext">
            Pulling student list
          </div>
        </div>
        <div class="glass-card metric-card">
          <div class="metric-label">Boys</div>
          <div id="summary-boys" class="metric-value mt-2">-</div>
          <div class="metric-sub mt-1 text-slate-500">
            Gender balance monitor
          </div>
        </div>
        <div class="glass-card metric-card">
          <div class="metric-label">Girls</div>
          <div id="summary-girls" class="metric-value mt-2">-</div>
          <div class="metric-sub mt-1 text-slate-500">
            Gender balance monitor
          </div>
        </div>
        <div class="glass-card metric-card">
          <div class="metric-label">Cleared Fees</div>
          <div id="summary-cleared" class="metric-value mt-2">-</div>
          <div class="metric-sub mt-1 text-slate-500">Fully settled pupils</div>
        </div>
        <div class="glass-card metric-card">
          <div class="metric-label">Discipline Incidents</div>
          <div id="summary-discipline" class="metric-value mt-2">-</div>
          <div class="metric-sub mt-1 text-slate-500">Logged this term</div>
        </div>
      </div>

      <div id="prefone-section" class="glass-card p-6 mb-8 hidden">
        <div
          class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
        >
          <div>
            <p class="text-xs uppercase tracking-[0.22em] text-slate-500 mb-2">
              Preform One Co-Teaching Hub
            </p>
            <h2 class="text-2xl font-semibold text-slate-800">
              Nurture Preform One Learners
            </h2>
            <p class="text-sm text-slate-500">
              Only approved class teachers can access these resources. Stay
              aligned with the SoMAp Preform One standards.
            </p>
          </div>
          <div class="flex gap-3">
            <span id="prefone-access-tag" class="badge">Limited</span>
          </div>
        </div>
        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
          <button
            id="prefone-dashboard-card"
            class="glass-card bg-white/70 border border-white/60 rounded-2xl p-5 flex flex-col gap-2 hover:shadow-xl transition hidden"
            data-prefone="dashboard"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-12 h-12 rounded-2xl bg-gradient-to-r from-indigo-500 to-violet-500 text-white grid place-items-center text-xl"
              >
                <i class="fas fa-chart-line"></i>
              </div>
              <h3 class="text-lg font-semibold text-slate-800">
                Full Dashboard
              </h3>
            </div>
            <p class="text-sm text-slate-500">
              Admissions, fees, attendance, child analytics, and graduation.
            </p>
          </button>
          <button
            class="glass-card bg-white/70 border border-white/60 rounded-2xl p-5 flex flex-col gap-2 hover:shadow-xl transition"
            data-prefone="books"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-12 h-12 rounded-2xl bg-gradient-to-r from-emerald-400 to-teal-500 text-white grid place-items-center text-xl"
              >
                <i class="fas fa-book-open-reader"></i>
              </div>
              <h3 class="text-lg font-semibold text-slate-800">
                Books Library
              </h3>
            </div>
            <p class="text-sm text-slate-500">
              Assign and review Preform One digital books easily.
            </p>
          </button>
          <button
            class="glass-card bg-white/70 border border-white/60 rounded-2xl p-5 flex flex-col gap-2 hover:shadow-xl transition"
            data-prefone="lesson"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-12 h-12 rounded-2xl bg-gradient-to-r from-sky-500 to-indigo-500 text-white grid place-items-center text-xl"
              >
                <i class="fas fa-scroll"></i>
              </div>
              <h3 class="text-lg font-semibold text-slate-800">Lesson Plans</h3>
            </div>
            <p class="text-sm text-slate-500">
              Upload and track daily lesson plans with SoMAp templates.
            </p>
          </button>
          <button
            class="glass-card bg-white/70 border border-white/60 rounded-2xl p-5 flex flex-col gap-2 hover:shadow-xl transition"
            data-prefone="journal"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-12 h-12 rounded-2xl bg-gradient-to-r from-rose-400 to-amber-400 text-white grid place-items-center text-xl"
              >
                <i class="fas fa-book-journal-whills"></i>
              </div>
              <h3 class="text-lg font-semibold text-slate-800">
                Class Journal
              </h3>
            </div>
            <p class="text-sm text-slate-500">
              Record daily reflections, incidents, and wins for Preform One.
            </p>
          </button>
        </div>
      </div>

      <div id="responsibilities-center" class="responsibility-card p-6 mb-8">
        <div
          class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"
        >
          <div>
            <p class="responsibility-meta">Daily Teacher Responsibilities</p>
            <h2 class="text-2xl font-semibold">
              Deliver all 18 duties before cut-off
            </h2>
            <p class="text-sm text-slate-300">
              Incomplete duties after 4:00 PM trigger salary deductions and
              historical penalties visible to admin.
            </p>
          </div>
          <div class="text-right">
            <p class="text-sm text-slate-300 mb-1">Completion Score</p>
            <p
              id="responsibility-progress"
              class="text-4xl font-bold text-sky-200"
            >
              0%
            </p>
            <p class="text-xs text-slate-400">
              Updates in real-time as you check off tasks.
            </p>
          </div>
        </div>
        <div
          id="responsibility-flash"
          class="mt-4 rounded-2xl px-4 py-3 bg-white/10 text-sm text-slate-200 border border-white/10"
        >
          Loading responsibility log...
        </div>
        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div id="responsibility-task-list"></div>
          <div
            class="glass-card bg-white/5 border border-white/10 rounded-2xl p-4"
          >
            <p class="text-xs uppercase tracking-[0.22em] text-slate-400 mb-2">
              Daily Timeline
            </p>
            <ul class="space-y-3 text-sm text-slate-200">
              <li>
                <i class="fas fa-sun mr-2 text-amber-300"></i
                ><strong>08:00 AM</strong> Duties open for the day
              </li>
              <li>
                <i class="fas fa-clock mr-2 text-emerald-300"></i
                ><strong>03:20 PM</strong> Attendance auto-check
              </li>
              <li>
                <i class="fas fa-flag-checkered mr-2 text-rose-300"></i
                ><strong>04:00 PM</strong> Responsibility cut-off
              </li>
              <li>
                <i class="fas fa-moon mr-2 text-indigo-300"></i
                ><strong>12:00 AM</strong> Penalties archived
              </li>
            </ul>
            <div
              class="mt-4 glass-card bg-white/5 border border-white/10 rounded-2xl p-4"
            >
              <p
                class="text-xs uppercase tracking-[0.22em] text-slate-400 mb-2"
              >
                Missed Duty Log
              </p>
              <div
                id="responsibility-history"
                class="text-sm text-slate-200 slim-scroll max-h-44"
              >
                No misses yet. Keep it up!
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mb-8">
        <div class="glass-card p-6 xl:col-span-2">
          <div
            class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6"
          >
            <div class="flex-1">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-slate-800">
                  Attendance Pulse
                </h2>
                <button
                  class="text-sm text-indigo-600 hover:text-indigo-800 font-medium"
                  data-link="classattendance"
                >
                  Open Attendance Hub
                </button>
              </div>
              <p class="text-sm text-slate-500 mb-5">
                Snapshot of today's roll call and reasons shared.
              </p>
              <div id="reasons-list" class="space-y-3"></div>
            </div>
            <div class="w-full lg:w-72">
              <canvas id="attendanceTrendChart" height="240"></canvas>
              <p class="text-xs text-slate-400 mt-3">
                Monthly presence trend (last 6 months)
              </p>
            </div>
          </div>
          <div class="mt-6 border-t border-slate-200 pt-4">
            <h3
              class="text-sm font-semibold text-slate-600 uppercase tracking-[0.18em] mb-3"
            >
              Last 5 Teaching Days
            </h3>
            <div class="overflow-x-auto slim-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Present</th>
                    <th>Absent</th>
                    <th>Special Codes</th>
                  </tr>
                </thead>
                <tbody id="last-five-attendance"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="glass-card p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-slate-800">Gender Balance</h2>
            <span class="text-xs text-slate-500 uppercase tracking-widest"
              >Live</span
            >
          </div>
          <canvas id="genderChart" height="220"></canvas>
          <p class="text-xs text-slate-400 mt-4">
            Strive for equitable participation every day.
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
        <div class="glass-card p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-slate-800">
              Student Spotlight
            </h2>
            <button
              class="text-sm text-indigo-600 hover:text-indigo-800 font-medium"
              data-link="studentlist"
            >
              View full list
            </button>
          </div>
          <p class="text-sm text-slate-500 mb-4">
            Quick glance at learners needing your attention. Click a name for
            their dossier.
          </p>
          <div class="overflow-x-auto slim-scroll">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Parent</th>
                  <th>Contact</th>
                  <th>Balance</th>
                  <th>Last Status</th>
                </tr>
              </thead>
              <tbody id="student-spotlight-body"></tbody>
            </table>
          </div>
        </div>
        <div class="glass-card p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-slate-800">Finance Health</h2>
            <button
              class="text-sm text-indigo-600 hover:text-indigo-800 font-medium"
              data-link="finance"
            >
              Update payments
            </button>
          </div>
          <p class="text-sm text-slate-500 mb-4">
            Balances and collections for this class.
          </p>
          <canvas id="financeChart" height="200"></canvas>
          <div class="mt-5 border-t border-slate-200 pt-4">
            <h3
              class="text-sm font-semibold text-slate-600 uppercase tracking-[0.18em] mb-3"
            >
              Top Outstanding Accounts
            </h3>
            <div class="overflow-x-auto slim-scroll">
              <table>
                <thead>
                  <tr>
                    <th>Student</th>
                    <th>Balance</th>
                    <th>Guardian</th>
                    <th>Contact</th>
                  </tr>
                </thead>
                <tbody id="finance-watch-body"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
        <div class="glass-card p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-slate-800">
              Inventory & Learning Tools
            </h2>
            <span class="text-xs text-slate-500 uppercase tracking-widest"
              >Class Assets</span
            >
          </div>
          <p class="text-sm text-slate-500 mb-4">
            Know exactly what is in your room before lessons start.
          </p>
          <canvas id="inventoryChart" height="200"></canvas>
          <ul
            id="inventory-list"
            class="mt-5 space-y-3 text-sm text-slate-600"
          ></ul>
        </div>
        <div class="glass-card p-6">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-slate-800">
              Books & Revision Coverage
            </h2>
            <button
              class="text-sm text-indigo-600 hover:text-indigo-800 font-medium"
              data-link="books"
            >
              Open class library
            </button>
          </div>
          <p class="text-sm text-slate-500 mb-4">
            Track distribution of required books and close the gaps.
          </p>
          <div
            class="glass-card bg-white/70 border border-white/60 rounded-2xl p-4 mb-4"
          >
            <div class="flex items-center justify-between">
              <div>
                <p class="text-xs uppercase tracking-[0.18em] text-slate-500">
                  Coverage
                </p>
                <p
                  id="books-coverage"
                  class="text-2xl font-semibold text-slate-800"
                >
                  -
                </p>
                <p id="books-coverage-sub" class="text-xs text-slate-500">
                  Awaiting library data
                </p>
              </div>
              <div
                class="w-16 h-16 rounded-full bg-gradient-to-br from-emerald-400/70 to-sky-400/80 text-white grid place-items-center text-xl"
              >
                <i class="fas fa-book-reader"></i>
              </div>
            </div>
          </div>
          <div class="overflow-x-auto slim-scroll">
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Subject</th>
                  <th>Have</th>
                  <th>Missing</th>
                </tr>
              </thead>
              <tbody id="books-coverage-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="alert-center" class="glass-card p-6 mb-10">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold text-slate-800">
            Follow-up & Shift Watch
          </h2>
          <span class="text-xs text-slate-500 uppercase tracking-widest"
            >Action Required</span
          >
        </div>
        <p class="text-sm text-slate-500 mb-4">
          Any learner absent beyond three weeks, finance escalations, or
          discipline trends show here automatically.
        </p>
        <div id="alert-list"></div>
      </div>
    </main>

    <div id="welcome" class="modal">
      <div class="modal-card max-w-md text-center">
        <button id="welcome-close" class="close-btn">
          <i class="fas fa-xmark"></i>
        </button>
        <div class="text-2xl font-bold text-slate-800 mb-2" id="welcome-msg">
          Welcome
        </div>
        <p class="text-sm text-slate-600 mb-3" id="welcome-sub">
          Loading class context...
        </p>
        <p class="text-xs text-slate-500 mb-6">
          Tip: add quick notes for each alert after you follow up.
        </p>
        <button
          class="px-4 py-2 rounded-lg bg-gradient-to-r from-sky-500 to-indigo-500 text-white font-semibold shadow"
          id="welcome-continue"
        >
          Enter dashboard
        </button>
      </div>
    </div>

    <div id="studentModal" class="modal">
      <div class="modal-card">
        <button class="close-btn" data-close="studentModal">
          <i class="fas fa-xmark"></i>
        </button>
        <div id="studentModalBody"></div>
      </div>
    </div>

    <div id="shiftModal" class="modal">
      <div class="modal-card">
        <button class="close-btn" data-close="shiftModal">
          <i class="fas fa-xmark"></i>
        </button>
        <h3 class="text-xl font-semibold text-slate-800 mb-2">
          Mark Learner as Shifted
        </h3>
        <p class="text-sm text-slate-500 mb-4">
          Capture the reason and destination so the office can update records.
        </p>
        <div
          class="bg-slate-100/80 border border-slate-200 rounded-xl p-4 mb-4"
        >
          <div
            class="text-sm font-semibold text-slate-700"
            id="shiftStudentName"
          >
            Student
          </div>
          <div class="text-xs text-slate-500" id="shiftStudentInfo">ADM -</div>
        </div>
        <form id="shiftForm" class="space-y-4">
          <div>
            <label
              for="shiftReason"
              class="text-xs font-semibold text-slate-600 uppercase tracking-widest block mb-2"
              >Reason / New School</label
            >
            <textarea
              id="shiftReason"
              rows="3"
              class="w-full border border-slate-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"
            ></textarea>
          </div>
          <div class="flex items-center gap-3">
            <button
              type="submit"
              class="px-4 py-2 bg-gradient-to-r from-amber-500 to-rose-500 text-white font-semibold rounded-xl shadow"
            >
              Save Shift Details
            </button>
            <button
              type="button"
              data-close="shiftModal"
              class="px-4 py-2 rounded-xl border border-slate-300 text-slate-600"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
      (function () {
        const auth = firebase.auth();
        const db = firebase.database();
        const YEAR = new Date().getFullYear();
        const CLASS_ALERT_ABSENCE_DAYS = 15;
        const ATTENDANCE_DEADLINE_MINUTES = 15 * 60 + 20; // 3:20 PM
        const RESPONSIBILITY_CUTOFF_MINUTES = 16 * 60; // 4:00 PM
        const RESPONSIBILITY_RESET_MINUTES = 8 * 60; // 8:00 AM

        const FULL_PREFONE_EMAILS = new Set([
          "ssclass72023@gmail.com",
          "ssclass72023@gmail_com",
        ]);

        const PARTIAL_PREFONE_EMAILS = new Set([
          "ssclass32023@gmail.com",
          "ssclass32023@gmail_com",
          "ssclass42023@gmail.com",
          "ssclass42023@gmail_com",
          "ssclass52023@gmail.com",
          "ssclass52023@gmail_com",
          "ssclass62023@gmail.com",
          "ssclass62023@gmail_com",
        ]);

        const RESPONSIBILITY_TASKS = [
          {
            id: "arrival_sign_in",
            label: "Sign in arrival time",
            detail: "Record your personal arrival time for audit trails.",
          },
          {
            id: "departure_sign_out",
            label: "Sign out departure time",
            detail: "Log departure to complete duty-of-care records.",
          },
          {
            id: "register_attendance_numbers",
            label: "Register number of pupils (present & absent)",
            detail: "Ensure counts match class roll call.",
          },
          {
            id: "core_documents_ready",
            label:
              "Core documents ready (curriculum, guide, syllabus, schemes)",
            detail:
              "Keep curriculum, teacher's guide, syllabus, and schemes aligned and on your desk.",
          },
          {
            id: "lesson_plan_filled",
            label: "Fill in daily lesson plans",
            detail: "Upload or complete SoMAp lesson plan for the day.",
          },
          {
            id: "weekly_teaching_aid",
            label: "Weekly teaching aid prepared",
            detail: "Confirm learning aids are ready and shared.",
          },
          {
            id: "benchmarks_updated",
            label: "Benchmarks updated",
            detail: "Record learner benchmarks or assessments due today.",
          },
          {
            id: "class_journal",
            label: "Class journal updated",
            detail: "Log class reflections and incidents in SoMAp.",
          },
          {
            id: "subject_log_book",
            label: "Subject log book updated",
            detail: "Enter subject-specific progress and challenges.",
          },
          {
            id: "homework_assigned",
            label: "Homework assigned & tracked",
            detail: "Assign or review homework tasks for learners.",
          },
          {
            id: "class_rules_enforced",
            label: "Class rules enforced",
            detail: "Confirm classroom rules were reinforced today.",
          },
          {
            id: "attendance_maintained",
            label: "Attendance record maintained",
            detail: "Ensure today's attendance is locked in SoMAp.",
          },
          {
            id: "co_curricular",
            label: "Co-curricular activity conducted",
            detail: "Engage learners in at least one activity.",
          },
          {
            id: "subject_timing",
            label: "Subjects taught on time",
            detail: "Cover scheduled subjects without delays.",
          },
          {
            id: "socratic_departments",
            label: "Handle 2 Socratic departments",
            detail: "Coordinate two departments towards term goals.",
          },
          {
            id: "pupils_diaries",
            label: "Pupils diaries updated",
            detail: "Check diaries for parent communication and homework.",
          },
          {
            id: "slow_learners_focus",
            label: "Support slow learners",
            detail: "Document support offered to emerging learners.",
          },
          {
            id: "remedial_lessons",
            label: "Attend remedial lessons on time",
            detail: "Confirm remedial sessions were held as timetabled.",
          },
        ];
        const FIXED_HOLIDAYS = [
          "01-01",
          "04-07",
          "04-26",
          "05-01",
          "07-07",
          "08-08",
          "10-14",
          "12-09",
          "12-25",
          "12-26",
        ];
        const MOVABLE_HOLIDAYS = [
          "2025-03-29",
          "2025-04-01",
          "2025-04-10",
          "2025-04-11",
          "2025-06-16",
        ];

        const state = {
          students: [],
          studentIndex: new Map(),
          attendance: {},
          fees: {},
          discipline: [],
          books: {},
          booksRows: [],
          booksSummary: { coveragePct: 0, totalMissing: 0 },
          inventory: {},
          inventoryItems: [],
          shifted: {},
          todays: {
            present: 0,
            absent: 0,
            partial: 0,
            special: 0,
            reasons: {},
            recorded: 0,
          },
          financeTotals: {
            required: 0,
            paid: 0,
            balance: 0,
            cleared: 0,
            owing: 0,
          },
          alerts: [],
          prefoneAccess: "none",
          responsibilities: {
            status: {},
            meta: {},
            history: [],
            prevPenalty: null,
            currentKey: null,
            refreshing: false,
          },
          penalties: {
            attendance: false,
            responsibilities: false,
          },
        };

        const userCtx = {
          displayName: "",
          email: "",
          className: "",
          safeEmail: "",
          safeClassKey: "",
        };

        const el = (id) => document.getElementById(id);
        const els = {
          sidebar: document.getElementById("sidebar"),
          main: document.getElementById("main"),
          teacherName: el("teacher-name"),
          heroClass: el("hero-class"),
          heroDate: el("hero-date"),
          heroClock: el("hero-clock"),
          heroEnrollment: el("hero-enrollment"),
          userBadge: el("user-badge"),
          studentSearch: el("student-search"),
          speechToggle: el("speech-toggle"),
          summaryPresent: el("summary-present"),
          presentSub: el("present-subtext"),
          summaryAbsent: el("summary-absent"),
          absentSub: el("absent-subtext"),
          summaryAlerts: el("summary-alerts"),
          alertsSub: el("alerts-subtext"),
          summaryOutstanding: el("summary-outstanding"),
          outstandingSub: el("outstanding-subtext"),
          summaryTotal: el("summary-total"),
          populationSub: el("population-subtext"),
          summaryBoys: el("summary-boys"),
          summaryGirls: el("summary-girls"),
          summaryCleared: el("summary-cleared"),
          summaryDiscipline: el("summary-discipline"),
          reasonsList: el("reasons-list"),
          lastFive: el("last-five-attendance"),
          studentSpotlightBody: el("student-spotlight-body"),
          financeWatchBody: el("finance-watch-body"),
          inventoryList: el("inventory-list"),
          booksCoverage: el("books-coverage"),
          booksCoverageSub: el("books-coverage-sub"),
          booksCoverageBody: el("books-coverage-body"),
          alertList: el("alert-list"),
          welcome: el("welcome"),
          welcomeMsg: el("welcome-msg"),
          welcomeSub: el("welcome-sub"),
          welcomeContinue: el("welcome-continue"),
          toast: el("toast"),
          studentModal: el("studentModal"),
          studentModalBody: el("studentModalBody"),
          shiftModal: el("shiftModal"),
          shiftForm: el("shiftForm"),
          shiftReason: el("shiftReason"),
          shiftStudentName: el("shiftStudentName"),
          shiftStudentInfo: el("shiftStudentInfo"),
          graduationItem: el("graduation-item"),
          prefoneEntry: el("prefone-entry"),
          prefoneSection: el("prefone-section"),
          prefoneAccessTag: el("prefone-access-tag"),
          prefoneQuick: el("prefone-quick"),
          prefoneDashboardCard: el("prefone-dashboard-card"),
          responsibilitiesCenter: el("responsibilities-center"),
          responsibilityTaskList: el("responsibility-task-list"),
          responsibilityProgress: el("responsibility-progress"),
          responsibilityFlash: el("responsibility-flash"),
          responsibilityHistory: el("responsibility-history"),
        };

        const charts = {
          attendance: null,
          gender: null,
          finance: null,
          inventory: null,
        };

        let renderPending = false;
        let searchTerm = "";
        let speechEnabled = false;
        let pendingShiftStudent = null;
        const pathCache = {};

        initLayout();
        startClock();
        evaluateCompliance();
        setInterval(evaluateCompliance, 60 * 1000);

        auth.onAuthStateChanged(handleAuthState);

        function initLayout() {
          const menuButton = document.getElementById("menu-dots");
          menuButton.addEventListener("click", () => {
            els.sidebar.classList.toggle("expanded");
            els.main.classList.toggle("shifted");
            const showSpeech = els.sidebar.classList.contains("expanded");
            if (els.speechToggle) {
              els.speechToggle.classList.toggle("hidden", !showSpeech);
            }
          });

          if (window.innerWidth >= 1280) {
            els.sidebar.classList.add("expanded");
            els.main.classList.add("shifted");
          }

          window.addEventListener("resize", () => {
            if (window.innerWidth >= 1280) {
              els.sidebar.classList.add("expanded");
              els.main.classList.add("shifted");
            }
          });

          document.querySelectorAll("[data-link]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const target = btn.getAttribute("data-link");
              if (target) navigateTo(target);
            });
          });

          document.querySelectorAll("[data-prefone]").forEach((card) => {
            card.addEventListener("click", () =>
              handlePrefoneLaunch(card.getAttribute("data-prefone"))
            );
          });

          document.querySelectorAll(".metric-card").forEach((card) => {
            card.addEventListener("click", () => {
              const target = card.getAttribute("data-link");
              if (target) navigateTo(target);
            });
          });

          if (els.studentSearch) {
            els.studentSearch.addEventListener("input", (event) => {
              searchTerm = (event.target.value || "").toLowerCase();
              scheduleRender();
            });
          }

          if (els.speechToggle) {
            els.speechToggle.addEventListener("click", () => {
              speechEnabled = !speechEnabled;
              els.speechToggle.innerHTML = speechEnabled
                ? '<i class="fas fa-volume-up"></i>'
                : '<i class="fas fa-volume-mute"></i>';
              showToast(`Speech ${speechEnabled ? "enabled" : "muted"}`);
            });
          }

          document.querySelectorAll(".modal").forEach((modal) => {
            modal.addEventListener("click", (event) => {
              if (event.target === modal) {
                hideModal(modal);
              }
            });
          });

          document.querySelectorAll("[data-close]").forEach((btn) => {
            btn.addEventListener("click", () => {
              const targetId = btn.getAttribute("data-close");
              const modal = document.getElementById(targetId);
              if (modal) hideModal(modal);
            });
          });

          if (els.welcomeContinue) {
            els.welcomeContinue.addEventListener("click", () =>
              hideModal(els.welcome)
            );
          }

          const welcomeClose = document.getElementById("welcome-close");
          if (welcomeClose)
            welcomeClose.addEventListener("click", () =>
              hideModal(els.welcome)
            );

          if (els.studentSpotlightBody) {
            els.studentSpotlightBody.addEventListener("click", (event) => {
              const row = event.target.closest("tr[data-student]");
              if (row) {
                openStudentModal(row.getAttribute("data-student"));
              }
            });
          }

          if (els.alertList) {
            els.alertList.addEventListener("click", (event) => {
              const button = event.target.closest("[data-shift]");
              if (button) {
                const lookupKey = button.getAttribute("data-shift");
                const student = state.studentIndex.get(lookupKey);
                if (student) {
                  openShiftModal(student);
                }
              }
            });
          }

          if (els.shiftForm) {
            els.shiftForm.addEventListener("submit", async (event) => {
              event.preventDefault();
              if (!pendingShiftStudent) {
                showToast("No student selected.");
                return;
              }
              const reason = (els.shiftReason.value || "").trim();
              if (!reason) {
                showToast("Please capture the shift reason or destination.");
                return;
              }
              try {
                const path = await getShiftedPath();
                const node = `${path}/${
                  pendingShiftStudent.lookupKey ||
                  normalizeAdm(pendingShiftStudent.adm) ||
                  pendingShiftStudent.id
                }`;
                await db.ref(node).set({
                  name: pendingShiftStudent.name,
                  adm: pendingShiftStudent.adm || "",
                  class: userCtx.className,
                  recordedBy: userCtx.email,
                  reason,
                  contact: pendingShiftStudent.contact || "",
                  time: Date.now(),
                });
                showToast("Shift record saved.");
                hideModal(els.shiftModal);
              } catch (err) {
                console.error("Shift save failed", err);
                showToast("Could not save shift record. Check your network.");
              }
            });
          }
        }

        function startClock() {
          const update = () => {
            const now = new Date();
            if (els.heroDate) {
              els.heroDate.textContent = now.toLocaleDateString("en-US", {
                weekday: "long",
                month: "long",
                day: "numeric",
                year: "numeric",
              });
            }
            if (els.heroClock) {
              els.heroClock.textContent = now.toLocaleTimeString("en-US", {
                hour: "2-digit",
                minute: "2-digit",
              });
            }
          };
          update();
          setInterval(update, 60 * 1000);
        }

        async function handleAuthState(user) {
          if (!user) {
            console.warn("Auth not ready yet, waiting...");
            return; //
          }
          userCtx.displayName =
            user.displayName ||
            (user.email ? user.email.split("@")[0] : "Teacher");
          userCtx.email = user.email || "";
          userCtx.safeEmail = userCtx.email.replace(/\./g, "_");

          try {
            const snap = await db.ref(`users/${userCtx.safeEmail}`).get();
            const profile = snap.exists() ? snap.val() : null;

            // If profile not loaded yet, do NOT log out
            if (!profile) {
              console.warn("Teacher profile not yet available, waiting...");
              return;
            }

            // Enforce role only if explicitly wrong
            if (
              profile.role &&
              String(profile.role).toLowerCase() !== "teacher"
            ) {
              alert("This dashboard is restricted to teacher accounts.");
              window.location.href = "index.html";
              return;
            }

            userCtx.className =
              profile.class ||
              profile.classLevel ||
              profile.streamClass ||
              "Class 7";
            userCtx.safeClassKey = encodeURIComponent(userCtx.className);

            if (els.teacherName)
              els.teacherName.textContent = userCtx.displayName;
            if (els.heroClass) els.heroClass.textContent = userCtx.className;
            if (els.userBadge) {
              els.userBadge.innerHTML = `<strong>${userCtx.displayName}</strong><div class="text-xs text-slate-500">${userCtx.email}</div>`;
            }

            if (profile.displaySpeech === true) {
              speechEnabled = true;
              if (els.speechToggle) {
                els.speechToggle.classList.remove("hidden");
                els.speechToggle.innerHTML = '<i class="fas fa-volume-up"></i>';
              }
            }

            if (els.graduationItem) {
              const GRAD_EMAILS = [
                "ssclass42023@gmail.com",
                "socratesschool2020@gmail.com",
              ];
              if (GRAD_EMAILS.includes(userCtx.email.toLowerCase())) {
                els.graduationItem.classList.remove("hidden");
              } else {
                els.graduationItem.classList.add("hidden");
              }
            }

            const prefAccess = resolvePrefoneAccess(
              userCtx.email,
              userCtx.safeEmail,
              userCtx.className
            );
            configurePrefoneAccess(prefAccess);

            showWelcome(userCtx.displayName, userCtx.className);

            await initializeFeeds();
          } catch (err) {
            console.error("Auth bootstrap error", err);
            showToast("Unable to load teacher profile.");
          }
        }

        function showWelcome(name, className) {
          if (!els.welcome) return;
          els.welcomeMsg.textContent = `Welcome ${name.toUpperCase()}`;
          els.welcomeSub.textContent = `Monitoring ${className}. Let us make today count.`;
          els.welcome.classList.add("show");
          setTimeout(() => hideModal(els.welcome), 2600);
        }

        async function initializeFeeds() {
          await subscribeStudents(userCtx.className);
          subscribeAttendance(userCtx.className);
          subscribeFees(userCtx.className);
          subscribeDiscipline(userCtx.className);
          subscribeBooks(userCtx.className);
          subscribeInventory(userCtx.className);
          subscribeShifted(userCtx.className);
          await ensureDailyResponsibilities();
          subscribeResponsibilities();
          subscribeResponsibilityHistory();
        }

        async function subscribeStudents(className) {
          const paths = [
            "students",
            "Students",
            "studentsList",
            "StudentsList",
            "studentList",
          ];
          const resolved = await resolveFirstPath(paths);
          const path = resolved || paths[0];
          pathCache.students = path;
          db.ref(path).on(
            "value",
            (snap) => {
              const raw = snap.val() || {};
              handleStudentsSnapshot(raw, className);
            },
            (err) => console.error("students listener error", err)
          );
        }

        function handleStudentsSnapshot(raw, className) {
          const list = [];
          const needle = normalizeClassName(className);
          Object.entries(raw).forEach(([key, data]) => {
            if (!data || typeof data !== "object") return;
            const status = String(
              data.status || data.enrollmentStatus || ""
            ).toLowerCase();
            const inactiveState = [
              "shifted",
              "transferred",
              "transfered",
              "inactive",
              "graduated",
              "archived",
            ].includes(status);
            if (
              inactiveState ||
              data.active === false ||
              data.shifted === true ||
              data.isShifted === true
            )
              return;
            const classLabel =
              data.class ||
              data.classLevel ||
              data.currentClass ||
              data.grade ||
              data.streamClass ||
              "";
            const normalized = normalizeClassName(classLabel);
            if (needle) {
              if (!normalized) return;
              const matches =
                normalized === needle ||
                normalized.startsWith(needle) ||
                needle.startsWith(normalized);
              if (!matches) return;
            }
            const student = normalizeStudentRecord(
              key,
              data,
              classLabel,
              status
            );
            list.push(student);
          });
          list.sort((a, b) => a.name.localeCompare(b.name));
          state.students = list;
          state.studentIndex = new Map(list.map((s) => [s.lookupKey, s]));
          if (els.heroEnrollment) {
            els.heroEnrollment.textContent = `${list.length} students`;
          }
          mergeFeesIntoStudents();
          updateTodaysTotals();
          refreshAlerts();
          scheduleRender();
        }

        function normalizeStudentRecord(key, data, classLabel, status = "") {
          const admRaw =
            data.admissionNumber ||
            data.admNo ||
            data.admission ||
            data.adm ||
            data.studentId ||
            data.pupilId ||
            key;
          const adm = String(admRaw || "").trim();
          const lookupKey = normalizeAdm(adm || key);
          const nameParts = [
            data.firstName,
            data.middleName,
            data.lastName,
          ].filter(Boolean);
          const name = (
            nameParts.join(" ").trim() ||
            data.name ||
            data.fullName ||
            "Student"
          ).replace(/\s+/g, " ");
          const gender = normalizeGender(data.gender || data.sex || "");
          const parent =
            data.parentName || data.guardianName || data.caretaker || "";
          const contact =
            data.parentContact ||
            data.parentPhone ||
            data.guardianPhone ||
            data.contact ||
            data.phone ||
            "";
          const feeDue = toNumber(
            data.totalFee || data.feePerYear || data.feeDue || data.required
          );
          const feePaid = toNumber(
            data.feesPaid || data.feePaid || data.paidAmount || data.paid || 0
          );
          const balance =
            data.balance != null
              ? toNumber(data.balance)
              : Math.max(0, feeDue - feePaid);
          const resolvedClass =
            classLabel ||
            data.streamClass ||
            data.stream ||
            data.classStream ||
            "";
          return {
            id: key,
            adm,
            lookupKey,
            name,
            classLabel: resolvedClass,
            gender,
            parent,
            contact,
            feeDue,
            feePaid,
            balance,
            status,
            picture: data.photoUrl || data.passport || data.avatar || "",
            raw: data,
          };
        }

        function subscribeAttendance(className) {
          db.ref(`attendance/${className}`).on(
            "value",
            (snap) => {
              state.attendance = snap.val() || {};
              updateTodaysTotals();
              refreshAlerts();
              scheduleRender();
            },
            (err) => console.error("attendance listener error", err)
          );
        }

        function subscribeFees(className) {
          db.ref(`fees/${YEAR}/${className}`).on(
            "value",
            (snap) => {
              const data = snap.val() || {};
              const mapped = {};
              Object.entries(data).forEach(([adm, value]) => {
                const key = normalizeAdm(adm);
                const required = toNumber(
                  value.required || value.expected || value.total || 0
                );
                const paid = toNumber(
                  value.paid || value.paidAmount || value.totalPaid || 0
                );
                const balance =
                  value.balance != null
                    ? toNumber(value.balance)
                    : Math.max(0, required - paid);
                mapped[key] = { required, paid, balance, raw: value };
              });
              state.fees = mapped;
              mergeFeesIntoStudents();
              refreshAlerts();
              scheduleRender();
            },
            (err) => console.error("fees listener error", err)
          );
        }

        function subscribeDiscipline(className) {
          db.ref("discipline")
            .orderByChild("class")
            .equalTo(className)
            .on(
              "value",
              (snap) => {
                const data = snap.val() || {};
                state.discipline = Object.values(data);
                refreshAlerts();
                scheduleRender();
              },
              (err) => console.error("discipline listener error", err)
            );
        }

        function subscribeBooks(className) {
          const path = `class_books/${encodeURIComponent(className)}`;
          pathCache.books = path;
          db.ref(path).on(
            "value",
            (snap) => {
              handleBooksSnapshot(snap.val() || {});
            },
            (err) => console.error("books listener error", err)
          );
        }

        async function subscribeInventory(className) {
          const encoded = encodeURIComponent(className);
          const paths = [
            `class_inventory/${encoded}`,
            `classInventory/${encoded}`,
            `inventory/${encoded}`,
            `inventory/${className}`,
            `classes/${encoded}/inventory`,
            `Classes/${encoded}/inventory`,
          ];
          const resolved = await resolveFirstPath(paths);
          if (!resolved) {
            state.inventory = {};
            state.inventoryItems = [];
            scheduleRender();
            return;
          }
          pathCache.inventory = resolved;
          db.ref(resolved).on(
            "value",
            (snap) => {
              handleInventorySnapshot(snap.val() || {});
            },
            (err) => console.error("inventory listener error", err)
          );
        }

        async function subscribeShifted(className) {
          const encoded = encodeURIComponent(className);
          const paths = [
            `shiftedStudents/${encoded}`,
            `shifted/${encoded}`,
            `shifted/${className}`,
            `studentsShifted/${encoded}`,
          ];
          const resolved = await resolveFirstPath(paths);
          const path = resolved || `shiftedStudents/${encoded}`;
          pathCache.shifted = path;
          db.ref(path).on(
            "value",
            (snap) => {
              state.shifted = snap.val() || {};
              refreshAlerts();
              scheduleRender();
            },
            (err) => console.error("shifted listener error", err)
          );
        }

        async function ensureDailyResponsibilities() {
          if (!db || !userCtx.safeEmail) return;
          const dateKey = getTodayKey();
          const basePath = getResponsibilitiesPath(dateKey);
          try {
            const tasksSnap = await db.ref(`${basePath}/tasks`).get();
            if (!tasksSnap.exists()) {
              const initial = {};
              RESPONSIBILITY_TASKS.forEach((task) => {
                initial[task.id] = false;
              });
              await db.ref(basePath).set({
                tasks: initial,
                meta: {
                  createdAt: Date.now(),
                  penaltyLogged: false,
                  totalTasks: RESPONSIBILITY_TASKS.length,
                },
              });
            }
          } catch (err) {
            console.error("ensureDailyResponsibilities", err);
          }
        }

        function subscribeResponsibilities() {
          if (!db || !userCtx.safeEmail) return;
          const dateKey = getTodayKey();
          const basePath = getResponsibilitiesPath(dateKey);
          if (
            pathCache.responsibilities &&
            pathCache.responsibilities !== basePath
          ) {
            db.ref(pathCache.responsibilities).off();
          }
          pathCache.responsibilities = basePath;
          state.responsibilities.currentKey = dateKey;
          state.responsibilities.refreshing = false;
          db.ref(basePath).on(
            "value",
            (snap) => {
              const data = snap.val() || {};
              state.responsibilities.status = data.tasks || {};
              state.responsibilities.meta = data.meta || {};
              renderResponsibilities();
              evaluateCompliance();
            },
            (err) => console.error("responsibilities listener error", err)
          );
        }

        function subscribeResponsibilityHistory() {
          if (!db || !userCtx.safeEmail) return;
          db.ref(`teacherResponsibilitiesHistory/${userCtx.safeEmail}`)
            .limitToLast(14)
            .on(
              "value",
              (snap) => {
                const data = snap.val() || {};
                const list = Object.entries(data)
                  .map(([dateKey, value]) => ({
                    dateKey,
                    missedTasks: value.missedTasks || [],
                    penaltyTime: value.penaltyTime || 0,
                  }))
                  .sort((a, b) => b.dateKey.localeCompare(a.dateKey));
                state.responsibilities.history = list;
                const yesterdayKey = getDateKey(-1);
                state.responsibilities.prevPenalty =
                  list.find(
                    (entry) =>
                      entry.dateKey === yesterdayKey &&
                      entry.missedTasks &&
                      entry.missedTasks.length
                  ) || null;
                renderResponsibilityHistory();
                evaluateCompliance();
              },
              (err) =>
                console.error("responsibility history listener error", err)
            );
        }

        function renderResponsibilities() {
          if (!els.responsibilityTaskList) return;
          const container = els.responsibilityTaskList;
          container.innerHTML = "";
          const todayStatus = state.responsibilities.status || {};
          RESPONSIBILITY_TASKS.forEach((task, index) => {
            const inputId = `resp-${task.id}`;
            const checked = !!todayStatus[task.id];
            const taskRow = document.createElement("div");
            taskRow.className = "task";
            taskRow.innerHTML = `
            <input type="checkbox" id="${inputId}" data-task="${task.id}" ${
              checked ? "checked" : ""
            } class="mt-1 accent-sky-500">
            <div>
              <label for="${inputId}"><span class="text-xs text-slate-400 mr-2">${String(
              index + 1
            ).padStart(2, "0")}</span>${task.label}</label>
              <p class="text-xs text-slate-400">${task.detail}</p>
            </div>
          `;
            container.appendChild(taskRow);
          });
          container
            .querySelectorAll('input[type="checkbox"]')
            .forEach((cb) =>
              cb.addEventListener("change", onResponsibilityToggle)
            );
          updateResponsibilityProgress();
          renderResponsibilityHistory();
        }

        function updateResponsibilityProgress() {
          const todayStatus = state.responsibilities.status || {};
          const total = RESPONSIBILITY_TASKS.length;
          const completed = RESPONSIBILITY_TASKS.reduce(
            (sum, task) => sum + (todayStatus[task.id] ? 1 : 0),
            0
          );
          const percentage = total ? Math.round((completed / total) * 100) : 0;
          if (els.responsibilityProgress) {
            els.responsibilityProgress.textContent = `${percentage}%`;
          }
          updateResponsibilityFlash(completed, total);
        }

        function renderResponsibilityHistory() {
          if (!els.responsibilityHistory) return;
          const history = state.responsibilities.history || [];
          if (!history.length) {
            els.responsibilityHistory.innerHTML = "No misses yet. Keep it up!";
            return;
          }
          const frag = document.createDocumentFragment();
          history.forEach((entry) => {
            const row = document.createElement("div");
            row.className =
              "flex items-start justify-between gap-3 py-2 border-b border-white/10";
            row.innerHTML = `
            <div>
              <p class="text-sm font-semibold text-amber-200">${formatDate(
                entry.dateKey
              )}</p>
              <p class="text-xs text-slate-300">${
                entry.missedTasks.length
                  ? entry.missedTasks.map((id) => taskLabelById(id)).join(", ")
                  : "All duties completed"
              }</p>
            </div>
            <div class="text-xs text-slate-400">${
              entry.missedTasks.length
                ? `${entry.missedTasks.length} missed`
                : ""
            }</div>
          `;
            frag.appendChild(row);
          });
          els.responsibilityHistory.innerHTML = "";
          els.responsibilityHistory.appendChild(frag);
        }

        function onResponsibilityToggle(event) {
          const checkbox = event.target;
          const taskId = checkbox.dataset.task;
          const done = checkbox.checked;
          saveResponsibilityStatus(taskId, done);
        }

        async function saveResponsibilityStatus(taskId, done) {
          if (!db || !userCtx.safeEmail || !taskId) return;
          const dateKey = getTodayKey();
          const basePath = getResponsibilitiesPath(dateKey);
          try {
            await db.ref(`${basePath}/tasks/${taskId}`).set(!!done);
            await db.ref(`${basePath}/meta`).update({
              updatedAt: Date.now(),
              totalTasks: RESPONSIBILITY_TASKS.length,
            });
          } catch (err) {
            console.error("saveResponsibilityStatus", err);
            showToast(
              "Could not update responsibility. Check your connection."
            );
          }
        }

        function updateResponsibilityFlash(completed, total) {
          if (!els.responsibilityFlash) return;
          const remaining = Math.max(0, total - completed);
          const now = new Date();
          const minutes = now.getHours() * 60 + now.getMinutes();
          els.responsibilityFlash.classList.remove(
            "bg-rose-600/90",
            "text-white",
            "border-rose-500/80",
            "bg-white/10",
            "text-slate-200",
            "border-white/10",
            "bg-emerald-500/70",
            "border-white/20"
          );
          if (!total) {
            els.responsibilityFlash.textContent =
              "Responsibilities template is initializing...";
            els.responsibilityFlash.classList.add(
              "bg-white/10",
              "text-slate-200",
              "border-white/10"
            );
            return;
          }
          if (remaining === 0) {
            els.responsibilityFlash.textContent = `All ${total} responsibilities cleared. Keep this consistency!`;
            els.responsibilityFlash.classList.add(
              "bg-emerald-500/70",
              "text-white",
              "border-white/20"
            );
          } else {
            const previousPenaltyActive =
              state.responsibilities.prevPenalty &&
              state.responsibilities.prevPenalty.missedTasks &&
              state.responsibilities.prevPenalty.missedTasks.length;
            let message = `You still have ${remaining} responsibility${
              remaining > 1 ? " items" : " item"
            } pending. Complete before 4:00 PM to avoid salary deductions.`;
            if (
              minutes < RESPONSIBILITY_RESET_MINUTES &&
              previousPenaltyActive
            ) {
              const missedList = state.responsibilities.prevPenalty.missedTasks
                .map(taskLabelById)
                .join(", ");
              message = `Yesterday's pending duties: ${
                missedList || `${remaining} items`
              }. Clear updates before 8:00 AM to lift the penalty.`;
            }
            els.responsibilityFlash.textContent = message;
            if (
              minutes >= RESPONSIBILITY_CUTOFF_MINUTES ||
              (minutes < RESPONSIBILITY_RESET_MINUTES && previousPenaltyActive)
            ) {
              els.responsibilityFlash.classList.add(
                "bg-rose-600/90",
                "text-white",
                "border-rose-500/80"
              );
            } else {
              els.responsibilityFlash.classList.add(
                "bg-white/10",
                "text-slate-200",
                "border-white/10"
              );
            }
          }
        }

        function missingResponsibilityIds() {
          const todayStatus = state.responsibilities.status || {};
          return RESPONSIBILITY_TASKS.filter(
            (task) => !todayStatus[task.id]
          ).map((task) => task.id);
        }

        async function recordResponsibilityPenalty(missingTasks) {
          if (!db || !userCtx.safeEmail) return;
          if (!missingTasks.length) return;
          const dateKey = getTodayKey();
          const basePath = getResponsibilitiesPath(dateKey);
          try {
            await db.ref(`${basePath}/meta`).update({
              penaltyLogged: true,
              penaltyTime: Date.now(),
              missedTasks: missingTasks,
            });
            await db
              .ref(
                `teacherResponsibilitiesHistory/${userCtx.safeEmail}/${dateKey}`
              )
              .set({
                missedTasks,
                penaltyTime: Date.now(),
              });
            state.responsibilities.meta = Object.assign(
              {},
              state.responsibilities.meta,
              {
                penaltyLogged: true,
                penaltyTime: Date.now(),
                missedTasks: missingTasks,
              }
            );
          } catch (err) {
            console.error("recordResponsibilityPenalty", err);
          }
        }

        function taskLabelById(taskId) {
          const task = RESPONSIBILITY_TASKS.find((t) => t.id === taskId);
          return task ? task.label : taskId;
        }

        function getResponsibilitiesPath(dateKey = getTodayKey()) {
          return `teacherResponsibilities/${userCtx.safeEmail}/${dateKey}`;
        }

        function resolvePrefoneAccess(email, safeEmail, className) {
          const emailKey = String(email || "").toLowerCase();
          const safeKey = String(safeEmail || "").toLowerCase();
          const classKey = normalizeClassName(className);
          if (
            FULL_PREFONE_EMAILS.has(emailKey) ||
            FULL_PREFONE_EMAILS.has(safeKey)
          ) {
            return "full";
          }
          if (
            PARTIAL_PREFONE_EMAILS.has(emailKey) ||
            PARTIAL_PREFONE_EMAILS.has(safeKey)
          ) {
            if (
              ["CLASS3", "CLASS4", "CLASS5", "CLASS6", "CLASS7"].includes(
                classKey
              )
            ) {
              return "partial";
            }
          }
          return "none";
        }

        function configurePrefoneAccess(level) {
          state.prefoneAccess = level;
          const hasAccess = level !== "none";
          if (els.prefoneSection)
            els.prefoneSection.classList.toggle("hidden", !hasAccess);
          if (els.prefoneQuick)
            els.prefoneQuick.classList.toggle("hidden", !hasAccess);
          if (els.prefoneEntry)
            els.prefoneEntry.classList.toggle("hidden", !hasAccess);
          if (els.prefoneAccessTag) {
            els.prefoneAccessTag.textContent =
              level === "full"
                ? "Full Access"
                : level === "partial"
                ? "Limited Access"
                : "Restricted";
            els.prefoneAccessTag.classList.toggle(
              "bg-white/80",
              level === "full"
            );
            els.prefoneAccessTag.classList.toggle(
              "text-indigo-700",
              level === "full"
            );
          }
          if (els.prefoneDashboardCard) {
            els.prefoneDashboardCard.classList.toggle(
              "hidden",
              level !== "full"
            );
          }
          localStorage.setItem("prefoneAccessLevel", level);
        }

        function handlePrefoneLaunch(target) {
          if (!state.prefoneAccess || state.prefoneAccess === "none") {
            showToast("You do not have access to Preform One resources.");
            return;
          }
          if (target === "dashboard" && state.prefoneAccess !== "full") {
            showToast(
              "Only the Class 7 Preform One teacher can open the full dashboard."
            );
            return;
          }
          const routes = {
            dashboard: "preformonehtml/prefonedashboard.html",
            books: "preformonehtml/prefonebooks.html",
            lesson: "preformonehtml/prefonelessonplan.html",
            journal: "preformonehtml/prefoneclassjournal.html",
          };
          const url = routes[target];
          if (!url) {
            showToast("Preform One resource unavailable.");
            return;
          }
          sessionStorage.setItem(
            "prefoneTeacherClass",
            userCtx.className || ""
          );
          sessionStorage.setItem("prefoneTeacherEmail", userCtx.email || "");
          window.location.href = url;
        }

        function openPrefoneHub() {
          if (!state.prefoneAccess || state.prefoneAccess === "none") {
            showToast("Preform One data is restricted to approved classes.");
            return;
          }
          scrollToId("prefone-section");
          if (els.prefoneSection) {
            els.prefoneSection.classList.add("ring-4", "ring-sky-300/60");
            setTimeout(
              () =>
                els.prefoneSection &&
                els.prefoneSection.classList.remove(
                  "ring-4",
                  "ring-sky-300/60"
                ),
              1600
            );
          }
        }

        async function resolveFirstPath(paths) {
          for (const p of paths) {
            try {
              const snap = await db.ref(p).limitToFirst(1).get();
              if (snap && snap.exists && snap.exists()) return p;
            } catch (err) {
              // ignore
            }
          }
          return null;
        }

        function mergeFeesIntoStudents() {
          let required = 0;
          let paid = 0;
          let balance = 0;
          let clearedCount = 0;
          let owingCount = 0;
          state.students.forEach((student) => {
            const feeRec = state.fees[student.lookupKey];
            if (feeRec) {
              student.feeDue = feeRec.required;
              student.feePaid = feeRec.paid;
              student.balance = feeRec.balance;
            } else {
              student.balance = Math.max(
                0,
                (student.feeDue || 0) - (student.feePaid || 0)
              );
            }
            required += student.feeDue || 0;
            paid += student.feePaid || 0;
            if (student.balance > 0.5) {
              balance += student.balance;
              owingCount += 1;
            } else {
              clearedCount += 1;
            }
          });
          state.financeTotals = {
            required,
            paid,
            balance,
            cleared: clearedCount,
            owing: owingCount,
          };
        }

        function handleBooksSnapshot(data) {
          const rows = [];
          let haveTotal = 0;
          let requiredTotal = 0;
          Object.entries(data).forEach(([id, book]) => {
            if (!book || typeof book !== "object") return;
            const title = book.title || id;
            const subject = book.subject || book.topic || "-";
            const have = toNumber(
              book.haveCount ||
                book.have ||
                (book.studentsWithBook
                  ? Object.keys(book.studentsWithBook).length
                  : 0)
            );
            const required = toNumber(
              book.required || book.totalNeeded || book.expected || 0
            );
            const missing = required
              ? Math.max(0, required - have)
              : toNumber(
                  book.missingCount || book.missing || book.shortage || 0
                );
            rows.push({ id, title, subject, have, missing });
            haveTotal += have;
            requiredTotal += required || have + missing;
          });
          rows.sort((a, b) => b.missing - a.missing);
          state.books = data;
          state.booksRows = rows;
          const coverage = requiredTotal
            ? Math.round((haveTotal / requiredTotal) * 100)
            : rows.length
            ? 100
            : 0;
          const totalMissing = rows.reduce((sum, row) => sum + row.missing, 0);
          state.booksSummary = { coveragePct: coverage, totalMissing };
          scheduleRender();
        }

        function handleInventorySnapshot(data) {
          state.inventory = data;
          const items = [];
          Object.entries(data).forEach(([key, value]) => {
            if (value == null) return;
            let total = 0;
            let available = 0;
            let damaged = 0;
            if (typeof value === "number") {
              total = toNumber(value);
              available = total;
            } else if (typeof value === "object") {
              total = toNumber(
                value.total || value.count || value.expected || 0
              );
              available = toNumber(
                value.available || value.good || value.inUse || 0
              );
              damaged = toNumber(
                value.damaged ||
                  value.broken ||
                  value.needingRepair ||
                  value.missing ||
                  0
              );
              if (!total && (available || damaged)) total = available + damaged;
            }
            items.push({ name: prettifyKey(key), total, available, damaged });
          });
          items.sort((a, b) => b.total - a.total);
          state.inventoryItems = items;
          scheduleRender();
        }

        function updateTodaysTotals() {
          const now = new Date();
          const dateKey = now.toISOString().slice(0, 10);
          const monthKey = dateKey.slice(0, 7);
          const monthObj = state.attendance[monthKey] || {};
          const todayObj = monthObj[dateKey] || {};
          let present = 0;
          let absent = 0;
          let partial = 0;
          let special = 0;
          const reasons = {};
          const recorded = Object.keys(todayObj || {}).length;

          Object.values(todayObj).forEach((rec) => {
            const status = classifyAttendance(rec);
            if (status === "present") present += 1;
            else if (status === "absent") {
              absent += 1;
              const note =
                rec.reason ||
                rec.note ||
                rec.notes ||
                rec.explain ||
                "No reason shared";
              reasons[note] = (reasons[note] || 0) + 1;
            } else if (status === "special") {
              special += 1;
              const note =
                rec.reason || rec.code || rec.am || rec.pm || "Special code";
              reasons[note] = (reasons[note] || 0) + 1;
            } else {
              partial += 1;
            }
          });

          state.todays = {
            present,
            absent,
            partial,
            special,
            reasons,
            recorded,
          };
          evaluateCompliance();
        }

        function refreshAlerts() {
          const alerts = [];
          const shiftedKeys = new Set(
            Object.keys(state.shifted || {}).map(normalizeAdm)
          );

          state.students.forEach((student) => {
            const { streak, lastDate, reason } =
              calculateAbsenceStreak(student);
            if (
              streak >= CLASS_ALERT_ABSENCE_DAYS &&
              !shiftedKeys.has(student.lookupKey)
            ) {
              alerts.push({
                type: "attendance",
                student,
                streak,
                lastDate,
                reason: reason || "Not provided",
              });
            }
          });

          state.students
            .filter((student) => (student.balance || 0) > 0)
            .sort((a, b) => b.balance - a.balance)
            .slice(0, 3)
            .forEach((student) => {
              alerts.push({
                type: "finance",
                student,
                balance: student.balance,
              });
            });

          const disciplineEntries = Array.isArray(state.discipline)
            ? state.discipline
            : Object.values(state.discipline || {});
          disciplineEntries
            .sort((a, b) => (b.time || 0) - (a.time || 0))
            .slice(0, 3)
            .forEach((incident) => {
              alerts.push({
                type: "discipline",
                incident,
                student: findStudentByAny(
                  incident.adm ||
                    incident.studentAdm ||
                    incident.admission ||
                    incident.studentId
                ),
                recordedAt: incident.time || incident.date || "",
              });
            });

          state.alerts = alerts;
        }

        function scheduleRender() {
          if (renderPending) return;
          renderPending = true;
          window.requestAnimationFrame(() => {
            renderPending = false;
            renderDashboard();
          });
        }

        function renderDashboard() {
          renderMetrics();
          renderReasons();
          renderLastFive();
          renderAttendanceTrend();
          renderGenderChart();
          renderStudentSpotlight();
          renderFinanceSection();
          renderInventorySection();
          renderBooksSection();
          renderResponsibilities();
          renderAlerts();
        }

        function renderMetrics() {
          const total = state.students.length;
          const present = state.todays.present || 0;
          const absent = state.todays.absent || 0;
          const special = state.todays.special || 0;

          if (els.summaryPresent) {
            els.summaryPresent.textContent = formatNumber(present);
            const pct = total ? Math.round((present / total) * 100) : 0;
            els.presentSub.textContent = total
              ? `${pct}% of class recorded`
              : "Awaiting roll call";
          }
          if (els.summaryAbsent) {
            els.summaryAbsent.textContent = formatNumber(absent);
            if (absent) {
              els.absentSub.textContent = `${absent} learner${
                absent > 1 ? "s" : ""
              } flagged for follow-up`;
            } else if (special) {
              els.absentSub.textContent = `${special} special codes (S/LE/MT)`;
            } else {
              els.absentSub.textContent = "No absentees recorded";
            }
          }
          if (els.summaryAlerts) {
            els.summaryAlerts.textContent = formatNumber(state.alerts.length);
            els.alertsSub.textContent = state.alerts.length
              ? "Review and close pending actions"
              : "All pupils accounted for";
          }
          if (els.summaryOutstanding) {
            els.summaryOutstanding.textContent = formatCurrency(
              state.financeTotals.balance
            );
            els.outstandingSub.textContent = state.financeTotals.owing
              ? `${state.financeTotals.owing} learner${
                  state.financeTotals.owing > 1 ? "s" : ""
                } owing`
              : "Everyone cleared";
          }
          if (els.summaryTotal) {
            els.summaryTotal.textContent = formatNumber(total);
            els.populationSub.textContent = total
              ? "Registered in this class"
              : "Loading registry...";
          }
          if (els.summaryBoys) {
            const boys = state.students.filter((s) => s.gender === "M").length;
            const girls = state.students.filter((s) => s.gender === "F").length;
            els.summaryBoys.textContent = formatNumber(boys);
            if (els.summaryGirls)
              els.summaryGirls.textContent = formatNumber(girls);
          }
          if (els.summaryCleared) {
            els.summaryCleared.textContent = formatNumber(
              state.financeTotals.cleared
            );
          }
          if (els.summaryDiscipline) {
            const count = Array.isArray(state.discipline)
              ? state.discipline.length
              : Object.keys(state.discipline || {}).length;
            els.summaryDiscipline.textContent = formatNumber(count);
          }
        }

        function renderReasons() {
          if (!els.reasonsList) return;
          els.reasonsList.innerHTML = "";
          const entries = Object.entries(state.todays.reasons || {}).filter(
            ([, count]) => count > 0
          );
          if (!entries.length) {
            const empty = document.createElement("div");
            empty.className = "empty-state";
            empty.textContent =
              "No reasons captured yet. Update attendance remarks for quick insight.";
            els.reasonsList.appendChild(empty);
            return;
          }
          entries.sort((a, b) => b[1] - a[1]);
          entries.slice(0, 6).forEach(([reason, count]) => {
            const block = document.createElement("div");
            block.className =
              "glass-card bg-white/80 border border-white/70 rounded-2xl p-4 flex items-center gap-4";
            block.innerHTML = `
            <div class="w-12 h-12 rounded-xl bg-rose-100 text-rose-600 grid place-items-center font-semibold">${count}</div>
            <div>
              <p class="text-sm font-semibold text-slate-700">${reason}</p>
              <p class="text-xs text-slate-500">Learners impacted today</p>
            </div>
          `;
            els.reasonsList.appendChild(block);
          });
        }

        function renderLastFive() {
          if (!els.lastFive) return;
          els.lastFive.innerHTML = "";
          const summaries = getRecentAttendanceSummaries(5);
          if (!summaries.length) {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="4" class="text-xs text-slate-500 py-6">No historical attendance stored yet.</td>`;
            els.lastFive.appendChild(row);
            return;
          }
          summaries.forEach((entry) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${formatDate(entry.date)}</td>
            <td>${formatNumber(entry.present)}</td>
            <td>${formatNumber(entry.absent)}</td>
            <td>${formatNumber(entry.special)}</td>
          `;
            els.lastFive.appendChild(row);
          });
        }

        function renderAttendanceTrend() {
          const canvas = document.getElementById("attendanceTrendChart");
          if (!canvas) return;
          const monthKeys = Object.keys(state.attendance || {}).sort();
          const recent = monthKeys.slice(-6);
          if (!recent.length) {
            if (charts.attendance) {
              charts.attendance.destroy();
              charts.attendance = null;
            }
            return;
          }
          const data = recent.map((month) => {
            const days = state.attendance[month] || {};
            let present = 0;
            let total = 0;
            Object.values(days).forEach((day) => {
              Object.values(day || {}).forEach((rec) => {
                const status = classifyAttendance(rec);
                if (status === "present") present += 1;
                total += 1;
              });
            });
            return total ? Math.round((present / total) * 100) : 0;
          });
          const ctx = canvas.getContext("2d");
          if (charts.attendance) charts.attendance.destroy();
          charts.attendance = new Chart(ctx, {
            type: "line",
            data: {
              labels: recent.map((m) => formatMonthLabel(m)),
              datasets: [
                {
                  label: "Presence %",
                  data,
                  borderColor: "#2563eb",
                  backgroundColor: "rgba(37,99,235,0.18)",
                  tension: 0.35,
                  fill: true,
                  pointRadius: 3,
                  pointBackgroundColor: "#2563eb",
                },
              ],
            },
            options: {
              scales: {
                y: { beginAtZero: true, max: 100 },
              },
              plugins: {
                legend: { display: false },
              },
            },
          });
        }

        function renderGenderChart() {
          const canvas = document.getElementById("genderChart");
          if (!canvas) return;
          const boys = state.students.filter((s) => s.gender === "M").length;
          const girls = state.students.filter((s) => s.gender === "F").length;
          const other = state.students.length - (boys + girls);
          const ctx = canvas.getContext("2d");
          if (charts.gender) charts.gender.destroy();
          charts.gender = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Boys", "Girls", "Other"],
              datasets: [
                {
                  data: [boys, girls, Math.max(0, other)],
                  backgroundColor: ["#38bdf8", "#f472b6", "#cbd5f5"],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              cutout: "70%",
              plugins: {
                legend: { position: "bottom", labels: { boxWidth: 12 } },
              },
            },
          });
        }

        function renderStudentSpotlight() {
          if (!els.studentSpotlightBody) return;
          els.studentSpotlightBody.innerHTML = "";
          if (!state.students.length) {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="5" class="text-xs text-slate-500 py-6">Student profile loading...</td>`;
            els.studentSpotlightBody.appendChild(row);
            return;
          }
          const filtered = state.students
            .filter((student) => {
              if (!searchTerm) return true;
              return (
                student.name.toLowerCase().includes(searchTerm) ||
                (student.adm || "").toLowerCase().includes(searchTerm) ||
                (student.parent || "").toLowerCase().includes(searchTerm) ||
                (student.contact || "").toLowerCase().includes(searchTerm)
              );
            })
            .sort((a, b) => b.balance - a.balance)
            .slice(0, 8);

          if (!filtered.length) {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="5" class="text-xs text-slate-500 py-6">No students match your search.</td>`;
            els.studentSpotlightBody.appendChild(row);
            return;
          }

          filtered.forEach((student) => {
            const latest = getLatestAttendanceSummary(student);
            const row = document.createElement("tr");
            row.className = "cursor-pointer hover:bg-white/70 transition";
            row.setAttribute("data-student", student.lookupKey);
            row.innerHTML = `
            <td>
              <div class="font-semibold text-slate-700">${student.name}</div>
              <div class="text-xs text-slate-400">ADM ${
                student.adm || student.id
              }</div>
            </td>
            <td>${
              student.parent || '<span class="text-xs text-slate-400">-</span>'
            }</td>
            <td>${
              student.contact || '<span class="text-xs text-slate-400">-</span>'
            }</td>
            <td class="${
              student.balance > 0
                ? "text-rose-600 font-semibold"
                : "text-emerald-600"
            }">${formatCurrency(student.balance)}</td>
            <td><span class="status-pill ${latest.statusClass}">${
              latest.statusLabel
            }</span></td>
          `;
            els.studentSpotlightBody.appendChild(row);
          });
        }

        function renderFinanceSection() {
          renderFinanceChart();
          if (!els.financeWatchBody) return;
          els.financeWatchBody.innerHTML = "";
          const owing = state.students
            .filter((s) => s.balance > 0.5)
            .sort((a, b) => b.balance - a.balance)
            .slice(0, 5);
          if (!owing.length) {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="4" class="text-xs text-slate-500 py-6">All learners are cleared. Great job!</td>`;
            els.financeWatchBody.appendChild(row);
            return;
          }
          owing.forEach((student) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>
              <div class="font-semibold text-slate-700">${student.name}</div>
              <div class="text-xs text-slate-400">ADM ${
                student.adm || student.id
              }</div>
            </td>
            <td class="text-rose-600 font-semibold">${formatCurrency(
              student.balance
            )}</td>
            <td>${
              student.parent || '<span class="text-xs text-slate-400">-</span>'
            }</td>
            <td>${
              student.contact || '<span class="text-xs text-slate-400">-</span>'
            }</td>
          `;
            els.financeWatchBody.appendChild(row);
          });
        }

        function renderFinanceChart() {
          const canvas = document.getElementById("financeChart");
          if (!canvas) return;
          const ctx = canvas.getContext("2d");
          const cleared = state.financeTotals.cleared || 0;
          const owing = state.financeTotals.owing || 0;
          if (charts.finance) charts.finance.destroy();
          charts.finance = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: ["Cleared", "Owing"],
              datasets: [
                {
                  data: [cleared, owing],
                  backgroundColor: ["#10b981", "#f97316"],
                  borderWidth: 0,
                },
              ],
            },
            options: {
              cutout: "72%",
              plugins: {
                legend: { position: "bottom", labels: { boxWidth: 12 } },
              },
            },
          });
        }

        function renderInventorySection() {
          const canvas = document.getElementById("inventoryChart");
          if (!canvas) return;
          const ctx = canvas.getContext("2d");
          if (!state.inventoryItems || !state.inventoryItems.length) {
            if (els.inventoryList) {
              els.inventoryList.innerHTML =
                '<li class="empty-state">No inventory data yet. Capture desks, chairs, and supplies.</li>';
            }
            if (charts.inventory) {
              charts.inventory.destroy();
              charts.inventory = null;
            }
            return;
          }

          if (els.inventoryList) {
            els.inventoryList.innerHTML = "";
            state.inventoryItems.slice(0, 6).forEach((item) => {
              const li = document.createElement("li");
              const utilisation = item.total
                ? Math.round((item.available / item.total) * 100)
                : 0;
              li.innerHTML = `
              <div class="flex items-center justify-between">
                <div>
                  <div class="font-semibold text-slate-700">${item.name}</div>
                  <div class="text-xs text-slate-400">${formatNumber(
                    item.available
                  )} available  ${formatNumber(
                item.damaged
              )} needing repair</div>
                </div>
                <div class="text-sm font-semibold text-slate-600">${utilisation}%</div>
              </div>
            `;
              els.inventoryList.appendChild(li);
            });
          }

          const labels = state.inventoryItems
            .slice(0, 6)
            .map((item) => item.name);
          const totals = state.inventoryItems
            .slice(0, 6)
            .map((item) => item.total);
          const available = state.inventoryItems
            .slice(0, 6)
            .map((item) => item.available);
          if (charts.inventory) charts.inventory.destroy();
          charts.inventory = new Chart(ctx, {
            type: "bar",
            data: {
              labels,
              datasets: [
                {
                  label: "Total",
                  data: totals,
                  backgroundColor: "rgba(99,102,241,0.25)",
                  borderRadius: 8,
                },
                {
                  label: "Available",
                  data: available,
                  backgroundColor: "rgba(34,197,94,0.65)",
                  borderRadius: 8,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: { legend: { display: true } },
              scales: { y: { beginAtZero: true } },
            },
          });
        }

        function renderBooksSection() {
          if (els.booksCoverage) {
            els.booksCoverage.textContent = state.booksSummary.coveragePct
              ? `${state.booksSummary.coveragePct}%`
              : "-";
            els.booksCoverageSub.textContent = state.booksSummary.totalMissing
              ? `${state.booksSummary.totalMissing} copies missing`
              : "All learners have required books";
          }
          if (!els.booksCoverageBody) return;
          els.booksCoverageBody.innerHTML = "";
          if (!state.booksRows || !state.booksRows.length) {
            const row = document.createElement("tr");
            row.innerHTML = `<td colspan="4" class="text-xs text-slate-500 py-6">No book data found. Upload class books to start tracking.</td>`;
            els.booksCoverageBody.appendChild(row);
            return;
          }
          state.booksRows.slice(0, 6).forEach((book) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${book.title}</td>
            <td>${book.subject}</td>
            <td>${formatNumber(book.have)}</td>
            <td class="${
              book.missing > 0
                ? "text-rose-600 font-semibold"
                : "text-emerald-600"
            }">${formatNumber(book.missing)}</td>
          `;
            els.booksCoverageBody.appendChild(row);
          });
        }

        function renderAlerts() {
          if (!els.alertList) return;
          els.alertList.innerHTML = "";
          if (!state.alerts.length) {
            const empty = document.createElement("div");
            empty.className = "empty-state";
            empty.textContent =
              "No alerts at the moment. Keep the momentum going!";
            els.alertList.appendChild(empty);
            return;
          }
          state.alerts.forEach((alert) => {
            const card = document.createElement("div");
            card.className = "alert-card";
            if (alert.type === "attendance") {
              card.innerHTML = `
              <div class="alert-type"><i class="fas fa-person-circle-exclamation"></i></div>
              <div class="flex-1">
                <div class="flex items-center justify-between">
                  <h4 class="text-sm font-semibold text-rose-600">${
                    alert.student?.name || "Learner"
                  } - ${alert.streak} days absent</h4>
                  <span class="text-xs text-slate-500">${formatDate(
                    alert.lastDate
                  )}</span>
                </div>
                <p class="text-sm text-slate-600 mt-1">Reason: ${
                  alert.reason || "Not captured"
                }</p>
                <div class="mt-3 flex gap-3">
                  <button class="px-3 py-2 bg-rose-500 text-white rounded-lg text-xs font-semibold" data-shift="${
                    alert.student?.lookupKey || ""
                  }"><i class="fas fa-share-from-square mr-1"></i>Mark shifted</button>
                  <a class="px-3 py-2 bg-white text-rose-500 rounded-lg border border-rose-200 text-xs font-semibold" href="tel:${
                    alert.student?.contact || ""
                  }"><i class="fas fa-phone-volume mr-1"></i>Call guardian</a>
                </div>
              </div>
            `;
            } else if (alert.type === "finance") {
              card.innerHTML = `
              <div class="alert-type"><i class="fas fa-sack-dollar"></i></div>
              <div class="flex-1">
                <div class="flex items-center justify-between">
                  <h4 class="text-sm font-semibold text-amber-600">${
                    alert.student?.name || "Learner"
                  } - High balance</h4>
                  <span class="text-xs text-slate-500">Finance</span>
                </div>
                <p class="text-sm text-slate-600 mt-1">Outstanding: ${formatCurrency(
                  alert.balance
                )}</p>
                <p class="text-xs text-slate-500 mt-1">${
                  alert.student?.parent || "Guardian not set"
                }  ${alert.student?.contact || "No contact"}</p>
              </div>
            `;
            } else if (alert.type === "discipline") {
              card.innerHTML = `
              <div class="alert-type"><i class="fas fa-exclamation"></i></div>
              <div class="flex-1">
                <div class="flex items-center justify-between">
                  <h4 class="text-sm font-semibold text-slate-700">Discipline case - ${
                    alert.incident?.studentName ||
                    alert.student?.name ||
                    "Learner"
                  }</h4>
                  <span class="text-xs text-slate-500">${formatDate(
                    alert.recordedAt
                  )}</span>
                </div>
                <p class="text-sm text-slate-600 mt-1">${
                  alert.incident?.issue ||
                  alert.incident?.reason ||
                  "See discipline log for details."
                }</p>
              </div>
            `;
            }
            els.alertList.appendChild(card);
          });
        }

        function openStudentModal(lookupKey) {
          if (!lookupKey) return;
          const student = state.studentIndex.get(lookupKey);
          if (!student) return;
          pendingShiftStudent = student;
          const latest = getLatestAttendanceSummary(student);
          const modal = els.studentModal;
          if (!modal) return;
          els.studentModalBody.innerHTML = `
          <div class="space-y-5">
            <div>
              <h3 class="text-2xl font-semibold text-slate-800">${
                student.name
              }</h3>
              <p class="text-sm text-slate-500">ADM ${
                student.adm || student.id
              }  ${student.classLabel}</p>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="glass-card bg-white/70 border border-white/60 p-4">
                <p class="text-xs uppercase tracking-[0.18em] text-slate-500 mb-2">Guardian</p>
                <p class="text-sm font-semibold text-slate-700">${
                  student.parent || "Not provided"
                }</p>
                <p class="text-xs text-slate-500">${
                  student.contact || "No contact number"
                }</p>
              </div>
              <div class="glass-card bg-white/70 border border-white/60 p-4">
                <p class="text-xs uppercase tracking-[0.18em] text-slate-500 mb-2">Finance</p>
                <p class="text-sm text-slate-700">Due: ${formatCurrency(
                  student.feeDue
                )}</p>
                <p class="text-sm text-slate-700">Paid: ${formatCurrency(
                  student.feePaid
                )}</p>
                <p class="text-sm font-semibold ${
                  student.balance > 0 ? "text-rose-600" : "text-emerald-600"
                }">Balance: ${formatCurrency(student.balance)}</p>
              </div>
            </div>
            <div class="glass-card bg-white/70 border border-white/60 p-4">
              <p class="text-xs uppercase tracking-[0.18em] text-slate-500 mb-2">Attendance trail</p>
              <p class="text-sm text-slate-700">${latest.summary}</p>
              <p class="text-xs text-slate-500 mt-1">${latest.detail}</p>
            </div>
            <div class="flex flex-wrap gap-3">
              <button class="px-4 py-2 bg-gradient-to-r from-amber-500 to-rose-500 text-white rounded-xl font-semibold" data-shift="${
                student.lookupKey
              }"><i class="fas fa-share-from-square mr-2"></i>Mark shifted</button>
              <a class="px-4 py-2 border border-slate-300 rounded-xl text-slate-600" href="tel:${
                student.contact || ""
              }"><i class="fas fa-phone mr-2"></i>Call guardian</a>
            </div>
          </div>
        `;
          modal.classList.add("show");
        }

        function openShiftModal(student) {
          pendingShiftStudent = student;
          if (!els.shiftModal) return;
          els.shiftReason.value = "";
          els.shiftStudentName.textContent = student.name;
          els.shiftStudentInfo.textContent = `ADM ${
            student.adm || student.id
          }  ${student.classLabel}`;
          els.shiftModal.classList.add("show");
        }

        function hideModal(modal) {
          if (!modal) return;
          modal.classList.remove("show");
        }

        function showToast(message) {
          if (!els.toast) return;
          els.toast.textContent = message;
          els.toast.style.display = "block";
          setTimeout(() => {
            els.toast.style.display = "none";
          }, 2800);
        }

        function classifyAttendance(rec) {
          if (!rec) return "unknown";
          const am = String(rec.am || "").toUpperCase();
          const pm = String(rec.pm || "").toUpperCase();
          const daily = String(rec.daily || "").toUpperCase();
          const combo = daily || am + pm;
          if ((am === "P" && pm === "P") || combo === "P") return "present";
          if (combo.includes("A") && !combo.includes("P")) return "absent";
          if (
            combo.includes("S") ||
            combo.includes("LE") ||
            combo.includes("MT") ||
            combo.includes("PG")
          )
            return "special";
          if (combo.includes("A") && combo.includes("P")) return "partial";
          return "partial";
        }

        function getRecentAttendanceSummaries(limit) {
          const dates = getRecentAttendanceDates(limit);
          return dates.map((date) => {
            const monthKey = date.slice(0, 7);
            const dayObj = (state.attendance[monthKey] || {})[date] || {};
            let present = 0;
            let absent = 0;
            let special = 0;
            Object.values(dayObj).forEach((rec) => {
              const status = classifyAttendance(rec);
              if (status === "present") present += 1;
              else if (status === "absent") absent += 1;
              else if (status === "special") special += 1;
            });
            return { date, present, absent, special };
          });
        }

        function getRecentAttendanceDates(limit = 10) {
          const dates = [];
          Object.entries(state.attendance || {}).forEach(([month, days]) => {
            Object.keys(days || {}).forEach((date) => dates.push(date));
          });
          dates.sort((a, b) => b.localeCompare(a));
          return limit ? dates.slice(0, limit) : dates;
        }

        function getLatestAttendanceSummary(student) {
          const dates = getRecentAttendanceDates(30);
          for (const date of dates) {
            const rec = findAttendanceRecordByStudent(date, student);
            if (rec) {
              const status = classifyAttendance(rec);
              const mapping = {
                present: {
                  label: "Present",
                  cls: "present",
                  detail: `Present on ${formatDate(date)}`,
                },
                absent: {
                  label: "Absent",
                  cls: "absent",
                  detail: `Absent on ${formatDate(date)} (${
                    rec.reason || "No reason provided"
                  })`,
                },
                special: {
                  label: "Special",
                  cls: "special",
                  detail: `Special code ${
                    rec.am || rec.pm || rec.daily || ""
                  } on ${formatDate(date)}`,
                },
                partial: {
                  label: "Partial",
                  cls: "special",
                  detail: `Partial attendance on ${formatDate(date)}`,
                },
              };
              const meta = mapping[status] || {
                label: "Unknown",
                cls: "special",
                detail: "Status not recorded",
              };
              return {
                statusLabel: meta.label,
                statusClass: meta.cls,
                summary: meta.detail,
                detail: rec.reason || rec.note || "",
              };
            }
          }
          return {
            statusLabel: "No data",
            statusClass: "special",
            summary: "No attendance history recorded yet.",
            detail: "",
          };
        }

        function findAttendanceRecordByStudent(date, student) {
          if (!date || !student) return null;
          const monthKey = date.slice(0, 7);
          const month = state.attendance[monthKey] || {};
          const day = month[date] || {};
          const candidates = [student.id, student.adm, student.lookupKey];
          for (const key of candidates) {
            if (key && day[key]) return day[key];
            const norm = normalizeAdm(key);
            if (norm && day[norm]) return day[norm];
          }
          return null;
        }

        function calculateAbsenceStreak(student) {
          const dates = getRecentAttendanceDates(30);
          let streak = 0;
          let lastDate = null;
          let reason = "";
          for (const date of dates) {
            const rec = findAttendanceRecordByStudent(date, student);
            if (!rec) break;
            const status = classifyAttendance(rec);
            if (status === "absent") {
              streak += 1;
              if (!lastDate) {
                lastDate = date;
                reason = rec.reason || rec.note || rec.notes || "Not captured";
              }
            } else {
              break;
            }
          }
          return { streak, lastDate, reason };
        }

        function getShiftedPath() {
          if (pathCache.shifted) return pathCache.shifted;
          return `shiftedStudents/${userCtx.safeClassKey}`;
        }

        function findStudentByAny(identifier) {
          if (!identifier) return null;
          const lookup = normalizeAdm(identifier);
          return state.studentIndex.get(lookup) || null;
        }

        function toNumber(value) {
          const num = Number(value);
          return Number.isFinite(num) ? num : 0;
        }

        function normalizeClassName(str) {
          return String(str || "")
            .toUpperCase()
            .replace(/[\s\-\._]/g, "");
        }

        function normalizeAdm(adm) {
          return String(adm || "")
            .toUpperCase()
            .replace(/[^A-Z0-9]/g, "");
        }

        function normalizeGender(val) {
          const g = String(val || "")
            .trim()
            .toUpperCase();
          if (!g) return "";
          if (g.startsWith("M") || g === "BOY" || g === "MALE") return "M";
          if (g.startsWith("F") || g === "GIRL" || g === "FEMALE") return "F";
          return "O";
        }

        function prettifyKey(key) {
          return String(key || "")
            .replace(/[_\-]/g, " ")
            .replace(/\b\w/g, (ch) => ch.toUpperCase());
        }

        function formatNumber(value) {
          return Number.isFinite(value) ? value.toLocaleString() : "-";
        }

        function formatCurrency(value) {
          const amount = Math.round(Number(value) || 0);
          return "TZS " + amount.toLocaleString();
        }

        function formatDate(dateStr) {
          if (!dateStr) return "-";
          const d = new Date(dateStr);
          if (Number.isNaN(d.getTime())) return dateStr;
          return d.toLocaleDateString("en-US", {
            day: "numeric",
            month: "short",
            year: "numeric",
          });
        }

        function formatMonthLabel(monthKey) {
          const parts = monthKey.split("-");
          if (parts.length !== 2) return monthKey;
          const month = Number(parts[1]) - 1;
          const year = Number(parts[0]);
          const date = new Date(year, month, 1);
          return date.toLocaleDateString("en-US", {
            month: "short",
            year: "numeric",
          });
        }

        function getDateKey(offsetDays = 0) {
          const date = new Date();
          date.setHours(0, 0, 0, 0);
          date.setDate(date.getDate() + offsetDays);
          return date.toISOString().slice(0, 10);
        }

        function getTodayKey() {
          return getDateKey(0);
        }

        function isHoliday(date) {
          const monthDay = `${String(date.getMonth() + 1).padStart(
            2,
            "0"
          )}-${String(date.getDate()).padStart(2, "0")}`;
          if (FIXED_HOLIDAYS.includes(monthDay)) return true;
          const iso = date.toISOString().slice(0, 10);
          return MOVABLE_HOLIDAYS.includes(iso);
        }

        function isWorkday(date) {
          const day = date.getDay();
          return day !== 0 && !isHoliday(date); // Sunday off by default
        }

        function refreshResponsibilitiesForNewDay() {
          const todayKey = getTodayKey();
          if (
            state.responsibilities.currentKey &&
            state.responsibilities.currentKey !== todayKey &&
            !state.responsibilities.refreshing
          ) {
            state.responsibilities.refreshing = true;
            ensureDailyResponsibilities()
              .then(() => {
                subscribeResponsibilities();
              })
              .catch((err) =>
                console.error("refresh responsibilities", err && err.message)
              )
              .then(() => {
                state.responsibilities.refreshing = false;
              });
          }
        }

        function scrollToId(id) {
          if (!id) return;
          const node = document.getElementById(id);
          if (node) node.scrollIntoView({ behavior: "smooth", block: "start" });
        }

        function lockClassAttendance() {
          if (!userCtx.className) return;
          sessionStorage.setItem("lockedClassAttendance", userCtx.className);
          sessionStorage.setItem("lockedClassTeacher", userCtx.email || "");
        }

        function evaluateCompliance() {
          refreshResponsibilitiesForNewDay();
          if (!userCtx.safeEmail) {
            clearPenaltyOverlay();
            return;
          }
          const now = new Date();
          if (!isWorkday(now)) {
            clearPenaltyOverlay();
            return;
          }
          const minutes = now.getHours() * 60 + now.getMinutes();
          const totalStudents = state.students.length;
          const attendanceComplete =
            totalStudents === 0 ||
            (state.todays.recorded || 0) >= totalStudents;
          const missingTasks = missingResponsibilityIds();
          const responsibilitiesComplete = missingTasks.length === 0;

          // Keep background penalties in state but remove the blocking overlay so staff can continue working.
          state.penalties.attendance = false;
          state.penalties.responsibilities = false;
          clearPenaltyOverlay();

          const previousPenaltyActive =
            state.responsibilities.prevPenalty &&
            state.responsibilities.prevPenalty.missedTasks &&
            state.responsibilities.prevPenalty.missedTasks.length;
          const postCutoffWindow =
            !responsibilitiesComplete &&
            minutes >= RESPONSIBILITY_CUTOFF_MINUTES;
          const earlyMorningWindow =
            previousPenaltyActive && minutes < RESPONSIBILITY_RESET_MINUTES;

          if (
            !attendanceComplete &&
            minutes >= ATTENDANCE_DEADLINE_MINUTES &&
            minutes < 24 * 60
          ) {
            state.penalties.attendance = true;
          }

          if (
            (!responsibilitiesComplete && postCutoffWindow) ||
            earlyMorningWindow
          ) {
            state.penalties.responsibilities = true;
          }

          if (
            postCutoffWindow &&
            !responsibilitiesComplete &&
            !state.responsibilities.meta.penaltyLogged
          ) {
            recordResponsibilityPenalty(missingTasks);
          }
        }

        function clearPenaltyOverlay() {
          document.body.classList.remove("attendance-overdue");
          document.body.removeAttribute("data-alert-msg");
        }

        window.navigateTo = function (page) {
          if (page === "prefone") {
            openPrefoneHub();
            return;
          }
          if (page === "responsibilities") {
            scrollToId("responsibilities-center");
            return;
          }
          if (page === "followups") {
            scrollToId("alert-center");
            return;
          }
          if (page === "classattendance") {
            lockClassAttendance();
            const classParam = encodeURIComponent(userCtx.className || "");
            window.location.href =
              "Toattendancehtml/classattendance.html?class=" + classParam;
            return;
          }
          if (page === "academic" && userCtx.className) {
            sessionStorage.setItem("assignedClass", userCtx.className);
          }
          const map = {
            discipline: "dashboard.html#discipline",
            studentlist: "ToSchoolerp/studentlist.html",
            academic: "academic.html",
            finance: "Tofinancehtml/receipt.html",
            books: "Bookshtml/classbook.html",
          };
          const target = map[page] || page;
          if (target.startsWith("#")) {
            scrollToId(target.replace("#", ""));
            return;
          }
          window.location.href = target;
        };

        window.logout = function () {
          auth.signOut().then(() => (window.location.href = "index.html"));
        };
      })();
    </script>
  </body>
</html>
