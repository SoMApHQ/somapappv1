<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SoMAp – Payment Approvals Control Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
              display: ["Poppins", "Inter", "system-ui", "sans-serif"],
            },
            colors: {
              somap: {
                midnight: "#020617",
                charcoal: "rgba(15, 23, 42, 0.78)",
                accent: "#38bdf8",
                accent2: "#a855f7",
                success: "#22c55e",
                warning: "#f59e0b",
                danger: "#ef4444",
              },
            },
            boxShadow: {
              glass: "0 30px 80px -45px rgba(8, 47, 73, 0.7)",
              glow: "0 0 0 1px rgba(56, 189, 248, 0.12), 0 18px 60px rgba(15, 23, 42, 0.45)",
            },
            backdropBlur: {
              xs: "6px",
            },
          },
        },
      };
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/js/all.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="yearContext.js"></script>
    <style>
      body {
        min-height: 100vh;
        background:
          radial-gradient(circle at 15% 20%, rgba(168, 85, 247, 0.22), transparent 45%),
          radial-gradient(circle at 85% 10%, rgba(56, 189, 248, 0.24), transparent 40%),
          linear-gradient(135deg, #0f172a 0%, #020617 65%, #111827 100%);
        color: rgba(226, 232, 240, 0.92);
        font-family: 'Inter', system-ui, sans-serif;
      }
      .glass-card {
        background: linear-gradient(145deg, rgba(15, 23, 42, 0.78), rgba(15, 23, 42, 0.62));
        border: 1px solid rgba(148, 163, 184, 0.16);
        border-radius: 1.5rem;
        box-shadow: 0 22px 65px -38px rgba(8, 47, 73, 0.8);
        backdrop-filter: blur(18px);
      }
      .stat-glass {
        position: relative;
        overflow: hidden;
        background: linear-gradient(135deg, rgba(56, 189, 248, 0.18), rgba(168, 85, 247, 0.15));
        border: 1px solid rgba(148, 163, 184, 0.18);
        border-radius: 1.25rem;
        box-shadow: 0 26px 70px -40px rgba(14, 165, 233, 0.6);
        backdrop-filter: blur(16px);
      }
      .stat-glass::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at top right, rgba(236, 254, 255, 0.18), transparent 52%);
        opacity: 0.7;
        pointer-events: none;
      }
      .stat-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.15em;
      }
      .stat-value {
        font-size: 1.9rem;
        font-weight: 700;
        line-height: 1.2;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.45rem;
        padding: 0.25rem 0.7rem;
        border-radius: 999px;
        font-size: 0.72rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .pill-pending {
        background: rgba(56, 189, 248, 0.16);
        border: 1px solid rgba(56, 189, 248, 0.3);
        color: #7dd3fc;
      }
      .pill-approved {
        background: rgba(34, 197, 94, 0.16);
        border: 1px solid rgba(34, 197, 94, 0.3);
        color: #bbf7d0;
      }
      .queued-year-row td {
        background: rgba(16, 185, 129, 0.08);
      }
      .queued-count {
        font-size: 0.6rem;
        font-weight: 600;
        margin-top: 0.35rem;
        color: #bbf7d0;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead th {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        background: rgba(30, 41, 59, 0.72);
        border-bottom: 1px solid rgba(148, 163, 184, 0.18);
        color: rgba(203, 213, 225, 0.88);
        padding: 0.75rem 0.9rem;
      }
      tbody td {
        border-bottom: 1px solid rgba(30, 41, 59, 0.58);
        padding: 0.85rem 0.9rem;
        font-size: 0.82rem;
      }
      tbody tr:nth-child(even) {
        background: rgba(15, 23, 42, 0.45);
      }
      tbody tr:hover {
        background: rgba(56, 189, 248, 0.12);
        transition: background 0.18s ease;
      }
      .history-group {
        border-radius: 1.1rem;
        border: 1px solid rgba(148, 163, 184, 0.16);
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(12px);
      }
      .history-row {
        border-top: 1px solid rgba(148, 163, 184, 0.12);
        padding: 0.75rem 0;
      }
      .history-row:first-of-type {
        border-top: none;
      }
      .tab-active {
        background: rgba(59, 130, 246, 0.18);
        border-color: rgba(59, 130, 246, 0.45);
        color: #bfdbfe;
      }
      .modal-backdrop {
        display: none;
      }
      .modal-backdrop.active {
        display: flex;
      }
    </style>
  </head>
  <body class="pb-24">
    <div class="absolute inset-0 pointer-events-none opacity-65">
      <div class="absolute -top-24 -left-16 w-96 h-96 bg-sky-500/20 blur-3xl rounded-full"></div>
      <div class="absolute bottom-[-160px] right-[-120px] w-[420px] h-[420px] bg-purple-500/10 blur-3xl rounded-full"></div>
    </div>

    <div id="page-loader" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur">
      <div class="flex flex-col items-center gap-4">
        <div class="h-16 w-16 animate-spin rounded-full border-4 border-sky-400/40 border-t-sky-400"></div>
        <p class="text-sm uppercase tracking-[0.35em] text-slate-200/80">Syncing Approvals</p>
      </div>
    </div>

    <div class="relative z-10 mx-auto max-w-7xl px-4 py-10 md:px-8">
      <header class="mb-10 flex flex-col gap-6 lg:flex-row lg:items-center lg:justify-between">
        <div>
          <p class="text-xs uppercase tracking-[0.45em] text-slate-300/70">
            Socrates School Admin
          </p>
          <h1 class="font-display text-3xl font-semibold text-slate-100 md:text-4xl">
            Payment Approvals Control Center
          </h1>
          <p class="mt-3 max-w-2xl text-sm text-slate-200/80">
            Review every payment claim before it touches the live ledgers. Approve only after you verify the bank or mobile money statement. Fast, glassy and optimised for low bandwidth.
          </p>
        </div>
          <div class="flex flex-wrap gap-3">
            <label class="flex flex-col rounded-full border border-slate-500/40 bg-slate-900/60 px-5 py-2 text-xs font-semibold uppercase tracking-wide text-slate-300/80 md:flex-row md:items-center md:gap-3 md:rounded-2xl md:px-4 md:py-2">
              <span class="text-[0.65rem] md:text-xs">Academic Year</span>
              <select
                data-somap-year-select
                class="mt-2 rounded-full border border-slate-500/40 bg-slate-900/70 px-3 py-1 text-sm font-semibold text-slate-100 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-400/40 md:mt-0 md:min-w-[120px]"
              >
              </select>
            </label>
            <a
              href="../dashboard.html"
              class="inline-flex items-center gap-2 rounded-full border border-slate-500/40 bg-slate-900/50 px-5 py-2 text-sm font-semibold text-slate-200 transition hover:border-slate-300/60 hover:bg-slate-900/70"
            >
            <i class="fas fa-arrow-left text-sky-300"></i>
            Back to Admin Dashboard
          </a>
          <button
            id="refreshApprovals"
            class="inline-flex items-center gap-2 rounded-full border border-sky-500/50 bg-sky-500/20 px-5 py-2 text-sm font-semibold text-sky-100 transition hover:border-sky-300/70 hover:bg-sky-500/30"
          >
            <i class="fas fa-rotate"></i>
            Refresh Snapshot
          </button>
        </div>
      </header>

      <main class="space-y-10">
        <section>
          <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
            <h2 class="font-display text-xl font-semibold text-slate-100">
              Live Financial Pulse
            </h2>
            <div class="pill pill-pending">
              <i class="fas fa-shield-check"></i>
              Approvals protect your books.
            </div>
          </div>
          <div
            class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"
            id="summaryGrid"
          >
            <article class="stat-glass relative overflow-hidden p-6" data-module="finance">
              <div class="flex items-start justify-between">
                <p class="stat-label text-sky-200/80">School Fees · Finance</p>
                <span class="pill pill-pending" id="finance-pending-count">-- Pending</span>
              </div>
              <h3 class="mt-3 text-2xl font-semibold text-slate-100">Finance Ledger</h3>
              <div class="mt-5 space-y-3 text-sm text-slate-200/90">
                <div class="flex items-baseline justify-between">
                  <span>Total Required</span>
                  <span class="stat-value text-sky-100" id="finance-required">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Approved Collected</span>
                  <span class="stat-value text-emerald-300" id="finance-approved">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Balance Remaining</span>
                  <span class="stat-value text-amber-200" id="finance-balance">--</span>
                </div>
              </div>
            </article>

            <article class="stat-glass relative overflow-hidden p-6" data-module="transport">
              <div class="flex items-start justify-between">
                <p class="stat-label text-sky-200/80">Transport Fees</p>
                <span class="pill pill-pending" id="transport-pending-count">-- Pending</span>
              </div>
              <h3 class="mt-3 text-2xl font-semibold text-slate-100">Transport Wallet</h3>
              <div class="mt-5 space-y-3 text-sm text-slate-200/90">
                <div class="flex items-baseline justify-between">
                  <span>Annual Expected</span>
                  <span class="stat-value text-sky-100" id="transport-required">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Approved Paid</span>
                  <span class="stat-value text-emerald-300" id="transport-approved">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Pending / Debt</span>
                  <span class="stat-value text-amber-200" id="transport-balance">--</span>
                </div>
              </div>
            </article>

            <article class="stat-glass relative overflow-hidden p-6" data-module="prefone">
              <div class="flex items-start justify-between">
                <p class="stat-label text-sky-200/80">Preform One</p>
                <span class="pill pill-pending" id="prefone-pending-count">-- Pending</span>
              </div>
              <h3 class="mt-3 text-2xl font-semibold text-slate-100">Preform One Fees</h3>
              <div class="mt-5 space-y-3 text-sm text-slate-200/90">
                <div class="flex items-baseline justify-between">
                  <span>Total Required</span>
                  <span class="stat-value text-sky-100" id="prefone-required">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Approved Collected</span>
                  <span class="stat-value text-emerald-300" id="prefone-approved">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Balance Remaining</span>
                  <span class="stat-value text-amber-200" id="prefone-balance">--</span>
                </div>
              </div>
            </article>

            <article class="stat-glass relative overflow-hidden p-6" data-module="graduation">
              <div class="flex items-start justify-between">
                <p class="stat-label text-sky-200/80">Graduation Contributions</p>
                <span class="pill pill-pending" id="graduation-pending-count">-- Pending</span>
              </div>
              <h3 class="mt-3 text-2xl font-semibold text-slate-100">Graduation Vault</h3>
              <div class="mt-5 space-y-3 text-sm text-slate-200/90">
                <div class="flex items-baseline justify-between">
                  <span>Target Total</span>
                  <span class="stat-value text-sky-100" id="graduation-required">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Approved So Far</span>
                  <span class="stat-value text-emerald-300" id="graduation-approved">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Still Pending</span>
                  <span class="stat-value text-amber-200" id="graduation-balance">--</span>
                </div>
              </div>
            </article>

            <article class="stat-glass relative overflow-hidden p-6" data-module="fridaymoney">
              <div class="flex items-start justify-between">
                <p class="stat-label text-sky-200/80">Friday Money</p>
                <span class="pill pill-pending" id="friday-pending-count">-- Pending</span>
              </div>
              <h3 class="mt-3 text-2xl font-semibold text-slate-100">Friday Welfare Fund</h3>
              <div class="mt-5 space-y-3 text-sm text-slate-200/90">
                <div class="flex items-baseline justify-between">
                  <span>This Week Collected</span>
                  <span class="stat-value text-sky-100" id="friday-required">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Approved</span>
                  <span class="stat-value text-emerald-300" id="friday-approved">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Still Pending</span>
                  <span class="stat-value text-amber-200" id="friday-balance">--</span>
                </div>
              </div>
            </article>

            <article class="stat-glass relative overflow-hidden p-6" data-module="joining">
              <div class="flex items-start justify-between">
                <p class="stat-label text-sky-200/80">Joining Applications</p>
                <span class="pill pill-pending" id="joining-pending-count">-- Pending</span>
              </div>
              <h3 class="mt-3 text-2xl font-semibold text-slate-100">Joining Forms</h3>
              <div class="mt-5 space-y-3 text-sm text-slate-200/90">
                <div class="flex items-baseline justify-between">
                  <span>Approved / Verified</span>
                  <span class="stat-value text-emerald-300" id="joining-approved">--</span>
                </div>
                <div class="flex items-baseline justify-between">
                  <span>Pending amount</span>
                  <span class="stat-value text-amber-200" id="joining-balance">--</span>
                </div>
              </div>
            </article>
          </div>
        </section>

        <section class="glass-card p-6 md:p-8">
          <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
            <div>
              <h2 class="font-display text-xl font-semibold text-slate-100">
                Pending Approvals Queue
              </h2>
              <p class="text-sm text-slate-300/80">
                Every payment waiting for your green light. Verify → View details → Approve.
              </p>
            </div>
            <div class="flex flex-wrap gap-3">
              <select
                id="filterModule"
                class="w-44 rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-200 focus:border-sky-400 focus:ring-0"
              >
                <option value="">All Modules</option>
                <option value="joining">Joining Applications</option>
                <option value="finance">School Fees</option>
                <option value="transport">Transport</option>
                <option value="prefonefinance">Preform One</option>
                <option value="graduation">Graduation</option>
                <option value="fridaymoney">Friday Money</option>
              </select>
              <input
                id="filterMonth"
                type="month"
                class="rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-200 focus:border-sky-400 focus:ring-0"
              />
              <div class="relative">
                <i class="fas fa-search absolute left-3 top-2.5 text-xs text-slate-400/80"></i>
                <input
                  id="filterSearch"
                  type="search"
                  placeholder="Search student or ADM"
                  class="w-56 rounded-full border border-slate-500/40 bg-slate-900/60 pl-9 pr-4 py-2 text-sm text-slate-200 focus:border-sky-400 focus:ring-0"
                />
              </div>
            </div>
          </div>

          <div class="mt-6 overflow-x-auto rounded-2xl border border-slate-500/30">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Student</th>
                  <th>Class</th>
                  <th>Parent Contact</th>
                  <th>Source Module</th>
                  <th>Amount Claimed</th>
                  <th>Recorded By</th>
                  <th>Status</th>
                  <th class="text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="pendingBody">
                <tr>
                  <td colspan="9" class="py-12 text-center text-sm text-slate-400">
                    Loading pending approvals...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section>
          <div class="mb-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <h2 class="font-display text-xl font-semibold text-slate-100">
              Approval History
            </h2>
            <div class="flex flex-wrap items-center gap-3">
              <select
                id="historyMonth"
                class="w-44 rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm text-slate-200 focus:border-sky-400 focus:ring-0"
              >
                <option value="">Latest 30 approvals</option>
              </select>
              <button
                id="viewMoreHistory"
                class="inline-flex items-center gap-2 rounded-full border border-slate-500/40 bg-slate-900/60 px-4 py-2 text-sm font-semibold text-slate-200 transition hover:border-slate-300/60 hover:bg-slate-900/80"
              >
                Load Previous Month
              </button>
            </div>
          </div>
          <div id="historyEmpty" class="history-group hidden p-6 text-center text-sm text-slate-300/75">
            No approvals found yet. Once you approve payments they will be logged here for audit trail.
          </div>
          <div id="historyList" class="space-y-5"></div>
        </section>
      </main>
    </div>

    <div
      id="detailModal"
      class="modal-backdrop fixed inset-0 z-40 hidden items-center justify-center bg-black/70 p-4 backdrop-blur"
    >
      <div class="glass-card relative flex flex-col w-full max-w-3xl max-h-[90vh] overflow-hidden border border-slate-500/40">
        <button
          id="closeDetailModal"
          class="absolute right-4 top-4 z-10 text-slate-400 transition hover:text-slate-100"
        >
          <i class="fas fa-times text-xl"></i>
        </button>
        <div id="detailContent" class="flex-1 overflow-y-auto p-6 space-y-4 text-sm text-slate-200"></div>
        <div class="flex-shrink-0 p-6 pt-4 border-t border-slate-500/30 flex flex-wrap justify-end gap-3 bg-slate-900/40">
          <button
            id="denyPayment"
            class="inline-flex items-center gap-2 rounded-full border border-rose-500/60 bg-rose-500/10 px-4 py-2 text-sm font-semibold text-rose-200 transition hover:border-rose-300/60 hover:bg-rose-500/20"
          >
            <i class="fas fa-ban"></i>
            Reject
          </button>
          <button
            id="approvePayment"
            class="inline-flex items-center gap-2 rounded-full border border-emerald-500/60 bg-emerald-500/15 px-4 py-2 text-sm font-semibold text-emerald-100 transition hover:border-emerald-300/60 hover:bg-emerald-500/25"
          >
            <i class="fas fa-check"></i>
            Approve Payment
          </button>
        </div>
      </div>
    </div>

    <div
      id="toastHost"
      class="pointer-events-none fixed bottom-6 right-6 z-[60] flex flex-col gap-2"
    ></div>

    <script src="../firebase.js"></script>
    <script src="../transporthtml/modules/transport_pricing.js"></script>
    <script src="approvals.js"></script>
    <script>
      (function () {
        const pendingEl = () => ({
          count: document.getElementById('joining-pending-count'),
          approved: document.getElementById('joining-approved'),
          balance: document.getElementById('joining-balance'),
        });
        const fmt = new Intl.NumberFormat('en-US', { minimumFractionDigits: 0 });
        function formatTsh(v) { return 'TSh ' + fmt.format(Number(v || 0)); }
        function resolveSchoolId() {
          if (window.currentSchoolId) return window.currentSchoolId;
          const params = new URLSearchParams(window.location.search || '');
          const q = params.get('school') || params.get('schoolId');
          const stored = (typeof localStorage !== 'undefined') ? localStorage.getItem('somap_school') : '';
          const id = (q || stored || 'socrates').trim();
          window.currentSchoolId = id;
          return id;
        }
        function initJoiningCard() {
          const db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
          if (!db) return;
          const year = window.somapYearContext?.getSelectedYear?.() || new Date().getFullYear();
          const schoolId = resolveSchoolId();
          db.ref(`schools/${schoolId}/joiningApplications/${year}`).on('value', (snap) => {
            const raw = snap.val() || {};
            let pendingCount = 0; let pendingAmt = 0; let approvedAmt = 0;
            Object.values(raw).forEach((app) => {
              if (!app) return;
              const fee = Number(app.joiningFeeAmount || 0);
              if (app.paymentVerificationStatus === 'verified') {
                approvedAmt += fee;
              } else if (!['rejected', 'no_show'].includes(app.status)) {
                pendingCount += 1;
                pendingAmt += fee;
              }
            });
            const els = pendingEl();
            if (els.count) els.count.textContent = `${pendingCount} Pending`;
            if (els.approved) els.approved.textContent = formatTsh(approvedAmt);
            if (els.balance) els.balance.textContent = formatTsh(pendingAmt);
          });
        }
        document.addEventListener('DOMContentLoaded', initJoiningCard);
      })();
    </script>
  </body>
</html>
