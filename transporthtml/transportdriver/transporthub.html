<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Driver Transport Hub</title>
  <link rel="stylesheet" href="../css/transport.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  </script>
  <style>
    :root { --bg:#f4f7fb; --card:#fff; --text:#0f172a; --muted:#475569; --line:#dbe3ef; --ok:#166534; --bad:#b91c1c; --warn:#92400e; --ok-strong:#15803d; --ok-soft:#dcfce7; --bad-strong:#dc2626; --bad-soft:#fee2e2; --neutral-soft:#e2e8f0; }
    body{margin:0;background:radial-gradient(circle at 10% -5%,#c7f9e0 0%,transparent 42%),radial-gradient(circle at 100% 0%,#dbeafe 0%,transparent 46%),var(--bg);color:var(--text)}
    .wrap{max-width:1180px;margin:0 auto;padding:1.1rem 1rem 2.4rem}
    .hero{background:linear-gradient(135deg,#0f766e,#115e59);color:#ecfeff;border-radius:16px;padding:1rem;display:grid;gap:.8rem}
    .hero h1{margin:0;font-size:1.35rem}.meta{font-size:.92rem;color:#ccfbf1}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap}.actions .btn{border-radius:12px;font-size:.87rem}
    .actions .btn.secondary{background:rgba(255,255,255,.2);color:#ecfeff;border:1px solid rgba(255,255,255,.45)}
    .box,.panel{margin-top:1rem;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:.9rem}
    .chips{margin-top:.5rem;display:flex;flex-wrap:wrap;gap:.45rem}.chipV{font-size:.77rem;background:#eef2ff;color:#1e3a8a;border-radius:999px;padding:.26rem .62rem;font-weight:700}
    .stats{margin-top:1rem;display:grid;gap:.68rem;grid-template-columns:repeat(auto-fit,minmax(130px,1fr))}
    .stat{background:#fff;border:1px solid var(--line);border-radius:12px;padding:.75rem}.k{font-size:.75rem;font-weight:700;color:var(--muted);text-transform:uppercase}.v{margin-top:.28rem;font-size:1.45rem;font-weight:800}.good{color:var(--ok)}.bad{color:var(--bad)}
    .head{display:flex;flex-wrap:wrap;gap:.65rem;align-items:center;justify-content:space-between}.head h2{margin:0;font-size:1.02rem}.sub{color:var(--muted);font-size:.86rem}
    .dateRow{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}.dateRow input{width:auto;min-width:170px}
    .alertDebt{margin-top:.75rem;border:1px solid #fecaca;background:#fff5f5;border-radius:12px;padding:.7rem}.alertDebt h3{margin:0 0 .34rem;color:var(--bad);font-size:.92rem}
    .debtList{margin:0;padding-left:1rem;display:grid;gap:.24rem}
    .riders{margin-top:.85rem;border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .rHead,.row{display:grid;grid-template-columns:2fr .85fr 1fr 1fr auto;gap:.55rem;align-items:center}
    .rHead{padding:.68rem .8rem;background:#f8fafc;font-size:.72rem;color:var(--muted);font-weight:700;text-transform:uppercase}
    .row{padding:.74rem .8rem;border-top:1px solid var(--line)}.name{font-weight:700}.mini{margin-top:.18rem;font-size:.8rem;color:var(--muted)}
    .status{display:inline-flex;align-items:center;border-radius:999px;font-size:.82rem;font-weight:900;padding:.28rem .72rem;border:1px solid transparent}
    .s-paid{background:#dcfce7;color:var(--ok);border-color:#86efac}
    .s-debt{background:#ffedd5;color:var(--warn);border-color:#fdba74}
    .s-pres{background:var(--ok-soft);color:var(--ok-strong);border-color:#86efac}
    .s-abs{background:var(--bad-soft);color:var(--bad-strong);border-color:#fca5a5}
    .s-un{background:var(--neutral-soft);color:#334155;border-color:#cbd5e1}
    .ra{display:flex;gap:.45rem}
    .ra .btn{border-radius:10px;padding:.54rem .82rem;font-size:.9rem;font-weight:800;min-height:42px;border:2px solid transparent}
    .btn.present-btn{background:var(--ok-strong);color:#fff;border-color:#166534}
    .btn.present-btn:hover{background:#166534}
    .btn.abs{background:#ef4444;color:#fff;border-color:#b91c1c}
    .btn.abs:hover{background:#dc2626}
    .ra .btn.active-present{background:#14532d;color:#fff;border-color:#bbf7d0;box-shadow:0 0 0 2px rgba(34,197,94,.25)}
    .ra .btn.active-absent{background:#991b1b;color:#fff;border-color:#fecaca;box-shadow:0 0 0 2px rgba(239,68,68,.25)}
    .placeholder{padding:1rem;color:var(--muted)}
    @media (min-width:860px){.hero{grid-template-columns:1.2fr auto;align-items:center}}
    @media (max-width:900px){
      .rHead{display:none}
      .row{grid-template-columns:1fr;gap:.62rem;padding:.86rem;border-top:1px solid #d5deea;background:#fff}
      .ra{display:grid;grid-template-columns:1fr 1fr;gap:.55rem}
      .ra .btn{width:100%;min-height:50px;font-size:1rem;border-radius:12px}
      .dateRow input,.dateRow select,.dateRow .btn{min-height:46px;font-size:1rem}
      .dateRow{gap:.45rem}
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="hero">
      <div>
        <h1>Kituo cha Dereva</h1>
        <div class="meta" id="welcome">Inapakia...</div>
      </div>
      <div class="actions">
        <a class="btn secondary" id="openAttendance" href="#">Mahudhurio Kamili</a>
        <a class="btn secondary" href="../driver/transportfuel_request.html">Omba Mafuta</a>
        <a class="btn secondary" href="../driver/transportmaintenance_request.html">Omba Matengenezo</a>
      </div>
    </section>

    <section class="box">
      <h2 style="margin:0;font-size:1rem;">Gari langu: <span id="vehicleName">Inapakia...</span></h2>
      <div class="chips" id="vehicleChips"></div>
    </section>

    <section class="stats">
      <article class="stat"><div class="k">Wanafunzi Wote</div><div class="v" id="kAssigned">0</div></article>
      <article class="stat"><div class="k">Waliopo</div><div class="v good" id="kPresent">0</div></article>
      <article class="stat"><div class="k">Hawapo</div><div class="v bad" id="kAbsent">0</div></article>
      <article class="stat"><div class="k">Bado Kumark</div><div class="v" id="kUnmarked">0</div></article>
      <article class="stat"><div class="k">Wamelipa (Mwezi)</div><div class="v good" id="kPaid">0</div></article>
      <article class="stat"><div class="k">Wanaodaiwa (Mwezi)</div><div class="v bad" id="kDebt">0</div></article>
    </section>

    <section class="panel">
      <div class="head">
        <div>
          <h2>Mahudhurio ya Wanafunzi Wangu</h2>
          <div class="sub" id="panelSub">Tumia Present / Absent kwa kila mtoto.</div>
        </div>
        <div class="dateRow">
          <select id="yearSelect" title="Academic Year" style="min-width:110px;"></select>
          <input type="date" id="dateInput" />
          <button class="btn secondary" id="todayBtn" type="button">Leo</button>
          <button class="btn" id="finalizeBtn" type="button">Maliza Siku</button>
        </div>
      </div>
      <div id="debtAlert" class="alertDebt hidden"></div>
      <div class="riders">
        <div class="rHead"><div>Mwanafunzi / Route</div><div>Darasa</div><div>Malipo</div><div>Status</div><div>Hatua</div></div>
        <div id="ridersBody" class="placeholder">Inapakia wanafunzi...</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>

  <script src="../modules/transport_helpers.js"></script>
  <script src="../modules/transport_context.js"></script>
  <script src="../modules/transport_pricing.js"></script>
  <script src="../modules/transportauto_tracker.js" defer></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);

    const refs = {
      welcome: document.getElementById("welcome"), vehicleName: document.getElementById("vehicleName"), vehicleChips: document.getElementById("vehicleChips"),
      openAttendance: document.getElementById("openAttendance"), panelSub: document.getElementById("panelSub"), dateInput: document.getElementById("dateInput"),
      yearSelect: document.getElementById("yearSelect"),
      todayBtn: document.getElementById("todayBtn"), finalizeBtn: document.getElementById("finalizeBtn"), debtAlert: document.getElementById("debtAlert"),
      ridersBody: document.getElementById("ridersBody"), toast: document.getElementById("toast"),
      kAssigned: document.getElementById("kAssigned"), kPresent: document.getElementById("kPresent"), kAbsent: document.getElementById("kAbsent"),
      kUnmarked: document.getElementById("kUnmarked"), kPaid: document.getElementById("kPaid"), kDebt: document.getElementById("kDebt")
    };

    const state = {
      user:null,
      profile:{},
      role:"guest",
      context:TransportContext.getContext(),
      vehicleId:"",
      buses:[],
      routeVehicleMap:{},
      students:{},
      allEnrollments:{},
      assignments:[],
      attendanceMap:{},
      ledgerMap:{},
      driverHint:{ uid:"", name:"", vehicle:"" }
    };

    function esc(v){return String(v??"").replace(/[&<>"']/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[ch]||ch));}
    function tzs(v){return (window.TransportHelpers&&TransportHelpers.fmtTZS)?TransportHelpers.fmtTZS(Number(v||0)):("TZS "+Number(v||0).toLocaleString("en-US"));}
    function toast(msg,bad){refs.toast.textContent=msg;refs.toast.style.background=bad?"#991b1b":"#0f172a";refs.toast.classList.remove("hidden");setTimeout(()=>refs.toast.classList.add("hidden"),3200);}
    function isDriver(role){const r=String(role||"").trim().toLowerCase();return r==="driver"||r==="dereva";}
    function isSoc(){const s=String(state.context.school||"").toLowerCase().trim();return s==="socrates-school"||s==="socrates"||s==="default";}
    function nName(v){return String(v||"").toLowerCase().replace(/\s+/g," ").trim();}
    function ymd(){return `${state.context.year}-${String(state.context.month).padStart(2,"0")}-${String(state.context.day).padStart(2,"0")}`;}
    function setDateFromContext(){refs.dateInput.value=ymd();}
    function setYearSelectFromContext(){refs.yearSelect.value=String(state.context.year||"");}
    function setContextDate(v){const p=String(v||"").split("-");if(p.length!==3)return;state.context=TransportContext.setContext({year:Number(p[0]),month:Number(p[1]),day:Number(p[2])});}
    function normalizeRoutes(raw){if(!raw)return[];if(Array.isArray(raw))return raw.map(v=>String(v||"").trim()).filter(Boolean);if(typeof raw==="object")return Object.values(raw).map(v=>String(v||"").trim()).filter(Boolean);if(typeof raw==="string")return raw.split(/[|;,\n]+/).map(v=>v.trim()).filter(Boolean);return[];}
    function actorId(){return (state.user&&state.user.uid)||state.driverHint.uid||"driver-local";}
    function clean(v){return String(v||"").trim();}
    function normalizeDateInput(raw, fallbackYear){
      if(!raw){
        const yr=Number.isFinite(fallbackYear)?fallbackYear:new Date().getFullYear();
        return `${yr}-01-01`;
      }
      if(typeof raw==='number'){const d=new Date(raw);if(!Number.isNaN(d.getTime())) return d.toISOString().slice(0,10);}
      const text=String(raw).trim();
      if(/^\d{4}-\d{2}-\d{2}$/.test(text)) return text;
      if(/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(text)){const [dd,mm,yy]=text.split('/').map(Number);const d=new Date(yy,mm-1,dd);if(!Number.isNaN(d.getTime())) return d.toISOString().slice(0,10);}
      const d2=new Date(text);if(!Number.isNaN(d2.getTime())) return d2.toISOString().slice(0,10);
      const yr=Number.isFinite(fallbackYear)?fallbackYear:new Date().getFullYear();
      return `${yr}-01-01`;
    }
    function resolveStartDate(enrollment){
      if(!enrollment) return normalizeDateInput(null,state.context.year);
      if(enrollment.startDate) return normalizeDateInput(enrollment.startDate,state.context.year);
      if(enrollment.start_date) return normalizeDateInput(enrollment.start_date,state.context.year);
      if(enrollment.startTimestamp) return normalizeDateInput(Number(enrollment.startTimestamp),state.context.year);
      if(enrollment.start_time) return normalizeDateInput(enrollment.start_time,state.context.year);
      if(enrollment.dateRegistered) return normalizeDateInput(enrollment.dateRegistered,state.context.year);
      return normalizeDateInput(null,state.context.year);
    }
    function currentDriverNames(){return [state.profile.fullName,state.profile.name,state.profile.displayName,[state.profile.firstName,state.profile.middleName,state.profile.lastName].filter(Boolean).join(" "),(state.user&&state.user.displayName)||"",state.driverHint.name].map(nName).filter(Boolean);}
    function currentDriverUid(){return (state.user&&state.user.uid)||state.driverHint.uid||"";}
    function enrollmentMatchesCurrentDriver(en){
      if(!en) return false;
      const uid=currentDriverUid();
      const names=currentDriverNames();
      const uidFields=[en.driverUid,en.assignedDriverUid,en.driverId,en.assignedDriverId,(en.morningVehicle&&en.morningVehicle.driverUid),(en.eveningVehicle&&en.eveningVehicle.driverUid),(en.morningVehicle&&en.morningVehicle.assignedDriverUid),(en.eveningVehicle&&en.eveningVehicle.assignedDriverUid)].filter(Boolean).map(v=>String(v));
      if(uid && uidFields.some(v=>v===String(uid))) return true;
      const nameFields=[en.driverName,en.assignedDriverName,(en.morningVehicle&&en.morningVehicle.driverName),(en.eveningVehicle&&en.eveningVehicle.driverName),(en.morningVehicle&&en.morningVehicle.assignedDriverName),(en.eveningVehicle&&en.eveningVehicle.assignedDriverName)].map(nName).filter(Boolean);
      return names.length ? nameFields.some(n=>names.includes(n)) : false;
    }
    function extractVehicleCandidates(en){
      if(!en) return [];
      return [en.vehicleId,en.busId,en.assignedVehicleId,en.morningVehicleId,en.eveningVehicleId,(en.morningVehicle&&en.morningVehicle.vehicleId),(en.eveningVehicle&&en.eveningVehicle.vehicleId),(en.morningVehicle&&en.morningVehicle.id),(en.eveningVehicle&&en.eveningVehicle.id)].map(clean).filter(Boolean);
    }
    function inferVehicleFromEnrollmentsForDriver(){
      const counts={};
      Object.values(state.allEnrollments||{}).forEach(en=>{
        if(!enrollmentMatchesCurrentDriver(en)) return;
        extractVehicleCandidates(en).forEach(id=>{ counts[id]=(counts[id]||0)+1; });
      });
      const ranked=Object.entries(counts).sort((a,b)=>b[1]-a[1]);
      return ranked.length?ranked[0][0]:"";
    }

    function hydrateDriverHintFromQueryAndStorage(){
      const storedUid = localStorage.getItem("somap_driver_uid") || "";
      const storedName = localStorage.getItem("somap_driver_name") || "";
      const storedVehicle = localStorage.getItem("somap_vehicleId") || "";
      state.driverHint = {
        uid: clean(urlParams.get("driverUid") || urlParams.get("uid") || storedUid),
        name: clean(urlParams.get("driverName") || urlParams.get("driver") || urlParams.get("name") || storedName),
        vehicle: clean(urlParams.get("vehicle") || storedVehicle)
      };
      if (state.driverHint.uid) localStorage.setItem("somap_driver_uid", state.driverHint.uid);
      if (state.driverHint.name) localStorage.setItem("somap_driver_name", state.driverHint.name);
      if (state.driverHint.vehicle) localStorage.setItem("somap_vehicleId", state.driverHint.vehicle);
    }

    function initYearSelector(){
      const min=2024,max=2042;
      refs.yearSelect.innerHTML="";
      for(let y=min;y<=max;y++){
        const opt=document.createElement("option");
        opt.value=String(y);
        opt.textContent=String(y);
        refs.yearSelect.appendChild(opt);
      }
      setYearSelectFromContext();
    }

    function applyAutomaticCurrentDateContext(){
      const hasDateInUrl = urlParams.has("year") || urlParams.has("month") || urlParams.has("day");
      if(hasDateInUrl) return;
      const now=new Date();
      state.context=TransportContext.setContext({
        year:now.getFullYear(),
        month:now.getMonth()+1,
        day:now.getDate()
      });
    }

    function updateAttendanceLink(){
      const q=new URLSearchParams({school:state.context.school||"",year:String(state.context.year||""),month:String(state.context.month||""),day:String(state.context.day||""),vehicle:state.vehicleId||""});
      refs.openAttendance.href=`../transportattendance.html?${q.toString()}`;
      refs.panelSub.textContent=`Tarehe ${ymd()} | Dereva anaona watoto wa gari lake tu.`;
    }

    async function loadBuses(){
      const items=[];const school=state.context.school;const year=String(state.context.year||"");
      const paths=[`transport/${school}/${year}/buses`,`schools/${school}/years/${year}/transport/buses`];
      if(isSoc()){paths.push(`transport/socrates-school/${year}/buses`,`transport/socrates/${year}/buses`);}paths.push(`transport/-O_HndQaeuNugluTYPdp/${year}/buses`);
      for(const p of paths){
        let s=null;
        try { s=await firebase.database().ref(p).get(); } catch(_err) { continue; }
        if(!s||!s.exists())continue;
        const v=s.val();if(!v||typeof v!=="object")continue;
        Object.keys(v).forEach(id=>items.push({id,...(v[id]||{})}));
        if(items.length)break;
      }
      items.sort((a,b)=>String(a.alias||a.name||a.plate||a.id||"").toLowerCase().localeCompare(String(b.alias||b.name||b.plate||b.id||"").toLowerCase()));
      state.buses=items;
    }

    function buildRouteMap(){
      const map={};const norm=s=>String(s||"").toLowerCase().trim();
      state.buses.forEach(bus=>{
        [bus.assignedRoutes,bus.routes,bus.routeNames,bus.route,bus.routeName,bus.stopNames,bus.stops,bus.amStop,bus.pmStop,bus.morningRoute,bus.eveningRoute].forEach(raw=>{
          normalizeRoutes(raw).forEach(route=>{const k=norm(route);if(k&&!map[k])map[k]=bus.id;});
        });
      });
      state.routeVehicleMap=map;
    }

    async function expandRouteMap(){
      const paths=[`schools/${state.context.school}/transportCatalog/${state.context.year}/stops`,`transportCatalog/${state.context.year}/stops`];
      const norm=v=>String(v||"").toLowerCase().trim();
      for(const p of paths){const s=await firebase.database().ref(p).get();if(!s.exists()||!s.val())continue;const c=s.val();Object.keys(c).forEach(id=>{const stop=c[id]||{};const n=norm(stop.name||stop.id||id);const vid=state.routeVehicleMap[n];if(vid){state.routeVehicleMap[norm(id)]=vid;state.routeVehicleMap[String(id)]=vid;}});break;}
    }

    function busIdFromRef(ref){const key=String(ref||"").trim();if(!key)return null;if(!state.buses.length)return key;if(state.buses.some(b=>b.id===key))return key;const cleanRef=v=>String(v||"").toLowerCase().replace(/\s+/g,"");const n=cleanRef(key);const b=state.buses.find(x=>cleanRef(x.plate||x.plateNo||x.registration||"")===n);return b?b.id:null;}

    function resolveVehicle(en){
      if(!en)return null;
      const direct=busIdFromRef(en.vehicleId||en.busId||en.assignedVehicleId||"");if(direct)return direct;
      const mv=en.morningVehicle,ev=en.eveningVehicle;const nested=busIdFromRef((mv&&(mv.vehicleId||mv.id))||"")||busIdFromRef((ev&&(ev.vehicleId||ev.id))||"");if(nested)return nested;
      const norm=v=>String(v||"").toLowerCase().trim();const am=norm(en.amStop||en.pickupStop||en.morningStop||""),pm=norm(en.pmStop||en.dropoffStop||en.eveningStop||"");
      if(am&&state.routeVehicleMap[am])return state.routeVehicleMap[am];if(pm&&state.routeVehicleMap[pm])return state.routeVehicleMap[pm];
      const fuzzy=Object.keys(state.routeVehicleMap).find(k=>(am&&(am.includes(k)||k.includes(am)))||(pm&&(pm.includes(k)||k.includes(pm))));return fuzzy?state.routeVehicleMap[fuzzy]:null;
    }

    async function loadStudents(){
      const sMap={};const paths=[];
      if(state.context.school){paths.push(`schools/${state.context.school}/years/${state.context.year}/students`,`schools/${state.context.school}/students`);}
      if(isSoc())paths.push(`years/${state.context.year}/students`);
      paths.push("students");
      for(const p of paths){
        let s=null;
        try { s=await firebase.database().ref(p).get(); } catch(_err) { continue; }
        if(!s||!s.exists())continue;
        s.forEach(c=>{if(!sMap[c.key])sMap[c.key]=c.val()||{};});
      }
      state.students=sMap;
    }

    async function loadAllEnrollments(){
      const year=String(state.context.year),school=state.context.school,valid=[school,"socrates-school","socrates","default","-O_HndQaeuNugluTYPdp","HndQaeuNugluTYPdp"];
      const safeGet = (path) => firebase.database().ref(path).get().catch(()=>({exists:()=>false,val:()=>null,forEach:()=>{}}));
      const [enS,enL,asS,asL,reS,reL]=await Promise.all([
        safeGet(`schools/${school}/years/${year}/transportEnrollments`),
        isSoc()?safeGet("transport_enrollments"):Promise.resolve({exists:()=>false,val:()=>null,forEach:()=>{}}),
        safeGet(`schools/${school}/years/${year}/transportAssignments`),
        isSoc()?safeGet(`transportAssignments/${year}`):Promise.resolve({exists:()=>false,val:()=>null,forEach:()=>{}}),
        safeGet(`schools/${school}/years/${year}/transportRegistry`),
        isSoc()?safeGet(`transportRegistry/${year}`):Promise.resolve({exists:()=>false,val:()=>null,forEach:()=>{}})
      ]);
      const en={};
      if(enS.exists())enS.forEach(c=>{const v=c.val();if(v)en[c.key]={...v,studentId:c.key};});
      if(enL.exists())enL.forEach(c=>{const v=c.val()||{};if((!v.school||valid.includes(v.school))&&!en[c.key])en[c.key]={...v,studentId:v.studentId||c.key};});
      if(reS.exists())reS.forEach(c=>{const v=c.val();if(v&&v.using===true&&!en[c.key])en[c.key]={studentId:c.key,amStop:v.routeId||"",pmStop:v.stopName||""};});
      if(reL.exists())reL.forEach(c=>{const v=c.val();if(v&&v.using===true&&!en[c.key])en[c.key]={studentId:c.key,amStop:v.routeId||"",pmStop:v.stopName||""};});
      const as={};if(asS.exists())asS.forEach(c=>{const v=c.val();if(v)as[c.key]=v;});if(asL.exists())asL.forEach(c=>{const v=c.val();if(v&&!as[c.key])as[c.key]=v;});
      Object.keys(as).forEach(id=>{const a=as[id],x=en[id]||{};if(a&&a.status&&a.status!=="Using"){delete en[id];return;}const mv=a.morningVehicle||x.morningVehicle,ev=a.eveningVehicle||x.eveningVehicle;en[id]={...x,...a,studentId:id,amStop:a.morningRouteId||a.amStop||x.amStop||"",pmStop:a.eveningRouteId||a.pmStop||x.pmStop||"",morningVehicleId:(mv&&(mv.vehicleId||mv.id))||null,eveningVehicleId:(ev&&(ev.vehicleId||ev.id))||null};});
      state.allEnrollments=en;
    }

    async function loadAssignments(vehicleId){
      if(!vehicleId){state.assignments=[];return;}buildRouteMap();await expandRouteMap();if(!Object.keys(state.allEnrollments).length)await loadAllEnrollments();
      const list=[];Object.keys(state.allEnrollments).forEach(id=>{const en=state.allEnrollments[id];const resolved=resolveVehicle(en);if(resolved!==vehicleId && !(enrollmentMatchesCurrentDriver(en)&&!resolved))return;const st=state.students[id]||{};const full=[st.firstName,st.middleName,st.lastName].filter(Boolean).join(" ").trim();list.push({...en,studentId:id,studentName:full||en.studentName||en.name||en.displayName||en.admissionNumber||id,className:st.classLevel||en.className||en.class||en.grade||"-",route:en.route||en.routeName||"",amStop:en.amStop||en.pickupStop||en.morningStop||"",pmStop:en.pmStop||en.dropoffStop||en.eveningStop||""});});
      list.sort((a,b)=>String(a.studentName||"").localeCompare(String(b.studentName||"")));state.assignments=list;
    }

    async function loadAttendance(){
      if(!state.vehicleId){state.attendanceMap={};return;}const y=ymd(),school=state.context.school,year=state.context.year;const paths=[`transport/${school}/${year}/attendance/${y}/${state.vehicleId}`];if(isSoc())paths.push(`transport/socrates-school/${year}/attendance/${y}/${state.vehicleId}`,`transport/socrates/${year}/attendance/${y}/${state.vehicleId}`);
      let merged={};for(const p of paths){const s=await firebase.database().ref(p).get();if(s.exists()&&s.val())merged={...merged,...s.val()};}state.attendanceMap=merged;
    }

    async function loadLedgers(){
      state.ledgerMap={};
      const year=Number(state.context.year),month=Number(state.context.month);
      const multipliers=(window.TransportPricing&&TransportPricing.loadYearMultipliers)?await TransportPricing.loadYearMultipliers(year).catch(()=>null):null;
      const tasks=state.assignments.map(st=>{
        if(!st.studentId)return Promise.resolve();
        const path=TransportHelpers.paths.ledgerMonth(st.studentId,year,month);
        return firebase.database().ref(path).get().then(async s=>{
          const l=s.val()||{};
          let expected=Number(l.expected||0);
          const paid=Number(l.paid||0);
          if(expected<=0 && window.TransportPricing && TransportPricing.dueForMonth){
            expected=Number(await TransportPricing.dueForMonth({
              year,
              month,
              baseMonthlyFee:Number(st.baseMonthlyFee||0),
              amStop:st.amStop||"",
              pmStop:st.pmStop||"",
              startDate:resolveStartDate(st),
              multipliers:multipliers||undefined
            }))||0;
          }
          const balance=Number(l.balance!==undefined?l.balance:Math.max(0,expected-paid));
          state.ledgerMap[st.studentId]={expected:expected,paid:paid,balance:Math.max(0,balance),hasBilling:expected>0};
        }).catch(()=>{});
      });
      await Promise.allSettled(tasks);
    }

    function renderVehicle(){
      const bus=state.buses.find(b=>b.id===state.vehicleId);
      if(!bus){
        if(state.vehicleId){
          refs.vehicleName.textContent=state.vehicleId;
          refs.vehicleChips.innerHTML='<span class="chipV">Mapped kutoka assignments</span>';
          return;
        }
        refs.vehicleName.textContent="Bado hujapangiwa gari";refs.vehicleChips.innerHTML='<span class="chipV" style="background:#fff7ed;color:#9a3412;">Admin ampangie dereva gari kwanza.</span>';return;
      }
      refs.vehicleName.textContent=bus.alias||bus.name||bus.plate||bus.id;
      const chips=[];if(bus.plate)chips.push(`Plate ${bus.plate}`);if(bus.capacity)chips.push(`Capacity ${bus.capacity}`);const r=normalizeRoutes(bus.assignedRoutes||bus.routes||bus.routeName||bus.route).slice(0,3).join(", ");if(r)chips.push(`Route ${r}`);
      refs.vehicleChips.innerHTML=chips.length?chips.map(c=>`<span class="chipV">${esc(c)}</span>`).join(""):`<span class="chipV">Vehicle ID ${esc(state.vehicleId)}</span>`;
    }

    function render(){
      const assigned=state.assignments.length;let present=0,absent=0,unmarked=0,paid=0,debt=0;const debtors=[];
      if(!assigned){refs.ridersBody.className="placeholder";refs.ridersBody.textContent="Hakuna wanafunzi waliopewa gari hili kwa mwaka huu.";}
      else {
        refs.ridersBody.className="";
        refs.ridersBody.innerHTML=state.assignments.map(st=>{
          const sid=st.studentId,a=state.attendanceMap[sid]||null,l=state.ledgerMap[sid]||null;
          const isPresent = !!(a&&a.status==="present");
          const isAbsent = !!(a&&a.status==="absent");
          let status='<span class="status s-un">• Unmarked</span>';if(isPresent){present++;status='<span class="status s-pres">✓ Present</span>';}else if(isAbsent){absent++;status='<span class="status s-abs">✕ Absent</span>';}else{unmarked++;}
          let pay='<span class="status s-un">No billing data</span>';
          if(l && l.hasBilling){
            if(Number(l.balance||0)<=0){
              paid++;
              pay=`<span class="status s-paid">Paid (This Month)</span><div class="mini">Paid ${esc(tzs(l.paid))} / Due ${esc(tzs(l.expected))}</div>`;
            }else{
              debt++;
              pay=`<span class="status s-debt">Left ${esc(tzs(l.balance))}</span><div class="mini">Paid ${esc(tzs(l.paid))} / Due ${esc(tzs(l.expected))}</div>`;
              debtors.push({name:st.studentName,amount:l.balance});
            }
          }
          const route=[];if(st.route)route.push(`Route ${st.route}`);if(st.amStop||st.pmStop)route.push(`AM ${st.amStop||"-"} / PM ${st.pmStop||"-"}`);
          const reason=(a&&a.reason)?`<div class="mini">Reason: ${esc(a.reason)}</div>`:"";
          const pClass = isPresent ? "active-present" : "";
          const aClass = isAbsent ? "active-absent" : "";
          return `<div class="row" data-student="${esc(sid)}"><div><div class="name">${esc(st.studentName||sid)}</div><div class="mini">${esc(route.join(" | ")||"Hakuna route details")}</div>${reason}</div><div>${esc(st.className||"-")}</div><div>${pay}</div><div>${status}</div><div class="ra"><button class="btn present-btn ${pClass}" type="button" data-action="present">✓ Present</button><button class="btn abs ${aClass}" type="button" data-action="absent">✕ Absent</button></div></div>`;
        }).join("");
      }
      refs.kAssigned.textContent=String(assigned);refs.kPresent.textContent=String(present);refs.kAbsent.textContent=String(absent);refs.kUnmarked.textContent=String(unmarked);refs.kPaid.textContent=String(paid);refs.kDebt.textContent=String(debt);
      if(debtors.length){const top=debtors.sort((a,b)=>Number(b.amount||0)-Number(a.amount||0)).slice(0,8);refs.debtAlert.classList.remove("hidden");refs.debtAlert.innerHTML=`<h3>No Pay, No Board: Wanafunzi wanaodaiwa</h3><ul class="debtList">${top.map(x=>`<li><strong>${esc(x.name)}</strong> - ${esc(tzs(x.amount))}</li>`).join("")}</ul>`;}else{refs.debtAlert.classList.add("hidden");refs.debtAlert.innerHTML="";}
      refs.finalizeBtn.disabled=!assigned;
    }

    function attendancePath(sid){return `transport/${state.context.school}/${state.context.year}/attendance/${ymd()}/${state.vehicleId}/${sid}`;}
    function summaryPath(sid){return `transport/${state.context.school}/${state.context.year}/attendance_summary/${state.vehicleId}/${sid}`;}

    async function markPresent(sid){const rec={status:"present",reason:"OK",by:actorId(),ts:Date.now()};await firebase.database().ref(attendancePath(sid)).set(rec);await firebase.database().ref(summaryPath(sid)).update({last_present_ymd:ymd(),consecutive_absent_days:0});state.attendanceMap[sid]=rec;}
    async function markAbsent(sid){const note=window.prompt("Andika sababu ya absent (mfano: SICK, NO SHOW, ALICHELEWA)","NO SHOW");if(note===null)return;const reason=String(note||"NO SHOW").trim()||"NO SHOW";const rec={status:"absent",reason,by:actorId(),ts:Date.now()};await firebase.database().ref(attendancePath(sid)).set(rec);const r=firebase.database().ref(summaryPath(sid)),s=await r.get(),v=s.val()||{};await r.update({consecutive_absent_days:Number(v.consecutive_absent_days||0)+1});state.attendanceMap[sid]=rec;}

    async function finalizeDay(){
      const unmarked=state.assignments.filter(st=>st.studentId&&!state.attendanceMap[st.studentId]);if(!unmarked.length){toast("Wote tayari wamewekewa status");return;}
      if(!window.confirm(`Una uhakika? Wanafunzi ${unmarked.length} watawekwa ABSENT (NO SHOW).`))return;
      const updates={},now=Date.now(),d=ymd();unmarked.forEach(st=>{updates[`transport/${state.context.school}/${state.context.year}/attendance/${d}/${state.vehicleId}/${st.studentId}`]={status:"absent",reason:"NO SHOW",by:actorId(),ts:now};});
      await firebase.database().ref().update(updates);
      for(const st of unmarked){const r=firebase.database().ref(summaryPath(st.studentId)),s=await r.get(),v=s.val()||{};await r.update({consecutive_absent_days:Number(v.consecutive_absent_days||0)+1});}
      await loadAttendance();render();toast("Siku imefungwa. Unmarked wote wamewekwa absent.");
    }

    function pickVehicle(){
      const uid=(state.user&&state.user.uid)||state.driverHint.uid||"";
      const names=[state.profile.fullName,state.profile.name,state.profile.displayName,[state.profile.firstName,state.profile.middleName,state.profile.lastName].filter(Boolean).join(" "),(state.user&&state.user.displayName)||"",state.driverHint.name].map(nName).filter(Boolean);

      const belongsToCurrentDriver = (bus) => {
        if (!bus) return false;
        const dUid = bus.assignedDriverUid||bus.driverUid||bus.driverId||bus.assignedDriverId||"";
        if (uid && dUid && String(dUid) === String(uid)) return true;
        if (names.length) {
          const busNames = [bus.assignedDriverName,bus.driverName,bus.driverFullName,bus.driver].map(nName).filter(Boolean);
          if (busNames.some(n => names.includes(n))) return true;
        }
        return false;
      };

      // Strict match first so one driver cannot see another driver's vehicle.
      const byUid=state.buses.find(b=>{const d=b.assignedDriverUid||b.driverUid||b.driverId||b.assignedDriverId;return uid&&d&&String(d)===String(uid);});
      if(byUid) return byUid.id;
      if(names.length){
        const byName=state.buses.find(b=>[b.assignedDriverName,b.driverName,b.driverFullName,b.driver].map(nName).filter(Boolean).some(n=>names.includes(n)));
        if(byName) return byName.id;
      }

      // Fallback to remembered vehicle only if it still belongs to current driver.
      const preferred = state.driverHint.vehicle || localStorage.getItem("somap_vehicleId") || "";
      if(preferred){
        const bus = state.buses.find(b=>b.id===preferred);
        if(bus && belongsToCurrentDriver(bus)) return preferred;
      }

      // Last safe fallback: first vehicle that belongs to current driver.
      const firstOwned = state.buses.find(b=>belongsToCurrentDriver(b));
      if (firstOwned) return firstOwned.id;
      return "";
    }

    async function loadDriversForFallback(){
      const year=String(state.context.year||"");
      const school=state.context.school;
      const paths=["workers",`years/${year}/workers`,`schools/${school}/workers`,`schools/${school}/years/${year}/workers`];
      const driversById={};
      for(const path of paths){
        const snap=await firebase.database().ref(path).get().catch(()=>({exists:()=>false}));
        if(!snap.exists()) continue;
        snap.forEach(child=>{
          if(driversById[child.key]) return;
          const w=child.val()||{}, p=w.profile||{};
          const role=String(p.role||w.role||"").toLowerCase().trim();
          if(role!=="driver"&&role!=="dereva") return;
          if(p.active===false) return;
          const full = p.fullNameUpper||p.fullName||w.fullName||[p.firstName,p.middleName,p.lastName].filter(Boolean).join(" ")||[w.firstName,w.middleName,w.lastName].filter(Boolean).join(" ")||child.key;
          const phone = p.phone||w.phone||w.phoneNumber||"";
          driversById[child.key]={id:child.key,name:String(full).trim(),phone:String(phone||"").trim()};
        });
      }
      return Object.values(driversById);
    }

    async function fallbackChooseDriver(){
      const drivers = await loadDriversForFallback();
      if(!drivers.length) return null;
      const top = drivers.slice(0, 25);
      const lines = top.map((d,i)=>`${i+1}. ${d.name}${d.phone?` (${d.phone})`:""}`).join("\n");
      const pick = window.prompt("Chagua dereva kwa namba:\n"+lines+"\n\nAndika namba (mfano 1):","1");
      if(pick===null) return null;
      const idx = Number(pick)-1;
      if(Number.isNaN(idx)||idx<0||idx>=top.length) return null;
      const chosen = top[idx];
      localStorage.setItem("somap_driver_uid", chosen.id);
      localStorage.setItem("somap_driver_name", chosen.name);
      return chosen;
    }

    async function autoPickDriverWithoutAuth(){
      const drivers = await loadDriversForFallback();
      if(!drivers.length) return null;

      const hinted = state.driverHint.uid
        ? drivers.find(d => String(d.id) === String(state.driverHint.uid))
        : null;
      if(hinted) return hinted;

      const byName = state.driverHint.name
        ? drivers.find(d => nName(d.name) === nName(state.driverHint.name))
        : null;
      if(byName) return byName;

      return drivers[0];
    }

    async function initializeDashboard(){
      setDateFromContext();
      setYearSelectFromContext();
      await loadBuses();
      state.vehicleId=pickVehicle();
      if(!state.vehicleId){
        await loadAllEnrollments();
        const inferred = inferVehicleFromEnrollmentsForDriver();
        if(inferred) state.vehicleId=inferred;
      }
      if(!state.vehicleId){
        renderVehicle();
        refs.ridersBody.className="placeholder";
        refs.ridersBody.textContent="Bado hujapangiwa gari. Mwambie admin akuweke kwenye gari lako.";
        refs.finalizeBtn.disabled=true;
        updateAttendanceLink();
        return;
      }
      localStorage.setItem("somap_vehicleId",state.vehicleId);
      state.driverHint.vehicle = state.vehicleId;
      renderVehicle();
      await loadStudents();
      await loadAssignments(state.vehicleId);
      await loadAttendance();
      await loadLedgers();
      updateAttendanceLink();
      render();
    }

    async function boot(){
      hydrateDriverHintFromQueryAndStorage();
      applyAutomaticCurrentDateContext();
      initYearSelector();
      firebase.auth().onAuthStateChanged(async user=>{
        if(!user){
          state.role="driver";
          let fallback = null;
          if (state.driverHint.uid || state.driverHint.name) {
            fallback = { id: state.driverHint.uid || "driver-local", name: state.driverHint.name || "Dereva" };
          } else {
            fallback = await autoPickDriverWithoutAuth();
            if (!fallback) fallback = await fallbackChooseDriver();
          }
          if(!fallback){
            refs.welcome.textContent="Hakuna session ya dereva na hakuna driver records.";
            refs.vehicleName.textContent="No access";
            refs.ridersBody.className="placeholder";
            refs.ridersBody.textContent="Weka dereva kwanza kwenye workers/buses.";
            return;
          }
          state.driverHint.uid = fallback.id || state.driverHint.uid;
          state.driverHint.name = fallback.name || state.driverHint.name;
          localStorage.setItem("somap_driver_uid", state.driverHint.uid || "");
          localStorage.setItem("somap_driver_name", state.driverHint.name || "");
          state.profile = { role: "driver", fullName: state.driverHint.name || "Dereva" };
          refs.welcome.innerHTML=`Karibu <strong>${esc(state.profile.fullName)}</strong> | ${esc(state.context.schoolName||state.context.school||"School")} | Year ${esc(state.context.year)}`;
          try { await initializeDashboard(); } catch(err){ console.error(err); refs.ridersBody.className="placeholder"; refs.ridersBody.textContent="Imeshindikana kupakia taarifa. Jaribu refresh."; toast("Imeshindikana kupakia taarifa",true); }
          return;
        }
        state.user=user;
        try {
          const [pSnap,rSnap,dSnap]=await Promise.all([firebase.database().ref(`users/${user.uid}`).get(),firebase.database().ref(`users/${user.uid}/role`).get(),firebase.database().ref(TransportHelpers.paths.deviceVehicle(user.uid)).get().catch(()=>({val:()=>""}))]);
          state.profile=pSnap.val()||{};state.role=state.profile.role||(state.profile.profile&&state.profile.profile.role)||rSnap.val()||"";
          if(!isDriver(state.role)){refs.welcome.textContent="Role yako si dereva.";refs.ridersBody.className="placeholder";refs.ridersBody.textContent="Huna ruhusa ya kutumia ukurasa huu.";refs.finalizeBtn.disabled=true;return;}
          const name=state.profile.fullName||state.profile.name||user.displayName||"Dereva";
          refs.welcome.innerHTML=`Karibu <strong>${esc(name)}</strong> | ${esc(state.context.schoolName||state.context.school||"School")} | Year ${esc(state.context.year)}`;
          if(dSnap&&typeof dSnap.val==="function"){const m=dSnap.val();if(m)localStorage.setItem("somap_vehicleId",m);}
          state.driverHint.uid = user.uid;
          state.driverHint.name = name;
          localStorage.setItem("somap_driver_uid", user.uid);
          localStorage.setItem("somap_driver_name", name);
          await initializeDashboard();
        } catch(err){console.error(err);refs.ridersBody.className="placeholder";refs.ridersBody.textContent="Imeshindikana kupakia taarifa. Jaribu refresh.";toast("Imeshindikana kupakia taarifa",true);}
      });
    }

    refs.dateInput.addEventListener("change",async()=>{if(!refs.dateInput.value)return;setContextDate(refs.dateInput.value);updateAttendanceLink();try{await loadAttendance();await loadLedgers();render();}catch(err){console.error(err);toast("Imeshindikana kubadili tarehe",true);}});
    refs.yearSelect.addEventListener("change",async()=>{const y=Number(refs.yearSelect.value||state.context.year);state.context=TransportContext.setContext({year:y});setDateFromContext();updateAttendanceLink();try{await initializeDashboard();}catch(err){console.error(err);toast("Imeshindikana kubadili mwaka",true);}});
    refs.todayBtn.addEventListener("click",async()=>{const n=new Date();state.context=TransportContext.setContext({year:n.getFullYear(),month:n.getMonth()+1,day:n.getDate()});setDateFromContext();updateAttendanceLink();try{await loadAttendance();await loadLedgers();render();}catch(err){console.error(err);toast("Imeshindikana kupakia leo",true);}});
    refs.ridersBody.addEventListener("click",async e=>{const btn=e.target.closest("button[data-action]");if(!btn)return;const row=btn.closest(".row"),sid=row?row.getAttribute("data-student"):"",a=btn.getAttribute("data-action");if(!sid||!state.vehicleId)return;btn.disabled=true;try{if(a==="present"){await markPresent(sid);toast("Present imeset");}else if(a==="absent"){await markAbsent(sid);toast("Absent imeset",true);}render();}catch(err){console.error(err);toast("Imeshindikana kusave attendance",true);}finally{btn.disabled=false;}});
    refs.finalizeBtn.addEventListener("click",async()=>{refs.finalizeBtn.disabled=true;try{await finalizeDay();}catch(err){console.error(err);toast("Finalize imeshindikana",true);}finally{refs.finalizeBtn.disabled=false;}});

    boot();
  </script>
</body>
</html>
