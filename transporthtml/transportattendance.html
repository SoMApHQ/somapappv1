
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Transport Attendance - SoMAp</title>

  <link rel="stylesheet" href="./css/transport.css"/>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>

  <style>
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.25), transparent 45%), radial-gradient(circle at bottom right, rgba(16, 185, 129, 0.2), transparent 40%), #0b1120;
      color: #f8fafc;
      font-family: "Inter", "Segoe UI", "Roboto", sans-serif;
    }

    .layout {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 20px 64px;
      display: grid;
      gap: 24px;
    }

    .card.glass-card {
      background: rgba(15, 23, 42, 0.6);
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.18);
      box-shadow: 0 25px 45px rgba(2, 6, 23, 0.35);
      backdrop-filter: blur(18px);
      color: #f1f5f9;
    }

    .muted {
      color: rgba(226, 232, 240, 0.72);
      font-size: 0.92rem;
    }

    .panel-header {
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    @media (min-width: 860px) {
      .panel-header {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
      }
    }

    .panel-header h1 {
      margin: 0;
      font-size: 1.9rem;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.9rem;
      align-items: flex-end;
    }

    .toolbar .field {
      display: flex;
      flex-direction: column;
      min-width: 160px;
    }

    .toolbar label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(226, 232, 240, 0.65);
      margin-bottom: 0.25rem;
    }

    .toolbar select,
    .toolbar input {
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.7);
      color: #f8fafc;
      padding: 0.46rem 0.7rem;
      font-size: 0.95rem;
    }

    .btn {
      border-radius: 10px;
      font-weight: 600;
    }

    .btn.secondary {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: #e2e8f0;
    }

    .btn.secondary:hover {
      border-color: rgba(148, 163, 184, 0.85);
    }

    .btn.danger {
      background: rgba(239, 68, 68, 0.9);
      color: #fff;
    }

    .btn.ok {
      background: rgba(16, 185, 129, 0.88);
      color: #0f172a;
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: #e2e8f0;
    }

    .btn.sm {
      padding: 0.35rem 0.75rem;
      font-size: 0.85rem;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .chip {
      padding: 0.28rem 0.65rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
    }

    .chip.ok {
      background: rgba(16, 185, 129, 0.2);
      color: #bbf7d0;
    }

    .chip.warn {
      background: rgba(234, 179, 8, 0.25);
      color: #fcd34d;
    }

    .chip.bad {
      background: rgba(248, 113, 113, 0.24);
      color: #fecaca;
    }

    .chip.muted {
      background: rgba(148, 163, 184, 0.18);
      color: #e2e8f0;
    }

    .stats-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .stat-card {
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 14px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .stat-card .label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(226, 232, 240, 0.68);
    }

    .stat-card span:last-child {
      font-size: 1.55rem;
      font-weight: 700;
      color: #f8fafc;
    }

    .list-card .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .table-head {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(226, 232, 240, 0.65);
      padding-bottom: 0.6rem;
      border-bottom: 1px solid rgba(148, 163, 184, 0.24);
      margin-bottom: 0.25rem;
    }

    .student-row {
      display: grid;
      grid-template-columns: 1.9fr 0.85fr 1fr 1.1fr auto;
      gap: 0.75rem;
      align-items: center;
      padding: 0.9rem 0;
      border-bottom: 1px solid rgba(148, 163, 184, 0.16);
    }

    .student-row:last-child {
      border-bottom: none;
    }

    .student-row .name {
      font-weight: 600;
      font-size: 1rem;
    }

    .student-row .meta {
      margin-top: 0.25rem;
      font-size: 0.8rem;
      color: rgba(226, 232, 240, 0.7);
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .student-row .actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.45rem;
    }

    .tag {
      display: inline-block;
      margin-left: 0.35rem;
      font-size: 0.75rem;
      color: rgba(226, 232, 240, 0.7);
    }

    .skeleton {
      height: 1rem;
      border-radius: 6px;
      background: linear-gradient(90deg, rgba(148, 163, 184, 0.16), rgba(148, 163, 184, 0.38), rgba(148, 163, 184, 0.16));
      background-size: 200% 100%;
      animation: shimmer 1.2s ease-in-out infinite;
    }

    @keyframes shimmer {
      from { background-position: 200% 0; }
      to { background-position: -200% 0; }
    }

    .toast {
      position: fixed;
      bottom: 32px;
      right: 32px;
      padding: 0.75rem 1.2rem;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.9);
      color: #f8fafc;
      box-shadow: 0 20px 40px rgba(2, 6, 23, 0.4);
      transition: opacity 0.25s ease;
      z-index: 30;
    }

    .toast.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .reason-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
      padding: 1.5rem;
    }

    .reason-modal {
      background: rgba(15, 23, 42, 0.92);
      color: #f8fafc;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.24);
      box-shadow: 0 30px 60px rgba(2, 6, 23, 0.5);
      width: min(520px, 92vw);
      padding: 1.5rem;
    }

    .reason-modal h3 {
      margin-top: 0;
      margin-bottom: 0.35rem;
    }

    .reason-list {
      display: grid;
      gap: 0.6rem;
      margin: 1rem 0;
    }

    .reason-list label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      cursor: pointer;
    }

    .reason-modal textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.65);
      color: #f8fafc;
      padding: 0.6rem 0.75rem;
      resize: vertical;
      min-height: 72px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1.2rem;
    }

    @media (max-width: 720px) {
      .student-row {
        grid-template-columns: 1fr;
      }
      .student-row .actions {
        justify-content: flex-start;
      }
      .toolbar {
        flex-direction: column;
        align-items: stretch;
      }
      .toolbar .field {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="contextBar" class="bar"></div>

  <main class="layout">
    <section class="card glass-card panel">
      <div class="panel-header">
        <div>
          <h1>Transport Attendance</h1>
          <p class="muted" id="selectedDateLabel">Loading date...</p>
          <div class="chips" id="vehicleMeta"></div>
        </div>
        <div class="toolbar">
          <div class="field">
            <label for="vehicleSelect">Vehicle</label>
            <select id="vehicleSelect"></select>
          </div>
          <div class="field">
            <label for="yearSelect">Year</label>
            <select id="yearSelect"></select>
          </div>
          <div class="field">
            <label for="monthSelect">Month</label>
            <select id="monthSelect">
              <option value="1">January</option>
              <option value="2">February</option>
              <option value="3">March</option>
              <option value="4">April</option>
              <option value="5">May</option>
              <option value="6">June</option>
              <option value="7">July</option>
              <option value="8">August</option>
              <option value="9">September</option>
              <option value="10">October</option>
              <option value="11">November</option>
              <option value="12">December</option>
            </select>
          </div>
          <div class="field">
            <label for="daySelect">Day</label>
            <select id="daySelect"></select>
          </div>
          <button id="todayBtn" class="btn secondary">Today</button>
          <button id="finalizeBtn" class="btn danger">Finalize Day</button>
        </div>
      </div>
    </section>

    <section class="card glass-card stats">
      <div class="stats-grid">
        <div class="stat-card">
          <span class="label">Assigned</span>
          <span id="kpiAssigned">--</span>
        </div>
        <div class="stat-card">
          <span class="label">Present</span>
          <span id="kpiPresent">--</span>
        </div>
        <div class="stat-card">
          <span class="label">Absent</span>
          <span id="kpiAbsent">--</span>
        </div>
        <div class="stat-card">
          <span class="label">Unmarked</span>
          <span id="kpiUnmarked">--</span>
        </div>
        <div class="stat-card">
          <span class="label">Paid-Up</span>
          <span id="kpiPaid">--</span>
        </div>
        <div class="stat-card">
          <span class="label">In-Debt</span>
          <span id="kpiDebt">--</span>
        </div>
        <div class="stat-card">
          <span class="label">Inactivity Alerts</span>
          <span id="kpiInactive">--</span>
        </div>
      </div>
    </section>

    <section class="card glass-card list-card">
      <div class="list-header">
        <strong>Riders on this vehicle</strong>
        <span class="muted" id="loadInfo">Loading...</span>
      </div>
      <div class="student-row table-head">
        <div>Student & Route</div>
        <div>Class</div>
        <div>Balance</div>
        <div>Status</div>
        <div>Actions</div>
      </div>
      <div id="studentsList"></div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>

  <div id="reasonModalBackdrop" class="reason-modal-backdrop">
    <div class="reason-modal">
      <h3>Mark rider absent</h3>
      <p class="muted">Select a reason so we can follow up with families.</p>
      <div class="reason-list">
        <label><input type="radio" name="absReason" value="SICK" checked/> SICK</label>
        <label><input type="radio" name="absReason" value="TRANSPORT FEE"/> TRANSPORT FEE</label>
        <label><input type="radio" name="absReason" value="SCHOOL FEE"/> SCHOOL FEE</label>
        <label><input type="radio" name="absReason" value="QUIT USING"/> QUIT USING</label>
        <label><input type="radio" name="absReason" value="OTHER"/> OTHER</label>
      </div>
      <label for="absNote" class="muted">Optional note</label>
      <textarea id="absNote" placeholder="Add a short note (optional)"></textarea>
      <div class="modal-actions">
        <button id="reasonCancel" class="btn ghost" type="button">Cancel</button>
        <button id="reasonOk" class="btn danger" type="button">Mark Absent</button>
      </div>
    </div>
  </div>

  <script src="./modules/transport_roles.js"></script>
  <script src="./modules/transport_helpers.js"></script>
  <script src="./modules/transport_context.js"></script>

  <script>
    (function() {
      "use strict";

      const contextBar = document.getElementById("contextBar");
      const selectedDateLabel = document.getElementById("selectedDateLabel");
      const vehicleMeta = document.getElementById("vehicleMeta");
      const vehicleSelect = document.getElementById("vehicleSelect");
      const yearSelect = document.getElementById("yearSelect");
      const monthSelect = document.getElementById("monthSelect");
      const daySelect = document.getElementById("daySelect");
      const todayBtn = document.getElementById("todayBtn");
      const finalizeBtn = document.getElementById("finalizeBtn");
      const loadInfo = document.getElementById("loadInfo");
      const studentsList = document.getElementById("studentsList");
      const toast = document.getElementById("toast");
      const urlParams = new URLSearchParams(window.location.search);
      const queryRole = TransportRoles.normalize(urlParams.get("role"));
      const preferredVehicleParam = (urlParams.get("vehicle") || "").trim();

      const kpiAssigned = document.getElementById("kpiAssigned");
      const kpiPresent = document.getElementById("kpiPresent");
      const kpiAbsent = document.getElementById("kpiAbsent");
      const kpiUnmarked = document.getElementById("kpiUnmarked");
      const kpiPaid = document.getElementById("kpiPaid");
      const kpiDebt = document.getElementById("kpiDebt");
      const kpiInactive = document.getElementById("kpiInactive");

      const modalBackdrop = document.getElementById("reasonModalBackdrop");
      const reasonOk = document.getElementById("reasonOk");
      const reasonCancel = document.getElementById("reasonCancel");
      const absNote = document.getElementById("absNote");

      const now = new Date();
      const hasDateOverride = urlParams.has("month") || urlParams.has("day");
      let initialContext = TransportContext.getContext();
      if (!hasDateOverride) {
        initialContext = TransportContext.setContext({
          month: now.getMonth() + 1,
          day: now.getDate()
        });
      }

      const state = {
        user: null,
        role: "guest",
        context: initialContext,
        buses: [],
        drivers: [],
        students: {},
        assignments: [],
        attendanceMap: {},
        ledgerMap: {},
        summaryMap: {},
        loadingLedgers: false,
        pendingAbsence: null,
        preferredVehicle: preferredVehicleParam || null,
        routeVehicleMap: {},
        allEnrollments: {}
      };

      let contextRun = 0;

      function canUse() {
        // Allow unrestricted access for transport attendance page.
        return true;
      }

      function escapeHtml(value) {
        return String(value ?? "").replace(/[&<>"']/g, function(ch) {
          switch (ch) {
            case "&": return "&amp;";
            case "<": return "&lt;";
            case ">": return "&gt;";
            case "\"": return "&quot;";
            case "'": return "&#39;";
            default: return ch;
          }
        });
      }

      function formatTzs(amount) {
        const num = Number(amount) || 0;
        if (window.TransportHelpers && typeof TransportHelpers.fmtTZS === "function") {
          return TransportHelpers.fmtTZS(num);
        }
        return "TZS " + num.toLocaleString("en-US");
      }

      function showToast(message, tone) {
        toast.textContent = message;
        toast.style.background = tone === "bad" ? "rgba(239, 68, 68, 0.92)" : "rgba(15, 23, 42, 0.92)";
        toast.classList.remove("hidden");
        setTimeout(function() {
          toast.classList.add("hidden");
        }, 3200);
      }

      function currentYmd() {
        const ctx = state.context;
        return String(ctx.year) + "-" + String(ctx.month).padStart(2, "0") + "-" + String(ctx.day).padStart(2, "0");
      }

      function updateSelectedDateLabel() {
        const ymd = currentYmd();
        const safeDate = new Date(ymd + "T00:00:00");
        if (Number.isNaN(safeDate.getTime())) {
          selectedDateLabel.textContent = "Selected date " + ymd;
        } else {
          selectedDateLabel.textContent = safeDate.toLocaleDateString("en-US", {
            weekday: "short",
            year: "numeric",
            month: "long",
            day: "numeric"
          });
        }
        return ymd;
      }

      function loadYearOptions(min, max) {
        let html = "";
        for (let year = min; year <= max; year += 1) {
          html += '<option value="' + year + '">' + year + "</option>";
        }
        yearSelect.innerHTML = html;
      }

      function refreshDayOptions(targetDay) {
        const y = Number(yearSelect.value || state.context.year);
        const m = Number(monthSelect.value || state.context.month);
        const total = new Date(y, m, 0).getDate();
        let html = "";
        for (let d = 1; d <= total; d += 1) {
          html += '<option value="' + d + '">' + d + "</option>";
        }
        daySelect.innerHTML = html;
        let dayToSelect = targetDay || state.context.day || 1;
        if (dayToSelect > total) dayToSelect = total;
        daySelect.value = String(dayToSelect);
      }

      function syncSelectorsFromContext() {
        yearSelect.value = String(state.context.year);
        monthSelect.value = String(state.context.month);
        refreshDayOptions(state.context.day);
      }

      function getDriverNameForVehicle(vehicleId) {
        const bus = state.buses.find(function(b) { return b.id === vehicleId; });
        if (!bus) return "";
        const uid = bus.assignedDriverUid || bus.driverUid || bus.driverId || bus.assignedDriverId || "";
        if (uid && state.drivers) {
          const d = state.drivers.find(function(dr) { return dr.id === uid; });
          if (d) return d.fullName || "";
        }
        return bus.assignedDriverName || bus.driverName || bus.driverFullName || bus.driver || "";
      }

      function setVehicleMeta() {
        const vehicleId = vehicleSelect.value;
        const bus = state.buses.find(function(item) { return item.id === vehicleId; });
        if (!bus) {
          vehicleMeta.innerHTML = "";
          return;
        }
        const chips = [];
        const label = bus.alias || bus.name || bus.plate || bus.id;
        if (label) {
          chips.push('<span class="chip ok">Vehicle ' + escapeHtml(label) + "</span>");
        }
        if (bus.plate) {
          chips.push('<span class="chip muted">Plate ' + escapeHtml(bus.plate) + "</span>");
        }
        if (bus.capacity) {
          chips.push('<span class="chip muted">Capacity ' + escapeHtml(bus.capacity) + "</span>");
        }
        const driverName = getDriverNameForVehicle(vehicleId);
        if (driverName) {
          chips.push('<span class="chip warn">Driver ' + escapeHtml(driverName) + "</span>");
        } else {
          chips.push('<span class="chip bad">Driver not assigned</span>');
        }
        if (bus.route) {
          chips.push('<span class="chip muted">Route ' + escapeHtml(bus.route) + "</span>");
        }
        const routes = bus.assignedRoutes;
        if (routes && (Array.isArray(routes) ? routes.length : Object.keys(routes || {}).length) > 0) {
          const rList = Array.isArray(routes) ? routes : Object.values(routes || {});
          chips.push('<span class="chip muted">Routes ' + escapeHtml(rList.slice(0, 3).join(", ")) + "</span>");
        }
        vehicleMeta.innerHTML = chips.join("");
      }

      function isSocratesAlias() {
        const s = String(state.context.school || "").toLowerCase().trim();
        return s === "socrates-school" || s === "socrates" || s === "default";
      }

      async function loadBuses() {
        const items = [];
        const year = state.context.year;
        const school = state.context.school;

        const pathsToTry = [
          "transport/" + school + "/" + year + "/buses",
          "schools/" + school + "/years/" + year + "/transport/buses"
        ];
        if (isSocratesAlias()) {
          pathsToTry.push("transport/socrates-school/" + year + "/buses");
          pathsToTry.push("transport/socrates/" + year + "/buses");
        }
        pathsToTry.push("transport/-O_HndQaeuNugluTYPdp/" + year + "/buses");

        let snapshot = null;
        for (const p of pathsToTry) {
          snapshot = await firebase.database().ref(p).get();
          if (snapshot.exists() && snapshot.val() && typeof snapshot.val() === "object" && Object.keys(snapshot.val()).length > 0) {
            break;
          }
        }
        if (snapshot) {
          snapshot.forEach(function(child) {
            const value = child.val() || {};
            items.push({
              id: child.key,
              ...value
            });
          });
        }
        
        items.sort(function(a, b) {
          const aLabel = (a.alias || a.name || a.plate || a.id || "").toLowerCase();
          const bLabel = (b.alias || b.name || b.plate || b.id || "").toLowerCase();
          if (aLabel < bLabel) return -1;
          if (aLabel > bLabel) return 1;
          return 0;
        });
        state.buses = items;

        if (!items.length) {
          vehicleSelect.innerHTML = '<option value="">No vehicles available</option>';
          vehicleSelect.disabled = true;
          setVehicleMeta();
          return;
        }

        vehicleSelect.disabled = false;
        vehicleSelect.innerHTML = items.map(function(bus) {
          return '<option value="' + escapeHtml(bus.id) + '">' + escapeHtml(bus.alias || bus.name || bus.plate || bus.id) + "</option>";
        }).join("");

        let nextVehicle = vehicleSelect.value;
        if (state.preferredVehicle) {
          const preferred = items.find(function(bus) {
            return bus.id === state.preferredVehicle;
          });
          if (preferred) {
            nextVehicle = preferred.id;
          }
        }
        if (!items.some(function(bus) { return bus.id === nextVehicle; })) {
          nextVehicle = items[0].id;
        }
        vehicleSelect.value = nextVehicle;
        state.preferredVehicle = null;

        setVehicleMeta();
      }
      function normalizeRoutes(raw) {
        if (!raw) return [];
        if (Array.isArray(raw)) return raw.map(function(r) { return String(r || "").trim(); }).filter(Boolean);
        if (typeof raw === "object") {
          const entries = Object.entries(raw);
          const isArrayLike = entries.every(function(e) { return String(Number(e[0])) === e[0]; });
          if (isArrayLike) {
            return entries.sort(function(a, b) { return Number(a[0]) - Number(b[0]); })
              .map(function(e) { return String(e[1] || "").trim(); }).filter(Boolean);
          }
          return entries.map(function(e) { return String(e[1] || e[0] || "").trim(); }).filter(Boolean);
        }
        if (typeof raw === "string") return raw.split(/[|;,\n]+/).map(function(s) { return s.trim(); }).filter(Boolean);
        return [];
      }

      function buildRouteVehicleMap() {
        const map = {};
        const norm = function(s) { return String(s || "").toLowerCase().trim(); };
        state.buses.forEach(function(v) {
          const routeCandidates = [
            v.assignedRoutes, v.routes, v.routeNames, v.route, v.routeName,
            v.stopNames, v.stops, v.amStop, v.pmStop, v.morningRoute, v.eveningRoute
          ];
          const routesList = [];
          routeCandidates.forEach(function(rc) {
            normalizeRoutes(rc).forEach(function(r) { if (r) routesList.push(r); });
          });
          routesList.forEach(function(routeName) {
            const key = norm(routeName);
            if (key && !map[key]) map[key] = v.id;
          });
        });
        state.routeVehicleMap = map;
      }

      async function expandRouteVehicleMapWithCatalog() {
        const year = state.context.year;
        const school = state.context.school;
        const paths = [
          "schools/" + school + "/transportCatalog/" + year + "/stops",
          "transportCatalog/" + year + "/stops"
        ];
        for (const p of paths) {
          const snap = await firebase.database().ref(p).get();
          if (snap.exists() && snap.val()) {
            const catalog = snap.val();
            const norm = function(s) { return String(s || "").toLowerCase().trim(); };
            Object.keys(catalog).forEach(function(stopId) {
              const stop = catalog[stopId];
              if (!stop) return;
              const stopName = norm(stop.name || stop.id || stopId || "");
              const vehicleId = state.routeVehicleMap[stopName];
              if (vehicleId) {
                state.routeVehicleMap[norm(stopId)] = vehicleId;
                state.routeVehicleMap[stopId] = vehicleId;
              }
            });
            break;
          }
        }
      }

      function resolveBusIdFromRef(ref) {
        const k = String(ref || "").trim();
        if (!k) return null;
        if (state.buses.some(function(b) { return b.id === k; })) return k;
        const norm = function(s) { return String(s || "").toLowerCase().replace(/\s+/g, ""); };
        const keyNorm = norm(k);
        const byPlate = state.buses.find(function(b) {
          return norm(b.plate || b.plateNo || b.registration || "") === keyNorm;
        });
        return byPlate ? byPlate.id : null;
      }

      function resolveVehicleIdForEnrollment(en) {
        if (!en) return null;
        const vid = en.vehicleId || en.busId || en.assignedVehicleId || "";
        let resolved = resolveBusIdFromRef(vid);
        if (resolved) return resolved;
        const mv = en.morningVehicle;
        const ev = en.eveningVehicle;
        const mvId = (mv && (mv.vehicleId || mv.id)) || "";
        const evId = (ev && (ev.vehicleId || ev.id)) || "";
        resolved = resolveBusIdFromRef(mvId) || resolveBusIdFromRef(evId);
        if (resolved) return resolved;
        const norm = function(s) { return String(s || "").toLowerCase().trim(); };
        const amStop = norm(en.amStop || en.pickupStop || en.morningStop || "");
        const pmStop = norm(en.pmStop || en.dropoffStop || en.eveningStop || "");
        if (amStop && state.routeVehicleMap[amStop]) return state.routeVehicleMap[amStop];
        if (pmStop && state.routeVehicleMap[pmStop]) return state.routeVehicleMap[pmStop];
        const partial = Object.keys(state.routeVehicleMap).find(function(k) {
          return (amStop && (amStop.indexOf(k) >= 0 || k.indexOf(amStop) >= 0)) ||
                 (pmStop && (pmStop.indexOf(k) >= 0 || k.indexOf(pmStop) >= 0));
        });
        return partial ? state.routeVehicleMap[partial] : null;
      }

      async function loadDrivers() {
        const year = String(state.context.year);
        const school = state.context.school;
        const driverById = {};
        const workerPaths = [
          "workers",
          "years/" + year + "/workers",
          "schools/" + school + "/workers",
          "schools/" + school + "/years/" + year + "/workers"
        ];
        for (const p of workerPaths) {
          const snap = await firebase.database().ref(p).get();
          if (snap.exists()) {
            snap.forEach(function(child) {
              if (driverById[child.key]) return;
              const w = child.val() || {};
              const profile = w.profile || {};
              const role = String(profile.role || w.role || "").toLowerCase().trim();
              if (role !== "driver" && role !== "dereva") return;
              if (profile.active === false) return;
              const fullName = profile.fullNameUpper || profile.fullName || w.fullName ||
                [profile.firstName, profile.middleName, profile.lastName].filter(Boolean).join(" ") ||
                [w.firstName, w.middleName, w.lastName].filter(Boolean).join(" ") || child.key;
              driverById[child.key] = { id: child.key, fullName: String(fullName || "").trim() || "Unknown" };
            });
          }
        }
        state.drivers = Object.values(driverById);
      }

      async function loadAllEnrollmentsAndAssignments() {
        const year = String(state.context.year);
        const school = state.context.school;
        const validSchools = [school, "socrates-school", "socrates", "default", "-O_HndQaeuNugluTYPdp", "HndQaeuNugluTYPdp"];

        const [enrollScoped, enrollLegacy, assignScoped, assignLegacy, registryScoped, registryLegacy] = await Promise.all([
          firebase.database().ref("schools/" + school + "/years/" + year + "/transportEnrollments").get(),
          isSocratesAlias() ? firebase.database().ref("transport_enrollments").get() : Promise.resolve({ exists: () => false }),
          firebase.database().ref("schools/" + school + "/years/" + year + "/transportAssignments").get(),
          isSocratesAlias() ? firebase.database().ref("transportAssignments/" + year).get() : Promise.resolve({ exists: () => false }),
          firebase.database().ref("schools/" + school + "/years/" + year + "/transportRegistry").get().catch(function() { return { exists: () => false }; }),
          isSocratesAlias() ? firebase.database().ref("transportRegistry/" + year).get().catch(function() { return { exists: () => false }; }) : Promise.resolve({ exists: () => false })
        ]);

        const enrollments = {};
        if (enrollScoped.exists()) {
          enrollScoped.forEach(function(c) {
            const v = c.val();
            if (v) enrollments[c.key] = { ...v, studentId: c.key };
          });
        }
        if (enrollLegacy.exists()) {
          enrollLegacy.forEach(function(c) {
            const v = c.val() || {};
            if (!v.school || validSchools.includes(v.school)) {
              if (!enrollments[c.key]) enrollments[c.key] = { ...v, studentId: v.studentId || c.key };
            }
          });
        }
        if (registryScoped.exists()) {
          registryScoped.forEach(function(c) {
            const v = c.val();
            if (v && v.using === true && !enrollments[c.key]) {
              enrollments[c.key] = { studentId: c.key, amStop: v.routeId || "", pmStop: v.stopName || "" };
            }
          });
        }
        if (registryLegacy.exists()) {
          registryLegacy.forEach(function(c) {
            const v = c.val();
            if (v && v.using === true && !enrollments[c.key]) {
              enrollments[c.key] = { studentId: c.key, amStop: v.routeId || "", pmStop: v.stopName || "" };
            }
          });
        }

        const assignments = {};
        if (assignScoped.exists()) {
          assignScoped.forEach(function(c) {
            const v = c.val();
            if (v) assignments[c.key] = v;
          });
        }
        if (assignLegacy.exists()) {
          assignLegacy.forEach(function(c) {
            const v = c.val();
            if (v && !assignments[c.key]) assignments[c.key] = v;
          });
        }

        Object.keys(assignments).forEach(function(studentId) {
          const assign = assignments[studentId];
          if (assign && assign.status !== "Using") {
            delete enrollments[studentId];
            return;
          }
          const existing = enrollments[studentId] || {};
          const amStop = assign.morningRouteId || assign.amStop || existing.amStop || "";
          const pmStop = assign.eveningRouteId || assign.pmStop || existing.pmStop || "";
          const mv = assign.morningVehicle || existing.morningVehicle;
          const ev = assign.eveningVehicle || existing.eveningVehicle;
          const mvId = (mv && (mv.vehicleId || mv.id)) || null;
          const evId = (ev && (ev.vehicleId || ev.id)) || null;
          enrollments[studentId] = {
            ...existing,
            ...assign,
            studentId: studentId,
            amStop: amStop,
            pmStop: pmStop,
            morningVehicleId: mvId,
            eveningVehicleId: evId
          };
        });

        state.allEnrollments = enrollments;
      }

      async function loadAssignmentsForVehicle(vehicleId) {
        if (!vehicleId) {
          state.assignments = [];
          return;
        }
        buildRouteVehicleMap();
        await expandRouteVehicleMapWithCatalog();

        if (Object.keys(state.allEnrollments).length === 0) {
          await loadAllEnrollmentsAndAssignments();
        }

        const list = [];
        Object.keys(state.allEnrollments).forEach(function(studentId) {
          const en = state.allEnrollments[studentId];
          const resolvedVid = resolveVehicleIdForEnrollment(en);
          if (resolvedVid !== vehicleId) return;

          const student = state.students[studentId] || {};
          const fullName = [student.firstName, student.middleName, student.lastName].filter(Boolean).join(" ").trim();
          list.push({
            ...en,
            enrollmentId: studentId,
            studentId: studentId,
            studentName: fullName || en.studentName || en.name || en.displayName || "Unknown student",
            className: student.classLevel || en.className || en.class || en.grade || "",
            route: en.route || en.routeName || "",
            amStop: en.amStop || en.pickupStop || en.morningStop || "",
            pmStop: en.pmStop || en.dropoffStop || en.eveningStop || ""
          });
        });
        list.sort(function(a, b) { return (a.studentName || "").localeCompare(b.studentName || ""); });
        state.assignments = list;
      }

      async function loadAttendanceForDay(vehicleId, ymd) {
        if (!vehicleId) {
          state.attendanceMap = {};
          return;
        }
        const school = state.context.school;
        const year = state.context.year;
        const pathsToTry = ["transport/" + school + "/" + year + "/attendance/" + ymd + "/" + vehicleId];
        if (isSocratesAlias()) {
          pathsToTry.push("transport/socrates-school/" + year + "/attendance/" + ymd + "/" + vehicleId);
          pathsToTry.push("transport/socrates/" + year + "/attendance/" + ymd + "/" + vehicleId);
        }
        let merged = {};
        for (const p of pathsToTry) {
          const snapshot = await firebase.database().ref(p).get();
          if (snapshot.exists() && snapshot.val()) {
            merged = { ...merged, ...snapshot.val() };
          }
        }
        state.attendanceMap = merged;
      }

      async function loadSummaryForVehicle(vehicleId) {
        if (!vehicleId) {
          state.summaryMap = {};
          return;
        }
        const school = state.context.school;
        const year = state.context.year;
        const pathsToTry = ["transport/" + school + "/" + year + "/attendance_summary/" + vehicleId];
        if (isSocratesAlias()) {
          pathsToTry.push("transport/socrates-school/" + year + "/attendance_summary/" + vehicleId);
          pathsToTry.push("transport/socrates/" + year + "/attendance_summary/" + vehicleId);
        }
        let merged = {};
        for (const p of pathsToTry) {
          const snapshot = await firebase.database().ref(p).get();
          if (snapshot.exists() && snapshot.val()) {
            merged = { ...merged, ...snapshot.val() };
          }
        }
        state.summaryMap = merged;
      }

      async function loadLedgersForMonth() {
        const ctx = state.context;
        const tasks = state.assignments.map(function(st) {
          if (!st.studentId) return Promise.resolve();
          const path = TransportHelpers.paths.ledgerMonth(st.studentId, ctx.year, ctx.month);
          return firebase.database().ref(path).get()
            .then(function(snap) {
              const ledger = snap.val() || {};
              const expected = Number(ledger.expected || 0);
              const paid = Number(ledger.paid || 0);
              const balance = Number(ledger.balance !== undefined ? ledger.balance : expected - paid);
              state.ledgerMap[st.studentId] = {
                expected: expected,
                paid: paid,
                balance: balance
              };
            })
            .catch(function() {
              // ignore ledger fetch errors for single riders
            });
        });
        await Promise.allSettled(tasks);
      }

      function render() {
        setVehicleMeta();
        const assigned = state.assignments.length;
        let present = 0;
        let absent = 0;
        let unmarked = 0;
        let paid = 0;
        let debt = 0;
        let inactive = 0;

        if (!assigned) {
          studentsList.innerHTML = '<div class="muted" style="padding: 1rem 0;">No students are assigned to this vehicle for the selected year.</div>';
        } else {
          const rows = state.assignments.map(function(st) {
            const studentId = st.studentId;
            const attendance = state.attendanceMap[studentId];
            const ledger = state.ledgerMap[studentId];
            const summary = state.summaryMap[studentId] || {};
            let statusCell = '<span class="chip muted">Unmarked</span>';
            let reasonHtml = "";
            if (attendance && attendance.status === "present") {
              present += 1;
              statusCell = '<span class="chip ok">Present</span>';
            } else if (attendance && attendance.status === "absent") {
              absent += 1;
              statusCell = '<span class="chip bad">Absent</span>';
              if (attendance.reason) {
                reasonHtml = '<span class="tag">' + escapeHtml(attendance.reason) + "</span>";
              }
            } else {
              unmarked += 1;
            }

            let balanceCell = state.loadingLedgers ? '<div class="skeleton"></div>' : '<span class="chip muted">No ledger</span>';
            if (ledger) {
              if (ledger.balance <= 0) {
                paid += 1;
                balanceCell = '<span class="chip ok">Paid</span>';
              } else {
                debt += 1;
                balanceCell = '<span class="chip warn">' + escapeHtml(formatTzs(ledger.balance)) + "</span>";
              }
            }

            const consecutive = Number(summary.consecutive_absent_days || 0);
            let alertChip = "";
            if (consecutive >= 21) {
              inactive += 1;
              alertChip = '<span class="chip bad">3+ weeks inactive - review rider</span>';
            }

            const stopInfo = [];
            if (st.amStop) stopInfo.push("AM " + st.amStop);
            if (st.pmStop) stopInfo.push("PM " + st.pmStop);
            const routeInfo = [];
            if (st.route) routeInfo.push("Route " + st.route);
            if (stopInfo.length) routeInfo.push("Stops " + stopInfo.join(" / "));

            return (
              '<div class="student-row" data-student="' + escapeHtml(studentId) + '">' +
                '<div>' +
                  '<div class="name">' + escapeHtml(st.studentName || "Unknown student") + "</div>" +
                  '<div class="meta">' + (routeInfo.length ? escapeHtml(routeInfo.join(" | ")) : "No route details") + (alertChip ? " " + alertChip : "") + "</div>" +
                "</div>" +
                '<div>' + escapeHtml(st.className || "-") + "</div>" +
                '<div>' + balanceCell + "</div>" +
                '<div>' + statusCell + reasonHtml + "</div>" +
                '<div class="actions">' +
                  '<button class="btn sm ok js-present" type="button">Present</button>' +
                  '<button class="btn sm ghost js-absent" type="button">Absent</button>' +
                "</div>" +
              "</div>"
            );
          }).join("");
          studentsList.innerHTML = rows;
        }

        kpiAssigned.textContent = String(assigned);
        kpiPresent.textContent = String(present);
        kpiAbsent.textContent = String(absent);
        kpiUnmarked.textContent = String(unmarked);
        kpiPaid.textContent = String(paid);
        kpiDebt.textContent = String(debt);
        kpiInactive.textContent = String(inactive);

        if (vehicleSelect.disabled) {
          loadInfo.textContent = "No vehicles available";
        } else {
          loadInfo.textContent = vehicleSelect.value ? "Ready" : "Pick a vehicle";
        }
        finalizeBtn.disabled = !assigned || vehicleSelect.disabled;

        studentsList.querySelectorAll(".student-row").forEach(function(row) {
          const studentId = row.getAttribute("data-student");
          const presentBtn = row.querySelector(".js-present");
          const absentBtn = row.querySelector(".js-absent");
          if (presentBtn) {
            presentBtn.addEventListener("click", function() {
              markPresent(studentId);
            });
          }
          if (absentBtn) {
            absentBtn.addEventListener("click", function() {
              openReasonModal(studentId);
            });
          }
        });
      }

      function attendancePath(ymd, vehicleId, studentId) {
        return "transport/" + state.context.school + "/" + state.context.year + "/attendance/" + ymd + "/" + vehicleId + "/" + studentId;
      }

      function summaryPath(vehicleId, studentId) {
        return "transport/" + state.context.school + "/" + state.context.year + "/attendance_summary/" + vehicleId + "/" + studentId;
      }

      async function markPresent(studentId) {
        if (!canUse() || !studentId) return;
        const vehicleId = vehicleSelect.value;
        if (!vehicleId) return;
        const ymd = currentYmd();
        const record = {
          status: "present",
          reason: "OK",
          by: state.user.uid,
          ts: Date.now()
        };
        try {
          await firebase.database().ref(attendancePath(ymd, vehicleId, studentId)).set(record);
          await firebase.database().ref(summaryPath(vehicleId, studentId)).update({
            last_present_ymd: ymd,
            consecutive_absent_days: 0
          });
          state.attendanceMap[studentId] = record;
          const prevSummary = state.summaryMap[studentId] || {};
          state.summaryMap[studentId] = { ...prevSummary, last_present_ymd: ymd, consecutive_absent_days: 0 };
          render();
          showToast("Marked present");
        } catch (err) {
          console.error(err);
          showToast("Could not mark present", "bad");
        }
      }

      function openReasonModal(studentId) {
        state.pendingAbsence = { studentId: studentId };
        absNote.value = "";
        const defaultRadio = modalBackdrop.querySelector("input[name='absReason'][value='SICK']");
        if (defaultRadio) {
          defaultRadio.checked = true;
        }
        modalBackdrop.style.display = "flex";
      }

      function closeReasonModal() {
        modalBackdrop.style.display = "none";
        state.pendingAbsence = null;
      }

      modalBackdrop.addEventListener("click", function(event) {
        if (event.target === modalBackdrop) {
          closeReasonModal();
        }
      });

      async function markAbsentConfirmed() {
        if (!canUse() || !state.pendingAbsence) return;
        const studentId = state.pendingAbsence.studentId;
        const vehicleId = vehicleSelect.value;
        if (!studentId || !vehicleId) {
          closeReasonModal();
          return;
        }
        const ymd = currentYmd();
        const selected = modalBackdrop.querySelector("input[name='absReason']:checked");
        const reasonCode = selected ? selected.value : "OTHER";
        const note = absNote.value.trim();
        const record = {
          status: "absent",
          reason: note ? reasonCode + " - " + note : reasonCode,
          by: state.user.uid,
          ts: Date.now()
        };
        reasonOk.disabled = true;
        try {
          await firebase.database().ref(attendancePath(ymd, vehicleId, studentId)).set(record);
          const summaryRef = firebase.database().ref(summaryPath(vehicleId, studentId));
          const snap = await summaryRef.get();
          const value = snap.val() || {};
          const nextCount = Number(value.consecutive_absent_days || 0) + 1;
          await summaryRef.update({ consecutive_absent_days: nextCount });
          state.attendanceMap[studentId] = record;
          state.summaryMap[studentId] = { ...value, consecutive_absent_days: nextCount };
          render();
          showToast("Marked absent", "bad");
        } catch (err) {
          console.error(err);
          showToast("Could not mark absent", "bad");
        } finally {
          reasonOk.disabled = false;
          closeReasonModal();
        }
      }

      async function finalizeDay() {
        if (!canUse()) return;
        const vehicleId = vehicleSelect.value;
        if (!vehicleId) return;
        const ymd = currentYmd();
        const unmarked = state.assignments.filter(function(st) {
          return st.studentId && !state.attendanceMap[st.studentId];
        });
        if (!unmarked.length) {
          showToast("All riders already marked");
          return;
        }
        const confirmed = window.confirm("Mark " + unmarked.length + " unmarked riders as absent (NO SHOW)?");
        if (!confirmed) return;

        const now = Date.now();
        const updates = {};
        unmarked.forEach(function(st) {
          updates[attendancePath(ymd, vehicleId, st.studentId)] = {
            status: "absent",
            reason: "NO SHOW",
            by: state.user.uid,
            ts: now
          };
        });

        try {
          loadInfo.textContent = "Saving...";
          await firebase.database().ref().update(updates);

          for (const st of unmarked) {
            const ref = firebase.database().ref(summaryPath(vehicleId, st.studentId));
            const snap = await ref.get();
            const value = snap.val() || {};
            const nextCount = Number(value.consecutive_absent_days || 0) + 1;
            await ref.update({ consecutive_absent_days: nextCount });
            state.summaryMap[st.studentId] = { ...value, consecutive_absent_days: nextCount };
          }

          await loadAttendanceForDay(vehicleId, ymd);
          render();
          showToast("Finalized " + unmarked.length + " riders", "bad");
        } catch (err) {
          console.error(err);
          showToast("Could not finalize day", "bad");
        } finally {
          loadInfo.textContent = "Ready";
        }
      }

      async function loadStudents() {
        const students = {};
        const year = state.context.year;
        const school = state.context.school;

        const pathsToTry = ["students"];
        if (school) {
          pathsToTry.push("schools/" + school + "/students");
          pathsToTry.push("schools/" + school + "/years/" + year + "/students");
        }
        if (isSocratesAlias()) {
          pathsToTry.push("years/" + year + "/students");
        }

        for (const p of pathsToTry) {
          const snapshot = await firebase.database().ref(p).get();
          if (snapshot.exists()) {
            snapshot.forEach(function(child) {
              if (!students[child.key]) students[child.key] = child.val();
            });
          }
        }
        state.students = students;
      }

      async function reloadVehicleAndData() {
        const vehicleId = vehicleSelect.value;
        if (!vehicleId) {
          state.assignments = [];
          state.attendanceMap = {};
          state.summaryMap = {};
          state.ledgerMap = {};
          render();
          return;
        }
        loadInfo.textContent = "Loading...";
        await loadAssignmentsForVehicle(vehicleId);
        const ymd = currentYmd();
        await Promise.all([
          loadAttendanceForDay(vehicleId, ymd),
          loadSummaryForVehicle(vehicleId)
        ]);
        state.ledgerMap = {};
        state.loadingLedgers = true;
        render();
        await loadLedgersForMonth();
        state.loadingLedgers = false;
        render();
      }

      const onContextChange = async function(ctx) {
        contextRun += 1;
        const runId = contextRun;
        state.context = ctx;
        state.allEnrollments = {};
        syncSelectorsFromContext();
        updateSelectedDateLabel();
        try {
          await Promise.all([loadBuses(), loadStudents(), loadDrivers()]);
          if (runId !== contextRun) return;
          await reloadVehicleAndData();
        } catch (err) {
          console.error(err);
          showToast("Failed to load transport data", "bad");
        }
      };

      async function persistSelectorsToContext() {
        const year = Number(yearSelect.value);
        const month = Number(monthSelect.value);
        const daysInMonth = new Date(year, month, 0).getDate();
        let day = Number(daySelect.value) || 1;
        if (day > daysInMonth) day = daysInMonth;
        daySelect.value = String(day);
        state.context = TransportContext.setContext({ year: year, month: month, day: day });
        updateSelectedDateLabel();
        TransportContext.attachContextSelectors(contextBar, onContextChange);
        await onContextChange(state.context);
      }

      function wireUi() {
        loadYearOptions(2024, 2042);
        syncSelectorsFromContext();
        updateSelectedDateLabel();

        vehicleSelect.addEventListener("change", function() {
          setVehicleMeta();
          reloadVehicleAndData().catch(console.error);
        });

        yearSelect.addEventListener("change", function() {
          refreshDayOptions(state.context.day);
          persistSelectorsToContext().catch(console.error);
        });

        monthSelect.addEventListener("change", function() {
          refreshDayOptions(state.context.day);
          persistSelectorsToContext().catch(console.error);
        });

        daySelect.addEventListener("change", function() {
          persistSelectorsToContext().catch(console.error);
        });

        todayBtn.addEventListener("click", function() {
          const now = new Date();
          yearSelect.value = String(now.getFullYear());
          monthSelect.value = String(now.getMonth() + 1);
          refreshDayOptions(now.getDate());
          daySelect.value = String(now.getDate());
          persistSelectorsToContext().catch(console.error);
        });

        finalizeBtn.addEventListener("click", finalizeDay);
        reasonOk.addEventListener("click", markAbsentConfirmed);
        reasonCancel.addEventListener("click", closeReasonModal);

        TransportContext.attachContextSelectors(contextBar, onContextChange);
        onContextChange(state.context).catch(console.error);
      }

      function ensureAuth() {
        firebase.auth().onAuthStateChanged(async function(user) {
          if (!user) {
            document.body.innerHTML = '<div class="alert red" style="margin: 2rem;">Sign in required.</div>';
            return;
          }
          state.user = user;
          const candidateRoles = [];
          try {
            const roleSnap = await firebase.database().ref("users/" + user.uid + "/role").get();
            candidateRoles.push(TransportRoles.normalize(roleSnap.val()));
          } catch (err) {
            console.warn("Could not load role", err);
          }
          try {
            const profileRoleSnap = await firebase.database().ref("users/" + user.uid + "/profile/role").get();
            candidateRoles.push(TransportRoles.normalize(profileRoleSnap.val()));
          } catch (err) {
            console.debug("No profile role found for user", err);
          }
          if (queryRole) {
            candidateRoles.push(queryRole);
          }
          state.role =
            candidateRoles.find(function(role) { return TransportRoles.canViewTransport(role); }) ||
            candidateRoles.find(function(role) { return role; }) ||
            "guest";
          if (!canUse()) {
            const detail = state.role && state.role !== "guest" ? " (" + state.role + ")" : "";
            document.body.innerHTML = '<div class="alert red" style="margin: 2rem;">No permission for transport attendance' + detail + '. Contact your administrator.</div>';
            return;
          }
          console.info("Transport attendance role resolved as:", state.role, "Candidates:", candidateRoles);
          wireUi();
        });
      }

      ensureAuth();
    })();
  </script>
</body>
</html>
