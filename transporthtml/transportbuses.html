<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transport Vehicles ¬∑ Registry & Insurance</title>
    <link rel="stylesheet" href="./css/transport_dark.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div id="contextBar" class="bar">
      <div>
        <h1>üöê Vehicle Registry ¬∑ Bwalo la Usafiri</h1>
        <small>Comprehensive fleet management and documentation</small>
      </div>
      <div class="context-selectors">
        <div class="date-time-display">
          <span class="label">Today</span>
          <span class="value" id="currentDate">‚Äî</span>
        </div>
        <div>
          <label style="margin-bottom: 0.25rem; font-size: 0.75rem;">Academic Year</label>
          <select id="yearSelect" style="min-width: 100px; padding: 0.5rem;">
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
          </select>
        </div>
        <a href="transport.html" class="btn secondary">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <main style="padding:1.5rem; max-width:1400px; margin:0 auto;">
      <!-- KPI Cards Row -->
      <section class="row" id="kpiRow">
        <article class="card stat-card">
          <div class="stat-label">Loading...</div>
          <div class="stat-value">‚è≥</div>
        </article>
      </section>

      <!-- Alerts Section -->
      <section id="alerts" class="mt-2"></section>

      <!-- Header with Add Button -->
      <div class="flex space center mt-3">
        <h2 style="margin:0;">Vehicle Registry</h2>
        <button class="btn success" id="addVehicleBtn" type="button">+ Add Vehicle</button>
      </div>

      <!-- Vehicles Table -->
      <section class="card mt-2">
        <div style="overflow-x: auto;">
          <table class="table">
            <thead>
              <tr>
                <th>Plate</th>
                <th>Make & Model</th>
                <th>Owner</th>
                <th>Driver</th>
                <th>Capacity</th>
                <th>Routes</th>
                <th>Insurance</th>
                <th>Permit</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="vehiclesBody"></tbody>
          </table>
        </div>
        <div id="emptyState" class="empty hidden">
          No vehicles recorded for this school/year.<br />
          Tap "+ Add Vehicle" to begin.
        </div>
      </section>
    </main>

    <!-- Vehicle Modal -->
    <div id="vehicleModal" class="modal hidden">
      <div class="modal-content" style="max-width: 1200px;">
        <div class="flex space center mb-2">
          <h2 id="modalTitle" style="margin: 0;">Add Vehicle</h2>
          <button class="btn secondary" id="closeModalBtn" type="button">Close</button>
        </div>

        <div id="modalAlert" class="alert hidden"></div>

        <form id="vehicleForm" autocomplete="off">
          <div class="grid two">
            <!-- Vehicle Core Info -->
            <div class="card">
              <h3 style="margin-top: 0; color: var(--accent-primary);">üöê Vehicle Core Information</h3>
              <label for="plateInput">Plate / Registration Number <span style="color: red;">*</span></label>
              <input id="plateInput" required placeholder="T 123 ABC" />
              
              <label class="mt-1" for="modelInput">Make & Model <span style="color: red;">*</span></label>
              <input id="modelInput" required placeholder="Toyota Hiace 2020" />
              
              <label class="mt-1" for="capacityInput">Seating Capacity <span style="color: red;">*</span></label>
              <input id="capacityInput" type="number" min="1" required placeholder="30" />
              
              <label class="mt-1" for="colorInput">Colour / Notes</label>
              <input id="colorInput" placeholder="White, Blue stripes" />
              
              <label class="mt-1" for="statusSelect">Vehicle Status <span style="color: red;">*</span></label>
              <select id="statusSelect" required>
                <option value="active">‚úÖ Active (In Service)</option>
                <option value="maintenance">üîß Under Maintenance</option>
                <option value="inactive">‚ùå Inactive</option>
              </select>
            </div>

            <!-- Ownership Details -->
            <div class="card">
              <h3 style="margin-top: 0; color: var(--accent-success);">üë§ Ownership Details</h3>
              <label for="ownerNameInput">Owner Full Name <span style="color: red;">*</span></label>
              <input id="ownerNameInput" required placeholder="John Doe" />
              
              <label class="mt-1" for="ownerPhoneInput">Owner Phone Number <span style="color: red;">*</span></label>
              <input id="ownerPhoneInput" required placeholder="+255712345678" />
              
              <label class="mt-1" for="ownerNotesInput">Owner Notes / Address</label>
              <textarea id="ownerNotesInput" rows="2" placeholder="Any additional information about the owner"></textarea>
              
              <label class="mt-1" for="ownershipTypeInput">Ownership Type <span style="color: red;">*</span></label>
              <select id="ownershipTypeInput" required>
                <option value="">-- Select Ownership --</option>
                <option value="school_owned">üè´ School Owned (Not Paid)</option>
                <option value="contracted">üìÑ Contracted (Paid)</option>
              </select>
            </div>
          </div>

          <!-- Contract Details (shown only for contracted vehicles) -->
          <div id="contractSection" class="card mt-2" style="display: none;">
            <h3 style="margin-top: 0; color: var(--accent-warning);">üí∞ Payment Contract Terms</h3>
            <div class="grid two">
              <div>
                <label for="paymentFrequencyInput">Payment Frequency <span style="color: red;">*</span></label>
                <select id="paymentFrequencyInput">
                  <option value="">-- Select Frequency --</option>
                  <option value="weekly">Weekly (Kila Wiki)</option>
                  <option value="monthly">Monthly (Kila Mwezi)</option>
                  <option value="yearly">Yearly (Kila Mwaka)</option>
                </select>
              </div>
              <div>
                <label for="paymentAmountInput">Payment Amount (TZS) <span style="color: red;">*</span></label>
                <input id="paymentAmountInput" type="number" min="0" placeholder="500000" />
              </div>
            </div>
            <div class="mt-1">
              <label for="contractNotesInput">Contract Notes / Terms</label>
              <textarea id="contractNotesInput" rows="2" placeholder="Additional contract terms, conditions, or notes"></textarea>
            </div>
          </div>

          <!-- Driver Assignment -->
          <div class="card mt-2">
            <h3 style="margin-top: 0; color: var(--accent-info);">üë®‚Äç‚úàÔ∏è Driver Assignment</h3>
            <label for="assignedDriverSelect">Assigned Driver <span style="color: red;">*</span></label>
            <select id="assignedDriverSelect" required>
              <option value="">-- Select Driver --</option>
              <!-- Populated from workers database -->
            </select>
            <small class="muted">Drivers are loaded from Workers ‚Üí Dereva entries</small>
          </div>

          <!-- Route Assignment -->
          <div class="card mt-2">
            <h3 style="margin-top: 0; color: var(--accent-primary);">üó∫Ô∏è Route Assignment</h3>
            <p class="muted" style="margin: 0 0 1rem 0;">Assign one or more routes to this vehicle. Click "+ Add Route" to assign multiple routes.</p>
            <div id="routesContainer"></div>
            <button class="btn secondary mt-2" type="button" id="addRouteBtn">+ Add Route</button>
          </div>

          <!-- Insurance Details -->
          <div class="card mt-2">
            <h3 style="margin-top: 0; color: var(--accent-danger);">üìã Insurance Information</h3>
            <div class="grid two">
              <div>
                <label for="providerInput">Insurance Provider <span style="color: red;">*</span></label>
                <input id="providerInput" required placeholder="AAR Insurance" />
              </div>
              <div>
                <label for="policyInput">Policy Number <span style="color: red;">*</span></label>
                <input id="policyInput" required placeholder="POL-2025-12345" />
              </div>
              <div>
                <label for="expiryInput">Insurance Expiry Date <span style="color: red;">*</span></label>
                <input id="expiryInput" type="date" required />
              </div>
              <div>
                <label>Insurance Photo <span style="color: red;">*</span></label>
                <input id="insuranceFile" type="file" accept="image/*" capture="environment" required />
              </div>
            </div>
            <img id="insurancePreview" alt="" style="width:100%; max-height:220px; object-fit:contain; margin-top:0.5rem; display:none; border-radius: 8px;" />
          </div>

          <!-- Permits & Inspection -->
          <div class="card mt-2">
            <h3 style="margin-top: 0; color: var(--accent-warning);">‚úÖ Permits & Inspection</h3>
            <div class="grid two">
              <div>
                <label for="permitExpiryInput">Road Permit Expiry <span style="color: red;">*</span></label>
                <input id="permitExpiryInput" type="date" required />
              </div>
              <div>
                <label>Road Permit Photo <span style="color: red;">*</span></label>
                <input id="permitFile" type="file" accept="image/*" capture="environment" required />
              </div>
              <div>
                <label for="inspectionExpiryInput">Inspection Expiry <span style="color: red;">*</span></label>
                <input id="inspectionExpiryInput" type="date" required />
              </div>
              <div>
                <label>Inspection Photo <span style="color: red;">*</span></label>
                <input id="inspectionFile" type="file" accept="image/*" capture="environment" required />
              </div>
            </div>
            <div class="grid two mt-1">
              <img id="permitPreview" alt="" style="width:100%; max-height:220px; object-fit:contain; border-radius: 8px; display:none;" />
              <img id="inspectionPreview" alt="" style="width:100%; max-height:220px; object-fit:contain; border-radius: 8px; display:none;" />
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex mt-3" style="justify-content:flex-end; gap: 1rem; flex-wrap: wrap;">
            <button class="btn secondary" type="button" id="cancelBtn">Cancel</button>
            <button class="btn danger hidden" type="button" id="deleteVehicleBtn">üóëÔ∏è Delete Vehicle</button>
            <button class="btn success" type="submit" id="saveVehicleBtn">üíæ Save Vehicle</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Vehicle Details PDF Preview Modal -->
    <div id="pdfModal" class="modal hidden">
      <div class="modal-content" style="max-width: 900px;">
        <div class="flex space center mb-2">
          <h2 style="margin: 0;">Vehicle Details</h2>
          <div class="flex" style="gap: 0.5rem;">
            <button class="btn success" id="downloadPdfBtn">üì• Download PDF</button>
            <button class="btn secondary" id="closePdfModal">Close</button>
          </div>
        </div>
        <div id="pdfContent" style="background: white; color: black; padding: 2rem; border-radius: 8px;">
          <!-- PDF content will be generated here -->
        </div>
      </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script src="./modules/transport_roles.js"></script>
    <script src="./modules/transport_context.js"></script>
    <script src="./modules/transport_helpers.js"></script>
    <script src="./modules/transport_pricing.js"></script>
    <script>
      // Global State
      const state = {
        user: null,
        role: null,
        year: new Date().getFullYear(),
        school: TransportContext.getContext().school || "socrates",
        vehicles: [],
        drivers: [],
        currentId: null,
        uploads: {},
        routes: [], // Will store assigned routes
        vehiclesRef: null
      };

      // Routes loaded dynamically from transportCatalog (includes Morombo and any + Add Stop)
      let ALL_ROUTES = [];
      async function loadAllRoutes() {
        if (typeof TransportPricing?.loadStopsForYear !== 'function') return;
        const yearEl = document.getElementById('yearSelect');
        const year = state.year || (yearEl ? Number(yearEl.value) : null) || new Date().getFullYear();
        const stops = await TransportPricing.loadStopsForYear(year);
        ALL_ROUTES = (stops || [])
          .filter(s => s.active !== false)
          .map(s => {
            const name = String(s.name || s.id || '').trim();
            const fee = Number(s.baseFee) || 0;
            const tier = fee <= 17000 ? '(1 KM)' : fee <= 18500 ? '(1.5 KM)' : fee <= 21000 ? '(2 KM)' : fee <= 24000 ? '(3-4 KM)' : fee <= 25000 ? '(5-6 KM)' : fee <= 28000 ? '(6-10 KM)' : fee <= 38000 ? '(10-15 KM)' : '(NJE YA MAENEO)';
            return { value: name.toLowerCase(), label: `${name} ${tier}` };
          })
          .sort((a, b) => a.label.localeCompare(b.label));
      }

      // Elements
      const toast = document.getElementById("toast");
      const vehiclesBody = document.getElementById("vehiclesBody");
      const emptyState = document.getElementById("emptyState");
      const alertsEl = document.getElementById("alerts");
      const kpiRow = document.getElementById("kpiRow");
      const modal = document.getElementById("vehicleModal");
      const modalAlert = document.getElementById("modalAlert");
      const yearSelect = document.getElementById("yearSelect");
      const currentDateEl = document.getElementById("currentDate");
      const deleteVehicleBtn = document.getElementById("deleteVehicleBtn");

      // Utility Functions
      function showToast(message, tone = "ok") {
        toast.textContent = message;
        toast.classList.remove("hidden");
        toast.style.background = tone === "bad" ? "#dc2626" : "#10b981";
        setTimeout(() => toast.classList.add("hidden"), 3200);
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-TZ', { style: 'currency', currency: 'TZS', minimumFractionDigits: 0 }).format(amount || 0);
      }

      function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-GB');
      }

      function formatDateTime(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleString('en-GB');
      }

      // Update current date display
      function updateDateDisplay() {
        const now = new Date();
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        currentDateEl.textContent = now.toLocaleDateString('en-US', options);
      }
      updateDateDisplay();
      setInterval(updateDateDisplay, 1000);

      // Apply URL params for school/year if present
      (function applyUrlParams(){
        const params = new URLSearchParams(window.location.search);
        const y = parseInt(params.get('year'), 10);
        const sch = params.get('school');
        if (Number.isFinite(y)) state.year = y;
        if (sch) state.school = sch;
      })();

      function normalizeRole(role) {
        return String(role || "").trim().toLowerCase();
      }

      function isSocratesAlias() {
        const target = String(state.school || "").toLowerCase().trim();
        return target === "socrates-school" || target === "socrates" || target === "default";
      }

      function schoolScopedPath(subPath) {
        const clean = String(subPath || "").replace(/^\/+/, "");
        return `schools/${state.school}/${clean}`;
      }

      function getScopedBusesPath() {
        return schoolScopedPath(`years/${state.year}/transport/buses`);
      }

      function getLegacyBusesPaths() {
        if (!isSocratesAlias()) return [];
        const year = state.year;
        if (String(state.school || "").toLowerCase().trim() === "socrates-school") {
          return [
            `transport/socrates-school/${year}/buses`,
            `transport/socrates/${year}/buses`
          ];
        }
        return [`transport/socrates/${year}/buses`];
      }

      function isEmptySnapshot(snapshot) {
        if (!snapshot || !snapshot.exists()) return true;
        const val = snapshot.val();
        if (!val) return true;
        if (typeof val !== "object") return false;
        return Object.keys(val).length === 0;
      }

      // Year selection handler
      yearSelect.value = String(state.year);
      yearSelect.addEventListener('change', (e) => {
        state.year = parseInt(e.target.value, 10);
        loadDrivers()
          .then(() => subscribeVehicles())
          .catch((err) => {
            console.error('Error reloading drivers:', err);
            subscribeVehicles();
          });
      });

      function chipForExpiry(dateStr) {
        if (!dateStr) {
          return '<span class="chip warn">Missing</span>';
        }
        const today = new Date();
        const expiry = new Date(dateStr);
        const diff = expiry - today;
        if (Number.isNaN(expiry.getTime())) {
          return '<span class="chip warn">Invalid date</span>';
        }
        if (diff < 0) {
          return `<span class="chip bad">EXPIRED ${formatDate(dateStr)}</span>`;
        }
        const daysRemaining = Math.ceil(diff / (1000 * 60 * 60 * 24));
        if (daysRemaining <= 30) {
          return `<span class="chip warn">Expiring ${formatDate(dateStr)}</span>`;
        }
        return `<span class="chip ok">OK ${formatDate(dateStr)}</span>`;
      }

      // Render KPIs
      function renderKpis() {
        const totalActive = state.vehicles.filter((v) => v.status === "active").length;
        const maintenance = state.vehicles.filter((v) => v.status === "maintenance").length;
        const expired = state.vehicles.filter((v) => {
          if (!v.insuranceExpiry) return false;
          return new Date(v.insuranceExpiry) < new Date();
        }).length;
        const expiringSoon = state.vehicles.filter((v) => {
          if (!v.insuranceExpiry) return false;
          const diff = new Date(v.insuranceExpiry) - new Date();
          return diff >= 0 && diff <= 30 * 24 * 60 * 60 * 1000;
        }).length;

        const cards = [
          { label: "Active Vehicles", value: totalActive, color: "success" },
          { label: "In Maintenance", value: maintenance, color: "warning" },
          { label: "Expired Insurance", value: expired, color: "danger" },
          { label: "Expiring Soon (30d)", value: expiringSoon, color: "info" },
        ];

        kpiRow.innerHTML = cards.map(card => `
          <article class="card stat-card">
            <div class="stat-label">${card.label}</div>
            <div class="stat-value" style="color: var(--accent-${card.color});">${card.value}</div>
          </article>
        `).join("");
      }

      // Render Alerts
      function renderAlerts() {
        const expired = state.vehicles.filter((v) => {
          if (!v.insuranceExpiry) return false;
          return new Date(v.insuranceExpiry) < new Date();
        });
        const expiring = state.vehicles.filter((v) => {
          if (!v.insuranceExpiry) return false;
          const diff = new Date(v.insuranceExpiry) - new Date();
          return diff >= 0 && diff <= 30 * 24 * 60 * 60 * 1000;
        });

        const alerts = [];
        if (expired.length) {
          alerts.push(
            `<div class="alert red" style="animation: pulse 2s infinite;">
              üö® <strong>CRITICAL:</strong> ${expired.length} vehicle(s) with EXPIRED insurance: ${expired.map((v) => v.plate || v.id).join(", ")}. 
              <strong>RENEW INSURANCE IMMEDIATELY!</strong>
            </div>`
          );
        }
        if (expiring.length) {
          alerts.push(
            `<div class="alert amber">
              ‚ö†Ô∏è Insurance expiring within 30 days: ${expiring.map((v) => v.plate || v.id).join(", ")}.
            </div>`
          );
        }
        alertsEl.innerHTML = alerts.join("") || "";
      }

      // Resolve school id if a friendly name (e.g., "socrates") is provided
      async function resolveSchoolIdIfNeeded() {
        try {
          const looksLikeId = typeof state.school === 'string' && state.school.startsWith('-');
          if (looksLikeId) return; // Already an RTDB id

          const schoolsSnap = await firebase.database().ref('schools').get();
          if (!schoolsSnap.exists()) return;
          const schools = schoolsSnap.val() || {};

          const target = String(state.school || '').toLowerCase().trim();
          let matchedId = null;

          // Try match by an explicit slug field, then by name, then by id equality
          Object.keys(schools).some((id) => {
            const s = schools[id] || {};
            const slug = String(s.slug || '').toLowerCase();
            const name = String(s.name || '').toLowerCase();
            if (slug === target || name === target || id === state.school) {
              matchedId = id;
              return true;
            }
            // Fallback contains match for simple aliases like "socrates"
            if (!matchedId && (name.includes(target) || slug.includes(target))) {
              matchedId = id;
            }
            return false;
          });

          if (matchedId && matchedId !== state.school) {
            state.school = matchedId;
          }
        } catch (err) {
          console.warn('Failed to resolve school id', err);
        }
      }

      function canEdit() {
        // Always allow editing - simplified for now
        return true;
      }

      // Render Table
      function renderTable() {
        if (!state.vehicles.length) {
          emptyState.classList.remove("hidden");
          vehiclesBody.innerHTML = "";
          return;
        }
        emptyState.classList.add("hidden");

        vehiclesBody.innerHTML = state.vehicles.map((vehicle) => {
          const driver = state.drivers.find(d => d.id === vehicle.assignedDriverUid);
          const driverName = driver ? driver.fullName : (vehicle.assignedDriverUid || '‚Äî');
          
          const routes = vehicle.assignedRoutes || [];
          const routesDisplay = routes.length > 0 
            ? routes.map(r => `<span class="chip ok" style="margin: 2px;">${r}</span>`).join(' ')
            : '‚Äî';

          const actions = [];
          actions.push(`<button class="btn secondary" data-edit="${vehicle.id}">‚úèÔ∏è Edit</button>`);
          actions.push(`<button class="btn danger" data-delete="${vehicle.id}">üóëÔ∏è Delete</button>`);
          actions.push(`<button class="btn info" data-pdf="${vehicle.id}">üìÑ PDF</button>`);
          
          return `
            <tr>
              <td style="font-weight: 600;">${vehicle.plate || "‚Äî"}</td>
              <td>${vehicle.makeModel || "‚Äî"}</td>
              <td>
                ${vehicle.ownerName || "‚Äî"}<br/>
                <small class="muted">${vehicle.ownerPhone || ""}</small>
              </td>
              <td>${driverName}</td>
              <td>${vehicle.capacity || "‚Äî"}</td>
              <td>${routesDisplay}</td>
              <td>${chipForExpiry(vehicle.insuranceExpiry)}</td>
              <td>${chipForExpiry(vehicle.roadPermitExpiry)}</td>
              <td>
                <span class="chip ${vehicle.status === "active" ? "ok" : vehicle.status === "maintenance" ? "warn" : "bad"}">
                  ${vehicle.status || "‚Äî"}
                </span>
              </td>
              <td class="table-actions">${actions.join(" ")}</td>
            </tr>
          `;
        }).join("");

        // Attach event listeners
        vehiclesBody.querySelectorAll("button[data-edit]").forEach((btn) => {
          btn.addEventListener("click", () => openModal(btn.dataset.edit));
        });
        vehiclesBody.querySelectorAll("button[data-delete]").forEach((btn) => {
          btn.addEventListener("click", () => handleDeleteVehicle(btn.dataset.delete));
        });
        vehiclesBody.querySelectorAll("button[data-pdf]").forEach((btn) => {
          btn.addEventListener("click", () => generatePDF(btn.dataset.pdf));
        });
      }

      // Load Drivers from Workers Database
      async function loadDrivers() {
        try {
          const year = String(state.year);
          const scopedWorkersRef = firebase.database().ref(schoolScopedPath(`years/${year}/workers`));
          const snapshots = [scopedWorkersRef.once('value')];
          if (isSocratesAlias()) {
            snapshots.push(firebase.database().ref(`years/${year}/workers`).once('value'));
          }
          const workerSnaps = await Promise.all(snapshots);
          state.drivers = [];
          const driversById = new Map();
          
          workerSnaps.forEach((workersSnap) => {
            if (!workersSnap || !workersSnap.exists()) return;
            workersSnap.forEach(workerSnap => {
              const worker = workerSnap.val() || {};
              const profile = worker.profile || {};
              const roleValue = normalizeRole(profile.role || worker.role);
              if (roleValue !== 'driver' || profile.active === false) return;
              if (driversById.has(workerSnap.key)) return;
              const fullName = profile.fullNameUpper
                || `${profile.firstName || ''} ${profile.middleName || ''} ${profile.lastName || ''}`.trim();
              driversById.set(workerSnap.key, {
                id: workerSnap.key,
                fullName: fullName || 'Unnamed Driver',
                phone: profile.phone || worker.phone || '',
                firstName: profile.firstName,
                middleName: profile.middleName,
                lastName: profile.lastName
              });
            });
          });

          state.drivers = Array.from(driversById.values());

          // Populate driver dropdown
          const driverSelect = document.getElementById('assignedDriverSelect');
          driverSelect.innerHTML = '<option value="">-- Select Driver --</option>' +
            state.drivers.map(d => `<option value="${d.id}">${d.fullName} (${d.phone})</option>`).join('');
          
          console.log('Loaded drivers:', state.drivers.length);
        } catch (error) {
          console.error('Error loading drivers:', error);
          showToast('Failed to load drivers', 'bad');
        }
      }

      // Add Route Card
      function addRouteCard(routeValue = '') {
        const container = document.getElementById('routesContainer');
        const routeId = `route_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        const routeCard = document.createElement('div');
        routeCard.className = 'card mt-1';
        routeCard.id = routeId;
        routeCard.style.background = 'rgba(59, 130, 246, 0.05)';
        routeCard.style.border = '1px solid rgba(59, 130, 246, 0.2)';
        
        const routeNorm = String(routeValue || '').toLowerCase().trim();
        routeCard.innerHTML = `
          <div class="flex space center">
            <label style="flex: 1; margin: 0;">
              <span style="font-size: 0.875rem; font-weight: 600;">Select Route</span>
              <select class="route-select" style="margin-top: 0.5rem;" data-route-id="${routeId}">
                <option value="">-- Select Route --</option>
                ${(ALL_ROUTES || []).map(r => `<option value="${r.value}" ${r.value === routeNorm ? 'selected' : ''}>${r.label}</option>`).join('')}
              </select>
            </label>
            <button type="button" class="btn secondary" onclick="removeRouteCard('${routeId}')" style="margin-top: 1.5rem;">‚ùå Remove</button>
          </div>
        `;
        
        container.appendChild(routeCard);
      }

      function removeRouteCard(routeId) {
        const card = document.getElementById(routeId);
        if (card) card.remove();
      }

      // Make removeRouteCard available globally
      window.removeRouteCard = removeRouteCard;

      // Add route button handler
      document.getElementById('addRouteBtn').addEventListener('click', () => {
        addRouteCard();
      });

      // Ownership type change handler
      document.getElementById('ownershipTypeInput').addEventListener('change', (e) => {
        const contractSection = document.getElementById('contractSection');
        const paymentFrequency = document.getElementById('paymentFrequencyInput');
        const paymentAmount = document.getElementById('paymentAmountInput');
        
        if (e.target.value === 'contracted') {
          contractSection.style.display = 'block';
          paymentFrequency.required = true;
          paymentAmount.required = true;
        } else {
          contractSection.style.display = 'none';
          paymentFrequency.required = false;
          paymentAmount.required = false;
        }
      });

      // File preview handlers
      function setupFilePreview(fileInputId, previewId) {
        const fileInput = document.getElementById(fileInputId);
        const preview = document.getElementById(previewId);
        
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (event) => {
            preview.src = event.target.result;
            preview.style.display = 'block';
          };
          reader.readAsDataURL(file);
          state.uploads[fileInputId] = file;
        });
      }

      setupFilePreview('insuranceFile', 'insurancePreview');
      setupFilePreview('permitFile', 'permitPreview');
      setupFilePreview('inspectionFile', 'inspectionPreview');

      // Upload files to Cloudinary
      async function uploadIfNeeded(school, year, busId) {
        const uploads = {};
        const uploadPromises = [];
        const cloudName = 'dg7vnrkgd';
        const uploadPreset = 'somap_unsigned';
        
        for (const [key, file] of Object.entries(state.uploads)) {
          if (!file) continue;
          
          const folder = `transport/${school}/${year}/buses/${busId}`;
          const uploadPromise = uploadFileToCloudinary(file, folder, cloudName, uploadPreset)
            .then(url => { 
              uploads[key] = url; 
              console.log(`Successfully uploaded ${key}`);
            })
            .catch(err => {
              console.error(`Failed to upload ${key}:`, err);
              // Continue even if upload fails - don't break the whole save
            });
          
          uploadPromises.push(uploadPromise);
        }
        
        // Wait for all uploads (success or failure)
        await Promise.all(uploadPromises);
        return uploads;
      }

      // Helper function to upload single file to Cloudinary
      async function uploadFileToCloudinary(file, folder, cloudName, uploadPreset) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);
        formData.append('folder', folder);
        
        const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/auto/upload`, {
          method: 'POST',
          body: formData
        });
        
        if (!res.ok) {
          const errorText = await res.text();
          throw new Error(`Cloudinary upload failed: ${res.status} - ${errorText}`);
        }
        
        const data = await res.json();
        if (!data.secure_url) {
          throw new Error('Cloudinary did not return a secure URL');
        }
        
        return data.secure_url;
      }

      // Reset Form
      function resetForm() {
        modalAlert.classList.add("hidden");
        modalAlert.classList.remove("red");
        modalAlert.textContent = "";
        
        const form = document.getElementById("vehicleForm");
        if (form) form.reset();
        
        document.getElementById("insurancePreview").style.display = "none";
        document.getElementById("permitPreview").style.display = "none";
        document.getElementById("inspectionPreview").style.display = "none";
        document.getElementById("contractSection").style.display = "none";
        document.getElementById("routesContainer").innerHTML = "";
        
        // Reset file input requirements for new vehicle
        document.getElementById("insuranceFile").required = true;
        document.getElementById("permitFile").required = true;
        document.getElementById("inspectionFile").required = true;
        
        // Reset save button
        const saveBtn = document.getElementById("saveVehicleBtn");
        if (saveBtn) {
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save Vehicle';
        }
        
        addRouteCard(); // Add one default route card
        state.uploads = {};
        state.currentId = null;
        if (deleteVehicleBtn) {
          deleteVehicleBtn.classList.add("hidden");
          deleteVehicleBtn.disabled = false;
          deleteVehicleBtn.textContent = 'üóëÔ∏è Delete Vehicle';
        }
      }

      // Open Modal
      async function openModal(id = null) {
        await loadAllRoutes();
        resetForm();
        
        if (id) {
          const vehicle = state.vehicles.find((v) => v.id === id);
          if (!vehicle) return;
          
          state.currentId = id;
          document.getElementById("modalTitle").textContent = `Edit Vehicle: ${vehicle.plate}`;
          document.getElementById("plateInput").value = vehicle.plate || "";
          document.getElementById("modelInput").value = vehicle.makeModel || "";
          document.getElementById("capacityInput").value = vehicle.capacity || "";
          document.getElementById("colorInput").value = vehicle.color || "";
          document.getElementById("statusSelect").value = vehicle.status || "active";
          document.getElementById("ownerNameInput").value = vehicle.ownerName || "";
          document.getElementById("ownerPhoneInput").value = vehicle.ownerPhone || "";
          document.getElementById("ownerNotesInput").value = vehicle.ownerNotes || "";
          document.getElementById("ownershipTypeInput").value = vehicle.ownershipType || "";
          document.getElementById("assignedDriverSelect").value = vehicle.assignedDriverUid || "";
          document.getElementById("providerInput").value = vehicle.insuranceProvider || "";
          document.getElementById("policyInput").value = vehicle.insurancePolicyNo || "";
          document.getElementById("expiryInput").value = vehicle.insuranceExpiry || "";
          document.getElementById("permitExpiryInput").value = vehicle.roadPermitExpiry || "";
          document.getElementById("inspectionExpiryInput").value = vehicle.inspectionExpiry || "";

          // Contract details
          if (vehicle.ownershipType === 'contracted') {
            document.getElementById("contractSection").style.display = "block";
            document.getElementById("paymentFrequencyInput").value = vehicle.paymentFrequency || "";
            document.getElementById("paymentAmountInput").value = vehicle.paymentAmount || "";
            document.getElementById("contractNotesInput").value = vehicle.contractNotes || "";
          }

          // Routes
          document.getElementById("routesContainer").innerHTML = "";
          const routes = vehicle.assignedRoutes || [];
          if (routes.length > 0) {
            routes.forEach(route => addRouteCard(route));
          } else {
            addRouteCard();
          }

          // Images
          if (vehicle.insurancePhotoUrl) {
            document.getElementById("insurancePreview").src = vehicle.insurancePhotoUrl;
            document.getElementById("insurancePreview").style.display = "block";
            // Make file inputs optional for editing
            document.getElementById("insuranceFile").required = false;
          }
          if (vehicle.roadPermitPhotoUrl) {
            document.getElementById("permitPreview").src = vehicle.roadPermitPhotoUrl;
            document.getElementById("permitPreview").style.display = "block";
            document.getElementById("permitFile").required = false;
          }
          if (vehicle.inspectionPhotoUrl) {
            document.getElementById("inspectionPreview").src = vehicle.inspectionPhotoUrl;
            document.getElementById("inspectionPreview").style.display = "block";
            document.getElementById("inspectionFile").required = false;
          }

          if (vehicle.insuranceExpiry && new Date(vehicle.insuranceExpiry) < new Date()) {
            modalAlert.textContent = "‚ö†Ô∏è INSURANCE EXPIRED ‚Äî RENEW INSURANCE BEFORE SERVICE.";
            modalAlert.classList.remove("hidden");
            modalAlert.classList.add("red");
          }
          if (deleteVehicleBtn) {
            deleteVehicleBtn.classList.remove("hidden");
            deleteVehicleBtn.disabled = false;
            deleteVehicleBtn.textContent = 'üóëÔ∏è Delete Vehicle';
          }
        } else {
          document.getElementById("modalTitle").textContent = "Add New Vehicle";
          addRouteCard(); // Add one default route card for new vehicles
          if (deleteVehicleBtn) {
            deleteVehicleBtn.classList.add("hidden");
          }
        }
        
        modal.classList.remove("hidden");
      }

      function closeModal() {
        modal.classList.add("hidden");
      }

      // Event Listeners
      document.getElementById("addVehicleBtn").addEventListener("click", () => {
        openModal();
      });

      document.getElementById("closeModalBtn").addEventListener("click", closeModal);
      document.getElementById("cancelBtn").addEventListener("click", closeModal);
      if (deleteVehicleBtn) {
        deleteVehicleBtn.addEventListener("click", () => {
          if (state.currentId) {
            handleDeleteVehicle(state.currentId, { fromModal: true });
          }
        });
      }

      // Save Vehicle
      document.getElementById("vehicleForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        console.log('=== VEHICLE SAVE FORM SUBMITTED ===');

        // Prevent double submission
        const saveBtn = document.getElementById("saveVehicleBtn");
        if (saveBtn.disabled) {
          console.log('Button already disabled, ignoring duplicate submission');
          return;
        }
        saveBtn.disabled = true;
        saveBtn.textContent = 'üíæ Saving...';
        console.log('Button disabled, starting save process');

        // Collect form data
        const plate = document.getElementById("plateInput").value.trim();
        const makeModel = document.getElementById("modelInput").value.trim();
        const capacity = Number(document.getElementById("capacityInput").value);
        const color = document.getElementById("colorInput").value.trim();
        const status = document.getElementById("statusSelect").value;
        const ownerName = document.getElementById("ownerNameInput").value.trim();
        const ownerPhone = document.getElementById("ownerPhoneInput").value.trim();
        const ownerNotes = document.getElementById("ownerNotesInput").value.trim();
        const ownershipType = document.getElementById("ownershipTypeInput").value;
        const assignedDriverUid = document.getElementById("assignedDriverSelect").value;
        const insuranceProvider = document.getElementById("providerInput").value.trim();
        const insurancePolicyNo = document.getElementById("policyInput").value.trim();
        const insuranceExpiry = document.getElementById("expiryInput").value;
        const roadPermitExpiry = document.getElementById("permitExpiryInput").value;
        const inspectionExpiry = document.getElementById("inspectionExpiryInput").value;

        // Collect routes
        const routeSelects = document.querySelectorAll('.route-select');
        const assignedRoutes = Array.from(routeSelects)
          .map(select => select.value)
          .filter(value => value !== '');

        if (assignedRoutes.length === 0) {
          console.log('VALIDATION ERROR: No routes assigned');
          modalAlert.textContent = "Please assign at least one route.";
          modalAlert.classList.remove("hidden");
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save Vehicle';
          return;
        }
        console.log('Route validation passed:', assignedRoutes);

        // Contract details
        let paymentFrequency = '';
        let paymentAmount = 0;
        let contractNotes = '';
        
        if (ownershipType === 'contracted') {
          paymentFrequency = document.getElementById("paymentFrequencyInput").value;
          paymentAmount = Number(document.getElementById("paymentAmountInput").value);
          contractNotes = document.getElementById("contractNotesInput").value.trim();
          
          if (!paymentFrequency || !paymentAmount) {
            modalAlert.textContent = "Please fill in all contract details for contracted vehicles.";
            modalAlert.classList.remove("hidden");
            saveBtn.disabled = false;
            saveBtn.textContent = 'üíæ Save Vehicle';
            return;
          }
        }

        // Validation
        if (!plate || !makeModel || !capacity || !ownerName || !ownerPhone || !ownershipType || !assignedDriverUid || 
            !insuranceProvider || !insurancePolicyNo || !insuranceExpiry || !roadPermitExpiry || !inspectionExpiry) {
          console.log('VALIDATION ERROR: Missing required fields');
          modalAlert.textContent = "Please fill in all required fields (marked with *).";
          modalAlert.classList.remove("hidden");
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save Vehicle';
          return;
        }
        console.log('Field validation passed');

        // Check if user is authenticated
        if (!state.user || !state.user.uid) {
          console.log('VALIDATION ERROR: Not authenticated');
          modalAlert.textContent = "Error: Not authenticated. Please sign in again.";
          modalAlert.classList.remove("hidden");
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save Vehicle';
          showToast('Authentication error', 'bad');
          return;
        }
        console.log('User authenticated:', state.user.uid);

        const isNew = !state.currentId;
        const dbPath = getScopedBusesPath();
        const ref = isNew
          ? firebase.database().ref(dbPath).push()
          : firebase.database().ref(`${dbPath}/${state.currentId}`);
        const busId = isNew ? ref.key : state.currentId;

        try {
          console.log('=== ENTERING TRY BLOCK ===');
          console.log('Starting save process for busId:', busId);
          showToast('Saving vehicle...', 'ok');
          
          // Upload files
          console.log('Uploading files...', Object.keys(state.uploads));
          const uploads = await uploadIfNeeded(state.school, state.year, busId);
          console.log('File uploads completed:', uploads);
          
          const payload = {
            plate,
            makeModel,
            capacity,
            color,
            status,
            ownerName,
            ownerPhone,
            ownerNotes,
            ownershipType,
            assignedDriverUid,
            assignedRoutes,
            insuranceProvider,
            insurancePolicyNo,
            insuranceExpiry,
            roadPermitExpiry,
            inspectionExpiry,
            insurancePhotoUrl: uploads.insuranceFile || (state.currentId ? state.vehicles.find((v) => v.id === state.currentId)?.insurancePhotoUrl || null : null),
            roadPermitPhotoUrl: uploads.permitFile || (state.currentId ? state.vehicles.find((v) => v.id === state.currentId)?.roadPermitPhotoUrl || null : null),
            inspectionPhotoUrl: uploads.inspectionFile || (state.currentId ? state.vehicles.find((v) => v.id === state.currentId)?.inspectionPhotoUrl || null : null),
            updatedAt: Date.now(),
            updatedBy: state.user.uid,
          };

          // Add contract details if contracted
          if (ownershipType === 'contracted') {
            payload.paymentFrequency = paymentFrequency;
            payload.paymentAmount = paymentAmount;
            payload.contractNotes = contractNotes;
          }

          if (isNew) {
            payload.createdAt = Date.now();
            payload.createdBy = state.user.uid;
            payload.registrationDate = new Date().toISOString();
          }

          console.log('Saving payload to Firebase...', payload);
          await ref.set(payload);
          console.log('Firebase save successful!');
          console.log('=== SAVE COMPLETED SUCCESSFULLY ===');
          showToast(`Vehicle saved successfully! ‚úÖ`, 'ok');
          closeModal();
        } catch (err) {
          console.error('=== SAVE ERROR ===', err);
          console.error(err);
          modalAlert.textContent = `Failed to save vehicle: ${err.message}`;
          modalAlert.classList.remove("hidden");
          showToast('Failed to save vehicle', 'bad');
          saveBtn.disabled = false;
          saveBtn.textContent = 'üíæ Save Vehicle';
        }
      });
      async function handleDeleteVehicle(vehicleId, options = {}) {
        const vehicle = state.vehicles.find((v) => v.id === vehicleId);
        if (!vehicle) return;
        if (!state.user || !state.user.uid) {
          showToast("Error: please sign in again before deleting.", "bad");
          return;
        }
        const confirmed = window.confirm(`Delete vehicle ${vehicle.plate || vehicle.id}? This action cannot be undone.`);
        if (!confirmed) return;

        const { fromModal = false } = options;
        if (fromModal && deleteVehicleBtn) {
          deleteVehicleBtn.disabled = true;
          deleteVehicleBtn.textContent = 'üóëÔ∏è Deleting...';
        }

        try {
          showToast("Deleting vehicle...");
          const path = `${getScopedBusesPath()}/${vehicleId}`;
          await firebase.database().ref(path).remove();
          showToast("Vehicle deleted successfully.", "ok");
          if (state.currentId === vehicleId) {
            closeModal();
          }
        } catch (error) {
          console.error("Failed to delete vehicle", error);
          showToast("Failed to delete vehicle", "bad");
          if (fromModal && deleteVehicleBtn) {
            deleteVehicleBtn.disabled = false;
            deleteVehicleBtn.textContent = 'üóëÔ∏è Delete Vehicle';
          }
        }
      }


      // Generate PDF
      function generatePDF(vehicleId) {
        const vehicle = state.vehicles.find(v => v.id === vehicleId);
        if (!vehicle) return;

        const driver = state.drivers.find(d => d.id === vehicle.assignedDriverUid);
        const driverName = driver ? driver.fullName : (vehicle.assignedDriverUid || 'Not Assigned');
        const routes = vehicle.assignedRoutes || [];

        const pdfContent = document.getElementById('pdfContent');
        pdfContent.innerHTML = `
          <div style="text-align: center; margin-bottom: 2rem;">
            <h1 style="color: #1f2937; margin: 0;">üöê SoMAp Transport System</h1>
            <h2 style="color: #6b7280; margin: 0.5rem 0 0 0;">Vehicle Registration Details</h2>
            <p style="color: #9ca3af; margin: 0.5rem 0 0 0;">Generated on ${formatDateTime(Date.now())}</p>
          </div>

          <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="color: #059669; margin: 0 0 1rem 0; border-bottom: 2px solid #059669; padding-bottom: 0.5rem;">Vehicle Information</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; width: 40%;">Plate Number:</td>
                <td style="padding: 0.5rem;">${vehicle.plate || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Make & Model:</td>
                <td style="padding: 0.5rem;">${vehicle.makeModel || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Seating Capacity:</td>
                <td style="padding: 0.5rem;">${vehicle.capacity || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Colour/Notes:</td>
                <td style="padding: 0.5rem;">${vehicle.color || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Status:</td>
                <td style="padding: 0.5rem;">${vehicle.status || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Registration Date:</td>
                <td style="padding: 0.5rem;">${formatDateTime(vehicle.createdAt || vehicle.registrationDate)}</td>
              </tr>
            </table>
          </div>

          <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="color: #2563eb; margin: 0 0 1rem 0; border-bottom: 2px solid #2563eb; padding-bottom: 0.5rem;">Ownership Details</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; width: 40%;">Owner Name:</td>
                <td style="padding: 0.5rem;">${vehicle.ownerName || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Owner Phone:</td>
                <td style="padding: 0.5rem;">${vehicle.ownerPhone || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Ownership Type:</td>
                <td style="padding: 0.5rem;">${vehicle.ownershipType === 'school_owned' ? 'üè´ School Owned' : 'üìÑ Contracted'}</td>
              </tr>
              ${vehicle.ownershipType === 'contracted' ? `
                <tr>
                  <td style="padding: 0.5rem; font-weight: 600;">Payment Frequency:</td>
                  <td style="padding: 0.5rem;">${vehicle.paymentFrequency || 'N/A'}</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem; font-weight: 600;">Payment Amount:</td>
                  <td style="padding: 0.5rem;">${formatCurrency(vehicle.paymentAmount || 0)}</td>
                </tr>
                <tr>
                  <td style="padding: 0.5rem; font-weight: 600;">Contract Notes:</td>
                  <td style="padding: 0.5rem;">${vehicle.contractNotes || 'N/A'}</td>
                </tr>
              ` : ''}
            </table>
          </div>

          <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <h3 style="color: #7c3aed; margin: 0 0 1rem 0; border-bottom: 2px solid #7c3aed; padding-bottom: 0.5rem;">Driver & Routes</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; width: 40%;">Assigned Driver:</td>
                <td style="padding: 0.5rem;">${driverName}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; vertical-align: top;">Assigned Routes:</td>
                <td style="padding: 0.5rem;">${routes.length > 0 ? routes.join(', ') : 'None'}</td>
              </tr>
            </table>
          </div>

          <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 1.5rem;">
            <h3 style="color: #dc2626; margin: 0 0 1rem 0; border-bottom: 2px solid #dc2626; padding-bottom: 0.5rem;">Insurance & Permits</h3>
            <table style="width: 100%; border-collapse: collapse;">
              <tr>
                <td style="padding: 0.5rem; font-weight: 600; width: 40%;">Insurance Provider:</td>
                <td style="padding: 0.5rem;">${vehicle.insuranceProvider || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Policy Number:</td>
                <td style="padding: 0.5rem;">${vehicle.insurancePolicyNo || 'N/A'}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Insurance Expiry:</td>
                <td style="padding: 0.5rem; ${new Date(vehicle.insuranceExpiry) < new Date() ? 'color: red; font-weight: 700;' : ''}">${formatDate(vehicle.insuranceExpiry)}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Road Permit Expiry:</td>
                <td style="padding: 0.5rem; ${new Date(vehicle.roadPermitExpiry) < new Date() ? 'color: red; font-weight: 700;' : ''}">${formatDate(vehicle.roadPermitExpiry)}</td>
              </tr>
              <tr>
                <td style="padding: 0.5rem; font-weight: 600;">Inspection Expiry:</td>
                <td style="padding: 0.5rem; ${new Date(vehicle.inspectionExpiry) < new Date() ? 'color: red; font-weight: 700;' : ''}">${formatDate(vehicle.inspectionExpiry)}</td>
              </tr>
            </table>
          </div>

          <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 0.875rem;">
            <p style="margin: 0;">SoMAp School Management System ¬∑ ${state.year}</p>
            <p style="margin: 0.25rem 0 0 0;">This document is computer-generated and valid without signature</p>
          </div>
        `;

        document.getElementById('pdfModal').classList.remove('hidden');
      }

      // Download PDF
      document.getElementById('downloadPdfBtn').addEventListener('click', () => {
        const element = document.getElementById('pdfContent');
        const opt = {
          margin: 10,
          filename: `vehicle_details_${Date.now()}.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
        showToast('PDF downloaded successfully!');
      });

      document.getElementById('closePdfModal').addEventListener('click', () => {
        document.getElementById('pdfModal').classList.add('hidden');
      });

      // Subscribe to Vehicles
      async function subscribeVehicles() {
        try {
          const scopedPath = getScopedBusesPath();
          const scopedRef = firebase.database().ref(scopedPath);
          const scopedSnap = await scopedRef.once('value');

          let resolvedPath = scopedPath;
          if (isEmptySnapshot(scopedSnap)) {
            const legacyPaths = getLegacyBusesPaths();
            for (const legacyPath of legacyPaths) {
              const legacySnap = await firebase.database().ref(legacyPath).once('value');
              if (!isEmptySnapshot(legacySnap)) {
                await scopedRef.set(legacySnap.val() || {});
                resolvedPath = scopedPath;
                break;
              }
            }
          }

          if (state.vehiclesRef) {
            state.vehiclesRef.off();
          }
          const ref = firebase.database().ref(resolvedPath);
          state.vehiclesRef = ref;
          
          ref.on("value", (snapshot) => {
            const vehicles = [];
            snapshot.forEach((child) => {
              const value = child.val() || {};
              vehicles.push({ id: child.key, ...value });
            });
            
            if (state.role === "driver") {
              state.vehicles = vehicles.filter((v) => v.assignedDriverUid === state.user.uid);
            } else {
              state.vehicles = vehicles;
            }
            
            renderKpis();
            renderAlerts();
            renderTable();
          }, (err) => {
            console.error(err);
            showToast("Failed to load vehicles", "bad");
          });
        } catch (err) {
          console.error(err);
          showToast("Failed to load vehicles", "bad");
        }
      }

      // Auth and Initialization
      function ensureAuth() {
        firebase.auth().onAuthStateChanged((user) => {
          if (!user) {
            showToast("Sign in first", "bad");
            vehiclesBody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem;">Please sign in to view vehicles.</td></tr>';
            return;
          }
          
          state.user = user;
          
          firebase.database().ref(`users/${user.uid}/role`).get()
            .then((snapshot) => {
              const roleRaw = snapshot.val();
              const role = TransportRoles.normalize(roleRaw);
              state.role = role || "admin"; // Default to admin for now
              
              console.log('User role loaded:', state.role, 'Raw:', roleRaw);
              
              // Resolve school id, load drivers, then subscribe to vehicles
              resolveSchoolIdIfNeeded().then(() => loadDrivers()).then(() => {
                subscribeVehicles();
              }).catch((err) => {
                console.error('Error loading drivers:', err);
                // Continue even if drivers fail to load
                resolveSchoolIdIfNeeded().then(() => subscribeVehicles());
              });
            })
            .catch((err) => {
              console.error(err);
              showToast("Failed to verify user", "bad");
              // Still allow using the page even if role check fails
              state.role = "admin";
              resolveSchoolIdIfNeeded().then(() => loadDrivers()).then(() => {
                subscribeVehicles();
              }).catch((err2) => {
                console.error('Error loading drivers:', err2);
                resolveSchoolIdIfNeeded().then(() => subscribeVehicles());
              });
            });
        });
      }

      // Initialize
      ensureAuth();
    </script>
  </body>
</html>
