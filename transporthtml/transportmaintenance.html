<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Transport Maintenance Hub</title>
    <link rel="stylesheet" href="./css/transport.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <style>
      :root {
        --glass-bg: rgba(15, 23, 42, 0.35);
        --glass-border: rgba(148, 163, 184, 0.35);
        --glass-soft: rgba(255, 255, 255, 0.1);
      }
      body {
        background:
          radial-gradient(1100px 500px at 0% 0%, rgba(34, 197, 94, 0.24), transparent 60%),
          radial-gradient(1200px 680px at 100% 0%, rgba(14, 165, 233, 0.2), transparent 60%),
          linear-gradient(140deg, #0b1220, #111827 42%, #172554);
        min-height: 100vh;
      }
      .glass {
        background: var(--glass-bg);
        border: 1px solid var(--glass-border);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        box-shadow: 0 20px 60px rgba(2, 6, 23, 0.45);
      }
      .stats {
        display: grid;
        gap: 0.9rem;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      }
      .stat-card {
        border-radius: 14px;
        padding: 0.9rem;
        border: 1px solid rgba(148, 163, 184, 0.32);
        background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
      }
      .stat-label {
        color: #cbd5e1;
        font-size: 0.77rem;
      }
      .stat-value {
        color: #f8fafc;
        font-size: 1.5rem;
        font-weight: 800;
        margin-top: 0.35rem;
      }
      .soko-list {
        max-height: 260px;
        overflow: auto;
        border: 1px solid rgba(148, 163, 184, 0.3);
        border-radius: 12px;
        padding: 0.4rem;
        background: rgba(15, 23, 42, 0.35);
      }
      .soko-row {
        border: 1px solid rgba(148, 163, 184, 0.25);
        border-radius: 10px;
        padding: 0.6rem;
        margin-bottom: 0.45rem;
        cursor: pointer;
        color: #e2e8f0;
        background: rgba(30, 41, 59, 0.55);
      }
      .soko-row:hover,
      .soko-row.active {
        border-color: rgba(56, 189, 248, 0.8);
        background: rgba(14, 116, 144, 0.45);
      }
      .surface {
        border-radius: 16px;
      }
      .head {
        color: #e2e8f0;
        margin: 0;
      }
      .sub {
        color: #94a3b8;
        font-size: 0.9rem;
      }
      .table th, .table td {
        vertical-align: top;
      }
    </style>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div id="contextBar" class="bar"></div>
    <main style="padding:1.2rem; max-width:1340px; margin:0 auto;">
      <section class="glass surface" style="padding:1rem;">
        <div class="flex space center">
          <div>
            <h2 class="head">Maintenance Hub</h2>
            <small class="sub">Unified driver + review desk. Soko-integrated spare requests with protection logic.</small>
          </div>
          <div class="chip-group">
            <button class="btn" data-tab="PENDING">Pending</button>
            <button class="btn secondary" data-tab="APPROVED">Approved</button>
            <button class="btn secondary" data-tab="REJECTED">Rejected</button>
          </div>
        </div>
        <div class="stats mt-2">
          <article class="stat-card"><div class="stat-label">Pending</div><div id="stPending" class="stat-value">0</div></article>
          <article class="stat-card"><div class="stat-label">Approved</div><div id="stApproved" class="stat-value">0</div></article>
          <article class="stat-card"><div class="stat-label">Rejected</div><div id="stRejected" class="stat-value">0</div></article>
          <article class="stat-card"><div class="stat-label">Flagged</div><div id="stFlagged" class="stat-value">0</div></article>
        </div>
      </section>

      <section id="composeCard" class="glass surface mt-2" style="padding:1rem;">
        <div class="flex space center">
          <h3 class="head" style="font-size:1.05rem;">Create Maintenance Request</h3>
          <small class="sub">Must pick an item from SoMAp soko.</small>
        </div>
        <form id="maintForm" class="grid two mt-1">
          <div>
            <label>Vehicle</label>
            <select id="vehicleSelect" required></select>
          </div>
          <div>
            <label>Part / Issue</label>
            <input id="partInput" required placeholder="e.g. SHOCK ABSORBER" />
          </div>
          <div>
            <label>Search Soko Item</label>
            <input id="sokoSearchInput" placeholder="search title / model / shop" />
          </div>
          <div>
            <label>Soko price</label>
            <input id="sokoPriceInput" readonly />
          </div>
          <div style="grid-column: span 2;">
            <label>Soko items (scroll list)</label>
            <div id="sokoList" class="soko-list"></div>
            <input id="sokoItemKey" type="hidden" />
            <small id="sokoMeta" class="sub"></small>
          </div>
          <div>
            <label>Quoted spare cost (TZS)</label>
            <input id="costInput" type="number" min="0" required />
          </div>
          <div>
            <label>Fundi labour (TZS)</label>
            <input id="labourCostInput" type="number" min="0" value="0" />
          </div>
          <div>
            <label>Fundi name</label>
            <input id="fundiNameInput" placeholder="Mechanic name" />
          </div>
          <div>
            <label>Odometer</label>
            <input id="odoInput" type="number" min="0" />
          </div>
          <div style="grid-column: span 2;">
            <label>Notes</label>
            <textarea id="notesInput" rows="3"></textarea>
          </div>
          <div style="grid-column: span 2;">
            <label>Photo (optional)</label>
            <input id="photoInput" type="file" accept="image/*" capture="environment" />
          </div>
          <div id="logicHint" class="alert amber hidden" style="grid-column: span 2;"></div>
          <div id="marketError" class="alert red hidden" style="grid-column: span 2;"></div>
          <div id="formError" class="alert red hidden" style="grid-column: span 2;"></div>
          <div style="grid-column: span 2; text-align:right;">
            <button class="btn" type="submit">Submit request</button>
          </div>
        </form>
      </section>

      <section class="glass surface mt-2" style="padding:1rem;">
        <div class="flex space center">
          <h3 class="head" style="font-size:1.05rem;">Maintenance Requests</h3>
          <small id="summary" class="sub"></small>
        </div>
        <table class="table mt-1">
          <thead>
            <tr>
              <th>Vehicle / Driver</th>
              <th>Part / Soko / Cost</th>
              <th>Odo</th>
              <th>Flags</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="maintBody"></tbody>
        </table>
        <div id="emptyState" class="empty hidden">No maintenance items.</div>
      </section>
    </main>
    <div id="toast" class="toast hidden"></div>

    <script src="./modules/transport_roles.js"></script>
    <script src="./modules/transport_helpers.js"></script>
    <script src="./modules/transport_context.js"></script>
    <script src="./modules/maintenance.js"></script>
    <script>
      const refs = {
        composeCard: document.getElementById("composeCard"),
        form: document.getElementById("maintForm"),
        vehicle: document.getElementById("vehicleSelect"),
        part: document.getElementById("partInput"),
        sokoSearch: document.getElementById("sokoSearchInput"),
        sokoList: document.getElementById("sokoList"),
        sokoItemKey: document.getElementById("sokoItemKey"),
        sokoMeta: document.getElementById("sokoMeta"),
        sokoPrice: document.getElementById("sokoPriceInput"),
        cost: document.getElementById("costInput"),
        labourCost: document.getElementById("labourCostInput"),
        fundiName: document.getElementById("fundiNameInput"),
        odo: document.getElementById("odoInput"),
        notes: document.getElementById("notesInput"),
        photo: document.getElementById("photoInput"),
        logicHint: document.getElementById("logicHint"),
        marketError: document.getElementById("marketError"),
        formError: document.getElementById("formError"),
        summary: document.getElementById("summary"),
        maintBody: document.getElementById("maintBody"),
        emptyState: document.getElementById("emptyState"),
      };
      const toast = document.getElementById("toast");
      const stats = {
        pending: document.getElementById("stPending"),
        approved: document.getElementById("stApproved"),
        rejected: document.getElementById("stRejected"),
        flagged: document.getElementById("stFlagged"),
      };
      const state = {
        user: null,
        profile: null,
        role: "",
        mode: new URLSearchParams(window.location.search).get("mode") || "",
        driverHint: { uid: "", name: "", vehicle: "" },
        context: TransportContext.getContext(),
        currentTab: "PENDING",
        requests: [],
        vehicles: [],
        sokoItems: [],
        sokoFiltered: [],
      };

      function showToast(message, tone = "ok") {
        toast.textContent = message;
        toast.classList.remove("hidden");
        toast.style.background = tone === "bad" ? "#dc2626" : "#1f2937";
        setTimeout(() => toast.classList.add("hidden"), 3200);
      }

      function showBox(el, text) {
        el.textContent = text || "";
        el.classList.toggle("hidden", !text);
      }

      function clearBoxes() {
        showBox(refs.logicHint, "");
        showBox(refs.marketError, "");
        showBox(refs.formError, "");
      }

      function isDriver() {
        const r = String(state.role || "").toLowerCase();
        if (r.includes("driver") || r === "dereva") return true;
        if (state.mode !== "driver") return false;
        return !r;
      }

      function hydrateDriverHintFromQueryAndStorage() {
        const params = new URLSearchParams(window.location.search);
        const storedUid = localStorage.getItem("somap_driver_uid") || "";
        const storedName = localStorage.getItem("somap_driver_name") || "";
        const storedVehicle = localStorage.getItem("somap_vehicleId") || "";
        state.driverHint = {
          uid: String(params.get("driverUid") || params.get("uid") || storedUid || "").trim(),
          name: String(params.get("driverName") || params.get("driver") || params.get("name") || storedName || "").trim(),
          vehicle: String(params.get("vehicle") || storedVehicle || "").trim(),
        };
        if (state.driverHint.uid) localStorage.setItem("somap_driver_uid", state.driverHint.uid);
        if (state.driverHint.name) localStorage.setItem("somap_driver_name", state.driverHint.name);
        if (state.driverHint.vehicle) localStorage.setItem("somap_vehicleId", state.driverHint.vehicle);
      }

      function canReview() {
        const r = String(state.role || "").toLowerCase();
        if (r === "accountant" || r === "mhasibu") return true;
        return TransportRoles.isAdmin(state.role);
      }

      function selectedVehicle() {
        return state.vehicles.find((v) => v.id === refs.vehicle.value) || null;
      }

      function selectedSokoItem() {
        return state.sokoItems.find((x) => `${x.sellerId}::${x.itemId}` === refs.sokoItemKey.value) || null;
      }

      function computeStats() {
        const list = state.requests;
        const pending = list.filter((x) => (x.status || "PENDING") === "PENDING").length;
        const approved = list.filter((x) => x.status === "APPROVED").length;
        const rejected = list.filter((x) => x.status === "REJECTED").length;
        const flagged = list.filter((x) => (Array.isArray(x.flags) && x.flags.length) || x.repeatPart || x.purchasedTooSoon).length;
        stats.pending.textContent = String(pending);
        stats.approved.textContent = String(approved);
        stats.rejected.textContent = String(rejected);
        stats.flagged.textContent = String(flagged);
      }

      function renderSokoList() {
        const q = String(refs.sokoSearch.value || "").trim().toLowerCase();
        const vehicleModel = String(selectedVehicle()?.makeModel || "").toLowerCase();
        state.sokoFiltered = state.sokoItems.filter((item) => {
          const modelOk = !vehicleModel || !item.vehicleModel
            || item.vehicleModel.toLowerCase().includes(vehicleModel)
            || vehicleModel.includes(item.vehicleModel.toLowerCase());
          if (!modelOk) return false;
          if (!q) return true;
          const hay = `${item.title} ${item.vehicleModel} ${item.shopName} ${item.area} ${item.city}`.toLowerCase();
          return hay.includes(q);
        });
        if (!state.sokoFiltered.length) {
          refs.sokoList.innerHTML = `<div class="soko-row">No matching soko spare. Add item in <a href="../marketing/index.html" target="_blank">soko</a>.</div>`;
          return;
        }
        refs.sokoList.innerHTML = state.sokoFiltered.map((item) => {
          const key = `${item.sellerId}::${item.itemId}`;
          const active = key === refs.sokoItemKey.value ? "active" : "";
          return `
            <div class="soko-row ${active}" data-key="${key}">
              <strong>${item.title}</strong> 路 ${item.vehicleModel || "Any model"}<br/>
              <small>${TransportMaintenance.fmtMoney(item.price, item.currency)} 路 ${item.shopName} 路 ${item.phoneRaw || "-"}</small>
            </div>
          `;
        }).join("");
        refs.sokoList.querySelectorAll(".soko-row[data-key]").forEach((el) => {
          el.addEventListener("click", () => chooseSokoByKey(el.dataset.key));
        });
      }

      function chooseSokoByKey(key) {
        refs.sokoItemKey.value = key || "";
        const item = selectedSokoItem();
        if (!item) {
          refs.sokoPrice.value = "";
          refs.sokoMeta.textContent = "";
          renderSokoList();
          return;
        }
        refs.part.value = refs.part.value.trim() || item.title;
        refs.sokoPrice.value = TransportMaintenance.fmtMoney(item.price, item.currency || "TZS");
        refs.cost.value = refs.cost.value || String(Number(item.price || 0));
        refs.sokoMeta.textContent = `Shop: ${item.shopName} | Phone: ${item.phoneRaw || "-"} | WhatsApp: ${item.whatsappUrl || "-"} | Lipa: ${item.lipaNumber || "-"}`;
        renderSokoList();
      }

      async function uploadPhoto(requestId, vehicleId) {
        const file = refs.photo.files[0];
        if (!file) return null;
        const ref = firebase.storage().ref(`maintenance/${vehicleId}/${requestId}-${file.name}`);
        await ref.put(file);
        return ref.getDownloadURL();
      }

      async function loadReferences() {
        state.vehicles = await TransportMaintenance.listVehicles(state.context);
        state.sokoItems = await TransportMaintenance.listSokoVehicleItems();
        refs.vehicle.innerHTML = state.vehicles.length
          ? state.vehicles.map((v) => `<option value="${v.id}">${v.plate} - ${v.makeModel || "Unknown model"}</option>`).join("")
          : '<option value="">No vehicles</option>';
        if (state.user?.uid) {
          const snap = await firebase.database().ref(TransportHelpers.paths.deviceVehicle(state.user.uid)).get();
          const assigned = String(snap.val() || localStorage.getItem("somap_vehicleId") || "").trim();
          if (assigned && state.vehicles.some((v) => v.id === assigned)) refs.vehicle.value = assigned;
        } else {
          const assigned = String(state.driverHint.vehicle || localStorage.getItem("somap_vehicleId") || "").trim();
          if (assigned && state.vehicles.some((v) => v.id === assigned)) refs.vehicle.value = assigned;
        }
        renderSokoList();
      }

      function rowActions(req) {
        const downloadPdfBtn = req.status === "APPROVED" ? `<button class="btn secondary" data-pdf="${req.id}">PDF</button>` : "";
        const printBtn = req.status === "APPROVED" ? `<button class="btn secondary" data-invoice="${req.id}">Print</button>` : "";
        if (!canReview() || req.status !== "PENDING") return `${downloadPdfBtn} ${printBtn}`;
        return `
          <div class="table-actions">
            <button class="btn" data-approve="${req.id}">Approve</button>
            <button class="btn danger" data-reject="${req.id}">Reject</button>
            ${downloadPdfBtn} ${printBtn}
          </div>
        `;
      }

      function priceBlock(req) {
        const quoted = Number(req.estCost || 0);
        const soko = Number(req.sokoPrice || 0);
        const labour = Number(req.fundiLabourCost || 0);
        const deltaPct = Number(req.priceDeltaPct || 0);
        const dir = req.priceDirection || "NA";
        const tone = dir === "ABOVE_SOKO" ? "bad" : dir === "BELOW_SOKO" ? "warn" : "ok";
        const chip = soko > 0 ? `<span class="chip ${tone}">${deltaPct > 0 ? "+" : ""}${deltaPct.toFixed(1)}%</span>` : "";
        return `
          <small class="muted">Quoted: ${TransportMaintenance.fmtMoney(quoted)}</small><br/>
          <small class="muted">Soko: ${TransportMaintenance.fmtMoney(soko, req.sokoCurrency || "TZS")} ${chip}</small><br/>
          <small class="muted">Labour: ${TransportMaintenance.fmtMoney(labour)} | Total: ${TransportMaintenance.fmtMoney(quoted + labour)}</small>
        `;
      }

      function visibleRequests() {
        const byTab = state.requests.filter((r) => (r.status || "PENDING") === state.currentTab);
        if (canReview()) return byTab;
        if (isDriver()) return byTab.filter((r) => r.driverUid === state.user?.uid);
        return [];
      }

      function renderTable() {
        computeStats();
        const list = visibleRequests();
        refs.summary.textContent = `${list.length} ${state.currentTab.toLowerCase()} request(s)`;
        if (!list.length) {
          refs.emptyState.classList.remove("hidden");
          refs.maintBody.innerHTML = "";
          return;
        }
        refs.emptyState.classList.add("hidden");
        refs.maintBody.innerHTML = list.map((req) => `
          <tr>
            <td>
              <strong>${req.vehiclePlate || req.vehicleId || "-"}</strong><br/>
              <small class="muted">${req.vehicleModel || "-"}</small><br/>
              <small class="muted">${req.driverName || "-"}</small>
            </td>
            <td>
              <strong>${req.part || "-"}</strong><br/>
              <small class="muted">${req.sokoShopName || "No shop"} 路 ${req.sokoPhone || "-"}</small><br/>
              ${priceBlock(req)}
            </td>
            <td>${req.odoKm || "-"}</td>
            <td>${TransportMaintenance.flagBadges(req)}</td>
            <td>${req.notes || "-"}</td>
            <td>${rowActions(req)}</td>
          </tr>
        `).join("");
        refs.maintBody.querySelectorAll("button[data-approve]").forEach((btn) => btn.addEventListener("click", () => approveRequest(btn.dataset.approve)));
        refs.maintBody.querySelectorAll("button[data-reject]").forEach((btn) => btn.addEventListener("click", () => rejectRequest(btn.dataset.reject)));
        refs.maintBody.querySelectorAll("button[data-invoice]").forEach((btn) => btn.addEventListener("click", () => printInvoice(btn.dataset.invoice)));
        refs.maintBody.querySelectorAll("button[data-pdf]").forEach((btn) => btn.addEventListener("click", () => downloadInvoice(btn.dataset.pdf)));
      }

      function subscribeRequests() {
        firebase.database().ref("maintenance_requests").on("value", (snapshot) => {
          const rows = [];
          snapshot.forEach((child) => {
            const value = child.val() || {};
            if (value.school && value.school !== state.context.school) return;
            if (Number(value.year || 0) && Number(value.year) !== Number(state.context.year)) return;
            rows.push({ id: child.key, ...value });
          });
          state.requests = rows;
          renderTable();
        }, (err) => {
          console.error(err);
          showToast("Failed to load maintenance requests", "bad");
        });
      }

      async function approveRequest(reqId) {
        const req = state.requests.find((r) => r.id === reqId);
        if (!req) return;
        const reviewerName =
          state.profile?.name ||
          state.profile?.profile?.fullName ||
          state.user?.email ||
          "Accountant";
        const ledgerBase = firebase.database().ref(TransportHelpers.paths.maintLedger(req.vehicleId));
        const entriesRef = ledgerBase.child("entries").push();
        const monthKey = `${req.year || state.context.year}-${String(req.month || state.context.month).padStart(2, "0")}`;
        try {
          await entriesRef.set({
            requestId: req.id,
            vehicleId: req.vehicleId,
            part: req.part,
            estCost: Number(req.estCost || 0),
            fundiLabourCost: Number(req.fundiLabourCost || 0),
            totalCost: Number(req.estCost || 0) + Number(req.fundiLabourCost || 0),
            odoKm: Number(req.odoKm || 0),
            notes: req.notes || "",
            approvedBy: state.user.uid,
            approvedByName: reviewerName,
            approvedAt: Date.now(),
          });
          await ledgerBase.child(`monthlyTotals/${monthKey}`).transaction((current) => {
            const c = current || { cost: 0 };
            return {
              cost: Number(c.cost || 0) + Number(req.estCost || 0) + Number(req.fundiLabourCost || 0),
              updatedAt: Date.now(),
            };
          });
          if (req.part) {
            await ledgerBase.child(`partsHistory/${TransportMaintenance.slug(req.part)}`).transaction((current) => {
              const h = current || [];
              h.push({ reqId, ts: Date.now(), cost: Number(req.estCost || 0) });
              return h.slice(-30);
            });
          }
          const invoice = TransportMaintenance.buildInvoiceObject({ id: reqId, ...req }, { uid: state.user.uid, name: reviewerName });
          await firebase.database().ref(`maintenance_invoices/${reqId}`).set(invoice);
          await firebase.database().ref(TransportHelpers.paths.maintRequest(reqId)).update({
            status: "APPROVED",
            reviewedBy: state.user.uid,
            reviewedByName: reviewerName,
            reviewedAt: Date.now(),
            invoiceNo: invoice.invoiceNo,
          });
          showToast("Approved and invoice created");
        } catch (err) {
          console.error(err);
          showToast("Approval failed", "bad");
        }
      }

      async function rejectRequest(reqId) {
        const reason = prompt("Rejection reason?");
        if (reason === null) return;
        try {
          await firebase.database().ref(TransportHelpers.paths.maintRequest(reqId)).update({
            status: "REJECTED",
            reviewedBy: state.user.uid,
            reviewedAt: Date.now(),
            rejectReason: reason,
          });
          showToast("Request rejected");
        } catch (err) {
          console.error(err);
          showToast("Failed to reject", "bad");
        }
      }

      async function getInvoice(reqId) {
        const req = state.requests.find((r) => r.id === reqId);
        if (!req) return null;
        const snap = await firebase.database().ref(`maintenance_invoices/${reqId}`).get();
        return snap.val() || TransportMaintenance.buildInvoiceObject({ id: reqId, ...req }, {});
      }

      async function printInvoice(reqId) {
        const invoice = await getInvoice(reqId);
        if (!invoice) return;
        TransportMaintenance.openPrintableInvoice(invoice);
      }

      async function downloadInvoice(reqId) {
        const invoice = await getInvoice(reqId);
        if (!invoice) return;
        await TransportMaintenance.downloadInvoicePdf(invoice);
      }

      refs.form.addEventListener("submit", async (event) => {
        event.preventDefault();
        clearBoxes();
        const vehicle = selectedVehicle();
        if (!vehicle) return showBox(refs.formError, "Select a vehicle first.");
        const partName = refs.part.value.trim();
        if (!partName) return showBox(refs.formError, "Part / issue is required.");

        let item = selectedSokoItem();
        if (!item) {
          const best = TransportMaintenance.findBestSokoMatch(state.sokoItems, partName, vehicle.makeModel);
          item = best ? best.item : null;
        }
        if (!item) {
          return showBox(refs.marketError, "This spare is not in SoMAp soko. Add it in soko first.");
        }

        try {
          const guard = await TransportMaintenance.buildPurchaseGuard(vehicle.id, partName);
          const price = TransportMaintenance.computePriceSignals(Number(refs.cost.value || 0), Number(item.price || 0));
          const flags = TransportMaintenance.buildFlags(guard, price);
          if (guard.purchasedTooSoon) {
            showBox(refs.logicHint, `Warning: ${partName} for ${vehicle.plate} was bought ${guard.daysSinceLast} day(s) ago. Consult management.`);
          }
          const requestRef = firebase.database().ref("maintenance_requests").push();
          const payload = {
            vehicleId: vehicle.id,
            vehiclePlate: vehicle.plate,
            vehicleModel: vehicle.makeModel,
            driverUid: (state.user && state.user.uid) || state.driverHint.uid || "driver-local",
            driverName: state.profile?.name || state.profile?.profile?.fullName || state.driverHint.name || "",
            part: partName,
            partSlug: TransportMaintenance.slug(partName),
            estCost: Number(refs.cost.value || 0),
            fundiLabourCost: Number(refs.labourCost.value || 0),
            fundiName: refs.fundiName.value.trim(),
            totalQuotedCost: Number(refs.cost.value || 0) + Number(refs.labourCost.value || 0),
            odoKm: Number(refs.odo.value || 0),
            notes: refs.notes.value.trim(),
            sokoItemId: item.itemId,
            sokoSellerId: item.sellerId,
            sokoShopName: item.shopName,
            sokoOwnerName: item.ownerName,
            sokoPhone: item.phoneRaw,
            sokoWhatsapp: item.whatsappUrl,
            sokoLipaNumber: item.lipaNumber,
            sokoPrice: Number(item.price || 0),
            sokoCurrency: item.currency || "TZS",
            priceDelta: price.delta,
            priceDeltaPct: Number(price.deltaPct.toFixed(2)),
            priceDirection: price.direction,
            repeatPart: guard.repeatPart,
            purchasedTooSoon: guard.purchasedTooSoon,
            minExpectedDays: guard.minDays,
            daysSinceLastPurchase: guard.daysSinceLast,
            lastPurchaseTs: guard.lastPurchaseTs,
            recentCount90d: guard.recentCount90d,
            flags,
            status: "PENDING",
            createdAt: Date.now(),
            school: state.profile?.school || state.context.school,
            year: state.context.year,
            month: state.context.month,
            day: state.context.day,
          };
          const file = refs.photo.files[0];
          if (file) {
            const url = await uploadPhoto(requestRef.key, vehicle.id);
            if (url) payload.photoUrl = url;
          }
          await requestRef.set(payload);
          showToast("Request sent");
          refs.form.reset();
          refs.vehicle.value = vehicle.id;
          refs.sokoItemKey.value = "";
          refs.sokoMeta.textContent = "";
          refs.sokoPrice.value = "";
          renderSokoList();
        } catch (err) {
          console.error(err);
          showBox(refs.formError, "Failed to submit maintenance request.");
        }
      });

      refs.vehicle.addEventListener("change", () => {
        refs.sokoItemKey.value = "";
        refs.sokoMeta.textContent = "";
        refs.sokoPrice.value = "";
        renderSokoList();
      });
      refs.sokoSearch.addEventListener("input", () => renderSokoList());

      document.querySelectorAll("button[data-tab]").forEach((btn) => {
        btn.addEventListener("click", () => {
          document.querySelectorAll("button[data-tab]").forEach((b) => b.classList.add("secondary"));
          btn.classList.remove("secondary");
          state.currentTab = btn.dataset.tab;
          renderTable();
        });
      });

      async function ensureAuth() {
        firebase.auth().onAuthStateChanged(async (user) => {
          if (!user) {
            if (state.driverHint.uid || state.driverHint.name || state.mode === "driver") {
              state.user = { uid: state.driverHint.uid || "driver-local" };
              state.profile = { role: "driver", name: state.driverHint.name || "Dereva" };
              state.role = "driver";
              await loadReferences();
              subscribeRequests();
              return;
            }
            showToast("Sign in first", "bad");
            refs.form.classList.add("hidden");
            return;
          }
          state.user = user;
          const [profileSnap, roleSnap] = await Promise.all([
            firebase.database().ref(`users/${user.uid}`).get(),
            firebase.database().ref(`users/${user.uid}/role`).get(),
          ]);
          state.profile = profileSnap.val() || {};
          state.role = TransportRoles.normalize(roleSnap.val() || state.profile.role || state.profile?.profile?.role || "");
          if (!canReview() && !isDriver()) {
            document.body.innerHTML = '<div class="alert red" style="margin:2rem;">No permission to access maintenance hub.</div>';
            return;
          }
          if (!isDriver() && !canReview()) refs.composeCard.classList.add("hidden");
          await loadReferences();
          subscribeRequests();
        });
      }

      TransportContext.attachContextSelectors(document.getElementById("contextBar"), async (ctx) => {
        state.context = ctx;
        if (state.user) {
          await loadReferences();
        }
      });

      hydrateDriverHintFromQueryAndStorage();
      ensureAuth();
    </script>
  </body>
</html>
