<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SoMAp Transport Hub ¬∑ Dashboard</title>
    <link rel="stylesheet" href="./css/transport_dark.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="../Todashboardhtml/yearContext.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
    </script>
  </head>
  <body>
    <!-- Context Bar with Year Selection and Date Display -->
    <div id="contextBar" class="bar">
      <div>
        <h1>üöå SoMAp Transport Hub</h1>
        <small>Advanced Transport Management System</small>
      </div>
      <div class="context-selectors">
        <div class="date-time-display">
          <span class="label">Today</span>
          <span class="value" id="currentDate">‚Äî</span>
        </div>
        <div>
          <label style="margin-bottom: 0.25rem; font-size: 0.75rem;">Academic Year</label>
          <select id="yearSelect" data-somap-year-select data-somap-year-min="2023" style="min-width: 100px; padding: 0.5rem;">
          </select>
        </div>
      </div>
    </div>

    <main>
      <!-- KPI Cards Row -->
      <section class="row" id="kpiRow"></section>

      <!-- Management Cards Row -->
      <section class="row" id="startCards"></section>

      <!-- Alerts Section -->
      <section class="mt-3" id="alerts"></section>
    </main>

    <!-- Students on Transport Modal -->
    <div id="studentsModal" class="modal hidden">
      <div class="modal-content" style="max-width: 1400px;">
        <div class="flex space center mb-2">
          <h2 style="margin: 0;">Students on Transport Registry</h2>
          <button class="btn secondary" id="closeStudentsModal">Close</button>
        </div>
        
        <div class="filter-bar">
          <select id="classFilterModal">
            <option value="">All Classes</option>
            <option>Baby Class</option>
            <option>Middle Class</option>
            <option>Pre Unit Class</option>
            <option>Class 1</option>
            <option>Class 2</option>
            <option>Class 3</option>
            <option>Class 4</option>
            <option>Class 5</option>
            <option>Class 6</option>
            <option>Class 7</option>
          </select>
          <input id="searchStudent" type="text" placeholder="Search student..." style="max-width: 300px;" />
          <button class="btn success" id="exportStudentsCsv">üì• Export CSV</button>
        </div>

        <div style="overflow-x: auto; margin-top: 1.5rem;">
          <table class="table" id="studentsTransportTable">
            <thead>
              <tr>
                <th>Admission No</th>
                <th>Full Name</th>
                <th>Class</th>
                <th>Date Registered</th>
                <th>Parent Contact</th>
                <th>Fee Total</th>
                <th>Paid Amount</th>
                <th>Debt</th>
                <th>Debt Till</th>
                <th>Transport Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="studentsTransportBody">
              <!-- Populated by JavaScript -->
            </tbody>
          </table>
          <div id="emptyStudents" class="empty hidden">No students found</div>
        </div>
      </div>
    </div>

    <!-- Transport Assignment Modal -->
    <div id="transportAssignModal" class="modal hidden">
      <div class="modal-content">
        <div class="flex space center mb-2">
          <h2 style="margin: 0;">Assign Transport</h2>
          <button class="btn secondary" id="closeTransportAssign">Close</button>
        </div>

        <div id="assignAlert" class="alert hidden"></div>

        <div style="margin-bottom: 1rem; padding: 1rem; background: rgba(59, 130, 246, 0.1); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
          <h3 style="margin: 0 0 0.5rem 0; font-size: 1rem;">Student Information</h3>
          <p id="assignStudentInfo" style="margin: 0; color: var(--text-secondary);"></p>
        </div>

        <div class="grid two">
          <div class="card">
            <h3 style="margin-top: 0;">Route Selection</h3>
            <label for="assignRouteSelect">Select Route/Drop Point</label>
            <select id="assignRouteSelect" required>
              <option value="">-- Select Route --</option>
              <optgroup label="1 KM - 17,000 TZS/month/time">
                <option value="jirani na shule">Jirani na Shule</option>
                <option value="mazengo">Mazengo</option>
                <option value="mbezi">Mbezi</option>
                <option value="msikitini">Msikitini</option>
                <option value="mlimani rc">Mlimani RC</option>
                <option value="uswahilini kanisani">Uswahilini Kanisani</option>
                <option value="international">International</option>
                <option value="kona dampo">Kona Dampo</option>
                <option value="mauwa">Mauwa</option>
                <option value="mwisho wa fensi">Mwisho wa Fensi</option>
                <option value="ghati">Ghati</option>
                <option value="mnara wa halotel">Mnara wa Halotel</option>
              </optgroup>
              <optgroup label="1.5 KM - 18,500 TZS/month/time">
                <option value="sinoni">Sinoni</option>
                <option value="kidemi">Kidemi</option>
                <option value="soko mjinga">Soko Mjinga</option>
                <option value="mnara wa voda">Mnara wa Voda</option>
                <option value="mbugani kwenye lami tu">Mbugani Kwenye Lami Tu</option>
              </optgroup>
              <optgroup label="2 KM - 21,000 TZS/month/time">
                <option value="glorious">Glorious</option>
                <option value="ushirika">Ushirika</option>
                <option value="tanga kona">Tanga Kona</option>
                <option value="njia mtoni">Njia Mtoni</option>
                <option value="kaburi moja">Kaburi Moja</option>
                <option value="kwa malaika">Kwa Malaika</option>
                <option value="savanna">Savanna</option>
                <option value="dampo">Dampo</option>
                <option value="darajani">Darajani</option>
                <option value="kikwete road">Kikwete Road</option>
                <option value="boma kubwa">Boma Kubwa</option>
                <option value="kiwetu pazuri">Kiwetu Pazuri</option>
                <option value="umoja road">Umoja Road</option>
                <option value="njiro ndogo">Njiro Ndogo</option>
                <option value="king david">King David</option>
              </optgroup>
              <optgroup label="3-4 KM - 24,000 TZS/month/time">
                <option value="chavda">Chavda</option>
                <option value="matokeo">Matokeo</option>
                <option value="milano">Milano</option>
                <option value="jamhuri">Jamhuri</option>
                <option value="felix mrema">Felix Mrema</option>
                <option value="lemara">Lemara</option>
                <option value="bonisite">Bonisite</option>
                <option value="intel">Intel</option>
                <option value="patel">Patel</option>
                <option value="terrati">Terrati</option>
                <option value="si mbaoil">Si Mbaoil</option>
              </optgroup>
              <optgroup label="5-6 KM - 25,000 TZS/month/time">
                <option value="mapambazuko">Mapambazuko</option>
                <option value="mkono wa madukani">Mkono wa Madukani</option>
                <option value="soweto">Soweto</option>
                <option value="mianzini barabarani">Mianzini Barabarani</option>
                <option value="eliboru jr">Eliboru JR</option>
                <option value="green valley">Green Valley</option>
                <option value="country coffee">Country Coffee</option>
                <option value="maua">Maua</option>
                <option value="pepsi">Pepsi</option>
                <option value="majengo">Majengo</option>
              </optgroup>
              <optgroup label="6-10 KM - 28,000 TZS/month/time">
                <option value="sanawari">Sanawari</option>
                <option value="sekei">Sekei</option>
                <option value="shabani">Shabani</option>
                <option value="kimandolu">Kimandolu</option>
                <option value="kijenge">Kijenge</option>
                <option value="mkono wa shuleni">Mkono wa Shuleni</option>
              </optgroup>
              <optgroup label="10-15 KM - 38,000 TZS/month/time">
                <option value="suye">Suye</option>
                <option value="moshono">Moshono</option>
                <option value="nado">Nado</option>
                <option value="mwanama reli">Mwanama Reli</option>
                <option value="kisongo">Kisongo</option>
              </optgroup>
              <optgroup label="NJE YA MAENEO HAYA - 44,000 TZS/month/time">
                <option value="kiserian">Kiserian</option>
                <option value="chekereni">Chekereni</option>
                <option value="duka bovu">Duka Bovu</option>
                <option value="tengeru">Tengeru</option>
                <option value="ngulelo">Ngulelo</option>
                <option value="kwamrefu">Kwamrefu</option>
                <option value="shangarai atomic">Shangarai Atomic</option>
              </optgroup>
            </select>
          </div>

          <div class="card">
            <h3 style="margin-top: 0;">Time Period</h3>
            <label for="assignPeriod">When will student use transport?</label>
            <select id="assignPeriod" required>
              <option value="">-- Select Period --</option>
              <option value="morning">Morning Only (Asubuhi)</option>
              <option value="evening">Evening Only (Jioni)</option>
              <option value="both">Morning & Evening (Both)</option>
            </select>
          </div>
        </div>

        <div class="grid two mt-2" id="dropOffSection" style="display: none;">
          <div class="card" id="morningDropSection" style="display: none;">
            <h3 style="margin-top: 0;">Morning Drop-off Point</h3>
            <label for="assignMorningDrop">Where to drop in the morning?</label>
            <select id="assignMorningDrop">
              <!-- Same options as route select -->
            </select>
          </div>

          <div class="card" id="eveningDropSection" style="display: none;">
            <h3 style="margin-top: 0;">Evening Drop-off Point</h3>
            <label for="assignEveningDrop">Where to drop in the evening?</label>
            <select id="assignEveningDrop">
              <!-- Same options as route select -->
            </select>
          </div>
        </div>

        <div class="card mt-2" id="startDateSection" style="display: none;">
          <h3 style="margin-top: 0;">Start Date</h3>
          <label for="transportStartDate">Start Date (first day student uses transport) *</label>
          <input type="date" id="transportStartDate" required />
        </div>

        <div class="card mt-2" id="farePreview" style="display: none;">
          <h3 style="margin-top: 0;">Monthly Fee Preview</h3>
          <div id="fareBreakdown" style="font-size: 0.875rem; line-height: 1.8;"></div>
          <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-weight: 600; font-size: 1.125rem;">Total Monthly Fee:</span>
              <span id="totalFareDisplay" style="font-weight: 800; font-size: 1.5rem; color: var(--accent-success);"></span>
            </div>
            <div id="startMonthDueWrap" style="margin-top: .5rem; display:none;">
              <div style="display:flex; justify-content: space-between; align-items:center;">
                <span style="font-size:.9rem;">Start month due (prorated):</span>
                <span id="startMonthDueDisplay" style="font-weight:700;"></span>
              </div>
            </div>
          </div>
        </div>

        <div class="card mt-2" id="vehicleAssignSection" style="display: none;">
          <h3 style="margin-top: 0;">üöê Vehicle & Driver Assignment</h3>
          <div id="vehicleInfo" style="padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
            <p style="margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-secondary);">
              Vehicle and driver are automatically assigned based on the selected route(s).
            </p>
            <div id="autoAssignInfo"></div>
          </div>
        </div>

        <div class="flex mt-2" style="justify-content: flex-end; gap: 1rem;">
          <button class="btn secondary" id="cancelAssign">Cancel</button>
          <button class="btn success" id="saveTransportAssign">üíæ Save Assignment</button>
        </div>
      </div>
    </div>

    <div id="toast" class="toast hidden"></div>

    <script src="./modules/transport_roles.js"></script>
    <script src="./modules/transport_context.js"></script>
    <script src="./modules/transport_helpers.js"></script>
    <script src="./modules/transport_pricing.js"></script>
    <script>
      // Global State
      const state = {
        user: null,
        role: null,
        year: (() => {
            const rawYear = window.somapYearContext?.getSelectedYear?.();
            const parsed = parseInt(rawYear, 10);
            return Number.isFinite(parsed) ? parsed : new Date().getFullYear();
          })(),
        month: new Date().getMonth() + 1,
        school: TransportContext.getContext().school || "socrates",
        students: {},
        vehicles: {},
        transportEnrollments: {},
        transportAssignments: {},
        transportPayments: {},
        financeData: {},
        currentAssignStudentId: null,
        drivers: [],
        routeVehicleValidation: {}, // Track which routes have vehicles assigned
      };

      const toast = document.getElementById("toast");
      const startCardsEl = document.getElementById("startCards");
      const kpiRowEl = document.getElementById("kpiRow");
      const alertsEl = document.getElementById("alerts");
      const yearSelect = document.getElementById("yearSelect");
      const currentDateEl = document.getElementById("currentDate");

      // Modal elements
      const studentsModal = document.getElementById("studentsModal");
      const closeStudentsModal = document.getElementById("closeStudentsModal");
      const studentsTransportBody = document.getElementById("studentsTransportBody");
      const classFilterModal = document.getElementById("classFilterModal");
      const searchStudent = document.getElementById("searchStudent");

      const transportAssignModal = document.getElementById("transportAssignModal");
      const closeTransportAssign = document.getElementById("closeTransportAssign");
      const assignRouteSelect = document.getElementById("assignRouteSelect");
      const assignPeriod = document.getElementById("assignPeriod");
      const assignMorningDrop = document.getElementById("assignMorningDrop");
      const assignEveningDrop = document.getElementById("assignEveningDrop");
      const saveTransportAssign = document.getElementById("saveTransportAssign");

      // Utility Functions
      function showToast(message, tone = "ok") {
        toast.textContent = message;
        toast.classList.remove("hidden");
        toast.style.background = tone === "bad" ? "#ef4444" : "#1f2937";
        setTimeout(() => toast.classList.add("hidden"), 3500);
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-TZ', { style: 'currency', currency: 'TZS' }).format(amount || 0);
      }

      function formatDate(timestamp) {
        if (!timestamp) return 'N/A';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-GB');
      }

      // Update current date display
      function updateDateDisplay() {
        const now = new Date();
        const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
        currentDateEl.textContent = now.toLocaleDateString('en-US', options);
      }

      // Initialize date display and update every second
      updateDateDisplay();
      setInterval(updateDateDisplay, 1000);

      // Apply URL params for school/year if present (keeps pages in sync)
      (function applyUrlParams(){
        const params = new URLSearchParams(window.location.search);
        const y = parseInt(params.get('year'), 10);
        const sch = params.get('school');
        if (Number.isFinite(y)) state.year = y;
        if (sch) {
          state.school = sch;
          if (typeof sch === 'string' && sch.startsWith('-')) {
            window.currentSchoolId = sch;
          }
        }
      })();

      // Resolve school id if a friendly name (e.g., "socrates") is present and set window.currentSchoolId
      async function resolveSchoolIdIfNeeded() {
        try {
          await resolveSchoolIdIfNeeded();
          const looksLikeId = typeof state.school === 'string' && state.school.startsWith('-');
          if (looksLikeId) {
            window.currentSchoolId = state.school;
            return;
          }
          const snap = await firebase.database().ref('schools').get();
          if (!snap.exists()) return;
          const schools = snap.val() || {};
          const target = String(state.school || '').toLowerCase().trim();
          let matchedId = null;
          Object.keys(schools).some((id) => {
            const s = schools[id] || {};
            const slug = String(s.slug || '').toLowerCase();
            const name = String(s.name || '').toLowerCase();
            if (slug === target || name === target || id === state.school) { matchedId = id; return true; }
            if (!matchedId && (name.includes(target) || slug.includes(target))) { matchedId = id; }
            return false;
          });
          if (matchedId) {
            state.school = matchedId;
            window.currentSchoolId = matchedId;
          }
        } catch (err) {
          console.warn('Failed to resolve school id', err);
        }
      }

      function currentSchoolPrefix() {
        return window.currentSchoolId ? `schools/${window.currentSchoolId}/` : '';
      }

      function withSchoolPrefix(path) {
        const prefix = currentSchoolPrefix();
        return prefix ? `${prefix}${path}` : path;
      }

      async function fetchWithSchoolFallback(path) {
        const db = firebase.database();
        const prefix = currentSchoolPrefix();
        if (prefix) {
          try {
            const scoped = await db.ref(`${prefix}${path}`).once('value');
            if (scoped.exists()) return scoped;
          } catch (err) {
            console.warn('Scoped fetch failed, using global path for', path, err);
          }
        }
        return db.ref(path).once('value');
      }

      // Year selection handler
      if (yearSelect && window.somapYearContext) {
        window.somapYearContext.attachYearDropdown(yearSelect);
        const synchronizeYear = (yearValue) => {
          const normalized = parseInt(yearValue, 10);
          if (!Number.isFinite(normalized)) return;
          state.year = normalized;
          if (String(normalized) !== yearSelect.value) {
            yearSelect.value = String(normalized);
          }
          if (state.user) {
            studentsLoaded = false; // Reset students cache on year change
            loadCriticalData();
          }
        };
        synchronizeYear(window.somapYearContext.getSelectedYear());
        window.somapYearContext.onYearChanged((nextYear) => {
          synchronizeYear(nextYear);
        });
        yearSelect.addEventListener('change', (event) => {
          window.somapYearContext.setSelectedYear(event.target.value);
        });
      } else if (yearSelect) {
        yearSelect.value = state.year;
        yearSelect.addEventListener('change', (event) => {
          const normalized = parseInt(event.target.value, 10);
          if (!Number.isFinite(normalized) || normalized === state.year) return;
          state.year = normalized;
          studentsLoaded = false; // Reset students cache on year change
          loadCriticalData();
          // Reload students if modal is open
          if (studentsModal && !studentsModal.classList.contains('hidden')) {
            loadStudentsIfNeeded().then(() => renderStudentsTable());
          }
        });
      }

      // Render KPI Cards
      function renderKpis() {
        const totalStudents = Object.keys(state.students || {}).length;
        const assignments = state.transportAssignments || {};
        const assignmentIds = Object.entries(assignments).filter(([, a]) => a && a.status === 'Using').map(([id]) => id);
        const studentsOnTransport = assignmentIds.length > 0
          ? assignmentIds.length
          : Object.keys(state.transportEnrollments || {}).length;
        const notOnTransport = totalStudents > 0 ? totalStudents - studentsOnTransport : '‚Äî';

        // Calculate financial KPIs (matching transportpayments.html logic)
        let expectedThisMonth = 0;
        let totalCollected = 0;
        let totalDebt = 0;

        const enrollments = state.transportEnrollments || {};
        const payments = state.transportPayments || {};
        const MONTH_NAMES = ["", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        
        Object.entries(enrollments).forEach(([studentId, enrollment]) => {
          if (!enrollment) return;
          
          const amStop = enrollment.amStop || '';
          const pmStop = enrollment.pmStop || '';
          
          // Current month expected (with multiplier) - for "Expected This Month" KPI
          const currentMonthExpected = TransportPricing.expectedForMonth(amStop, pmStop, state.month);
          expectedThisMonth += currentMonthExpected;

          // Calculate total expected and total paid across ALL months (like transportpayments.html)
          let totalExpected = 0;
          let totalPaid = 0;
          
          const studentPayments = payments[studentId] || {};
          const paymentsArray = Array.isArray(studentPayments) ? studentPayments : Object.values(studentPayments || {});
          
          for (let month = 1; month <= 12; month++) {
            const monthlyExpected = TransportPricing.expectedForMonth(amStop, pmStop, month);
            totalExpected += monthlyExpected;
            
            // Handle both number and month name formats for payments
            const monthPayments = paymentsArray.filter(p => {
              if (!p || !p.month) return false;
              if (typeof p.month === 'number') return p.month === month;
              if (typeof p.month === 'string') return MONTH_NAMES[month] === p.month;
              return false;
            });
            
            const monthPaid = monthPayments.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
            totalPaid += monthPaid;
          }
          
          totalCollected += totalPaid;
          totalDebt += Math.max(0, totalExpected - totalPaid);
        });

        const cards = [
          {
            id: "students-transport",
            label: "Students on Transport",
            value: studentsOnTransport,
            description: `${totalStudents} total students`,
            color: "primary",
            clickable: true,
          },
          {
            id: "not-transport",
            label: "Not Using Transport",
            value: notOnTransport,
            description: totalStudents > 0 ? "Available for enrollment" : "Loading...",
            color: "info",
          },
          {
            id: "expected-month",
            label: `Expected ${getMonthName(state.month)} ${state.year}`,
            value: formatCurrency(expectedThisMonth),
            description: "Monthly target",
            color: "success",
          },
          {
            id: "paid-month",
            label: "Total Collected",
            value: formatCurrency(totalCollected),
            description: "All transport payments",
            color: "success",
          },
          {
            id: "debt-month",
            label: "Total Transport Debt",
            value: formatCurrency(totalDebt),
            description: "Unpaid amounts",
            color: "danger",
          },
        ];

        kpiRowEl.innerHTML = cards
          .map(
            (card) => `
            <article class="card stat-card ${card.clickable ? 'clickable' : ''}" ${card.clickable ? `onclick="openStudentsModal()"` : ''} style="cursor: ${card.clickable ? 'pointer' : 'default'};">
              <div class="stat-label">${card.label}</div>
              <div class="stat-value">${card.value}</div>
              <div class="stat-label" style="font-size: 0.75rem; margin-top: 0.5rem;">${card.description}</div>
            </article>
          `
          )
          .join("");
      }

      function getMonthName(monthIndex) {
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        return months[monthIndex - 1] || "";
      }

      // Render Management Cards
      function renderStartCards() {
        const cards = [
          {
            title: "Payments Queue",
            description: "Approve transport fee claims and ledgers",
            href: "transportpayments.html",
            icon: "üí∞",
          },
          {
            title: "Vehicle Registry",
            description: "Fleet, owners, insurance expiries",
            href: "transportbuses.html",
            icon: "üöê",
          },
          {
            title: "Routes & Stops",
            description: "Manage routes, stops, and schedules",
            href: "transportroutes.html",
            icon: "üó∫Ô∏è",
          },
          {
            title: "Fuel Requests",
            description: "Review, approve & flag fuel usage",
            href: "transportfuel.html",
            icon: "‚õΩ",
          },
          {
            title: "Maintenance Desk",
            description: "Repairs, parts history and approvals",
            href: "transportmaintenance.html",
            icon: "üîß",
          },
          {
            title: "Boarding Gate",
            description: "No Pay ¬∑ No Board control centre",
            href: "transportattendance.html",
            icon: "üö™",
          },
          {
            title: "Reports & Exports",
            description: "Monthly KPIs and CSV/PDF exports",
            href: "transportreports.html",
            icon: "üìä",
          },
          {
            title: "Operations & Toggles",
            description: "Windows, active days, km-per-litre controls",
            href: "transportops.html",
            icon: "‚öôÔ∏è",
          },
        ];

        startCardsEl.innerHTML = cards
          .map(
            (card) => `
            <article class="card">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">${card.icon}</div>
              <h2>${card.title}</h2>
              <p class="muted">${card.description}</p>
              <a class="btn mt-2" href="${card.href}?school=${state.school}&year=${state.year}" style="display: block;">
                Open ‚Üí
              </a>
            </article>
          `
          )
          .join("");
      }

      // Open Students on Transport Modal
      async function openStudentsModal() {
        studentsModal.classList.remove("hidden");
        // Show loading state
        studentsTransportBody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 2rem;">Loading students...</td></tr>';
        
        // Load students data if not already loaded
        await loadStudentsIfNeeded();
        renderStudentsTable();
      }

      closeStudentsModal.addEventListener("click", () => {
        studentsModal.classList.add("hidden");
      });

      // Render Students Table
      function renderStudentsTable() {
        const filterClass = classFilterModal.value;
        const searchTerm = searchStudent.value.toLowerCase();

        const filtered = Object.entries(state.students).filter(([id, student]) => {
          const matchesClass = !filterClass || student.classLevel === filterClass;
          const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.toLowerCase();
          const matchesSearch = !searchTerm || 
            fullName.includes(searchTerm) || 
            (student.admissionNumber || '').toLowerCase().includes(searchTerm);
          return matchesClass && matchesSearch;
        });

        if (filtered.length === 0) {
          studentsTransportBody.innerHTML = '';
          document.getElementById('emptyStudents').classList.remove('hidden');
          return;
        }

        document.getElementById('emptyStudents').classList.add('hidden');

        studentsTransportBody.innerHTML = filtered
          .map(([id, student]) => {
            const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
            const enrollment = state.transportEnrollments[id];
            const assignments = state.transportAssignments || {};
            const hasYearAssignments = Object.keys(assignments).length > 0;
            const assignment = assignments[id];
            const isUsingTransport = assignment && assignment.status === 'Using'
              ? true
              : (!hasYearAssignments && !!enrollment);

            // Get finance data
            const financeData = state.financeData[id] || {};
            const feeTotal = financeData.feePerYear || 0;
            const payments = financeData.payments || {};
            const paidAmount = Object.values(payments).reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
            const debt = Math.max(0, feeTotal - paidAmount);
            const debtTill = financeData.debtTill || '‚Äî';

            const statusBadge = isUsingTransport 
              ? '<span class="chip ok">Using</span>'
              : '<span class="chip warn">Not Using</span>';

            const actionBtn = isUsingTransport
              ? `<button class="btn secondary" onclick="editTransportAssignment('${id}')">Edit</button>`
              : `<button class="btn success" onclick="assignTransport('${id}')">Assign Transport</button>`;

            return `
              <tr>
                <td>${student.admissionNumber || 'N/A'}</td>
                <td>${fullName}</td>
                <td>${student.classLevel || 'N/A'}</td>
                <td>${formatDate(student.timestamp || student.createdAt)}</td>
                <td>${student.primaryParentContact || 'N/A'}</td>
                <td>${formatCurrency(feeTotal)}</td>
                <td>${formatCurrency(paidAmount)}</td>
                <td style="color: ${debt > 0 ? 'var(--accent-danger)' : 'var(--accent-success)'};">${formatCurrency(debt)}</td>
                <td>${debtTill}</td>
                <td>${statusBadge}</td>
                <td class="table-actions">${actionBtn}</td>
              </tr>
            `;
          })
          .join("");
      }

      // Debounce search for better performance
      let searchTimeout = null;
      classFilterModal.addEventListener('change', renderStudentsTable);
      searchStudent.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => renderStudentsTable(), 300); // Wait 300ms after typing stops
      });

      // Assign Transport Function
      async function assignTransport(studentId) {
        state.currentAssignStudentId = studentId;
        
        // Ensure students are loaded
        await loadStudentsIfNeeded();
        
        const student = state.students[studentId];
        if (!student) {
          showToast('Student not found', 'bad');
          return;
        }

        const fullName = `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.trim();
        document.getElementById('assignStudentInfo').textContent = 
          `${fullName} - ${student.admissionNumber} - ${student.classLevel}`;

        // Copy route options to drop-off selects
        const routeOptions = assignRouteSelect.innerHTML;
        assignMorningDrop.innerHTML = routeOptions;
        assignEveningDrop.innerHTML = routeOptions;

        // Reset form
        assignRouteSelect.value = '';
        assignPeriod.value = '';
        assignMorningDrop.value = '';
        assignEveningDrop.value = '';
        document.getElementById('dropOffSection').style.display = 'none';
        document.getElementById('farePreview').style.display = 'none';
        document.getElementById('vehicleAssignSection').style.display = 'none';
        state.routeVehicleValidation = {};

        // Reset save button
        const saveBtn = document.getElementById('saveTransportAssign');
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.style.opacity = '0.6';
          saveBtn.style.cursor = 'not-allowed';
          saveBtn.title = 'Please complete all required fields';
        }

        transportAssignModal.classList.remove('hidden');
      }

      async function editTransportAssignment(studentId) {
        await assignTransport(studentId);
        const enrollment = state.transportEnrollments[studentId];
        if (enrollment) {
          assignRouteSelect.value = enrollment.route || '';
          assignPeriod.value = enrollment.period || '';
          if (enrollment.amStop) assignMorningDrop.value = enrollment.amStop;
          if (enrollment.pmStop) assignEveningDrop.value = enrollment.pmStop;
          await calculateFare();
          updateSaveButtonState();
        }
      }

      // Period change handler
      assignPeriod.addEventListener('change', async () => {
        const period = assignPeriod.value;
        const dropSection = document.getElementById('dropOffSection');
        const morningSection = document.getElementById('morningDropSection');
        const eveningSection = document.getElementById('eveningDropSection');

        if (period === 'morning') {
          dropSection.style.display = 'grid';
          morningSection.style.display = 'block';
          eveningSection.style.display = 'none';
          assignEveningDrop.value = '';
        } else if (period === 'evening') {
          dropSection.style.display = 'grid';
          morningSection.style.display = 'none';
          eveningSection.style.display = 'block';
          assignMorningDrop.value = '';
        } else if (period === 'both') {
          dropSection.style.display = 'grid';
          morningSection.style.display = 'block';
          eveningSection.style.display = 'block';
        } else {
          dropSection.style.display = 'none';
        }

        await calculateFare();
        // reveal start date when period/routes selected
        const hasAny = assignMorningDrop.value || assignEveningDrop.value;
        document.getElementById('startDateSection').style.display = hasAny ? 'block' : 'none';
        updateSaveButtonState();
      });

      assignMorningDrop.addEventListener('change', async () => {
        await calculateFare();
        const hasAny = assignMorningDrop.value || assignEveningDrop.value;
        document.getElementById('startDateSection').style.display = hasAny ? 'block' : 'none';
        updateSaveButtonState();
      });
      assignEveningDrop.addEventListener('change', async () => {
        await calculateFare();
        const hasAny = assignMorningDrop.value || assignEveningDrop.value;
        document.getElementById('startDateSection').style.display = hasAny ? 'block' : 'none';
        updateSaveButtonState();
      });

      // Recalculate when start date changes (to update proration preview)
      document.getElementById('transportStartDate')?.addEventListener('change', async () => {
        await calculateFare();
      });

      // Calculate and display fare with vehicle/driver info
      async function calculateFare() {
        const period = assignPeriod.value;
        if (!period) {
          document.getElementById('farePreview').style.display = 'none';
          document.getElementById('vehicleAssignSection').style.display = 'none';
          return;
        }

        const morningRoute = assignMorningDrop.value;
        const eveningRoute = assignEveningDrop.value;
        const year = Number(state.year);
        
        // Get start date to determine which month's price to use
        const startDateInput = document.getElementById('transportStartDate');
        const focusedMonth = startDateInput?.value 
          ? (new Date(startDateInput.value)).getMonth() + 1
          : (new Date()).getMonth() + 1;
        
        // Use date-aware pricing
        const baseFee = await TransportPricing.computeBaseMonthlyFeeOnMonth({
          year,
          month: focusedMonth,
          amStop: morningRoute,
          pmStop: eveningRoute
        });
        
        // For display breakdown, get individual prices
        const morningPrice = morningRoute ? await TransportPricing.baseFeeOnDate({
          year,
          stopName: morningRoute,
          onDate: TransportPricing.monthStartIso(year, focusedMonth)
        }) : 0;
        const eveningPrice = eveningRoute ? await TransportPricing.baseFeeOnDate({
          year,
          stopName: eveningRoute,
          onDate: TransportPricing.monthStartIso(year, focusedMonth)
        }) : 0;

        let breakdown = '<div style="display: grid; gap: 0.5rem;">';
        if (morningRoute) {
          breakdown += `<div style="display: flex; justify-content: space-between;">
            <span>Morning (${morningRoute}):</span>
            <span style="font-weight: 600;">${formatCurrency(morningPrice)}</span>
          </div>`;
        }
        if (eveningRoute) {
          breakdown += `<div style="display: flex; justify-content: space-between;">
            <span>Evening (${eveningRoute}):</span>
            <span style="font-weight: 600;">${formatCurrency(eveningPrice)}</span>
          </div>`;
        }
        breakdown += `</div>
          <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
            <p style="margin: 0; font-size: 0.75rem; color: var(--text-muted);">
              Note: This is the base monthly fee. Actual monthly fees vary with multipliers:
              January (1.5√ó), April & September (0.8√ó), November (1.25√ó), June & December (0√ó)
            </p>
          </div>`;

        document.getElementById('fareBreakdown').innerHTML = breakdown;
        document.getElementById('totalFareDisplay').textContent = formatCurrency(baseFee);
        document.getElementById('farePreview').style.display = 'block';

        // If start date selected, preview prorated start month due
        const sd = document.getElementById('transportStartDate')?.value;
        const y = state.year;
        if (sd) {
          const { y: sy, m: sm } = (function(s){ const a=String(s).split('-'); return { y:Number(a[0]||y), m:Number(a[1]||1) }; })(sd);
          const multipliers = await TransportPricing.loadYearMultipliers(sy);
          const due = await TransportPricing.dueForMonth({ 
            year: sy, 
            month: sm, 
            amStop: morningRoute,
            pmStop: eveningRoute,
            baseMonthlyFee: baseFee, 
            startDate: sd,
            multipliers
          });
          const wrap = document.getElementById('startMonthDueWrap');
          const disp = document.getElementById('startMonthDueDisplay');
          if (wrap && disp) { wrap.style.display='block'; disp.textContent = formatCurrency(Math.round(due)); }
        } else {
          const wrap = document.getElementById('startMonthDueWrap'); if (wrap) wrap.style.display='none';
        }

        // Show vehicle and driver assignment
        updateVehicleDriverInfo(morningRoute, eveningRoute);
        document.getElementById('vehicleAssignSection').style.display = 'block';
      }

      // Update vehicle and driver information based on selected routes
      function updateVehicleDriverInfo(morningRoute, eveningRoute) {
        const routes = [morningRoute, eveningRoute].filter(r => r);
        if (routes.length === 0) {
          document.getElementById('autoAssignInfo').innerHTML = '<p style="margin: 0; color: var(--text-muted);">No routes selected</p>';
          state.routeVehicleValidation = {};
          updateSaveButtonState();
          return;
        }

        // Reset validation state
        state.routeVehicleValidation = {};

        let vehicleDriverInfo = '<div style="display: grid; gap: 1rem;">';
        let allRoutesHaveVehicles = true;

        routes.forEach(route => {
          // Find vehicle(s) assigned to this route
          const vehiclesForRoute = Object.values(state.vehicles || {}).filter(v => {
            if (!v) return false;
            // assignedRoutes can be array OR object of strings/objects
            const rawAssigned = v.assignedRoutes;
            const assigned = Array.isArray(rawAssigned)
              ? rawAssigned
              : (rawAssigned && typeof rawAssigned === 'object')
                ? Object.values(rawAssigned)
                : [];
            const target = String(route).toLowerCase().trim();
            return assigned.some(r => {
              if (!r) return false;
              const val = (typeof r === 'string') ? r : (r.route || r.name || r.id || '');
              return String(val).toLowerCase().trim() === target;
            });
          });

          if (vehiclesForRoute.length > 0) {
            // Route has vehicle(s) - mark as valid
            state.routeVehicleValidation[route] = true;

            vehiclesForRoute.forEach(vehicle => {
              const driver = state.drivers.find(d => d.id === vehicle.assignedDriverUid);
              const driverName = driver ? driver.fullName : 'Driver not assigned';
              const driverPhone = driver ? driver.phone : '';

              vehicleDriverInfo += `
                <div style="background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                  <div style="display: grid; gap: 0.5rem; font-size: 0.875rem;">
                    <div><strong>Route:</strong> ${route}</div>
                    <div><strong>üöê Vehicle:</strong> ${vehicle.plate} (${vehicle.makeModel || 'N/A'})</div>
                    <div><strong>üë®‚Äç‚úàÔ∏è Driver:</strong> ${driverName}${driverPhone ? ` (${driverPhone})` : ''}</div>
                    <div><strong>Capacity:</strong> ${vehicle.capacity || 'N/A'} seats</div>
                  </div>
                </div>
              `;
            });
          } else {
            // Route has no vehicle - mark as invalid
            state.routeVehicleValidation[route] = false;
            allRoutesHaveVehicles = false;

            vehicleDriverInfo += `
              <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.3);">
                <div style="font-size: 0.875rem;">
                  <strong>Route:</strong> ${route}<br/>
                  <span style="color: var(--accent-danger);">‚ö†Ô∏è No vehicle assigned to this route yet. Please assign a vehicle in Vehicle Registry.</span>
                </div>
              </div>
            `;
          }
        });

        vehicleDriverInfo += '</div>';
        document.getElementById('autoAssignInfo').innerHTML = vehicleDriverInfo;

        // Update save button state based on validation
        updateSaveButtonState(allRoutesHaveVehicles);
      }

      // Update save button state based on vehicle assignment validation
      function updateSaveButtonState(allRoutesHaveVehicles = false) {
        const saveBtn = document.getElementById('saveTransportAssign');
        if (!saveBtn) return;

        const period = assignPeriod.value;
        const morningRoute = assignMorningDrop.value;
        const eveningRoute = assignEveningDrop.value;
        const hasRoutes = morningRoute || eveningRoute;

        // Check if all selected routes have vehicles
        const routes = [morningRoute, eveningRoute].filter(r => r);
        const allValid = routes.length > 0 && routes.every(route => state.routeVehicleValidation[route] === true);

        if (!period || !hasRoutes || !allValid) {
          saveBtn.disabled = true;
          saveBtn.style.opacity = '0.6';
          saveBtn.style.cursor = 'not-allowed';
          if (hasRoutes && !allValid) {
            saveBtn.title = 'Cannot save: No vehicle assigned to one or more selected routes';
          } else {
            saveBtn.title = 'Please complete all required fields';
          }
        } else {
          saveBtn.disabled = false;
          saveBtn.style.opacity = '1';
          saveBtn.style.cursor = 'pointer';
          saveBtn.title = '';
        }
      }

      // Save transport assignment
      saveTransportAssign.addEventListener('click', async () => {
        const studentId = state.currentAssignStudentId;
        const period = assignPeriod.value;
        const morningRoute = assignMorningDrop.value;
        const eveningRoute = assignEveningDrop.value;
        const startDate = (document.getElementById('transportStartDate') || {}).value;

        // Basic validation
        if (!period || (!morningRoute && !eveningRoute)) {
          showToast('Please complete all required fields', 'bad');
          return;
        }

        if (!startDate) {
          showToast('Please select Start Date', 'bad');
          return;
        }

        // Validate vehicle assignment for all selected routes
        const routes = [morningRoute, eveningRoute].filter(r => r);
        const missingVehicles = routes.filter(route => state.routeVehicleValidation[route] !== true);

        if (missingVehicles.length > 0) {
          showToast(`Cannot save: No vehicle assigned to route(s): ${missingVehicles.join(', ')}. Please assign vehicles in Vehicle Registry first.`, 'bad');
          return;
        }

        try {
          // Find and store vehicle/driver info for each route
          const routeVehicleMap = {};
          routes.forEach(route => {
            const vehiclesForRoute = Object.values(state.vehicles || {}).filter(v => {
              if (!v || !v.assignedRoutes) return false;
              const raw = v.assignedRoutes;
              const list = Array.isArray(raw)
                ? raw
                : (typeof raw === 'object') ? Object.values(raw) : [];
              const target = String(route).toLowerCase().trim();
              return list.some(r => {
                if (!r) return false;
                const val = (typeof r === 'string') ? r : (r.route || r.name || r.id || '');
                return String(val).toLowerCase().trim() === target;
              });
            });
            
            if (vehiclesForRoute.length > 0) {
              // Use the first vehicle found for this route
              const vehicle = vehiclesForRoute[0];
              const driver = state.drivers.find(d => d.id === vehicle.assignedDriverUid);
              routeVehicleMap[route] = {
                vehicleId: vehicle.id || null,
                vehiclePlate: vehicle.plate || '',
                driverId: vehicle.assignedDriverUid || null,
                driverName: driver ? driver.fullName : 'Not assigned'
              };
            }
          });

          const enrollment = {
            studentId,
            school: state.school,
            year: state.year,
            period,
            amStop: morningRoute || '',
            pmStop: eveningRoute || '',
            route: morningRoute || eveningRoute,
            // Store vehicle/driver assignment info
            morningVehicle: morningRoute ? routeVehicleMap[morningRoute] : null,
            eveningVehicle: eveningRoute ? routeVehicleMap[eveningRoute] : null,
            updatedAt: Date.now(),
            updatedBy: state.user.uid,
          };

          await firebase.database()
            .ref(withSchoolPrefix(`transport_enrollments/${studentId}`))
            .set(enrollment);

          // Also write year-scoped assignment with base fees + start date (canonical path)
          const baseMorningFee = TransportPricing.priceForStop(morningRoute || '');
          const baseEveningFee = TransportPricing.priceForStop(eveningRoute || '');
          const baseMonthlyFee = baseMorningFee + baseEveningFee;
          const assignPayload = {
            status: 'Using',
            morningRouteId: morningRoute || '',
            eveningRouteId: eveningRoute || '',
            baseMorningFee,
            baseEveningFee,
            baseMonthlyFee,
            startDate: startDate,
            dateRegistered: Date.now(),
            parentContact: state.students[studentId]?.primaryParentContact || '',
            className: state.students[studentId]?.classLevel || '',
            admissionNo: state.students[studentId]?.admissionNumber || '',
            fullName: `${state.students[studentId]?.firstName||''} ${state.students[studentId]?.middleName||''} ${state.students[studentId]?.lastName||''}`.replace(/\s+/g,' ').trim()
          };
          await firebase.database().ref(withSchoolPrefix(`transportAssignments/${state.year}/${studentId}`)).set(assignPayload);

          showToast('Transport assignment saved successfully!');
          transportAssignModal.classList.add('hidden');
          
          // Update local state immediately
          state.transportEnrollments[studentId] = enrollment;
          state.transportAssignments[studentId] = assignPayload;
          
          // Refresh data in background
          loadCriticalData().then(() => {
            if (studentsModal && !studentsModal.classList.contains('hidden')) {
              renderStudentsTable();
            }
          });
          
          // Update KPIs immediately
          renderKpis();
        } catch (error) {
          console.error('Error saving assignment:', error);
          showToast('Failed to save assignment', 'bad');
        }
      });

      closeTransportAssign.addEventListener('click', () => {
        transportAssignModal.classList.add('hidden');
      });

      document.getElementById('cancelAssign').addEventListener('click', () => {
        transportAssignModal.classList.add('hidden');
      });

      // Cache for drivers (rarely changes)
      let driversCache = null;
      let driversCacheTime = 0;
      const DRIVERS_CACHE_TTL = 5 * 60 * 1000; // 5 minutes

      // Load critical data first (for KPIs and UI)
      async function loadCriticalData() {
        try {
          // Show loading state
          kpiRowEl.innerHTML = '<article class="card stat-card"><div class="stat-label">Loading...</div><div class="stat-value">‚è≥</div></article>';
          
          // Load critical data in parallel
          const [enrollSnap, assignmentsSnap, vehiclesSnap] = await Promise.all([
            fetchWithSchoolFallback('transport_enrollments'),
            fetchWithSchoolFallback(`transportAssignments/${state.year}`).catch(() => ({ val: () => null })),
            firebase.database().ref(`transport/${state.school}/${state.year}/buses`).once('value')
          ]);

          const legacyEnrollments = enrollSnap.val() || {};
          const assignments = assignmentsSnap.val() || {};
          const hasAssignments = Object.keys(assignments || {}).length > 0;
          state.transportAssignments = assignments || {};
          state.transportEnrollments = {};

          if (!hasAssignments) {
            Object.entries(legacyEnrollments).forEach(([studentId, enrollment]) => {
              if (enrollment) state.transportEnrollments[studentId] = enrollment;
            });
          }

          Object.entries(assignments).forEach(([studentId, assignRecord]) => {
            if (!assignRecord || assignRecord.status !== 'Using') return;
            const existing = state.transportEnrollments[studentId] || {};
            const amStop = assignRecord.morningRouteId || assignRecord.amStop || existing.amStop || '';
            const pmStop = assignRecord.eveningRouteId || assignRecord.pmStop || existing.pmStop || '';
            const route = assignRecord.route || existing.route || amStop || pmStop || '';
            const period = amStop && pmStop ? 'both' : (amStop ? 'morning' : (pmStop ? 'evening' : ''));
            state.transportEnrollments[studentId] = {
              ...existing,
              ...assignRecord,
              amStop,
              pmStop,
              route,
              period: assignRecord.period || existing.period || period,
              baseMonthlyFee: assignRecord.baseMonthlyFee || existing.baseMonthlyFee,
              startDate: assignRecord.startDate || existing.startDate,
            };
          });
          
          // Process vehicles
          state.vehicles = {};
          if (vehiclesSnap.exists()) {
            vehiclesSnap.forEach(child => {
              state.vehicles[child.key] = { id: child.key, ...(child.val() || {}) };
            });
          }

          // Load drivers (with caching)
          await loadDriversCached();

          // Load payments in background (needed for KPI calculations)
          // Use same data source as transportpayments.html (transportLedgers)
          const prefix = window.currentSchoolId ? `schools/${window.currentSchoolId}/` : '';
          const year = String(state.year);
          
          Promise.all([
            firebase.database().ref(`${prefix}transportLedgers/${year}`).once('value').catch(() => ({ val: () => null })),
            firebase.database().ref(`${prefix}transport_payments`).once('value').catch(() => ({ val: () => null }))
          ]).then(([ledgersSnap, legacySnap]) => {
            // New format: transportLedgers/{year}/{studentId}/payments
            const paymentsData = {};
            const ledgers = ledgersSnap.val() || {};
            Object.entries(ledgers).forEach(([studentId, ledger]) => {
              if (ledger && ledger.payments) {
                paymentsData[studentId] = Object.values(ledger.payments);
              }
            });
            
            // Also check legacy path for backward compatibility
            const legacyPayments = legacySnap.val() || {};
            Object.entries(legacyPayments).forEach(([studentId, payments]) => {
              if (!paymentsData[studentId]) {
                paymentsData[studentId] = Array.isArray(payments) ? payments : Object.values(payments || {});
              }
            });
            
            state.transportPayments = paymentsData;
            renderKpis(); // Re-render KPIs when payments load
          }).catch(err => {
            console.warn('Failed to load payments:', err);
            state.transportPayments = {};
            renderKpis();
          });

          // Render UI immediately with available data
          renderKpis();
        } catch (error) {
          console.error('Error loading critical data:', error);
          showToast('Error loading data', 'bad');
          kpiRowEl.innerHTML = '<article class="card stat-card"><div class="stat-label">Error</div><div class="stat-value">‚ùå</div></article>';
        }
      }

      // Load drivers with caching
      async function loadDriversCached() {
        const now = Date.now();
        if (driversCache && (now - driversCacheTime) < DRIVERS_CACHE_TTL) {
          state.drivers = driversCache;
          return;
        }

        try {
          const workersSnap = await firebase.database().ref('workers').once('value');
          state.drivers = [];
          if (workersSnap.exists()) {
            workersSnap.forEach(workerSnap => {
              const worker = workerSnap.val();
              if (worker.profile && worker.profile.role === 'driver' && worker.profile.active !== false) {
                state.drivers.push({
                  id: workerSnap.key,
                  fullName: worker.profile.fullNameUpper || `${worker.profile.firstName} ${worker.profile.middleName} ${worker.profile.lastName}`,
                  phone: worker.profile.phone,
                  firstName: worker.profile.firstName,
                  middleName: worker.profile.middleName,
                  lastName: worker.profile.lastName
                });
              }
            });
          }
          driversCache = state.drivers;
          driversCacheTime = now;
        } catch (error) {
          console.warn('Error loading drivers:', error);
          state.drivers = driversCache || [];
        }
      }

      // Lazy load students data (only when needed)
      let studentsLoaded = false;
      async function loadStudentsIfNeeded() {
        if (studentsLoaded && Object.keys(state.students).length > 0) {
          return; // Already loaded
        }

        try {
          await resolveSchoolIdIfNeeded();
          const studentsSnap = await fetchWithSchoolFallback('students');
          state.students = studentsSnap.val() || {};
          
          // Process finance data
          state.financeData = {};
          Object.entries(state.students).forEach(([id, student]) => {
            state.financeData[id] = {
              feePerYear: student.feePerYear || 0,
              payments: student.payments || {},
              debtTill: student.debtTill || '‚Äî',
            };
          });
          
          studentsLoaded = true;
          
          // Update KPIs with student count
          renderKpis();
        } catch (error) {
          console.error('Error loading students:', error);
          state.students = {};
          state.financeData = {};
        }
      }

      // Load all data (backward compatibility)
      async function loadAllData() {
        await loadCriticalData();
        await loadStudentsIfNeeded();
      }

      // Auth and initialization
      function ensureAuth(callback) {
        firebase.auth().onAuthStateChanged((user) => {
          if (!user) {
            alertsEl.innerHTML =
              '<div class="alert red">üîí Sign in to view Transport Hub.</div>';
            return;
          }
          
          state.user = user;
          
          // Check if TransportRoles is available
          if (typeof TransportRoles === 'undefined') {
            console.warn('TransportRoles module not loaded, defaulting to admin access');
            state.role = "admin";
            alertsEl.innerHTML =
              '<div class="alert amber">‚ö†Ô∏è Permission module not loaded. Proceeding with default access.</div>';
            callback();
            return;
          }

          firebase
            .database()
            .ref(`users/${user.uid}/role`)
            .get()
            .then((snapshot) => {
              const roleRaw = snapshot.val();
              state.role = TransportRoles.normalize(roleRaw);
              
              if (!TransportRoles.canViewTransport(state.role)) {
                alertsEl.innerHTML =
                  '<div class="alert warn">‚ö†Ô∏è No transport permissions for this account. Please contact your administrator.</div>';
                return;
              }
              
              alertsEl.innerHTML = "";
              callback();
            })
            .catch((err) => {
              console.error('Error verifying permissions:', err);
              // If we can't verify permissions, default to allowing access but show a warning
              state.role = "admin"; // Default to admin role
              alertsEl.innerHTML =
                '<div class="alert amber">‚ö†Ô∏è Could not verify permissions. Proceeding with default access. If you experience issues, please refresh the page.</div>';
              // Still call callback to allow the page to load
              setTimeout(() => {
                callback();
              }, 500);
            });
        });
      }

      // Initialize
      ensureAuth(() => {
        // Render start cards immediately (no data needed)
        renderStartCards();
        // Load critical data (this will render KPIs when ready)
        loadCriticalData();
        // Preload students in background (they'll load when modal opens anyway)
        setTimeout(() => loadStudentsIfNeeded(), 1000);
      });
    </script>
  </body>
</html>
