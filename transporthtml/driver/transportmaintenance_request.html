<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Driver Maintenance Request</title>
    <link rel="stylesheet" href="../css/transport.css" />
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div id="contextBar" class="bar"></div>
    <main style="padding:1.5rem; max-width:1100px; margin:0 auto;">
      <section class="card">
        <h2>Maintenance Request</h2>
        <p class="muted">Chagua spare part kutoka soko la SoMAp. Ikiwa haipo, utaambiwa uiongeze kwanza sokoni.</p>

        <form id="maintForm" class="grid two mt-1">
          <div>
            <label>Vehicle</label>
            <select id="vehicleSelect" required></select>
          </div>
          <div>
            <label>Part / Issue</label>
            <input id="partInput" placeholder="e.g. SHOCK ABSORBER" required />
          </div>
          <div>
            <label>Soko Spare (required)</label>
            <select id="sokoItemSelect" required>
              <option value="">Select from soko</option>
            </select>
            <small id="sokoItemMeta" class="muted"></small>
          </div>
          <div>
            <label>Soko price</label>
            <input id="sokoPriceInput" readonly />
          </div>
          <div>
            <label>Quoted spare cost (TZS)</label>
            <input id="costInput" type="number" min="0" required />
          </div>
          <div>
            <label>Fundi labour (TZS)</label>
            <input id="labourCostInput" type="number" min="0" value="0" />
          </div>
          <div>
            <label>Fundi name</label>
            <input id="fundiNameInput" placeholder="Mechanic name" />
          </div>
          <div>
            <label>Odometer</label>
            <input id="odoInput" type="number" min="0" />
          </div>
          <div style="grid-column: span 2;">
            <label>Notes</label>
            <textarea id="notesInput" rows="3"></textarea>
          </div>
          <div style="grid-column: span 2;">
            <label>Photo (optional)</label>
            <input id="photoInput" type="file" accept="image/*" capture="environment" />
          </div>

          <div id="logicHint" class="alert amber hidden" style="grid-column: span 2;"></div>
          <div id="marketError" class="alert red hidden" style="grid-column: span 2;"></div>
          <div id="formError" class="alert red hidden" style="grid-column: span 2;"></div>

          <div style="grid-column: span 2; text-align:right;">
            <button class="btn" type="submit">Submit request</button>
          </div>
        </form>
      </section>

      <section class="card mt-2">
        <div class="flex space center">
          <h3 style="margin:0;">My Requests</h3>
          <small class="muted" id="requestSummary"></small>
        </div>
        <table class="table mt-1">
          <thead>
            <tr>
              <th>Date</th>
              <th>Vehicle</th>
              <th>Part</th>
              <th>Status</th>
              <th>Flags</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="myReqBody"></tbody>
        </table>
        <div id="myReqEmpty" class="empty hidden">No maintenance requests yet.</div>
      </section>
    </main>

    <div id="toast" class="toast hidden"></div>

    <script src="../modules/transport_helpers.js"></script>
    <script src="../modules/transport_context.js"></script>
    <script src="../modules/maintenance.js"></script>
    <script>
      const refs = {
        form: document.getElementById("maintForm"),
        vehicle: document.getElementById("vehicleSelect"),
        part: document.getElementById("partInput"),
        sokoItem: document.getElementById("sokoItemSelect"),
        sokoMeta: document.getElementById("sokoItemMeta"),
        sokoPrice: document.getElementById("sokoPriceInput"),
        cost: document.getElementById("costInput"),
        labourCost: document.getElementById("labourCostInput"),
        fundiName: document.getElementById("fundiNameInput"),
        odo: document.getElementById("odoInput"),
        notes: document.getElementById("notesInput"),
        photo: document.getElementById("photoInput"),
        marketError: document.getElementById("marketError"),
        formError: document.getElementById("formError"),
        logicHint: document.getElementById("logicHint"),
        myReqBody: document.getElementById("myReqBody"),
        myReqEmpty: document.getElementById("myReqEmpty"),
        requestSummary: document.getElementById("requestSummary"),
      };

      const toast = document.getElementById("toast");
      const state = {
        user: null,
        profile: null,
        context: TransportContext.getContext(),
        vehicles: [],
        sokoItems: [],
        myRequests: [],
      };

      function showToast(message, tone = "ok") {
        toast.textContent = message;
        toast.classList.remove("hidden");
        toast.style.background = tone === "bad" ? "#dc2626" : "#1f2937";
        setTimeout(() => toast.classList.add("hidden"), 3200);
      }

      function showBox(el, text) {
        if (!el) return;
        el.textContent = text || "";
        el.classList.toggle("hidden", !text);
      }

      function clearErrors() {
        showBox(refs.formError, "");
        showBox(refs.marketError, "");
        showBox(refs.logicHint, "");
      }

      function normalizeRole(userNode) {
        const role = userNode?.role || userNode?.profile?.role || "";
        return String(role).trim().toLowerCase();
      }

      function selectedVehicle() {
        const id = refs.vehicle.value;
        return state.vehicles.find((v) => v.id === id) || null;
      }

      function selectedSokoItem() {
        const key = refs.sokoItem.value;
        if (!key) return null;
        return state.sokoItems.find((x) => `${x.sellerId}::${x.itemId}` === key) || null;
      }

      function refreshSokoItemsDropdown() {
        const v = selectedVehicle();
        const wantedModel = String(v?.makeModel || "").toLowerCase();
        const byModel = state.sokoItems.filter((item) => {
          if (!item.vehicleModel) return true;
          const m = String(item.vehicleModel).toLowerCase();
          return !wantedModel || m.includes(wantedModel) || wantedModel.includes(m);
        });

        refs.sokoItem.innerHTML = `<option value="">Select from soko (${byModel.length})</option>` +
          byModel.map((item) => {
            const key = `${item.sellerId}::${item.itemId}`;
            const label = `${item.title} - ${item.vehicleModel || "Any model"} - ${TransportMaintenance.fmtMoney(item.price, item.currency)} - ${item.shopName}`;
            return `<option value="${key}">${label}</option>`;
          }).join("");
      }

      function syncFromSokoSelection() {
        const item = selectedSokoItem();
        if (!item) {
          refs.sokoPrice.value = "";
          refs.sokoMeta.textContent = "";
          return;
        }
        refs.part.value = refs.part.value.trim() || item.title;
        refs.sokoPrice.value = TransportMaintenance.fmtMoney(item.price, item.currency || "TZS");
        refs.cost.value = refs.cost.value || String(Number(item.price || 0));
        refs.sokoMeta.textContent = `Shop: ${item.shopName} | Phone: ${item.phoneRaw || "-"} | Lipa: ${item.lipaNumber || "-"}`;
      }

      async function uploadPhoto(requestId, vehicleId) {
        const file = refs.photo.files[0];
        if (!file) return null;
        const ref = firebase.storage().ref(`maintenance/${vehicleId}/${requestId}-${file.name}`);
        await ref.put(file);
        return ref.getDownloadURL();
      }

      async function loadVehiclesAndSoko() {
        state.vehicles = await TransportMaintenance.listVehicles(state.context);
        state.sokoItems = await TransportMaintenance.listSokoVehicleItems();

        refs.vehicle.innerHTML = state.vehicles.length
          ? state.vehicles.map((v) => `<option value="${v.id}">${v.plate} - ${v.makeModel || "Unknown model"}</option>`).join("")
          : '<option value="">No vehicles</option>';

        if (state.user?.uid) {
          const assignedSnap = await firebase.database().ref(TransportHelpers.paths.deviceVehicle(state.user.uid)).get();
          const assigned = String(assignedSnap.val() || localStorage.getItem("somap_vehicleId") || "").trim();
          if (assigned && state.vehicles.some((v) => v.id === assigned)) {
            refs.vehicle.value = assigned;
          }
        }

        refreshSokoItemsDropdown();
      }

      function renderMyRequests() {
        const rows = state.myRequests.slice().sort((a, b) => Number(b.createdAt || 0) - Number(a.createdAt || 0));
        refs.requestSummary.textContent = `${rows.length} request(s)`;
        if (!rows.length) {
          refs.myReqBody.innerHTML = "";
          refs.myReqEmpty.classList.remove("hidden");
          return;
        }
        refs.myReqEmpty.classList.add("hidden");
        refs.myReqBody.innerHTML = rows.map((req) => {
          const dt = req.createdAt ? new Date(req.createdAt).toLocaleDateString() : "-";
          const flags = TransportMaintenance.flagBadges(req);
          const invoiceBtn = req.status === "APPROVED"
            ? `<button class="btn" data-invoice="${req.id}">Invoice</button>`
            : "";
          return `
            <tr>
              <td>${dt}</td>
              <td>${req.vehiclePlate || req.vehicleId || "-"}</td>
              <td>${req.part || "-"}</td>
              <td><span class="chip ${req.status === "APPROVED" ? "ok" : req.status === "REJECTED" ? "bad" : "warn"}">${req.status || "PENDING"}</span></td>
              <td>${flags}</td>
              <td>${invoiceBtn}</td>
            </tr>
          `;
        }).join("");

        refs.myReqBody.querySelectorAll("button[data-invoice]").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const reqId = btn.dataset.invoice;
            const req = state.myRequests.find((r) => r.id === reqId);
            if (!req) return;
            const invSnap = await firebase.database().ref(`maintenance_invoices/${reqId}`).get();
            const invoice = invSnap.val() || TransportMaintenance.buildInvoiceObject(req, {});
            TransportMaintenance.openPrintableInvoice(invoice);
          });
        });
      }

      function subscribeMyRequests() {
        firebase.database().ref("maintenance_requests").on("value", (snapshot) => {
          const list = [];
          snapshot.forEach((child) => {
            const value = child.val() || {};
            if (value.driverUid !== state.user.uid) return;
            if (value.school && value.school !== state.context.school) return;
            list.push({ id: child.key, ...value });
          });
          state.myRequests = list;
          renderMyRequests();
        });
      }

      async function ensureAuthAndLoad() {
        firebase.auth().onAuthStateChanged(async (user) => {
          if (!user) {
            showToast("Sign in first", "bad");
            refs.form.classList.add("hidden");
            return;
          }
          state.user = user;

          const profileSnap = await firebase.database().ref(`users/${user.uid}`).get();
          const profile = profileSnap.val() || {};
          state.profile = profile;
          const role = normalizeRole(profile);
          if (role && role !== "driver" && role !== "dereva") {
            showToast("Driver role required", "bad");
            refs.form.classList.add("hidden");
            return;
          }

          await loadVehiclesAndSoko();
          subscribeMyRequests();
        });
      }

      refs.vehicle.addEventListener("change", () => {
        refreshSokoItemsDropdown();
        syncFromSokoSelection();
      });

      refs.sokoItem.addEventListener("change", () => {
        clearErrors();
        syncFromSokoSelection();
      });

      refs.form.addEventListener("submit", async (event) => {
        event.preventDefault();
        clearErrors();

        const vehicle = selectedVehicle();
        if (!vehicle) {
          showBox(refs.formError, "Select a vehicle first.");
          return;
        }

        const partName = refs.part.value.trim();
        if (!partName) {
          showBox(refs.formError, "Part / issue is required.");
          return;
        }

        let item = selectedSokoItem();
        if (!item) {
          const best = TransportMaintenance.findBestSokoMatch(state.sokoItems, partName, vehicle.makeModel);
          item = best ? best.item : null;
        }
        if (!item) {
          showBox(refs.marketError, "This spare is not in SoMAp soko. Add it in soko first, then submit maintenance.");
          return;
        }

        try {
          const guard = await TransportMaintenance.buildPurchaseGuard(vehicle.id, partName);
          const price = TransportMaintenance.computePriceSignals(Number(refs.cost.value || 0), Number(item.price || 0));
          const flags = TransportMaintenance.buildFlags(guard, price);

          if (guard.purchasedTooSoon) {
            showBox(
              refs.logicHint,
              `Warning: ${partName} for ${vehicle.plate} was bought ${guard.daysSinceLast} day(s) ago. Consult management before approval.`
            );
          }

          const requestRef = firebase.database().ref("maintenance_requests").push();
          const payload = {
            vehicleId: vehicle.id,
            vehiclePlate: vehicle.plate,
            vehicleModel: vehicle.makeModel,
            driverUid: state.user.uid,
            driverName: state.profile?.name || state.profile?.profile?.fullName || "",
            part: partName,
            partSlug: TransportMaintenance.slug(partName),
            estCost: Number(refs.cost.value || 0),
            fundiLabourCost: Number(refs.labourCost.value || 0),
            fundiName: refs.fundiName.value.trim(),
            totalQuotedCost: Number(refs.cost.value || 0) + Number(refs.labourCost.value || 0),
            odoKm: Number(refs.odo.value || 0),
            notes: refs.notes.value.trim(),
            sokoItemId: item.itemId,
            sokoSellerId: item.sellerId,
            sokoShopName: item.shopName,
            sokoOwnerName: item.ownerName,
            sokoPhone: item.phoneRaw,
            sokoWhatsapp: item.whatsappUrl,
            sokoLipaNumber: item.lipaNumber,
            sokoPrice: Number(item.price || 0),
            sokoCurrency: item.currency || "TZS",
            priceDelta: price.delta,
            priceDeltaPct: Number(price.deltaPct.toFixed(2)),
            priceDirection: price.direction,
            repeatPart: guard.repeatPart,
            purchasedTooSoon: guard.purchasedTooSoon,
            minExpectedDays: guard.minDays,
            daysSinceLastPurchase: guard.daysSinceLast,
            lastPurchaseTs: guard.lastPurchaseTs,
            recentCount90d: guard.recentCount90d,
            flags,
            status: "PENDING",
            createdAt: Date.now(),
            school: state.profile?.school || state.context.school,
            year: state.context.year,
            month: state.context.month,
            day: state.context.day,
          };

          const photoUrl = await uploadPhoto(requestRef.key, vehicle.id);
          if (photoUrl) payload.photoUrl = photoUrl;

          await requestRef.set(payload);
          showToast("Maintenance request sent");
          refs.form.reset();
          refs.vehicle.value = vehicle.id;
          refreshSokoItemsDropdown();
          syncFromSokoSelection();
        } catch (err) {
          console.error(err);
          showBox(refs.formError, "Failed to submit maintenance request.");
        }
      });

      TransportContext.attachContextSelectors(document.getElementById("contextBar"), async (ctx) => {
        state.context = ctx;
        if (state.user) await loadVehiclesAndSoko();
      });

      ensureAuthAndLoad();
    </script>
  </body>
</html>
