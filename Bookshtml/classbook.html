<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>SoMAp — Magical Books Library (Secure Reader v2.1)</title>

  <!-- Perf & CDN hints -->
  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <!-- Firebase (compat 9.6.10) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- PDF.js (render PDFs into canvases; no browser toolbar, no download/print UI) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.min.js"></script>
  <script>
    // match worker to the same version above
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.10.111/pdf.worker.min.js";
  </script>

  <style>
    /* ======= Base UI ======= */
    @media print { body { display:none !important; } }
    * { user-select:none; -webkit-user-select:none; -webkit-touch-callout:none; }
    html, body { height:100%; }
    body { font-family:Inter,system-ui,Arial; background:#f8fafc; color:#0f172a; }

    .maxw { max-width: 1120px; margin: 0 auto; }

    /* ======= Hero ======= */
    .hero { position:relative; overflow:hidden; border-radius:20px; background:linear-gradient(135deg, #eef2ff, #f5f3ff); border:1px solid #e5e7eb; }
    .hero-inner { display:flex; gap:18px; align-items:center; padding:18px; }
    .hero h2 { font-weight:900; letter-spacing:.2px; }
    .hero p { color:#334155; font-weight:700; }
    .hero-img { width:64px; height:64px; border-radius:12px; border:2px solid #c7d2fe; background:#fff; object-fit:cover; }

    /* ======= Book Grid ======= */
    .book-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:22px; padding:24px; }
    .book-card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,.05); transition:transform .15s ease, box-shadow .15s ease; }
    .book-card:hover { transform: translateY(-2px); box-shadow:0 6px 18px rgba(2,6,23,.08); }
    .book-thumb-wrap { position:relative; background:#0b1220; }
    .book-thumb { width:100%; height:180px; object-fit:cover; display:block; }
    .thumb-veil { position:absolute; inset:0; background:linear-gradient(180deg, rgba(2,6,23,.0), rgba(2,6,23,.15)); }
    .book-body { padding:14px 14px 16px; }
    .book-title { font-weight:800; line-height:1.2; font-size:1rem; color:#111827; margin-bottom:6px; }
    .book-sub { font-size:.85rem; color:#475569; display:flex; gap:8px; align-items:center; }
    .subject-chip { font-weight:800; font-size:.7rem; padding:4px 8px; border-radius:9999px; border:1px solid rgba(0,0,0,.06); background:#f1f5f9; }
    .read-btn { margin-top:12px; width:100%; background:#4f46e5; color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:800; letter-spacing:.2px; }
    .read-btn:hover { filter:brightness(1.05); }

    /* Kid-friendly color accents per subject (no rainbow/striped patterns) */
    .sub-Mathematics { background:#dbeafe; color:#1e40af; border-color:#bfdbfe; }
    .sub-English { background:#dcfce7; color:#166534; border-color:#bbf7d0; }
    .sub-Science { background:#ede9fe; color:#5b21b6; border-color:#ddd6fe; }
    .sub-Kiswahili { background:#e0f2fe; color:#075985; border-color:#bae6fd; }
    .sub-Social { background:#ffedd5; color:#9a3412; border-color:#fed7aa; }
    .sub-Religious { background:#fae8ff; color:#86198f; border-color:#f5d0fe; }

    .searchbar { width:100%; border:1px solid #e2e8f0; border-radius:14px; padding:12px 48px 12px 16px; font-size:1rem; }
    .searchwrap { position:relative; }
    .searchwrap i { position:absolute; right:14px; top:50%; transform:translateY(-50%); color:#64748b; }

    .loading { text-align:center; margin:40px 0; color:#475569; }
    .spinner { width:38px; height:38px; border:3px solid #e5e7eb; border-top-color:#94a3b8; border-radius:50%; margin:0 auto 12px; animation:spin .9s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ======= Secure Reader Modal ======= */
    .modal { position:fixed; inset:0; background:rgba(2,6,23,.85); backdrop-filter: blur(2px); display:none; z-index:70; }
    .modal.show { display:block; }
    .modal-content { position:absolute; inset:2.5%; display:flex; flex-direction:column; border-radius:16px; overflow:hidden; border:1px solid #1f2937; background:#0b1220; }

    .modal-header { display:flex; align-items:center; gap:10px; padding:10px 14px; color:#e5e7eb; background:#111827; border-bottom:1px solid #1f2937; }
    .modal-header h2 { font-weight:900; font-size:1rem; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .modal-controls { background:#0b1220; border-bottom:1px solid #1f2937; padding:8px 10px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .mc-btn { border:1px solid #293042; background:#111827; color:#e5e7eb; border-radius:10px; padding:8px 12px; font-weight:800; line-height:1; }
    .mc-btn[disabled] { opacity:.5; cursor:not-allowed; }
    .mc-badge { color:#94a3b8; font-weight:800; }

    .reader { position:relative; display:grid; grid-template-columns: 1fr; gap:0; flex:1; overflow:auto; background:#0b1220; }
    .page { position:relative; width:100%; display:block; margin:0 auto; padding: 16px 0; }

    /* Maintain A4 aspect when scaling to container width */
    .page-inner { position:relative; margin:0 auto; width:min(96%, 1000px); background:#111827; border:1px solid #1f2937; border-radius:12px; box-shadow: 0 10px 24px rgba(0,0,0,.25); overflow:hidden; }
    .page-canvas { display:block; width:100%; height:auto; }

    /* Watermarks */
    .wm-overlay { pointer-events:none; position:absolute; inset:0; display:grid; place-items:center; opacity:.08; color:#fff; font-weight:900; font-size:7vw; transform:rotate(-16deg); }
    .wm-line { pointer-events:none; position:absolute; right:12px; bottom:10px; color:rgba(255,255,255,.55); font-weight:800; font-size:.8rem; }

    .viewer-spinner { position:absolute; inset:0; display:none; place-items:center; z-index:3; background:linear-gradient(180deg, rgba(2,6,23,.35), rgba(2,6,23,.25)); }
    .viewer-spinner.show { display:grid; }

    /* Page rail (mini-map thumbnails) */
    .rail { position:absolute; left:8px; top:12px; bottom:12px; width:84px; overflow:auto; display:flex; flex-direction:column; gap:6px; padding-right:6px; border-right:1px solid #1f2937; }
    .rail-thumb { border:1px solid #1f2937; border-radius:8px; overflow:hidden; background:#0b1220; cursor:pointer; }
    .rail-thumb canvas { width:100%; height:auto; display:block; }

    /* Floating buttons */
    .floating { position:absolute; right:12px; bottom:12px; display:flex; flex-direction:column; gap:8px; z-index:5; }
    .float-btn { border:1px solid #293042; background:#111827; color:#e5e7eb; border-radius:12px; padding:10px; font-weight:900; }

    /* Progress bar */
    .progress { position:sticky; bottom:0; left:0; right:0; height:6px; background:#0b1220; }
    .progress > div { height:100%; width:0%; background:#4f46e5; }

    /* Deterrents */
    .no-events { pointer-events:none !important; }
    .glass-veil { position:absolute; inset:0; background:transparent; z-index:2; }

    /* Tooltip-ish */
    .tip { font-size:.78rem; color:#94a3b8; }

    /* Mobile tweaks */
    @media (max-width: 720px) {
      .rail { display:none; }
      .modal-content { inset:1.5%; }
      .page-inner { width: 98%; }
    }
  </style>
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>
</head>
<body>
  <!-- ======= Top ======= -->
  <header class="bg-white border-b border-gray-200">
    <div class="maxw px-4 py-3 flex items-center justify-between">
      <h1 class="text-lg font-extrabold tracking-tight">Magical Books Library</h1>
      <a id="backBtn" href="../index.html" class="text-sm font-extrabold text-indigo-600 hover:text-indigo-700">Back</a>
    </div>
  </header>

  <!-- ======= Hero ======= -->
  <section class="maxw px-4 mt-4">
    <div class="hero">
      <div class="hero-inner">
        <img id="school-logo-display" class="hero-img" src="../images/socrates_logo.png" alt="School Logo" onerror="this.onerror=null;this.src='../images/socrates_logo.png';"/>
        <div>
          <h2 class="text-xl sm:text-2xl">Here is your Library — <span class="text-indigo-700">Read</span>, enjoy <span class="text-emerald-700">school books</span>, <span class="text-purple-700">story books</span>, and <span class="text-amber-700">fun books</span>. Build your own future.</h2>
          <p class="mt-1 italic">“An unexamined life is not worth living.” — <strong>Socrates</strong></p>

          <div class="mt-3 flex flex-wrap items-center gap-3">
            <div class="text-sm font-bold text-gray-700">School: <span id="somapSchoolName">—</span></div>
            <div class="text-sm font-bold text-gray-700">Class: <span id="somapResolvedClass">—</span></div>
            <div class="ml-auto flex flex-wrap items-center gap-2">
              <label class="text-xs uppercase tracking-wider text-gray-500 font-extrabold">Academic Year</label>
              <select data-somap-year-select class="rounded-lg border border-gray-300 px-2 py-1 text-sm font-extrabold"></select>
              <div class="text-xs text-gray-600">Working year: <span id="somapYearHint" class="font-extrabold">—</span></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </section>

  <!-- ======= Body ======= -->
  <main class="maxw px-4 py-6">
    <div class="mb-4 searchwrap">
      <input id="searchInput" class="searchbar" placeholder="Search books by title or subject…"/>
      <i class="fa fa-search"></i>
    </div>

    <div id="booksGrid" class="book-grid"></div>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      Loading your books…
    </div>

    <div id="noBooks" class="hidden text-center text-gray-500 my-10">
      <i class="fa fa-book-open text-5xl mb-4"></i>
      <div>No books available yet.</div>
    </div>
  </main>

  <!-- ======= Secure Overlay Reader (no external PDF/UI) ======= -->
  <div id="viewer" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
        <button id="closeBtn" class="mc-btn"><i class="fa fa-times mr-1"></i>Close</button>
      </div>

      <div class="modal-controls">
        <button id="fsBtn" class="mc-btn"><i class="fa fa-expand mr-1"></i>Full Screen</button>
        <button id="zinBtn" class="mc-btn"><i class="fa fa-search-plus mr-1"></i>Zoom In</button>
        <button id="zoutBtn" class="mc-btn"><i class="fa fa-search-minus mr-1"></i>Zoom Out</button>
        <button id="rotBtn" class="mc-btn"><i class="fa fa-rotate mr-1"></i>Rotate</button>
        <button id="fitBtn" class="mc-btn"><i class="fa fa-compress mr-1"></i>Reset</button>
        <button id="clarityBtn" class="mc-btn" title="Increase page rendering sharpness">Clarity: <span id="clarityLabel">HD</span></button>
        <div class="ml-auto mc-badge" id="zoomLabel">100%</div>
      </div>

      <div id="readerWrap" class="reader">
        <!-- left rail of page thumbs -->
        <aside id="rail" class="rail"></aside>

        <!-- main pages column -->
        <section id="pages" style="position:relative;">
          <div class="viewer-spinner" id="viewerSpinner">
            <div>
              <div class="spinner" style="margin:0 auto 10px;"></div>
              <div class="text-white text-sm font-extrabold text-center">Loading…</div>
            </div>
          </div>
          <!-- canvases and overlays inserted here -->
        </section>

        <!-- floating actions (extra) -->
        <div class="floating">
          <button id="topBtn" class="float-btn" title="Back to Top"><i class="fa fa-arrow-up"></i></button>
          <button id="fitPageBtn" class="float-btn" title="Fit Page"><i class="fa fa-up-right-and-down-left-from-center"></i></button>
        </div>

        <!-- subtle reading progress -->
        <div class="progress"><div id="progBar"></div></div>
      </div>
    </div>
  </div>

  <script>
  // ================== Firebase ==================
  const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const urlParams = new URLSearchParams(location.search);
  const forcedStudentId = urlParams.get('student');
  const forcedClassParam = (urlParams.get('class') || '').trim();
  const forcedYearParam = (urlParams.get('year') || '').trim();

  // Sync year from URL to the shared yearContext (navigation should not "pin" manual year).
  if (forcedYearParam && window.somapYearContext && typeof window.somapYearContext.setSelectedYear === 'function') {
    window.somapYearContext.setSelectedYear(forcedYearParam, { manual: false, forceDispatch: true });
  }

  function getActiveYear(){
    return (window.somapYearContext && typeof window.somapYearContext.getSelectedYear === 'function')
      ? String(window.somapYearContext.getSelectedYear())
      : String(new Date().getFullYear());
  }

  // MULTI-SCHOOL guard (required on every SoMAp page)
  let currentSchool = null;
  try { currentSchool = window.SOMAP && typeof SOMAP.getSchool === 'function' ? SOMAP.getSchool() : null; } catch(_e){}
  if (!currentSchool || !currentSchool.id) {
    location.href = "../somapappv1multischool/multischool.html";
    throw new Error("No active school selected");
  }
  const schoolId = String(currentSchool.id);
  const schoolName = String(currentSchool.name || currentSchool.id || "");
  const schoolRef = (subPath) => db.ref(SOMAP.P(subPath));

  // UI: show school name + working year
  const schoolNameEl = document.getElementById('somapSchoolName');
  if (schoolNameEl) schoolNameEl.textContent = schoolName || schoolId;
  const yearHintEl = document.getElementById('somapYearHint');
  if (yearHintEl) yearHintEl.textContent = getActiveYear();

  // Dynamic school logo (falls back to Socrates logo)
  async function loadSchoolLogo(){
    const img = document.getElementById('school-logo-display');
    if (!img) return;
    if (schoolId === "socrates-school" || schoolId === "default") {
      img.src = "../images/socrates_logo.png";
      return;
    }
    try{
      const snap = await db.ref(`schools/${schoolId}/profile/logoUrl`).once('value');
      const url = snap.val();
      img.src = url || "../images/socrates_logo.png";
    } catch(_e){
      img.src = "../images/socrates_logo.png";
    }
  }
  loadSchoolLogo();

  if (forcedStudentId){
    try{ localStorage.setItem('studentKey', forcedStudentId); }catch(_e){}
  }

  let userMode = 'child'; // 'child' | 'teacher'
  let className = '';
  let userKey = '';

  let childBaseClass = '';
  let teacherBaseClass = '';

  function updateResolvedClassUI(cls){
    const el = document.getElementById('somapResolvedClass');
    if (el) el.textContent = cls || '—';
  }

  function showGraduatedState(){
    updateResolvedClassUI('Graduated');
    const grid = document.getElementById('booksGrid');
    if (grid) grid.innerHTML = '<div class="empty">Student has graduated (Class 7 completed). Books are in the previous years.</div>';
  }

  function refreshForActiveYear(){
    const yr = getActiveYear();
    const yearEl = document.getElementById("somapYearHint");
    if (yearEl) yearEl.textContent = yr;

    if (userMode === "child" && childBaseClass){
      const cls = shiftClassForYear(childBaseClass, yr);
      className = cls;
      updateResolvedClassUI(cls);

      if (cls === "GRADUATED") { showGraduatedState(); return; }
      fetchBooks(cls);
      return;
    }

    if (userMode === "teacher" && teacherBaseClass){
      const cls = normalizeClassName(teacherBaseClass);
      className = cls;
      updateResolvedClassUI(cls);
      fetchBooks(cls);
    }
  }

  // React to year selector changes
  if (window.somapYearContext && typeof window.somapYearContext.onYearChanged === 'function') {
    window.somapYearContext.onYearChanged(() => refreshForActiveYear());
  }


  auth.onAuthStateChanged(async (user) => {
    if (user) {
      userKey = user.email.replace(/\./g,'_');
      try {
        const snap = await db.ref(`users/${userKey}`).once('value');
        const u = snap.val();
        if (u && u.role === 'teacher' && u.class) {
          userMode = 'teacher';
          teacherBaseClass = (u.class || '').trim();
          className = normalizeClassName(teacherBaseClass);
          updateResolvedClassUI(className);
          initTeacher();
          refreshForActiveYear();
        } else {
          alert('Invalid teacher access'); location.href='../index.html';
        }
      } catch(e){ alert(e.message); }
    } else {
      const studentKey = forcedStudentId || localStorage.getItem('studentKey');
      if (!studentKey){ alert('Please sign in'); location.href='../index.html'; return; }
      try {
        const snap = await schoolRef(`students/${studentKey}`).once('value');
        const s = snap.val();
        if (!s && !forcedClassParam){
          localStorage.removeItem('studentKey');
          location.href='../index.html';
          return;
        }
        const baseClassRaw = (forcedClassParam || s?.classLevel || s?.class || 'Class 1').trim();
      childBaseClass = baseClassRaw;

      userMode = 'child';
      className = shiftClassForYear(baseClassRaw, getActiveYear());
      updateResolvedClassUI(className);

      initChild();
      refreshForActiveYear();
      } catch(e){ alert(e.message); }
    }
  });

  function initTeacher(){ document.getElementById('backBtn').href = '../staff.html'; }
  function initChild(){ document.getElementById('backBtn').href = '../parent.html'; }

  // ================== Data / Grid ==================
  const cache = new Map();
  const thumbCache = new Map(); // url -> dataURL
  const loadingEl = document.getElementById('loading');
  const noBooksEl = document.getElementById('noBooks');
  const grid = document.getElementById('booksGrid');
  const searchInput = document.getElementById('searchInput');

  function isPdf(url){ return /\.pdf(\?|#|$)/i.test(url||''); }
  function thumbFrom(url){
    if (isPdf(url)) return null; // handled by PDF cover generator below
    return /res\.cloudinary\.com/.test(url)
      ? url.replace('/upload/','/upload/fl_sanitize,pg_1,f_jpg,q_auto,w_360/')
      : url;
  }

  function normalizeClassName(value){
    const raw = (value || '').trim();
    if (!raw) return '';
    const lower = raw.toLowerCase();

    // Canonical class labels for Books module:
    // Baby Class, Middle Class, Pre-Unit, Class 1..Class 7
    if (lower.includes('baby') || lower.includes('nursery')) return 'Baby Class';
    if (lower.includes('middle')) return 'Middle Class';
    if (lower.includes('pre unit') || lower.includes('pre-unit') || lower.includes('preunit')) return 'Pre-Unit';

    const classMatch = lower.match(/class\s*(\d+)/);
    if (classMatch) return `Class ${classMatch[1]}`;

    if (lower.includes('std 7') || lower.includes('standard 7') || lower.includes('grade 7')) return 'Class 7';
    return raw;
  }

  const SOMAP_CLASS_ANCHOR_YEAR = 2025;
  const BOOKS_CLASS_ORDER = [
    'Baby Class',
    'Middle Class',
    'Pre-Unit',
    'Class 1',
    'Class 2',
    'Class 3',
    'Class 4',
    'Class 5',
    'Class 6',
    'Class 7',
  ];

  function shiftClassForYear(baseClass, targetYear){
    const base = normalizeClassName(baseClass);
    const yearNum = Number(targetYear);
    const delta = (Number.isFinite(yearNum) ? yearNum : new Date().getFullYear()) - SOMAP_CLASS_ANCHOR_YEAR;

    const idx = BOOKS_CLASS_ORDER.findIndex((c) => c.toLowerCase() === base.toLowerCase());
    if (idx < 0) return base;

    const next = idx + delta;
    if (next >= BOOKS_CLASS_ORDER.length) return 'GRADUATED';
    if (next < 0) return base;
    return BOOKS_CLASS_ORDER[next];
  }

let currentBooksCacheKey = ""; // used by search

function classKeyVariants(normalizedCls){
  const raw = String(normalizedCls || "").trim();
  const enc = encodeURIComponent(raw);
  // Try encoded first (new uploader), then raw (older nodes)
  return (enc && enc !== raw) ? [enc, raw] : [raw];
}

async function pickFirstExistingPath(paths){
  for (const p of paths){
    try{
      const snap = await db.ref(p).once("value");
      if (snap.exists()) return p;
    }catch(_e){}
  }
  return paths[0]; // if none exists yet, still listen on the best candidate
}

async function fetchBooks(cls){
  const normalizedCls = normalizeClassName(cls);
  const year = getActiveYear();

  // UI loading
  grid.innerHTML = "";
  loadingEl.classList.remove("hidden");
  noBooksEl.classList.add("hidden");

  // Cache key MUST include year
  const cacheKey = `books_${year}_${normalizedCls}`;
  currentBooksCacheKey = cacheKey;

  // Show cached immediately (if any)
  try{
    const cached = localStorage.getItem(cacheKey);
    if (cached){
      const entries = JSON.parse(cached);
      if (Array.isArray(entries)){
        cache.set(cacheKey, entries);
        renderBooks(entries);
      }
    }
  }catch(_e){}

  // stop old listeners
  if (window.__booksRefUnsub) { window.__booksRefUnsub(); window.__booksRefUnsub = null; }

  // Build candidate paths (try YEAR first, then legacy; try encoded + raw class keys)
  const keys = classKeyVariants(normalizedCls);
  const candidates = [];
  for (const k of keys) candidates.push(`class_books/${year}/${k}`);
  for (const k of keys) candidates.push(`class_books/${k}`);

  const chosenPath = await pickFirstExistingPath(candidates);
  const ref = db.ref(chosenPath);

  ref.on("value", (snap) => {
    const val = snap.val() || {};

    // IMPORTANT: keep [id, book] entries so renderBooks works
    let entries = Object.entries(val);

    // store in memory + local cache
    cache.set(cacheKey, entries);
    try{ localStorage.setItem(cacheKey, JSON.stringify(entries)); }catch(_e){}

    renderBooks(entries);
  });

  window.__booksRefUnsub = () => ref.off();
}

  // attach once
  searchInput.addEventListener("input", () => {
    const q = (searchInput.value || "").toLowerCase().trim();
    const all = cache.get(currentBooksCacheKey) || [];

    const filtered = all.filter(([id, b]) => {
      const t = (b?.title || "").toLowerCase();
      const s = (b?.subject || "").toLowerCase();
      return t.includes(q) || s.includes(q);
    });

    renderBooks(filtered);
  });

  function subjectClass(s){
    if(!s) return '';
    const k = s.toLowerCase();
    if (k.includes('math')) return 'sub-Mathematics';
    if (k.includes('eng')) return 'sub-English';
    if (k.includes('sci')) return 'sub-Science';
    if (k.includes('kis')) return 'sub-Kiswahili';
    if (k.includes('socs')||k.includes('social')) return 'sub-Social';
    if (k.includes('relig')) return 'sub-Religious';
    return '';
  }

  async function generatePdfCoverThumb(url){
    if (thumbCache.has(url)) return thumbCache.get(url);
    try{
      const cacheKey = 'somap_thumb_' + btoa(url).replace(/=/g,'');
      const existing = sessionStorage.getItem(cacheKey);
      if (existing){ thumbCache.set(url, existing); return existing; }

      const buf = await fetch(url, { credentials:'omit' }).then(r=>r.arrayBuffer());
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      const page = await pdf.getPage(1);
      const desired = 360; // px width for card
      const vp = page.getViewport({ scale: 1 });
      const scale = desired / vp.width;
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      await page.render({ canvasContext: ctx, viewport }).promise;
      const dataURL = canvas.toDataURL('image/jpeg', 0.86);
      thumbCache.set(url, dataURL);
      sessionStorage.setItem(cacheKey, dataURL);
      return dataURL;
    }catch(e){
      console.warn('thumb gen failed', e); return null;
    }
  }

  async function renderBooks(entries){
    loadingEl.classList.add('hidden');
    grid.innerHTML = '';
    if (!entries.length){ noBooksEl.classList.remove('hidden'); return; }
    noBooksEl.classList.add('hidden');

    const frag = document.createDocumentFragment();
    for (const [id,b] of entries){
      const card = document.createElement('div');
      card.className = 'book-card';
      const t = (b.title||'Untitled');
      const s = (b.subject||'');
      const subClass = subjectClass(s);

      let cover = thumbFrom(b.url||'');
      if (!cover && isPdf(b.url)){
        // placeholder while generating
        cover = 'https://dummyimage.com/640x360/0b1220/ffffff.png&text=Loading…';
        // async improve once ready
        generatePdfCoverThumb(b.url).then(dataURL=>{
          if (!dataURL) return;
          const imgEl = card.querySelector('img[data-id="'+id+'"]');
          if (imgEl) imgEl.src = dataURL;
        });
      }

      card.innerHTML = `
        <div class="book-thumb-wrap">
          <img class="book-thumb" data-id="${id}" loading="lazy" src="${cover||''}" alt="${escapeHtml(t)} cover" onerror="this.style.display='none'">
          <div class="thumb-veil"></div>
        </div>
        <div class="book-body">
          <div class="book-title">${escapeHtml(t)}</div>
          <div class="book-sub"><span class="subject-chip ${subClass}">${escapeHtml(s||'General')}</span></div>
          <button class="read-btn" data-url="${b.url||''}" data-title="${escapeHtml(t)}"><i class="fa fa-book-open mr-1"></i>Read</button>
        </div>`;
      frag.appendChild(card);
    }
    grid.appendChild(frag);

    grid.querySelectorAll('.read-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        openViewer(btn.getAttribute('data-url'), btn.getAttribute('data-title'));
      });
    });
  }

  function escapeHtml(t){ const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

  // ================== Secure Reader (Canvas-based) ==================
  const viewer = document.getElementById('viewer');
  const pagesEl = document.getElementById('pages');
  const railEl = document.getElementById('rail');
  const spinner = document.getElementById('viewerSpinner');
  const titleEl = document.getElementById('modalTitle');
  const zoomLabel = document.getElementById('zoomLabel');
  const fsBtn = document.getElementById('fsBtn');
  const zinBtn = document.getElementById('zinBtn');
  const zoutBtn = document.getElementById('zoutBtn');
  const rotBtn = document.getElementById('rotBtn');
  const fitBtn = document.getElementById('fitBtn');
  const fitPageBtn = document.getElementById('fitPageBtn');
  const topBtn = document.getElementById('topBtn');
  const closeBtn = document.getElementById('closeBtn');
  const progBar = document.getElementById('progBar');
  const clarityBtn = document.getElementById('clarityBtn');
  const clarityLabel = document.getElementById('clarityLabel');

  let zoom = 1, rotation = 0;
  const ZMIN=0.6, ZMAX=2.5, ZSTEP=0.1;
  let activeDoc = null; // { type:'pdf'|'img', pdf?, numPages? }
  let pageRecords = new Map(); // p -> {canvas, container, renderedScale, thumbCanvas}
  let observer = null;

  // Clarity levels (multiplies devicePixelRatio for sharper text on phones)
  const CLARITIES = [
    { key:'normal', label:'Normal', mult:1.0 },
    { key:'hd',     label:'HD',     mult:1.5 },
    { key:'ultra',  label:'Ultra',  mult:2.0 },
  ];
  let clarityIndex = 1; // default HD
  try{
    const saved = localStorage.getItem('somap_reader_clarity');
    if (saved){ const i = CLARITIES.findIndex(c=>c.key===saved); if (i>=0) clarityIndex=i; }
  }catch(_){ }

  function setClarity(i){
    clarityIndex = (i+CLARITIES.length)%CLARITIES.length;
    clarityLabel.textContent = CLARITIES[clarityIndex].label;
    try{ localStorage.setItem('somap_reader_clarity', CLARITIES[clarityIndex].key); }catch(_){ }
    rerenderAllVisible(true);
  }
  // mobile: default to higher clarity and slightly larger zoom
  if (window.innerWidth < 720) { clarityIndex = Math.max(clarityIndex, 1); }
  clarityLabel.textContent = CLARITIES[clarityIndex].label;

  clarityBtn.onclick = ()=> setClarity(clarityIndex+1);

  function setLoading(on){
    spinner.classList.toggle('show', !!on);
    [fsBtn, zinBtn, zoutBtn, rotBtn, fitBtn, fitPageBtn, closeBtn, clarityBtn].forEach(b=>{
      b.disabled = !!on;
    });
  }

  function updateWatermarks(){
    const now = new Date().toLocaleString();
    const who = userKey || 'SoMAp User';
    document.querySelectorAll('.wm-overlay').forEach(el=> el.textContent = `SoMAp — ${who}`);
    document.querySelectorAll('.wm-line').forEach(el=> el.textContent = `SoMAp • ${who} • ${now}`);
  }

  async function openViewer(rawUrl, title){
    const url = (rawUrl||'').trim(); if (!url) return;
    titleEl.textContent = title || 'Book';
    viewer.classList.add('show');
    document.body.style.overflow='hidden';
    setLoading(true); updateWatermarks();

    // Clear state
    pagesEl.innerHTML = '';
    railEl.innerHTML = '';
    pageRecords = new Map();
    rotation = 0; setZoom(window.innerWidth<720?1.1:1, false);

    if (/\.pdf(\?|#|$)/i.test(url)){
      activeDoc = { type:'pdf' };
      try{
        // Fetch into memory buffer to avoid exposing URL in any DOM attribute
        const buf = await fetch(url, { credentials:'omit' }).then(r=>r.arrayBuffer());
        const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
        activeDoc.pdf = pdf; activeDoc.numPages = pdf.numPages;
        buildPagesSkeleton(pdf.numPages);
        setupLazyRender();
      }catch(e){ alert('Failed to load PDF'); console.error(e); }
      setLoading(false);
    } else {
      activeDoc = { type:'img' };
      try{
        await renderImageToCanvas(url);
      }catch(e){ alert('Failed to load image'); console.error(e); }
      setLoading(false);
    }
  }

  function closeViewer(){
    viewer.classList.remove('show');
    document.body.style.overflow='';
    if (observer) { observer.disconnect(); observer = null; }
    pageRecords.forEach(rec=> rec.renderTask && rec.renderTask.cancel?.());
    activeDoc = null; pageRecords.clear();
  }

  // ===== PDF: skeleton + lazy rendering =====
  function buildPagesSkeleton(n){
    const frag = document.createDocumentFragment();
    for(let p=1; p<=n; p++){
      const pageWrap = document.createElement('article');
      pageWrap.className = 'page';
      pageWrap.dataset.page = String(p);

      const inner = document.createElement('div');
      inner.className = 'page-inner';

      const canvas = document.createElement('canvas');
      canvas.className = 'page-canvas';
      canvas.width = 100; canvas.height = 100; // placeholder

      const veil = document.createElement('div'); veil.className = 'glass-veil';
      const wmBig = document.createElement('div'); wmBig.className = 'wm-overlay'; wmBig.textContent = 'SoMAp';
      const wmSmall = document.createElement('div'); wmSmall.className = 'wm-line'; wmSmall.textContent = 'SoMAp';

      inner.appendChild(canvas);
      inner.appendChild(veil);
      inner.appendChild(wmBig);
      inner.appendChild(wmSmall);
      pageWrap.appendChild(inner);
      frag.appendChild(pageWrap);

      // Left rail thumb shell
      const r = document.createElement('div'); r.className = 'rail-thumb'; r.dataset.page = String(p);
      const tc = document.createElement('canvas'); r.appendChild(tc);
      railEl.appendChild(r);

      pageRecords.set(p, { canvas, container: inner, thumbCanvas: tc, renderedScale: 0, renderTask: null });
    }
    pagesEl.appendChild(frag);
    updateWatermarks();
  }

  function setupLazyRender(){
    if (observer) observer.disconnect();
    const opts = { root: document.getElementById('readerWrap'), rootMargin: '600px 0px', threshold: 0.01 };
    observer = new IntersectionObserver((entries)=>{
      entries.forEach(en=>{
        if (en.isIntersecting){
          const pageNo = Number(en.target.dataset.page);
          renderPdfPage(pageNo);
        }
      });
    }, opts);
    document.querySelectorAll('.page').forEach(el=> observer.observe(el));
  }

  function effectiveDpr(){
    const sys = Math.min(window.devicePixelRatio||1, 2.5);
    const mult = CLARITIES[clarityIndex].mult;
    return Math.min(sys*mult, 3);
  }

  async function renderPdfPage(p){
    if (!activeDoc?.pdf) return;
    const rec = pageRecords.get(p); if (!rec) return;
    const pdf = activeDoc.pdf;

    const availCss = Math.min(rec.container.clientWidth || 1000, 1000) * zoom;
    const page = await pdf.getPage(p);
    const baseViewport = page.getViewport({ scale: 1, rotation });
    const dpr = effectiveDpr();
    const renderScale = (availCss / baseViewport.width) * dpr; // high-res render

    if (Math.abs((rec.renderedScale||0) - renderScale) < 0.03 && rec._lastRot === rotation) return;

    try{ rec.renderTask?.cancel?.(); }catch(_){ }

    const viewport = page.getViewport({ scale: renderScale, rotation });
    const canvas = rec.canvas;
    const ctx = canvas.getContext('2d', { willReadFrequently:false });
    canvas.width = Math.floor(viewport.width);
    canvas.height = Math.floor(viewport.height);
    // CSS size remains in CSS pixels (not DPR) for crispness on phone
    canvas.style.width = Math.floor(viewport.width / dpr) + 'px';
    canvas.style.height = Math.floor(viewport.height / dpr) + 'px';

    const renderTask = page.render({ canvasContext: ctx, viewport });
    rec.renderTask = renderTask; rec.renderedScale = renderScale; rec._lastRot = rotation;

    try{
      await renderTask.promise;
      drawWatermarkOnCanvas(canvas, `SoMAp — ${userKey||'User'}`);
      // tiny rail thumb
      const tctx = rec.thumbCanvas.getContext('2d');
      const tw = 80; const th = Math.floor((tw/canvas.clientWidth)*canvas.clientHeight);
      rec.thumbCanvas.width = tw; rec.thumbCanvas.height = th;
      tctx.drawImage(canvas, 0, 0, tw, th);
    }catch(e){ if (e?.name!=='RenderingCancelledException') console.warn('render error', e); }
  }

  function drawWatermarkOnCanvas(canvas, text){
    try{
      const ctx = canvas.getContext('2d');
      ctx.save();
      const diag = Math.sqrt(canvas.width*canvas.width + canvas.height*canvas.height);
      ctx.globalAlpha = 0.06; ctx.translate(canvas.width/2, canvas.height/2); ctx.rotate(-Math.PI/10);
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      const fontSize = Math.max(24, Math.floor(diag*0.06));
      ctx.font = `900 ${fontSize}px Inter, system-ui, Arial`;
      ctx.fillStyle = '#ffffff';
      ctx.fillText(text, 0, 0);
      ctx.restore();

      ctx.save();
      ctx.globalAlpha = 0.5; ctx.font = '800 14px Inter, system-ui, Arial';
      ctx.fillStyle = '#ffffff';
      ctx.textAlign = 'right'; ctx.textBaseline = 'alphabetic';
      const small = `SoMAp • ${userKey||'User'} • ${new Date().toLocaleString()}`;
      ctx.fillText(small, canvas.width-12, canvas.height-10);
      ctx.restore();
    }catch(_){ }
  }

  // ===== Image path: render into a canvas (not <img>) =====
  async function renderImageToCanvas(url){
    const pageWrap = document.createElement('article');
    pageWrap.className = 'page'; pageWrap.dataset.page = '1';
    const inner = document.createElement('div'); inner.className = 'page-inner';
    const canvas = document.createElement('canvas'); canvas.className = 'page-canvas';
    const veil = document.createElement('div'); veil.className = 'glass-veil';
    const wmBig = document.createElement('div'); wmBig.className = 'wm-overlay';
    const wmSmall = document.createElement('div'); wmSmall.className = 'wm-line';
    inner.appendChild(canvas); inner.appendChild(veil); inner.appendChild(wmBig); inner.appendChild(wmSmall);
    pageWrap.appendChild(inner); pagesEl.appendChild(pageWrap);

    const img = new Image(); img.crossOrigin = 'anonymous';
    await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=url; });

    const dpr = effectiveDpr();
    const availCss = Math.min(inner.clientWidth||1000, 1000) * zoom;
    const scale = (availCss / img.width) * dpr;
    const cw = Math.floor(img.width * scale);
    const ch = Math.floor(img.height * scale);
    canvas.width = cw; canvas.height = ch;
    canvas.style.width = Math.floor(cw / dpr) + 'px';
    canvas.style.height = Math.floor(ch / dpr) + 'px';
    const ctx = canvas.getContext('2d');

    if (rotation) {
      const tmp = document.createElement('canvas'); tmp.width = cw; tmp.height = ch; tmp.getContext('2d').drawImage(img, 0,0,cw,ch);
      canvas.width = ch; canvas.height = cw; canvas.style.width = Math.floor(ch/dpr)+'px'; canvas.style.height = Math.floor(cw/dpr)+'px';
      ctx.save(); ctx.translate(canvas.width/2, canvas.height/2); ctx.rotate(rotation*Math.PI/180); ctx.drawImage(tmp, -cw/2, -ch/2); ctx.restore();
    } else {
      ctx.drawImage(img, 0,0,cw,ch);
    }
    drawWatermarkOnCanvas(canvas, `SoMAp — ${userKey||'User'}`);

    const r = document.createElement('div'); r.className = 'rail-thumb'; r.dataset.page = '1';
    const tc = document.createElement('canvas'); r.appendChild(tc); railEl.appendChild(r);
    const tctx = tc.getContext('2d'); tc.width = 80; tc.height = Math.floor((80/canvas.clientWidth)*canvas.clientHeight);
    tctx.drawImage(canvas,0,0,tc.width, tc.height);

    pageRecords.set(1, { canvas, container: inner, thumbCanvas: tc, renderedScale: zoom, renderTask: null });
  }

  // ===== Controls =====
  function setZoom(z, rerender=true){ zoom = Math.min(ZMAX, Math.max(ZMIN, z)); zoomLabel.textContent = Math.round(zoom*100)+'%'; if (rerender) rerenderAllVisible(); }
  function applyRotation(){ rotation = (rotation+90)%360; rerenderAllVisible(true); }
  function resetView(){ zoom=1; rotation=0; zoomLabel.textContent='100%'; rerenderAllVisible(true); }

  function rerenderAllVisible(force=false){
    if (!activeDoc) return;
    if (activeDoc.type==='pdf'){
      document.querySelectorAll('.page').forEach(el=>{
        const rect = el.getBoundingClientRect();
        const inView = rect.bottom > 0 && rect.top < window.innerHeight*1.8;
        if (inView || force){
          const pageNo = Number(en.target.dataset.page);
          renderPdfPage(pageNo);
        }
      });
    } else if (activeDoc.type==='img') {
      const rec = pageRecords.get(1);
      if (rec){
        // Re-render from source URL if we saved it in dataset
        const url = rec._src || rec.canvas.toDataURL('image/png');
        pagesEl.innerHTML = ''; // clear and rebuild
        renderImageToCanvas(url);
      }
    }
  }

  fsBtn.onclick = () => {
    const el = document.querySelector('.modal-content');
    if (!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
  };
  zinBtn.onclick = () => setZoom(+(zoom+ZSTEP).toFixed(2));
  zoutBtn.onclick = () => setZoom(+(zoom-ZSTEP).toFixed(2));
  rotBtn.onclick = () => applyRotation();
  fitBtn.onclick = () => resetView();
  fitPageBtn.onclick = () => setZoom(1);
  topBtn.onclick = () => pagesEl.parentElement.scrollTo({ top:0, behavior:'smooth' });
  closeBtn.onclick = () => closeViewer();

  // keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if (!viewer.classList.contains('show')) return;
    if (e.key==='Escape'){ closeViewer(); e.preventDefault(); }
    if (e.key==='+'||e.key==='='){ zinBtn.click(); e.preventDefault(); }
    if (e.key==='-'||e.key==='_'){ zoutBtn.click(); e.preventDefault(); }
    if (e.key.toLowerCase()==='r'){ rotBtn.click(); e.preventDefault(); }
    if (e.key.toLowerCase()==='f'){ fsBtn.click(); e.preventDefault(); }
    if (e.key==='0'){ fitBtn.click(); e.preventDefault(); }
    if ((e.ctrlKey||e.metaKey) && (e.key==='p'||e.key==='s')) { e.preventDefault(); alert('Blocked.'); }
  }, true);

  // ctrl + wheel zoom
  document.getElementById('readerWrap').addEventListener('wheel',(e)=>{
    if (!viewer.classList.contains('show')) return;
    if (e.ctrlKey){ e.preventDefault();
      const d = e.deltaY>0 ? -ZSTEP : ZSTEP; setZoom(+(zoom+d).toFixed(2));
    }
  }, {passive:false});

  // reading progress
  document.getElementById('readerWrap').addEventListener('scroll', (e)=>{
    const el = e.currentTarget; const pct = (el.scrollTop/(el.scrollHeight-el.clientHeight))*100;
    progBar.style.width = Math.max(0, Math.min(100, pct))+'%';
  });

  // page rail navigation
  railEl.addEventListener('click',(e)=>{
    const box = e.target.closest('.rail-thumb'); if (!box) return;
    const p = Number(box.dataset.page); const pageElem = document.querySelector(`.page[data-page="${p}"]`);
    pageElem?.scrollIntoView({ behavior:'smooth', block:'start' });
  });

  // watermark refresh & re-render on resize/orientation
  setInterval(()=>{ if (viewer.classList.contains('show')) updateWatermarks(); }, 30000);
  let resizeTimer=null; window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer=setTimeout(()=> rerenderAllVisible(true), 200); });

  // deterrents: disallow context menu & printing & selection
  window.print = function(){ alert('Printing is disabled.'); return false; };
  document.addEventListener('contextmenu', (e)=>{ if (viewer.classList.contains('show')) e.preventDefault(); }, true);
  document.addEventListener('dragstart', (e)=>{ if (viewer.classList.contains('show')) e.preventDefault(); }, true);
  document.addEventListener('copy', (e)=>{ if (viewer.classList.contains('show')) e.preventDefault(); }, true);

  // double-tap zoom on mobile
  let lastTap=0; document.getElementById('pages').addEventListener('touchend', (e)=>{
    const now = Date.now(); if (now-lastTap<300){ setZoom(zoom<1.4?1.6:1); }
    lastTap=now;
  });

  // ========= End =========
  </script>
</body>
</html>
