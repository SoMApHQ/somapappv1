<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Extend Pay Period Hub | SoMAp</title>
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="../firebase.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --bg: #f4f6fb;
      --ink: #112033;
      --muted: #5c6c7f;
      --card: #ffffff;
      --line: #dbe2ef;
      --brand: #0f766e;
      --brand-soft: #d8f3ef;
      --warn: #b45309;
      --warn-soft: #fff3dc;
      --bad: #b91c1c;
      --good: #166534;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      color: var(--ink);
      background:
        radial-gradient(circle at 10% 10%, #e2f2ff 0%, transparent 28%),
        radial-gradient(circle at 90% 0%, #e9ffe9 0%, transparent 25%),
        var(--bg);
      min-height: 100vh;
      padding: 20px;
    }
    .wrap { max-width: 1500px; margin: 0 auto; }
    .top {
      background: linear-gradient(135deg, #0f766e, #0c4a6e);
      color: #fff;
      border-radius: 18px;
      padding: 22px;
      display: grid;
      gap: 10px;
    }
    .top h1 { margin: 0; font-size: 1.6rem; }
    .top p { margin: 0; color: #cfe9ff; }
    .top-row { display: flex; justify-content: space-between; gap: 12px; flex-wrap: wrap; align-items: center; }
    .top-meta { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .pill {
      background: rgba(255,255,255,.18);
      border: 1px solid rgba(255,255,255,.25);
      color: #fff;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: .86rem;
      font-weight: 700;
    }
    .pill select {
      border: 0;
      background: transparent;
      color: #fff;
      font: inherit;
      min-width: 96px;
      outline: none;
      cursor: pointer;
    }
    .pill select option { color: #0f172a; }
    .btn {
      border: 0;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 700;
    }
    .btn-main { background: #fff; color: #0c4a6e; }
    .btn-soft { background: var(--brand-soft); color: #064e3b; }
    .grid4 { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 12px; margin-top: 14px; }
    .stat {
      background: rgba(255,255,255,.15);
      border: 1px solid rgba(255,255,255,.2);
      border-radius: 12px;
      padding: 12px;
    }
    .stat .n { font-size: 1.5rem; font-weight: 800; }
    .stat .l { font-size: .8rem; color: #dbebff; text-transform: uppercase; letter-spacing: .8px; }

    .layout { display: grid; grid-template-columns: 300px 1fr 340px; gap: 16px; margin-top: 16px; }
    .layout-2 { display: grid; grid-template-columns: 300px 1fr; gap: 16px; margin-top: 16px; }
    .panel {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
    }
    .panel h2 { margin: 0 0 10px; font-size: 1.05rem; }
    .muted { color: var(--muted); font-size: .9rem; }
    .field { margin-bottom: 10px; }
    .field label { display: block; font-size: .82rem; margin-bottom: 6px; color: #334155; font-weight: 700; }
    .field input, .field textarea, .field select {
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      padding: 10px;
      font: inherit;
      background: #fff;
    }
    .field textarea { min-height: 80px; resize: vertical; }
    .result-list { max-height: 480px; overflow: auto; display: grid; gap: 8px; }
    .result-item {
      border: 1px solid #d5deea;
      border-radius: 10px;
      padding: 10px;
      cursor: pointer;
      background: #fff;
    }
    .result-item:hover { border-color: #7aa6c7; }
    .result-item.active { border-color: #0f766e; background: #edfdfa; }
    .k { font-size: .78rem; color: #5b6981; }
    .v { font-weight: 700; }
    .badge { display: inline-block; padding: 4px 8px; border-radius: 999px; font-size: .74rem; font-weight: 700; }
    .badge-warn { background: var(--warn-soft); color: var(--warn); }
    .badge-bad { background: #fee2e2; color: var(--bad); }
    .badge-good { background: #dcfce7; color: var(--good); }
    .info-grid { display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 10px; margin-bottom: 12px; }
    .ibox { border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; background: #f8fafc; }
    .ibox .n { font-size: 1.1rem; font-weight: 800; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; font-size: .86rem; }
    th { background: #f1f5f9; }
    .history-row { cursor: pointer; }
    .history-row:hover { background: #f8fafc; }
    .history-row.selected { background: #edfdfa; border-left: 3px solid var(--brand); }
    .detail-panel { max-height: 600px; overflow-y: auto; }
    .danger { color: var(--bad); font-weight: 700; }
    .ok { color: var(--good); font-weight: 700; }
    #financeBridge { width: 0; height: 0; border: 0; opacity: 0; position: absolute; pointer-events: none; }
    @media (max-width: 1200px) {
      .layout { grid-template-columns: 1fr; }
    }
    @media (max-width: 980px) {
      .grid4 { grid-template-columns: repeat(2, minmax(0,1fr)); }
      .layout, .layout-2 { grid-template-columns: 1fr; }
      .info-grid { grid-template-columns: 1fr; }
      .row { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <iframe id="financeBridge" title="finance-bridge"></iframe>
  <div class="wrap">
    <div class="top">
      <div class="top-row">
        <div>
          <h1>EXTEND PAY PERIOD HUB</h1>
          <p id="hubMeta">Loading context...</p>
        </div>
        <div class="top-meta">
          <div class="pill">School: <span id="schoolNamePill">-</span></div>
          <label class="pill" for="yearSelectHub">Year:
            <select id="yearSelectHub" aria-label="Academic year selector"></select>
          </label>
        </div>
        <div>
          <button class="btn btn-main" id="backBtn">Back to Teacher Dashboard</button>
        </div>
      </div>
      <div class="grid4">
        <div class="stat"><div class="n" id="statTotal">0</div><div class="l">Total Requests</div></div>
        <div class="stat"><div class="n" id="statApproved">0</div><div class="l">Approved</div></div>
        <div class="stat"><div class="n" id="statRejected">0</div><div class="l">Rejected</div></div>
        <div class="stat"><div class="n" id="statBlocked">0</div><div class="l">Reached 5 Times</div></div>
      </div>
    </div>

    <div class="layout">
      <aside class="panel">
        <h2>Search Child</h2>
        <p class="muted">Search by admission number, name, or class.</p>
        <div class="field">
          <input id="searchInput" placeholder="AUTO-..., HAZEL, Class 5">
        </div>
        <div id="searchResultCount" class="muted" style="margin-bottom:8px;">0 matches</div>
        <div class="result-list" id="resultList"></div>
      </aside>

      <section class="panel">
        <h2>Extension History</h2>
        <p class="muted">All payment extension agreements for this year. Click a row to view details.</p>
        <div style="max-height: 520px; overflow: auto;">
          <table>
            <thead>
              <tr>
                <th>Child</th>
                <th>Date</th>
                <th>From</th>
                <th>To</th>
                <th>Status</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <tr><td colspan="6" class="muted">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <aside class="panel detail-panel">
        <h2>Agreement Details</h2>
        <div id="detailPlaceholder" class="muted">Select a child on the left or click a row in Extension History to view agreement details.</div>

        <div id="detailForm" style="display:none;">
          <p class="muted">Create or view extension for selected child.</p>
          <div id="studentInfo" class="muted"></div>

          <div class="info-grid" id="debtCards" style="display:none;">
            <div class="ibox">
              <div class="k">Debt Now</div>
              <div class="n" id="cardDebtAmount">0</div>
            </div>
            <div class="ibox">
              <div class="k">Current Deadline</div>
              <div class="n" id="cardDebtTill">-</div>
            </div>
            <div class="ibox">
              <div class="k">Allowed Extensions (Used)</div>
              <div class="n" id="cardUsed">0 / 5</div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="newDeadline">New agreed deadline</label>
              <input type="date" id="newDeadline">
            </div>
            <div class="field">
              <label for="reasonType">Reason category</label>
              <select id="reasonType">
                <option value="Temporary income delay">Temporary income delay</option>
                <option value="Medical emergency">Medical emergency</option>
                <option value="Family hardship">Family hardship</option>
                <option value="Seasonal business cycle">Seasonal business cycle</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="parentReason">Parent explanation</label>
            <textarea id="parentReason" placeholder="What did the parent explain?"></textarea>
          </div>
          <div class="field">
            <label for="headteacherReason">Headteacher decision notes</label>
            <textarea id="headteacherReason" placeholder="Why are you granting more time?"></textarea>
          </div>

          <div class="row">
            <div class="field">
              <label for="managementConsulted">Management consulted?</label>
              <select id="managementConsulted">
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
            <div class="field">
              <label for="parentName">Parent/Guardian name</label>
              <input id="parentName" placeholder="Full name">
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-soft" id="saveExtensionBtn">Approve and Save Extension</button>
            <button class="btn" id="downloadAgreementBtn">Download Agreement PDF</button>
            <span id="saveStatus" class="muted"></span>
          </div>
        </div>

        <div id="detailView" style="display:none;">
          <div id="detailContent"></div>
          <div class="actions" style="margin-top:12px;">
            <button class="btn" id="downloadHistoryPdfBtn">Download Agreement PDF</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <script>
  (() => {
    const MAX_EXTENSIONS_PER_YEAR = 5;
    const today = new Date();
    const pad2 = (n) => String(n).padStart(2, '0');
    const ymd = (d) => `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    const fmtDate = (ts) => {
      const n = Number(ts || 0);
      if (!(n > 0)) return '-';
      return new Date(n).toLocaleDateString('en-US', { timeZone: 'Africa/Nairobi' });
    };
    const fmtNum = (n) => Number(n || 0).toLocaleString();

    let db = null;
    let school = null;
    let year = String(window.somapYearContext?.getSelectedYear?.() || new Date().getFullYear());
    let students = {};
    let extensionsByStudent = {};
    let selected = null;
    let selectedSummary = null;
    let selectedHistoryRecord = null;
    let financeBridgeReady = false;
    let selectedWorkerId = String(localStorage.getItem('workerId') || sessionStorage.getItem('workerId') || '').trim();

    const hubMeta = document.getElementById('hubMeta');
    const schoolNamePill = document.getElementById('schoolNamePill');
    const yearSelectHub = document.getElementById('yearSelectHub');
    const resultList = document.getElementById('resultList');
    const searchInput = document.getElementById('searchInput');
    const searchResultCount = document.getElementById('searchResultCount');
    const studentInfo = document.getElementById('studentInfo');
    const debtCards = document.getElementById('debtCards');
    const cardDebtAmount = document.getElementById('cardDebtAmount');
    const cardDebtTill = document.getElementById('cardDebtTill');
    const cardUsed = document.getElementById('cardUsed');
    const newDeadline = document.getElementById('newDeadline');
    const reasonType = document.getElementById('reasonType');
    const parentReason = document.getElementById('parentReason');
    const headteacherReason = document.getElementById('headteacherReason');
    const managementConsulted = document.getElementById('managementConsulted');
    const parentName = document.getElementById('parentName');
    const saveStatus = document.getElementById('saveStatus');
    const historyBody = document.getElementById('historyBody');
    const detailPlaceholder = document.getElementById('detailPlaceholder');
    const detailForm = document.getElementById('detailForm');
    const detailView = document.getElementById('detailView');
    const detailContent = document.getElementById('detailContent');

    const schoolRef = (path) => db.ref(SOMAP.P(path));

    function getChildName(row) {
      const name = String(row.fullName || '').trim();
      if (name) return name;
      const sid = String(row.studentId || '').trim();
      const adm = String(row.admissionNumber || '').trim();
      const student = students[sid] || (adm ? Object.values(students).find((s) => String(s?.admissionNumber || '').trim() === adm) : null);
      if (student) return getFullName(student);
      return adm || sid || 'Unknown';
    }

    function getFullName(student) {
      return `${student.firstName || ''} ${student.middleName || ''} ${student.lastName || ''}`.replace(/\s+/g, ' ').trim() || 'Unknown';
    }

    function admissionOf(student, id) {
      return String(student.admissionNumber || student.admissionNo || id || '').trim();
    }

    function toEndOfDayTsFromYmd(rawYmd) {
      if (!rawYmd) return 0;
      const d = new Date(`${rawYmd}T23:59:59.999`);
      return Number.isFinite(d.getTime()) ? d.getTime() : 0;
    }

    function flattenExtensions(source) {
      const out = [];
      Object.entries(source || {}).forEach(([studentId, rows]) => {
        Object.entries(rows || {}).forEach(([id, row]) => {
          out.push({ id, studentId, ...(row || {}) });
        });
      });
      return out;
    }

    function approvedCountForStudent(studentId, admission) {
      const bucketA = extensionsByStudent[studentId] || {};
      const bucketB = admission ? (extensionsByStudent[admission] || {}) : {};
      const all = [...Object.values(bucketA), ...Object.values(bucketB)];
      return all.filter((row) => String(row.status || 'approved').toLowerCase() === 'approved').length;
    }

    function getStudentHistory(studentId, admission) {
      const bucketA = extensionsByStudent[studentId] || {};
      const bucketB = admission ? (extensionsByStudent[admission] || {}) : {};
      return [...Object.entries(bucketA), ...Object.entries(bucketB)]
        .map(([id, row]) => ({ id, ...(row || {}) }))
        .sort((a, b) => Number(b.createdAt || b.approvedAt || 0) - Number(a.createdAt || a.approvedAt || 0));
    }

    function renderAllHistory() {
      const flat = flattenExtensions(extensionsByStudent)
        .sort((a, b) => Number(b.createdAt || b.approvedAt || 0) - Number(a.createdAt || a.approvedAt || 0));
      if (!flat.length) {
        historyBody.innerHTML = '<tr><td colspan="6" class="muted">No extension agreements yet for this year.</td></tr>';
        return;
      }
      historyBody.innerHTML = flat.map((row, idx) => {
        const status = String(row.status || 'approved');
        const statusClass = status.toLowerCase() === 'approved' ? 'ok' : (status.toLowerCase() === 'rejected' ? 'danger' : '');
        const childName = getChildName(row);
        const isSelected = selectedHistoryRecord && selectedHistoryRecord.id === row.id && String(selectedHistoryRecord.studentId || '') === String(row.studentId || '');
        return `<tr class="history-row ${isSelected ? 'selected' : ''}" data-idx="${idx}" data-row-id="${row.id}" data-student-id="${row.studentId || ''}">
          <td><strong>${String(childName).slice(0, 40)}</strong></td>
          <td>${fmtDate(row.createdAt || row.approvedAt)}</td>
          <td>${fmtDate(row.oldDeadlineTs)}</td>
          <td>${fmtDate(row.newDeadlineTs)}</td>
          <td class="${statusClass}">${status}</td>
          <td>${String(row.headteacherReason || row.parentReason || '-').slice(0, 80)}</td>
        </tr>`;
      }).join('');
      historyBody.querySelectorAll('.history-row').forEach((el) => {
        el.addEventListener('click', () => {
          const idx = parseInt(el.getAttribute('data-idx'), 10);
          const flat = flattenExtensions(extensionsByStudent)
            .sort((a, b) => Number(b.createdAt || b.approvedAt || 0) - Number(a.createdAt || a.approvedAt || 0));
          const row = flat[idx];
          if (row) {
            selectedHistoryRecord = row;
            selected = null;
            selectedSummary = null;
            showDetailView(row);
            renderAllHistory();
            renderSearchResults();
          }
        });
      });
    }

    function showDetailPlaceholder() {
      detailPlaceholder.style.display = 'block';
      detailForm.style.display = 'none';
      detailView.style.display = 'none';
      selectedHistoryRecord = null;
    }

    function showDetailForm() {
      detailPlaceholder.style.display = 'none';
      detailView.style.display = 'none';
      detailForm.style.display = 'block';
    }

    function showDetailView(row) {
      detailPlaceholder.style.display = 'none';
      detailForm.style.display = 'none';
      detailView.style.display = 'block';
      const childName = getChildName(row);
      detailContent.innerHTML = `
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Child</div><div class="n">${childName}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Admission No</div><div class="n">${row.admissionNumber || row.studentId || '-'}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Class</div><div class="n">${row.classLevel || '-'}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Debt Amount</div><div class="n">${fmtNum(row.debtAmount || 0)}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Old Deadline</div><div class="n">${fmtDate(row.oldDeadlineTs)}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">New Deadline</div><div class="n">${fmtDate(row.newDeadlineTs)}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Reason Type</div><div class="n">${row.reasonType || '-'}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Parent Explanation</div><div class="n">${String(row.parentReason || '-').replace(/\n/g, '<br>')}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Headteacher Notes</div><div class="n">${String(row.headteacherReason || '-').replace(/\n/g, '<br>')}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Management Consulted</div><div class="n">${row.managementConsulted || '-'}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Parent/Guardian Name</div><div class="n">${row.parentName || '-'}</div></div>
        <div class="ibox" style="margin-bottom:10px;"><div class="k">Status</div><div class="n">${row.status || 'approved'}</div></div>
      `;
    }

    function computeStats() {
      const flat = flattenExtensions(extensionsByStudent);
      const approved = flat.filter((r) => String(r.status || '').toLowerCase() === 'approved').length;
      const rejected = flat.filter((r) => String(r.status || '').toLowerCase() === 'rejected').length;
      const grouped = {};
      flat.forEach((row) => {
        const key = String(row.studentId || row.studentKey || row.admissionNumber || '').trim();
        if (!key) return;
        if (!grouped[key]) grouped[key] = 0;
        if (String(row.status || '').toLowerCase() === 'approved') grouped[key] += 1;
      });
      const blocked = Object.values(grouped).filter((n) => Number(n) >= MAX_EXTENSIONS_PER_YEAR).length;
      document.getElementById('statTotal').textContent = String(flat.length);
      document.getElementById('statApproved').textContent = String(approved);
      document.getElementById('statRejected').textContent = String(rejected);
      document.getElementById('statBlocked').textContent = String(blocked);
    }

    async function ensureFinanceBridge() {
      const frame = document.getElementById('financeBridge');
      const targetSrc = `../finance.html?year=${encodeURIComponent(year)}&bridge=1`;
      if (!frame.src || !frame.src.includes(`year=${encodeURIComponent(year)}`)) {
        frame.src = targetSrc;
        financeBridgeReady = false;
      }
      for (let i = 0; i < 60; i++) {
        try {
          const fn = frame.contentWindow && frame.contentWindow.__finance_getStudentFinanceSummary;
          if (typeof fn === 'function') {
            financeBridgeReady = true;
            return frame.contentWindow;
          }
        } catch (_) {}
        await new Promise((r) => setTimeout(r, 300));
      }
      throw new Error('Finance bridge not ready.');
    }

    async function fetchFinanceSummary(studentIdOrAdm) {
      const win = await ensureFinanceBridge();
      const summary = await win.__finance_getStudentFinanceSummary(year, studentIdOrAdm);
      return summary || null;
    }

    function populateYearSelector() {
      const YEARS = [];
      for (let y = 2024; y <= 2042; y += 1) YEARS.push(y);
      yearSelectHub.innerHTML = YEARS
        .map((y) => `<option value="${y}">${y}</option>`)
        .join('');
      if (YEARS.includes(Number(year))) {
        yearSelectHub.value = String(year);
      } else {
        const custom = Number(year);
        if (Number.isFinite(custom) && custom >= 2000 && custom <= 2100) {
          const opt = document.createElement('option');
          opt.value = String(custom);
          opt.textContent = String(custom);
          yearSelectHub.appendChild(opt);
          yearSelectHub.value = String(custom);
        } else {
          yearSelectHub.value = String(YEARS[YEARS.length - 1]);
          year = yearSelectHub.value;
        }
      }
    }

    async function loadStudents() {
      const win = await ensureFinanceBridge();
      let rows = [];
      try {
        rows = await win.__finance_getStudentsForYear?.(year);
      } catch (_) {}
      if (!Array.isArray(rows) || !rows.length) {
        // Finance bridge can still be warming up; retry briefly.
        for (let i = 0; i < 6; i += 1) {
          await new Promise((r) => setTimeout(r, 300));
          try {
            rows = await win.__finance_getStudentsForYear?.(year);
          } catch (_) {}
          if (Array.isArray(rows) && rows.length) break;
        }
      }
      if (!Array.isArray(rows)) rows = [];
      rows = rows.filter((row) => {
        const cls = String(row?.classLevel || '').trim().toUpperCase();
        return cls !== 'GRADUATED';
      });
      students = {};
      rows.forEach((row) => {
        const id = String(row?.id || '').trim();
        if (!id) return;
        students[id] = {
          firstName: '',
          middleName: '',
          lastName: '',
          classLevel: row.classLevel || '',
          admissionNumber: row.admissionNumber || id,
          _fullName: row.fullName || '',
        };
      });
    }

    async function loadExtensions() {
      const snap = await schoolRef(`financeDeadlineExtensions/${year}`).once('value');
      extensionsByStudent = snap.val() || {};
      computeStats();
      renderAllHistory();
    }

    function filterStudents(q) {
      const needle = String(q || '').trim().toLowerCase();
      const rows = Object.entries(students || {}).map(([id, student]) => ({
        id,
        student,
        fullName: String(student._fullName || getFullName(student)).trim(),
        admission: admissionOf(student, id),
        cls: String(student.classLevel || student.className || '').trim(),
      }));
      if (!needle) return rows.slice(0, 120);
      return rows.filter((row) => {
        const hay = `${row.id} ${row.fullName} ${row.admission} ${row.cls}`.toLowerCase();
        return hay.includes(needle);
      }).slice(0, 120);
    }

    function renderSearchResults() {
      const rows = filterStudents(searchInput.value);
      searchResultCount.textContent = `${rows.length} matches`;
      if (!rows.length) {
        resultList.innerHTML = '<div class="muted">No match found.</div>';
        return;
      }
      resultList.innerHTML = rows.map((row) => {
        const active = selected && selected.id === row.id ? 'active' : '';
        return `<div class="result-item ${active}" data-id="${row.id}">
          <div class="v">${row.fullName}</div>
          <div class="k">${row.admission} | ${row.cls || '-'}</div>
        </div>`;
      }).join('');
      resultList.querySelectorAll('.result-item').forEach((el) => {
        el.addEventListener('click', async () => {
          const id = el.getAttribute('data-id');
          const student = students[id] || {};
          selected = { id, student, admission: admissionOf(student, id), fullName: getFullName(student) };
          selectedHistoryRecord = null;
          await refreshSelectedStudent();
          renderSearchResults();
        });
      });
    }

    function maxAllowedDeadlineTs(summary) {
      const nextStart = Number(summary?.nextInstallmentStartTs || 0);
      if (nextStart > 0) return nextStart - 1;
      const yr = Number(year);
      if (Number.isFinite(yr)) return new Date(yr, 11, 31, 23, 59, 59, 999).getTime();
      return new Date(today.getFullYear(), 11, 31, 23, 59, 59, 999).getTime();
    }

    async function refreshSelectedStudent() {
      if (!selected) return;
      selectedSummary = await fetchFinanceSummary(selected.id) || await fetchFinanceSummary(selected.admission);
      const debt = Number(selectedSummary?.periodDebtValue || 0);
      const debtTill = selectedSummary?.periodDebtLabel || '-';
      const used = approvedCountForStudent(selected.id, selected.admission);
      const blocked = used >= MAX_EXTENSIONS_PER_YEAR;
      studentInfo.innerHTML = `
        <div><strong>${selected.fullName}</strong> (${selected.admission || selected.id})</div>
        <div class="muted">Class: ${selectedSummary?.classLevel || selected.student.classLevel || '-'}</div>
        ${blocked ? '<div class="badge badge-bad" style="margin-top:6px;">Limit reached: 5 approved extensions this year</div>' : '<div class="badge badge-good" style="margin-top:6px;">Eligible for extension</div>'}
      `;
      debtCards.style.display = 'grid';
      cardDebtAmount.textContent = fmtNum(debt);
      cardDebtTill.textContent = debtTill;
      cardUsed.textContent = `${used} / ${MAX_EXTENSIONS_PER_YEAR}`;

      showDetailForm();
      renderAllHistory();

      const minTs = new Date().setHours(0, 0, 0, 0);
      const maxTs = maxAllowedDeadlineTs(selectedSummary);
      const suggested = Math.min(maxTs, new Date().setDate(new Date().getDate() + 3));
      newDeadline.min = ymd(new Date(minTs));
      newDeadline.max = ymd(new Date(maxTs));
      newDeadline.value = ymd(new Date(Math.max(minTs, suggested)));
      saveStatus.textContent = '';
    }

    function buildAgreementPayload() {
      if (!selected || !selectedSummary) throw new Error('Select a child first.');
      const debt = Number(selectedSummary?.periodDebtValue || 0);
      if (!(debt > 0)) throw new Error('This child currently has no debt due for collection.');
      const used = approvedCountForStudent(selected.id, selected.admission);
      if (used >= MAX_EXTENSIONS_PER_YEAR) {
        throw new Error('This parent has already reached 5 approved extensions this year.');
      }
      const oldDeadlineTs = Number(selectedSummary?.originalOverdueThroughTs || selectedSummary?.overdueThroughTs || 0);
      if (!(oldDeadlineTs > 0)) {
        throw new Error('No overdue deadline found for this debt.');
      }
      const newDeadlineTs = toEndOfDayTsFromYmd(newDeadline.value);
      if (!(newDeadlineTs > 0)) throw new Error('Set a valid new deadline.');
      const nowStart = new Date().setHours(0, 0, 0, 0);
      if (newDeadlineTs < nowStart) throw new Error('New deadline cannot be in the past.');
      const maxTs = maxAllowedDeadlineTs(selectedSummary);
      if (newDeadlineTs > maxTs) {
        throw new Error(`New deadline cannot pass ${fmtDate(maxTs)} because the next installment starts after that.`);
      }
      if (!String(parentReason.value || '').trim()) throw new Error('Parent explanation is required.');
      if (!String(headteacherReason.value || '').trim()) throw new Error('Headteacher decision notes are required.');

      return {
        studentId: selected.id,
        admissionNumber: selected.admission,
        fullName: selected.fullName,
        classLevel: selectedSummary?.classLevel || selected.student.classLevel || '',
        year,
        debtAmount: debt,
        oldDeadlineTs,
        newDeadlineTs,
        sourceOverdueTs: oldDeadlineTs,
        nextInstallmentStartTs: Number(selectedSummary?.nextInstallmentStartTs || 0),
        reasonType: reasonType.value,
        parentReason: parentReason.value.trim(),
        headteacherReason: headteacherReason.value.trim(),
        managementConsulted: managementConsulted.value,
        parentName: parentName.value.trim(),
        requestedBy: 'Parent/Guardian',
        status: 'approved',
        approvedByWorkerId: selectedWorkerId || 'headteacher',
        approvedAt: firebase.database.ServerValue.TIMESTAMP,
        createdAt: firebase.database.ServerValue.TIMESTAMP,
      };
    }

    async function saveExtension() {
      saveStatus.textContent = '';
      try {
        const payload = buildAgreementPayload();
        await schoolRef(`financeDeadlineExtensions/${year}/${selected.id}`).push(payload);
        saveStatus.textContent = 'Saved. Finance overdue date will update for this child.';
        saveStatus.className = 'ok';
        await loadExtensions();
        await refreshSelectedStudent();
      } catch (err) {
        saveStatus.textContent = err.message || String(err);
        saveStatus.className = 'danger';
      }
    }

    function downloadAgreementPdf() {
      try {
        const payload = buildAgreementPayload();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const schoolName = school?.name || school?.id || 'School';
        doc.setFontSize(14);
        doc.text(`${schoolName} - School Fee Extension Agreement`, 14, 14);
        doc.setFontSize(10);
        doc.text(`Academic Year: ${year}`, 14, 21);
        doc.text(`Generated: ${new Date().toLocaleString('en-US', { timeZone: 'Africa/Nairobi' })}`, 14, 27);

        const body = [
          ['Admission No', payload.admissionNumber],
          ['Child Name', payload.fullName],
          ['Class', payload.classLevel || '-'],
          ['Debt Amount', fmtNum(payload.debtAmount)],
          ['Old Deadline', fmtDate(payload.oldDeadlineTs)],
          ['New Deadline', fmtDate(payload.newDeadlineTs)],
          ['Reason Type', payload.reasonType],
          ['Parent Explanation', payload.parentReason],
          ['Headteacher Notes', payload.headteacherReason],
          ['Management Consulted', payload.managementConsulted],
          ['Parent/Guardian Name', payload.parentName || '-'],
        ];
        doc.autoTable({
          startY: 33,
          head: [['Field', 'Detail']],
          body,
          styles: { fontSize: 9, cellPadding: 2.5 },
          headStyles: { fillColor: [15, 118, 110] }
        });
        const endY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 12 : 180;
        doc.text('Signatures', 14, endY);
        doc.text('Parent/Guardian: _____________________', 14, endY + 10);
        doc.text('Headteacher: _________________________', 14, endY + 18);
        doc.text('Date: ________________________________', 14, endY + 26);

        const safeAdm = String(payload.admissionNumber || payload.studentId || 'student').replace(/[^a-zA-Z0-9_-]+/g, '_');
        doc.save(`fee_extension_${safeAdm}_${year}.pdf`);
      } catch (err) {
        alert(err.message || String(err));
      }
    }

    function downloadHistoryPdf() {
      if (!selectedHistoryRecord) {
        alert('Select an agreement from Extension History first.');
        return;
      }
      try {
        const row = selectedHistoryRecord;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const schoolName = school?.name || school?.id || 'School';
        const childName = getChildName(row);
        doc.setFontSize(14);
        doc.text(`${schoolName} - School Fee Extension Agreement`, 14, 14);
        doc.setFontSize(10);
        doc.text(`Academic Year: ${year}`, 14, 21);
        doc.text(`Generated: ${new Date().toLocaleString('en-US', { timeZone: 'Africa/Nairobi' })}`, 14, 27);

        const body = [
          ['Admission No', row.admissionNumber || row.studentId || '-'],
          ['Child Name', childName],
          ['Class', row.classLevel || '-'],
          ['Debt Amount', fmtNum(row.debtAmount || 0)],
          ['Old Deadline', fmtDate(row.oldDeadlineTs)],
          ['New Deadline', fmtDate(row.newDeadlineTs)],
          ['Reason Type', row.reasonType || '-'],
          ['Parent Explanation', row.parentReason || '-'],
          ['Headteacher Notes', row.headteacherReason || '-'],
          ['Management Consulted', row.managementConsulted || '-'],
          ['Parent/Guardian Name', row.parentName || '-'],
          ['Status', row.status || 'approved'],
        ];
        doc.autoTable({
          startY: 33,
          head: [['Field', 'Detail']],
          body,
          styles: { fontSize: 9, cellPadding: 2.5 },
          headStyles: { fillColor: [15, 118, 110] }
        });
        const endY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 12 : 180;
        doc.text('Signatures', 14, endY);
        doc.text('Parent/Guardian: _____________________', 14, endY + 10);
        doc.text('Headteacher: _________________________', 14, endY + 18);
        doc.text('Date: ________________________________', 14, endY + 26);

        const safeAdm = String(row.admissionNumber || row.studentId || 'student').replace(/[^a-zA-Z0-9_-]+/g, '_');
        doc.save(`fee_extension_${safeAdm}_${year}.pdf`);
      } catch (err) {
        alert(err.message || String(err));
      }
    }

    async function init() {
      if (!window.firebase || !firebase.apps?.length) {
        alert('Firebase is not ready.');
        return;
      }
      if (!window.SOMAP || typeof SOMAP.getSchool !== 'function') {
        alert('School context missing.');
        return;
      }
      db = firebase.database();
      school = SOMAP.getSchool();
      if (!school || !school.id) {
        window.location.href = '../somapappv1multischool/multischool.html';
        return;
      }
      const role = String(localStorage.getItem('somap_role') || '').trim().toLowerCase();
      if (role && role !== 'head teacher') {
        alert('This page is for Head Teacher only.');
        window.location.href = 'workertasks.html';
        return;
      }
      schoolNamePill.textContent = school.name || school.id || 'School';
      populateYearSelector();
      hubMeta.textContent = `${school.name || school.id} | Academic Year ${year}`;

      try {
        await Promise.all([loadStudents(), loadExtensions(), ensureFinanceBridge()]);
      } catch (err) {
        console.warn(err);
      }
      showDetailPlaceholder();
      renderAllHistory();
      renderSearchResults();

      searchInput.addEventListener('input', renderSearchResults);
      document.getElementById('saveExtensionBtn').addEventListener('click', saveExtension);
      document.getElementById('downloadAgreementBtn').addEventListener('click', downloadAgreementPdf);
      document.getElementById('downloadHistoryPdfBtn').addEventListener('click', downloadHistoryPdf);
      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = 'workertasks.html';
      });
      yearSelectHub.addEventListener('change', async (e) => {
        const nextYear = String(e.target.value || '').trim();
        if (!nextYear || nextYear === year) return;
        year = nextYear;
        hubMeta.textContent = `${school.name || school.id} | Academic Year ${year}`;
        selected = null;
        selectedSummary = null;
        selectedHistoryRecord = null;
        students = {};
        showDetailPlaceholder();
        debtCards.style.display = 'none';
        try {
          await Promise.all([loadStudents(), loadExtensions(), ensureFinanceBridge()]);
        } catch (err) {
          console.warn(err);
        }
        renderAllHistory();
        renderSearchResults();
      });

      if (window.somapYearContext?.onYearChanged) {
        window.somapYearContext.onYearChanged(async (next) => {
          const normalized = String(next || '').trim();
          if (!normalized || normalized === year) return;
          year = normalized;
          if (yearSelectHub && yearSelectHub.value !== normalized) {
            const exists = Array.from(yearSelectHub.options || []).some((opt) => String(opt.value) === normalized);
            if (exists) yearSelectHub.value = normalized;
          }
          hubMeta.textContent = `${school.name || school.id} | Academic Year ${year}`;
          selected = null;
          selectedSummary = null;
          selectedHistoryRecord = null;
          students = {};
          showDetailPlaceholder();
          debtCards.style.display = 'none';
          await Promise.all([loadStudents(), loadExtensions(), ensureFinanceBridge()]);
          renderAllHistory();
          renderSearchResults();
        });
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
