<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Likizo na Ruhusa</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>
  <script src="../firebase/firebase-config.js"></script>
</head>
<body>
  <main>
    <header>
      <h1>Likizo | Leave Requests</h1>
      <p class="workers-card__subtitle">
        Kikomo cha siku 90: Sick max 3 bila ushahidi, General max 3 bila maelezo ya kutosha. Ukiomba zaidi bila proof utakataliwa.
      </p>
    </header>

    <section class="workers-card">
      <header class="workers-card__header">
        <h2>Omba Likizo Mpya</h2>
      </header>
      <div class="workers-card__content workers-form">
        <label>Aina ya Likizo
          <select id="leaveType">
            <option value="sick">Sick | Ugonjwa</option>
            <option value="general">General | Sababu binafsi</option>
            <option value="annual">Annual | Mwaka</option>
            <option value="maternity">Maternity</option>
            <option value="paternity">Paternity</option>
            <option value="official">Official | Kazi ya shule</option>
          </select>
        </label>
        <label>Kwanini / Reason
          <textarea id="leaveReason" placeholder="Eleza sababu kwa ufupi"></textarea>
        </label>
        <label>Kuanzia (YYYY-MM-DD)
          <input type="date" id="startDate" required>
        </label>
        <label>Mpaka (YYYY-MM-DD)
          <input type="date" id="endDate" required>
        </label>
        <label>Ushahidi (PDF au picha, hiari)
          <input type="file" id="leaveProof" accept=".pdf,image/*">
        </label>
        <button id="submitLeave" class="workers-btn">Tuma Ombi</button>
      </div>
    </section>

    <section class="workers-card" style="margin-top:24px;">
      <header class="workers-card__header">
        <h2>Maombi Yangu</h2>
      </header>
      <div class="workers-card__content">
        <ul id="myLeaves"></ul>
      </div>
    </section>

    <section class="workers-card" id="adminPanel" style="display:none; margin-top:24px;">
      <header class="workers-card__header">
        <h2>Admin - Maombi Yanayosubiri</h2>
      </header>
      <div class="workers-card__content">
        <ul id="pendingLeaves"></ul>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      ensureAnonymousAuth,
      getLinkedWorkerId,
      dbRefs,
      localTs,
      toast
    } from '../modules/workers_helpers.js';
    import { uploadFileToStorage } from '../modules/workers_ui.js';

    const db = firebase.database();
    const school = SOMAP.getSchool();
    if (!school || !school.id) {
      window.location.href = '../somapappv1multischool/multischool.html';
    }
    const schoolRef = (p) => db.ref(SOMAP.P(p));
    const getYear = () => window.somapYearContext?.getSelectedYear?.() || new Date().getFullYear();
    let currentYear = getYear();
    const getRefs = () => dbRefs(db);

    const leaveTypeEl = document.getElementById('leaveType');
    const leaveReasonEl = document.getElementById('leaveReason');
    const startDateEl = document.getElementById('startDate');
    const endDateEl = document.getElementById('endDate');
    const leaveProofEl = document.getElementById('leaveProof');
    const submitBtn = document.getElementById('submitLeave');
    const myLeavesList = document.getElementById('myLeaves');
    const pendingLeavesList = document.getElementById('pendingLeaves');
    const adminPanel = document.getElementById('adminPanel');

    let workerId = null;
    let workerProfile = null;
    let settings = null;
    let isAdmin = false;

    ensureAnonymousAuth()
      .then(init)
      .catch(err => {
        toast(err.message || 'Error', 'error');
        window.location.href = '../index.html';
      });

    async function init() {
      workerId = await getLinkedWorkerId();
      if (!workerId) {
        toast('Ingia tena.', 'error');
        window.location.href = '../index.html';
        return;
      }
      const authUid = firebase.auth().currentUser.uid;

      const [profileSnap, settingsSnap, adminSnap] = await Promise.all([
        getRefs().worker(workerId).once('value'),
        getRefs().settings().once('value'),
        firebase.database().ref(`admins/${authUid}`).once('value')
      ]);
      workerProfile = profileSnap.val().profile;
      settings = settingsSnap.val() || {};
      isAdmin = adminSnap.exists() && adminSnap.val() === true;
      if (!isAdmin && ['manager', 'hr'].includes(workerProfile.role)) {
        isAdmin = true;
      }

      startDateEl.valueAsDate = new Date();
      endDateEl.valueAsDate = new Date();

      submitBtn.addEventListener('click', submitLeave);
      loadMyLeaves();
      if (isAdmin) {
        adminPanel.style.display = 'block';
        loadPendingLeaves();
      }
    }

    async function submitLeave() {
      const type = leaveTypeEl.value;
      const reason = leaveReasonEl.value.trim();
      const startYmd = startDateEl.value;
      const endYmd = endDateEl.value;
      if (!startYmd || !endYmd) {
        toast('Weka tarehe mwanzo na mwisho.', 'warning');
        return;
      }
      if (endYmd < startYmd) {
        toast('Mpaka lazima uwe baada ya mwanzo.', 'warning');
        return;
      }

      const proofFile = leaveProofEl.files[0];
      const recentLeaves = await fetchRecentLeaves(type);
      const sickLimit = settings.leave?.sickLimit90d ?? 3;
      const generalLimit = settings.leave?.generalLimit90d ?? 3;
      let status = 'pending';
      let reviewNote = '';

      if (type === 'sick' && recentLeaves >= sickLimit && !proofFile) {
        status = 'rejected';
        reviewNote = 'Imeathiriwa: ugonjwa zaidi ya kikomo cha siku 90 bila ushahidi.';
      }
      if (type === 'general' && recentLeaves >= generalLimit && reason.length < 8) {
        status = 'rejected';
        reviewNote = 'Imeathiriwa: sababu haijitoshelezi baada ya kikomo cha siku 90.';
      }

      const ref = getRefs().leaveRequests(workerId).push();
      let proofUrl = '';
      if (proofFile) {
        proofUrl = await uploadFileToStorage(proofFile, `leave/${workerId}/${ref.key}.${getExtension(proofFile)}`);
      }
      await ref.set({
        type,
        reason,
        startYmd,
        endYmd,
        createdTs: localTs(),
        status,
        proofUrl,
        reviewNote
      });

      toast(status === 'pending' ? 'Ombi limetumwa. Subiri uamuzi.' : reviewNote, status === 'pending' ? 'success' : 'warning');
      leaveReasonEl.value = '';
      leaveProofEl.value = '';
      loadMyLeaves();
      if (isAdmin) loadPendingLeaves();
    }

    async function fetchRecentLeaves(type) {
      const snap = await getRefs().leaveRequests(workerId).orderByChild('createdTs').once('value');
      if (!snap.exists()) return 0;
      const now = Date.now();
      const ninetyDaysMs = 90 * 24 * 60 * 60 * 1000;
      let count = 0;
      snap.forEach(child => {
        const value = child.val();
        if (value.type === type && now - value.createdTs <= ninetyDaysMs) {
          count += 1;
        }
      });
      return count;
    }

    async function loadMyLeaves() {
      myLeavesList.innerHTML = '';
      const snap = await getRefs().leaveRequests(workerId).orderByChild('createdTs').once('value');
      if (!snap.exists()) {
        myLeavesList.innerHTML = '<li>Hakuna maombi. Karibu kuanza.</li>';
        return;
      }
      snap.forEach(child => {
        const req = child.val();
        const li = document.createElement('li');
        li.className = 'workers-fieldset';
        li.innerHTML = `
          <strong>${req.type.toUpperCase()} - ${req.status.toUpperCase()}</strong>
          <p>${req.startYmd} -> ${req.endYmd}</p>
          <p>${req.reason || 'Hakuna maelezo'}</p>
          ${req.reviewNote ? `<p>Maelezo: ${req.reviewNote}</p>` : ''}
          ${req.proofUrl ? `<a class="workers-btn secondary" href="${req.proofUrl}" target="_blank">Ona Ushahidi</a>` : ''}
        `;
        myLeavesList.appendChild(li);
      });
    }

    async function loadPendingLeaves() {
      pendingLeavesList.innerHTML = '';
      const snap = await firebase.database().ref('leave_requests').once('value');
      const workersSnap = await firebase.database().ref('workers').once('value');
      const workers = workersSnap.val() || {};
      const leaves = snap.val() || {};

      Object.entries(leaves).forEach(([wId, requests]) => {
        Object.entries(requests).forEach(([reqId, req]) => {
          if (req.status !== 'pending') return;
          const profile = workers[wId]?.profile || {};
          const li = document.createElement('li');
          li.className = 'workers-fieldset';
          li.innerHTML = `
            <strong>${profile.fullNameUpper || wId}</strong>
            <p>${req.type.toUpperCase()} - ${req.startYmd} -> ${req.endYmd}</p>
            <p>${req.reason || 'Hakuna sababu iliyoandikwa'}</p>
            ${req.proofUrl ? `<a class="workers-btn secondary" href="${req.proofUrl}" target="_blank">Ushahidi</a>` : ''}
          `;
          const approveBtn = document.createElement('button');
          approveBtn.className = 'workers-btn';
          approveBtn.textContent = 'Kubali';
          approveBtn.addEventListener('click', () => updateLeave(wId, reqId, 'approved'));

          const rejectBtn = document.createElement('button');
          rejectBtn.className = 'workers-btn danger';
          rejectBtn.textContent = 'Kataa';
          rejectBtn.addEventListener('click', () => {
            const note = prompt('Sababu ya kukataa?');
            updateLeave(wId, reqId, 'rejected', note || '');
          });

          li.appendChild(approveBtn);
          li.appendChild(rejectBtn);
          pendingLeavesList.appendChild(li);
        });
      });

      if (!pendingLeavesList.children.length) {
        pendingLeavesList.innerHTML = '<li>Hakuna maombi yanayosubiri.</li>';
      }
    }

    async function updateLeave(worker, requestId, status, note = '') {
      await getRefs().leaveRequest(worker, requestId).update({
        status,
        reviewNote: note,
        reviewedTs: localTs(),
        reviewerUid: firebase.auth().currentUser.uid
      });
      toast(`Ombi limewekwa ${status}`, status === 'approved' ? 'success' : 'warning');
      loadMyLeaves();
      loadPendingLeaves();
    }

    function getExtension(file) {
      const name = file.name || '';
      const ext = name.split('.').pop();
      if (ext) return ext;
      if (file.type === 'application/pdf') return 'pdf';
      if (file.type.startsWith('image/')) return file.type.split('/')[1];
      return 'dat';
    }
  </script>
</body>
</html>
