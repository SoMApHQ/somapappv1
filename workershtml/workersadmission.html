<!DOCTYPE html>
<html lang="sw">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kuajiri Wafanyakazi | SoMAp</title>
  <link rel="stylesheet" href="../css/workers.css"/>

  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    .workers-table{width:100%;border-collapse:collapse}
    .workers-table th,.workers-table td{border:1px solid #ddd;padding:.5rem;font-size:.95rem}
    .workers-table th{background:#fafafa;text-align:left}
    .workers-card{border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin:8px 0;background:#fff}
    .workers-card__header h2{margin:0 0 4px 0}
    .workers-card__subtitle{color:#6b7280;margin:.25rem 0 0 0}
    .workers-card__actions{display:flex;gap:.5rem;margin-top:12px}
    .workers-btn{padding:.6rem 1rem;border:0;border-radius:10px;background:#111827;color:#fff;cursor:pointer}
    .workers-btn.secondary{background:#6b7280}
    .workers-form{display:grid;gap:16px}
    .workers-fieldset{display:grid;gap:8px;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
    .workers-flex{display:grid;gap:12px}
    label{display:grid;gap:6px}
    input,select,textarea{padding:.6rem;border:1px solid #d1d5db;border-radius:10px}
    .workers-section-count{margin:0 0 .5rem;color:#1f2937;font-weight:600}
    .workers-table td.photo-cell{width:72px;text-align:center;vertical-align:middle}
    .workers-table__photo{width:60px;height:60px;border-radius:12px;object-fit:cover;border:1px solid #e5e7eb}
    .workers-table__photo-placeholder{width:60px;height:60px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;border:1px dashed #9ca3af;color:#6b7280;font-size:.65rem}
    .workers-table td.actions-cell{display:flex;gap:.35rem;flex-wrap:wrap;align-items:center}
    .workers-table td.actions-cell button{font-size:.75rem;padding:.4rem .65rem;border-radius:8px}
    .workers-form-status{margin-top:10px;font-weight:600;color:#047857;min-height:1.2rem}
    .workers-form-status.error{color:#b91c1c}
    .school-header{display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap;margin-bottom:12px}
    .school-brand{display:flex;align-items:center;gap:12px}
    .school-logo{width:56px;height:56px;border-radius:14px;object-fit:contain;background:#fff;border:1px solid #e5e7eb;padding:6px}
    .school-name{margin:0;font-weight:700;color:#111827}
    .school-year{margin:0;color:#4b5563;font-size:.95rem}
    .year-selector label{display:grid;gap:6px;font-weight:600}
    .year-selector select{min-width:140px}
  </style>
</head>
<body>
<main>
  <header>
    <div class="school-header">
      <div class="school-brand">
        <img id="school-logo-display" class="school-logo" alt="School logo">
        <div>
          <p id="schoolNameDisplay" class="school-name"></p>
          <p id="currentYearDisplay" class="school-year"></p>
        </div>
      </div>
      <div class="year-selector">
        <label for="yearSelect">Mwaka wa Masomo
          <select id="yearSelect" data-somap-year-select></select>
        </label>
      </div>
    </div>
    <h1>Usajili wa Mfanyakazi Mpya</h1>
    <p class="workers-card__subtitle">
      Jaza kila sehemu ? weka picha mbili (ID & Passport) ? bonyeza “Hifadhi Mfanyakazi”.
    </p>
  </header>

  <section class="workers-flex">
    <div class="workers-card">
      <header class="workers-card__header">
        <h2>Tarehe ya Leo</h2>
        <p class="workers-card__subtitle" id="currentDate"></p>
      </header>
      <div class="workers-card__content">
        <ul>
          <li>Simu lazima iwe kama <strong>+2550XXXXXXXXX</strong> (tarakimu 9 baada ya 0)</li>
          <li>Majina lazima yawe <strong>MATATU</strong> (mf. JOHN DOE JUNIOR)</li>
          <li>Chagua jukumu (role)</li>
        </ul>
      </div>
    </div>
  </section>

  <form id="admissionForm" class="workers-form workers-fieldset" novalidate>
    <fieldset class="workers-fieldset">
      <legend>Wasifu wa Mfanyakazi</legend>
      <label>Jina la Kwanza <input name="firstName" required></label>
      <label>Jina la Kati   <input name="middleName" required></label>
      <label>Jina la Mwisho <input name="lastName" required></label>
      <label>Nambari ya Simu (+2550xxxxxxxxx) <input name="phone" required placeholder="+2550XXXXXXXXX"></label>
      <label>Nchi / Country
        <select name="country">
          <option value="TZ" selected>Tanzania (TZ)</option>
          <option value="KE">Kenya (KE)</option>
          <option value="UG">Uganda (UG)</option>
        </select>
      </label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Wasiliana (Next of Kin)</legend>
      <label>Jina la Mtu wa Dharura <input name="nextOfKinName" required></label>
      <label>Namba ya Simu ya Mtu wa Dharura <input name="nextOfKinPhone" required placeholder="+2550XXXXXXXXX"></label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Nyaraka za Utambulisho</legend>
      <label>NSSF Number <input name="nssfNumber" required></label>
      <label>NIDA au Passport Number <input name="nidaOrPassport" required></label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Taarifa za Familia</legend>
      <label>Jina la Baba <input name="fatherName" required></label>
      <label>Jina la Mama <input name="motherName" required></label>
      <label>Hali ya Ndoa
        <select name="maritalStatus" required id="maritalStatus">
          <option value="">-- Chagua --</option>
          <option value="single">Sijaoa / Sijaolewa</option>
          <option value="married">Nimeoa / Nimeolewa</option>
          <option value="other">Nyingine</option>
        </select>
      </label>
      <div id="spouseFields" style="display:none;">
        <label>Jina la Mwenza <input name="spouseName"></label>
        <label>Namba ya Mwenza <input name="spousePhone" placeholder="+2550XXXXXXXXX"></label>
      </div>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Anuani</legend>
      <label>Eneo / Mtaa / Kata <input name="area" required></label>
      <label>Kabila / Tribe <input name="tribe" required></label>
      <label>Kijiji cha Nyumbani <input name="villageHome" required></label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Ajira</legend>
      <label>Jukumu / Role
        <select name="role" required id="roleSelect">
          <option value="">-- Chagua jukumu --</option>
          <option value="cook">Mpishi / Cook</option>
          <option value="guard">Mlinzi / Guard</option>
          <option value="cleaner">Msafi / Cleaner</option>
          <option value="driver">Dereva / Driver</option>
          <option value="teacher">Mwalimu / Teacher</option>
          <option value="accountant">Mhasibu / Accountant</option>
          <option value="manager">Msimamizi / Manager</option>
          <option value="academic">Mratibu wa Masomo / Academic</option>
          <option value="secretary">Katibu / Secretary</option>
          <option value="hr">Rasilimali Watu / HR</option>
          <option value="storekeeper">Ghala / Storekeeper</option>
        </select>
      </label>
      <label>Mshahara wa Msingi (TZS) <input name="baseSalary" type="number" min="0" required></label>
      <label>Hali ya kazi
        <select name="active">
          <option value="true" selected>Hai (Active)</option>
          <option value="false">Imesimama</option>
        </select>
      </label>
      <label>Maelezo ya Afya (hiari) <textarea name="medicalConditions" placeholder="Magonjwa sugu / maelezo ya daktari"></textarea></label>
      <label>Uthibitisho wa Afya (PDF / picha, hiari) <input type="file" name="medicalProof" accept=".pdf,image/*"></label>
    </fieldset>

    <fieldset class="workers-fieldset">
      <legend>Faili za LAZIMA</legend>
      <label>Picha ya Kitambulisho (ID photo) <input type="file" name="idPhoto" accept="image/*" required></label>
      <label>Picha ya Passport <input type="file" name="passportPhoto" accept="image/*" required></label>
      <div id="roleDocs"></div>
    </fieldset>

    <div class="workers-card__actions">
      <button class="workers-btn" type="submit">Hifadhi Mfanyakazi</button>
      <button class="workers-btn secondary" type="reset">Futa & Anza upya</button>
    </div>
    <p id="saveStatus" class="workers-form-status" aria-live="polite"></p>
  </form>

  <section>
    <h2 class="workers-section-title">Wafanyakazi Walio Sajiliwa</h2>
    <p id="workerCount" class="workers-section-count" aria-live="polite"></p>
    <div id="workerTable"></div>
  </section>
</main>

<script type="module">
  /* ---------- Firebase init (no auth required) ---------- */
  const firebaseConfig = {
    apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
    authDomain: "somaptestt.firebaseapp.com",
    databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
    projectId: "somaptestt",
    storageBucket: "somaptestt.appspot.com",
    messagingSenderId: "105526245138",
    appId: "1:105526245138:web:b8e7c0cb82a46e861965cb"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  /* ---------- Multi-school + year context ---------- */
  const activeSchool = (window.SOMAP && SOMAP.getSchool && SOMAP.getSchool()) || null;
  if (!activeSchool || !activeSchool.id) {
    window.location.href = '../somapappv1multischool/multischool.html';
    throw new Error('No school selected for SoMAp multi-school context');
  }
  const schoolId = activeSchool.id;
  const schoolDisplayName = activeSchool.name || schoolId;
  const legacyFriendlyId = (schoolId === 'socrates-school' || schoolId === 'default');
  const schoolRef = (subPath)=>db.ref(SOMAP.P(subPath));

  const schoolNameEl = document.getElementById('schoolNameDisplay');
  const yearDisplayEl = document.getElementById('currentYearDisplay');
  const yearSelectEl = document.getElementById('yearSelect');
  if (schoolNameEl) schoolNameEl.textContent = schoolDisplayName;

  /* ---------- Cloudinary (edit in DevTools if needed) ---------- */
  const CLD_CLOUD_NAME    = localStorage.getItem('cloud_name')    || 'dg7vnrkgd';
  const CLD_UPLOAD_PRESET = localStorage.getItem('upload_preset') || 'books_unsigned';
  const getCloudinaryFolder = ()=>`somapappv1/${schoolId}/years/${currentYear}/workers`;

  /* ---------- Small helpers ---------- */
  const $ = (id)=>document.getElementById(id);
  $('currentDate').textContent =
    new Date().toLocaleString('sw-TZ',{timeZone:'Africa/Nairobi',weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const ROLE_DOC_REQUIREMENTS = {
    teacher:['cv','formFourCert'],
    accountant:['cv'],
    manager:['cv'],
    academic:['cv'],
    driver:['roleCert'],
    cook:['roleCert','villageLetter'],
    cleaner:['villageLetter'],
    guard:['villageLetter'],
    storekeeper:['roleCert'],
    hr:['cv'],
    secretary:['cv']
  };
  const DOC_LABELS = {
    cv:'CV (PDF)',
    formFourCert:'Cheti cha Kidato cha Nne (PDF)',
    roleCert:'Cheti cha Jukumu / Leseni (PDF/IMG)',
    villageLetter:'Barua ya Kijiji (PDF/IMG)'
  };
  const formEl = document.getElementById('admissionForm');
  const statusEl = document.getElementById('saveStatus');
  const workerTableContainer = $('workerTable');
  const workerCountEl = $('workerCount');
  let workersData = [];
  let currentEditingWorkerId = '';
  let currentEditingDocs = {};
  let skipResetHandler = false;
  let currentYear = (window.somapYearContext && somapYearContext.getSelectedYear && somapYearContext.getSelectedYear()) || String(new Date().getFullYear());
  let currentWorkersSource = 'scoped';

  function setStatus(message='', isError=false){
    if (!statusEl) return;
    statusEl.textContent = message;
    statusEl.classList.toggle('error', isError);
  }

  function setField(name, value){
    const field = formEl.querySelector(`[name="${name}"]`);
    if (field) field.value = value ?? '';
  }

  function renderRoleDocs(){
    const c = $('roleDocs'); c.innerHTML = '';
    const role = $('roleSelect').value;
    (ROLE_DOC_REQUIREMENTS[role]||[]).forEach(key=>{
      const lab = document.createElement('label');
      lab.textContent = DOC_LABELS[key] || key;
      const inp = document.createElement('input');
      inp.type = 'file'; inp.name = key;
      inp.accept = (key==='cv' || key==='formFourCert')?'.pdf':'.pdf,image/*';
      lab.appendChild(inp); c.appendChild(lab);
    });
  }
  $('roleSelect').addEventListener('change', renderRoleDocs);
  renderRoleDocs();

  function isTZWorkerPhone(p){ return /^\+2550\d{9}$/.test(String(p||'').trim()); }
  function normalizeThreeNames(s){
    const t = String(s||'').replace(/\s+/g,' ').trim().toUpperCase().split(' ');
    if (t.length!==3) throw new Error('Majina lazima yawe MATATU (mf. JOHN DOE JUNIOR)');
    return t.join(' ');
  }

  async function cldUpload(file, publicIdHint='file'){
    if (!file || !file.size) throw new Error('Chagua faili kwanza');
    const isImage = (file.type||'').startsWith('image/');
    const resource = isImage ? 'image' : 'raw';
    const url = `https://api.cloudinary.com/v1_1/${CLD_CLOUD_NAME}/${resource}/upload`;
    const fd = new FormData();
    fd.append('file', file);
    fd.append('upload_preset', CLD_UPLOAD_PRESET);
    fd.append('folder', getCloudinaryFolder());
    fd.append('public_id', String(publicIdHint).replace(/[^a-z0-9_\-]/gi, '_'));
    const res = await fetch(url, { method:'POST', body: fd });
    const data = await res.json();
    if (!res.ok) throw new Error(data?.error?.message || 'Cloudinary upload failed');
    return data.secure_url;
  }

  function updateYearUI(){
    if (yearDisplayEl) yearDisplayEl.textContent = `Mwaka wa masomo: ${currentYear}`;
  }

  function attachYearSelector(){
    if (window.somapYearContext && yearSelectEl){
      somapYearContext.attachYearDropdown(yearSelectEl);
    }
    if (window.somapYearContext){
      const systemYear = String(new Date().getFullYear());
      const selected = somapYearContext.getSelectedYear();
      if (Number(selected) < Number(systemYear)){
        currentYear = somapYearContext.resetToCurrentYear();
      }else{
        currentYear = somapYearContext.setSelectedYear(selected, { forceDispatch:true });
      }
      somapYearContext.onYearChanged((yr)=>{
        currentYear = yr;
        updateYearUI();
        loadWorkers();
        runRolloverIfNeeded(yr).catch(err=>console.error('Rollover error', err));
      });
    }
    updateYearUI();
  }
  attachYearSelector();

  function getDisplayName(profile){
    if (!profile) return '-';
    if (profile.fullNameUpper) return profile.fullNameUpper;
    const parts = [profile.firstName, profile.middleName, profile.lastName].filter(Boolean);
    return parts.join(' ') || '-';
  }

  function renderWorkersTable(rows){
    workerTableContainer.innerHTML = '';
    workerCountEl.textContent = rows.length
      ? `Idadi ya wafanyakazi (${currentYear}): ${rows.length}`
      : `Hakuna wafanyakazi waliopatikana (bado) kwa ${currentYear}.`;
    if (!rows.length) {
      const empty = document.createElement('div');
      empty.style.padding = '12px';
      empty.style.background = '#f3f4f6';
      empty.style.border = '1px solid #e5e7eb';
      empty.style.borderRadius = '10px';
      empty.textContent = 'Hakuna wafanyakazi waliopatikana (bado).';
      workerTableContainer.appendChild(empty);
      return;
    }
    const tbl = document.createElement('table'); tbl.className='workers-table';
    tbl.innerHTML = `
      <thead><tr>
        <th>Picha</th>
        <th>Jina Kamili</th>
        <th>Jukumu</th>
        <th>Simu</th>
        <th>Mshahara (TZS)</th>
        <th>Hali</th>
        <th>Tendo</th>
      </tr></thead><tbody></tbody>`;
    const tb = tbl.querySelector('tbody');
    rows.forEach(worker=>{
      const profile = worker.profile||{};
      const docs = worker.docs||{};
      const photoUrl = docs.idPhotoUrl || docs.passportPhotoUrl || '';
      const photoHtml = photoUrl
        ? `<img src="${photoUrl}" alt="${getDisplayName(profile)}" class="workers-table__photo">`
        : `<span class="workers-table__photo-placeholder">Hakuna picha</span>`;
      const statusText = profile.active !== false ? 'Active' : 'Inactive';
      const salary = Number(profile.baseSalary||0).toLocaleString('sw-TZ');
      const tr = document.createElement('tr');
      tr.dataset.workerId = worker.id;
      tr.dataset.source = worker.source || 'scoped';
      const isLegacy = worker.source === 'legacy';
      const deleteAttrs = isLegacy ? 'disabled title="Data ya Socrates (legacy) ni read-only"' : '';
      tr.innerHTML = `
        <td class="photo-cell">${photoHtml}</td>
        <td>${getDisplayName(profile)}</td>
        <td>${profile.role||''}</td>
        <td>${profile.phone||''}</td>
        <td>${salary}</td>
        <td>${statusText}</td>
        <td class="actions-cell">
          <button type="button" class="workers-btn secondary" data-action="edit" data-worker-id="${worker.id}">Edit</button>
          <button type="button" class="workers-btn secondary" data-action="delete" data-worker-id="${worker.id}" ${deleteAttrs}>Delete</button>
        </td>`;
      tb.appendChild(tr);
    });
    workerTableContainer.appendChild(tbl);
  }

  function populateForm(worker){
    const profile = worker.profile||{};
    currentWorkersSource = worker.source || 'scoped';
    currentEditingWorkerId = worker.id;
    currentEditingDocs = worker.docs||{};
    skipResetHandler = true;
    formEl.reset();
    $('roleSelect').value = profile.role||'';
    renderRoleDocs();
    setField('firstName', profile.firstName);
    setField('middleName', profile.middleName);
    setField('lastName', profile.lastName);
    setField('phone', profile.phone);
    setField('country', profile.country||'TZ');
    setField('nextOfKinName', profile.nextOfKinName);
    setField('nextOfKinPhone', profile.nextOfKinPhone);
    setField('nssfNumber', profile.nssfNumber);
    setField('nidaOrPassport', profile.nidaOrPassport);
    setField('fatherName', profile.fatherName);
    setField('motherName', profile.motherName);
    setField('maritalStatus', profile.maritalStatus);
    setField('spouseName', profile.spouseName);
    setField('spousePhone', profile.spousePhone);
    setField('area', profile.area);
    setField('tribe', profile.tribe);
    setField('villageHome', profile.villageHome);
    setField('baseSalary', profile.baseSalary ?? '');
    setField('medicalConditions', profile.medicalConditions);
    const activeSelect = formEl.querySelector('[name="active"]');
    if (activeSelect) activeSelect.value = profile.active !== false ? 'true' : 'false';
    setStatus(`Editing ${getDisplayName(profile)} - save to update.`);
    formEl.scrollIntoView({behavior:'smooth'});
    const focusField = formEl.querySelector('[name="firstName"]');
    if (focusField) focusField.focus();
  }

  async function deleteWorker(workerId){
    if (currentWorkersSource === 'legacy'){
      alert('Data ya Socrates (legacy) ni ya kusoma tu. Tafadhali hifadhi tena kwenye mwaka uliochaguliwa ili urekebishe.');
      return;
    }
    try{
      await schoolRef(`years/${currentYear}/workers/${workerId}`).remove();
      if (currentEditingWorkerId === workerId){
        currentEditingWorkerId = '';
        currentEditingDocs = {};
        setStatus('');
        formEl.reset();
        renderRoleDocs();
      }
      loadWorkers();
    }catch(err){
      console.error('Delete worker error:', err);
      alert('Imeshindikana kufuta mfanyakazi. Jaribu tena.');
    }
  }

  workerTableContainer.addEventListener('click', async (event)=>{
    const btn = event.target.closest('button[data-action]');
    if (!btn) return;
    const workerId = btn.dataset.workerId;
    const worker = workersData.find(item=>item.id===workerId);
    if (!worker) return;
    if (btn.dataset.action==='edit'){
      populateForm(worker);
      return;
    }
    if (btn.dataset.action==='delete'){
      if (!confirm('Una hakika unataka kufuta mfanyakazi huyu?')) return;
      currentWorkersSource = worker.source || 'scoped';
      await deleteWorker(workerId);
    }
  });

  function normalizeClassKey(value=''){
    return String(value||'').replace(/\s+/g,'').toLowerCase();
  }

  function getPromotedClassName(current=''){
    const key = normalizeClassKey(current);
    const ladder = {
      baby:'Middle',
      middle:'Preunit',
      preunit:'Class1',
      class1:'Class2',
      class2:'Class3',
      class3:'Class4',
      class4:'Class5',
      class5:'Class6',
      class6:'Class7',
      class7:'Graduated/Archive'
    };
    return ladder[key] || current || '';
  }

  async function runRolloverIfNeeded(targetYear){
    if (!targetYear) return;
    const flagRef = schoolRef(`meta/rolloverDone/${targetYear}`);
    const flagSnap = await flagRef.get();
    if (flagSnap.exists()) return;

    const previousYear = String(Number(targetYear) - 1);
    const srcSnap = await schoolRef(`years/${previousYear}/students`).get();
    const existingDestSnap = await schoolRef(`years/${targetYear}/students`).get();
    const existingIds = new Set();
    existingDestSnap.forEach(ch=>existingIds.add(ch.key));
    if (srcSnap.exists()){
      const updates = {};
      srcSnap.forEach(ch=>{
        if (existingIds.has(ch.key)) return;
        const student = ch.val()||{};
        const nextClass = getPromotedClassName(student.class || student.className || '');
        updates[ch.key] = {
          ...student,
          class: nextClass,
          className: nextClass,
          rolledOverFrom: previousYear
        };
      });
      if (Object.keys(updates).length){
        await schoolRef(`years/${targetYear}/students`).update(updates);
      }
    }
    await flagRef.set(true);
  }

  async function scopedOrSocratesLegacy(scopedSubPath, legacyPath){
    const scopedSnap = await schoolRef(scopedSubPath).get();
    if (scopedSnap.exists()) return { snap: scopedSnap, source:'scoped' };
    if (legacyFriendlyId){
      const legacySnap = await db.ref(legacyPath).get();
      if (legacySnap.exists()) return { snap: legacySnap, source:'legacy' };
    }
    return { snap: scopedSnap, source:'scoped' };
  }

  async function loadSchoolLogo(){
    const el = document.getElementById('school-logo-display');
    if (!el) return;
    try{
      let logoUrl = '';
      if (schoolId === 'socrates-school' || schoolId === 'default'){
        logoUrl = '../images/socrates_logo.png';
      }else{
        const snap = await schoolRef('profile/logoUrl').get();
        logoUrl = snap.val() || '';
      }
      el.src = logoUrl || '../images/socrates_logo.png';
      el.alt = `${schoolDisplayName} logo`;
    }catch(err){
      console.warn('Logo load failed', err);
      el.src = '../images/socrates_logo.png';
      el.alt = `${schoolDisplayName} logo`;
    }
  }

  async function loadWorkers(){
    try{
      currentWorkersSource = 'scoped';
      const { snap, source } = await scopedOrSocratesLegacy(`years/${currentYear}/workers`, 'workers');
      const rows = [];
      (snap && snap.forEach) && snap.forEach(ch=>{
        const v = ch.val()||{};
        rows.push({
          id: ch.key,
          profile: v.profile||{},
          docs: v.docs||{},
          source
        });
      });
      rows.sort((a,b)=>{
        const nameA = (a.profile?.fullNameUpper||'').toUpperCase();
        const nameB = (b.profile?.fullNameUpper||'').toUpperCase();
        return nameA.localeCompare(nameB,'sw-TZ');
      });
      workersData = rows;
      renderWorkersTable(rows);
    }catch(e){
      console.error('Load workers error:', e);
      workersData = [];
      renderWorkersTable([]);
    }
  }

  formEl.addEventListener('reset', ()=>{
    if (skipResetHandler){
      skipResetHandler = false;
      return;
    }
    currentEditingWorkerId = '';
    currentEditingDocs = {};
    currentWorkersSource = 'scoped';
    setStatus('');
    setTimeout(renderRoleDocs,0);
  });

  formEl.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const fd = new FormData(e.currentTarget);

    const firstName = (fd.get('firstName')||'').trim();
    const middleName= (fd.get('middleName')||'').trim();
    const lastName  = (fd.get('lastName')||'').trim();
    const phone     = (fd.get('phone')||'').trim();
    const role      = (fd.get('role')||'').trim();

    let fullNameUpper;
    try { fullNameUpper = normalizeThreeNames(`${firstName} ${middleName} ${lastName}`); }
    catch(err){ return alert(err.message); }

    if (!isTZWorkerPhone(phone)) return alert('Simu lazima iwe kama +2550XXXXXXXXX');
    if (!role) return alert('Chagua jukumu (Role)');

    const isEditing = Boolean(currentEditingWorkerId);
    const workerId = isEditing ? currentEditingWorkerId : schoolRef(`years/${currentYear}/workers`).push().key;
    const baseHint = `w_${workerId}_${Date.now()}`;

    const idPhoto = fd.get('idPhoto');
    const passportPhoto = fd.get('passportPhoto');
    let idPhotoUrl = currentEditingDocs.idPhotoUrl || '';
    let passportPhotoUrl = currentEditingDocs.passportPhotoUrl || '';
    if (idPhoto?.size) idPhotoUrl = await cldUpload(idPhoto, `${baseHint}_id`);
    if (passportPhoto?.size) passportPhotoUrl = await cldUpload(passportPhoto, `${baseHint}_passport`);
    if (!idPhotoUrl || !passportPhotoUrl) return alert('Weka Picha ya Kitambulisho na Picha ya Passport');

    let medicalProofUrl = currentEditingDocs.medicalProofUrl || '';
    const medicalProof = fd.get('medicalProof');
    if (medicalProof?.size) medicalProofUrl = await cldUpload(medicalProof, `${baseHint}_medical`);

    const extra = {};
    for (const k of (ROLE_DOC_REQUIREMENTS[role]||[])){
      const f = fd.get(k);
      const fieldKey = (k==='cv'?'cvPdf':k) + 'Url';
      if (f?.size){
        extra[fieldKey] = await cldUpload(f, `${baseHint}_${k}`);
      }else if (currentEditingDocs[fieldKey]){
        extra[fieldKey] = currentEditingDocs[fieldKey];
      }else{
        return alert(`Faili ya lazima: ${DOC_LABELS[k]||k}`);
      }
    }

    const profile = {
      firstName, middleName, lastName, fullNameUpper,
      phone,
      country:(fd.get('country')||'TZ').trim(),
      nextOfKinName:(fd.get('nextOfKinName')||'').trim(),
      nextOfKinPhone:(fd.get('nextOfKinPhone')||'').trim(),
      nssfNumber:(fd.get('nssfNumber')||'').trim(),
      nidaOrPassport:(fd.get('nidaOrPassport')||'').trim(),
      fatherName:(fd.get('fatherName')||'').trim(),
      motherName:(fd.get('motherName')||'').trim(),
      maritalStatus:(fd.get('maritalStatus')||'').trim(),
      spouseName:(fd.get('spouseName')||'').trim(),
      spousePhone:(fd.get('spousePhone')||'').trim(),
      area:(fd.get('area')||'').trim(),
      tribe:(fd.get('tribe')||'').trim(),
      villageHome:(fd.get('villageHome')||'').trim(),
      role,
      baseSalary:Number(fd.get('baseSalary')||0),
      active:(fd.get('active')||'true')!=='false',
      medicalConditions:(fd.get('medicalConditions')||'').trim(),
      createdBy: '',
      admissionDate: Date.now()
    };

    try{
      const payload = {
        profile,
        docs: { idPhotoUrl, passportPhotoUrl, medicalProofUrl, ...extra },
        contract: {
          language: (['driver','cook','cleaner','guard'].includes(role)?'sw':'en'),
          templateKey: role,
          accepted:false, acceptedTs:0, contractPdfUrl:''
        }
      };
      await schoolRef(`years/${currentYear}/workers/${workerId}`).set(payload);
      setStatus('SAVED SUCCESSFULLY');
      alert('SAVED SUCCESSFULLY');
      currentEditingWorkerId = '';
      currentEditingDocs = {};
      currentWorkersSource = 'scoped';
      skipResetHandler = true;
      formEl.reset();
      renderRoleDocs();
      loadWorkers();
    }catch(err){
      console.error(err);
      alert('Imeshindikana kuhifadhi. Angalia Cloudinary preset / intaneti / RTDB path.');
    }
  });

  loadSchoolLogo();
  runRolloverIfNeeded(currentYear).catch(err=>console.error('Rollover error', err));
  loadWorkers();
</script>

</body>
</html>

