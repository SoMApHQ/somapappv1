<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workers Contract Hub | Headteacher</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script>
  <style>
    :root {
      --ink: #0f172a;
      --muted: #64748b;
      --panel: #ffffff;
      --border: #e2e8f0;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.08);
      --bg: #f8fafc;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
    }
    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    header {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
    }
    header h1 {
      margin: 0;
      font-size: 1.6rem;
    }
    .context {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .context-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--accent-soft);
      color: var(--muted);
      font-size: 0.9rem;
    }
    .context-chip select {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      background: #fff;
      color: var(--ink);
      font-weight: 600;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(260px, 1fr) 2fr;
      gap: 18px;
      margin-top: 20px;
    }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 18px;
    }
    .panel h2 {
      margin: 0 0 12px;
      font-size: 1.2rem;
    }
    label {
      display: block;
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select, input, textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 0.95rem;
      box-sizing: border-box;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    .field {
      margin-bottom: 14px;
    }
    .meta {
      margin-top: 10px;
      padding: 12px;
      border-radius: 12px;
      background: #f1f5f9;
      color: var(--muted);
      font-size: 0.9rem;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }
    .actions .workers-btn {
      border-radius: 10px;
    }
    .status {
      margin-top: 10px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    .link-row {
      margin-top: 10px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .link-row a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }
    @media (max-width: 960px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>Workers Contract Hub</h1>
        <div class="status">Headteacher tools for contract terms, drafts, and approvals.</div>
      </div>
      <div class="context">
        <div class="context-chip">School: <strong id="schoolNameDisplay">-</strong></div>
        <div class="context-chip">Year: <select id="yearSelect" data-somap-year-select></select></div>
      </div>
    </header>

    <section class="layout">
      <div class="panel">
        <h2>Workers</h2>
        <div class="field">
          <label for="workerSelect">Select worker</label>
          <select id="workerSelect">
            <option value="">-- Choose worker --</option>
          </select>
        </div>
        <div class="meta" id="workerMeta">No worker selected.</div>
      </div>

      <div class="panel">
        <h2>Contract Terms</h2>
        <div class="field">
          <label>Total Salary (read-only)</label>
          <input type="text" id="totalSalary" disabled>
        </div>
        <div class="field">
          <label for="roleSalary">Role Salary (TZS)</label>
          <input type="number" id="roleSalary" min="0" placeholder="0">
        </div>
        <div class="field">
          <label for="responsibilityAllowance">Responsibility Allowance (TZS)</label>
          <input type="number" id="responsibilityAllowance" min="0" placeholder="0">
        </div>
        <div class="field">
          <label for="agreementLang">Special Agreement Language</label>
          <select id="agreementLang">
            <option value="en">English</option>
            <option value="sw">Kiswahili</option>
          </select>
        </div>
        <div class="field">
          <label for="specialAgreement">Special Agreement</label>
          <textarea id="specialAgreement" placeholder="Add any special agreement text..."></textarea>
        </div>
        <div class="actions">
          <button class="workers-btn" id="saveTermsBtn">Save Terms</button>
          <button class="workers-btn secondary" id="generateDraftBtn">Generate Draft PDF</button>
          <button class="workers-btn secondary" id="approveBtn" disabled>Approve Signed PDF</button>
        </div>
        <div class="status" id="contractStatus">Select a worker to manage contracts.</div>
        <div class="link-row" id="linkRow"></div>
      </div>
    </section>
  </main>

  <script type="module">
    import { defaultContractLanguage, buildContractHtml } from './modules/workers_contracts.js';
    import { ensureHtml2Pdf } from './modules/workers_ui.js';
    import { toast } from './modules/workers_helpers.js';

    const db = firebase.database();
    const storage = firebase.storage();

    const schoolNameEl = document.getElementById('schoolNameDisplay');
    const yearSelectEl = document.getElementById('yearSelect');
    const workerSelectEl = document.getElementById('workerSelect');
    const workerMetaEl = document.getElementById('workerMeta');
    const totalSalaryEl = document.getElementById('totalSalary');
    const roleSalaryEl = document.getElementById('roleSalary');
    const allowanceEl = document.getElementById('responsibilityAllowance');
    const agreementLangEl = document.getElementById('agreementLang');
    const agreementTextEl = document.getElementById('specialAgreement');
    const saveTermsBtn = document.getElementById('saveTermsBtn');
    const generateDraftBtn = document.getElementById('generateDraftBtn');
    const approveBtn = document.getElementById('approveBtn');
    const statusEl = document.getElementById('contractStatus');
    const linkRowEl = document.getElementById('linkRow');

    const state = {
      schoolId: '',
      schoolName: '',
      year: '',
      workers: [],
      selectedWorkerId: '',
      selectedWorker: null,
      terms: {},
      signing: {}
    };

    init();

    function init() {
      initSchoolContext();
      initYearContext();
      attachListeners();
      loadWorkers();
    }

    function initSchoolContext() {
      const school = (window.SOMAP && SOMAP.getSchool && SOMAP.getSchool()) || null;
      if (!school || !school.id) {
        window.location.href = '../somapappv1multischool/multischool.html';
        throw new Error('No school selected for multi-school context');
      }
      state.schoolId = school.id;
      state.schoolName = school.name || school.id;
      if (schoolNameEl) schoolNameEl.textContent = state.schoolName;
    }

    function initYearContext() {
      const yearCtx = window.somapYearContext || null;
      const systemYear = String(new Date().getFullYear());
      const selected = String(yearCtx?.getSelectedYear?.() || systemYear);
      state.year = selected;
      yearCtx?.attachYearDropdown?.(yearSelectEl);
      yearCtx?.onYearChanged?.((yr) => {
        state.year = String(yr);
        resetSelection();
        loadWorkers();
      });
    }

    function attachListeners() {
      workerSelectEl.addEventListener('change', () => {
        state.selectedWorkerId = workerSelectEl.value;
        if (!state.selectedWorkerId) {
          resetSelection();
          return;
        }
        state.selectedWorker = state.workers.find(w => w.id === state.selectedWorkerId) || null;
        loadContractData();
      });

      saveTermsBtn.addEventListener('click', saveTerms);
      generateDraftBtn.addEventListener('click', generateDraftPdf);
      approveBtn.addEventListener('click', approveSignedPdf);
    }

    function yearRoot() {
      return `schools/${state.schoolId}/years/${state.year}`;
    }

    function workersRef() {
      return db.ref(`${yearRoot()}/workers`);
    }

    function contractRef(workerId) {
      return db.ref(`${yearRoot()}/workersContracts/${workerId}`);
    }

    async function loadWorkers() {
      try {
        workerSelectEl.innerHTML = '<option value="">-- Choose worker --</option>';
        const snap = await workersRef().once('value');
        const rows = [];
        snap.forEach(child => {
          const data = child.val() || {};
          rows.push({
            id: child.key,
            profile: data.profile || {}
          });
        });
        rows.sort((a, b) => {
          const nameA = (a.profile.fullNameUpper || '').toUpperCase();
          const nameB = (b.profile.fullNameUpper || '').toUpperCase();
          return nameA.localeCompare(nameB, 'sw-TZ');
        });
        state.workers = rows;
        rows.forEach(worker => {
          const opt = document.createElement('option');
          opt.value = worker.id;
          opt.textContent = `${worker.profile.fullNameUpper || worker.id} - ${worker.profile.role || ''}`;
          workerSelectEl.appendChild(opt);
        });
        if (!rows.length) {
          workerMetaEl.textContent = 'No workers found for this year.';
        }
      } catch (err) {
        console.error('Load workers error:', err);
        toast('Failed to load workers.', 'error');
      }
    }

    async function loadContractData() {
      if (!state.selectedWorkerId) return;
      try {
        const snap = await contractRef(state.selectedWorkerId).once('value');
        const data = snap.val() || {};
        state.terms = data.terms || {};
        state.signing = data.signing || {};
        populateWorkerMeta();
        populateForm();
        refreshStatus();
      } catch (err) {
        console.error('Load contract error:', err);
        toast('Failed to load contract data.', 'error');
      }
    }

    function populateWorkerMeta() {
      const profile = state.selectedWorker?.profile || {};
      const name = profile.fullNameUpper || profile.firstName || state.selectedWorkerId;
      const role = profile.role || '-';
      const phone = profile.phone || '-';
      workerMetaEl.textContent = `${name} | ${role} | ${phone}`;
      totalSalaryEl.value = Number(profile.baseSalary || 0).toLocaleString('en-US');
    }

    function populateForm() {
      const profile = state.selectedWorker?.profile || {};
      const totalSalary = Number(profile.baseSalary || 0);
      roleSalaryEl.value = Number(state.terms.roleSalary ?? totalSalary).toString();
      allowanceEl.value = Number(state.terms.responsibilityAllowance ?? 0).toString();
      const agreement = state.terms.specialAgreement || {};
      agreementLangEl.value = agreement.lang || 'en';
      agreementTextEl.value = agreement.text || '';
      approveBtn.disabled = !(state.signing?.signedPdfUrl);
      linkRowEl.innerHTML = '';
      if (state.signing?.draftPdfUrl) {
        const draftLink = document.createElement('a');
        draftLink.href = state.signing.draftPdfUrl;
        draftLink.target = '_blank';
        draftLink.textContent = 'Download Draft PDF';
        linkRowEl.appendChild(draftLink);
      }
      if (state.signing?.signedPdfUrl) {
        const signedLink = document.createElement('a');
        signedLink.href = state.signing.signedPdfUrl;
        signedLink.target = '_blank';
        signedLink.textContent = 'Download Signed PDF';
        linkRowEl.appendChild(signedLink);
      }
    }

    function refreshStatus() {
      const status = state.signing?.status || 'draft';
      const statusMap = {
        draft: 'Draft ready (generate if missing).',
        worker_uploaded: 'Signed PDF uploaded by worker. Ready to approve.',
        approved: 'Approved and finalized.'
      };
      statusEl.textContent = statusMap[status] || 'Contract status ready.';
    }

    function collectTermsPayload() {
      const roleSalary = Number(roleSalaryEl.value || 0);
      const allowance = Number(allowanceEl.value || 0);
      const agreementText = agreementTextEl.value.trim();
      const agreementLang = agreementLangEl.value === 'sw' ? 'sw' : 'en';
      const actor = localStorage.getItem('workerId') || firebase.auth().currentUser?.uid || '';

      return {
        roleSalary,
        responsibilityAllowance: allowance,
        nssfEmployeePercent: 0.10,
        nssfEmployerPercent: 0.10,
        nssfAppliesTo: 'roleSalary',
        specialAgreement: agreementText ? { lang: agreementLang, text: agreementText } : null,
        updatedBy: actor,
        updatedAt: Date.now()
      };
    }

    async function saveTerms() {
      if (!state.selectedWorkerId) {
        toast('Select a worker first.', 'warning');
        return null;
      }
      const payload = collectTermsPayload();
      try {
        await contractRef(state.selectedWorkerId).child('terms').set(payload);
        state.terms = payload;
        toast('Terms saved.', 'success');
        return payload;
      } catch (err) {
        console.error('Save terms error:', err);
        toast('Failed to save terms.', 'error');
        return null;
      }
    }

    async function generateDraftPdf() {
      if (!state.selectedWorkerId) {
        toast('Select a worker first.', 'warning');
        return;
      }
      const payload = await saveTerms();
      if (!payload) return;
      try {
        const profile = state.selectedWorker?.profile || {};
        const language = defaultContractLanguage(profile.role);
        const html = buildContractHtml(profile, {
          language,
          signatureUrl: '',
          terms: payload,
          specialAgreement: payload.specialAgreement || null
        });

        await ensureHtml2Pdf();
        const wrapper = document.createElement('div');
        wrapper.style.position = 'fixed';
        wrapper.style.top = '-9999px';
        wrapper.innerHTML = html;
        document.body.appendChild(wrapper);

        const pdfBlob = await window.html2pdf().set({
          margin: 6,
          filename: `contract-${state.selectedWorkerId}.pdf`,
          html2canvas: { scale: 1.2, useCORS: true, logging: false },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
          pagebreak: { mode: 'avoid-all' }
        }).from(wrapper).toPdf().output('blob');

        wrapper.remove();

        const storageRef = storage.ref(`schools/${state.schoolId}/years/${state.year}/contracts/${state.selectedWorkerId}/draft.pdf`);
        await storageRef.put(pdfBlob, { contentType: 'application/pdf' });
        const url = await storageRef.getDownloadURL();

        await contractRef(state.selectedWorkerId).child('signing').update({
          draftPdfUrl: url,
          status: 'draft'
        });
        state.signing = { ...(state.signing || {}), draftPdfUrl: url, status: 'draft' };
        populateForm();
        refreshStatus();
        toast('Draft generated.', 'success');
      } catch (err) {
        console.error('Draft generation error:', err);
        toast(err.message || 'Failed to generate draft.', 'error');
      }
    }

    async function approveSignedPdf() {
      if (!state.selectedWorkerId) return;
      if (!state.signing?.signedPdfUrl) {
        toast('Signed PDF not uploaded yet.', 'warning');
        return;
      }
      const actor = localStorage.getItem('workerId') || firebase.auth().currentUser?.uid || '';
      try {
        await contractRef(state.selectedWorkerId).child('signing').update({
          status: 'approved',
          approvedAt: Date.now(),
          approvedBy: actor
        });
        state.signing = { ...(state.signing || {}), status: 'approved' };
        refreshStatus();
        toast('Contract approved.', 'success');
      } catch (err) {
        console.error('Approve error:', err);
        toast('Failed to approve contract.', 'error');
      }
    }

    function resetSelection() {
      state.selectedWorkerId = '';
      state.selectedWorker = null;
      state.terms = {};
      state.signing = {};
      workerSelectEl.value = '';
      workerMetaEl.textContent = 'No worker selected.';
      totalSalaryEl.value = '';
      roleSalaryEl.value = '';
      allowanceEl.value = '';
      agreementLangEl.value = 'en';
      agreementTextEl.value = '';
      linkRowEl.innerHTML = '';
      approveBtn.disabled = true;
      statusEl.textContent = 'Select a worker to manage contracts.';
    }
  </script>
</body>
</html>
