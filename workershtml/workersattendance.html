<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mahudhurio ya Kazi | SoMAp</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>
  <script src="../js/school-logo.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script>
  <style>
    :root {
      --bg: #0b1220;
      --panel: rgba(255, 255, 255, 0.08);
      --glass: rgba(255, 255, 255, 0.06);
      --border: rgba(255, 255, 255, 0.12);
      --ink: #e2e8f0;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --accent-2: #6366f1;
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #fb7185;
      --card-shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
    }
    body { background: radial-gradient(circle at 20% 20%, rgba(34,211,238,0.14), transparent 28%), radial-gradient(circle at 80% 10%, rgba(99,102,241,0.16), transparent 24%), #0b1220; color: var(--ink); font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    main.page { max-width: 1100px; margin: 0 auto; padding: 22px 16px 48px; }
    .page__hero { display:flex; justify-content:space-between; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:20px; }
    .brand { display:flex; gap:14px; align-items:center; }
    .brand__logo { width:64px; height:64px; border-radius:18px; border:1px solid var(--border); background:var(--glass); object-fit:contain; padding:8px; box-shadow:var(--card-shadow); }
    .brand__eyebrow { margin:0; color:var(--muted); font-weight:600; letter-spacing:0.2px; }
    .brand h1 { margin:2px 0; font-size:1.6rem; color:#fff; }
    .brand__school { margin:0; color:var(--muted); }
    .context { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .context__chip { background:var(--glass); border:1px solid var(--border); border-radius:14px; padding:12px 14px; min-width:220px; box-shadow:var(--card-shadow); backdrop-filter: blur(16px); }
    .context__chip label { font-size:0.9rem; color:var(--muted); display:block; margin-bottom:6px; }
    .context__chip select { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px; background:rgba(255,255,255,0.06); color:var(--ink); }
    .context__wifi { font-size:0.95rem; color:var(--muted); line-height:1.4; }
    .summary-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:18px; }
    .stat-card { background:var(--glass); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:var(--card-shadow); backdrop-filter: blur(18px); }
    .stat-label { color:var(--muted); font-size:0.9rem; margin-bottom:6px; }
    .stat-value { font-size:1.7rem; font-weight:800; color:#fff; }
    .stat-accent { color:var(--accent); }
    .stat-warning { color:var(--warning); }
    .stat-danger { color:var(--danger); }
    .stat-success { color:var(--success); }
    .workers-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:12px; }
    .workers-card { background:var(--glass); border:1px solid var(--border); border-radius:18px; padding:16px; box-shadow:var(--card-shadow); backdrop-filter: blur(18px); }
    .workers-card__header h2 { margin:0 0 4px; color:#fff; }
    .workers-card__subtitle { margin:0; color:var(--muted); }
    .workers-card__content { display:grid; gap:10px; margin-top:12px; }
    .workers-btn { padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#0b1220; font-weight:800; cursor:pointer; box-shadow:0 12px 24px rgba(99,102,241,0.35); }
    .workers-btn.secondary { background:rgba(255,255,255,0.06); color:var(--ink); border:1px solid var(--border); box-shadow:none; }
    .workers-table { width:100%; border-collapse:collapse; }
    .workers-table th, .workers-table td { padding:10px 8px; border-bottom:1px solid var(--border); font-size:0.95rem; color:var(--ink); }
    .workers-table th { text-align:left; color:var(--muted); font-weight:700; }
    .pill { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:999px; font-size:0.85rem; border:1px solid var(--border); background:rgba(255,255,255,0.06); }
    .pill.success { background:rgba(52,211,153,0.15); border-color:rgba(52,211,153,0.5); color:#bbf7d0; }
    .pill.warning { background:rgba(251,191,36,0.15); border-color:rgba(251,191,36,0.5); color:#fcd34d; }
    .pill.danger { background:rgba(251,113,133,0.15); border-color:rgba(251,113,133,0.5); color:#fecdd3; }
    .pill.info { background:rgba(99,102,241,0.18); border-color:rgba(99,102,241,0.45); color:#c7d2fe; }
    .admin-actions { display:flex; gap:6px; flex-wrap:wrap; }
    .hint { font-size:0.9rem; color:var(--muted); }
    @media (max-width: 640px) {
      .brand h1 { font-size:1.3rem; }
      .context__chip { width:100%; }
    }
  </style>
</head>
<body>
  <main class="page">
    <header class="page__hero">
      <div class="brand">
        <img id="school-logo-display" alt="School logo" class="brand__logo">
        <div>
          <p class="brand__eyebrow">SoMAp Workers</p>
          <h1>Mahudhurio | Attendance</h1>
          <p class="brand__school" id="schoolNameDisplay"></p>
        </div>
      </div>
      <div class="context">
        <div class="context__chip">
          <label for="yearSelect">Mwaka wa masomo</label>
          <select id="yearSelect" data-somap-year-select></select>
          <p class="hint" id="currentYearLabel"></p>
        </div>
        <div class="context__chip context__wifi" id="wifiStatus">Wi-Fi verification (beta) inatumika kuthibitisha uko shule.</div>
      </div>
    </header>

    <section class="summary-grid">
      <div class="stat-card">
        <div class="stat-label">Siku ulizohudhuria</div>
        <div class="stat-value stat-success" id="statPresent">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Spoti za kuchelewa</div>
        <div class="stat-value stat-warning" id="statLate">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Kuondoka mapema</div>
        <div class="stat-value stat-danger" id="statEarly">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Faini mwezi huu (TZS)</div>
        <div class="stat-value stat-accent" id="statFines">0</div>
      </div>
    </section>

    <section class="workers-grid">
      <div class="workers-card">
        <header class="workers-card__header">
          <h2>Check-In</h2>
          <p class="workers-card__subtitle">Wi-Fi ya shule pekee. Hakuna GPS wala picha.</p>
        </header>
        <div class="workers-card__content">
          <button id="checkInBtn" class="workers-btn">Check-In Sasa</button>
          <p class="hint">Lazima kabla ya 07:20 (Africa/Nairobi). Baada ya tukio la 3+ la kuchelewa, kiasi kitaondolewa kwenye posho ya uwajibikaji.</p>
        </div>
      </div>

      <div class="workers-card">
        <header class="workers-card__header">
          <h2>Check-Out</h2>
          <p class="workers-card__subtitle">Ondoka kwa nidhamu (baada ya 16:30)</p>
        </header>
        <div class="workers-card__content">
          <button id="checkOutBtn" class="workers-btn secondary">Check-Out Sasa</button>
          <p class="hint">Ukitoka kabla ya 16:30, kuondoka mapema hujilimbikiza na baada ya tukio la 3+, kiasi kitaondolewa kwenye posho ya uwajibikaji.</p>
        </div>
      </div>
    </section>

    <section class="workers-card" style="margin-top:18px;">
      <header class="workers-card__header">
        <h2>Mahudhurio ya Mwezi</h2>
        <p id="monthLabel" class="workers-card__subtitle"></p>
      </header>
      <div class="workers-card__content">
        <table class="workers-table" id="attendanceTable">
          <thead>
            <tr>
              <th>Siku</th>
              <th>Check-In</th>
              <th>Check-Out</th>
              <th>Late (dakika)</th>
              <th>Early (dakika)</th>
              <th>Approval</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="workers-card" id="adminPanel" style="display:none; margin-top:18px;">
      <header class="workers-card__header">
        <h2>Headteacher - Leo</h2>
        <p class="workers-card__subtitle">Waangalie walioingia baada ya 07:20 au hawajaingia; thibitisha au katae</p>
      </header>
      <div class="workers-card__content">
        <ul id="lateList" style="list-style:none; padding-left:0; display:grid; gap:8px;"></ul>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      ensureAnonymousAuth,
      getLinkedWorkerId,
      todayYMD,
      yyyymm,
      localTs,
      toast
    } from '../modules/workers_helpers.js';

    const checkInBtn = document.getElementById('checkInBtn');
    const checkOutBtn = document.getElementById('checkOutBtn');
    const attendanceTable = document.getElementById('attendanceTable').querySelector('tbody');
    const lateList = document.getElementById('lateList');
    const adminPanel = document.getElementById('adminPanel');
    const monthLabel = document.getElementById('monthLabel');
    const schoolNameEl = document.getElementById('schoolNameDisplay');
    const yearSelect = document.getElementById('yearSelect');
    const yearLabel = document.getElementById('currentYearLabel');
    const wifiStatus = document.getElementById('wifiStatus');
    const statPresent = document.getElementById('statPresent');
    const statLate = document.getElementById('statLate');
    const statEarly = document.getElementById('statEarly');
    const statFines = document.getElementById('statFines');

    const DEFAULT_RULES = {
      requireWifi: true,
      allowedSsids: [],
      lateThreshold: 3,
      earlyThreshold: 3,
      deductionAmount: 1000,
      deductionLabel: 'Posho ya Uwajibikaji',
      requireSchoolInternet: false,
      rotatingCodeEnabled: false,
      codeTTLSeconds: 90
    };

    const state = {
      school: null,
      schoolId: '',
      schoolName: '',
      legacyFriendly: false,
      year: '',
      monthKey: yyyymm(new Date()),
      today: todayYMD(),
      todayKey: todayYMD().replace(/-/g, ''),
      workerId: '',
      profile: null,
      settings: {},
      rules: { ...DEFAULT_RULES },
      deviceId: ''
    };

    const DEVICE_ID_KEY = 'somap_workers_device_id';
    const PUBLIC_IP_ENDPOINT = 'https://api.ipify.org';

    const db = firebase.database();

    const DAY_START = '07:20';
    const DAY_END = '16:30';

    ensureAnonymousAuth()
      .then(init)
      .catch(err => {
        console.error(err);
        toast(err.message || 'Error', 'error');
        window.location.href = '../index.html';
      });

    function schoolRef(subPath) {
      return db.ref(SOMAP.P(subPath));
    }

    function scopedPathForYear(year, subPath) {
      return `years/${year}/${subPath}`;
    }

    function scopedPath(subPath) {
      return scopedPathForYear(state.year, subPath);
    }

    function normalizeNow(useSelectedYear = true) {
      const now = new Date();
      state.today = todayYMD(now);
      state.todayKey = state.today.replace(/-/g, '');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const targetYear = useSelectedYear && state.year ? state.year : String(now.getFullYear());
      state.monthKey = `${targetYear}${month}`;
    }

    async function ensureSystemYearForCheck() {
      const systemYear = String(new Date().getFullYear());
      if (state.year === systemYear) return;
      state.year = systemYear;
      if (yearLabel) {
        yearLabel.textContent = `Mwaka: ${state.year}`;
      }
      window.somapYearContext?.setSelectedYear?.(systemYear, { manual: false, forceDispatch: true });
      await loadSettings();
    }

    function setBranding() {
      if (schoolNameEl) schoolNameEl.textContent = state.schoolName;
      if (window.SomapLogo?.loadSchoolLogo) {
        SomapLogo.loadSchoolLogo(db);
      }
    }

    function initSchoolContext() {
      const school = (window.SOMAP && SOMAP.getSchool && SOMAP.getSchool()) || null;
      if (!school || !school.id) {
        window.location.href = '../somapappv1multischool/multischool.html';
        throw new Error('No school selected for multi-school context');
      }
      state.school = school;
      state.schoolId = school.id;
      state.schoolName = school.name || school.id;
      state.legacyFriendly = state.schoolId === 'socrates-school' || state.schoolId === 'default';
      setBranding();
    }

    function initYearContext() {
      const yearCtx = window.somapYearContext || null;
      const systemYear = String(new Date().getFullYear());
      const selected = String(yearCtx?.getSelectedYear?.() ?? systemYear);
      state.year = selected;
      const month = String(new Date().getMonth() + 1).padStart(2, '0');
      state.monthKey = `${state.year}${month}`;
      yearCtx?.attachYearDropdown?.(yearSelect);
      yearLabel.textContent = `Mwaka: ${state.year}`;
      yearCtx?.onYearChanged?.((yr) => {
        state.year = String(yr);
        yearLabel.textContent = `Mwaka: ${state.year}`;
        const monthRecalc = String(new Date().getMonth() + 1).padStart(2, '0');
        state.monthKey = `${state.year}${monthRecalc}`;
        refreshAll();
      });
    }

    async function scopedOrSocratesLegacy(scopedSubPath, legacyPath) {
      const scopedSnap = await schoolRef(scopedSubPath).once('value');
      if (scopedSnap.exists()) return { snap: scopedSnap, source: 'scoped' };
      const isSocrates = ['socrates-school', 'default', 'socrates'].includes(state.schoolId);
      if (isSocrates) {
        const legacySnap = await db.ref(legacyPath).once('value');
        if (legacySnap.exists()) return { snap: legacySnap, source: 'legacy' };
      }
      return { snap: scopedSnap, source: 'scoped' };
    }

    async function init() {
      initSchoolContext();
      initYearContext();
      normalizeNow();
      ensureLocalDeviceId();

      const workerId = await getLinkedWorkerId();
      if (!workerId) {
        toast('Tafadhali ingia tena.', 'error');
        window.location.href = '../index.html';
        return;
      }
      state.workerId = workerId;

      await Promise.all([loadProfile(), loadSettings()]);
      await refreshAll();

      checkInBtn.addEventListener('click', () => handleCheck('in'));
      checkOutBtn.addEventListener('click', () => handleCheck('out'));
    }

    async function loadProfile() {
      const { snap } = await scopedOrSocratesLegacy(
        scopedPath(`workers/${state.workerId}`),
        `workers/${state.workerId}`
      );
      if (!snap.exists()) throw new Error('Worker profile missing');
      state.profile = snap.val().profile || {};
      if (schoolNameEl && state.schoolName) {
        schoolNameEl.textContent = `${state.schoolName} • ${state.profile.role || ''}`.trim();
      }
    }

    async function loadSettings() {
      const { snap } = await scopedOrSocratesLegacy(
        scopedPath('workers_settings'),
        'settings/workers'
      );
      state.settings = snap.val() || {};
      state.rules = { ...DEFAULT_RULES, ...(state.settings.attendanceRules || {}) };
      updateWifiStatus();
    }

    function computeLateMinutes(checkInTs) {
      const start = new Date(`${state.today}T${DAY_START}:00`);
      const startLocal = new Date(start.toLocaleString('en-US', { timeZone: 'Africa/Nairobi' }));
      const diff = checkInTs - startLocal.getTime();
      return diff > 0 ? Math.round(diff / 60000) : 0;
    }

    function computeEarlyMinutes(checkOutTs) {
      const end = new Date(`${state.today}T${DAY_END}:00`);
      const endLocal = new Date(end.toLocaleString('en-US', { timeZone: 'Africa/Nairobi' }));
      const diff = endLocal.getTime() - checkOutTs;
      return diff > 0 ? Math.round(diff / 60000) : 0;
    }

    async function enforceWifi() {
      const rules = state.rules || DEFAULT_RULES;
      if (!rules.requireWifi) return true;
      const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
      if (!connection || typeof connection.type === 'undefined') {
        toast('Kivinjari hakiwezi kuthibitisha aina ya Wi-Fi; SSID haiwezi kuthibitishwa kwenye kivinjari. Hakikisha una Wi-Fi ya shule unayojua.', 'warning');
        return true;
      }
      if (connection.type !== 'wifi') {
        toast('Unganisha kwenye Wi-Fi ya shule ili kuhudhuria.', 'warning');
        return false;
      }
      return true;
    }

    function ensureLocalDeviceId() {
      let stored = localStorage.getItem(DEVICE_ID_KEY);
      if (!stored) {
        if (crypto?.randomUUID) {
          stored = crypto.randomUUID();
        } else {
          stored = `device-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
        }
        localStorage.setItem(DEVICE_ID_KEY, stored);
      }
      state.deviceId = stored;
    }

    async function fetchPublicIP() {
      const resp = await fetch(PUBLIC_IP_ENDPOINT, { cache: 'no-store' });
      if (!resp.ok) throw new Error('IP lookup failed');
      return (await resp.text()).trim();
    }

    async function ensureSchoolInternetRequirement() {
      try {
        const ip = await fetchPublicIP();
        const snap = await schoolRef(scopedPath(`workers_settings/attendanceRules/schoolPublicIPs/${state.todayKey}`)).once('value');
        const allowed = snap.val() || {};
        if (!allowed[ip]) {
          toast('Connect to School Wi-Fi', 'warning');
          return { success: false };
        }
        return { success: true, publicIP: ip };
      } catch (err) {
        console.error('School IP verification failed', err);
        toast('Haikuweza kuthibitisha Wi-Fi ya shule. Jaribu tena.', 'error');
        return { success: false };
      }
    }

    async function verifyRotatingCodeEntry() {
      try {
        const snap = await schoolRef(scopedPath(`workers_settings/dailyCheckin/${state.todayKey}`)).once('value');
        const entry = snap.val();
        if (!entry?.code) {
          toast('Ask Headteacher to set code', 'warning');
          return { success: false };
        }
        const now = localTs();
        if (!entry.validFrom || !entry.validTo || now < entry.validFrom || now > entry.validTo) {
          toast('Ask Headteacher to set code', 'warning');
          return { success: false };
        }
        const codePrompt = prompt('Enter today\\'s rotating code:');
        if (!codePrompt) {
          toast('Msimbo unahitajika.', 'warning');
          return { success: false };
        }
        if (codePrompt.trim() !== entry.code) {
          toast('Invalid code', 'warning');
          return { success: false };
        }
        return { success: true, code: entry.code, validFrom: entry.validFrom, validTo: entry.validTo };
      } catch (err) {
        console.error('Rotating code check failed', err);
        toast('Hitilafu kuthibitisha msimbo. Jaribu tena.', 'error');
        return { success: false };
      }
    }

    async function ensureDeviceBinding() {
      const ref = schoolRef(`workers/${state.workerId}/security/deviceId`);
      const snap = await ref.once('value');
      const boundId = snap.exists() ? snap.val() : null;
      if (boundId && boundId !== state.deviceId) {
        toast('Device not authorized', 'warning');
        return { success: false };
      }
      return { success: true, ref, boundId };
    }

    async function preflightChecks() {
      const binding = await ensureDeviceBinding();
      if (!binding.success) return null;
      const methodParts = ['device_binding'];
      const rules = state.rules || DEFAULT_RULES;
      let publicIP = null;
      if (rules.requireSchoolInternet) {
        const internet = await ensureSchoolInternetRequirement();
        if (!internet.success) return null;
        methodParts.push('school_internet');
        publicIP = internet.publicIP;
      }
      let codeEntry = null;
      if (rules.rotatingCodeEnabled) {
        const codeResult = await verifyRotatingCodeEntry();
        if (!codeResult.success) return null;
        methodParts.push('rotating_code');
        codeEntry = codeResult;
      }
      return {
        method: methodParts.join('+'),
        publicIP,
        codeWindow: codeEntry?.code || null,
        validTo: codeEntry?.validTo || null,
        binding
      };
    }

    async function handleCheck(direction) {
      await ensureSystemYearForCheck();
      normalizeNow(false);
      await loadSettings();
      const onWifi = await enforceWifi();
      if (!onWifi) return;
      const verification = await preflightChecks();
      if (!verification) return;
      if (!verification.binding.boundId && direction === 'in') {
        await verification.binding.ref.set(state.deviceId);
      }
      const timestamp = localTs();
      const dayKey = state.todayKey;

      const dayRef = schoolRef(scopedPath(`workerAttendance/${state.workerId}/${state.monthKey}/${dayKey}`));
      const daySnap = await dayRef.once('value');
      const existing = daySnap.val() || {};

      if (direction === 'in' && existing.checkInTs) {
        toast('Ulishafanya check-in leo.', 'warning');
        return;
      }
      if (direction === 'out' && !existing.checkInTs) {
        toast('Hujafanya check-in bado.', 'warning');
        return;
      }

      const payload = direction === 'in'
        ? {
            checkInTs: timestamp,
            lateMinutes: computeLateMinutes(timestamp),
            approved: existing.approved ?? false
          }
        : {
            checkOutTs: timestamp,
            earlyMinutes: computeEarlyMinutes(timestamp)
          };

      const verificationFields = {
        method: verification.method,
        publicIP: verification.publicIP || null,
        deviceId: state.deviceId,
        codeWindow: verification.codeWindow,
        validTo: verification.validTo
      };
      Object.assign(payload, verificationFields);

      await dayRef.update(payload);
      await markPresent();
      await updateSummaries(existing, payload, direction, dayKey);

      toast(direction === 'in' ? 'Karibu kazini!' : 'Asante kwa kazi!', 'success');
      await refreshAll();
    }

    async function markPresent() {
      const presentRef = schoolRef(scopedPath(`dashboard/presentWorkers/${state.todayKey}/${state.workerId}`));
      await presentRef.set(true);
    }

    async function getSummaryRef() {
      return schoolRef(scopedPath(`workerAttendanceSummary/${state.workerId}/${state.monthKey}`));
    }

    async function updateSummaries(existing, payload, direction, dayKey) {
      const summaryRef = await getSummaryRef();
      const summarySnap = await summaryRef.once('value');
      const summary = summarySnap.val() || { daysPresent: 0, countLate: 0, countEarly: 0, finesTZS: 0 };
      let changed = false;
      let newCountLate = summary.countLate || 0;
      let newCountEarly = summary.countEarly || 0;
      let newFines = summary.finesTZS || 0;

      if (!existing.checkInTs && (payload.checkInTs || direction === 'in')) {
        summary.daysPresent = (summary.daysPresent || 0) + 1;
        changed = true;
      }
      if (direction === 'in' && (payload.lateMinutes || 0) > 0 && !(existing.lateMinutes > 0)) {
        newCountLate += 1;
        summary.countLate = newCountLate;
        changed = true;
        const addFine = await maybeAddPenalty('late', newCountLate, dayKey);
        newFines += addFine;
      }
      if (direction === 'out') {
        const early = payload.earlyMinutes || 0;
        if (early > 0 && !(existing.earlyMinutes > 0)) {
          newCountEarly += 1;
          summary.countEarly = newCountEarly;
          changed = true;
          const addFine = await maybeAddPenalty('early', newCountEarly, dayKey);
          newFines += addFine;
        }
      }
      if (newFines !== summary.finesTZS) {
        summary.finesTZS = newFines;
        changed = true;
      }
      if (changed) {
        await summaryRef.update(summary);
      }
    }

    async function maybeAddPenalty(kind, count, dayKey) {
      const rules = state.rules || DEFAULT_RULES;
      const threshold = kind === 'late' ? (rules.lateThreshold || 3) : (rules.earlyThreshold || 3);
      if (count < threshold) return 0;
      const penaltyRef = schoolRef(scopedPath(`workers_penalties_ledger/${state.workerId}/${state.monthKey}/${dayKey}-${kind}`));
      const existing = await penaltyRef.once('value');
      if (existing.exists()) return 0;
      const amount = Number(rules.deductionAmount || 0);
      const payload = {
        kind,
        count,
        amountTZS: amount,
        label: rules.deductionLabel || 'Posho ya Uwajibikaji',
        refPath: SOMAP.P(scopedPath(`workerAttendance/${state.workerId}/${state.monthKey}/${dayKey}`)),
        createdTs: localTs()
      };
      await penaltyRef.set(payload);
      return amount;
    }

    async function refreshAll() {
      await Promise.all([renderTable(), renderStats(), maybeShowAdminPanel()]);
    }

    function updateWifiStatus() {
      if (!wifiStatus) return;
      const rules = state.rules || DEFAULT_RULES;
      const ssids = Array.isArray(rules.allowedSsids) && rules.allowedSsids.length
        ? `SSID: ${rules.allowedSsids.join(', ')}`
        : 'Tumia Wi-Fi ya shule (SSID itawekwa na Mwalimu Mkuu).';
      const extras = [];
      if (rules.requireSchoolInternet) extras.push('IP ya umma lazima iwe ya shule.');
      if (rules.rotatingCodeEnabled) extras.push('Msimbo unaozunguka unahitajika.');
      const extraText = extras.join(' ');
      wifiStatus.textContent = rules.requireWifi
        ? `Mahudhurio hupokelewa ukiwa kwenye Wi-Fi ya shule. ${ssids} ${extraText}`.trim()
        : `Wi-Fi haitakiwi kwa sasa (imetolewa na Mwalimu Mkuu). ${extraText}`.trim();
    }

    function formatTs(ts) {
      if (!ts) return '—';
      return new Date(ts).toLocaleTimeString('sw-TZ', {
        timeZone: 'Africa/Nairobi',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    async function renderTable() {
      monthLabel.textContent = new Date().toLocaleString('sw-TZ', {
        timeZone: 'Africa/Nairobi',
        month: 'long',
        year: 'numeric'
      });
      attendanceTable.innerHTML = '';
      const { snap, source } = await scopedOrSocratesLegacy(
        scopedPath(`workerAttendance/${state.workerId}/${state.monthKey}`),
        `attendance/${state.workerId}/${state.monthKey}`
      );
      const data = snap.val() || {};
      const dayKeys = Object.keys(data).sort();
      dayKeys.forEach(dayKey => {
        const record = data[dayKey] || {};
        const row = document.createElement('tr');
        const approval = record.approved === true
          ? '<span class="pill success">Approved</span>'
          : record.approved === false
            ? '<span class="pill warning">Pending/Not approved</span>'
            : '<span class="pill info">Awaiting review</span>';
        row.innerHTML = `
          <td>${dayKey}${source === 'legacy' ? ' *' : ''}</td>
          <td>${formatTs(record.checkInTs)}</td>
          <td>${formatTs(record.checkOutTs)}</td>
          <td>${record.lateMinutes || 0}</td>
          <td>${record.earlyMinutes || 0}</td>
          <td>${approval}</td>
        `;
        attendanceTable.appendChild(row);
      });
    }

    async function renderStats() {
      const [attendanceSnap, penaltiesSnap, summarySnap] = await Promise.all([
        schoolRef(scopedPath(`workerAttendance/${state.workerId}/${state.monthKey}`)).once('value'),
        schoolRef(scopedPath(`workers_penalties_ledger/${state.workerId}/${state.monthKey}`)).once('value'),
        (await getSummaryRef()).once('value')
      ]);
      const attendance = attendanceSnap.val() || {};
      const summary = summarySnap.val() || {};
      let daysPresent = 0;
      let late = 0;
      let early = 0;
      Object.values(attendance).forEach((record) => {
        if (record.checkInTs) daysPresent += 1;
        if (record.lateMinutes > 0) late += 1;
        if (record.earlyMinutes > 0) early += 1;
      });
      const penalties = penaltiesSnap.val() || {};
      const finesTotal = Object.values(penalties).reduce((sum, p) => sum + Number(p.amountTZS || 0), 0);

      statPresent.textContent = daysPresent;
      statLate.textContent = late || summary.countLate || 0;
      statEarly.textContent = early || summary.countEarly || 0;
      statFines.textContent = (finesTotal || summary.finesTZS || 0).toLocaleString('sw-TZ');
    }

    async function maybeShowAdminPanel() {
      const role = (state.profile?.role || '').toLowerCase();
      const isHead = role.includes('head');
      if (!isHead) {
        adminPanel.style.display = 'none';
        return;
      }
      adminPanel.style.display = 'block';
      lateList.innerHTML = '';

      const now = new Date();
      const adminYear = String(now.getFullYear());
      const adminMonthKey = `${adminYear}${String(now.getMonth() + 1).padStart(2, '0')}`;
      const todayKey = todayYMD(now).replace(/-/g, '');
      const [{ snap: attendanceSnap }, { snap: workersSnap }] = await Promise.all([
        scopedOrSocratesLegacy(scopedPathForYear(adminYear, 'workerAttendance'), 'attendance'),
        scopedOrSocratesLegacy(scopedPathForYear(adminYear, 'workers'), 'workers')
      ]);
      const attendanceData = attendanceSnap.val() || {};
      const workerData = workersSnap.val() || {};

      Object.entries(attendanceData).forEach(([wId, months]) => {
        const todayRecord = months?.[adminMonthKey]?.[todayKey] || {};
        const profile = workerData[wId]?.profile || {};
        if (!todayRecord.checkInTs || todayRecord.lateMinutes > 0 || todayRecord.earlyMinutes > 0) {
          const li = document.createElement('li');
          li.innerHTML = `
            <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
              <div>
                <strong>${profile.fullNameUpper || wId}</strong> • ${profile.role || ''}
                <div class="hint">Late: ${todayRecord.lateMinutes || 0} mins | Early: ${todayRecord.earlyMinutes || 0} mins</div>
              </div>
              <div class="admin-actions">
                <button class="workers-btn secondary" data-approve="true" data-worker="${wId}">Approve</button>
                <button class="workers-btn secondary" data-approve="false" data-worker="${wId}">Reject</button>
              </div>
            </div>
          `;
          lateList.appendChild(li);
        }
      });

      lateList.onclick = async (event) => {
        const btn = event.target.closest('button[data-worker]');
        if (!btn) return;
        const wId = btn.dataset.worker;
        const approveValue = btn.dataset.approve === 'true';
        const dayRef = schoolRef(scopedPathForYear(adminYear, `workerAttendance/${wId}/${adminMonthKey}/${todayKey}`));
        await dayRef.update({ approved: approveValue });
        toast(`Entry ${approveValue ? 'approved' : 'rejected'}`, approveValue ? 'success' : 'warning');
        await refreshAll();
      };
    }
  </script>
</body>
</html>
