<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mahudhurio ya Kazi | SoMAp</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase/firebase-config.js"></script>
  <style>
    :root {
      --ink: #0f172a;
      --muted: #64748b;
      --card: #ffffff;
      --accent: #0ea5e9;
      --accent-2: #6366f1;
      --border: #e2e8f0;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg: #f8fafc;
    }
    body { background: var(--bg); color: var(--ink); font-family: 'Inter', system-ui, -apple-system, sans-serif; }
    main.page { max-width: 1100px; margin: 0 auto; padding: 20px 16px 48px; }
    .page__hero { display:flex; justify-content:space-between; gap:16px; align-items:center; flex-wrap:wrap; margin-bottom:20px; }
    .brand { display:flex; gap:14px; align-items:center; }
    .brand__logo { width:64px; height:64px; border-radius:16px; border:1px solid var(--border); background:#fff; object-fit:contain; padding:8px; }
    .brand__eyebrow { margin:0; color:var(--muted); font-weight:600; letter-spacing:0.2px; }
    .brand h1 { margin:2px 0; font-size:1.6rem; }
    .brand__school { margin:0; color:var(--muted); }
    .context { display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
    .context__chip { background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px 12px; min-width:200px; box-shadow:0 10px 30px rgba(15,23,42,0.04); }
    .context__chip label { font-size:0.85rem; color:var(--muted); display:block; margin-bottom:4px; }
    .context__chip select { width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:10px; }
    .context__wifi { font-size:0.95rem; color:var(--muted); }
    .summary-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; margin-bottom:18px; }
    .stat-card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:14px; box-shadow:0 12px 30px rgba(15,23,42,0.05); }
    .stat-label { color:var(--muted); font-size:0.88rem; margin-bottom:6px; }
    .stat-value { font-size:1.6rem; font-weight:800; }
    .stat-accent { color:var(--accent); }
    .stat-warning { color:var(--warning); }
    .stat-danger { color:var(--danger); }
    .stat-success { color:var(--success); }
    .workers-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:12px; }
    .workers-card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:0 12px 30px rgba(15,23,42,0.05); }
    .workers-card__header h2 { margin:0 0 4px; }
    .workers-card__subtitle { margin:0; color:var(--muted); }
    .workers-card__content { display:grid; gap:10px; margin-top:12px; }
    .workers-card__content label { font-weight:600; color:var(--ink); display:grid; gap:6px; }
    .workers-card__content input[type="file"] { border:1px dashed var(--border); border-radius:10px; padding:10px; background:#f8fafc; }
    .workers-btn { padding:10px 16px; border-radius:10px; border:0; background:linear-gradient(135deg,var(--accent),var(--accent-2)); color:#fff; font-weight:700; cursor:pointer; box-shadow:0 8px 18px rgba(14,165,233,0.25); }
    .workers-btn.secondary { background:#fff; color:var(--ink); border:1px solid var(--border); box-shadow:none; }
    .workers-table { width:100%; border-collapse:collapse; }
    .workers-table th, .workers-table td { padding:10px 8px; border-bottom:1px solid var(--border); font-size:0.95rem; }
    .workers-table th { text-align:left; color:var(--muted); font-weight:700; }
    .pill { display:inline-flex; align-items:center; gap:4px; padding:4px 10px; border-radius:999px; font-size:0.85rem; border:1px solid var(--border); background:#f8fafc; }
    .pill.success { background:#ecfdf3; border-color:#bbf7d0; color:#166534; }
    .pill.warning { background:#fffbeb; border-color:#fef3c7; color:#92400e; }
    .pill.danger { background:#fef2f2; border-color:#fee2e2; color:#991b1b; }
    .pill.info { background:#eff6ff; border-color:#dbeafe; color:#1d4ed8; }
    .admin-actions { display:flex; gap:6px; flex-wrap:wrap; }
    .hint { font-size:0.88rem; color:var(--muted); }
    @media (max-width: 640px) {
      .brand h1 { font-size:1.3rem; }
      .context__chip { width:100%; }
    }
  </style>
</head>
<body>
  <main class="page">
    <header class="page__hero">
      <div class="brand">
        <img id="school-logo-display" alt="School logo" class="brand__logo">
        <div>
          <p class="brand__eyebrow">SoMAp Workers</p>
          <h1>Mahudhurio | Attendance</h1>
          <p class="brand__school" id="schoolNameDisplay"></p>
        </div>
      </div>
      <div class="context">
        <div class="context__chip">
          <label for="yearSelect">Mwaka wa masomo</label>
          <select id="yearSelect" data-somap-year-select></select>
          <p class="hint" id="currentYearLabel"></p>
        </div>
        <div class="context__chip context__wifi" id="wifiStatus">Wi-Fi verification (beta) inatumika kuthibitisha uko shule.</div>
      </div>
    </header>

    <section class="summary-grid">
      <div class="stat-card">
        <div class="stat-label">Siku ulizohudhuria</div>
        <div class="stat-value stat-success" id="statPresent">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Spoti za kuchelewa</div>
        <div class="stat-value stat-warning" id="statLate">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Kuondoka mapema</div>
        <div class="stat-value stat-danger" id="statEarly">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Faini mwezi huu (TZS)</div>
        <div class="stat-value stat-accent" id="statFines">0</div>
      </div>
    </section>

    <section class="workers-grid">
      <div class="workers-card">
        <header class="workers-card__header">
          <h2>Check-In</h2>
          <p class="workers-card__subtitle">Piga picha + Wi-Fi kuthibitisha uko shuleni (hakuna GPS)</p>
        </header>
        <div class="workers-card__content">
          <label>Kumbukumbu ya Picha
            <input type="file" id="checkInPhoto" accept="image/*" capture="environment">
          </label>
          <button id="checkInBtn" class="workers-btn">Check-In Sasa</button>
          <p class="hint">Lazima kabla ya 07:20 (Africa/Nairobi). Baada ya mara ya 3 ya kuchelewa mwezi huu, faini 0.001 × basic salary × (countLate - 2).</p>
        </div>
      </div>

      <div class="workers-card">
        <header class="workers-card__header">
          <h2>Check-Out</h2>
          <p class="workers-card__subtitle">Ondoka kwa nidhamu (baada ya 16:30)</p>
        </header>
        <div class="workers-card__content">
          <label>Picha ya Kuondoka
            <input type="file" id="checkOutPhoto" accept="image/*" capture="environment">
          </label>
          <button id="checkOutBtn" class="workers-btn secondary">Check-Out Sasa</button>
          <p class="hint">Ukitoka kabla ya 16:30, kuondoka mapema hujilimbikiza na baada ya tukio la 3+, faini 0.001 × basic salary × (countEarly - 2).</p>
        </div>
      </div>
    </section>

    <section class="workers-card" style="margin-top:18px;">
      <header class="workers-card__header">
        <h2>Mahudhurio ya Mwezi</h2>
        <p id="monthLabel" class="workers-card__subtitle"></p>
      </header>
      <div class="workers-card__content">
        <table class="workers-table" id="attendanceTable">
          <thead>
            <tr>
              <th>Siku</th>
              <th>Check-In</th>
              <th>Check-Out</th>
              <th>Late (dakika)</th>
              <th>Early (dakika)</th>
              <th>Approval</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="workers-card" id="adminPanel" style="display:none; margin-top:18px;">
      <header class="workers-card__header">
        <h2>Headteacher - Leo</h2>
        <p class="workers-card__subtitle">Waangalie walioingia baada ya 07:20 au hawajaingia; thibitisha au katae</p>
      </header>
      <div class="workers-card__content">
        <ul id="lateList" style="list-style:none; padding-left:0; display:grid; gap:8px;"></ul>
      </div>
    </section>
  </main>

  <script type="module">
    import {
      ensureAnonymousAuth,
      getLinkedWorkerId,
      todayYMD,
      yyyymm,
      localTs,
      toast
    } from '../modules/workers_helpers.js';
    import { uploadFileToStorage } from '../modules/workers_ui.js';

    const checkInBtn = document.getElementById('checkInBtn');
    const checkOutBtn = document.getElementById('checkOutBtn');
    const checkInPhoto = document.getElementById('checkInPhoto');
    const checkOutPhoto = document.getElementById('checkOutPhoto');
    const attendanceTable = document.getElementById('attendanceTable').querySelector('tbody');
    const lateList = document.getElementById('lateList');
    const adminPanel = document.getElementById('adminPanel');
    const monthLabel = document.getElementById('monthLabel');
    const schoolNameEl = document.getElementById('schoolNameDisplay');
    const yearSelect = document.getElementById('yearSelect');
    const yearLabel = document.getElementById('currentYearLabel');
    const wifiStatus = document.getElementById('wifiStatus');
    const statPresent = document.getElementById('statPresent');
    const statLate = document.getElementById('statLate');
    const statEarly = document.getElementById('statEarly');
    const statFines = document.getElementById('statFines');

    const state = {
      school: null,
      schoolId: '',
      schoolName: '',
      legacyFriendly: false,
      year: '',
      monthKey: yyyymm(new Date()),
      today: todayYMD(),
      todayKey: todayYMD().replace(/-/g, ''),
      workerId: '',
      profile: null,
      settings: {}
    };

    const db = firebase.database();

    const DAY_START = '07:20';
    const DAY_END = '16:30';

    ensureAnonymousAuth()
      .then(init)
      .catch(err => {
        console.error(err);
        toast(err.message || 'Error', 'error');
        window.location.href = '../index.html';
      });

    function schoolRef(subPath) {
      return db.ref(SOMAP.P(subPath));
    }

    function scopedPathForYear(year, subPath) {
      return `years/${year}/${subPath}`;
    }

    function scopedPath(subPath) {
      return scopedPathForYear(state.year, subPath);
    }

    function normalizeNow(useSelectedYear = true) {
      const now = new Date();
      state.today = todayYMD(now);
      state.todayKey = state.today.replace(/-/g, '');
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const targetYear = useSelectedYear && state.year ? state.year : String(now.getFullYear());
      state.monthKey = `${targetYear}${month}`;
    }

    function setBranding() {
      if (schoolNameEl) schoolNameEl.textContent = state.schoolName;
      const logoEl = document.getElementById('school-logo-display');
      if (!logoEl) return;
      (async () => {
        try {
          let logoUrl = '';
          if (state.legacyFriendly) {
            logoUrl = '../images/socrates_logo.png';
          } else {
            const snap = await schoolRef('profile/logoUrl').get();
            logoUrl = snap.val() || '';
          }
          logoEl.src = logoUrl || '../images/socrates_logo.png';
          logoEl.alt = `${state.schoolName} logo`;
        } catch (err) {
          console.warn('Logo load failed', err);
          logoEl.src = '../images/socrates_logo.png';
        }
      })();
    }

    function initSchoolContext() {
      const school = (window.SOMAP && SOMAP.getSchool && SOMAP.getSchool()) || null;
      if (!school || !school.id) {
        window.location.href = '../somapappv1multischool/multischool.html';
        throw new Error('No school selected for multi-school context');
      }
      state.school = school;
      state.schoolId = school.id;
      state.schoolName = school.name || school.id;
      state.legacyFriendly = state.schoolId === 'socrates-school' || state.schoolId === 'default';
      setBranding();
    }

    function initYearContext() {
      const yearCtx = window.somapYearContext || null;
      const systemYear = String(new Date().getFullYear());
      const selected = String(yearCtx?.getSelectedYear?.() || systemYear);
      state.year = selected !== systemYear ? yearCtx.resetToCurrentYear?.() || systemYear : selected;
      const month = String(new Date().getMonth() + 1).padStart(2, '0');
      state.monthKey = `${state.year}${month}`;
      yearCtx?.attachYearDropdown?.(yearSelect);
      yearLabel.textContent = `Mwaka: ${state.year}`;
      yearCtx?.onYearChanged?.((yr) => {
        state.year = String(yr);
        yearLabel.textContent = `Mwaka: ${state.year}`;
        const monthRecalc = String(new Date().getMonth() + 1).padStart(2, '0');
        state.monthKey = `${state.year}${monthRecalc}`;
        refreshAll();
      });
    }

    function scopedOrSocratesLegacy(scopedSubPath, legacyPath) {
      return Promise.all([
        schoolRef(scopedSubPath).once('value'),
        state.legacyFriendly ? db.ref(legacyPath).once('value') : Promise.resolve({ exists: () => false, val: () => null })
      ]).then(([scopedSnap, legacySnap]) => {
        if (scopedSnap.exists()) return { snap: scopedSnap, source: 'scoped' };
        if (state.legacyFriendly && legacySnap.exists()) return { snap: legacySnap, source: 'legacy' };
        return { snap: scopedSnap, source: 'scoped' };
      });
    }

    async function init() {
      initSchoolContext();
      initYearContext();
      normalizeNow();

      const workerId = await getLinkedWorkerId();
      if (!workerId) {
        toast('Tafadhali ingia tena.', 'error');
        window.location.href = '../index.html';
        return;
      }
      state.workerId = workerId;

      await Promise.all([loadProfile(), loadSettings()]);
      await refreshAll();

      checkInBtn.addEventListener('click', () => handleCheck('in'));
      checkOutBtn.addEventListener('click', () => handleCheck('out'));
      wifiStatus.textContent = 'Wi-Fi check (beta): tutaunganisha SSID ya shule kuthibitisha uwepo. Kwa sasa, check-in hutumia kifaa hiki tu.';
    }

    async function loadProfile() {
      const { snap } = await scopedOrSocratesLegacy(
        scopedPath(`workers/${state.workerId}`),
        `workers/${state.workerId}`
      );
      if (!snap.exists()) throw new Error('Worker profile missing');
      state.profile = snap.val().profile || {};
      if (schoolNameEl && state.schoolName) {
        schoolNameEl.textContent = `${state.schoolName} • ${state.profile.role || ''}`.trim();
      }
    }

    async function loadSettings() {
      const { snap } = await scopedOrSocratesLegacy(
        'settings/workers',
        'settings/workers'
      );
      state.settings = snap.val() || {};
    }

    function computeLateMinutes(checkInTs) {
      const start = new Date(`${state.today}T${DAY_START}:00`);
      const startLocal = new Date(start.toLocaleString('en-US', { timeZone: 'Africa/Nairobi' }));
      const diff = checkInTs - startLocal.getTime();
      return diff > 0 ? Math.round(diff / 60000) : 0;
    }

    function computeEarlyMinutes(checkOutTs) {
      const end = new Date(`${state.today}T${DAY_END}:00`);
      const endLocal = new Date(end.toLocaleString('en-US', { timeZone: 'Africa/Nairobi' }));
      const diff = endLocal.getTime() - checkOutTs;
      return diff > 0 ? Math.round(diff / 60000) : 0;
    }

    async function handleCheck(direction) {
      const systemYear = String(new Date().getFullYear());
      if (state.year !== systemYear) {
        state.year = systemYear;
        window.somapYearContext?.setSelectedYear?.(systemYear, { manual: false, forceDispatch: true });
      }
      normalizeNow(false);
      const fileInput = direction === 'in' ? checkInPhoto : checkOutPhoto;
      if (!fileInput.files.length) {
        toast('Chagua au piga picha kwanza.', 'warning');
        return;
      }
      const file = fileInput.files[0];
      const timestamp = localTs();
      const dayKey = state.todayKey;
      const storagePath = `schools/${state.schoolId}/years/${state.year}/attendance/${state.workerId}/${dayKey}-${direction}-${Date.now()}.jpg`;
      const photoUrl = await uploadFileToStorage(file, storagePath);

      const dayRef = schoolRef(scopedPath(`attendance/${state.workerId}/${state.monthKey}/${dayKey}`));
      const daySnap = await dayRef.once('value');
      const existing = daySnap.val() || {};

      if (direction === 'in' && existing.checkInTs) {
        toast('Ulishafanya check-in leo.', 'warning');
        return;
      }
      if (direction === 'out' && !existing.checkInTs) {
        toast('Hujafanya check-in bado.', 'warning');
        return;
      }

      const payload = direction === 'in'
        ? {
            checkInTs: timestamp,
            checkInPhotoUrl: photoUrl,
            lateMinutes: computeLateMinutes(timestamp),
            approved: existing.approved ?? false
          }
        : {
            checkOutTs: timestamp,
            checkOutPhotoUrl: photoUrl,
            earlyMinutes: computeEarlyMinutes(timestamp)
          };

      await dayRef.update(payload);
      await markPresent();
      await updateSummaries(existing, payload, direction, dayKey);

      toast(direction === 'in' ? 'Karibu kazini!' : 'Asante kwa kazi!', 'success');
      fileInput.value = '';
      await refreshAll();
    }

    async function markPresent() {
      const presentRef = schoolRef(scopedPath(`dashboard/presentWorkers/${state.todayKey}/${state.workerId}`));
      await presentRef.set(true);
    }

    async function getSummaryRef() {
      return schoolRef(scopedPath(`attendanceSummary/${state.workerId}/${state.monthKey}`));
    }

    async function updateSummaries(existing, payload, direction, dayKey) {
      const summaryRef = await getSummaryRef();
      const summarySnap = await summaryRef.once('value');
      const summary = summarySnap.val() || { daysPresent: 0, countLate: 0, countEarly: 0, finesTZS: 0 };
      let changed = false;
      let newCountLate = summary.countLate || 0;
      let newCountEarly = summary.countEarly || 0;
      let newFines = summary.finesTZS || 0;

      if (!existing.checkInTs && (payload.checkInTs || direction === 'in')) {
        summary.daysPresent = (summary.daysPresent || 0) + 1;
        changed = true;
      }
      if (direction === 'in' && (payload.lateMinutes || 0) > 0 && !(existing.lateMinutes > 0)) {
        newCountLate += 1;
        summary.countLate = newCountLate;
        changed = true;
        const addFine = await maybeAddPenalty('late', newCountLate, dayKey);
        newFines += addFine;
      }
      if (direction === 'out') {
        const early = payload.earlyMinutes || 0;
        if (early > 0 && !(existing.earlyMinutes > 0)) {
          newCountEarly += 1;
          summary.countEarly = newCountEarly;
          changed = true;
          const addFine = await maybeAddPenalty('early', newCountEarly, dayKey);
          newFines += addFine;
        }
      }
      if (newFines !== summary.finesTZS) {
        summary.finesTZS = newFines;
        changed = true;
      }
      if (changed) {
        await summaryRef.update(summary);
      }
    }

    async function maybeAddPenalty(kind, count, dayKey) {
      if (count <= 2) return 0;
      const penaltyRef = schoolRef(scopedPath(`penalties/${state.workerId}/${state.monthKey}/${dayKey}-${kind}`));
      const existing = await penaltyRef.once('value');
      if (existing.exists()) return 0;
      const amount = Math.round(Number(state.profile?.baseSalary || 0) * 0.001 * (count - 2));
      const payload = {
        kind,
        count,
        amountTZS: amount,
        baseSalary: Number(state.profile?.baseSalary || 0),
        refPath: SOMAP.P(scopedPath(`attendance/${state.workerId}/${state.monthKey}/${dayKey}`)),
        createdTs: localTs()
      };
      await penaltyRef.set(payload);
      return amount;
    }

    async function refreshAll() {
      await Promise.all([renderTable(), renderStats(), maybeShowAdminPanel()]);
    }

    function formatTs(ts) {
      if (!ts) return '—';
      return new Date(ts).toLocaleTimeString('sw-TZ', {
        timeZone: 'Africa/Nairobi',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    async function renderTable() {
      monthLabel.textContent = new Date().toLocaleString('sw-TZ', {
        timeZone: 'Africa/Nairobi',
        month: 'long',
        year: 'numeric'
      });
      attendanceTable.innerHTML = '';
      const { snap, source } = await scopedOrSocratesLegacy(
        scopedPath(`attendance/${state.workerId}/${state.monthKey}`),
        `attendance/${state.workerId}/${state.monthKey}`
      );
      const data = snap.val() || {};
      const dayKeys = Object.keys(data).sort();
      dayKeys.forEach(dayKey => {
        const record = data[dayKey] || {};
        const row = document.createElement('tr');
        const approval = record.approved === true
          ? '<span class="pill success">Approved</span>'
          : record.approved === false
            ? '<span class="pill warning">Pending/Not approved</span>'
            : '<span class="pill info">Awaiting review</span>';
        row.innerHTML = `
          <td>${dayKey}${source === 'legacy' ? ' *' : ''}</td>
          <td>${formatTs(record.checkInTs)}</td>
          <td>${formatTs(record.checkOutTs)}</td>
          <td>${record.lateMinutes || 0}</td>
          <td>${record.earlyMinutes || 0}</td>
          <td>${approval}</td>
        `;
        attendanceTable.appendChild(row);
      });
    }

    async function renderStats() {
      const [attendanceSnap, penaltiesSnap, summarySnap] = await Promise.all([
        schoolRef(scopedPath(`attendance/${state.workerId}/${state.monthKey}`)).once('value'),
        schoolRef(scopedPath(`penalties/${state.workerId}/${state.monthKey}`)).once('value'),
        (await getSummaryRef()).once('value')
      ]);
      const attendance = attendanceSnap.val() || {};
      const summary = summarySnap.val() || {};
      let daysPresent = 0;
      let late = 0;
      let early = 0;
      Object.values(attendance).forEach((record) => {
        if (record.checkInTs) daysPresent += 1;
        if (record.lateMinutes > 0) late += 1;
        if (record.earlyMinutes > 0) early += 1;
      });
      const penalties = penaltiesSnap.val() || {};
      const finesTotal = Object.values(penalties).reduce((sum, p) => sum + Number(p.amountTZS || 0), 0);

      statPresent.textContent = daysPresent;
      statLate.textContent = late || summary.countLate || 0;
      statEarly.textContent = early || summary.countEarly || 0;
      statFines.textContent = (finesTotal || summary.finesTZS || 0).toLocaleString('sw-TZ');
    }

    async function maybeShowAdminPanel() {
      const role = (state.profile?.role || '').toLowerCase();
      const isHead = role.includes('head');
      if (!isHead) {
        adminPanel.style.display = 'none';
        return;
      }
      adminPanel.style.display = 'block';
      lateList.innerHTML = '';

      const now = new Date();
      const adminYear = String(now.getFullYear());
      const adminMonthKey = `${adminYear}${String(now.getMonth() + 1).padStart(2, '0')}`;
      const todayKey = todayYMD(now).replace(/-/g, '');
      const [{ snap: attendanceSnap }, { snap: workersSnap }] = await Promise.all([
        scopedOrSocratesLegacy(scopedPathForYear(adminYear, 'attendance'), 'attendance'),
        scopedOrSocratesLegacy(scopedPathForYear(adminYear, 'workers'), 'workers')
      ]);
      const attendanceData = attendanceSnap.val() || {};
      const workerData = workersSnap.val() || {};

      Object.entries(attendanceData).forEach(([wId, months]) => {
        const todayRecord = months?.[adminMonthKey]?.[todayKey] || {};
        const profile = workerData[wId]?.profile || {};
        if (!todayRecord.checkInTs || todayRecord.lateMinutes > 0 || todayRecord.earlyMinutes > 0) {
          const li = document.createElement('li');
          li.innerHTML = `
            <div style="display:flex; justify-content:space-between; gap:8px; align-items:center;">
              <div>
                <strong>${profile.fullNameUpper || wId}</strong> • ${profile.role || ''}
                <div class="hint">Late: ${todayRecord.lateMinutes || 0} mins | Early: ${todayRecord.earlyMinutes || 0} mins</div>
              </div>
              <div class="admin-actions">
                <button class="workers-btn secondary" data-approve="true" data-worker="${wId}">Approve</button>
                <button class="workers-btn secondary" data-approve="false" data-worker="${wId}">Reject</button>
              </div>
            </div>
          `;
          lateList.appendChild(li);
        }
      });

      lateList.onclick = async (event) => {
        const btn = event.target.closest('button[data-worker]');
        if (!btn) return;
        const wId = btn.dataset.worker;
        const approveValue = btn.dataset.approve === 'true';
        const dayRef = schoolRef(scopedPathForYear(adminYear, `attendance/${wId}/${adminMonthKey}/${todayKey}`));
        await dayRef.update({ approved: approveValue });
        toast(`Entry ${approveValue ? 'approved' : 'rejected'}`, approveValue ? 'success' : 'warning');
        await refreshAll();
      };
    }
  </script>
</body>
</html>
