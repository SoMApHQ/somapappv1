<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Academic Expense Approvals</title>
  <script src="../../somapappv1multischool/js/context.js"></script>
  <script src="../../Todashboardhtml/yearContext.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="../../firebase.js"></script>
  <script src="../../js/finance_cashbook.js"></script>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111b2f;
      --line: #334155;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --ok: #16a34a;
      --warn: #f59e0b;
      --bad: #dc2626;
      --accent: #2563eb;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background: radial-gradient(circle at 0% 0%, #1e293b, var(--bg)); color: var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .top { display: flex; flex-wrap: wrap; gap: 12px; align-items: end; justify-content: space-between; margin-bottom: 16px; }
    .chips { display: flex; gap: 10px; flex-wrap: wrap; }
    .chip { background: #1e293b; border: 1px solid var(--line); padding: 8px 10px; border-radius: 10px; color: var(--muted); }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px; cursor: pointer; }
    .card.active { border-color: #60a5fa; box-shadow: 0 0 0 1px #60a5fa inset; }
    .k { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .08em; }
    .v { font-size: 22px; font-weight: 700; margin-top: 6px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
    select, button { background: #0f172a; color: var(--text); border: 1px solid var(--line); border-radius: 8px; padding: 8px 10px; }
    button.primary { background: var(--accent); border-color: #1d4ed8; }
    button.ok { background: #14532d; border-color: #166534; }
    button.bad { background: #7f1d1d; border-color: #991b1b; }
    .panel { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #223047; text-align: left; padding: 10px 8px; font-size: 13px; vertical-align: top; }
    th { color: var(--muted); font-size: 12px; text-transform: uppercase; }
    .status { padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
    .pending { background: #78350f; color: #fde68a; }
    .approved { background: #14532d; color: #bbf7d0; }
    .rejected { background: #7f1d1d; color: #fecaca; }
    .empty { color: var(--muted); padding: 18px 0; }
    .small { font-size: 12px; color: var(--muted); }
    .loading { opacity: 0.6; pointer-events: none; }
    .section-title { font-size: 13px; color: var(--muted); margin: 16px 0 8px 0; text-transform: uppercase; letter-spacing: .08em; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 style="margin:0 0 6px 0;">Academic Expense Approvals</h1>
        <div class="small" id="schoolLabel">School: Socrates School</div>
        <script>
          (function(){try{var L=document.getElementById('schoolLabel');if(!L)return;
          var n='';var r=localStorage.getItem('somap.currentSchool');if(r){try{var p=JSON.parse(r);n=(p&&p.name&&p.name!=='-'?p.name:null)||(p&&p.id&&p.id!=='-'?p.id:null)||'';}catch(_){}}
          if(!n){var s=localStorage.getItem('somap.currentSchoolId')||localStorage.getItem('somap_school')||'socrates-school';n=(s==='socrates-school'||s==='socrates'||s==='default')?'Socrates School':s;}
          if(n)L.textContent='School: '+n;}catch(_){}})();
        </script>
      </div>
      <div class="toolbar">
        <label class="small" for="yearSelect">Year</label>
        <select id="yearSelect" data-somap-year-select data-somap-year-min="2024" data-somap-year-max="2042"></select>
        <a href="../workertasks.html"><button type="button">Back</button></a>
      </div>
    </div>

    <div class="chips" style="margin-bottom: 14px;">
      <div class="chip">Finance Received: <b id="financeReceived">TSh 0</b></div>
      <div class="chip">Finance Approved Spent: <b id="financeSpent">TSh 0</b></div>
      <div class="chip">Finance Pocket: <b id="financePocket">TSh 0</b></div>
    </div>

    <div class="cards" id="moduleCards"></div>

    <div class="panel">
      <div class="toolbar">
        <select id="statusFilter">
          <option value="all">All statuses</option>
          <option value="pending">Pending only</option>
          <option value="approved">Approved only</option>
          <option value="rejected">Rejected only</option>
        </select>
        <button type="button" id="allModulesBtn">Show All Modules</button>
        <button type="button" class="primary" id="refreshBtn">Refresh</button>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Requested</th>
              <th>Module</th>
              <th>Category</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Requested By</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div id="empty" class="empty" style="display:none;">No records for this filter.</div>
      <div id="recordedSection" style="display:none;">
        <div class="section-title" id="recordedSectionTitle">Recorded expenses</div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Recorded By</th>
              </tr>
            </thead>
            <tbody id="recordedRows"></tbody>
          </table>
        </div>
        <div id="recordedEmpty" class="empty" style="display:none;">No recorded expenses in this module yet.</div>
      </div>
    </div>
  </div>

  <script>
    (function setSchoolLabelFallback() {
      try {
        const label = document.getElementById('schoolLabel');
        if (!label) return;
        const isPlaceholder = (v) => !v || String(v).trim() === '' || String(v).trim() === '-';
        let schoolName = '';
        if (window.SOMAP?.getSchool) {
          const school = window.SOMAP.getSchool();
          if (school) {
            const n = school.name || school.id || '';
            if (!isPlaceholder(n)) schoolName = String(n).trim();
          }
        }
        if (!schoolName) {
          const rawMeta = localStorage.getItem('somap.currentSchool');
          if (rawMeta) {
            try {
              const parsed = JSON.parse(rawMeta);
              const n = parsed?.name || parsed?.id || '';
              if (!isPlaceholder(n)) schoolName = String(n).trim();
            } catch (_) {}
          }
        }
        if (!schoolName) {
          const sid =
            localStorage.getItem('somap.currentSchoolId') ||
            localStorage.getItem('somap_school') ||
            window.currentSchoolId ||
            'socrates-school';
          const id = String(sid || 'socrates-school').trim() || 'socrates-school';
          schoolName = (id === 'socrates-school' || id === 'socrates' || id === 'default') ? 'Socrates School' : id;
        }
        label.textContent = `School: ${schoolName}`;
      } catch (_) {}
    })();

    const db = window.db || firebase.database();
    const state = {
      year: String(window.somapYearContext?.getSelectedYear?.() || new Date().getFullYear()),
      moduleFilter: 'all',
      statusFilter: 'all',
      requests: {},
      recordedByModule: {},
      moduleExpenses: {},
      school: null,
      expenseApprovalsUseRoot: false,
      loading: false,
      approvalUnsubscribe: null,
    };

    function getModuleExpensePath(m, y) {
      if (m.key === 'preform_one') {
        const schoolName = String(state.school?.name || state.school?.id || 'Socrates School').trim() || 'Socrates School';
        return `schools/${schoolName} Preform one/${y}/expenses`;
      }
      return m.expensePath ? m.expensePath(y) : null;
    }

    const MODULES = [
      { key: 'finance', label: 'Finance Expense Approval', expensePath: (y) => `expenses/${y}` },
      { key: 'remedial', label: 'Remedial Expense Approval', expensePath: (y) => `remedial/expenses/${y}` },
      { key: 'transport', label: 'Transport Expense Approval', expensePath: (y) => `years/${y}/transport_expenses` },
      { key: 'preform_one', label: 'Preform One Expense Approval', expensePath: (y) => `schools/Socrates School Preform one/${y}/expenses` },
    ];

    const fmt = (n) => `TSh ${(Math.round(Number(n) || 0)).toLocaleString('en-US')}`;
    const dt = (v) => {
      const n = Number(v || 0);
      if (!n) return '-';
      return new Date(n).toLocaleString();
    };

    function normalizePath(path) {
      return String(path || '').replace(/^\/+/, '');
    }

    const isPlaceholder = (v) => !v || String(v || '').trim() === '' || String(v || '').trim() === '-';

    function getStoredSchoolMeta() {
      try {
        const raw = localStorage.getItem('somap.currentSchool');
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && parsed.id && !isPlaceholder(parsed.id)) return parsed;
        }
      } catch (_) {}
      return null;
    }

    function inferSchool() {
      const viaSomap = window.SOMAP?.getSchool?.();
      if (viaSomap && viaSomap.id && !isPlaceholder(viaSomap.id)) {
        const name = viaSomap.name || viaSomap.id;
        return { id: viaSomap.id, name: isPlaceholder(name) ? (viaSomap.id === 'socrates-school' ? 'Socrates School' : viaSomap.id) : name };
      }
      const stored = getStoredSchoolMeta();
      if (stored && stored.id) {
        const name = stored.name || stored.id;
        return { id: stored.id, name: isPlaceholder(name) ? (stored.id === 'socrates-school' ? 'Socrates School' : stored.id) : name };
      }
      const sid =
        localStorage.getItem('somap.currentSchoolId') ||
        localStorage.getItem('somap_school') ||
        window.currentSchoolId ||
        'socrates-school';
      const id = String(sid || 'socrates-school').trim() || 'socrates-school';
      const name = (id === 'socrates-school' || id === 'socrates' || id === 'default') ? 'Socrates School' : id;
      return { id, name };
    }

    function isSocratesLegacy(sid) {
      const s = String(sid || '').trim().toLowerCase();
      return s === 'socrates-school' || s === 'socrates' || s === 'default';
    }

    function schoolPath(path) {
      const clean = String(path || '').replace(/^\/+/, '');
      if (window.SOMAP?.P) {
        const p = window.SOMAP.P(clean);
        if (p) return p;
      }
      const sid = inferSchool()?.id || 'socrates-school';
      if (isSocratesLegacy(sid)) return clean;
      return `schools/${sid}/${clean}`;
    }

    function schoolRef(path) {
      return db.ref(schoolPath(path));
    }

    function rootRef(path) {
      return db.ref(String(path || '').replace(/^\/+/, ''));
    }

    function currentApprover() {
      return firebase.auth?.().currentUser?.email || localStorage.getItem('somap_workerName') || 'academic-teacher';
    }

    function normalizeRole(value) {
      return String(value || '').trim().toLowerCase();
    }

    function roleCandidates() {
      return [
        localStorage.getItem('somap_role'),
        sessionStorage.getItem('somap_role'),
        localStorage.getItem('role'),
        sessionStorage.getItem('role'),
      ]
        .map(normalizeRole)
        .filter(Boolean);
    }

    function isAcademicRole(role) {
      const r = normalizeRole(role);
      return r === 'academic teacher' || r === 'academic';
    }

    function enforceAcademicRole() {
      const roles = roleCandidates();
      if (roles.some(isAcademicRole)) return true;
      if (roles.length === 0) return true; // allow when role key missing in storage
      if (!roles.some(isAcademicRole)) {
        alert('This page is for Academic Teacher role only.');
        window.location.href = '../workertasks.html';
        return false;
      }
      return true;
    }

    function buildCards() {
      const wrap = document.getElementById('moduleCards');
      if (!wrap) return;
      wrap.innerHTML = MODULES.map((m) => {
        const records = Object.values(state.requests || {}).filter((r) => String(r.module || '').toLowerCase() === m.key);
        const pending = records.filter((r) => String(r.status || 'pending') === 'pending');
        const amount = pending.reduce((s, r) => s + (Number(r.amount) || 0), 0);
        const recorded = Number(state.recordedByModule?.[m.key] || 0);
        const active = state.moduleFilter === m.key ? 'active' : '';
        return `<div class="card ${active}" data-module="${m.key}"><div class="k">${m.label}</div><div class="v">${pending.length}</div><div class="small">Pending ${fmt(amount)}</div>${recorded > 0 ? `<div class="small" style="margin-top:4px;color:var(--ok);">Recorded: ${recorded}</div>` : ''}</div>`;
      }).join('');

      wrap.querySelectorAll('[data-module]').forEach((el) => {
        el.addEventListener('click', () => {
          state.moduleFilter = el.getAttribute('data-module') || 'all';
          buildCards();
          renderTable();
        });
      });
    }

    function renderTable() {
      const tbody = document.getElementById('rows');
      const empty = document.getElementById('empty');
      if (!tbody || !empty) return;
      const list = Object.entries(state.requests || {}).map(([id, row]) => ({ id, ...row }));
      const filtered = list
        .filter((r) => state.moduleFilter === 'all' || String(r.module || '').toLowerCase() === state.moduleFilter)
        .filter((r) => {
          if (state.statusFilter === 'all') return true;
          return String(r.status || 'pending') === state.statusFilter;
        })
        .sort((a, b) => Number(b.requestedAt || 0) - Number(a.requestedAt || 0));

      if (!filtered.length) {
        tbody.innerHTML = '';
        empty.style.display = '';
        return;
      }
      empty.style.display = 'none';

      tbody.innerHTML = filtered.map((r) => {
        const status = String(r.status || 'pending');
        const canAct = status === 'pending';
        const statusClass = status === 'approved' ? 'approved' : status === 'rejected' ? 'rejected' : 'pending';
        const reqAt = Number(r.requestedAt || r.createdAt || 0);
        return `
          <tr>
            <td>${dt(reqAt)}</td>
            <td>${r.moduleLabel || r.module || '-'}</td>
            <td>${r.category || '-'}</td>
            <td>${r.description || '-'}</td>
            <td>${fmt(r.amount)}</td>
            <td><span class="status ${statusClass}">${status}</span></td>
            <td>${r.requestedBy || '-'}</td>
            <td>
              ${canAct ? `<button class="ok" data-approve="${r.id}">Approve</button> <button class="bad" data-reject="${r.id}">Reject</button>` : '-'}
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('[data-approve]').forEach((btn) => {
        btn.addEventListener('click', () => approveRequest(btn.getAttribute('data-approve')));
      });
      tbody.querySelectorAll('[data-reject]').forEach((btn) => {
        btn.addEventListener('click', () => rejectRequest(btn.getAttribute('data-reject')));
      });

      renderRecordedExpenses();
    }

    function normalizeExpenseRow(row, moduleKey) {
      const ts = Number(row.timestamp || row.approvedAt || row.createdAt || 0);
      const dateStr = row.date || row.expenseDate || (ts ? new Date(ts).toLocaleDateString() : '-');
      const category = row.category || row.label || '-';
      const desc = row.description || row.label || '-';
      const amount = Number(row.amount) || 0;
      const by = row.approvedBy || row.createdBy || row.addedBy || '-';
      return { dateStr, category, desc, amount, by };
    }

    function renderRecordedExpenses() {
      const section = document.getElementById('recordedSection');
      const title = document.getElementById('recordedSectionTitle');
      const tbody = document.getElementById('recordedRows');
      const empty = document.getElementById('recordedEmpty');
      if (!section || !tbody) return;
      if (state.moduleFilter === 'all') {
        section.style.display = 'none';
        return;
      }
      const mod = MODULES.find((m) => m.key === state.moduleFilter);
      if (!mod) {
        section.style.display = 'none';
        return;
      }
      const expenses = state.moduleExpenses?.[state.moduleFilter] || [];
      section.style.display = '';
      if (title) title.textContent = `Recorded expenses â€“ ${mod.label}`;
      if (expenses.length === 0) {
        tbody.innerHTML = '';
        if (empty) empty.style.display = '';
        return;
      }
      if (empty) empty.style.display = 'none';
      const sorted = [...expenses].sort((a, b) => {
        const ta = Number(a.timestamp || a.approvedAt || a.createdAt || 0);
        const tb = Number(b.timestamp || b.approvedAt || b.createdAt || 0);
        return tb - ta;
      });
      tbody.innerHTML = sorted.map((r) => {
        const { dateStr, category, desc, amount, by } = normalizeExpenseRow(r, state.moduleFilter);
        return `<tr><td>${dateStr}</td><td>${category}</td><td>${desc}</td><td>${fmt(amount)}</td><td>${by}</td></tr>`;
      }).join('');
    }

    async function loadFinanceContext() {
      const y = state.year;
      const useRoot = isSocratesLegacy(state.school?.id || inferSchool()?.id);
      const fundingPath = `cashbook/${y}/funding`;
      const expensesPath = `expenses/${y}`;
      let [fundingSnap, expSnap] = await Promise.all([
        schoolRef(fundingPath).once('value'),
        schoolRef(expensesPath).once('value')
      ]);
      if (useRoot && !fundingSnap.exists() && !expSnap.exists()) {
        [fundingSnap, expSnap] = await Promise.all([
          rootRef(fundingPath).once('value'),
          rootRef(expensesPath).once('value')
        ]);
      }
      const fundingRaw = fundingSnap.val() || {};
      const expenseRaw = expSnap.val() || {};
      const fundingEntries = Array.isArray(fundingRaw)
        ? fundingRaw.filter(Boolean)
        : Object.entries(fundingRaw).map(([id, row]) => window.SomapFinanceCashbook?.normalizeFundingEntry?.(row, id) || row);
      const expenseEntries = Array.isArray(expenseRaw) ? expenseRaw.filter(Boolean) : Object.values(expenseRaw);
      const sum = window.SomapFinanceCashbook?.summarize?.({ fundingEntries, expenseEntries }) || {
        totalReceived: fundingEntries.reduce((s, r) => s + (Number(r.amount) || 0), 0),
        totalExpenses: expenseEntries.reduce((s, r) => s + (Number(r.amount) || 0), 0),
        inPocket: 0,
      };
      if (!Number.isFinite(sum.inPocket)) {
        sum.inPocket = Number(sum.totalReceived || 0) - Number(sum.totalExpenses || 0);
      }
      document.getElementById('financeReceived').textContent = fmt(sum.totalReceived || 0);
      document.getElementById('financeSpent').textContent = fmt(sum.totalExpenses || 0);
      document.getElementById('financePocket').textContent = fmt(sum.inPocket || 0);
    }

    async function loadRequests() {
      const path = `expenseApprovals/${state.year}`;
      let snap = await schoolRef(path).once('value');
      let data = snap.val() || {};
      state.expenseApprovalsUseRoot = false;
      if (Object.keys(data).length === 0 && isSocratesLegacy(state.school?.id || inferSchool()?.id)) {
        snap = await rootRef(path).once('value');
        data = snap.val() || {};
        state.expenseApprovalsUseRoot = Object.keys(data).length > 0;
      }
      state.requests = data;
    }

    function expenseApprovalRef(id) {
      const path = `expenseApprovals/${state.year}${id ? '/' + id : ''}`;
      return state.expenseApprovalsUseRoot ? rootRef(path) : schoolRef(path);
    }

    async function loadModuleRecordedCounts() {
      const y = state.year;
      const useRoot = isSocratesLegacy(state.school?.id || inferSchool()?.id);
      state.recordedByModule = {};
      await Promise.all(MODULES.map(async (m) => {
        const p = getModuleExpensePath(m, y);
        if (!p) return;
        try {
          const isPreform = m.key === 'preform_one';
          let snap = isPreform ? await rootRef(p).once('value') : await schoolRef(p).once('value');
          if (!isPreform && useRoot && !snap.exists()) snap = await rootRef(p).once('value');
          const val = snap.val();
          const count = Array.isArray(val) ? val.filter(Boolean).length : (val ? Object.keys(val).length : 0);
          state.recordedByModule[m.key] = count;
        } catch (_) {
          state.recordedByModule[m.key] = 0;
        }
      }));
    }

    async function loadModuleExpenses() {
      const y = state.year;
      const useRoot = isSocratesLegacy(state.school?.id || inferSchool()?.id);
      state.moduleExpenses = {};
      await Promise.all(MODULES.map(async (m) => {
        const p = getModuleExpensePath(m, y);
        if (!p) return;
        try {
          const isPreform = m.key === 'preform_one';
          let snap = isPreform ? await rootRef(p).once('value') : await schoolRef(p).once('value');
          if (!isPreform && useRoot && !snap.exists()) snap = await rootRef(p).once('value');
          const val = snap.val();
          const entries = Array.isArray(val) ? val.filter(Boolean) : (val ? Object.entries(val).map(([id, row]) => ({ id, ...row })) : []);
          state.moduleExpenses[m.key] = entries;
        } catch (_) {
          state.moduleExpenses[m.key] = [];
        }
      }));
    }

    async function approveRequest(id) {
      if (!id) return;
      const reqRef = expenseApprovalRef(id);
      const snap = await reqRef.once('value');
      const row = snap.val();
      if (!row || String(row.status || 'pending') !== 'pending') {
        alert('This request is already processed.');
        await refreshAll();
        return;
      }
      const targetPath = normalizePath(row.targetPath);
      if (!targetPath) {
        alert('Missing target path in request.');
        return;
      }
      const writer = db.ref(targetPath).push();
      await writer.set({
        ...(row.targetPayload || {}),
        approvedAt: firebase.database.ServerValue.TIMESTAMP,
        approvedBy: currentApprover(),
        approvalRequestId: id,
        approvalSource: 'academic_expense_approval',
      });
      await reqRef.update({
        status: 'approved',
        approvedAt: firebase.database.ServerValue.TIMESTAMP,
        approvedBy: currentApprover(),
        finalRecordPath: `${targetPath}/${writer.key}`,
      });
      await refreshAll();
    }

    async function rejectRequest(id) {
      if (!id) return;
      const reason = prompt('Reason for rejection (required):');
      if (!reason || !reason.trim()) return;
      await expenseApprovalRef(id).update({
        status: 'rejected',
        rejectedAt: firebase.database.ServerValue.TIMESTAMP,
        rejectedBy: currentApprover(),
        rejectionReason: String(reason).trim(),
      });
      await refreshAll();
    }

    async function refreshAll() {
      state.loading = true;
      const wrapEl = document.querySelector('.wrap');
      if (wrapEl) wrapEl.classList.add('loading');
      try {
        await loadRequests();
      } catch (err) {
        console.warn('Failed to load requests', err);
        state.requests = {};
      }
      try {
        await loadFinanceContext();
      } catch (err) {
        console.warn('Failed to load finance context', err);
      }
      try {
        await loadModuleRecordedCounts();
      } catch (err) {
        console.warn('Failed to load module recorded counts', err);
        state.recordedByModule = {};
      }
      try {
        await loadModuleExpenses();
      } catch (err) {
        console.warn('Failed to load module expenses', err);
        state.moduleExpenses = {};
      }
      buildCards();
      renderTable();
    } finally {
      state.loading = false;
      if (wrapEl) wrapEl.classList.remove('loading');
    }

    function setupFilters() {
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.value = state.statusFilter;
        statusFilter.addEventListener('change', (e) => {
          state.statusFilter = e.target.value || 'pending';
          renderTable();
        });
      }
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', refreshAll);
      const allModulesBtn = document.getElementById('allModulesBtn');
      if (allModulesBtn) {
        allModulesBtn.addEventListener('click', () => {
          state.moduleFilter = 'all';
          buildCards();
          renderTable();
        });
      }
    }

    async function init() {
      if (!enforceAcademicRole()) return;
      if (window.SOMAP?.init) {
        window.SOMAP.init({
          db,
          allowQuerySchoolParam: true,
          redirectIfMissingSchool: false,
          multischoolPath: '../../somapappv1multischool/multischool.html',
        });
      }
      state.school = inferSchool();
      if (!state.school || !state.school.id) {
        window.location.href = '../../somapappv1multischool/multischool.html';
        return;
      }
      const schoolLabelEl = document.getElementById('schoolLabel');
      if (schoolLabelEl) schoolLabelEl.textContent = `School: ${state.school.name || state.school.id}`;

      const yearSelect = document.getElementById('yearSelect');
      window.somapYearContext?.attachYearDropdown?.(yearSelect);
      yearSelect.value = String(window.somapYearContext?.getSelectedYear?.() || state.year);
      state.year = String(yearSelect.value || state.year);
      yearSelect.addEventListener('change', async (e) => {
        state.year = String(e.target.value || state.year);
        window.somapYearContext?.setSelectedYear?.(state.year);
        await refreshAll();
        setupRealtimeApprovals();
      });

      setupFilters();
      await refreshAll();
      setupRealtimeApprovals();
    }

    function setupRealtimeApprovals() {
      if (state.approvalUnsubscribe) {
        state.approvalUnsubscribe();
        state.approvalUnsubscribe = null;
      }
      const path = `expenseApprovals/${state.year}`;
      const ref = state.expenseApprovalsUseRoot ? rootRef(path) : schoolRef(path);
      state.approvalUnsubscribe = ref.on('value', (snap) => {
        const data = snap.val() || {};
        state.requests = data;
        buildCards();
        renderTable();
      });
    }

    init().catch((err) => {
      console.error('expense_approvals init failed:', err);
      const schoolLabelEl = document.getElementById('schoolLabel');
      if (schoolLabelEl && schoolLabelEl.textContent.trim() === 'School: -') {
        schoolLabelEl.textContent = 'School: Socrates School';
      }
    });
  </script>
</body>
</html>
