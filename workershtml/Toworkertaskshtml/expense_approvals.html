<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Academic Expense Approvals</title>
  <script src="../../somapappv1multischool/js/context.js"></script>
  <script src="../../Todashboardhtml/yearContext.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="../../firebase.js"></script>
  <script src="../../js/finance_cashbook.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --bg: #0b1220;
      --card: #111b2f;
      --line: #334155;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --ok: #16a34a;
      --warn: #f59e0b;
      --bad: #dc2626;
      --accent: #2563eb;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Arial, sans-serif; background: radial-gradient(circle at 0% 0%, #1e293b, var(--bg)); color: var(--text); }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .top { display: flex; flex-wrap: wrap; gap: 12px; align-items: end; justify-content: space-between; margin-bottom: 16px; }
    .chips { display: flex; gap: 10px; flex-wrap: wrap; }
    .chip { background: #1e293b; border: 1px solid var(--line); padding: 8px 10px; border-radius: 10px; color: var(--muted); }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px; cursor: pointer; }
    .card.active { border-color: #60a5fa; box-shadow: 0 0 0 1px #60a5fa inset; }
    .k { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: .08em; }
    .v { font-size: 22px; font-weight: 700; margin-top: 6px; }
    .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 10px; }
    select, button { background: #0f172a; color: var(--text); border: 1px solid var(--line); border-radius: 8px; padding: 8px 10px; }
    button.primary { background: var(--accent); border-color: #1d4ed8; }
    button.ok { background: #14532d; border-color: #166534; }
    button.bad { background: #7f1d1d; border-color: #991b1b; }
    .panel { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #223047; text-align: left; padding: 10px 8px; font-size: 13px; vertical-align: top; }
    th { color: var(--muted); font-size: 12px; text-transform: uppercase; }
    .status { padding: 4px 8px; border-radius: 999px; font-size: 11px; font-weight: 700; }
    .pending { background: #78350f; color: #fde68a; }
    .approved { background: #14532d; color: #bbf7d0; }
    .rejected { background: #7f1d1d; color: #fecaca; }
    .empty { color: var(--muted); padding: 18px 0; }
    .small { font-size: 12px; color: var(--muted); }
    .loading { opacity: 0.6; pointer-events: none; }
    .section-title { font-size: 13px; color: var(--muted); margin: 16px 0 8px 0; text-transform: uppercase; letter-spacing: .08em; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1 style="margin:0 0 6px 0;">Academic Expense Approvals</h1>
        <div class="small" id="schoolLabel">School: Socrates School</div>
        <script>
          (function(){try{var L=document.getElementById('schoolLabel');if(!L)return;
          var n='';var r=localStorage.getItem('somap.currentSchool');if(r){try{var p=JSON.parse(r);n=(p&&p.name&&p.name!=='-'?p.name:null)||(p&&p.id&&p.id!=='-'?p.id:null)||'';}catch(_){}}
          if(!n){var s=localStorage.getItem('somap.currentSchoolId')||localStorage.getItem('somap_school')||'socrates-school';n=(s==='socrates-school'||s==='socrates'||s==='default')?'Socrates School':s;}
          if(n)L.textContent='School: '+n;}catch(_){}})();
        </script>
      </div>
      <div class="toolbar">
        <label class="small" for="yearSelect">Year</label>
        <select id="yearSelect" data-somap-year-select data-somap-year-min="2024" data-somap-year-max="2042"></select>
        <a href="../workertasks.html"><button type="button">Back</button></a>
      </div>
    </div>

    <div class="chips" style="margin-bottom: 14px;">
      <div class="chip">Finance Received: <b id="financeReceived">TSh 0</b></div>
      <div class="chip">Finance Approved Spent: <b id="financeSpent">TSh 0</b></div>
      <div class="chip">Finance Pocket: <b id="financePocket">TSh 0</b></div>
    </div>

    <div class="cards" id="moduleCards"></div>

    <div class="panel">
      <div class="toolbar">
        <select id="statusFilter">
          <option value="all">All statuses</option>
          <option value="pending">Pending only</option>
          <option value="approved">Approved only</option>
          <option value="rejected">Rejected only</option>
        </select>
        <button type="button" id="allModulesBtn" style="display:none;">Show All Modules</button>
        <button type="button" class="primary" id="refreshBtn">Refresh</button>
        <button type="button" id="downloadCsvBtn">Download CSV</button>
        <button type="button" id="downloadPdfBtn">Download PDF</button>
      </div>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Requested</th>
              <th>Module</th>
              <th>Category</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Status</th>
              <th>Requested By</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
      <div id="empty" class="empty" style="display:none;">No records for this filter. Submit an expense from Finance, Remedial, or Transport first—they will appear here for approval.</div>
      <div id="emptyHint" class="small" style="display:none;margin-top:8px;padding:10px;background:#1e293b;border-radius:8px;border:1px solid var(--line);">
        <strong>If you expected to see items:</strong> (1) Ensure the <b>Year</b> dropdown matches the year used in Finance when you submitted. (2) Check the debug info below for permission errors.
      </div>
      <div id="approvalDebug" class="small" style="margin:8px 0 4px 0;padding:8px;background:#1e293b;border-radius:8px;border:1px solid var(--line);"></div>
      <div id="recordedSection" style="display:none;">
        <div class="section-title" id="recordedSectionTitle">Recorded expenses</div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr id="recordedTableHeader">
                <th>Date</th>
                <th>Category</th>
                <th>Description</th>
                <th>Amount</th>
                <th>Recorded By</th>
              </tr>
            </thead>
            <tbody id="recordedRows"></tbody>
          </table>
        </div>
        <div id="recordedEmpty" class="empty" style="display:none;">No recorded expenses in this module yet.</div>
      </div>
    </div>
  </div>

  <script>
    (function setSchoolLabelFallback() {
      try {
        const label = document.getElementById('schoolLabel');
        if (!label) return;
        const isPlaceholder = (v) => !v || String(v).trim() === '' || String(v).trim() === '-';
        let schoolName = '';
        if (window.SOMAP?.getSchool) {
          const school = window.SOMAP.getSchool();
          if (school) {
            const n = school.name || school.id || '';
            if (!isPlaceholder(n)) schoolName = String(n).trim();
          }
        }
        if (!schoolName) {
          const rawMeta = localStorage.getItem('somap.currentSchool');
          if (rawMeta) {
            try {
              const parsed = JSON.parse(rawMeta);
              const n = parsed?.name || parsed?.id || '';
              if (!isPlaceholder(n)) schoolName = String(n).trim();
            } catch (_) {}
          }
        }
        if (!schoolName) {
          const sid =
            localStorage.getItem('somap.currentSchoolId') ||
            localStorage.getItem('somap_school') ||
            window.currentSchoolId ||
            'socrates-school';
          const id = String(sid || 'socrates-school').trim() || 'socrates-school';
          schoolName = (id === 'socrates-school' || id === 'socrates' || id === 'default') ? 'Socrates School' : id;
        }
        label.textContent = `School: ${schoolName}`;
      } catch (_) {}
    })();

    const db = window.db || firebase.database();
    const state = {
      year: String(
        new URLSearchParams(window.location.search || '').get('year') ||
        window.somapYearContext?.getSelectedYear?.() ||
        (() => { try { return sessionStorage.getItem('somap_selected_year'); } catch (_) { return null; } })() ||
        new Date().getFullYear()
      ),
      moduleFilter: 'finance',
      statusFilter: 'all',
      requests: {},
      requestMetaById: {},
      recordedByModule: {},
      moduleExpenses: {},
      school: null,
      approvalBasePaths: [],
      lastApprovalErrors: [],
      loading: false,
      approvalUnsubscribe: [],
    };

    function getModuleExpensePath(m, y) {
      return m.expensePath ? m.expensePath(y) : null;
    }

    const MODULES = [
      { key: 'finance', label: 'Finance Expense Approval', expensePath: (y) => `expenses/${y}` },
      { key: 'remedial', label: 'Remedial Expense Approval', expensePath: (y) => `remedial/expenses/${y}` },
      { key: 'transport', label: 'Transport Expense Approval', expensePath: (y) => `years/${y}/transport_expenses` },
    ];

    const fmt = (n) => `TSh ${(Math.round(Number(n) || 0)).toLocaleString('en-US')}`;
    const dt = (v) => {
      const n = Number(v || 0);
      if (!n) return '-';
      return new Date(n).toLocaleString();
    };

    function normalizePath(path) {
      return String(path || '').replace(/^\/+/, '');
    }

    function normalizeSchoolId(sid) {
      const raw = String(sid || '').trim();
      if (!raw) return '';
      const lowered = raw.toLowerCase();
      if (
        lowered === 'socrates school' ||
        lowered === 'socrates school pre and primary' ||
        lowered === 'socrates school pre & primary' ||
        lowered === 'socrates-school' ||
        lowered === 'socrates' ||
        lowered === 'default'
      ) {
        return 'socrates-school';
      }
      return raw;
    }

    const isPlaceholder = (v) => !v || String(v || '').trim() === '' || String(v || '').trim() === '-';

    function getStoredSchoolMeta() {
      try {
        const raw = localStorage.getItem('somap.currentSchool');
        if (raw) {
          const parsed = JSON.parse(raw);
          if (parsed && parsed.id && !isPlaceholder(parsed.id)) return parsed;
        }
      } catch (_) {}
      return null;
    }

    function inferSchool() {
      const viaSomap = window.SOMAP?.getSchool?.();
      if (viaSomap && viaSomap.id && !isPlaceholder(viaSomap.id)) {
        const id = normalizeSchoolId(viaSomap.id);
        const name = viaSomap.name || id;
        return { id, name: isPlaceholder(name) ? (isSocratesLegacy(id) ? 'Socrates School' : id) : name };
      }
      const stored = getStoredSchoolMeta();
      if (stored && stored.id) {
        const id = normalizeSchoolId(stored.id);
        const name = stored.name || id;
        return { id, name: isPlaceholder(name) ? (isSocratesLegacy(id) ? 'Socrates School' : id) : name };
      }
      const sid =
        localStorage.getItem('somap.currentSchoolId') ||
        localStorage.getItem('somap_school') ||
        window.currentSchoolId ||
        'socrates-school';
      const id = normalizeSchoolId(String(sid || 'socrates-school').trim() || 'socrates-school');
      const name = isSocratesLegacy(id) ? 'Socrates School' : id;
      return { id, name };
    }

    function isSocratesLegacy(sid) {
      const s = normalizeSchoolId(sid).toLowerCase();
      return s === 'socrates-school' || s === 'socrates' || s === 'default';
    }

    function schoolPath(path) {
      const clean = String(path || '').replace(/^\/+/, '');
      const sid = normalizeSchoolId(inferSchool()?.id || 'socrates-school');
      if (isSocratesLegacy(sid)) return clean;
      return `schools/${sid}/${clean}`;
    }

    function schoolIdVariants() {
      const values = [
        state.school?.id,
        window.SOMAP?.getSchool?.()?.id,
        window.currentSchoolId,
        localStorage.getItem('somap.currentSchoolId'),
        localStorage.getItem('somap_school'),
      ].map((v) => String(v || '').trim()).filter(Boolean);
      const uniq = new Set(values);
      const normalized = values.map((v) => normalizeSchoolId(v)).filter(Boolean);
      normalized.forEach((v) => uniq.add(v));
      return Array.from(uniq);
    }

    function schoolRef(path) {
      const p = schoolPath(path);
      return db.ref(p);
    }

    function rootRef(path) {
      return db.ref(String(path || '').replace(/^\/+/, ''));
    }

    function schoolsSocratesRef(subpath) {
      const clean = String(subpath || '').replace(/^\/+/, '');
      return db.ref(clean ? `schools/socrates-school/${clean}` : 'schools/socrates-school');
    }

    function currentApprover() {
      return firebase.auth?.().currentUser?.email || localStorage.getItem('somap_workerName') || 'academic-teacher';
    }

    function normalizeRole(value) {
      return String(value || '').trim().toLowerCase();
    }

    function roleCandidates() {
      return [
        localStorage.getItem('somap_role'),
        sessionStorage.getItem('somap_role'),
        localStorage.getItem('role'),
        sessionStorage.getItem('role'),
      ]
        .map(normalizeRole)
        .filter(Boolean);
    }

    function isAcademicRole(role) {
      const r = normalizeRole(role);
      return r === 'academic teacher' || r === 'academic';
    }

    function enforceAcademicRole() {
      const roles = roleCandidates();
      if (roles.some(isAcademicRole)) return true;
      if (roles.length === 0) return true; // allow when role key missing in storage
      if (!roles.some(isAcademicRole)) {
        alert('This page is for Academic Teacher role only.');
        window.location.href = '../workertasks.html';
        return false;
      }
      return true;
    }

    function buildCards() {
      const wrap = document.getElementById('moduleCards');
      if (!wrap) return;
      const allRecords = Object.values(state.requests || {});
      const financeRecords = allRecords.filter((r) => String(r.module || '').toLowerCase() === 'finance');
      const financePending = financeRecords.filter((r) => String(r.status || 'pending') === 'pending');
      const financeAmount = financePending.reduce((s, r) => s + (Number(r.amount) || 0), 0);
      const recorded = Number(state.recordedByModule?.finance || 0);
      const active = state.moduleFilter === 'finance' ? 'active' : '';
      wrap.innerHTML = `<div class="card ${active}" data-module="finance"><div class="k">Finance Expense Approval</div><div class="v">${financePending.length}</div><div class="small">Pending ${fmt(financeAmount)}</div>${recorded > 0 ? `<div class="small" style="margin-top:4px;color:var(--ok);">Recorded: ${recorded}</div>` : ''}</div>`;

      wrap.querySelectorAll('[data-module]').forEach((el) => {
        el.addEventListener('click', () => {
          state.moduleFilter = el.getAttribute('data-module') || 'all';
          buildCards();
          renderTable();
        });
      });
    }

    function renderTable() {
      const tbody = document.getElementById('rows');
      const empty = document.getElementById('empty');
      const emptyHint = document.getElementById('emptyHint');
      if (!tbody || !empty) return;
      const list = Object.entries(state.requests || {}).map(([id, row]) => ({ id, ...row }));
      const filtered = list
        .filter((r) => state.moduleFilter === 'all' || String(r.module || '').toLowerCase() === state.moduleFilter)
        .filter((r) => {
          if (state.statusFilter === 'all') return true;
          return String(r.status || 'pending') === state.statusFilter;
        })
        .sort((a, b) => Number(b.requestedAt || 0) - Number(a.requestedAt || 0));

      if (!filtered.length) {
        tbody.innerHTML = '';
        empty.style.display = '';
        if (emptyHint) emptyHint.style.display = (Object.keys(state.requests || {}).length === 0) ? '' : 'none';
        return;
      }
      empty.style.display = 'none';
      if (emptyHint) emptyHint.style.display = 'none';

      tbody.innerHTML = filtered.map((r) => {
        const status = String(r.status || 'pending');
        const canAct = status === 'pending';
        const statusClass = (status === 'approved' || status === 'recorded') ? 'approved' : status === 'rejected' ? 'rejected' : 'pending';
        const reqAt = Number(r.requestedAt || r.createdAt || 0);
        return `
          <tr>
            <td>${dt(reqAt)}</td>
            <td>${r.moduleLabel || r.module || '-'}</td>
            <td>${r.category || '-'}</td>
            <td>${r.description || '-'}</td>
            <td>${fmt(r.amount)}</td>
            <td><span class="status ${statusClass}">${status}</span></td>
            <td>${r.requestedBy || '-'}</td>
            <td>
              ${canAct ? `<button class="ok" data-approve="${r.id}">Approve</button> <button class="bad" data-reject="${r.id}">Reject</button>` : '-'}
            </td>
          </tr>
        `;
      }).join('');

      tbody.querySelectorAll('[data-approve]').forEach((btn) => {
        btn.addEventListener('click', () => approveRequest(btn.getAttribute('data-approve')));
      });
      tbody.querySelectorAll('[data-reject]').forEach((btn) => {
        btn.addEventListener('click', () => rejectRequest(btn.getAttribute('data-reject')));
      });

      renderRecordedExpenses();
    }

    function normalizeExpenseRow(row, moduleKey) {
      const ts = Number(row.timestamp || row.approvedAt || row.createdAt || 0);
      const dateStr = row.date || row.expenseDate || (ts ? new Date(ts).toLocaleDateString() : '-');
      const category = row.category || row.label || '-';
      const desc = row.description || row.label || '-';
      const amount = Number(row.amount) || 0;
      const by = row.approvedBy || row.createdBy || row.addedBy || '-';
      return { dateStr, category, desc, amount, by };
    }

    function renderRecordedExpenses() {
      const section = document.getElementById('recordedSection');
      const title = document.getElementById('recordedSectionTitle');
      const headerRow = document.getElementById('recordedTableHeader');
      const tbody = document.getElementById('recordedRows');
      const empty = document.getElementById('recordedEmpty');
      if (!section || !tbody) return;
      section.style.display = '';
      if (state.moduleFilter === 'all') {
        const allExpenses = [];
        MODULES.forEach((m) => {
          (state.moduleExpenses?.[m.key] || []).forEach((r) => allExpenses.push({ ...r, _module: m.label }));
        });
        if (title) title.textContent = 'Recorded expenses – All Modules (Finance, Remedial, Transport)';
        if (headerRow) headerRow.innerHTML = '<th>Date</th><th>Module</th><th>Category</th><th>Description</th><th>Amount</th><th>Recorded By</th>';
        if (allExpenses.length === 0) {
          tbody.innerHTML = '';
          if (empty) empty.style.display = '';
          return;
        }
        if (empty) empty.style.display = 'none';
        const sorted = [...allExpenses].sort((a, b) => (Number(b.timestamp || b.approvedAt || 0) - Number(a.timestamp || a.approvedAt || 0)));
        tbody.innerHTML = sorted.map((r) => {
          const { dateStr, category, desc, amount, by } = normalizeExpenseRow(r, '');
          return `<tr><td>${dateStr}</td><td>${r._module || '-'}</td><td>${category}</td><td>${desc}</td><td>${fmt(amount)}</td><td>${by}</td></tr>`;
        }).join('');
        return;
      }
      const mod = MODULES.find((m) => m.key === state.moduleFilter);
      if (!mod) {
        section.style.display = 'none';
        return;
      }
      if (headerRow) headerRow.innerHTML = '<th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Recorded By</th>';
      const expenses = state.moduleExpenses?.[state.moduleFilter] || [];
      if (title) title.textContent = `Recorded expenses – ${mod.label}`;
      if (expenses.length === 0) {
        tbody.innerHTML = '';
        if (empty) empty.style.display = '';
        return;
      }
      if (empty) empty.style.display = 'none';
      const sorted = [...expenses].sort((a, b) => (Number(b.timestamp || b.approvedAt || 0) - Number(a.timestamp || a.approvedAt || 0)));
      tbody.innerHTML = sorted.map((r) => {
        const { dateStr, category, desc, amount, by } = normalizeExpenseRow(r, state.moduleFilter);
        return `<tr><td>${dateStr}</td><td>${category}</td><td>${desc}</td><td>${fmt(amount)}</td><td>${by}</td></tr>`;
      }).join('');
    }

    async function loadFinanceContext() {
      const y = state.year;
      const useRoot = isSocratesLegacy(state.school?.id || inferSchool()?.id);
      const fundingPath = `cashbook/${y}/funding`;
      const expensesPath = `expenses/${y}`;
      let [fundingSnap, expSnap] = await Promise.all([
        schoolRef(fundingPath).once('value'),
        schoolRef(expensesPath).once('value')
      ]);
      if (useRoot && !fundingSnap.exists() && !expSnap.exists()) {
        [fundingSnap, expSnap] = await Promise.all([
          rootRef(fundingPath).once('value'),
          rootRef(expensesPath).once('value')
        ]);
      }
      if (useRoot && !fundingSnap.exists() && !expSnap.exists()) {
        [fundingSnap, expSnap] = await Promise.all([
          schoolsSocratesRef(fundingPath).once('value'),
          schoolsSocratesRef(expensesPath).once('value')
        ]);
      }
      const fundingRaw = fundingSnap.val() || {};
      const expenseRaw = expSnap.val() || {};
      const fundingEntries = Array.isArray(fundingRaw)
        ? fundingRaw.filter(Boolean)
        : Object.entries(fundingRaw).map(([id, row]) => window.SomapFinanceCashbook?.normalizeFundingEntry?.(row, id) || row);
      const expenseEntries = Array.isArray(expenseRaw) ? expenseRaw.filter(Boolean) : Object.values(expenseRaw);
      const sum = window.SomapFinanceCashbook?.summarize?.({ fundingEntries, expenseEntries }) || {
        totalReceived: fundingEntries.reduce((s, r) => s + (Number(r.amount) || 0), 0),
        totalExpenses: expenseEntries.reduce((s, r) => s + (Number(r.amount) || 0), 0),
        inPocket: 0,
      };
      if (!Number.isFinite(sum.inPocket)) {
        sum.inPocket = Number(sum.totalReceived || 0) - Number(sum.totalExpenses || 0);
      }
      document.getElementById('financeReceived').textContent = fmt(sum.totalReceived || 0);
      document.getElementById('financeSpent').textContent = fmt(sum.totalExpenses || 0);
      document.getElementById('financePocket').textContent = fmt(sum.inPocket || 0);
    }

    function uniqPaths(paths) {
      const seen = new Set();
      return (paths || []).map((p) => normalizePath(p).replace(/\/+/g, '/')).filter((p) => {
        if (!p || seen.has(p)) return false;
        seen.add(p);
        return true;
      });
    }

    function candidateApprovalBasePaths(year) {
      const y = String(year || state.year || new Date().getFullYear());
      const queuePath = `years/${y}/expenseApprovals`;
      const canonicalPath = window.SOMAP?.P ? window.SOMAP.P(queuePath) : queuePath;
      const sid = normalizeSchoolId(state.school?.id || inferSchool()?.id || window.SOMAP?.getSchoolId?.() || 'socrates-school');
      const raw = [
        canonicalPath,
        queuePath,
        `schools/socrates-school/${queuePath}`,
        `schools/${sid}/${queuePath}`,
      ];
      return uniqPaths(raw);
    }

    function getExpenseApprovalRefs() {
      const basePaths = candidateApprovalBasePaths(state.year);
      state.approvalBasePaths = basePaths;
      return basePaths.map((basePath) => ({ basePath, ref: db.ref(basePath) }));
    }

    function mergeApprovalRows(rowsByPath, year) {
      const merged = {};
      state.requestMetaById = {};
      Object.entries(rowsByPath || {}).forEach(([basePath, data]) => {
        if (!data || typeof data !== 'object' || Array.isArray(data)) return;
        Object.entries(data).forEach(([id, row]) => {
          if (!id) return;
          if (!merged[id]) {
            merged[id] = row;
            state.requestMetaById[id] = { path: `${basePath}/${id}`, basePath, year: String(year || state.year) };
            return;
          }
          const existingTs = Number(merged[id]?.requestedAt || merged[id]?.createdAt || 0);
          const incomingTs = Number(row?.requestedAt || row?.createdAt || 0);
          if (incomingTs > existingTs) {
            merged[id] = row;
            state.requestMetaById[id] = { path: `${basePath}/${id}`, basePath, year: String(year || state.year) };
          }
        });
      });
      state.requests = merged;
    }

    function renderApprovalDebug() {
      const el = document.getElementById('approvalDebug');
      if (!el) return;
      const year = String(state.year || '');
      const paths = state.approvalBasePaths || [];
      const primaryPath = paths[0] || '(none)';
      const loaded = Object.keys(state.requests || {}).length;
      const errors = Array.isArray(state.lastApprovalErrors) ? state.lastApprovalErrors : [];
      const errCount = errors.length;
      let html = `Year: ${year} | Reading from: <code style="font-size:11px;background:#1e293b;padding:2px 6px;border-radius:4px;">${primaryPath}</code> | Loaded: <b>${loaded}</b> requests`;
      if (loaded === 0 && errCount === 0) {
        html += '<br><small style="color:var(--muted);">If you submitted expenses but see 0: check Firebase Console → Realtime Database → Rules. Add read for <code>years/$year/expenseApprovals</code>. See rtdb/expense_approvals.rules.json</small>';
      }
      if (errCount > 0) {
        html += ` | <span style="color:var(--bad);">Errors: ${errCount}</span>`;
        errors.forEach((e, i) => {
          html += `<br><small style="color:var(--bad);">${i + 1}. ${e.basePath}: ${(e.message || '').substring(0, 80)}</small>`;
        });
        html += '<br><small style="color:var(--warn);">If permission denied: add read/write rules for years/$year/expenseApprovals in Firebase Console.</small>';
      }
      el.innerHTML = html;
    }

    async function loadRequests() {
      state.requestMetaById = {};
      state.lastApprovalErrors = [];
      const refs = getExpenseApprovalRefs();
      const rowsByPath = {};
      for (let i = 0; i < refs.length; i++) {
        const { basePath, ref } = refs[i];
        try {
          const snap = await ref.once('value');
          const val = snap.val();
          let data = {};
          if (Array.isArray(val)) {
            val.forEach((row, idx) => { if (row && typeof row === 'object') data['_' + idx] = row; });
          } else if (val && typeof val === 'object' && !Array.isArray(val)) {
            data = val;
          }
          if (Object.keys(data).length > 0) {
            console.log('[ExpenseApprovalQueue] found', Object.keys(data).length, 'at', basePath);
          }
          rowsByPath[basePath] = data;
        } catch (err) {
          state.lastApprovalErrors.push({ basePath, message: err?.message || String(err) });
          console.warn('[ExpenseApprovalQueue] read failed:', basePath, err);
        }
      }
      mergeApprovalRows(rowsByPath, state.year);
      renderApprovalDebug();
      const loaded = Object.keys(state.requests || {}).length;
      if (loaded === 0 && state.approvalBasePaths?.length) {
        console.log('[ExpenseApprovalQueue] Finance path (same as finance.html):', state.approvalBasePaths[0]);
      }
    }

    function expenseApprovalRef(id) {
      const meta = id ? state.requestMetaById?.[id] : null;
      const p = normalizePath(meta?.path || '');
      if (!p) throw new Error(`Approval metadata missing for ${id}`);
      return db.ref(p);
    }

    async function loadModuleRecordedCounts() {
      const y = state.year;
      const useRoot = isSocratesLegacy(state.school?.id || inferSchool()?.id);
      state.recordedByModule = {};
      await Promise.all(MODULES.map(async (m) => {
        const p = getModuleExpensePath(m, y);
        if (!p) return;
        try {
          let snap = await schoolRef(p).once('value');
          if (useRoot && !snap.exists()) snap = await rootRef(p).once('value');
          if (useRoot && !snap.exists()) snap = await schoolsSocratesRef(p).once('value');
          const val = snap.val();
          const count = Array.isArray(val) ? val.filter(Boolean).length : (val ? Object.keys(val).length : 0);
          state.recordedByModule[m.key] = count;
        } catch (_) {
          state.recordedByModule[m.key] = 0;
        }
      }));
    }

    async function loadModuleExpenses() {
      const y = state.year;
      const useRoot = isSocratesLegacy(state.school?.id || inferSchool()?.id);
      state.moduleExpenses = {};
      await Promise.all(MODULES.map(async (m) => {
        const p = getModuleExpensePath(m, y);
        if (!p) return;
        try {
          let snap = await schoolRef(p).once('value');
          if (useRoot && !snap.exists()) snap = await rootRef(p).once('value');
          if (useRoot && !snap.exists()) snap = await schoolsSocratesRef(p).once('value');
          const val = snap.val();
          const entries = Array.isArray(val) ? val.filter(Boolean) : (val ? Object.entries(val).map(([id, row]) => ({ id, ...row })) : []);
          state.moduleExpenses[m.key] = entries;
        } catch (_) {
          state.moduleExpenses[m.key] = [];
        }
      }));
    }

    async function approveRequest(id) {
      if (!id) return;
      const reqRef = expenseApprovalRef(id);
      const snap = await reqRef.once('value');
      const row = snap.val();
      if (!row || String(row.status || 'pending') !== 'pending') {
        alert('This request is already processed.');
        await refreshAll();
        return;
      }
      const targetPath = normalizePath(row.targetPath);
      if (!targetPath) {
        alert('Missing target path in request.');
        return;
      }
      const writer = db.ref(targetPath).push();
      const approver = currentApprover();
      await writer.set({
        ...(row.targetPayload || {}),
        approvedAt: firebase.database.ServerValue.TIMESTAMP,
        approvedBy: approver,
        approvalId: id,
        approvalSource: 'academic_expense_approval',
      });
      await reqRef.update({
        status: 'approved',
        approvedAt: firebase.database.ServerValue.TIMESTAMP,
        approvedBy: approver,
        recordedKey: writer.key,
        recordedPath: `${targetPath}/${writer.key}`,
      });
      await refreshAll();
    }

    async function rejectRequest(id) {
      if (!id) return;
      const reason = prompt('Reason for rejection (required):');
      if (!reason || !reason.trim()) return;
      await expenseApprovalRef(id).update({
        status: 'rejected',
        rejectedAt: firebase.database.ServerValue.TIMESTAMP,
        rejectedBy: currentApprover(),
        rejectionReason: String(reason).trim(),
      });
      await refreshAll();
    }

    async function refreshAll() {
      state.loading = true;
      const wrapEl = document.querySelector('.wrap');
      if (wrapEl) wrapEl.classList.add('loading');
      try {
        try {
          await loadRequests();
        } catch (err) {
          console.warn('Failed to load requests', err);
          state.requests = {};
        }
        try {
          await loadFinanceContext();
        } catch (err) {
          console.warn('Failed to load finance context', err);
        }
        try {
          await loadModuleRecordedCounts();
        } catch (err) {
          console.warn('Failed to load module recorded counts', err);
          state.recordedByModule = {};
        }
        try {
          await loadModuleExpenses();
        } catch (err) {
          console.warn('Failed to load module expenses', err);
          state.moduleExpenses = {};
        }
        buildCards();
        renderTable();
      } finally {
        state.loading = false;
        if (wrapEl) wrapEl.classList.remove('loading');
      }
    }

    function getFilteredRowsForExport() {
      const list = Object.entries(state.requests || {}).map(([id, row]) => ({ id, ...row }));
      return list
        .filter((r) => state.moduleFilter === 'all' || String(r.module || '').toLowerCase() === state.moduleFilter)
        .filter((r) => {
          if (state.statusFilter === 'all') return true;
          return String(r.status || 'pending') === state.statusFilter;
        })
        .sort((a, b) => Number(b.requestedAt || 0) - Number(a.requestedAt || 0));
    }

    function downloadCsv() {
      const rows = getFilteredRowsForExport();
      const headers = ['Requested', 'Module', 'Category', 'Description', 'Amount', 'Status', 'Requested By'];
      const lines = [headers.join(',')];
      rows.forEach((r) => {
        const reqAt = Number(r.requestedAt || r.createdAt || 0);
        const dateStr = reqAt ? new Date(reqAt).toLocaleString() : '-';
        lines.push([
          `"${String(dateStr).replace(/"/g, '""')}"`,
          `"${String(r.moduleLabel || r.module || '-').replace(/"/g, '""')}"`,
          `"${String(r.category || '-').replace(/"/g, '""')}"`,
          `"${String(r.description || '-').replace(/"/g, '""')}"`,
          String(r.amount || 0),
          `"${String(r.status || 'pending').replace(/"/g, '""')}"`,
          `"${String(r.requestedBy || '-').replace(/"/g, '""')}"`,
        ].join(','));
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `expense_approvals_${state.school?.id || 'school'}_${state.year}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function downloadPdf() {
      if (!window.jspdf || !window.jspdf.jsPDF) {
        alert('PDF library not loaded.');
        return;
      }
      const rows = getFilteredRowsForExport();
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape' });
      doc.setFontSize(14);
      doc.text(`Academic Expense Approvals - ${state.school?.name || state.school?.id || 'School'} (${state.year})`, 14, 14);
      doc.setFontSize(10);
      const tableData = rows.map((r) => {
        const reqAt = Number(r.requestedAt || r.createdAt || 0);
        const dateStr = reqAt ? new Date(reqAt).toLocaleString() : '-';
        return [dateStr, r.moduleLabel || r.module || '-', r.category || '-', (r.description || '-').substring(0, 40), fmt(r.amount), r.status || 'pending', (r.requestedBy || '-').substring(0, 25)];
      });
      doc.autoTable({
        head: [['Requested', 'Module', 'Category', 'Description', 'Amount', 'Status', 'Requested By']],
        body: tableData,
        startY: 22,
        styles: { fontSize: 8 },
      });
      doc.save(`expense_approvals_${state.school?.id || 'school'}_${state.year}.pdf`);
    }

    function setupFilters() {
      const statusFilter = document.getElementById('statusFilter');
      if (statusFilter) {
        statusFilter.value = state.statusFilter;
        statusFilter.addEventListener('change', (e) => {
          state.statusFilter = e.target.value || 'pending';
          renderTable();
        });
      }
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) refreshBtn.addEventListener('click', refreshAll);
      const allModulesBtn = document.getElementById('allModulesBtn');
      if (allModulesBtn) {
        allModulesBtn.addEventListener('click', () => {
          state.moduleFilter = 'all';
          buildCards();
          renderTable();
        });
      }
      const downloadCsvBtn = document.getElementById('downloadCsvBtn');
      if (downloadCsvBtn) downloadCsvBtn.addEventListener('click', downloadCsv);
      const downloadPdfBtn = document.getElementById('downloadPdfBtn');
      if (downloadPdfBtn) downloadPdfBtn.addEventListener('click', downloadPdf);
    }

    async function init() {
      if (!enforceAcademicRole()) return;
      const params = new URLSearchParams(window.location.search || '');
      const schoolParam = params.get('school') || params.get('schoolId');
      const yearParam = params.get('year');
      if (schoolParam && window.SOMAP?.setSchoolId) {
        try {
          const sid = normalizeSchoolId(schoolParam);
          window.SOMAP.setSchoolId(sid || schoolParam);
        } catch (_) {}
      }
      if (yearParam && window.somapYearContext?.setSelectedYear) {
        try {
          window.somapYearContext.setSelectedYear(String(yearParam), { manual: false });
          state.year = String(yearParam);
        } catch (_) {}
      } else {
        const sessionYear = (() => { try { return sessionStorage.getItem('somap_selected_year'); } catch (_) { return null; } })();
        if (sessionYear && window.somapYearContext?.setSelectedYear) {
          try {
            window.somapYearContext.setSelectedYear(String(sessionYear), { manual: false });
            state.year = String(sessionYear);
          } catch (_) {}
        }
      }
      if (window.SOMAP?.init) {
        window.SOMAP.init({
          db,
          allowQuerySchoolParam: true,
          redirectIfMissingSchool: false,
          multischoolPath: '../../somapappv1multischool/multischool.html',
        });
      }
      state.school = inferSchool();
      if (!state.school || !state.school.id) {
        window.location.href = '../../somapappv1multischool/multischool.html';
        return;
      }
      if (window.SOMAP?.setSchoolId) {
        try { window.SOMAP.setSchoolId(state.school.id); } catch (_) {}
      }
      const schoolLabelEl = document.getElementById('schoolLabel');
      if (schoolLabelEl) schoolLabelEl.textContent = `School: ${state.school.name || state.school.id}`;

      const yearSelect = document.getElementById('yearSelect');
      window.somapYearContext?.attachYearDropdown?.(yearSelect);
      yearSelect.value = String(window.somapYearContext?.getSelectedYear?.() || state.year);
      state.year = String(yearSelect.value || state.year);
      yearSelect.addEventListener('change', async (e) => {
        state.year = String(e.target.value || state.year);
        window.somapYearContext?.setSelectedYear?.(state.year);
        try { sessionStorage.setItem('somap_selected_year', state.year); } catch (_) {}
        await refreshAll();
        setupRealtimeApprovals();
      });

      setupFilters();
      await refreshAll();
      setupRealtimeApprovals();
    }

    function setupRealtimeApprovals() {
      if (Array.isArray(state.approvalUnsubscribe) && state.approvalUnsubscribe.length) {
        state.approvalUnsubscribe.forEach((off) => {
          try { off(); } catch (_) {}
        });
      }
      state.approvalUnsubscribe = [];

      const refs = getExpenseApprovalRefs();
      state.lastApprovalErrors = [];
      const snapshots = {};
      const applyMerged = () => {
        mergeApprovalRows(snapshots, state.year);
        renderApprovalDebug();
        buildCards();
        renderTable();
      };

      refs.forEach(({ basePath, ref }) => {
        const handler = (snap) => {
          snapshots[basePath] = snap.val() || {};
          applyMerged();
        };
        const errorHandler = (err) => {
          state.lastApprovalErrors.push({ basePath, message: err?.message || String(err) });
          console.warn('[ExpenseApprovalQueue] realtime read failed:', basePath, err);
          renderApprovalDebug();
        };
        ref.on('value', handler, errorHandler);
        state.approvalUnsubscribe.push(() => {
          try {
            ref.off('value', handler);
            ref.off('value', errorHandler);
          } catch (_) {}
        });
      });
    }

    init().catch((err) => {
      console.error('expense_approvals init failed:', err);
      const schoolLabelEl = document.getElementById('schoolLabel');
      if (schoolLabelEl && schoolLabelEl.textContent.trim() === 'School: -') {
        schoolLabelEl.textContent = 'School: Socrates School';
      }
    });
  </script>
</body>
</html>
