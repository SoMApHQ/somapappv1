<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Academic Materials | SoMAp</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../../firebase.js"></script>
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --primary: #667eea;
      --primary-dark: #5a67d8;
      --secondary: #764ba2;
      --accent: #f093fb;
      --text-light: rgba(255, 255, 255, 0.95);
      --text-muted: rgba(255, 255, 255, 0.75);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text-light);
      min-height: 100vh;
      padding: 20px;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(120, 119, 198, 0.35) 0%, transparent 50%),
        radial-gradient(circle at 80% 70%, rgba(162, 155, 254, 0.35) 0%, transparent 50%);
      z-index: -1;
      animation: bgPulse 20s ease infinite;
    }

    @keyframes bgPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .page {
      max-width: 1200px;
      margin: 0 auto;
    }

    header.page-header {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(16px);
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .page-header h1 {
      margin: 0;
      font-size: 1.8rem;
      font-weight: 800;
      letter-spacing: -0.02em;
    }

    .page-header p {
      margin: 4px 0 0 0;
      color: var(--text-muted);
      max-width: 720px;
    }

    .card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(16px);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    }

    .card h2 {
      margin: 0 0 12px 0;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 14px;
      margin-top: 12px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-light);
      font-size: 0.95rem;
    }

    select, input, button {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.12);
      color: white;
      font-size: 1rem;
      outline: none;
    }

    select:focus, input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(240, 147, 251, 0.2);
      background: rgba(255, 255, 255, 0.16);
    }

    button {
      cursor: pointer;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--primary));
      font-weight: 700;
      letter-spacing: 0.01em;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,0.25); }
    button:active { transform: translateY(0); }

    .table-wrap {
      overflow-x: auto;
      margin-top: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 760px;
    }

    th, td {
      padding: 12px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      color: var(--text-light);
    }

    th {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 999px;
      font-size: 0.85rem;
    }

    .inline {
      display: inline-flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .muted { color: var(--text-muted); font-size: 0.95rem; }

    .hidden { display: none; }

    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 0.9rem;
    }

    @media (max-width: 720px) {
      header.page-header { flex-direction: column; align-items: flex-start; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <main class="page">
    <header class="page-header">
      <div>
        <h1>Academic Materials</h1>
        <p>Upload official schemes of work and academic resources for teachers to use as templates.</p>
      </div>
      <div class="inline">
        <a href="../workertasks.html" style="text-decoration:none;">
          <button type="button" style="background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.3);">Back to Dashboard</button>
        </a>
      </div>
    </header>

    <section class="card" id="accessNotice" class="hidden">
      <h2>Access Restricted</h2>
      <p class="muted">This page is available to Academic Teachers and Assistant Headteachers only.</p>
    </section>

    <section class="card" id="uploadCard">
      <div class="inline" style="justify-content:space-between; width:100%;">
        <div>
          <h2>Upload Scheme of Work</h2>
          <p class="muted" id="preparedByLabel">Prepared by: loading...</p>
        </div>
        <span class="pill" id="schoolTag">School: socrates</span>
      </div>
      <form id="uploadForm" style="margin-top:12px;">
        <div class="form-grid">
          <div>
            <label for="uploadClass">Class</label>
            <select id="uploadClass" required>
              <option value="">Select class</option>
            </select>
          </div>
          <div>
            <label for="uploadSubject">Subject</label>
            <select id="uploadSubject" required>
              <option value="">Select subject</option>
            </select>
          </div>
          <div>
          <label for="uploadTerm">Term</label>
          <select id="uploadTerm" required>
            <option value="term1">Term 1</option>
            <option value="term2">Term 2</option>
          </select>
          </div>
          <div>
            <label for="uploadYear">Academic Year</label>
            <input id="uploadYear" type="text" placeholder="2026" required>
          </div>
          <div>
            <label for="uploadHours">Hours Per Week</label>
            <input id="uploadHours" type="number" min="1" max="40" value="6">
          </div>
          <div>
            <label for="uploadFile">Scheme File (PDF or DOCX)</label>
            <input id="uploadFile" type="file" accept=".pdf,.doc,.docx" required>
          </div>
        </div>
        <div style="margin-top:14px;">
          <button type="submit">Upload Scheme</button>
        </div>
      </form>
      <p class="muted" style="margin-top:10px;">Files are stored in Cloudinary and linked to the template record in Firebase.</p>
    </section>

    <section class="card">
      <div class="inline" style="justify-content:space-between; width:100%; gap:12px; flex-wrap:wrap;">
        <h2>Uploaded Schemes</h2>
        <div class="inline" style="gap:8px;">
          <select id="filterYear"><option value="all">All Years</option></select>
          <select id="filterClass"><option value="all">All Classes</option></select>
          <select id="filterSubject"><option value="all">All Subjects</option></select>
        <select id="filterTerm">
          <option value="all">All Terms</option>
          <option value="term1">Term 1</option>
          <option value="term2">Term 2</option>
        </select>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Year</th>
              <th>Class</th>
              <th>Subject</th>
              <th>Term</th>
              <th>Hours</th>
              <th>Prepared By</th>
              <th>File</th>
            </tr>
          </thead>
          <tbody id="templatesTable">
            <tr><td colspan="7" class="muted">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    const db = window.db || firebase.database();
    const workerId = localStorage.getItem('workerId');
    const allowedRoles = ['Academic Teacher', 'Assistant Headteacher'];
    const schoolId = window.currentSchoolId || localStorage.getItem('currentSchoolId') || localStorage.getItem('schoolId') || 'socrates';

    // Full school coverage (all classes and subjects) so academic/assistant headteachers can upload for everyone
    const SUBJECTS_BY_CLASS = {
      'Baby Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Baby': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Middle Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Middle': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Preunit Class': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Preunit': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Pre-Unit': ['Arithmetic','Communication','Relation','CRN','Healthcare','Arts'],
      'Class 1': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 1 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 2 AB': ['Writing Skills','Arithmetic','Developing Sports & Arts','Health.AREC','Kusoma','Listening'],
      'Class 3': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 4': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 5': ['Math','English','Kiswahili','Science','Geography','Arts','History','French'],
      'Class 6': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals'],
      'Class 7': ['Math','English','Kiswahili','Science','Social Studies','Civics & Morals']
    };
    const ALL_CLASSES = Object.keys(SUBJECTS_BY_CLASS);
    const ALL_SUBJECTS = Array.from(new Set(Object.values(SUBJECTS_BY_CLASS).flat()));

    const uploadForm = document.getElementById('uploadForm');
    const uploadClass = document.getElementById('uploadClass');
    const uploadSubject = document.getElementById('uploadSubject');
    const uploadYear = document.getElementById('uploadYear');
    const uploadTerm = document.getElementById('uploadTerm');
    const uploadHours = document.getElementById('uploadHours');
    const uploadFile = document.getElementById('uploadFile');
    const templatesTable = document.getElementById('templatesTable');
    const filterYear = document.getElementById('filterYear');
    const filterClass = document.getElementById('filterClass');
    const filterSubject = document.getElementById('filterSubject');
    const filterTerm = document.getElementById('filterTerm');
    const preparedByLabel = document.getElementById('preparedByLabel');
    const schoolTag = document.getElementById('schoolTag');
    const accessNotice = document.getElementById('accessNotice');
    const uploadCard = document.getElementById('uploadCard');

    let currentProfile = null;
    let teacherConfig = null;
    let templatesCache = [];

    function safeKey(value) {
      return String(value || '').replace(/[.#$/\[\]]/g, '_');
    }

    function toast(msg, type = 'info') {
      console.log(`[${type}]`, msg);
      alert(msg);
    }

    function populateSelect(select, values, placeholder) {
      const current = select.value;
      select.innerHTML = '';
      if (placeholder) select.add(new Option(placeholder.label, placeholder.value));
      values.forEach(v => select.add(new Option(v, v)));
      if (current) select.value = current;
    }

    async function loadProfile() {
      if (!workerId) {
        toast('Please sign in again.', 'error');
        window.location.href = '../../index.html';
        return;
      }
      const [profileSnap, configSnap] = await Promise.all([
        db.ref(`workers/${workerId}/profile`).once('value'),
        db.ref(`teachers_config/${workerId}`).once('value')
      ]);
      currentProfile = profileSnap.val() || {};
      teacherConfig = configSnap.val() || {};
      const fullName = currentProfile.fullNameUpper || [currentProfile.firstName, currentProfile.middleName, currentProfile.lastName].filter(Boolean).join(' ').toUpperCase();
      preparedByLabel.textContent = `Prepared by: ${fullName || 'Unknown'}`;
      schoolTag.textContent = `School: ${schoolId}`;

      const role = teacherConfig.teacherType || currentProfile.role || '';
      const canUpload = allowedRoles.includes(role);
      uploadCard.style.display = canUpload ? 'block' : 'none';
      accessNotice.classList.toggle('hidden', canUpload);
      if (!canUpload) return;

      // Academic/assistant headteacher sees the whole school set; if teacherConfig expands classes/subjects, merge them in.
      const classes = Array.from(new Set([...(teacherConfig.classes || []), ...ALL_CLASSES]));
      const subjects = Array.from(new Set([...(teacherConfig.subjects || []), ...ALL_SUBJECTS]));

      populateSelect(uploadClass, classes, { label: 'Select class', value: '' });
      populateSelect(uploadSubject, subjects, { label: 'Select subject', value: '' });

      populateSelect(filterClass, classes, { label: 'All Classes', value: 'all' });
      populateSelect(filterSubject, subjects, { label: 'All Subjects', value: 'all' });

      const currentYear = new Date().getFullYear();
      uploadYear.value = currentYear;
      const years = [];
      for (let i = currentYear - 1; i <= currentYear + 2; i++) years.push(String(i));
      populateSelect(filterYear, years, { label: 'All Years', value: 'all' });
    }

    function termLabel(termKey) {
      if (termKey === 'term2') return 'Term 2';
      if (termKey === 'term3') return 'Term 3';
      return 'Term 1';
    }

    function cloudinaryDefaults() {
      const cloudName = localStorage.getItem('cloud_name') || 'dg7vnrkgd';
      const uploadPreset = localStorage.getItem('upload_preset') || 'books_unsigned';
      const folder = 'somapappv1/schemes';
      return { cloudName, uploadPreset, folder };
    }

    async function uploadToCloudinary(file, folderPath, pathHint) {
      const { cloudName, uploadPreset, folder } = cloudinaryDefaults();
      const resource = (file.type || '').startsWith('image/') ? 'image' : 'raw';
      const url = `https://api.cloudinary.com/v1_1/${cloudName}/${resource}/upload`;
      const fd = new FormData();
      fd.append('file', file);
      fd.append('upload_preset', uploadPreset);
      fd.append('folder', `${folder}/${folderPath}`);
      if (pathHint) {
        fd.append('public_id', String(pathHint).replace(/[^a-z0-9_\-]/gi, '_'));
      }
      const res = await fetch(url, { method: 'POST', body: fd });
      const data = await res.json();
      if (!res.ok) throw new Error(data?.error?.message || 'Cloudinary upload failed');
      return { url: data.secure_url, publicId: data.public_id };
    }

    uploadForm?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!uploadFile.files.length) {
        toast('Please choose a file to upload.', 'warning');
        return;
      }

      const className = uploadClass.value;
      const subjectName = uploadSubject.value;
      const termKey = uploadTerm.value;
      const year = uploadYear.value.trim();
      const classKey = safeKey(className);
      const subjectKey = safeKey(subjectName);
      const hoursPerWeek = Number(uploadHours.value) || 0;
      const file = uploadFile.files[0];

      if (!className || !subjectName || !year) {
        toast('Please fill all required fields.', 'warning');
        return;
      }

      try {
        uploadForm.querySelector('button[type="submit"]').textContent = 'Uploading...';
        const folderPath = `${year}/${classKey}/${subjectKey}/${termKey}`;
        const { url, publicId } = await uploadToCloudinary(file, folderPath, `${subjectKey}-${classKey}-${year}-${termKey}`);

        const templateRef = db.ref(`schemes/${schoolId}/templates/${year}/${classKey}/${subjectKey}/${termKey}`).push();
        const payload = {
          templateId: templateRef.key,
          type: 'scheme_of_work',
          schoolId,
          year,
          className,
          classKey,
          subjectName,
          subjectKey,
          termKey,
          hoursPerWeek: hoursPerWeek || null,
          preparedBy: {
            uid: workerId,
            name: preparedByLabel.textContent.replace('Prepared by: ', '') || 'Unknown',
            role: teacherConfig?.teacherType || ''
          },
          pdf: { url, publicId },
          meta: { createdAt: Date.now(), updatedAt: Date.now(), source: 'academic_upload' }
        };

        await templateRef.set(payload);
        toast('Scheme uploaded successfully.', 'success');
        uploadForm.reset();
        uploadYear.value = year;
        uploadHours.value = hoursPerWeek || 6;
        await loadTemplates();
      } catch (err) {
        console.error(err);
        toast(err.message || 'Upload failed', 'error');
      } finally {
        uploadForm.querySelector('button[type="submit"]').textContent = 'Upload Scheme';
      }
    });

    filterYear.addEventListener('change', () => renderTemplates());
    filterClass.addEventListener('change', () => renderTemplates());
    filterSubject.addEventListener('change', () => renderTemplates());
    filterTerm.addEventListener('change', () => renderTemplates());

    async function loadTemplates() {
      const snap = await db.ref(`schemes/${schoolId}/templates`).once('value');
      const data = snap.val() || {};
      const list = [];
      Object.entries(data).forEach(([year, byClass]) => {
        Object.entries(byClass || {}).forEach(([className, bySubject]) => {
          Object.entries(bySubject || {}).forEach(([subjectName, byTerm]) => {
            Object.entries(byTerm || {}).forEach(([termKey, templates]) => {
              Object.values(templates || {}).forEach(t => list.push(t));
            });
          });
        });
      });
      templatesCache = list.sort((a, b) => (b.meta?.createdAt || 0) - (a.meta?.createdAt || 0));
      renderTemplates();
    }

    function renderTemplates() {
      if (!templatesCache.length) {
        templatesTable.innerHTML = '<tr><td colspan="7" class="muted">No schemes uploaded yet.</td></tr>';
        return;
      }
      const y = filterYear.value;
      const c = filterClass.value;
      const s = filterSubject.value;
      const t = filterTerm.value;
      const rows = templatesCache.filter(row => {
        if (y !== 'all' && row.year !== y) return false;
        if (c !== 'all' && row.className !== c && row.classKey !== safeKey(c)) return false;
        if (s !== 'all' && row.subjectName !== s && row.subjectKey !== safeKey(s)) return false;
        if (t !== 'all' && row.termKey !== t) return false;
        return true;
      });

      if (!rows.length) {
        templatesTable.innerHTML = '<tr><td colspan="7" class="muted">No schemes match your filters.</td></tr>';
        return;
      }

      templatesTable.innerHTML = rows.map(row => `
        <tr>
          <td>${row.year || ''}</td>
          <td>${row.className || ''}</td>
          <td>${row.subjectName || row.subjectKey || ''}</td>
          <td>${termLabel(row.termKey)}</td>
          <td>${row.hoursPerWeek || '-'}</td>
          <td>${row.preparedBy?.name || ''}</td>
          <td><a href="${row.pdf?.url || '#'}" target="_blank" style="color:#c7d2fe;text-decoration:underline;">Open</a></td>
        </tr>
      `).join('');
    }

    (async function init() {
      try {
        await loadProfile();
        await loadTemplates();
      } catch (err) {
        console.error(err);
        toast(err.message || 'Failed to load page', 'error');
      }
    })();
  </script>
</body>
</html>
