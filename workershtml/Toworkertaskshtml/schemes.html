<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Schemes of Work | SoMAp</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="../../firebase.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.2);
      --primary: #667eea;
      --secondary: #764ba2;
      --accent: #f093fb;
      --text: #f8fafc;
      --muted: rgba(248, 250, 252, 0.75);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: var(--text);
      min-height: 100vh;
      padding: 18px;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 30% 40%, rgba(120, 119, 198, 0.28) 0%, transparent 48%),
        radial-gradient(circle at 70% 70%, rgba(162, 155, 254, 0.32) 0%, transparent 52%);
      z-index: -1;
      animation: bgPulse 18s ease-in-out infinite;
    }

    @keyframes bgPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.75; }
    }

    .page {
      max-width: 1350px;
      margin: 0 auto;
    }

    .header {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      backdrop-filter: blur(16px);
      box-shadow: 0 12px 36px rgba(0,0,0,0.15);
    }

    .header h1 {
      margin: 0;
      font-size: 1.9rem;
      letter-spacing: -0.02em;
    }

    .header p {
      margin: 4px 0 0 0;
      color: var(--muted);
    }

    .btn {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: linear-gradient(135deg, var(--accent), var(--primary));
      color: white;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn.secondary {
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.28);
    }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 22px rgba(0,0,0,0.22); }
    .btn:active { transform: translateY(0); }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 14px;
      backdrop-filter: blur(14px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }

    .card h2 {
      margin: 0 0 10px 0;
      font-size: 1.3rem;
      letter-spacing: -0.01em;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap: 12px;
    }

    .info {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--glass-border);
      background: rgba(255,255,255,0.06);
    }

    .info label { display: block; color: var(--muted); font-size: 0.85rem; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.06em; }
    .info span { font-weight: 700; font-size: 1.05rem; }

    label {
      display: block;
      color: var(--text);
      font-weight: 600;
      margin-bottom: 6px;
    }

    select, input, textarea {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 1rem;
      outline: none;
    }

    select:focus, input:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(240, 147, 251, 0.22);
      background: rgba(255,255,255,0.14);
    }

    textarea { min-height: 80px; resize: vertical; }

    .table-wrap { overflow-x: auto; margin-top: 12px; }

    table { width: 100%; border-collapse: collapse; min-width: 1200px; }
    th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.16); vertical-align: top; }
    th { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.06em; color: var(--muted); }
    td input, td textarea { width: 100%; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.22); border-radius: 10px; color: white; padding: 8px 10px; }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.18);
      font-size: 0.9rem;
    }

    .template-card, .scheme-card {
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 14px;
      background: rgba(255,255,255,0.06);
      margin-bottom: 10px;
    }

    .template-card h3, .scheme-card h3 { margin: 0 0 6px 0; }
    .template-card p, .scheme-card p { margin: 4px 0; color: var(--muted); }

    .flex {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }

    .empty {
      text-align: center;
      padding: 24px;
      border: 1px dashed rgba(255,255,255,0.28);
      border-radius: 12px;
      color: var(--muted);
    }

    .hidden { display: none; }

    /* Mobile and narrow screens: allow easier reading/editing */
    @media (max-width: 960px) {
      body { padding: 12px; }
      table { min-width: 900px; }
      th, td { padding: 8px; }
      td input, td textarea { font-size: 0.9rem; }
      .actions { flex-direction: column; }
      .actions .btn { width: 100%; text-align: center; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="header">
      <div>
        <h1>Schemes of Work</h1>
        <p>Aligned to the Tanzania RALG format with academic templates and teacher copies.</p>
      </div>
      <button class="btn secondary" id="backBtn">Back to Dashboard</button>
    </div>

    <div class="info-grid">
      <div class="info">
        <label>Teacher Name</label>
        <span id="teacherName">Loading...</span>
      </div>
      <div class="info">
        <label>Teacher Type</label>
        <span id="teacherType">Loading...</span>
      </div>
      <div class="info">
        <label>Total Schemes</label>
        <span id="totalSchemes">0</span>
      </div>
      <div class="info">
        <label>Date</label>
        <span id="currentDate">Loading...</span>
      </div>
    </div>

    <div class="card">
      <div class="grid">
        <div>
          <label>Filter by Class</label>
          <select id="filterClass"><option value="">All Classes</option></select>
        </div>
        <div>
          <label>Filter by Subject</label>
          <select id="filterSubject"><option value="">All Subjects</option></select>
        </div>
        <div>
          <label>Filter by Term</label>
          <select id="filterTerm">
            <option value="">All Terms</option>
            <option value="term1">Term 1</option>
            <option value="term2">Term 2</option>
            <option value="term3">Term 3</option>
          </select>
        </div>
        <div>
          <label>Filter by Academic Year</label>
          <input type="text" id="filterYear" placeholder="2026">
        </div>
      </div>
      <div class="actions" style="margin-top:12px;">
        <button class="btn" id="newSchemeBtn">Create New Scheme</button>
      </div>
    </div>

    <div class="card hidden" id="templatesSection">
      <div class="flex" style="justify-content: space-between;">
        <h2>Academic Schemes Available</h2>
        <span class="tag" id="templatesInfo"></span>
      </div>
      <div id="templatesList"></div>
    </div>

    <div class="card hidden" id="schemeFormCard">
      <h2>New Scheme of Work</h2>
      <div class="grid">
        <div>
          <label>Class *</label>
          <select id="schemeClass">
            <option value="">Select Class</option>
          </select>
        </div>
        <div>
          <label>Subject *</label>
          <select id="schemeSubject">
            <option value="">Select Subject</option>
          </select>
        </div>
        <div>
          <label>Term *</label>
          <select id="schemeTerm">
            <option value="term1">Term 1</option>
            <option value="term2">Term 2</option>
            <option value="term3">Term 3</option>
          </select>
        </div>
        <div>
          <label>Academic Year *</label>
          <input type="text" id="academicYear" placeholder="2026">
        </div>
        <div>
          <label>Total Weeks</label>
          <input type="number" id="totalWeeks" min="1" max="52" value="12">
        </div>
        <div>
          <label>Hours per Week</label>
          <input type="number" id="hoursPerWeek" min="1" max="40" value="6">
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>General Objectives / Learning Outcomes</label>
        <textarea id="generalObjectives" placeholder="What should students achieve by the end of this term?"></textarea>
      </div>
      <div style="margin-top:12px;">
        <label>Assessment Methods</label>
        <textarea id="assessmentMethods" placeholder="Describe how you will assess students' progress throughout the term."></textarea>
      </div>
      <div style="margin-top:12px;">
        <label>Teaching Resources / Materials</label>
        <textarea id="teachingResources" placeholder="List all resources needed for the term (textbooks, charts, videos, etc.)"></textarea>
      </div>

      <div style="margin-top:14px;" class="flex">
        <h3 style="margin:0;">Official Scheme Table (Tanzania Format)</h3>
        <button class="btn secondary" type="button" id="addRowBtn">Add Row</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>S/N</th>
              <th>Main Competence</th>
              <th>Specific Competence</th>
              <th>Learning Activities</th>
              <th>Specific Activities / Content</th>
              <th>Month</th>
              <th>Week</th>
              <th>Periods</th>
              <th>Teaching & Learning Methods</th>
              <th>Teaching & Learning Tools</th>
              <th>Assessment Tools / Criteria</th>
              <th>Reference</th>
              <th>Remarks</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="rowsTableBody"></tbody>
        </table>
      </div>

      <div class="actions" style="margin-top:16px;">
        <button class="btn" id="saveSchemeBtn">Save Scheme of Work</button>
        <button class="btn secondary" id="downloadPdfBtn" type="button">Download as PDF</button>
        <button class="btn secondary" id="cancelSchemeBtn" type="button">Cancel</button>
      </div>
    </div>

    <div class="card">
      <div class="flex" style="justify-content: space-between;">
        <h2>My Saved Schemes</h2>
        <span class="tag" id="savedSchemesInfo"></span>
      </div>
      <div id="schemesList"></div>
    </div>
  </div>

  <script type="module">
    const db = window.db || firebase.database();
    const workerId = localStorage.getItem('workerId');
    const schoolId = window.currentSchoolId || localStorage.getItem('currentSchoolId') || localStorage.getItem('schoolId') || 'socrates';
    const schoolName = (localStorage.getItem('schoolName') || 'Socrates School Arusha').toUpperCase();

    const teacherNameEl = document.getElementById('teacherName');
    const teacherTypeEl = document.getElementById('teacherType');
    const totalSchemesEl = document.getElementById('totalSchemes');
    const currentDateEl = document.getElementById('currentDate');
    const filterClass = document.getElementById('filterClass');
    const filterSubject = document.getElementById('filterSubject');
    const filterTerm = document.getElementById('filterTerm');
    const filterYear = document.getElementById('filterYear');
    const newSchemeBtn = document.getElementById('newSchemeBtn');
    const schemeFormCard = document.getElementById('schemeFormCard');
    const templatesSection = document.getElementById('templatesSection');
    const templatesList = document.getElementById('templatesList');
    const templatesInfo = document.getElementById('templatesInfo');
    const rowsTableBody = document.getElementById('rowsTableBody');
    const schemesList = document.getElementById('schemesList');
    const savedSchemesInfo = document.getElementById('savedSchemesInfo');
    const backBtn = document.getElementById('backBtn');

    const schemeClass = document.getElementById('schemeClass');
    const schemeSubject = document.getElementById('schemeSubject');
    const schemeTerm = document.getElementById('schemeTerm');
    const academicYear = document.getElementById('academicYear');
    const totalWeeks = document.getElementById('totalWeeks');
    const hoursPerWeek = document.getElementById('hoursPerWeek');
    const generalObjectives = document.getElementById('generalObjectives');
    const assessmentMethods = document.getElementById('assessmentMethods');
    const teachingResources = document.getElementById('teachingResources');

    const addRowBtn = document.getElementById('addRowBtn');
    const saveSchemeBtn = document.getElementById('saveSchemeBtn');
    const cancelSchemeBtn = document.getElementById('cancelSchemeBtn');
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');

    let teacherConfig = null;
    let templatesCache = [];
    let teacherSchemesCache = [];
    let editingScheme = null;
    let currentTemplateId = null;

    currentDateEl.textContent = new Date().toLocaleDateString('en-US', {
      timeZone: 'Africa/Nairobi',
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    function toast(msg) { console.log(msg); alert(msg); }
    function termLabel(termKey) {
      if (termKey === 'term2') return 'Term 2';
      if (termKey === 'term3') return 'Term 3';
      return 'Term 1';
    }

    function safeKey(value) {
      return String(value || '').replace(/[.#$/\[\]]/g, '_');
    }

    function ensureWorker() {
      if (!workerId) {
        toast('Please login first.');
        window.location.href = '../../index.html';
        return false;
      }
      return true;
    }

    function populateSelect(select, items, placeholder) {
      const current = select.value;
      select.innerHTML = '';
      if (placeholder) select.add(new Option(placeholder.label, placeholder.value));
      items.forEach(v => select.add(new Option(v, v)));
      if (current) select.value = current;
    }

    async function loadProfile() {
      const [profileSnap, configSnap] = await Promise.all([
        db.ref(`workers/${workerId}/profile`).once('value'),
        db.ref(`teachers_config/${workerId}`).once('value')
      ]);
      const profile = profileSnap.val() || {};
      teacherConfig = configSnap.val() || {};

      const fullName = profile.fullNameUpper || [profile.firstName, profile.middleName, profile.lastName].filter(Boolean).join(' ').toUpperCase();
      teacherNameEl.textContent = fullName || 'Unknown';
      teacherTypeEl.textContent = teacherConfig.teacherType || 'Teacher';

      const classes = teacherConfig.classes || [];
      const subjects = teacherConfig.subjects || [];
      populateSelect(filterClass, classes, { label: 'All Classes', value: '' });
      populateSelect(filterSubject, subjects, { label: 'All Subjects', value: '' });
      populateSelect(schemeClass, classes, { label: 'Select Class', value: '' });
      populateSelect(schemeSubject, subjects, { label: 'Select Subject', value: '' });

      const yearNow = new Date().getFullYear();
      academicYear.value = yearNow;
      filterYear.value = yearNow;
    }

    function createRow(data = {}) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="sn"></td>
        <td><textarea data-field="mainCompetence" placeholder="Main competence">${data.mainCompetence || ''}</textarea></td>
        <td><textarea data-field="specificCompetence" placeholder="Specific competence">${data.specificCompetence || ''}</textarea></td>
        <td><textarea data-field="learningActivities" placeholder="Learning activities">${data.learningActivities || ''}</textarea></td>
        <td><textarea data-field="specificActivities" placeholder="Specific activities / content">${data.specificActivities || ''}</textarea></td>
        <td><input data-field="month" value="${data.month || ''}" placeholder="Month"></td>
        <td><input data-field="week" value="${data.week || ''}" placeholder="Week"></td>
        <td><input data-field="periods" type="number" min="1" max="20" value="${data.periods || ''}" placeholder="Periods"></td>
        <td><textarea data-field="methods" placeholder="Teaching & learning methods">${data.methods || ''}</textarea></td>
        <td><textarea data-field="tools" placeholder="Teaching & learning tools">${data.tools || ''}</textarea></td>
        <td><textarea data-field="assessment" placeholder="Assessment tools / criteria">${data.assessment || ''}</textarea></td>
        <td><input data-field="reference" value="${data.reference || ''}" placeholder="Reference"></td>
        <td><input data-field="remarks" value="${data.remarks || ''}" placeholder="Remarks"></td>
        <td><button type="button" class="btn secondary remove-row">Remove</button></td>
      `;
      tr.querySelector('.remove-row').addEventListener('click', () => {
        tr.remove();
        refreshSerials();
      });
      rowsTableBody.appendChild(tr);
      refreshSerials();
    }

    function refreshSerials() {
      Array.from(rowsTableBody.querySelectorAll('.sn')).forEach((cell, idx) => {
        cell.textContent = idx + 1;
      });
    }

    function clearForm() {
      editingScheme = null;
      currentTemplateId = null;
      schemeClass.value = filterClass.value || '';
      schemeSubject.value = filterSubject.value || '';
      schemeTerm.value = filterTerm.value || 'term1';
      academicYear.value = filterYear.value || new Date().getFullYear();
      totalWeeks.value = 12;
      hoursPerWeek.value = 6;
      generalObjectives.value = '';
      assessmentMethods.value = '';
      teachingResources.value = '';
      rowsTableBody.innerHTML = '';
      createRow();
      createRow();
    }

    function collectRows() {
      const rows = {};
      Array.from(rowsTableBody.querySelectorAll('tr')).forEach((tr, idx) => {
        const get = (field) => tr.querySelector(`[data-field="${field}"]`)?.value || '';
        rows[`row${idx + 1}`] = {
          sn: idx + 1,
          mainCompetence: get('mainCompetence'),
          specificCompetence: get('specificCompetence'),
          learningActivities: get('learningActivities'),
          specificActivities: get('specificActivities'),
          month: get('month'),
          week: get('week'),
          periods: Number(get('periods')) || '',
          methods: get('methods'),
          tools: get('tools'),
          assessment: get('assessment'),
          reference: get('reference'),
          remarks: get('remarks')
        };
      });
      return rows;
    }

    async function loadTemplates() {
      const year = filterYear.value || '';
      const cls = filterClass.value || '';
      const subj = filterSubject.value || '';
      const term = filterTerm.value || '';
      if (!year || !cls || !subj || !term) {
        templatesSection.classList.add('hidden');
        templatesList.innerHTML = '';
        templatesInfo.textContent = 'Select class, subject, term, and year to view academic templates.';
        return;
      }
      const snap = await db.ref(`schemes/${schoolId}/templates/${year}/${safeKey(cls)}/${safeKey(subj)}/${term}`).once('value');
      const templates = snap.val() || {};
      templatesCache = Object.values(templates);
      renderTemplates();
    }

    function renderTemplates() {
      if (!templatesCache.length) {
        templatesSection.classList.add('hidden');
        templatesList.innerHTML = '';
        return;
      }
      templatesSection.classList.remove('hidden');
      templatesInfo.textContent = `${templatesCache.length} template(s)`;
      templatesList.innerHTML = templatesCache.map(t => `
        <div class="template-card">
          <h3>${t.subjectName || t.subjectKey} - ${t.className} (${termLabel(t.termKey)})</h3>
          <p>Year: ${t.year} | Prepared by: ${t.preparedBy?.name || 'Academic'}</p>
          <div class="flex">
            <button class="btn secondary use-template" data-template-id="${t.templateId}">Use this as my base</button>
            ${t.pdf?.url ? `<a class="btn secondary" href="${t.pdf.url}" target="_blank" style="text-decoration:none;text-align:center;">Open PDF</a>` : ''}
          </div>
        </div>
      `).join('');
      templatesList.querySelectorAll('.use-template').forEach(btn => {
        btn.addEventListener('click', () => {
          const tmpl = templatesCache.find(t => t.templateId === btn.dataset.templateId);
          if (tmpl) applyTemplate(tmpl);
        });
      });
    }

    function applyTemplate(tmpl) {
      currentTemplateId = tmpl.templateId;
      schemeClass.value = tmpl.className || '';
      schemeSubject.value = tmpl.subjectName || tmpl.subjectKey || '';
      schemeTerm.value = tmpl.termKey || 'term1';
      academicYear.value = tmpl.year || '';
      hoursPerWeek.value = tmpl.hoursPerWeek || 6;
      generalObjectives.value = tmpl.generalObjectives || '';
      assessmentMethods.value = tmpl.assessmentMethods || '';
      teachingResources.value = tmpl.teachingResources || '';
      rowsTableBody.innerHTML = '';
      const rowValues = Object.values(tmpl.rows || {}).sort((a, b) => (a.sn || 0) - (b.sn || 0));
      if (rowValues.length === 0) {
        createRow();
      } else {
        rowValues.forEach(r => createRow(r));
      }
      schemeFormCard.classList.remove('hidden');
      schemeFormCard.scrollIntoView({ behavior: 'smooth' });
    }

    async function loadTeacherSchemes() {
      const snap = await db.ref(`schemes/${schoolId}/teacher/${workerId}`).once('value');
      const data = snap.val() || {};
      const list = [];
      Object.entries(data).forEach(([year, byClass]) => {
        Object.entries(byClass || {}).forEach(([cls, bySubj]) => {
          Object.entries(bySubj || {}).forEach(([subj, byTerm]) => {
            Object.entries(byTerm || {}).forEach(([term, schemes]) => {
              Object.values(schemes || {}).forEach(s => list.push(s));
            });
          });
        });
      });
      teacherSchemesCache = list.sort((a, b) => (b.meta?.updatedAt || 0) - (a.meta?.updatedAt || 0));
      renderTeacherSchemes();
    }

    function renderTeacherSchemes() {
      totalSchemesEl.textContent = teacherSchemesCache.length;
      if (!teacherSchemesCache.length) {
        schemesList.innerHTML = '<div class="empty">No schemes saved yet. Create one to get started.</div>';
        savedSchemesInfo.textContent = '';
        return;
      }
      const cls = filterClass.value;
      const subj = filterSubject.value;
      const term = filterTerm.value;
      const year = filterYear.value;
      const filtered = teacherSchemesCache.filter(s => {
        if (cls && s.className !== cls && s.classKey !== safeKey(cls)) return false;
        if (subj && s.subjectName !== subj && s.subjectKey !== safeKey(subj)) return false;
        if (term && s.termKey !== term) return false;
        if (year && s.year !== year) return false;
        return true;
      });
      savedSchemesInfo.textContent = `${filtered.length} shown`;
      if (!filtered.length) {
        schemesList.innerHTML = '<div class="empty">No schemes match your filters.</div>';
        return;
      }
      schemesList.innerHTML = filtered.map(s => `
        <div class="scheme-card">
          <h3>${s.subjectName || s.subjectKey} - ${s.className} (${termLabel(s.termKey)})</h3>
          <p>Year: ${s.year} | Weeks: ${s.totalWeeks || Object.keys(s.rows || {}).length || '-'} | Hours/Week: ${s.hoursPerWeek || '-'}</p>
          <p>Updated: ${s.meta?.updatedAt ? new Date(s.meta.updatedAt).toLocaleString() : '-'}</p>
          <div class="flex">
            <button class="btn secondary load-scheme" data-id="${s.schemeId}" data-year="${s.year}" data-class="${s.classKey || safeKey(s.className)}" data-subject="${s.subjectKey || safeKey(s.subjectName)}" data-term="${s.termKey}">Load to edit</button>
          </div>
        </div>
      `).join('');
      schemesList.querySelectorAll('.load-scheme').forEach(btn => {
        btn.addEventListener('click', () => loadSchemeForEdit(btn.dataset));
      });
    }

    function loadSchemeForEdit(meta) {
      const scheme = teacherSchemesCache.find(s =>
        s.schemeId === meta.id &&
        s.year === meta.year &&
        (s.classKey === meta.class || safeKey(s.className) === meta.class) &&
        (s.subjectKey === meta.subject || safeKey(s.subjectName) === meta.subject) &&
        s.termKey === meta.term
      );
      if (!scheme) return;
      editingScheme = scheme;
      currentTemplateId = scheme.fromTemplateId || null;
      schemeClass.value = scheme.className;
      schemeSubject.value = scheme.subjectName || scheme.subjectKey;
      schemeTerm.value = scheme.termKey;
      academicYear.value = scheme.year;
      totalWeeks.value = scheme.totalWeeks || Object.keys(scheme.rows || {}).length || 12;
      hoursPerWeek.value = scheme.hoursPerWeek || 6;
      generalObjectives.value = scheme.generalObjectives || '';
      assessmentMethods.value = scheme.assessmentMethods || '';
      teachingResources.value = scheme.teachingResources || '';
      rowsTableBody.innerHTML = '';
      const rowValues = Object.values(scheme.rows || {}).sort((a, b) => (a.sn || 0) - (b.sn || 0));
      if (rowValues.length === 0) {
        createRow();
      } else {
        rowValues.forEach(r => createRow(r));
      }
      schemeFormCard.classList.remove('hidden');
      schemeFormCard.scrollIntoView({ behavior: 'smooth' });
    }

    async function saveScheme() {
      const cls = schemeClass.value;
      const subj = schemeSubject.value;
      const term = schemeTerm.value;
      const year = academicYear.value;
      const rows = collectRows();
      if (!cls || !subj || !term || !year) {
        toast('Please fill class, subject, term, and academic year.');
        return;
      }
      if (!Object.keys(rows).length) {
        toast('Please add at least one row.');
        return;
      }
      const payload = {
        schemeId: editingScheme?.schemeId || db.ref().push().key,
        fromTemplateId: currentTemplateId || null,
        schoolId,
        teacher: {
          uid: workerId,
          name: teacherNameEl.textContent,
          type: teacherConfig?.teacherType || 'Teacher'
        },
        year,
        className: cls,
        classKey: safeKey(cls),
        subjectName: subj,
        subjectKey: safeKey(subj),
        termKey: term,
        hoursPerWeek: Number(hoursPerWeek.value) || null,
        totalWeeks: Number(totalWeeks.value) || Object.keys(rows).length,
        generalObjectives: generalObjectives.value || '',
        assessmentMethods: assessmentMethods.value || '',
        teachingResources: teachingResources.value || '',
        rows,
        meta: {
          createdAt: editingScheme?.meta?.createdAt || Date.now(),
          updatedAt: Date.now(),
          status: editingScheme?.meta?.status || 'draft'
        }
      };
      const path = `schemes/${schoolId}/teacher/${workerId}/${year}/${safeKey(cls)}/${safeKey(subj)}/${term}/${payload.schemeId}`;
      await db.ref(path).set(payload);
      toast('Scheme saved.');
      schemeFormCard.classList.add('hidden');
      await loadTeacherSchemes();
    }

    function downloadPdf() {
      const cls = schemeClass.value || 'Class';
      const subj = schemeSubject.value || 'Subject';
      const term = termLabel(schemeTerm.value);
      const year = academicYear.value || '';
      const rowsObj = collectRows();
      const rows = Object.values(rowsObj);
      if (!rows.length) {
        toast('Add at least one row before exporting.');
        return;
      }
      const jsPdfLib = window.jspdf;
      if (!jsPdfLib || !jsPdfLib.jsPDF) {
        toast('PDF library not loaded.');
        return;
      }
      const doc = new jsPdfLib.jsPDF({ orientation: 'landscape', unit: 'pt' });
      doc.setFontSize(12);
      doc.text("PRESIDENT'S OFFICE, REGIONAL ADMINISTRATION AND LOCAL GOVERNMENT", 40, 30);
      doc.text(schoolName, 40, 48);
      doc.text(`SCHEME OF WORK FOR ${subj} ${cls} FOR YEAR ${year} ${term}`, 40, 66);
      const body = rows.map((r, idx) => [
        idx + 1,
        r.mainCompetence || '',
        r.specificCompetence || '',
        r.learningActivities || '',
        r.specificActivities || '',
        r.month || '',
        r.week || '',
        r.periods || '',
        r.methods || '',
        r.tools || '',
        r.assessment || '',
        r.reference || '',
        r.remarks || ''
      ]);
      doc.autoTable({
        head: [[
          'S/N','Main Competence','Specific Competence','Learning Activities',
          'Specific Activities / Content','Month','Week','Periods',
          'Teaching & Learning Methods','Teaching & Learning Tools',
          'Assessment Tools / Criteria','Reference','Remarks'
        ]],
        body,
        startY: 80,
        styles: { fontSize: 8, cellPadding: 4 }
      });
      const fileName = `scheme-${subj}-${cls}-${year}-${schemeTerm.value}.pdf`.replace(/\\s+/g, '-').toLowerCase();
      doc.save(fileName);
    }

    filterClass.addEventListener('change', () => { loadTemplates(); renderTeacherSchemes(); });
    filterSubject.addEventListener('change', () => { loadTemplates(); renderTeacherSchemes(); });
    filterTerm.addEventListener('change', () => { loadTemplates(); renderTeacherSchemes(); });
    filterYear.addEventListener('input', () => { loadTemplates(); renderTeacherSchemes(); });

    newSchemeBtn.addEventListener('click', () => {
      clearForm();
      schemeFormCard.classList.remove('hidden');
      schemeFormCard.scrollIntoView({ behavior: 'smooth' });
    });

    addRowBtn.addEventListener('click', () => createRow());
    saveSchemeBtn.addEventListener('click', saveScheme);
    cancelSchemeBtn.addEventListener('click', () => schemeFormCard.classList.add('hidden'));
    downloadPdfBtn.addEventListener('click', downloadPdf);
    backBtn.addEventListener('click', () => window.location.href = '../workertasks.html');

    (async function init() {
      if (!ensureWorker()) return;
      await loadProfile();
      clearForm();
      await Promise.all([loadTemplates(), loadTeacherSchemes()]);
    })();
  </script>
</body>
</html>
