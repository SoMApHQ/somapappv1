<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mkataba | Contract</title>
  <link rel="stylesheet" href="../css/workers.css">
  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../firebase.js"></script>
  <script>
    window.showToast = (message, type = 'info') => {
      const container = document.getElementById('toastContainer') || document.body;
      const toastEl = document.createElement('div');
      toastEl.className = `toast ${type}`;
      toastEl.textContent = message;
      container.appendChild(toastEl);
      
      setTimeout(() => toastEl.classList.add('show'), 100);
      setTimeout(() => {
        toastEl.classList.remove('show');
        setTimeout(() => toastEl.remove(), 300);
      }, 3000);
    };
  </script>
  <style>
    :root {
      --primary: #4f46e5;
      --primary-dark: #4338ca;
      --secondary: #7c3aed;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #06b6d4;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #64748b;
      --border: #e2e8f0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: var(--dark);
      line-height: 1.6;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
    }

    header h1 {
      margin: 0 0 8px 0;
      font-size: 2.5rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    header p {
      margin: 0;
      color: var(--gray);
      font-size: 1.125rem;
    }

    .context-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 16px;
    }

    .context-chip {
      background: rgba(79, 70, 229, 0.08);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: var(--gray);
    }

    .context-chip select {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      background: white;
      color: var(--dark);
      font-weight: 600;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .glass-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }

    .card-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .card-title {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
    }

    .card-subtitle {
      margin: 0;
      color: var(--gray);
      font-size: 0.875rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .stat-card.success {
      background: linear-gradient(135deg, var(--success), #059669);
    }

    .stat-card.warning {
      background: linear-gradient(135deg, var(--warning), #d97706);
    }

    .stat-card.info {
      background: linear-gradient(135deg, var(--info), #0891b2);
    }

    .stat-label {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 0;
    }

    .salary-breakdown {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
      border-radius: 12px;
      padding: 20px;
      margin: 24px 0;
    }

    .salary-breakdown h3 {
      margin: 0 0 16px 0;
      color: var(--success);
      font-size: 1.25rem;
      font-weight: 700;
    }

    .salary-table {
      width: 100%;
      border-collapse: collapse;
    }

    .salary-table td {
      padding: 12px;
      border: 1px solid #d1fae5;
    }

    .salary-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.5);
    }

    .salary-table .total-row {
      background: rgba(79, 70, 229, 0.15) !important;
      border: 2px solid var(--primary);
    }

    .salary-table .total-row td {
      font-weight: 700;
      font-size: 1.125rem;
      color: var(--primary);
      padding: 16px 12px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 1rem;
      margin: 8px 8px 8px 0;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
    }

    .btn-secondary {
      background: var(--gray);
      color: white;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .status-accepted {
      background: #dcfce7;
      color: #166534;
    }

    .status-pending {
      background: #fef3c7;
      color: #92400e;
    }

    .signature-upload {
      margin: 24px 0;
      padding: 20px;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(124, 58, 237, 0.05));
      border-radius: 12px;
      border: 2px dashed var(--border);
    }

    .signature-upload.has-signature {
      border-color: var(--success);
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05));
    }

    .signature-preview {
      margin-top: 16px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      display: inline-block;
    }

    .signature-preview img {
      max-width: 300px;
      max-height: 120px;
      border: 1px solid var(--border);
      padding: 8px;
      border-radius: 4px;
    }

    .contract-viewer {
      background: white;
      border-radius: 12px;
      padding: 32px;
      margin: 24px 0;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      max-height: 600px;
      overflow-y: auto;
    }

    .pdf-viewer {
      margin-top: 16px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(79, 70, 229, 0.04);
    }

    .pdf-viewer iframe {
      width: 100%;
      height: 520px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: white;
    }

    .language-selector {
      display: flex;
      gap: 12px;
      margin: 16px 0;
      padding: 16px;
      background: rgba(79, 70, 229, 0.05);
      border-radius: 12px;
    }

    .language-selector button {
      flex: 1;
      padding: 12px;
      border: 2px solid var(--border);
      background: white;
      color: var(--dark);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .language-selector button.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .language-selector button:hover:not(.active) {
      border-color: var(--primary);
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: none;
    }

    .toast {
      padding: 16px 24px;
      background: var(--dark);
      color: white;
      border-radius: 8px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transform: translateX(120%);
      transition: all 0.3s ease;
      pointer-events: auto;
      max-width: 400px;
      word-wrap: break-word;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast.success {
      background: var(--success);
    }

    .toast.error {
      background: var(--danger);
    }

    .toast.info {
      background: var(--info);
    }

    .file-input-wrapper {
      position: relative;
      display: inline-block;
      overflow: hidden;
    }

    .file-input-wrapper input[type="file"] {
      position: absolute;
      left: -9999px;
    }

    @media (max-width: 768px) {
      main {
        padding: 16px;
      }
      
      header h1 {
        font-size: 2rem;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div class="context-bar">
        <div class="context-chip">School: <strong id="schoolNameDisplay">-</strong></div>
        <div class="context-chip">Year: <select id="yearSelect" data-somap-year-select></select></div>
      </div>
      <h1>?? Mkataba | Contract</h1>
      <p class="card-subtitle">
        Pakua draft, sahihi, kisha pakia PDF iliyosainiwa.<br>
        Download the draft, sign, then upload the signed PDF.
      </p>
    </header>

    <!-- Worker Details -->
    <div class="glass-card">
      <div class="card-header">
        <h2 class="card-title">Taarifa ya Mfanyakazi | Worker Details</h2>
        <p class="card-subtitle" id="statusLabel"></p>
      </div>
      
      <div class="stats-grid" id="workerStats">
        <div class="stat-card info">
          <div class="stat-label">Jina Kamili | Full Name</div>
          <div class="stat-value" id="statName">-</div>
        </div>
        <div class="stat-card info">
          <div class="stat-label">Jukumu | Role</div>
          <div class="stat-value" id="statRole">-</div>
        </div>
        <div class="stat-card info">
          <div class="stat-label">Simu | Phone</div>
          <div class="stat-value" id="statPhone">-</div>
        </div>
      </div>
    </div>

    <!-- Salary Breakdown -->
    <div class="glass-card">
      <div class="card-header">
        <h2 class="card-title">?? Muhtasari wa Mshahara | Salary Breakdown</h2>
        <p class="card-subtitle">Breakdown of salary, NSSF contributions, and net salary</p>
      </div>
      
      <div class="salary-breakdown">
        <h3>?? Salary Structure</h3>
        <table class="salary-table">
          <tbody id="salaryBreakdownTable">
            <tr><td colspan="2" style="text-align: center; padding: 20px; color: var(--gray);">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Language Selector & Contract Viewer -->
    <div class="glass-card">
      <div class="card-header">
        <h2 class="card-title">?? Mkataba | Employment Contract</h2>
        <p class="card-subtitle">Choose language and review your contract</p>
      </div>

      <div class="language-selector">
        <button id="langEn" class="active">???? English</button>
        <button id="langSw">???? Kiswahili</button>
      </div>

      <div class="contract-viewer" id="contractViewer">
        <p style="text-align: center; color: var(--gray);">Loading contract...</p>
      </div>
    </div>

    <!-- Draft PDF Viewer -->
    <div class="glass-card" id="draftPdfCard">
      <div class="card-header">
        <h2 class="card-title">?? Draft PDF</h2>
        <p class="card-subtitle">Soma draft PDF kabla ya kusaini. | Read the draft PDF before signing.</p>
      </div>
      <div id="draftPdfSection">
        <p style="text-align: center; color: var(--gray);">Loading draft PDF...</p>
      </div>
    </div>

    <!-- Signature Upload -->
    <div class="glass-card" id="signatureSection">
      <div class="card-header">
        <h2 class="card-title">?? Sahihi | Signature</h2>
        <p class="card-subtitle">Upload your handwritten signature for this contract</p>
      </div>

      <div class="signature-upload" id="signatureUploadArea">
        <div class="file-input-wrapper">
          <button class="btn btn-primary" onclick="document.getElementById('signatureInput').click()">
            ?? Chagua Picha ya Sahihi | Choose Signature Image
          </button>
          <input type="file" id="signatureInput" accept="image/*">
        </div>
        <p style="margin: 8px 0 0; color: var(--gray); font-size: 0.875rem;">
          Accepted formats: JPG, PNG (Max 2MB)
        </p>
      </div>

      <div class="signature-preview" id="signaturePreview" style="display: none;"></div>
    </div>

    <!-- Actions -->
    <div class="glass-card">
      <div class="card-header">
        <h2 class="card-title">? Hatua | Actions</h2>
      </div>

      <div id="actions">
        <p style="text-align: center; color: var(--gray);">Loading...</p>
      </div>
    </div>
  </main>

  <!-- Toast Notification Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script type="module">
  import {
    defaultContractLanguage,
    buildContractHtml,
    calculateSalaryBreakdown
  } from './modules/workers_contracts.js';

  const db = firebase.database();
  const storage = firebase.storage();
  const school = SOMAP.getSchool();
  if (!school || !school.id) {
    window.location.href = '../somapappv1multischool/multischool.html';
    throw new Error('No school selected for multi-school context');
  }
  const schoolRef = (path) => db.ref(SOMAP.P(path));

  const schoolNameEl = document.getElementById('schoolNameDisplay');
  const yearSelectEl = document.getElementById('yearSelect');

  const state = {
    schoolId: '',
    schoolName: '',
    year: '',
    workerId: '',
    profile: null,
    terms: {},
    signing: {},
    selectedLanguage: 'en',
    draftOpened: false
  };

  init();

  async function init() {
    try {
      state.workerId = localStorage.getItem('workerId');
      if (!state.workerId) {
        showToast('Ingia tena. | Please sign in again.', 'error');
        setTimeout(() => window.location.href = '../index.html', 3000);
        return;
      }

      initSchoolContext();
      initYearContext();
      updateDraftOpenedFromStorage();
      await loadData();
      setupLanguageHandlers();
    } catch (err) {
      console.error('Init error:', err);
      showToast(err.message || 'Kosa limejitokeza | An error occurred', 'error');
    }
  }

  function initSchoolContext() {
    state.schoolId = school.id;
    state.schoolName = school.name || school.id;
    if (schoolNameEl) schoolNameEl.textContent = state.schoolName;
  }

  function initYearContext() {
    const yearCtx = window.somapYearContext || null;
    const systemYear = String(new Date().getFullYear());
    const selected = String(yearCtx?.getSelectedYear?.() || systemYear);
    state.year = selected;
    yearCtx?.attachYearDropdown?.(yearSelectEl);
    yearCtx?.onYearChanged?.((yr) => {
      state.year = String(yr);
      updateDraftOpenedFromStorage();
      loadData();
    });
  }

  function yearRoot() {
    return `years/${state.year}`;
  }

  function workerRef() {
    return schoolRef(`${yearRoot()}/workers/${state.workerId}`);
  }

  function termsRef() {
    return schoolRef(`${yearRoot()}/workersContractTerms/${state.workerId}`);
  }

  function signingRef() {
    return schoolRef(`${yearRoot()}/workersContractSigning/${state.workerId}`);
  }

  function isSocratesSchool() {
    const schoolCtx = SOMAP.getSchool();
    const schoolId = schoolCtx?.id || '';
    return schoolId === 'socrates-school' || schoolId === 'default' || /socrates/i.test(schoolId);
  }

  function draftFlagKey() {
    return `draftOpened:${state.schoolId}:${state.year}:${state.workerId}`;
  }

  function updateDraftOpenedFromStorage() {
    if (!state.schoolId || !state.year || !state.workerId) return;
    state.draftOpened = localStorage.getItem(draftFlagKey()) === '1';
  }

  function markDraftOpened() {
    localStorage.setItem(draftFlagKey(), '1');
    state.draftOpened = true;
  }

  async function scopedOrSocratesLegacy(scopedSubPath, legacyPath) {
    const schoolCtx = SOMAP.getSchool();
    const schoolId = schoolCtx?.id || "";
    const scopedSnap = await db.ref(SOMAP.P(scopedSubPath)).get();
    if (scopedSnap.exists()) return scopedSnap.val();
    const isSocrates = (schoolId === "socrates-school" || schoolId === "default" || /socrates/i.test(schoolId));
    if (!isSocrates) return null;
    const legacySnap = await db.ref(legacyPath).get();
    return legacySnap.exists() ? legacySnap.val() : null;
  }

  function profileHasIdentity(profile) {
    return Boolean(profile?.fullNameUpper || profile?.firstName || profile?.lastName);
  }

  function injectSpecialAgreementClause(html, agreement) {
    if (!agreement || !agreement.text) return html;
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const headings = Array.from(doc.querySelectorAll('h1, h2, h3, h4, h5, h6'));

    const anchorHeading = headings.find(h => /^\s*2\./i.test(h.textContent || '')) || null;
    if (!anchorHeading) return html;

    const anchorText = (anchorHeading.textContent || '').toLowerCase();
    const alreadyInserted = /2\(b\)\s+(special agreement|makubaliano maalum)/i.test(doc.body.textContent || '') ||
      anchorText.includes('2(b)');
    if (alreadyInserted) return html;

    const clauseWrap = doc.createElement('div');
    clauseWrap.style.margin = '12px 0 0';
    clauseWrap.style.padding = '10px 12px';
    clauseWrap.style.borderLeft = '3px solid #4f46e5';
    clauseWrap.style.background = 'rgba(79, 70, 229, 0.06)';
    clauseWrap.style.borderRadius = '8px';

    const clause = doc.createElement('p');
    clause.style.margin = '0';
    clause.style.whiteSpace = 'pre-wrap';
    const label = doc.createElement('strong');
    label.textContent = agreement.lang === 'sw'
      ? '2(b) Makubaliano Maalum:'
      : '2(b) Special Agreement:';
    clause.appendChild(label);
    clause.appendChild(doc.createTextNode(` ${agreement.text}`));
    clauseWrap.appendChild(clause);

    const following = [];
    let cursor = anchorHeading.nextElementSibling;
    while (cursor) {
      following.push(cursor);
      if (/^\s*3\./i.test(cursor.textContent || '')) break;
      cursor = cursor.nextElementSibling;
    }

    const firstParagraph = following.find(el => el.tagName === 'P') || null;
    if (firstParagraph) {
      firstParagraph.after(clauseWrap);
    } else {
      anchorHeading.after(clauseWrap);
    }
    return doc.body.innerHTML;
  }

  async function loadData() {
    updateDraftOpenedFromStorage();
    const workerData = await scopedOrSocratesLegacy(
      `${yearRoot()}/workers/${state.workerId}`,
      `workers/${state.workerId}`
    ) || {};
    const [termsData, signingData] = await Promise.all([
      scopedOrSocratesLegacy(
        `${yearRoot()}/workersContractTerms/${state.workerId}`,
        `workersContractTerms/${state.workerId}`
      ),
      scopedOrSocratesLegacy(
        `${yearRoot()}/workersContractSigning/${state.workerId}`,
        `workersContracts/${state.workerId}`
      )
    ]);

    let resolvedProfile = workerData.profile || {};
    if (!profileHasIdentity(resolvedProfile) && isSocratesSchool()) {
      const legacySnap = await db.ref(`workers/${state.workerId}`).get();
      resolvedProfile = legacySnap.exists() ? (legacySnap.val()?.profile || {}) : {};
    }
    state.profile = resolvedProfile;

    let resolvedTerms = termsData;
    if (!resolvedTerms && isSocratesSchool()) {
      const legacyTermsSnap = await db.ref(`workers/${state.workerId}/contract/terms`).get();
      resolvedTerms = legacyTermsSnap.exists() ? legacyTermsSnap.val() : null;
    }
    state.terms = resolvedTerms || {};
    state.signing = signingData?.signing || {};

    state.selectedLanguage = defaultContractLanguage(state.profile.role);

    renderAll();
  }

  function renderAll() {
    renderWorkerDetails();
    renderSalaryBreakdown();
    renderContract();
    renderDraftPdfSection();
    renderActions();
    renderSignature();
  }

  function renderWorkerDetails() {
    const profile = state.profile || {};
    const fullName = profile.fullNameUpper || `${profile.firstName || ''} ${profile.lastName || ''}`.trim().toUpperCase();
    document.getElementById('statName').textContent = fullName || '-';
    document.getElementById('statRole').textContent = profile.role || '-';
    document.getElementById('statPhone').textContent = profile.phone || '-';

    const statusLabel = document.getElementById('statusLabel');
    const hasProfile = Boolean(profile.fullNameUpper || profile.firstName || profile.lastName);
    if (!hasProfile) {
      statusLabel.innerHTML = '<span class="status-badge status-pending">Profile missing for this year</span>';
      return;
    }
    const status = state.signing?.status || 'draft';
    const labelMap = {
      approved: 'Approved',
      worker_uploaded: 'Pending Approval',
      draft: 'Draft Ready'
    };
    const draftHint = state.draftOpened
      ? 'Draft opened'
      : 'Open draft before signing';
    statusLabel.innerHTML = `
      <span class="status-badge status-${status === 'approved' ? 'accepted' : 'pending'}">${labelMap[status] || 'Draft'}</span>
      <span style="margin-left: 8px; color: var(--gray); font-weight: 600;">${draftHint}</span>
    `;
  }

  function renderSalaryBreakdown() {
    const hasTerms = state.terms && (Number(state.terms.roleSalary) || Number(state.terms.responsibilityAllowance));
    const fallbackTotal = Number(state.profile?.baseSalary || 0);
    const breakdown = calculateSalaryBreakdown(hasTerms ? state.terms : fallbackTotal);
    const employeePct = hasTerms ? Number(state.terms.nssfEmployeePercent ?? 0.10) : 0.10;
    const employerPct = hasTerms ? Number(state.terms.nssfEmployerPercent ?? 0.10) : 0.10;

    const table = document.getElementById('salaryBreakdownTable');
    table.innerHTML = `
      <tr>
        <td><strong>Mshahara wa Msingi (Jumla) | Total Salary</strong></td>
        <td style="text-align: right; font-weight: 700; color: var(--success);">TZS ${Number(breakdown.baseSalary).toLocaleString('en-US')}</td>
      </tr>
      <tr>
        <td style="padding-left: 24px;">- Mshahara (Kazi) | Role Salary</td>
        <td style="text-align: right;">TZS ${Number(breakdown.salary).toLocaleString('en-US')}</td>
      </tr>
      <tr>
        <td style="padding-left: 24px;">- Posho ya Uwajibikaji | Responsibility Allowance</td>
        <td style="text-align: right;">TZS ${Number(breakdown.other).toLocaleString('en-US')}</td>
      </tr>
      <tr style="background: rgba(239, 68, 68, 0.1);">
        <td colspan="2" style="font-weight: 600; color: var(--danger);"><strong>NSSF Deductions (Role Salary only)</strong></td>
      </tr>
      <tr>
        <td style="padding-left: 24px;">- Mfanyakazi (${Math.round(employeePct * 100)}%) | Employee Contribution</td>
        <td style="text-align: right; color: var(--danger);">- TZS ${Number(breakdown.nssfEmployee).toLocaleString('en-US')}</td>
      </tr>
      <tr>
        <td style="padding-left: 24px;">- Mwajiri (${Math.round(employerPct * 100)}%) | Employer Contribution</td>
        <td style="text-align: right; color: var(--success);">+ TZS ${Number(breakdown.nssfEmployer).toLocaleString('en-US')}</td>
      </tr>
      <tr>
        <td style="padding-left: 24px;">- Jumla ya NSSF | Total NSSF Monthly</td>
        <td style="text-align: right; font-weight: 600;">TZS ${Number(breakdown.nssfTotal).toLocaleString('en-US')}</td>
      </tr>
      <tr class="total-row">
        <td><strong>MSHAHARA SAFI (Baada ya NSSF) | NET SALARY</strong></td>
        <td style="text-align: right;">TZS ${Number(breakdown.netSalary).toLocaleString('en-US')}</td>
      </tr>
    `;
  }

  function renderContract() {
    const profile = state.profile || {};
    const hasProfile = Boolean(profile.fullNameUpper || profile.firstName || profile.lastName);
    if (!hasProfile) {
      document.getElementById('contractViewer').innerHTML = '<p style="text-align: center; color: var(--gray);">No worker profile found for this year.</p>';
      return;
    }
    const html = buildContractHtml(profile, {
      language: state.selectedLanguage,
      signatureUrl: state.signing?.signatureUrl || '',
      terms: state.terms || {},
      specialAgreement: null
    });
    const withClause = injectSpecialAgreementClause(html, state.terms?.specialAgreement || null);
    document.getElementById('contractViewer').innerHTML = withClause;
    syncLanguageButtons();
  }

  function syncLanguageButtons() {
    const isSw = state.selectedLanguage === 'sw';
    document.getElementById('langSw').classList.toggle('active', isSw);
    document.getElementById('langEn').classList.toggle('active', !isSw);
  }

  function renderDraftPdfSection() {
    const section = document.getElementById('draftPdfSection');
    if (!section) return;
    const hasProfile = profileHasIdentity(state.profile);
    const hasTerms = hasContractTerms();
    const canDownload = hasProfile && hasTerms;
    const draftUrl = state.signing?.draftPdfUrl || '';

    section.innerHTML = `
      <div style="margin-bottom: 12px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
        <button class="btn btn-success" type="button" id="downloadDraftPrintBtn" ${canDownload ? '' : 'disabled'}>DOWNLOAD DRAFT PDF</button>
        ${draftUrl ? `<a href="${draftUrl}" target="_blank" class="btn btn-secondary">View Stored Draft</a>` : ''}
      </div>
      <p style="margin: 0; color: var(--gray); text-align: center;">
        Bonyeza DOWNLOAD DRAFT PDF kisha chagua Print → Save as PDF.<br>
        Click DOWNLOAD DRAFT PDF, then choose Print → Save as PDF.
      </p>
    `;
    const btn = document.getElementById('downloadDraftPrintBtn');
    if (btn && canDownload) {
      btn.addEventListener('click', handleDraftPrintDownload);
    }
  }

  function renderActions() {
    const actions = document.getElementById('actions');
    const draftUrl = state.signing?.draftPdfUrl || '';
    const signedUrl = state.signing?.signedPdfUrl || '';
    const hasProfile = profileHasIdentity(state.profile);
    const hasTerms = hasContractTerms();
    const canDownload = hasProfile && hasTerms;

    if (!canDownload) {
      actions.innerHTML = `
        <p style="color: var(--gray); text-align: center;">
          Mkataba bado haujakamilika kwa mwaka huu.<br>
          The contract is not ready for this year yet.
        </p>
        <a href="workersdashboard.html" class="btn btn-secondary">Rudi Nyumbani | Back</a>
      `;
      return;
    }

    actions.innerHTML = `
      <button class="btn btn-success" type="button" id="downloadDraftPrintBtnActions">DOWNLOAD DRAFT PDF</button>
      ${draftUrl ? `<a href="${draftUrl}" target="_blank" class="btn btn-secondary">View Stored Draft</a>` : ''}
      <div class="file-input-wrapper">
        <button class="btn btn-primary" id="uploadSignedBtn" ${state.draftOpened ? '' : 'disabled'}>Upload Signed PDF</button>
        <input type="file" id="signedPdfInput" accept="application/pdf" ${state.draftOpened ? '' : 'disabled'}>
      </div>
      ${signedUrl ? `<a href="${signedUrl}" target="_blank" class="btn btn-secondary">Download Signed PDF</a>` : ''}
      <a href="workersdashboard.html" class="btn btn-secondary">Rudi Nyumbani | Back</a>
      ${state.draftOpened ? '' : `
        <p style="margin: 8px 0 0; color: var(--danger); font-weight: 600;">
          Tafadhali pakua draft kwanza. | Please download the draft first.
        </p>
      `}
    `;

    const draftBtn = document.getElementById('downloadDraftPrintBtnActions');
    if (draftBtn) {
      draftBtn.addEventListener('click', handleDraftPrintDownload);
    }

    const signedInput = document.getElementById('signedPdfInput');
    const signedBtn = document.getElementById('uploadSignedBtn');
    if (signedBtn && signedInput) {
      signedBtn.onclick = () => signedInput.click();
      signedInput.onchange = () => handleSignedUpload(signedInput.files[0]);
    }
  }

  function renderSignature() {
    const signatureSection = document.getElementById('signatureSection');
    if (signatureSection) signatureSection.style.display = 'block';

    const canSign = state.draftOpened;
    const uploadArea = document.getElementById('signatureUploadArea');
    const signatureInput = document.getElementById('signatureInput');
    const uploadBtn = uploadArea?.querySelector('button');
    let hint = document.getElementById('signatureHint');
    if (!hint && uploadArea) {
      hint = document.createElement('p');
      hint.id = 'signatureHint';
      hint.style.margin = '8px 0 0';
      hint.style.fontSize = '0.9rem';
      uploadArea.appendChild(hint);
    }

    if (signatureInput) signatureInput.disabled = !canSign;
    if (uploadBtn) uploadBtn.disabled = !canSign;
    if (hint) {
      hint.style.color = canSign ? 'var(--gray)' : 'var(--danger)';
      hint.textContent = canSign
        ? 'Unaweza kupakia sahihi baada ya kufungua draft PDF.'
        : 'Sahihi imefungwa hadi ufungue draft PDF kwanza.';
    }

    const preview = document.getElementById('signaturePreview');
    const signatureUrl = state.signing?.signatureUrl || '';
    if (preview) {
      if (signatureUrl) {
        preview.innerHTML = `
          <p style="margin: 0 0 8px; font-weight: 600; color: var(--success);">Signature uploaded:</p>
          <img src="${signatureUrl}" alt="Signature">
        `;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
        preview.innerHTML = '';
      }
    }
  }

  function hasContractTerms() {
    const terms = state.terms || {};
    return Boolean(
      Number(terms.roleSalary || 0) > 0 ||
      Number(terms.responsibilityAllowance || 0) > 0 ||
      (terms.specialAgreement && String(terms.specialAgreement.text || '').trim())
    );
  }

  function hasDownloadableDraft() {
    return Boolean(state.signing?.draftPdfUrl);
  }

  function buildContractHtmlForPrint() {
    const profile = state.profile || {};
    const html = buildContractHtml(profile, {
      language: state.selectedLanguage,
      signatureUrl: '',
      terms: state.terms || {},
      specialAgreement: null
    });
    return injectSpecialAgreementClause(html, state.terms?.specialAgreement || null);
  }

  function openPrintWindow(contractHtml) {
    const printWin = window.open('', '_blank', 'noopener,noreferrer');
    if (!printWin) {
      showToast('Ruhusu popups kupakua PDF. | Please allow popups to download PDF.', 'error');
      return null;
    }

    const doc = printWin.document;
    const schoolName = state.schoolName || state.schoolId;
    const title = `Contract ${state.workerId} ${state.year} ${schoolName}`;

    doc.open();
    doc.write(`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title}</title>
  <style>
    @page {
      size: A4;
      margin: 12mm;
    }
    html, body {
      padding: 0;
      margin: 0;
      background: #ffffff;
      color: #0f172a;
      font-family: "Times New Roman", Times, serif;
      line-height: 1.6;
    }
    body {
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
    .print-root {
      width: 210mm;
      margin: 0 auto;
      padding: 12mm;
      box-sizing: border-box;
      background: #ffffff;
    }
    img {
      max-width: 100%;
      height: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      page-break-inside: avoid;
    }
    h1, h2, h3, h4, h5, h6 {
      page-break-after: avoid;
      page-break-inside: avoid;
    }
    p, li {
      orphans: 3;
      widows: 3;
    }
    .no-print {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="print-root">${contractHtml}</div>
  <script>
    window.addEventListener('load', function () {
      setTimeout(function () {
        window.focus();
        window.print();
      }, 50);
    });
  </script>
</body>
</html>`);
    doc.close();
    return printWin;
  }

  function handleDraftPrintDownload() {
    const profile = state.profile || {};
    const hasProfile = profileHasIdentity(profile);
    const hasTerms = hasContractTerms();
    if (!hasProfile || !hasTerms) {
      showToast('Mkataba bado haujakamilika kwa mwaka huu.', 'error');
      return;
    }

    try {
      const contractHtml = buildContractHtmlForPrint();
      const printWin = openPrintWindow(contractHtml);
      if (!printWin) return;

      markDraftOpened();
      renderWorkerDetails();
      renderDraftPdfSection();
      renderActions();
      renderSignature();
      showToast('Draft imefunguliwa. Tumia Print → Save as PDF.', 'success');
    } catch (err) {
      console.error('Print draft failed:', err);
      showToast(err.message || 'Imeshindikana kufungua draft kwa print.', 'error');
    }
  }

  function setupLanguageHandlers() {
    document.getElementById('langEn').addEventListener('click', () => {
      state.selectedLanguage = 'en';
      document.getElementById('langEn').classList.add('active');
      document.getElementById('langSw').classList.remove('active');
      renderContract();
    });

    document.getElementById('langSw').addEventListener('click', () => {
      state.selectedLanguage = 'sw';
      document.getElementById('langSw').classList.add('active');
      document.getElementById('langEn').classList.remove('active');
      renderContract();
    });

    const signatureInput = document.getElementById('signatureInput');
    if (signatureInput) {
      signatureInput.addEventListener('change', () => {
        const file = signatureInput.files[0];
        if (file) {
          if (file.size > 2 * 1024 * 1024) {
            showToast('Picha kubwa sana! Lazima chini ya 2MB', 'error');
            return;
          }
          handleSignatureUpload(file);
        }
      });
    }
  }

  async function handleSignedUpload(file) {
    if (!file) return;
    if (!state.draftOpened) {
      showToast('Fungua draft kwanza kabla ya kupakia. | Open the draft before uploading.', 'error');
      return;
    }
    if (!file.type.includes('pdf')) {
      showToast('Tafadhali chagua PDF sahihi.', 'error');
      return;
    }
    try {
      showToast('Inapakia signed PDF...', 'info');
      const storageRef = storage.ref(`schools/${state.schoolId}/years/${state.year}/contracts/${state.workerId}/signed.pdf`);
      await storageRef.put(file, { contentType: 'application/pdf' });
      const url = await storageRef.getDownloadURL();
      await signingRef().child('signing').update({
        signedPdfUrl: url,
        status: 'worker_uploaded',
        workerUploadedAt: Date.now()
      });
      state.signing = { ...(state.signing || {}), signedPdfUrl: url, status: 'worker_uploaded', workerUploadedAt: Date.now() };
      showToast('Signed PDF imepakiwa.', 'success');
      renderActions();
    } catch (err) {
      console.error('Signed upload error:', err);
      showToast(err.message || 'Imeshindikana kupakia', 'error');
    }
  }

  async function handleSignatureUpload(file) {
    try {
      if (!state.draftOpened) {
        showToast('Fungua draft kwanza kabla ya sahihi. | Open the draft before signing.', 'error');
        return;
      }
      showToast('Inapakia sahihi...', 'info');
      const storageRef = storage.ref(`schools/${state.schoolId}/years/${state.year}/contracts/${state.workerId}/signature.png`);
      await storageRef.put(file, { contentType: file.type || 'image/png' });
      const url = await storageRef.getDownloadURL();
      await signingRef().child('signing').update({
        signatureUrl: url
      });
      state.signing = { ...(state.signing || {}), signatureUrl: url };
      showToast('Sahihi imehifadhiwa.', 'success');
      renderSignature();
      renderContract();
    } catch (err) {
      console.error('Signature upload error:', err);
      showToast(err.message || 'Imeshindikana kupakia sahihi', 'error');
    }
  }
</script>
</body>
</html>

