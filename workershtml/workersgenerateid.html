<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SoMAp | Staff ID Card Studio</title>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

  <script src="../somapappv1multischool/js/context.js"></script>
  <script src="../Todashboardhtml/yearContext.js"></script>
  <script src="../firebase.js"></script>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --ink: #102038;
      --muted: #5b6b81;
      --sky: #0ea5e9;
      --emerald: #0f766e;
      --amber: #f59e0b;
      --surface: rgba(255, 255, 255, 0.9);
      --surface-border: rgba(255, 255, 255, 0.5);
      --card-w: 430px;
      --card-h: 272px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--ink);
      font-family: "Poppins", sans-serif;
      background:
        radial-gradient(950px 500px at 10% -10%, rgba(14, 165, 233, 0.28), transparent 52%),
        radial-gradient(900px 560px at 110% 0%, rgba(245, 158, 11, 0.2), transparent 46%),
        linear-gradient(170deg, #0a1526 0%, #0d2030 45%, #0a111d 100%);
    }

    .shell {
      max-width: 1440px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      gap: 16px;
    }

    .glass {
      background: var(--surface);
      border: 1px solid var(--surface-border);
      border-radius: 18px;
      backdrop-filter: blur(14px);
      box-shadow: 0 24px 38px -28px rgba(2, 8, 23, 0.65);
    }

    .header {
      padding: 16px;
      display: grid;
      gap: 12px;
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .title {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      font-size: 1.6rem;
      letter-spacing: .01em;
    }

    .subtle {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: .92rem;
    }

    .school-chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(14, 165, 233, 0.1);
      border: 1px solid rgba(14, 165, 233, 0.24);
      color: #0c4a6e;
      font-weight: 600;
    }

    .school-chip img {
      width: 34px;
      height: 34px;
      border-radius: 9px;
      object-fit: cover;
      border: 1px solid rgba(2, 132, 199, 0.22);
      background: #fff;
    }

    .controls {
      display: grid;
      grid-template-columns: 150px 1fr auto auto auto;
      gap: 10px;
      align-items: center;
    }

    .controls input,
    .controls select,
    .controls button {
      border: 1px solid #d5dbe8;
      border-radius: 10px;
      padding: 10px 12px;
      font-family: inherit;
      font-size: .88rem;
    }

    .controls input,
    .controls select {
      background: rgba(255, 255, 255, 0.92);
      color: #0f172a;
    }

    .btn {
      color: #fff;
      cursor: pointer;
      border: none;
      transition: transform .15s ease, filter .2s ease;
      font-weight: 600;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: .55;
      cursor: wait;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .btn.single { background: linear-gradient(135deg, #2563eb, #0ea5e9); }
    .btn.selected { background: linear-gradient(135deg, #059669, #0d9488); }
    .btn.all { background: linear-gradient(135deg, #b45309, #f59e0b); }

    .status-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .stat-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.1);
      border: 1px solid rgba(15, 118, 110, 0.2);
      color: #115e59;
      font-size: .83rem;
      font-weight: 600;
    }

    .main-grid {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
      min-height: 74vh;
    }

    .panel {
      padding: 14px;
    }

    .staff-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      color: #475569;
      font-size: .84rem;
    }

    .staff-list {
      border: 1px solid #dbe3f1;
      border-radius: 14px;
      overflow: auto;
      max-height: 66vh;
      background: rgba(255, 255, 255, 0.75);
    }

    .staff-item {
      display: grid;
      grid-template-columns: 24px 1fr;
      gap: 10px;
      padding: 10px;
      border-bottom: 1px solid #e6edf7;
      cursor: pointer;
      transition: background .2s ease;
    }

    .staff-item:last-child { border-bottom: 0; }
    .staff-item:hover { background: rgba(219, 234, 254, 0.38); }
    .staff-item.active { background: rgba(14, 165, 233, 0.16); }

    .staff-name { font-weight: 700; font-size: .89rem; }
    .staff-meta { font-size: .76rem; color: #64748b; }

    .preview-area {
      padding: 14px;
      display: grid;
      gap: 10px;
    }

    .preview-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      font-size: .9rem;
      color: #475569;
    }

    .preview-stack {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
      align-items: start;
    }

    .id-card {
      width: 100%;
      max-width: var(--card-w);
      aspect-ratio: 1.581;
      min-height: var(--card-h);
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      color: #0b1b2d;
      border: 1px solid rgba(15, 23, 42, 0.14);
      box-shadow: 0 18px 25px -18px rgba(2, 8, 23, 0.6);
    }

    .id-front {
      background:
        radial-gradient(circle at 88% 10%, rgba(251, 191, 36, 0.4) 0%, transparent 36%),
        radial-gradient(circle at 10% 90%, rgba(14, 165, 233, 0.24) 0%, transparent 45%),
        linear-gradient(140deg, #dbeafe 0%, #ecfeff 40%, #fff7ed 100%);
    }

    .id-front .bar {
      position: absolute;
      inset: 0 0 auto 0;
      height: 74px;
      background: linear-gradient(120deg, #115e59, #0369a1 68%, #f59e0b 100%);
    }

    .school-row {
      position: absolute;
      left: 14px;
      right: 14px;
      top: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: #f8fafc;
      z-index: 3;
    }

    .school-row img {
      width: 42px;
      height: 42px;
      border-radius: 11px;
      object-fit: cover;
      background: #fff;
      border: 1px solid rgba(255, 255, 255, 0.44);
    }

    .school-row .school-main {
      font-size: .78rem;
      line-height: 1.2;
      min-width: 0;
    }

    .school-row .school-main strong {
      display: block;
      font-size: .9rem;
      letter-spacing: .04em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .front-photo {
      position: absolute;
      right: 16px;
      top: 86px;
      width: 108px;
      height: 130px;
      border-radius: 14px;
      object-fit: cover;
      background: #fff;
      border: 3px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 10px 18px -15px rgba(0, 0, 0, 0.7);
    }

    .front-info {
      position: absolute;
      left: 14px;
      right: 134px;
      top: 92px;
    }

    .front-name {
      margin: 0;
      font-family: "Space Grotesk", sans-serif;
      font-size: 1.02rem;
      line-height: 1.18;
      letter-spacing: .01em;
      text-transform: uppercase;
    }

    .front-role {
      margin-top: 5px;
      display: inline-block;
      padding: 4px 9px;
      border-radius: 999px;
      font-size: .7rem;
      font-weight: 700;
      color: #065f46;
      background: rgba(16, 185, 129, 0.17);
      border: 1px solid rgba(16, 185, 129, 0.35);
    }

    .front-id,
    .front-valid,
    .front-phone {
      margin-top: 6px;
      font-size: .73rem;
      color: #334155;
      font-weight: 600;
    }

    .front-bottom {
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 10px;
    }

    .front-address {
      font-size: .68rem;
      line-height: 1.28;
      color: #475569;
      max-width: 66%;
    }

    .qr-box {
      width: 64px;
      height: 64px;
      border-radius: 8px;
      overflow: hidden;
      background: #fff;
      border: 1px solid #d7deea;
      display: grid;
      place-items: center;
      padding: 4px;
    }

    .id-back {
      background:
        radial-gradient(circle at 82% 14%, rgba(14, 165, 233, 0.16), transparent 44%),
        radial-gradient(circle at 12% 88%, rgba(245, 158, 11, 0.22), transparent 36%),
        linear-gradient(125deg, #ffffff 0%, #f8fafc 55%, #ecfeff 100%);
    }

    .id-back .back-head {
      position: absolute;
      left: 14px;
      right: 14px;
      top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .back-chip {
      width: 42px;
      height: 28px;
      border-radius: 6px;
      background: linear-gradient(145deg, #e2e8f0, #94a3b8);
      border: 1px solid rgba(51, 65, 85, 0.25);
    }

    .back-title {
      font-family: "Space Grotesk", sans-serif;
      font-size: .79rem;
      color: #0f172a;
      letter-spacing: .03em;
    }

    .back-grid {
      position: absolute;
      left: 14px;
      right: 14px;
      top: 50px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px 10px;
      font-size: .69rem;
      color: #1e293b;
      line-height: 1.3;
    }

    .back-note {
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 62px;
      font-size: .62rem;
      color: #4b5563;
      line-height: 1.28;
    }

    .back-footer {
      position: absolute;
      left: 14px;
      right: 14px;
      bottom: 10px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 10px;
    }

    .signature {
      min-width: 140px;
      text-align: center;
      font-size: .62rem;
      color: #334155;
    }

    .signature .line {
      height: 1px;
      background: #334155;
      margin-bottom: 4px;
    }

    .tiny {
      font-size: .69rem;
      color: #64748b;
    }

    @media (max-width: 1120px) {
      .controls {
        grid-template-columns: 1fr 1fr;
      }
      .main-grid {
        grid-template-columns: 1fr;
      }
      .staff-list {
        max-height: 360px;
      }
    }
  </style>
</head>
<body>
  <main id="app" class="shell" style="display:none;">
    <section class="glass header">
      <div class="header-top">
        <div>
          <p style="margin:0;color:#2563eb;font-size:.75rem;font-weight:700;letter-spacing:.2em;text-transform:uppercase;">HR + Security</p>
          <h1 class="title">Staff ID Card Studio</h1>
          <p class="subtle">ATM-size front/back cards, single export, and bulk A4 sheets (left = front, right = back).</p>
        </div>
        <div class="school-chip">
          <img id="headerSchoolLogo" src="../images/somap-logo.png.jpg" alt="School logo">
          <span id="headerSchoolName">School</span>
        </div>
      </div>

      <div class="controls">
        <select id="yearSelect" data-somap-year-select data-somap-year-min="2024" data-somap-year-max="2042" title="Academic Year"></select>
        <input id="searchBox" placeholder="Search name / staff ID / role" autocomplete="off" />
        <button id="downloadPdf" class="btn single">Download Current</button>
        <button id="downloadSelectedPdf" class="btn selected">Download Selected</button>
        <button id="downloadAllPdf" class="btn all">Download All</button>
      </div>

      <div class="status-row">
        <label class="stat-pill" style="cursor:pointer;">
          <input id="selectAllWorkers" type="checkbox" style="accent-color:#0f766e;">
          <span>Select Visible</span>
        </label>
        <span class="stat-pill">Staff: <strong id="staffTotal">0</strong></span>
        <span class="stat-pill">Filtered: <strong id="countHint">0</strong></span>
        <span class="stat-pill">Selected: <strong id="selectedCount">0</strong></span>
        <span class="stat-pill" id="loadInfo">Ready</span>
      </div>
    </section>

    <section class="main-grid">
      <aside class="glass panel">
        <div class="staff-head">
          <strong>Workers</strong>
          <span id="listYearHint"></span>
        </div>
        <div id="results" class="staff-list"></div>
      </aside>

      <section class="glass preview-area">
        <div class="preview-head">
          <strong>Live Preview</strong>
          <span class="tiny">A4 bulk layout: 4 rows per page, each row = front + back</span>
        </div>

        <div class="preview-stack">
          <article id="front" class="id-card id-front">
            <div class="bar"></div>
            <div class="school-row">
              <img id="frontSchoolLogo" src="../images/somap-logo.png.jpg" alt="Logo" />
              <div class="school-main">
                <strong id="frontSchoolName">SOCRATES SCHOOL</strong>
                <span id="frontSchoolContact">P.O. Box 14256, Arusha | 0686828732 / 0689649822</span>
              </div>
            </div>

            <img id="wPhoto" crossOrigin="anonymous" referrerpolicy="no-referrer" class="front-photo" src="" alt="Passport" />

            <div class="front-info">
              <h2 id="wName" class="front-name">-</h2>
              <span id="wRole" class="front-role">Role | Department</span>
              <div id="wId" class="front-id">Staff ID: -</div>
              <div id="wValid" class="front-valid">Valid: 2025-2026</div>
              <div id="wPhone" class="front-phone">Phone: -</div>
            </div>

            <div class="front-bottom">
              <div class="front-address" id="frontAddress">Address: P.O. Box 14256, Arusha, Tanzania</div>
              <div id="qrFront" class="qr-box"></div>
            </div>
          </article>

          <article id="back" class="id-card id-back">
            <div class="back-head">
              <div class="back-chip"></div>
              <strong class="back-title">EMPLOYEE IDENTITY CARD</strong>
              <div class="back-chip"></div>
            </div>

            <div class="back-grid">
              <div><strong>Name:</strong> <span id="bName">-</span></div>
              <div><strong>Phone:</strong> <span id="bPhone">-</span></div>
              <div><strong>Role:</strong> <span id="bRole">-</span></div>
              <div><strong>Blood:</strong> <span id="bBlood">-</span></div>
              <div><strong>Department:</strong> <span id="bDept">-</span></div>
              <div><strong>Emergency:</strong> <span id="bEmerg">-</span></div>
              <div><strong>Staff ID:</strong> <span id="bStaffId">-</span></div>
              <div><strong>Issued:</strong> <span id="bIssued">-</span></div>
            </div>

            <p class="back-note" id="backNote">
              This card is property of this school. If found, return it to school administration. Misuse is subject to disciplinary action.
              Verify: somapv2i.com/verify.
            </p>

            <div class="back-footer">
              <div id="qrBack" class="qr-box"></div>
              <div class="signature">
                <div class="line"></div>
                Authorised Signature
              </div>
            </div>
          </article>
        </div>
      </section>
    </section>
  </main>

  <script src="./modules/workers_idcards.js"></script>
</body>
</html>
