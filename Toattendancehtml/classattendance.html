<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SoMAp ‚Äî Class Attendance</title>

    <!-- Tailwind for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../Todashboardhtml/yearContext.js"></script>
  <script src="../somapappv1multischool/js/context.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script type="module">
      import {
        SUBJECTS_BY_CLASS,
        getSubjectsForClass,
        canonSubject,
        canonClass,
      } from "../js/modules/subjects.js";
      window.SomapSubjects = {
        SUBJECTS_BY_CLASS,
        getSubjectsForClass,
        canonSubject,
        canonClass,
      };
    </script>
    <style>
      * {
        font-family: Inter, system-ui, Arial;
      }
      .status-chip {
        min-width: 44px;
        border-radius: 9999px;
        padding: 6px 10px;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .chip-P {
        background: #dcfce7;
        color: #166534;
      } /* green */
      .chip-A {
        background: #fee2e2;
        color: #991b1b;
      } /* red */
      .chip-S {
        background: #fff7ed;
        color: #c2410c;
      } /* amber */
      .chip-LE {
        background: #eef2ff;
        color: #3730a3;
      } /* indigo */
      .chip-MT {
        background: #fff7f0;
        color: #9a3412;
      } /* orange-ish */
      .chip-PG {
        background: #eef2ff;
        color: #0b69ff;
      } /* permission blue */
      .chip-empty {
        background: #f3f4f6;
        color: #374151;
        border: 1px dashed #e5e7eb;
      }
      .status-pill {
        padding: 4px 8px;
        border-radius: 9999px;
        font-weight: 700;
      }
      .hidden {
        display: none !important;
      }
      .table th,
      .table td {
        padding: 8px;
        border-bottom: 1px solid #e6e9ef;
        white-space: nowrap;
      }
      .table thead th {
        background: #f8fafc;
        font-weight: 700;
        position: sticky;
        top: 0;
      }
      .scroll {
        overflow: auto;
      }
      .btn-shift {
        padding: 6px 10px;
        border-radius: 9999px;
        font-size: 12px;
        font-weight: 600;
        background: #f97316;
        color: #fff;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
      .btn-shift span {
        font-size: 14px;
      }
      .btn-shift:hover {
        background: #ea580c;
      }
      .btn-shift[disabled] {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .shift-flag {
        background: #fee2e2 !important;
      }
      .shift-flag td {
        border-color: #fecaca;
      }
      .shift-flag-reported {
        background: #fef3c7 !important;
      }
      .shift-flag-reported td {
        border-color: #fde68a;
      }
      .shift-note {
        display: block;
        font-size: 11px;
        margin-top: 6px;
        color: #b91c1c;
      }
      .shift-note.success {
        color: #a16207;
      }
      #shiftModal {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.55);
        z-index: 100;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }
      #shiftModal.hidden {
        display: none !important;
      }
      #shiftModal .modal-panel {
        background: #fff;
        max-width: 420px;
        width: 100%;
        border-radius: 18px;
        padding: 24px;
        box-shadow: 0 22px 60px rgba(15, 23, 42, 0.28);
        position: relative;
      }
      #shiftModal .modal-panel h3 {
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        color: #0f172a;
      }
      #shiftModal .modal-panel p {
        margin: 0 0 12px;
        font-size: 0.9rem;
        color: #475569;
      }
      #shiftModal label {
        display: block;
        font-size: 0.82rem;
        font-weight: 600;
        color: #1f2937;
        margin-top: 12px;
      }
      #shiftModal input,
      #shiftModal select,
      #shiftModal textarea {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 8px 10px;
        font-size: 0.9rem;
        margin-top: 4px;
      }
      #shiftModal textarea {
        min-height: 70px;
        resize: vertical;
      }
      #shiftModal .close-btn {
        position: absolute;
        top: 14px;
        right: 16px;
        font-size: 1.25rem;
        color: #94a3b8;
        cursor: pointer;
      }
      #shiftModal .close-btn:hover {
        color: #475569;
      }
      #shiftModal .actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }
      #shiftModal .actions button {
        padding: 8px 16px;
        border-radius: 9999px;
        font-weight: 600;
      }
      #shiftModal .actions .cancel-btn {
        background: #e2e8f0;
        color: #0f172a;
      }
      #shiftModal .actions .submit-btn {
        background: #2563eb;
        color: #fff;
      }
      #shiftModal .actions .submit-btn:hover {
        background: #1d4ed8;
      }
    </style>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <header class="bg-white border-b sticky top-0 z-30">
      <div
        class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between"
      >
        <div class="flex items-center gap-4">
          <a
            href="../attendance.html"
            class="text-slate-700 hover:text-blue-600"
            >‚Üê Back to Dashboard</a
          >
          <h1 class="text-lg font-semibold">SoMAp ‚Äî Class Attendance</h1>
        </div>
        <div class="flex items-center gap-3">
          <label
            class="flex items-center gap-2 rounded-md border border-slate-300 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600"
          >
            <span class="hidden sm:inline text-[0.7rem]">Academic Year</span>
            <select
              data-somap-year-select
              class="min-w-[110px] rounded border border-slate-300 bg-white px-2 py-1 text-sm font-medium text-slate-700 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
            ></select>
          </label>
          <button
            id="btnFullscreen"
            class="px-3 py-1 rounded-md border bg-slate-100"
          >
            Enter Fullscreen
          </button>
          <div id="rtState" class="text-sm text-slate-500">Connecting‚Ä¶</div>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-4 space-y-4">
      <!-- Filters + actions -->
      <section class="bg-white rounded-2xl p-4 shadow-sm border">
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
          <div>
            <label class="text-sm font-medium">Class</label>
            <select
              id="classSelect"
              class="w-full border rounded px-3 py-2"
            ></select>
          </div>
          <div>
            <label class="text-sm font-medium">Date</label>
            <input
              id="dateInput"
              type="date"
              class="w-full border rounded px-3 py-2"
            />
          </div>
          <div>
            <label class="text-sm font-medium">Search / Show</label>
            <input
              id="searchInput"
              type="text"
              placeholder="Type name or admission"
              class="w-full border rounded px-3 py-2"
            />
          </div>
          <div>
            <label class="text-sm font-medium">Quick Set</label>
            <div class="flex gap-2">
              <select id="quickAm" class="border rounded px-3 py-2">
                <option value="">AM</option>
                <option value="P">P</option>
                <option value="A">A</option>
                <option value="S">S</option>
                <option value="LE">LE</option>
                <option value="MT">MT</option>
                <option value="PG">PG</option>
              </select>
              <select id="quickPm" class="border rounded px-3 py-2">
                <option value="">PM</option>
                <option value="P">P</option>
                <option value="A">A</option>
                <option value="S">S</option>
                <option value="LE">LE</option>
                <option value="MT">MT</option>
                <option value="PG">PG</option>
              </select>
            </div>
          </div>
          <div class="flex gap-2">
            <button
              id="markAllPresent"
              class="px-3 py-2 bg-green-600 text-white rounded"
            >
              Mark all Present
            </button>
            <button
              id="applyQuick"
              class="px-3 py-2 bg-slate-900 text-white rounded"
            >
              Apply Quick
            </button>
            <button
              id="saveAll"
              class="px-3 py-2 bg-blue-600 text-white rounded"
            >
              Save
            </button>
          </div>
        </div>
      </section>

      <!-- Attendance list -->
      <section class="bg-white rounded-2xl p-4 shadow-sm border">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Class Attendance</h2>
          <div class="text-sm text-slate-500">
            Students in view: <span id="studentCount">0</span>
          </div>
        </div>
        <div class="scroll">
          <table class="table min-w-full" id="attTable">
            <thead>
              <tr>
                <th style="width: 40px">#</th>
                <th style="width: 120px">Adm No</th>
                <th>Student Name</th>
                <th style="width: 120px">Fee Due</th>
                <th style="width: 120px">Paid</th>
                <th style="width: 120px">Balance</th>
                <th style="width: 380px">Mark AM / PM</th>
                <th style="width: 140px">Daily</th>
                <th style="width: 140px">Actions</th>
              </tr>
            </thead>
            <tbody id="attBody"></tbody>
          </table>
        </div>
        <div class="mt-3 flex gap-2">
          <button id="exportDaily" class="px-3 py-2 border rounded">
            Export Daily (PDF)
          </button>
          <button id="exportMonthly" class="px-3 py-2 border rounded">
            Export Monthly (PDF)
          </button>
          <button id="exportStudent" class="px-3 py-2 border rounded">
            Export Student (PDF)
          </button>
          <div id="saveToast" class="text-sm text-slate-500 ml-auto"></div>
        </div>
      </section>
    </main>

    <!-- Shift Modal -->
    <div id="shiftModal" class="hidden">
      <div class="modal-panel">
        <button
          type="button"
          class="close-btn"
          id="shiftModalClose"
          aria-label="Close"
        >
          &times;
        </button>
        <h3>Shift Alert Review</h3>
        <p id="shiftStudentMeta"></p>
        <form id="shiftForm">
          <div>
            <label for="shiftedChoice">Shifted?</label>
            <select id="shiftedChoice" name="shiftedChoice" required>
              <option value="">Select</option>
              <option value="YES">YES - confirmed shifted</option>
              <option value="NO">NO - not yet shifted</option>
            </select>
          </div>
          <div>
            <label for="shiftReason">Reason / Notes</label>
            <textarea
              id="shiftReason"
              name="shiftReason"
              placeholder="Why do you suspect the student shifted?"
              required
            ></textarea>
          </div>
          <div>
            <label for="shiftInfoSource">Information from?</label>
            <input
              id="shiftInfoSource"
              name="shiftInfoSource"
              type="text"
              placeholder="Parent, neighbour, classmate..."
              required
            />
          </div>
          <div>
            <label for="shiftDate">Date shifted (or last seen)</label>
            <input id="shiftDate" name="shiftDate" type="date" required />
          </div>
          <div>
            <label for="shiftProbableSchool">Probable new school</label>
            <input
              id="shiftProbableSchool"
              name="shiftProbableSchool"
              type="text"
              placeholder="School name"
            />
          </div>
          <div id="shiftFormAlert" class="shift-note hidden"></div>
          <div class="actions">
            <button type="button" class="cancel-btn" id="shiftModalCancel">
              Cancel
            </button>
            <button type="submit" class="submit-btn" id="shiftSubmitBtn">
              Save Shift Alert
            </button>
          </div>
        </form>
      </div>
    </div>

    <footer class="bg-white border-t py-3 sticky bottom-0">
      <div
        class="max-w-6xl mx-auto px-4 text-sm text-slate-500 flex items-center gap-3"
      >
        <div>SoMAp Class Attendance ¬∑ Mobile friendly</div>
        <div
          id="todayAlert"
          class="ml-auto text-sm text-yellow-700 hidden"
        ></div>
      </div>
    </footer>

    <!-- Firebase libs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="../firebase.js"></script>
    <!-- finance -->
    <script src="../shared/finance_math.js"></script>

    <!-- jsPDF for export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      (async function () {
        // ---------- CONFIG ----------
        const TZ = "Africa/Nairobi";
        const SCHOOL_DAY_CUTOFF_HOUR = 15;
        const HOLIDAYS = [
          "01-01",
          "04-07",
          "04-26",
          "05-01",
          "07-07",
          "08-08",
          "10-14",
          "12-09",
          "12-25",
          "12-26",
        ];
        const MOVABLE = [
          "2025-03-29",
          "2025-04-01",
          "2025-04-10",
          "2025-04-11",
          "2025-06-16",
        ];
        const SHIFT_CONSECUTIVE_DAYS = 10;
        const SHIFT_REPORT_PATH = "shiftReports";

        // ---------- STATE ----------
        const urlParams = new URLSearchParams(window.location.search);
        const queryClassRaw = (urlParams.get("class") || "").trim();
        const lockedClassStorage = (
          sessionStorage.getItem("lockedClassAttendance") || ""
        ).trim();
        const lockedTeacherStorage = (
          sessionStorage.getItem("lockedClassTeacher") || ""
        ).trim();

        let students = [];
        let filtered = [];
        let currentClass = lockedClassStorage || queryClassRaw || "";
        let currentDateStr = "";
        let monthKey = "";
        let attendanceCache = {};
        let monthAttendance = {};
        let db = null;

    // Multi-school helpers (requires ../somapappv1multischool/js/context.js)
    const P = (path) =>
      (window.SOMAP && typeof window.SOMAP.P === 'function') ? window.SOMAP.P(path) : path;
    const schoolRef = (path) => {
      if (!db) throw new Error('Firebase DB not initialized');
      return db.ref(P(path));
    };

    const replaceYearInIsoDate = (iso, year) => {
      if (!iso || typeof iso !== 'string') return iso;
      const parts = iso.split('-');
      if (parts.length !== 3) return iso;
      parts[0] = String(year);
      return parts.join('-');
    };
        let shiftReports = {};
        let shiftRef = null;
        let currentShiftStudent = null;
        let currentYear = "";
        let yearReloadPromise = null;

        // ---------- HELPERS ----------
        const el = (id) => document.getElementById(id);
        const shiftModal = document.getElementById("shiftModal");
        const shiftForm = document.getElementById("shiftForm");
        const shiftModalClose = document.getElementById("shiftModalClose");
        const shiftModalCancel = document.getElementById("shiftModalCancel");
        const shiftStudentMeta = document.getElementById("shiftStudentMeta");
        const shiftFormAlert = document.getElementById("shiftFormAlert");
        const shiftSubmitBtn = document.getElementById("shiftSubmitBtn");
 

        function fmtDate(d) {
          const y = d.getFullYear(),
            m = String(d.getMonth() + 1).padStart(2, "0"),
            day = String(d.getDate()).padStart(2, "0");
          return `${y}-${m}-${day}`;
        }
        function toMonthKey(dStr) {
          const d = new Date(dStr + "T00:00:00");
          return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(
            2,
            "0"
          )}`;
        }
        function isWeekend(d) {
          const day = d.getDay();
          return day === 0 || day === 6;
        }
        function isHoliday(d) {
          const fixed =
            String(d.getMonth() + 1).padStart(2, "0") +
            "-" +
            String(d.getDate()).padStart(2, "0");
          const iso = fmtDate(d);
          return HOLIDAYS.includes(fixed) || MOVABLE.includes(iso);
        }
        function deriveDaily(am, pm) {
          if (!am && !pm) return "";
          const A = (am || "").toUpperCase();
          const P = (pm || "").toUpperCase();
          if (A === "P" && P === "P") return "P";
          const map = {
            "P-A": "PA",
            "A-P": "AP",
            "P-S": "PS",
            "P-MT": "PMT",
            "P-PG": "PPG",
            "P-LE": "PLE",
            "S-P": "SP",
            "MT-P": "MTP",
            "PG-P": "PGP",
            "LE-P": "LEP",
          };
          return map[`${A}-${P}`] || `${A}${P}`;
        }
        function normalizeClassName(str) {
          return String(str || "")
            .toUpperCase()
            .replace(/[\s\-\._]/g, "");
        }
        function normalizeYearValue(year) {
          const y = Number(year);
          if (!Number.isFinite(y)) return String(SOMAP_DEFAULT_YEAR);
          return String(y);
        }
        function canonicalClassKey(str) {
          const api = window.SomapSubjects || {};
          const canonical = api.canonClass ? api.canonClass(str) : str;
          const norm = normalizeClassName(canonical);
          if (!norm) return "";
          let key = norm.replace(/(19|20)\d{2}$/, "");
          key = key.replace(/^(CLASS|GRADE|STD|STANDARD|FORM|PRIMARY)/, "");
          key = key.replace(/STREAM/g, "");
          return key;
        }
        function isSameClass(a, b) {
          if (!a || !b) return false;
          const normA = normalizeClassName(a);
          const normB = normalizeClassName(b);
          if (!normA || !normB) return false;
          if (normA === normB) return true;
          const canonicalA = canonicalClassKey(a);
          const canonicalB = canonicalClassKey(b);
          return canonicalA && canonicalA === canonicalB;
        }
        // Treat Class 1 family and Class 2 family as the same cohort on this page
        function classMatches(target, actual) {
          if (!target || !actual) return false;
          // keep the existing "exact" logic first
          if (isSameClass(target, actual)) return true;

          const t = canonicalClassKey(target); // e.g. "2AB" or "2"
          const a = canonicalClassKey(actual); // e.g. "2" or "2A"
          // Grab the leading number if present
          const tLead = (t.match(/^\d+/) || [""])[0];
          const aLead = (a.match(/^\d+/) || [""])[0];

          // If we're in Class 1/2 universe, treat AB/streams as equivalent
          if (
            (tLead === "1" || tLead === "2") &&
            (aLead === "1" || aLead === "2")
          ) {
            return tLead === aLead;
          }
          return false;
        }
        function resolveClassNameForData(candidate) {
          if (!candidate) return "";
          const targetKey = canonicalClassKey(candidate);
          if (!targetKey) return candidate;
          const direct = students.find(
            (s) => canonicalClassKey(s.class) === targetKey
          );
          return direct ? direct.class : candidate;
        }
        function isAbsentDay(rec) {
          if (!rec) return false;
          const daily = rec.daily || deriveDaily(rec.am, rec.pm) || "";
          return daily.includes("A");
        }
        function getStudentAttendanceHistory(studentId) {
          const history = {};
          const monthData = monthAttendance[studentId] || {};
          Object.keys(monthData).forEach((dateKey) => {
            if (monthData[dateKey])
              history[dateKey] = { ...monthData[dateKey] };
          });
          if (attendanceCache[studentId]) {
            const merged = {
              ...(history[currentDateStr] || {}),
              ...attendanceCache[studentId],
            };
            merged.daily = merged.daily || deriveDaily(merged.am, merged.pm);
            history[currentDateStr] = merged;
          }
          return Object.keys(history)
            .map((date) => ({ date, rec: history[date] }))
            .sort((a, b) => a.date.localeCompare(b.date));
        }
        function getConsecutiveAbsences(studentId) {
          const hist = getStudentAttendanceHistory(studentId);
          let streak = 0;
          for (let i = hist.length - 1; i >= 0; i--) {
            if (isAbsentDay(hist[i].rec)) streak++;
            else break;
          }
          return streak;
        }
        function getShiftEntry(studentId) {
          return shiftReports && shiftReports[studentId]
            ? shiftReports[studentId]
            : null;
        }
        function monthWorkingDays(dateStr) {
          const d = new Date(dateStr + "T00:00:00");
          const y = d.getFullYear(),
            m = d.getMonth();
          let count = 0;
          for (let day = 1; day <= 31; day++) {
            const dt = new Date(y, m, day);
            if (dt.getMonth() !== m) break;
            if (isWeekend(dt) || isHoliday(dt)) continue;
            count++;
          }
          return count;
        }
        function setStatusElem(elm, val) {
          if (!elm) return;
          elm.textContent = val || "‚Äì";
          elm.className =
            "status-pill " +
            (val === "P"
              ? "bg-green-100 text-green-800"
              : (val || "").includes("A")
              ? "bg-red-100 text-red-700"
              : (val || "").includes("S")
              ? "bg-amber-100 text-amber-800"
              : "bg-slate-100 text-slate-700");
        }
        function saveToastOK(msg) {
          const t = el("saveToast");
          if (!t) return;
          t.textContent = msg || "Attendance saved successfully";
          t.style.color = "#065f46";
          t.style.fontWeight = "600";
          setTimeout(() => {
            t.textContent = "";
            t.removeAttribute("style");
          }, 1800);
        }

        // ---------- FIREBASE: initialize and load students ----------
        async function initializeFirebase() {
          try {
            if (!window.firebase || !window.firebase.apps.length) {
              await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.src = "../firebase.js";
                script.onload = resolve;
                script.onerror = () =>
                  reject(new Error("Failed to load ../firebase.js"));
                document.head.appendChild(script);
              });
            }
            db =
              window.db ||
              (window.firebase && firebase.database
                ? firebase.database()
                : null);
            if (!db) {
              throw new Error("Firebase database not initialized");
            }
            el("rtState").textContent = "Connected to Firebase";
          } catch (e) {
            console.error("Firebase initialization error:", e.message);
            el("rtState").textContent = "Firebase error: " + e.message;
            alert(
              "Firebase initialization failed: " +
                e.message +
                ". Please check ../firebase.js and database rules."
            );
          }
        }
        const SOMAP_DEFAULT_YEAR = 2025;

        const CLASS_ORDER = [
          "Baby Class",
          "Middle Class",
          "Pre Unit Class",
          "Class 1",
          "Class 2",
          "Class 3",
          "Class 4",
          "Class 5",
          "Class 6",
          "Class 7",
        ];

        const L = (s) =>
          String(s || "")
            .trim()
            .toLowerCase();

        function shiftClass(baseClass, deltaYears) {
          const i = CLASS_ORDER.findIndex((c) => L(c) === L(baseClass));
          if (i < 0) return baseClass || "";
          const j = i + Number(deltaYears || 0);
          if (j < 0) return "PRE-ADMISSION";
          if (j >= CLASS_ORDER.length) return "GRADUATED";
          return CLASS_ORDER[j];
        }

        function buildEnrollmentIndex(enrollments) {
          const byId = enrollments || {};
          const byAdmission = {};
          Object.entries(enrollments || {}).forEach(([key, value]) => {
            if (!value || typeof value !== "object") return;
            const admission =
              value.admissionNumber || value.admissionNo || value.admNo || "";
            if (admission && !byAdmission[admission]) {
              byAdmission[admission] = value;
            }
            if (!byId[key]) byId[key] = value;
          });
          return { byId, byAdmission };
        }
        function lookupEnrollment(index, studentId, admissionNo) {
          if (!index) return {};
          if (studentId && index.byId?.[studentId]) return index.byId[studentId];
          if (admissionNo && index.byId?.[admissionNo])
            return index.byId[admissionNo];
          if (admissionNo && index.byAdmission?.[admissionNo])
            return index.byAdmission[admissionNo];
          return {};
        }

        async function loadStudentsFromDb(year) {
          if (!db) return [];

          const selectedYear = normalizeYearValue(
            year ||
              window.somapYearContext?.getSelectedYear?.() ||
              SOMAP_DEFAULT_YEAR
          );
          const delta = Number(selectedYear) - SOMAP_DEFAULT_YEAR;
          const tryPaths = ["students", "Students", "StudentsList", "Students_List"];

          const [anchorEnrollSnap, yearEnrollSnap] = await Promise.all([
            db
              .ref(`enrollments/${SOMAP_DEFAULT_YEAR}`)
              .get()
              .catch(() => null),
            schoolRef(`enrollments/${selectedYear}`).get().catch(() => null),
          ]);
          const anchorIndex = buildEnrollmentIndex(
            anchorEnrollSnap?.exists() ? anchorEnrollSnap.val() : {}
          );
          const yearIndex = buildEnrollmentIndex(
            yearEnrollSnap?.exists() ? yearEnrollSnap.val() : {}
          );

          for (const p of tryPaths) {
            try {
              const snap = await schoolRef(p).get();
              if (!snap.exists()) continue;

              const data = snap.val();

              return Object.keys(data)
                .map((k) => {
                  const s = data[k] || {};

                  const status = String(s.status || "").toLowerCase();
                  if (status === "shifted") return null;

                  const name =
                    [s.firstName, s.middleName, s.lastName]
                      .filter(Boolean)
                      .join(" ")
                      .trim() ||
                    s.name ||
                    s.fullName ||
                    "";

                  const parentName =
                    s.primaryParentName ||
                    s.parentName ||
                    s.guardianName ||
                    "";

                  const parentContact =
                    s.primaryParentContact ||
                    s.parentPhone ||
                    s.parentContact ||
                    s.guardianContact ||
                    "";

                  const admissionNo =
                    s.admissionNumber || s.admNo || s.admissionNo || "";

                  const anchorEnrollment = lookupEnrollment(
                    anchorIndex,
                    k,
                    admissionNo
                  );
                  const yearEnrollment = lookupEnrollment(
                    yearIndex,
                    k,
                    admissionNo
                  );
                  const yearClass =
                    yearEnrollment.className ||
                    yearEnrollment.classLevel ||
                    yearEnrollment.class ||
                    "";
                  const baseClass =
                    anchorEnrollment.className ||
                    anchorEnrollment.classLevel ||
                    s.class ||
                    s.classLevel ||
                    s.grade ||
                    "";

                  return {
                    id: k,
                    admissionNo,
                    name,
                    class: yearClass || shiftClass(baseClass, delta),
                    feeDue: 0,
                    feePaid: 0,
                    balance: 0,
                    parentName,
                    parentContact,
                    status: status || "active",
                  };
                })
                .filter(Boolean);
            } catch (e) {
              console.warn("Failed to load path", p, e.message);
            }
          }

          console.error("No students data found");
          return [];
        }

        async function attachFinanceDataForYear(year) {
          const yearKey = normalizeYearValue(year);
          if (!window.SomapFinance?.getYearFinanceEntries) return;
          try {
            if (window.SomapFinance._clearFinanceCaches) {
              window.SomapFinance._clearFinanceCaches();
            }
            const entries = await window.SomapFinance.getYearFinanceEntries(
              yearKey
            );
            const byAdmission = {};
            Object.entries(entries || {}).forEach(([_, entry]) => {
              const student = entry?.student || {};
              const admission =
                student.admissionNumber ||
                student.admissionNo ||
                entry.admissionNumber ||
                entry.admissionNo ||
                "";
              if (admission) byAdmission[String(admission)] = entry;
            });
            students = students.map((s) => {
              const entry =
                entries?.[s.id] ||
                (s.admissionNo
                  ? byAdmission[String(s.admissionNo)]
                  : null) ||
                null;
              if (!entry) return { ...s, feeDue: 0, feePaid: 0, balance: 0 };
              const due = Number(
                entry.due ?? entry.finance?.feePerYear ?? 0
              );
              const paid = Number(
                entry.paid ?? entry.finance?.paidAmount ?? 0
              );
              const balance = Number(
                entry.outstanding ??
                  entry.finance?.balance ??
                  Math.max(0, due - paid)
              );
              return { ...s, feeDue: due, feePaid: paid, balance };
            });
            renderTable();
          } catch (e) {
            console.warn("Finance summary load failed", e?.message || e);
          }
        }

        // ---------- Attendance CRUD ----------
        async function loadDayAttendance(cls, dateStr) {
          attendanceCache = {};
          if (!db || !cls) return;
          const yymm = toMonthKey(dateStr);
          try {
            const snap = await db
              .ref(`attendance/${cls}/${yymm}/${dateStr}`)
              .get();
            const d = snap.exists() ? snap.val() : {};
            Object.keys(d).forEach((k) => (attendanceCache[k] = d[k]));
          } catch (e) {
            console.warn("Failed to load day attendance:", e.message);
          }
        }
        async function loadMonthAttendance(cls, yymm) {
          monthAttendance = {};
          if (!db || !cls) return;
          try {
            const snap = await schoolRef(`attendance/${cls}/${yymm}`).get();
            const d = snap.exists() ? snap.val() : {};
            Object.keys(d).forEach((dateKey) => {
              const byStu = d[dateKey] || {};
              Object.keys(byStu).forEach((stuId) => {
                monthAttendance[stuId] = monthAttendance[stuId] || {};
                monthAttendance[stuId][dateKey] = byStu[stuId];
              });
            });
          } catch (e) {
            console.warn("Failed to load month attendance:", e.message);
          }
        }
        async function saveDayAttendance(cls, dateStr) {
          if (!db) return;
          const yymm = toMonthKey(dateStr);
          const path = `attendance/${cls}/${yymm}/${dateStr}`;
          try {
            await schoolRef(path).update(attendanceCache);
            saveToastOK("Attendance saved successfully");
          } catch (e) {
            alert("Save failed: " + e.message);
          }
        }
        function subscribeShiftReports() {
          if (!db) return;
          if (shiftRef) shiftRef.off(); // keep this

          shiftRef = schoolRef(SHIFT_REPORT_PATH);

          shiftRef.on("value", (snap) => {
            const next = snap.exists() ? snap.val() : {};

            // üîπ only re-render if data actually changed
            if (JSON.stringify(next) !== JSON.stringify(shiftReports)) {
              shiftReports = next;
              renderTable();
            }
          });
        }

        // ---------- Render UI ----------
        function renderTable() {
          const body = el("attBody");
          body.innerHTML = "";
          const q = (el("searchInput").value || "").toLowerCase();
          const classKey = canonicalClassKey(currentClass);
          filtered = students
            .filter((s) =>
              classKey
                ? classMatches(currentClass, s.class)
                : s.class === currentClass
            )
            .filter(
              (s) =>
                !q ||
                s.name.toLowerCase().includes(q) ||
                String(s.admissionNo || "").includes(q)
            );
          el("studentCount").textContent = filtered.length;

          filtered.forEach((s, idx) => {
            const rec = attendanceCache[s.id] || {};
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${s.admissionNo || ""}</td>
        <td>${escapeHtml(s.name)}</td>
        <td>${Number(s.feeDue || 0).toLocaleString()}</td>
<td>${Number(s.feePaid || 0).toLocaleString()}</td>
<td>${Number(s.balance || 0).toLocaleString()}</td>

        <td id="chips-${s.id}"></td>
        <td><span id="daily-${s.id}" class="status-pill">‚Äî</span></td>
        <td>
          <div class="flex gap-2 items-center">
            <button data-id="${
              s.id
            }" class="btn-export text-sm px-2 py-1 border rounded">Export</button>
            <button data-id="${
              s.id
            }" data-action="shift" class="btn-shift hidden" title="Send shift alert to admin">Shift</button>
          </div>
          <span id="shift-note-${s.id}" class="shift-note hidden"></span>
        </td>
      `;
            body.appendChild(tr);

            const chipsCell = tr.querySelector(`#chips-${s.id}`);
            const statuses = ["P", "A", "S", "LE", "MT", "PG"];
            const amGroup = document.createElement("div");
            amGroup.className = "flex gap-2 items-center mb-2";
            const lblAm = document.createElement("div");
            lblAm.className = "text-xs text-slate-500 mr-2";
            lblAm.textContent = "AM";
            amGroup.appendChild(lblAm);
            statuses.forEach((st) => {
              const b = document.createElement("div");
              b.className = "status-chip " + (st ? "chip-" + st : "chip-empty");
              b.textContent = st;
              b.title = "AM: " + st;
              b.dataset.stu = s.id;
              b.dataset.sess = "am";
              b.dataset.val = st;
              b.addEventListener("click", onChipClick);
              amGroup.appendChild(b);
            });
            chipsCell.appendChild(amGroup);

            const pmGroup = document.createElement("div");
            pmGroup.className = "flex gap-2 items-center";
            const lblPm = document.createElement("div");
            lblPm.className = "text-xs text-slate-500 mr-2";
            lblPm.textContent = "PM";
            pmGroup.appendChild(lblPm);
            statuses.forEach((st) => {
              const b = document.createElement("div");
              b.className = "status-chip " + (st ? "chip-" + st : "chip-empty");
              b.textContent = st;
              b.title = "PM: " + st;
              b.dataset.stu = s.id;
              b.dataset.sess = "pm";
              b.dataset.val = st;
              b.addEventListener("click", onChipClick);
              pmGroup.appendChild(b);
            });
            chipsCell.appendChild(pmGroup);

            updateRowVisuals(s.id);
            decorateShiftState(tr, s);
          });

          document.querySelectorAll(".btn-export").forEach((btn) => {
            btn.addEventListener("click", () =>
              exportPdfForStudent(btn.dataset.id)
            );
          });
          document.querySelectorAll('[data-action="shift"]').forEach((btn) => {
            btn.addEventListener("click", () =>
              handleShiftClick(btn.dataset.id)
            );
          });
        }

        function onChipClick(e) {
          const b = e.currentTarget;
          const stu = b.dataset.stu;
          const sess = b.dataset.sess;
          const val = b.dataset.val;
          attendanceCache[stu] = attendanceCache[stu] || {};
          if (attendanceCache[stu][sess] === val)
            attendanceCache[stu][sess] = "";
          else attendanceCache[stu][sess] = val;
          attendanceCache[stu].daily = deriveDaily(
            attendanceCache[stu].am,
            attendanceCache[stu].pm
          );
          const s = students.find((x) => x.id === stu);
          attendanceCache[stu].snap = {
            admissionNo: s?.admissionNo || "",
            name: s?.name || "",
            class: s?.class || "",
            feeDue: s?.feeDue || 0,
            feePaid: s?.feePaid || 0,
            balance: s?.balance || 0,
          };
          updateRowVisuals(stu);
          const row = b.closest("tr");
          if (row && s) decorateShiftState(row, s);
        }

        function updateRowVisuals(stu) {
          const rec = attendanceCache[stu] || {};
          document
            .querySelectorAll(`[data-stu="${stu}"][data-sess="am"]`)
            .forEach((el) => {
              el.style.outline =
                rec.am && el.dataset.val === rec.am
                  ? "3px solid rgba(11,103,255,0.12)"
                  : "none";
            });
          document
            .querySelectorAll(`[data-stu="${stu}"][data-sess="pm"]`)
            .forEach((el) => {
              el.style.outline =
                rec.pm && el.dataset.val === rec.pm
                  ? "3px solid rgba(11,103,255,0.12)"
                  : "none";
            });
          setStatusElem(
            el("daily-" + stu),
            rec.daily || deriveDaily(rec.am, rec.pm)
          );
        }
        function decorateShiftState(row, student) {
          if (!row || !student) return;
          const shiftBtn = row.querySelector('[data-action="shift"]');
          const note = row.querySelector(`#shift-note-${student.id}`);
          if (note) {
            note.classList.add("hidden");
            note.classList.remove("success");
            note.textContent = "";
          }
          row.classList.remove("shift-flag", "shift-flag-reported");
          if (shiftBtn) {
            shiftBtn.classList.add("hidden");
            shiftBtn.textContent = "Shift";
          }

          const existing = getShiftEntry(student.id);
          const status =
            existing && existing.status ? existing.status : "pending";
          const consecutive = getConsecutiveAbsences(student.id);
          const shouldFlag =
            consecutive >= SHIFT_CONSECUTIVE_DAYS || !!existing;

          if (shiftBtn) shiftBtn.dataset.streak = String(consecutive);

          if (status === "shifted") {
            if (shiftBtn) shiftBtn.classList.add("hidden");
            if (note) {
              note.classList.remove("hidden");
              note.classList.add("success");
              note.textContent = "Shifted by admin";
            }
            return;
          }

          if (!shouldFlag) return;

          if (shiftBtn) {
            shiftBtn.classList.remove("hidden");
            shiftBtn.textContent = existing ? "Update" : "Shift";
          }
          if (existing) {
            row.classList.add("shift-flag-reported");
            if (note) {
              note.classList.remove("hidden");
              note.classList.add("success");
              note.textContent = "Alert sent to admin. You can update details.";
            }
          } else {
            row.classList.add("shift-flag");
            if (note) {
              note.classList.remove("hidden");
              note.textContent = `${consecutive} consecutive absent days. Provide shift info.`;
            }
          }
        }
        function setShiftFormMessage(message, variant) {
          if (!shiftFormAlert) return;
          if (!message) {
            shiftFormAlert.classList.add("hidden");
            shiftFormAlert.classList.remove("success");
            shiftFormAlert.textContent = "";
            return;
          }
          shiftFormAlert.textContent = message;
          shiftFormAlert.classList.remove("hidden");
          if (variant === "success") shiftFormAlert.classList.add("success");
          else shiftFormAlert.classList.remove("success");
        }
        function handleShiftClick(studentId) {
          if (!studentId) return;
          const student = students.find((x) => x.id === studentId);
          if (!student) {
            alert("Student record not found in this class view.");
            return;
          }
          currentShiftStudent = student;
          const consecutive = getConsecutiveAbsences(student.id);
          const existing = getShiftEntry(student.id);
          openShiftModal(student, consecutive, existing);
        }
        function openShiftModal(student, consecutive, existing) {
          if (!shiftModal || !shiftForm) return;
          const today = currentDateStr || fmtDate(new Date());
          shiftForm.reset();
          if (shiftStudentMeta) {
            shiftStudentMeta.textContent = `${student.name} ‚Ä¢ ${
              student.class || ""
            } ‚Ä¢ Adm ${
              student.admissionNo || "N/A"
            } ‚Ä¢ ${consecutive} absent days`;
          }
          shiftFormAlert && shiftFormAlert.classList.add("hidden");
          if (existing) {
            if (shiftForm.shiftedChoice)
              shiftForm.shiftedChoice.value =
                existing.shiftChoice || existing.shiftedChoice || "";
            if (shiftForm.shiftReason)
              shiftForm.shiftReason.value = existing.reason || "";
            if (shiftForm.shiftInfoSource)
              shiftForm.shiftInfoSource.value = existing.infoSource || "";
            if (shiftForm.shiftDate)
              shiftForm.shiftDate.value = existing.dateShifted || today;
            if (shiftForm.shiftProbableSchool)
              shiftForm.shiftProbableSchool.value =
                existing.probableSchool || "";
          } else {
            if (shiftForm.shiftedChoice) shiftForm.shiftedChoice.value = "";
            if (shiftForm.shiftReason) shiftForm.shiftReason.value = "";
            if (shiftForm.shiftInfoSource) shiftForm.shiftInfoSource.value = "";
            if (shiftForm.shiftDate) shiftForm.shiftDate.value = today;
            if (shiftForm.shiftProbableSchool)
              shiftForm.shiftProbableSchool.value = "";
          }
          shiftModal.classList.remove("hidden");
        }
        function closeShiftModal() {
          if (!shiftModal) return;
          shiftModal.classList.add("hidden");
          setShiftFormMessage("");
          currentShiftStudent = null;
        }
        function setupShiftModal() {
          if (shiftModalClose)
            shiftModalClose.addEventListener("click", closeShiftModal);
          if (shiftModalCancel)
            shiftModalCancel.addEventListener("click", closeShiftModal);
          if (shiftModal) {
            shiftModal.addEventListener("click", (e) => {
              if (e.target === shiftModal) closeShiftModal();
            });
          }
          if (shiftForm) {
            shiftForm.addEventListener("submit", async (e) => {
              e.preventDefault();
              if (!db) {
                setShiftFormMessage(
                  "No database connection. Please reconnect.",
                  "error"
                );
                return;
              }
              if (!currentShiftStudent) {
                setShiftFormMessage(
                  "Select the student again before submitting.",
                  "error"
                );
                return;
              }
              const shiftChoice = shiftForm.shiftedChoice
                ? shiftForm.shiftedChoice.value
                : "";
              const reason = shiftForm.shiftReason
                ? shiftForm.shiftReason.value.trim()
                : "";
              const infoSource = shiftForm.shiftInfoSource
                ? shiftForm.shiftInfoSource.value.trim()
                : "";
              const dateShifted = shiftForm.shiftDate
                ? shiftForm.shiftDate.value
                : "";
              const probableSchool = shiftForm.shiftProbableSchool
                ? shiftForm.shiftProbableSchool.value.trim()
                : "";
              if (!shiftChoice || !reason || !infoSource || !dateShifted) {
                setShiftFormMessage(
                  "Please fill in all the required fields.",
                  "error"
                );
                return;
              }
              const student = currentShiftStudent;
              const existing = getShiftEntry(student.id) || {};
              const now = Date.now();
              const flaggedAbsences = getConsecutiveAbsences(student.id);
              const payload = {
                ...existing,
                studentId: student.id,
                studentName: student.name,
                admissionNo: student.admissionNo || "",
                className: student.class,
                parentName: student.parentName || "",
                parentContact: student.parentContact || "",
                shiftChoice,
                reason,
                infoSource,
                dateShifted,
                probableSchool,
                flaggedAbsences,
                balance: Number(student.balance || 0),
                feeDue: Number(student.feeDue || 0),
                feePaid: Number(student.feePaid || 0),
                debtStatus:
                  Number(student.balance || 0) > 0 ? "not cleared" : "cleared",
                teacherClass: student.class,
                flaggedDate:
                  existing.flaggedDate || currentDateStr || fmtDate(new Date()),
                teacherReportedAt: existing.teacherReportedAt || now,
                updatedAt: now,
                status: existing.status === "shifted" ? "shifted" : "pending",
              };
              try {
                if (shiftSubmitBtn) shiftSubmitBtn.disabled = true;
                await schoolRef(`${SHIFT_REPORT_PATH}/${student.id}`).set(payload);
                setShiftFormMessage(
                  "Shift alert saved. Admin has been notified.",
                  "success"
                );
                setTimeout(() => {
                  closeShiftModal();
                  renderTable();
                }, 400);
              } catch (err) {
                console.error("Failed to save shift alert", err);
                setShiftFormMessage(
                  err && err.message
                    ? err.message
                    : "Failed to save shift alert.",
                  "error"
                );
              } finally {
                if (shiftSubmitBtn) shiftSubmitBtn.disabled = false;
              }
            });
          }
        }

        // ---------- Quick / Mark all ----------
        function applyQuick() {
          const qAm = el("quickAm").value;
          const qPm = el("quickPm").value;
          filtered.forEach((s) => {
            attendanceCache[s.id] = attendanceCache[s.id] || {};
            if (qAm) attendanceCache[s.id].am = qAm;
            if (qPm) attendanceCache[s.id].pm = qPm;
            attendanceCache[s.id].daily = deriveDaily(
              attendanceCache[s.id].am,
              attendanceCache[s.id].pm
            );
            attendanceCache[s.id].snap = {
              admissionNo: s.admissionNo || "",
              name: s.name,
              class: s.class,
              feeDue: s.feeDue,
              feePaid: s.feePaid,
              balance: s.balance,
            };
            updateRowVisuals(s.id);
            const noteEl = document.getElementById(`shift-note-${s.id}`);
            if (noteEl) {
              const row = noteEl.closest("tr");
              if (row) decorateShiftState(row, s);
            }
          });
        }
        function markAllPresent() {
          filtered.forEach((s) => {
            attendanceCache[s.id] = attendanceCache[s.id] || {};
            attendanceCache[s.id].am = "P";
            attendanceCache[s.id].pm = "P";
            attendanceCache[s.id].daily = "P";
            attendanceCache[s.id].snap = {
              admissionNo: s.admissionNo || "",
              name: s.name,
              class: s.class,
              feeDue: s.feeDue,
              feePaid: s.feePaid,
              balance: s.balance,
            };
            updateRowVisuals(s.id);
            const noteEl = document.getElementById(`shift-note-${s.id}`);
            if (noteEl) {
              const row = noteEl.closest("tr");
              if (row) decorateShiftState(row, s);
            }
          });
        }

        // ---------- Export features ----------
        async function exportDailyPDF() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation: "landscape" });
          doc.setFontSize(12);
          doc.text(
            `SoMAp Daily Attendance ‚Äî ${currentClass} ‚Äî ${currentDateStr}`,
            14,
            14
          );
          let y = 24;
          doc.setFontSize(10);
          [
            "No",
            "Adm",
            "Name",
            "AM",
            "PM",
            "Daily",
            "Due",
            "Paid",
            "Bal",
          ].forEach((h, i) => doc.text(h, 14 + i * 30, y));
          y += 6;
          filtered.forEach((s, i) => {
            const rec = attendanceCache[s.id] || {};
            if (y > 180) {
              doc.addPage("landscape");
              y = 20;
            }
            doc.text(String(i + 1), 14, y);
            doc.text(String(s.admissionNo || ""), 44, y);
            doc.text(String(s.name || ""), 74, y);
            doc.text(String(rec.am || ""), 134, y);
            doc.text(String(rec.pm || ""), 164, y);
            doc.text(String(rec.daily || ""), 194, y);
            doc.text(String(s.feeDue || 0), 224, y);
            doc.text(String(s.feePaid || 0), 254, y);
            doc.text(String(s.balance || 0), 284, y);
            y += 6;
          });
          doc.save(`SoMAp_Daily_${currentClass}_${currentDateStr}.pdf`);
        }
        async function exportMonthlyPDF() {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFontSize(12);
          doc.text(`SoMAp Monthly ‚Äî ${currentClass} ‚Äî ${monthKey}`, 14, 14);
          let y = 28;
          const workdays = monthWorkingDays(currentDateStr);
          filtered.forEach((s, i) => {
            if (y > 270) {
              doc.addPage();
              y = 20;
            }
            const dates = monthAttendance[s.id] || {};
            let present = 0,
              absent = 0;
            Object.keys(dates).forEach((dk) => {
              const r = dates[dk];
              if (r && r.daily === "P") present++;
              if (r && (r.daily || "").includes("A")) absent++;
            });
            doc.text(
              `${i + 1}. ${s.name} (${
                s.admissionNo
              }) ‚Äî Present: ${present}/${workdays} Absent: ${absent} => ${
                workdays ? Math.round((present / workdays) * 100) : 0
              }%`,
              14,
              y
            );
            y += 6;
          });
          doc.save(`SoMAp_Monthly_${currentClass}_${monthKey}.pdf`);
        }
        async function exportPdfForStudent(studentId) {
          const s = students.find((x) => x.id === studentId);
          if (!s) return alert("Student not found");
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();
          doc.setFontSize(14);
          doc.text(`Attendance for ${s.name}`, 14, 18);
          doc.setFontSize(11);
          doc.text(`Admission No: ${s.admissionNo}`, 14, 28);
          const dates = monthAttendance[studentId] || {};
          let y = 40;
          const workdays = monthWorkingDays(currentDateStr);
          Object.keys(dates)
            .sort()
            .forEach((dk) => {
              const r = dates[dk];
              doc.text(
                `${dk}: AM=${r.am || ""} PM=${r.pm || ""} Daily=${
                  r.daily || ""
                }`,
                14,
                y
              );
              y += 6;
              if (y > 270) {
                doc.addPage();
                y = 20;
              }
            });
          doc.text(
            `Summary: ${workdays ? "Workdays: " + workdays : ""}`,
            14,
            y + 6
          );
          doc.save(`Attendance_${s.admissionNo || s.id}_${monthKey}.pdf`);
        }

        // ---------- UI wiring ----------
        async function activateClass(cls) {
          if (!cls) return;
          const resolved = resolveClassNameForData(cls);
          if (!resolved) return;
          currentClass = resolved;
          const select = el("classSelect");
          if (select) {
            const match = Array.from(select.options).find((opt) =>
              classMatches(resolved, opt.value)
            );
            if (match) {
              select.value = match.value;
            } else {
              const option = new Option(resolved, resolved, true, true);
              select.add(option);
            }
          }
          await loadDayAttendance(currentClass, currentDateStr);
          monthKey = toMonthKey(currentDateStr);
          await loadMonthAttendance(currentClass, monthKey);
          renderTable();
        }

        function wireUI() {
          el("classSelect").addEventListener("change", async (e) => {
            const requested = e.target.value;
            if (!requested) {
              currentClass = "";
              renderTable();
              return;
            }
            if (lockedClassStorage) {
              const lockedKey = canonicalClassKey(lockedClassStorage);
              const requestedKey = canonicalClassKey(requested);
              if (lockedKey && requestedKey !== lockedKey) {
                e.target.value = currentClass || "";
                return;
              }
            }
            await activateClass(requested);
          });

          el("dateInput").addEventListener("change", async (e) => {
            currentDateStr = e.target.value;
            monthKey = toMonthKey(currentDateStr);
            if (!currentClass) return;
            await loadDayAttendance(currentClass, currentDateStr);
            await loadMonthAttendance(currentClass, monthKey);
            renderTable();
          });

          el("searchInput").addEventListener("input", () => renderTable());
          el("applyQuick").addEventListener("click", () => {
            applyQuick();
            el("saveToast").textContent = "Quick applied";
            setTimeout(() => (el("saveToast").textContent = ""), 1200);
          });
          el("markAllPresent").addEventListener("click", () => {
            markAllPresent();
            el("saveToast").textContent = "All marked present";
            setTimeout(() => (el("saveToast").textContent = ""), 1200);
          });
          el("saveAll").addEventListener("click", async () => {
            if (!currentClass) return alert("Pick a class");
            await saveDayAttendance(currentClass, currentDateStr);
            await loadMonthAttendance(currentClass, monthKey);
          });
          el("exportDaily").addEventListener("click", () => exportDailyPDF());
          el("exportMonthly").addEventListener("click", () =>
            exportMonthlyPDF()
          );
          el("exportStudent").addEventListener("click", () => {
            const id = prompt(
              "Enter student admission number or ID to export (leave blank to pick first in view):"
            );
            if (!id) {
              if (filtered.length) exportPdfForStudent(filtered[0].id);
              else alert("No student selected");
              return;
            }
            const s = students.find(
              (x) => (x.admissionNo || "") === id || x.id === id
            );
            if (!s) return alert("Student not found");
            exportPdfForStudent(s.id);
          });
          el("btnFullscreen").addEventListener("click", () => {
            if (!document.fullscreenElement)
              document.documentElement.requestFullscreen().catch(() => {});
            else document.exitFullscreen().catch(() => {});
          });
          setInterval(check3pmAlert, 60 * 1000);
          const handleYearChange = (yearValue) => {
            const nextYear = normalizeYearValue(
              yearValue || SOMAP_DEFAULT_YEAR
            );
            if (nextYear === currentYear) return;
            reloadForYear(nextYear);
          };
          if (window.somapYearContext?.onYearChanged) {
            window.somapYearContext.onYearChanged(handleYearChange);
          } else {
            window.addEventListener("somapYearChanged", (e) => {
              const yearValue =
                (e.detail && e.detail.year) || e.detail || SOMAP_DEFAULT_YEAR;
              handleYearChange(yearValue);
            });
          }
        }

        // ---------- 3PM alert ----------
        function check3pmAlert() {
          const now = new Date();
          const cut = new Date(now);
          cut.setHours(SCHOOL_DAY_CUTOFF_HOUR, 0, 0, 0);
          const box = el("todayAlert");
          if (now > cut) {
            const need = filtered.some((s) => {
              const rec = attendanceCache[s.id] || {};
              return !(rec.am && rec.pm);
            });
            if (need) {
              box.textContent =
                "‚ö†Ô∏è 3:00 PM: Attendance not fully marked for today";
              box.classList.remove("hidden");
            } else {
              box.classList.add("hidden");
            }
          } else {
            box.classList.add("hidden");
          }
        }

        // ---------- Utilities ----------
        function escapeHtml(s) {
          if (!s) return "";
          return String(s).replace(
            /[&<>"']/g,
            (m) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
              }[m])
          );
        }

        // ---------- Start ----------
        async function applyInitialClassSelection() {
          const sel = el("classSelect");
          if (!sel) return;
          const setAndActivate = async (value, lock = false) => {
            if (!value) return false;
            await activateClass(value);
            sel.value = currentClass;
            if (lock) {
              sel.disabled = true;
              sel.classList.add("cursor-not-allowed", "opacity-60");
              const lockedLabel = lockedClassStorage || currentClass || value;
              sel.title = lockedTeacherStorage
                ? `Locked to ${lockedLabel} for ${lockedTeacherStorage}`
                : `Locked to ${lockedLabel}`;
            }
            return true;
          };

          if (lockedClassStorage) {
            const lockedKey = canonicalClassKey(lockedClassStorage);
            let candidate = "";
            if (lockedKey) {
              const match = Array.from(sel.options).find(
                (opt) => canonicalClassKey(opt.value) === lockedKey
              );
              if (match) candidate = match.value;
            }
            if (!candidate) {
              candidate =
                resolveClassNameForData(lockedClassStorage) ||
                lockedClassStorage;
            }
            await setAndActivate(candidate, true);
            return;
          }

          if (currentClass) {
            if (await setAndActivate(currentClass)) return;
          }

          if (queryClassRaw) {
            const candidate = resolveClassNameForData(queryClassRaw);
            if (await setAndActivate(candidate)) return;
          }

          const classOptions = Array.from(sel.options).slice(1);
          if (classOptions.length === 1) {
            await setAndActivate(classOptions[0].value);
          }
        }
        function populateClassSelect() {
          const baseClasses = Array.from(
            new Set(students.map((s) => s.class))
          ).filter(Boolean);

          const options = [];
          const seen = new Set();

          const pushOption = (value) => {
            if (!value) return;
            const key = canonicalClassKey(value) || normalizeClassName(value);
            if (!key || seen.has(key)) return;
            seen.add(key);
            options.push(value);
          };

          baseClasses.forEach(pushOption);
          pushOption(lockedClassStorage);
          pushOption(queryClassRaw);
          pushOption(currentClass);

          options.sort((a, b) =>
            a.localeCompare(b, undefined, { sensitivity: "base" })
          );

          const sel = el("classSelect");
          sel.innerHTML =
            `<option value="">-- Select class --</option>` +
            options.map((c) => `<option value="${c}">${c}</option>`).join("");
        }

        async function init() {
          const now = new Date();
          currentDateStr = fmtDate(now);
          monthKey = toMonthKey(currentDateStr);
          el("dateInput").value = currentDateStr;

          await initializeFirebase();
          if (!db) return;

          el("rtState").textContent = "Loading students‚Ä¶";

          // 1Ô∏è‚É£ Load students with retry
          let loaded = false;
          currentYear = normalizeYearValue(
            window.somapYearContext?.getSelectedYear?.() || SOMAP_DEFAULT_YEAR
          );
          // Align date inputs / monthKey to the selected year (keep same month/day)
          currentDateStr = replaceYearInIsoDate(currentDateStr, currentYear);
          el("dateInput").value = currentDateStr;
          monthKey = toMonthKey(currentDateStr);
          for (let attempt = 1; attempt <= 3; attempt++) {
            students = await loadStudentsFromDb(currentYear);

            if (students.length) {
              loaded = true;
              break;
            }

            console.warn(
              `Attempt ${attempt} failed to load students. Retrying‚Ä¶`
            );
            await new Promise((resolve) => setTimeout(resolve, 1000));
          }

          if (!loaded) {
            el("rtState").textContent = "No students found";
            alert(
              "No students found in database. Please check Firebase data at /students."
            );
            return;
          }

          // 2Ô∏è‚É£ FAST initial render (no finance yet)
          renderTable();
          populateClassSelect();
          wireUI();
          setupShiftModal();
          subscribeShiftReports();
          await applyInitialClassSelection();

          // 3Ô∏è‚É£ Auto-activate single class if needed
          if (!currentClass) {
            const classes = Array.from(
              new Set(students.map((s) => s.class))
            ).filter(Boolean);

            if (classes.length === 1) {
              await activateClass(classes[0]);
            }
          }

          // 4 Background finance attach (NON-BLOCKING)
          attachFinanceDataForYear(currentYear);

          // 5Ô∏è‚É£ Final state text (finance will update later)
          if (lockedClassStorage) {
            el("rtState").textContent = `Locked to ${
              currentClass || lockedClassStorage
            }`;
          } else if (currentClass) {
            el("rtState").textContent = `Ready - ${currentClass}`;
          } else {
            el("rtState").textContent = "Ready";
          }
        }

        async function reloadForYear(yearValue) {
          const targetYear = normalizeYearValue(yearValue);
          if (yearReloadPromise) return;
          currentYear = targetYear;
          el("rtState").textContent = "Reloading year...";
          yearReloadPromise = (async () => {
            // Keep the same month/day but switch the year so attendance reads
            // and month keys align with the selected year.
            const dEl = el("dateInput");
            if (dEl) {
              const base = dEl.value || currentDateStr || fmtDate(new Date());
              const next = replaceYearInIsoDate(base, targetYear);
              dEl.value = next;
              currentDateStr = next;
            }
            students = await loadStudentsFromDb(targetYear);
            populateClassSelect();
            const fallbackClass =
              lockedClassStorage || currentClass || queryClassRaw || "";
            currentClass = fallbackClass;
            await applyInitialClassSelection();
            if (!currentClass) renderTable();
            attachFinanceDataForYear(targetYear);
          })();
          await yearReloadPromise;
          yearReloadPromise = null;
          if (lockedClassStorage) {
            el("rtState").textContent = `Locked to ${
              currentClass || lockedClassStorage
            }`;
          } else if (currentClass) {
            el("rtState").textContent = `Ready - ${currentClass}`;
          } else {
            el("rtState").textContent = "Ready";
          }
        }
        await init();
      })();
    </script>
  </body>
</html>











