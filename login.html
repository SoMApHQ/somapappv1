<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoMAp — Login</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- reCAPTCHA -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- Multischool context -->
  <script src="somapappv1multischool/js/context.js"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex flex-col">

<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
    <span class="font-bold text-indigo-600">SoMAp</span>

    <a href="somapappv1multischool/multischool.html"
       class="text-sm text-indigo-600 hover:underline">
      Switch School
    </a>
  </div>
</header>

<main class="flex-1 flex items-center justify-center px-4 py-10">
  <div class="w-full max-w-xl space-y-6">

    <!-- STAFF -->
    <section class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold text-center mb-2">Staff Sign-In</h2>
      <p class="text-center text-gray-600 mb-3">
        Use your school Google account
      </p>

      <div class="g-recaptcha mb-4"
        data-sitekey="6LekDsorAAAAAOkhrg-3PKJCHEpBN1HYQQzca83x"></div>

      <button id="googleLogin"
        class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-gray-100 rounded-lg font-semibold">
        <img src="https://developers.google.com/identity/images/g-logo.png" class="h-5">
        Sign in with Google
      </button>
    </section>

    <!-- PARENT -->
    <section class="bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-semibold mb-1">Parent Sign-In</h3>
      <p class="text-center text-gray-600 mb-3">
        Use any two or more of your child’s names and phone number
      </p>

      <form id="parentForm" class="space-y-3">
        <input id="childNames" required
          class="w-full px-3 py-2 border rounded-lg"
          placeholder="e.g. Mnyore Joseph Omondi" />

        <input id="parentPhone" required
          class="w-full px-3 py-2 border rounded-lg"
          placeholder="+2550XXXXXXXXX" />

        <button class="w-full bg-green-600 text-white py-2 rounded font-semibold">
          Sign In as Parent
        </button>
      </form>

      <p id="parentError" class="hidden text-red-600 text-sm mt-2 text-center"></p>
    </section>

    <!-- WORKER -->
    <section class="bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-semibold mb-1">Worker Sign-In</h3>
      <p class="text-center text-gray-600 mb-3">
        Enter THREE names (any spacing, case-insensitive) and phone starting with +2550
      </p>

      <form id="workerForm" class="space-y-3">
        <input id="workerName" required
          class="w-full px-3 py-2 border rounded-lg"
          placeholder="e.g. John Doe Junior" />

        <input id="workerPhone" required
          class="w-full px-3 py-2 border rounded-lg"
          placeholder="+2550XXXXXXXXX" />

        <button class="w-full bg-indigo-600 text-white py-2 rounded font-semibold">
          Sign In as Worker
        </button>
      </form>

      <p id="workerError" class="hidden text-red-600 text-sm mt-2 text-center"></p>
    </section>

  </div>
</main>

<footer class="bg-gray-900 text-gray-300 text-center py-4">
  © <span id="year"></span> SoMAp — Built for African schools
</footer>

<script>
/* YEAR */
document.getElementById("year").textContent = new Date().getFullYear();

/* FIREBASE INIT */
firebase.initializeApp({
  apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
  authDomain: "somaptestt.firebaseapp.com",
  databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
  projectId: "somaptestt"
});

const auth = firebase.auth();
const db = firebase.database();

/* SAFE AUTO-RESET (NON-DESTRUCTIVE) */
(function autoResetStaleState(){
  const last = localStorage.getItem("somap_last_login");
  if (last && Date.now() - Number(last) > 86400000) {
    sessionStorage.clear();
  }
})();

/* HELPERS */
function normalizePhone(phone) {
  if (!phone) return "";
  phone = phone.trim().replace(/[\s-()]/g, "");
  if (/^0\d{9}$/.test(phone)) return "+255" + phone.slice(1);
  if (phone.startsWith("+")) return phone;
  if (/^255\d{9}$/.test(phone)) return "+" + phone;
  return phone;
}

/* STAFF LOGIN */
googleLogin.onclick = async () => {
  if (!grecaptcha.getResponse()) {
    Swal.fire("Verify", "Complete CAPTCHA", "warning");
    return;
  }
  await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};

/* AUTH STATE (FIXED) */
auth.onAuthStateChanged(async (user) => {
  if (!user || !user.email) return;

  const emailKey = user.email.replace(/\./g, "_");
  const path = window.SOMAP ? SOMAP.P("users/" + emailKey) : "users/" + emailKey;

  const snap = await db.ref(path).once("value");
  if (!snap.exists()) return;

  const role = snap.val().role;
  localStorage.setItem("somap_last_login", Date.now());

  if (role === "admin") location.href = "dashboard.html";
  else if (role === "teacher") location.href = "staff.html";
  else if (role === "accountant") location.href = "mhasibu.html";
});

/* PARENT LOGIN — RESTORED LOGIC */
parentForm.onsubmit = async (e) => {
  e.preventDefault();

  const namesInput = childNames.value.trim().toLowerCase();
  const parentPhoneInput = parentPhone.value.trim();
  const normalizedPhone = normalizePhone(parentPhoneInput);

  parentError.classList.add("hidden");

  const nameParts = namesInput.split(/\s+/).filter(w => w.length >= 2);
  if (nameParts.length < 2) {
    parentError.textContent = "Enter at least two child names";
    parentError.classList.remove("hidden");
    return;
  }

  const roots = [
    window.SOMAP ? SOMAP.P("students") : "students",
    "students"
  ];

  let match = null;

  for (const root of roots) {
    const snap = await db.ref(root).once("value");
    snap.forEach(s => {
      const st = s.val();
      const full = `${st.firstName||""} ${st.middleName||""} ${st.lastName||""}`.toLowerCase();
      const phone = normalizePhone(
        st.parentPhone || st.parentContact ||
        st.primaryParentContact || st.primaryParentPhone || ""
      );

      const nameMatch = nameParts.every(n => full.includes(n));
      const phoneMatch =
        phone === normalizedPhone ||
        phone.endsWith(parentPhoneInput) ||
        normalizedPhone.endsWith(phone);

      if (nameMatch && phoneMatch) {
        match = s.key;
      }
    });
    if (match) break;
  }

  if (!match) {
    parentError.textContent = "No matching student found";
    parentError.classList.remove("hidden");
    return;
  }

  localStorage.setItem("role", "parent");
  localStorage.setItem("studentKey", match);
  location.href = "parent.html";
};

/* WORKER LOGIN (UNCHANGED LOGIC) */
workerForm.onsubmit = async (e) => {
  e.preventDefault();

  const name = workerName.value.trim().toUpperCase();
  const phone = workerPhone.value.trim();

  workerError.classList.add("hidden");

  const snap = await db.ref("workers").once("value");
  let found = null;

  snap.forEach(w => {
    const p = w.val().profile || {};
    if (p.fullNameUpper === name && p.phone === phone) found = w.key;
  });

  if (!found) {
    workerError.textContent = "Worker not found";
    workerError.classList.remove("hidden");
    return;
  }

  localStorage.setItem("role", "worker");
  localStorage.setItem("workerId", found);
  location.href = "workershtml/workersdashboard.html";
};
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/service-worker.js");
}
</script>

</body>
</html>
