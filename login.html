<!doctype html>
<html lang="en">
  <head>
    <style>
      /* Icon inside input */
      .input-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
        transition: color 0.15s ease;
      }

      /* Glow icon when input focused */
      .icon-input:focus-within .input-icon {
        color: #16a34a; /* green */
      }
      .icon-input.indigo:focus-within .input-icon {
        color: #4f46e5; /* indigo */
      }

      /* Error shake */
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-4px);
        }
        75% {
          transform: translateX(4px);
        }
      }

      .shake {
        animation: shake 0.25s ease-in-out;
      }

      /* Inline error icon */
      .error-icon {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #dc2626;
        font-size: 0.9rem;
      }
    </style>

    <script>
      (function enforceSchoolSelection() {
        const SCHOOL_KEY = "somap.currentSchoolId";

        const schoolId = localStorage.getItem(SCHOOL_KEY);

        // Block login if no school is selected
        if (!schoolId) {
          sessionStorage.setItem(
            "somap.redirectAfterSchool",
            "/login.html?login=1",
          );

          // Redirect to multischool selector
          window.location.replace("/somapappv1multischool/multischool.html");
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SoMAp â€” Login</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <!-- reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <!-- SweetAlert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Multischool context -->
    <script src="somapappv1multischool/js/context.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
  </head>

  <body
    class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex flex-col"
  >
    <header class="bg-white shadow sticky top-0 z-50">
      <div
        class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between"
      >
        <h1
          class="font-semibold text-gray-800 text-sm sm:text-lg leading-tight break-words"
        >
          SoMAp â€” Society Management App
        </h1>

        <a
          href="somapappv1multischool/multischool.html"
          class="h-8 px-4 flex items-center justify-center rounded-full text-sm font-semibold text-indigo-600 border border-indigo-600 hover:bg-indigo-50 active:scale-95 transition whitespace-nowrap"
        >
          Switch School
        </a>
      </div>
    </header>

    <main class="flex-1 flex items-center justify-center px-4 py-10">
      <div class="w-full max-w-xl space-y-6">
        <!-- STAFF -->
        <section class="bg-white rounded-xl shadow p-6">
          <h2 class="text-xl font-bold text-center mb-2">Staff Sign-In</h2>
          <p class="text-center text-gray-600 mb-3">
            Use your school Google account
          </p>

          <div
            class="g-recaptcha mb-4"
            data-sitekey="6LekDsorAAAAAOkhrg-3PKJCHEpBN1HYQQzca83x"
          ></div>

          <button
            id="googleLogin"
            class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-gray-100 rounded-lg font-semibold"
          >
            <img
              src="https://developers.google.com/identity/images/g-logo.png"
              class="h-5"
            />
            Sign in with Google
          </button>
        </section>

        <!-- PARENT -->

        <section class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-1">Parent Sign-In</h3>
          <p class="text-center text-gray-600 mb-3">
            Use any two or more of your childâ€™s names and phone number
          </p>

          <form id="parentForm" class="space-y-4">
            <!-- Child Names -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Childâ€™s Full Names
              </label>

              <div class="relative icon-input">
                <i class="fas fa-child input-icon"></i>

                <input
                  id="childNames"
                  class="w-full pl-10 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                  placeholder="e.g. Mnyore Joseph Omondi"
                  required
                />
              </div>
            </div>

            <!-- Parent Phone -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Parent Phone Number
              </label>

              <div class="relative icon-input">
                <i class="fas fa-phone input-icon"></i>

                <input
                  id="parentPhone"
                  class="w-full pl-10 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                  placeholder="0XXXXXXXXX"
                  required
                />

                <!-- Tanzania hint -->
                <span class="text-xs text-gray-400 block mt-1">
                  ðŸ‡¹ðŸ‡¿ Tanzania format: 0XXXXXXXXX
                </span>
              </div>
            </div>

            <button
              type="submit"
              class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded font-semibold transition"
            >
              Sign In as Parent
            </button>
          </form>

          <p
            id="parentError"
            class="hidden text-red-600 text-sm mt-2 text-center"
          ></p>
        </section>

        <!-- WORKER -->

        <section class="bg-white rounded-xl shadow p-6">
          <h3 class="text-lg font-semibold mb-1">Worker Sign-In</h3>
          <p class="text-center text-gray-600 mb-3">
            Enter THREE names (any spacing, case-insensitive) and phone starting
            with +2550
          </p>

          <form id="workerForm" class="space-y-4">
            <!-- Worker Name -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Full Name (Three Names)
              </label>

              <div class="relative icon-input indigo">
                <i class="fas fa-user-tie input-icon"></i>

                <input
                  id="workerName"
                  class="w-full pl-10 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="e.g. John Doe Junior"
                  required
                />
              </div>
            </div>

            <!-- Worker Phone -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">
                Phone Number (+2550xxxxxxxxx)
              </label>

              <div class="relative icon-input indigo">
                <i class="fas fa-mobile-alt input-icon"></i>

                <input
                  id="workerPhone"
                  class="w-full pl-10 pr-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                  placeholder="+2550XXXXXXXXX"
                  required
                />

                <span class="text-xs text-gray-400 block mt-1">
                  ðŸ‡¹ðŸ‡¿ Tanzania format only
                </span>
              </div>
            </div>

            <button
              type="submit"
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded font-semibold transition"
            >
              Sign In as Worker
            </button>
          </form>

          <p
            id="workerError"
            class="hidden text-red-600 text-sm mt-2 text-center"
          ></p>
        </section>
      </div>
    </main>

    <footer class="bg-gray-900 text-gray-300">
      <div class="max-w-7xl mx-auto px-4 py-10">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div>
            <h3 class="text-white font-bold">SoMAp</h3>
            <p class="mt-2 text-sm">
              School & Society Management Platform built for African
              institutions.
            </p>
          </div>

          <div>
            <h4 class="text-white font-semibold text-sm uppercase">Platform</h4>
            <ul class="mt-3 space-y-2 text-sm">
              <li><a href="login.html" class="hover:text-white">Login</a></li>
              <li>
                <a href="join.html" class="hover:text-white">Admissions</a>
              </li>
              <li>
                <a
                  href="societycashbook/societycashbook.html"
                  class="hover:text-white"
                  >Cashbook</a
                >
              </li>
            </ul>
          </div>

          <div>
            <h4 class="text-white font-semibold text-sm uppercase">Project</h4>
            <p class="text-sm mt-3">Project: somaptestt</p>
            <p class="text-sm">Contact: mnyorej@gmail.com</p>
          </div>
        </div>

        <div class="mt-8 border-t border-gray-700 pt-4 text-center text-sm">
          Â© <span id="year"></span> SoMAp â€” Built for African schools
        </div>
      </div>
    </footer>
    <script>
      document.getElementById("year").textContent = new Date().getFullYear();

      /* FIREBASE INIT */
      firebase.initializeApp({
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
      });

      const auth = firebase.auth();
      const db = firebase.database();

      /* SAFE AUTO-RESET (NON-DESTRUCTIVE) */
      (function autoResetStaleState() {
        const last = localStorage.getItem("somap_last_login");
        if (last && Date.now() - Number(last) > 86400000) {
          sessionStorage.clear();
        }
      })();

      /* HELPERS */
      function normalizePhone(phone) {
        if (!phone) return "";
        phone = phone.trim().replace(/[\s-()]/g, "");
        if (/^0\d{9}$/.test(phone)) return "+255" + phone.slice(1);
        if (phone.startsWith("+")) return phone;
        if (/^255\d{9}$/.test(phone)) return "+" + phone;
        return phone;
      }
      function normalizePhoneAll(phone) {
        if (!phone) return "";
        return phone
          .toString()
          .replace(/\D/g, "") // remove all non-digits
          .replace(/^0/, "255") // 0712... â†’ 255712...
          .replace(/^\+/, ""); // remove +
      }

      function normalizeName(name) {
        return name
          .toLowerCase()
          .replace(/[^a-z]/g, " ")
          .split(/\s+/)
          .filter((n) => n.length >= 2);
      }

      /* STAFF LOGIN */
      googleLogin.onclick = async () => {
        if (!grecaptcha.getResponse()) {
          Swal.fire("Verify", "Complete CAPTCHA", "warning");
          return;
        }
        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      };

      /* AUTH STATE */
      auth.onAuthStateChanged(async (user) => {
        if (!user || !user.email) return;

        const emailKey = user.email.replace(/\./g, "_");
        // /users is GLOBAL. Do not wrap with SOMAP.P()
        const userPath = "users/" + emailKey;

        const snap = await db.ref(userPath).once("value");
        if (!snap.exists()) return;

        const role = snap.val().role;
        localStorage.setItem("somap_last_login", Date.now());

        if (role === "admin") location.href = "dashboard.html";
        else if (role === "teacher") location.href = "staff.html";
        else if (role === "accountant") location.href = "mhasibu.html";
      });

      /* PARENT LOGIN*/
      parentForm.onsubmit = async (e) => {
        e.preventDefault();

        const inputNames = normalizeName(childNames.value);
        const inputPhone = normalizePhoneAll(parentPhone.value);

        parentError.classList.add("hidden");

        if (inputNames.length < 2) {
          parentError.textContent = "Enter at least two child names";
          parentError.classList.remove("hidden");
          return;
        }

        const roots = [
          window.SOMAP ? SOMAP.P("students") : "students",
          "students",
        ];

        let match = null;

        for (const root of roots) {
          const snap = await db.ref(root).once("value");

          snap.forEach((s) => {
            const st = s.val();

            const fullName = normalizeName(
              `${st.firstName || ""} ${st.middleName || ""} ${st.lastName || ""}`,
            );

            const dbPhone = normalizePhoneAll(
              st.parentPhone ||
                st.parentContact ||
                st.primaryParentContact ||
                st.primaryParentPhone ||
                "",
            );

            const nameMatches = inputNames.filter((n) =>
              fullName.includes(n),
            ).length;

            const phoneMatch =
              dbPhone.endsWith(inputPhone.slice(-7)) ||
              inputPhone.endsWith(dbPhone.slice(-7));

            if (nameMatches >= 2 && phoneMatch) {
              match = s.key;
            }
          });

          if (match) break;
        }

        if (!match) {
          parentError.textContent =
            "Student not found. Check spelling or phone number.";
          parentError.classList.remove("hidden");
          shakeField("childNames");
          shakeField("parentPhone");
          return;
        }

        localStorage.setItem("role", "parent");
        localStorage.setItem("studentKey", match);
        location.href = "parent.html";
      };

      /* WORKER LOGIN */
      workerForm.onsubmit = async (e) => {
        e.preventDefault();

        const name = workerName.value.trim().toUpperCase();
        const phone = workerPhone.value.trim();

        workerError.classList.add("hidden");

        const snap = await db.ref("workers").once("value");
        let found = null;

        snap.forEach((w) => {
          const p = w.val().profile || {};
          if (p.fullNameUpper === name && p.phone === phone) found = w.key;
        });

        if (!found) {
          workerError.textContent = "Worker not found";
          workerError.classList.remove("hidden");
          return;
        }

        localStorage.setItem("role", "worker");
        localStorage.setItem("workerId", found);
        location.href = "workershtml/workersdashboard.html";
      };
      function shakeField(id) {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.add("shake");
        setTimeout(() => el.classList.remove("shake"), 300);
      }
    </script>

    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/service-worker.js");

        navigator.serviceWorker.addEventListener("message", (msg) => {
          if (msg.data === "UPDATE_AVAILABLE") {
            location.reload();
          }
        });
      }
    </script>
  </body>
</html>
