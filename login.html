<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SoMAp — Login</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <!-- reCAPTCHA -->
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex flex-col">

<!-- ================= HEADER ================= -->
<header class="bg-white shadow sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
    <span class="font-bold text-indigo-600">SoMAp</span>

    <div class="flex items-center gap-4">
      <a
        href="somapappv1multischool/multischool.html"
        class="text-sm text-indigo-600 hover:underline"
      >
        Switch School
      </a>

      <select id="langSelect" class="border rounded px-2 py-1 text-sm">
        <option value="en">English</option>
        <option value="sw">Swahili</option>
      </select>
    </div>
  </div>
</header>

<!-- ================= MAIN ================= -->
<main class="flex-1 flex items-center justify-center px-4 py-10">
  <div class="w-full max-w-xl space-y-6">

    <!-- STAFF -->
    <section class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold text-center mb-2">Staff Sign-In</h2>
      <p class="text-center text-gray-600 mb-3">
        Use your school Google account
      </p>

      <div class="g-recaptcha mb-4"
        data-sitekey="6LekDsorAAAAAOkhrg-3PKJCHEpBN1HYQQzca83x"></div>

      <button id="googleLogin"
        class="w-full flex items-center justify-center gap-3 px-4 py-3 bg-gray-100 rounded-lg font-semibold">
        <img src="https://developers.google.com/identity/images/g-logo.png" class="h-5">
        Sign in with Google
      </button>
    </section>

    <!-- PARENT -->
    <section class="bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-semibold mb-1">Parent Sign-In</h3>
      <p class="text-center text-gray-600 mb-3">
        Use any two or more of your child’s names and phone number
      </p>

      <form id="parentForm" class="space-y-3">
        <div>
          <label for="childNames" class="block text-sm font-medium text-gray-700">
            Child’s Names
          </label>
          <input
            id="childNames"
            class="w-full px-3 py-2 border rounded-lg"
            placeholder="e.g. Mnyore Joseph Omondi"
            required
          />
        </div>

        <div>
          <label for="parentPhone" class="block text-sm font-medium text-gray-700">
            Parent Phone Number
          </label>
          <input
            id="parentPhone"
            class="w-full px-3 py-2 border rounded-lg"
            placeholder="+2550XXXXXXXXX"
            required
          />
        </div>

        <button
          class="w-full bg-green-600 text-white py-2 rounded font-semibold">
          Sign In as Parent
        </button>
      </form>

      <p id="parentError" class="hidden text-red-600 text-sm mt-2 text-center"></p>
    </section>

    <!-- WORKER -->
    <section class="bg-white rounded-xl shadow p-6">
      <h3 class="text-lg font-semibold mb-1">Worker Sign-In</h3>
      <p class="text-center text-gray-600 mb-3">
        Enter THREE names (any spacing, case-insensitive) and phone starting with +2550
      </p>

      <form id="workerForm" class="space-y-3">
        <div>
          <label for="workerName" class="block text-sm font-medium text-gray-700">
            Full Name (Three Names)
          </label>
          <input
            id="workerName"
            class="w-full px-3 py-2 border rounded-lg"
            placeholder="e.g. John Doe Junior"
            required
          />
        </div>

        <div>
          <label for="workerPhone" class="block text-sm font-medium text-gray-700">
            Phone Number (+2550xxxxxxxxx)
          </label>
          <input
            id="workerPhone"
            class="w-full px-3 py-2 border rounded-lg"
            placeholder="+2550XXXXXXXXX"
            required
          />
        </div>

        <button
          class="w-full bg-indigo-600 text-white py-2 rounded font-semibold">
          Sign In as Worker
        </button>
      </form>

      <p id="workerError" class="hidden text-red-600 text-sm mt-2 text-center"></p>
    </section>

  </div>
</main>

<!-- ================= FOOTER ================= -->
<footer class="bg-gray-900 text-gray-300 text-center py-4">
  © <span id="year"></span> SoMAp — Built for African schools
</footer>

<script>
/* YEAR */
document.getElementById("year").textContent = new Date().getFullYear();

/* FIREBASE */
firebase.initializeApp({
  apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
  authDomain: "somaptestt.firebaseapp.com",
  databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
  projectId: "somaptestt"
});
const auth = firebase.auth();
const db = firebase.database();

/* HELPERS */
function normalizePhone(phone) {
  if (!phone) return "";
  phone = phone.trim().replace(/[\s-()]/g, "");
  if (/^0\d{9}$/.test(phone)) return "+255" + phone.slice(1);
  if (phone.startsWith("+")) return phone;
  if (/^255\d{9}$/.test(phone)) return "+" + phone;
  return phone;
}

/* STAFF */
googleLogin.onclick = async () => {
  if (!grecaptcha.getResponse()) {
    Swal.fire("Verify", "Complete CAPTCHA", "warning");
    return;
  }
  await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
};

/* AUTH STATE + DEVICE AUTO LOGIN */
auth.onAuthStateChanged(async (user) => {
  if (user?.uid) {
    const d = await db.ref(`devices/${user.uid}/workerId`).once("value");
    if (d.exists()) {
      localStorage.setItem("role", "worker");
      localStorage.setItem("workerId", d.val());
      sessionStorage.setItem("workerDashboardActive", "true");
      location.href = "workershtml/workersdashboard.html";
      return;
    }
  }

  if (!user?.email) return;

  const key = user.email.replace(/\./g, "_");
  const snap = await db.ref("users/" + key).once("value");
  const role = snap.val()?.role;

  if (role === "admin") location.href = "dashboard.html";
  else if (role === "teacher") location.href = "staff.html";
  else if (role === "accountant") location.href = "mhasibu.html";
};

/* PARENT LOGIN */
parentForm.onsubmit = async (e) => {
  e.preventDefault();
  const names = childNames.value.trim().toLowerCase().split(/\s+/);
  const phone = normalizePhone(parentPhone.value);
  parentError.classList.add("hidden");

  const snap = await db.ref("students").once("value");
  let found = null;

  snap.forEach(s => {
    const st = s.val();
    const full = `${st.firstName||""} ${st.middleName||""} ${st.lastName||""}`.toLowerCase();
    const dbPhone = normalizePhone(st.parentPhone || st.parentContact || "");
    if (names.every(n => full.includes(n)) && dbPhone === phone) found = s.key;
  });

  if (!found) {
    parentError.textContent = "No matching student found";
    parentError.classList.remove("hidden");
    return;
  }

  localStorage.setItem("role", "parent");
  localStorage.setItem("studentKey", found);
  location.href = "parent.html";
};

/* WORKER LOGIN */
workerForm.onsubmit = async (e) => {
  e.preventDefault();
  const name = workerName.value.trim().toUpperCase();
  const phone = workerPhone.value.trim();
  workerError.classList.add("hidden");

  const snap = await db.ref("workers").once("value");
  let found = null;

  snap.forEach(w => {
    const p = w.val().profile || {};
    if (p.fullNameUpper === name && p.phone === phone) found = w.key;
  });

  if (!found) {
    workerError.textContent = "Worker not found";
    workerError.classList.remove("hidden");
    return;
  }

  localStorage.setItem("role", "worker");
  localStorage.setItem("workerId", found);
  location.href = "workershtml/workersdashboard.html";
};
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("/service-worker.js");
}
</script>

</body>
</html>
