<!-- dashboard.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>
    <script src="somapappv1multischool/js/context.js"></script>
    <script src="Todashboardhtml/yearContext.js"></script>
    <title>SoMAp - Society Management App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <script type="module">
      import { mountMarketingHubCard } from "./marketing/marketing.js";
      window.addEventListener("DOMContentLoaded", () => {
        const el = document.getElementById("marketinghub-card-root");
        if (el) mountMarketingHubCard({ el, context: "admin" });
      });
    </script>
    <style>
      /* ==== SoMAp anti-overlap + responsive overrides ==== */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      .app-header h1,
      .app-header .title,
      .section h1,
      .section h2,
      .section h3,
      .section p,
      .card,
      .card *,
      .stat-card,
      .stat-card *,
      .badge,
      .pill,
      .menu-group h3,
      .workspace .grid,
      .workspace .grid * {
        white-space: normal !important;
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      .workspace,
      .section,
      .card,
      .stat-card,
      .grid,
      .row {
        min-width: 0;
      }
      .layout-row,
      .grid,
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .card,
      .stat-card {
        flex: 1 1 280px;
        min-width: 240px;
      }
      img,
      video,
      canvas {
        max-width: 100%;
        height: auto;
      }
      .workspace-shell {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .workspace {
        margin-left: 0;
        padding: 2.5rem clamp(1.25rem, 4vw, 3rem) 4rem;
        width: 100%;
      }
      @media (max-width: 768px) {
        .workspace {
          padding: 2rem 1.25rem 3rem;
        }
      }
      :root {
        --primary: #38bdf8;
        --secondary: #a855f7;
        --success: #10b981;
        --danger: #f43f5e;
        --warning: #f97316;
        --info: #06b6d4;
        --glass: rgba(15, 23, 42, 0.78);
        --border: rgba(148, 163, 184, 0.25);
        --text: #f1f5f9;
        --muted: rgba(148, 163, 184, 0.9);
      }
      .dashboard-body,
      body {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        overflow-x: hidden;
        min-height: 100vh;
        background: radial-gradient(
            1200px 600px at -10% -10%,
            rgba(56, 189, 248, 0.25),
            transparent 60%
          ),
          radial-gradient(
            800px 500px at 110% 0%,
            rgba(168, 85, 247, 0.22),
            transparent 55%
          ),
          linear-gradient(145deg, #020617, #050c1f 45%, #020617 100%);
        color: var(--text);
      }
      .glass-header {
        position: sticky;
        top: 0;
        z-index: 30;
        background: rgba(2, 6, 23, 0.75);
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        backdrop-filter: blur(18px);
      }
      .glass-header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.5rem;
        padding: 1rem clamp(1.5rem, 4vw, 3rem);
      }
      .menu-launcher {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.6);
        color: #e0f2fe;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
        cursor: pointer;
        transition: transform 0.2s ease, border-color 0.2s ease,
          background 0.2s ease;
      }
      .menu-launcher:hover {
        transform: translateY(-1px);
        border-color: rgba(56, 189, 248, 0.8);
        background: rgba(15, 23, 42, 0.85);
      }
      .header-icon {
        width: 42px;
        height: 42px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.25);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        transition: transform 0.2s ease, border-color 0.2s ease;
      }
      .header-icon:hover {
        transform: translateY(-2px);
        border-color: rgba(56, 189, 248, 0.8);
      }
      .page-title-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }
      .page-title-stack {
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        gap: 0.35rem;
        color: var(--text);
        line-height: 1.35;
      }
      .page-title-main {
        font-size: clamp(1.4rem, 4vw, 2.3rem);
        font-weight: 800;
        color: #e0f2fe;
      }
      .page-title-divider {
        font-size: clamp(0.9rem, 2.5vw, 1.4rem);
        opacity: 0.6;
      }
      .page-title-sub {
        font-size: clamp(0.85rem, 3vw, 1.15rem);
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: rgba(226, 232, 240, 0.9);
      }
      @media (max-width: 640px) {
        .glass-header-content {
          flex-direction: column;
          align-items: flex-start;
        }
        .page-title-stack {
          gap: 0.2rem;
        }
        .page-title-main {
          font-size: 1.35rem;
        }
        .page-title-sub {
          font-size: 0.85rem;
          letter-spacing: 0.08em;
        }
      }
      .command-menu {
        position: fixed;
        inset: 0;
        background: radial-gradient(
          circle at top,
          rgba(15, 23, 42, 0.85),
          rgba(2, 6, 23, 0.92)
        );
        backdrop-filter: blur(10px);
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding: 1.5rem;
        z-index: 60;
        overflow-y: auto;
      }
      .command-menu.open {
        display: flex;
      }
      .command-menu__panel {
        width: min(460px, 100%);
        max-height: 90vh;
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 1.5rem;
        box-shadow: 0 25px 60px rgba(0, 0, 0, 0.45);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        overflow-y: auto;
      }
      .command-menu__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }
      .menu-close {
        width: 38px;
        height: 38px;
        border-radius: 999px;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: transparent;
        color: var(--text);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .command-menu__grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.85rem;
      }
      .command-tile {
        position: relative;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        padding: 0.95rem;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.2);
        background: rgba(15, 23, 42, 0.6);
        color: var(--text);
        text-align: left;
        transition: transform 0.2s ease, border-color 0.2s ease,
          background 0.2s ease;
      }
      .command-tile.active {
        border-color: rgba(56, 189, 248, 0.6);
        background: rgba(15, 23, 42, 0.85);
      }
      .command-tile i {
        font-size: 1.35rem;
        color: var(--primary);
      }
      .command-tile:hover {
        transform: translateY(-3px);
        border-color: rgba(56, 189, 248, 0.55);
        background: rgba(15, 23, 42, 0.9);
      }
      .card {
        border-radius: 0.75rem;
        box-shadow: 0 25px 45px rgba(15, 23, 42, 0.35);
        transition: all 0.3s;
        background: rgba(15, 23, 42, 0.55);
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: #f8fafc;
        backdrop-filter: blur(18px);
      }
      .card:hover {
        transform: translateY(-6px);
        box-shadow: 0 35px 60px rgba(15, 23, 42, 0.45);
      }
      .stat-card {
        transition: all 0.3s;
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.65),
          rgba(14, 165, 233, 0.52)
        );
        color: #f8fafc;
        border: 1px solid rgba(191, 219, 254, 0.4);
        backdrop-filter: blur(14px);
      }
      .stat-card:hover {
        transform: translateY(-4px);
      }
      .btn {
        transition: all 0.2s;
      }
      .btn:hover {
        transform: translateY(-1px);
      }
      .btn:active {
        transform: translateY(0);
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      .loader {
        border-top-color: var(--primary);
        animation: spinner 0.6s linear infinite;
      }
      @keyframes spinner {
        to {
          transform: rotate(360deg);
        }
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }
      .workspace {
        flex: 1 1 auto;
        min-width: 0;
        overflow-x: hidden;
        overflow-y: auto;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        max-width: 100%;
        word-break: break-word;
      }
      .stat-card .mt-4,
      .card .mt-4 {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      @media (min-width: 1024px) {
        .grid {
          gap: 2rem;
        }
        .workspace {
          padding: 1.5rem;
        }
      }
      @media (max-width: 767px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .workspace {
          padding: 0.5rem;
        }
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
      .badge-pulse {
        animation: pulse 2s infinite;
      }
      .glass-panel {
        background: rgba(15, 23, 42, 0.75);
        border: 1px solid rgba(148, 163, 184, 0.2);
        box-shadow: 0 18px 35px rgba(2, 6, 23, 0.6);
        backdrop-filter: blur(12px);
      }
      .main-content {
        margin-left: 0;
        padding: 20px;
      }
      .welcome-note {
        background: linear-gradient(
          135deg,
          rgba(56, 189, 248, 0.16),
          rgba(99, 102, 241, 0.24)
        );
        padding: 50px;
        text-align: center;
        border-radius: 20px;
        margin: 50px auto;
        max-width: 800px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow: 0 25px 60px rgba(2, 6, 23, 0.55);
        color: var(--text);
        backdrop-filter: blur(14px);
      }
      .market-section {
        background: linear-gradient(
          135deg,
          rgba(14, 165, 233, 0.18),
          rgba(59, 130, 246, 0.22)
        );
        padding: 30px;
        border-radius: 15px;
        color: #f8fafc;
        border: 1px solid rgba(148, 163, 184, 0.25);
        box-shadow: 0 20px 45px rgba(2, 6, 23, 0.5);
        backdrop-filter: blur(12px);
      }
      .market-img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .quick-action-btn {
        background: linear-gradient(
          135deg,
          rgba(79, 70, 229, 0.9),
          rgba(56, 189, 248, 0.85)
        );
        color: #fff;
        border: none;
        margin: 10px;
        padding: 15px 30px;
        border-radius: 999px;
        font-weight: bold;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 18px 40px rgba(14, 165, 233, 0.35);
      }
      .quick-action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 24px 50px rgba(14, 165, 233, 0.4);
      }
      #language-select {
        margin: 20px auto;
        width: 200px;
        background: #fff;
        color: #000;
        border: 2px solid #ced4da;
        border-radius: 10px;
      }
      .events-list {
        list-style: none;
        padding: 0;
      }
      .events-list li {
        background: #fff;
        color: #000;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .chart-container {
        background: #fff;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
      }
      .footer {
        background-color: #343a40;
        color: #fff;
        padding: 20px;
        text-align: center;
        margin-top: 50px;
        border-top: 2px solid #fff;
      }
      .role-specific {
        display: none;
      }
      .module-section {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        color: #000;
      }
      .attendance-trends {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
      }
      .discipline-card {
        background: linear-gradient(135deg, #dc3545, #f55);
      }
      .finance-overview {
        background: linear-gradient(135deg, #28a745, #198754);
      }
      .resource-card {
        background: linear-gradient(135deg, #0dcaf0, #20c997);
      }
      .communication-stats {
        background: linear-gradient(135deg, #6610f2, #6f42c1);
      }
      .ai-insights {
        background: linear-gradient(135deg, #d63384, #dc3545);
        color: #fff;
      }
      .volunteer-section {
        background: linear-gradient(135deg, #ffc107, #ffca2c);
      }
      .calendar {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
      }
      .hidden {
        display: none;
      }
      .btn-custom {
        background-color: #6f42c1;
        color: #fff;
        border-radius: 50px;
        padding: 10px 20px;
      }
      .form-control-custom {
        border-radius: 10px;
        border: 2px solid #ced4da;
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        color: #fff;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }
      .card h5,
      .card p,
      .events-list li {
        color: #f8fafc;
        text-shadow: none;
      }
      p {
        line-height: 1.6;
      }
      .img-fluid {
        border-radius: 10px;
      }
      .section-padding {
        padding: 40px 0;
      }
      .card-body {
        padding: 20px;
      }
      /* New Finance Cards in Dashboard */
      .finance-card {
        background: linear-gradient(
          135deg,
          rgba(99, 102, 241, 0.85),
          rgba(16, 185, 129, 0.7)
        );
        color: #f8fafc;
        border-radius: 1rem;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid rgba(191, 219, 254, 0.35);
        box-shadow: 0 30px 50px rgba(15, 23, 42, 0.4);
        backdrop-filter: blur(18px);
      }
      .finance-card h5 {
        color: #f8fafc;
        text-shadow: 1px 1px 2px rgba(15, 23, 42, 0.4);
      }
      .finance-card p {
        font-size: 1.6rem;
        font-weight: 700;
      }
      .remedial-card {
        cursor: pointer;
        background: linear-gradient(
          145deg,
          rgba(244, 114, 182, 0.78),
          rgba(99, 102, 241, 0.72)
        );
      }
      .remedial-card:hover {
        transform: translateY(-6px);
      }
      .remedial-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.2rem 0.55rem;
        border-radius: 999px;
        font-size: 0.72rem;
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.4);
      }
      .remedial-modal {
        position: fixed;
        inset: 0;
        z-index: 140;
        display: none;
        background: rgba(2, 6, 23, 0.75);
        backdrop-filter: blur(7px);
        align-items: center;
        justify-content: center;
        padding: 1rem;
      }
      .remedial-modal.open {
        display: flex;
      }
      .remedial-panel {
        width: min(1200px, 96vw);
        max-height: 92vh;
        overflow: auto;
        border-radius: 1rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: linear-gradient(
            180deg,
            rgba(15, 23, 42, 0.92),
            rgba(15, 23, 42, 0.96)
          ),
          radial-gradient(
            900px 400px at 10% 0%,
            rgba(236, 72, 153, 0.24),
            transparent 70%
          );
        box-shadow: 0 32px 60px rgba(0, 0, 0, 0.55);
        color: #e2e8f0;
      }
      .remedial-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        align-items: center;
      }
      .remedial-input,
      .remedial-select {
        min-height: 2.2rem;
        border-radius: 0.65rem;
        border: 1px solid rgba(148, 163, 184, 0.35);
        background: rgba(15, 23, 42, 0.82);
        color: #e2e8f0;
        padding: 0.45rem 0.65rem;
      }
      .remedial-btn {
        border-radius: 0.6rem;
        border: 1px solid rgba(148, 163, 184, 0.28);
        padding: 0.45rem 0.8rem;
        font-size: 0.85rem;
        font-weight: 700;
      }
      .remedial-table-wrap {
        border: 1px solid rgba(148, 163, 184, 0.22);
        border-radius: 0.8rem;
        overflow: auto;
      }
      .remedial-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 980px;
      }
      .remedial-table th,
      .remedial-table td {
        border-bottom: 1px solid rgba(148, 163, 184, 0.2);
        padding: 0.6rem 0.55rem;
        text-align: left;
        font-size: 0.82rem;
      }
      .remedial-table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: rgba(30, 41, 59, 0.98);
        color: #e2e8f0;
      }
      .remedial-row-risk {
        background: rgba(239, 68, 68, 0.32);
      }
      .remedial-row-ok {
        background: rgba(16, 185, 129, 0.16);
      }
      .remedial-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.65rem;
      }
      .remedial-kpi {
        border-radius: 0.75rem;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.64);
        padding: 0.75rem;
      }
      .remedial-kpi .v {
        font-size: 1.15rem;
        font-weight: 800;
        color: #f8fafc;
      }
      .remedial-kpi .l {
        font-size: 0.75rem;
        color: #cbd5e1;
      }
      .remedial-exp-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 0.75rem;
      }
    </style>

    <script>
      /** Year range + anchor **/
      const SOMAP_ALLOWED_YEARS = Array.from(
        { length: 20 },
        (_, i) => 2023 + i
      ); // 2023..2042
      const SOMAP_DEFAULT_YEAR = 2025;

      /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
      const CLASS_ORDER = [
        "Baby Class",
        "Middle Class",
        "Pre Unit Class",
        "Class 1",
        "Class 2",
        "Class 3",
        "Class 4",
        "Class 5",
        "Class 6",
        "Class 7",
      ];
      const L = (s) =>
        String(s || "")
          .trim()
          .toLowerCase();
      const CLASS_ALIASES = {
        middle: "Middle Class",
        "middle class": "Middle Class",
        "pre unit": "Pre Unit Class",
        preunit: "Pre Unit Class",
        "pre unit class": "Pre Unit Class",
        "preunit class": "Pre Unit Class",
        "pre-unit": "Pre Unit Class",
      };

      /** Shift a base class by delta years relative to anchor (2025). */
      function shiftClass(baseClass, deltaYears) {
        const alias = CLASS_ALIASES[L(baseClass)] || baseClass;
        const i = CLASS_ORDER.findIndex((c) => L(c) === L(alias));
        if (i < 0) return baseClass || "";
        const j = i + Number(deltaYears || 0);
        if (j < 0) return "PRE-ADMISSION";
        if (j >= CLASS_ORDER.length) return "GRADUATED";
        return CLASS_ORDER[j];
      }
    </script>

    <script>
      /** Reuse shared year context if present, else create a light fallback. */
      window.somapYearContext =
        window.somapYearContext ||
        (function () {
          let selected =
            (sessionStorage.getItem("somap_selected_year") ||
              SOMAP_DEFAULT_YEAR) + "";
          const listeners = new Set();
          return {
            getSelectedYear() {
              return selected;
            },
            setSelectedYear(y) {
              y = String(y);
              if (selected === y) return;
              selected = y;
              try {
                sessionStorage.setItem("somap_selected_year", y);
              } catch (_e) {}
              listeners.forEach((fn) => {
                try {
                  fn(y);
                } catch (err) {
                  console.error(err);
                }
              });
            },
            onYearChanged(fn) {
              if (typeof fn === "function") listeners.add(fn);
            },
          };
        })();
    </script>

    <script src="js/finance_dedupe.js"></script>
    <script src="shared/finance_math.js"></script>
    <script src="js/school-logo.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (window.SomapLogo) {
          SomapLogo.loadSchoolLogo({
            defaultLogo: "images/socrates_logo.png",
            fallbackLogo: "images/somap-logo.png.jpg",
          });
        }
      });
    </script>
  </head>
  <body class="dashboard-body">
    <div id="commandMenu" class="command-menu" aria-hidden="true">
      <div class="command-menu__panel">
        <div class="command-menu__header">
          <div class="flex items-center gap-3">
            <img
              id="school-logo-display"
              src="images/somap-logo.png.jpg"
              alt="School Logo"
              class="h-12 w-12 rounded-2xl object-cover"
            />
            <div>
              <p
                class="text-xs uppercase tracking-[0.35em] text-slate-400 mb-1"
              >
                SoMAp
              </p>
              <p class="text-base font-semibold text-slate-100">
                Experience Hub
              </p>
            </div>
          </div>
          <button
            id="commandMenuClose"
            class="menu-close"
            aria-label="Close menu"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="command-menu__grid">
          <button class="command-tile active" data-module="dashboard">
            <i class="fas fa-th-large"></i>
            <div>
              <p class="text-sm font-semibold">Dashboard</p>
              <p class="text-[0.7rem] text-slate-400">Live pulse</p>
            </div>
          </button>
          <button class="command-tile" data-module="erp">
            <i class="fas fa-user-graduate"></i>
            <div>
              <p class="text-sm font-semibold">Academic</p>
              <p class="text-[0.7rem] text-slate-400">School ERP</p>
            </div>
          </button>
          <button class="command-tile" data-module="attendance">
            <i class="fas fa-check-circle"></i>
            <div>
              <p class="text-sm font-semibold">Attendance</p>
              <p class="text-[0.7rem] text-slate-400">Daily roll call</p>
            </div>
          </button>
          <button class="command-tile" data-module="discipline">
            <i class="fas fa-exclamation-circle"></i>
            <div>
              <p class="text-sm font-semibold">Discipline</p>
              <p class="text-[0.7rem] text-slate-400">Incidents & care</p>
            </div>
          </button>
          <button class="command-tile" data-module="finance">
            <i class="fas fa-money-bill-wave"></i>
            <div>
              <p class="text-sm font-semibold">Finance</p>
              <p class="text-[0.7rem] text-slate-400">Collections & dues</p>
            </div>
          </button>
          <a href="Bookshtml/upload.html" class="command-tile">
            <i class="fas fa-book"></i>
            <div>
              <p class="text-sm font-semibold">Books</p>
              <p class="text-[0.7rem] text-slate-400">Digital shelf</p>
            </div>
          </a>
          <button class="command-tile" data-module="communications">
            <span
              class="absolute top-2 right-2 bg-rose-500 text-white text-[0.65rem] rounded-full h-5 w-5 flex items-center justify-center badge-pulse"
              >5</span
            >
            <i class="fas fa-comment-alt"></i>
            <div>
              <p class="text-sm font-semibold">Comms</p>
              <p class="text-[0.7rem] text-slate-400">Announcements</p>
            </div>
          </button>
          <button class="command-tile" data-module="market">
            <i class="fas fa-store"></i>
            <div>
              <p class="text-sm font-semibold">Market</p>
              <p class="text-[0.7rem] text-slate-400">Dirisha la Malipo</p>
            </div>
          </button>
          <button class="command-tile" data-module="ai-insights">
            <i class="fas fa-robot"></i>
            <div>
              <p class="text-sm font-semibold">AI Insights</p>
              <p class="text-[0.7rem] text-slate-400">Advisor</p>
            </div>
          </button>
          <button class="command-tile" data-module="volunteers">
            <i class="fas fa-people-carry"></i>
            <div>
              <p class="text-sm font-semibold">Volunteers</p>
              <p class="text-[0.7rem] text-slate-400">Support teams</p>
            </div>
          </button>
          <button class="command-tile" data-module="events">
            <i class="fas fa-calendar-alt"></i>
            <div>
              <p class="text-sm font-semibold">Events</p>
              <p class="text-[0.7rem] text-slate-400">Key dates</p>
            </div>
          </button>
          <button
            class="command-tile"
            onclick="window.location.href='preformonehtml/prefonedashboard.html';"
          >
            <i class="fas fa-graduation-cap text-sky-400"></i>
            <div>
              <p class="text-sm font-semibold">Pre-Form One</p>
              <p class="text-[0.7rem] text-slate-400">Prep center</p>
            </div>
          </button>
          <button
            id="graduationShortcut"
            class="command-tile"
            style="display: none"
            onclick="window.location.href='Tostaffhtml/graduation.html';"
          >
            <i class="fas fa-trophy text-amber-300"></i>
            <div>
              <p class="text-sm font-semibold">Graduation</p>
              <p class="text-[0.7rem] text-slate-400">Ceremony kit</p>
            </div>
          </button>
          <button
            class="command-tile role-specific admin-only"
            data-module="admin-tools"
          >
            <i class="fas fa-tools"></i>
            <div>
              <p class="text-sm font-semibold">Admin Tools</p>
              <p class="text-[0.7rem] text-slate-400">Controls</p>
            </div>
          </button>
          <button
            class="command-tile role-specific teacher-only"
            data-module="class-tools"
          >
            <i class="fas fa-chalkboard-teacher"></i>
            <div>
              <p class="text-sm font-semibold">Class Tools</p>
              <p class="text-[0.7rem] text-slate-400">Lessons</p>
            </div>
          </button>
          <button
            class="command-tile role-specific accountant-only"
            data-module="finance-tools"
          >
            <i class="fas fa-calculator"></i>
            <div>
              <p class="text-sm font-semibold">Finance Tools</p>
              <p class="text-[0.7rem] text-slate-400">Ledgers</p>
            </div>
          </button>
          <button
            class="command-tile role-specific parent-only"
            data-module="child-info"
          >
            <i class="fas fa-child"></i>
            <div>
              <p class="text-sm font-semibold">Child Info</p>
              <p class="text-[0.7rem] text-slate-400">Parent view</p>
            </div>
          </button>
          <button id="logout" class="command-tile">
            <i class="fas fa-sign-out-alt text-rose-400"></i>
            <div>
              <p class="text-sm font-semibold">Logout</p>
              <p class="text-[0.7rem] text-slate-400">End session</p>
            </div>
          </button>
        </div>
      </div>
    </div>
    <div class="workspace-shell">
      <header class="glass-header">
        <div class="glass-header-content">
          <div class="flex items-center gap-4 w-full sm:w-auto">
            <button
              id="commandMenuToggle"
              class="menu-launcher"
              aria-label="Open quick menu"
            >
              <i class="fas fa-ellipsis-v"></i>
            </button>
            <div class="page-title-wrapper">
              <p
                class="text-[0.6rem] uppercase tracking-[0.45em] text-slate-400 hidden sm:block"
              >
                Control hub
              </p>
              <h1
                id="page-title"
                class="page-title-stack"
                aria-label="SoMAp Society Management App"
              >
                <span class="page-title-main">SoMAp</span>
                <span class="page-title-divider">•</span>
                <span class="page-title-sub">Society Management App</span>
              </h1>
            </div>
          </div>
          <div
            class="flex flex-1 flex-col gap-4 md:flex-row md:items-center md:justify-end"
          >
            <div
              id="somapYearWrap"
              class="flex flex-col md:flex-row md:items-center md:space-x-3 text-xs font-semibold text-slate-300"
            >
              <div class="flex flex-col">
                <span
                  class="uppercase tracking-[0.35em] mb-1 text-[0.6rem] text-slate-400"
                  >Academic Year</span
                >
                <select
                  data-somap-year-select
                  class="min-w-[150px] rounded-xl border border-slate-700 bg-slate-900/60 px-3 py-1 text-sm font-semibold text-slate-100 shadow-lg focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/40"
                ></select>
              </div>
              <span class="text-[0.75rem] text-slate-200 mt-1 md:mt-0"
                >Working year: <b id="somapYearHint">--</b></span
              >
            </div>
            <div class="flex items-center gap-3">
              <div class="relative hidden lg:block">
                <input
                  type="text"
                  class="px-4 py-2 rounded-2xl border border-slate-700 bg-slate-900/40 text-slate-100 placeholder-slate-500 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/30 w-64"
                  placeholder="Search..."
                />
                <i
                  class="fas fa-search absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 text-sm"
                ></i>
              </div>
              <button class="header-icon">
                <i class="far fa-bell relative">
                  <span
                    class="absolute -top-1 -right-1 bg-rose-500 text-white text-[0.6rem] rounded-full h-4 w-4 flex items-center justify-center"
                    >3</span
                  >
                </i>
              </button>
              <button class="header-icon">
                <i class="fas fa-cog"></i>
              </button>
            </div>
          </div>
        </div>
        <div class="px-6 pb-3 md:hidden">
          <label
            class="mb-2 block text-xs font-semibold uppercase tracking-[0.35em] text-slate-400"
            >Academic Year</label
          >
          <select
            data-somap-year-select
            class="w-full rounded-xl border border-slate-700 bg-slate-900/60 px-3 py-2 text-sm font-semibold text-slate-100 shadow-lg focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/40"
          ></select>
          <p class="mt-2 text-xs text-slate-300">
            Working year: <b id="somapYearHintMobile">--</b>
          </p>
        </div>
      </header>
      <div class="workspace flex-1 min-w-0 overflow-x-hidden overflow-y-auto">
        <!-- Main Dashboard -->
        <div id="main-dashboard" class="main-content">
          <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
              <a class="navbar-brand text-white" href="#">SoMAp Dashboard</a>
              <span
                id="currentSchoolLabel"
                class="ms-3 px-3 py-1 rounded-full bg-white/10 text-xs text-slate-200 border border-white/15"
              ></span>
              <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                    <a class="nav-link text-white" href="#market"
                      >SoMAp Market</a
                    >
                  </li>
                  <li class="nav-item">
                    <a class="nav-link text-white" href="#schools">Schools</a>
                  </li>
                </ul>
              </div>
            </div>
          </nav>
          <!-- Dashboard Overview -->
          <section id="dashboard" class="section-padding">
            <h2>Dashboard Overview</h2>
            <div class="row grid">
              <div class="col-md-3">
                <div class="card stat-card stats-card">
                  <div class="card-body">
                    <h5>Total Students</h5>
                    <p id="total-students">
                      Loading... <small>5.2% Since last month</small>
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stat-card stats-card">
                  <div class="card-body">
                    <h5>Attendance Rate</h5>
                    <p id="attendance-rate">
                      Loading... <small>1.5% Since last month</small>
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stat-card stats-card">
                  <div class="card-body">
                    <h5>Upcoming Events</h5>
                    <p id="upcoming-events">
                      Loading... <small>2 new This week</small>
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="finance-card">
                  <h5>Total Due (All Students)</h5>
                  <p id="total-due">TSh 0</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="finance-card">
                  <h5>Total Collected</h5>
                  <p id="total-collected">TSh 0</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="finance-card">
                  <h5>Total Outstanding</h5>
                  <p id="total-outstanding">TSh 0</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="finance-card">
                  <h5>Total Expenses</h5>
                  <p id="total-expenses">TSh 0</p>
                </div>
              </div>
              <div class="col-md-3">
                <div class="finance-card">
                  <h5>Net Balance</h5>
                  <p id="net-balance">TSh 0</p>
                </div>
              </div>
              <div class="col-md-3">
                <a
                  class="finance-card block"
                  style="text-decoration: none"
                  href="Tofinancehtml/financialstatements/fs_dashboard.html"
                >
                  <h5>Financial Statements</h5>
                  <p class="text-lg">TRA-ready FS</p>
                  <div class="text-sm text-indigo-50/90">
                    P&L • Balance Sheet • Cash Flow
                  </div>
                </a>
              </div>
              <div class="col-md-3">
                <div
                  id="remedialCard"
                  class="card stat-card stats-card remedial-card"
                  role="button"
                  tabindex="0"
                  aria-label="Open remedial manager"
                >
                  <div class="card-body">
                    <h5>Remedial (Class 4 & 7)</h5>
                    <p id="remedialStatCollected">Collected: TSh 0</p>
                    <p class="text-sm text-slate-100">
                      Debt now: <span id="remedialStatDebtNow">TSh 0</span>
                    </p>
                    <div class="mt-2 flex items-center gap-2">
                      <span class="remedial-chip"
                        >Students: <b id="remedialStatStudents">0</b></span
                      >
                      <span class="remedial-chip"
                        >Debtors: <b id="remedialStatDebtors">0</b></span
                      >
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stat-card stats-card glass-panel">
                  <div class="card-body">
                    <h5>Students Today</h5>
                    <p><span id="students-present-today">--</span> Present</p>
                    <p><span id="students-absent-today">--</span> Absent</p>
                    <p class="text-sm text-slate-300">
                      Boys: <span id="students-boys-count">--</span> · Girls:
                      <span id="students-girls-count">--</span>
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card stat-card stats-card glass-panel">
                  <div class="card-body">
                    <h5>Workers Snapshot</h5>
                    <p>Total: <span id="workers-total-count">--</span></p>
                    <p>
                      <span id="workers-present-count">--</span> Present ·
                      <span id="workers-absent-count">--</span> Absent
                    </p>
                    <p class="text-sm text-slate-300">
                      Male: <span id="workers-male-count">--</span> · Female:
                      <span id="workers-female-count">--</span>
                    </p>
                  </div>
                </div>
              </div>
              <div
                class="col-md-3 role-specific admin-only"
                id="approvalsShortcut"
              >
                <div
                  class="card stat-card stats-card"
                  style="
                    background: linear-gradient(
                      135deg,
                      rgba(56, 189, 248, 0.35),
                      rgba(14, 165, 233, 0.22)
                    );
                    color: #0f172a;
                  "
                >
                  <div class="card-body">
                    <h5>Payment Approvals</h5>
                    <p>Review pending payments before they hit the ledgers.</p>
                    <a
                      href="Todashboardhtml/approvals.html"
                      class="btn quick-action-btn role-specific admin-only"
                      style="
                        margin-top: 0.75rem;
                        background: rgba(15, 23, 42, 0.85);
                        color: #e0f2fe;
                        border: 1px solid rgba(56, 189, 248, 0.45);
                      "
                      >Open Approvals</a
                    >
                  </div>
                </div>
              </div>
              <div
                class="col-md-3 role-specific admin-only"
                id="schoolApprovalsShortcut"
                style="display: none"
              >
                <div
                  class="card stat-card stats-card"
                  style="
                    background: linear-gradient(
                      135deg,
                      rgba(56, 189, 248, 0.35),
                      rgba(14, 165, 233, 0.22)
                    );
                    color: #0f172a;
                  "
                >
                  <div class="card-body">
                    <h5>School Approvals (HQ)</h5>
                    <p>
                      Approve new schools before they appear in CHAGUA SHULE.
                    </p>
                    <a
                      href="somapappv1multischool/hq-approvals.html"
                      class="btn quick-action-btn role-specific admin-only"
                      style="
                        margin-top: 0.75rem;
                        background: rgba(15, 23, 42, 0.85);
                        color: #e0f2fe;
                        border: 1px solid rgba(56, 189, 248, 0.45);
                      "
                      >Open SoMAp HQ</a
                    >
                  </div>
                </div>
              </div>
              <div
                class="col-md-3 role-specific admin-only"
                id="reclassifyShortcut"
              >
                <div
                  class="card stat-card stats-card"
                  style="
                    background: linear-gradient(
                      135deg,
                      rgba(56, 189, 248, 0.35),
                      rgba(14, 165, 233, 0.22)
                    );
                    color: #0f172a;
                  "
                >
                  <div class="card-body">
                    <h5>Reclassify Payments</h5>
                    <p>
                      Assign school-fee years to legacy payments and queue them
                      for approvals.
                    </p>
                    <a
                      href="Tofinancehtml/reclassify_financepayments.html"
                      class="btn quick-action-btn role-specific admin-only"
                      style="
                        margin-top: 0.75rem;
                        background: rgba(15, 23, 42, 0.85);
                        color: #e0f2fe;
                        border: 1px solid rgba(56, 189, 248, 0.45);
                      "
                      >Open Reclassifier</a
                    >
                  </div>
                </div>
              </div>
            </div>
          </section>
          <div id="remedialModal" class="remedial-modal" aria-hidden="true">
            <div class="remedial-panel p-4 md:p-5">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <h3 class="text-xl font-bold text-pink-200">
                    Remedial Manager
                  </h3>
                  <p class="text-xs text-slate-300">
                    <span id="remedialSchoolTag">School</span> | Year:
                    <span id="remedialYearTag">--</span> | Classes: 4 and 7
                  </p>
                </div>
                <button
                  id="remedialCloseBtn"
                  class="remedial-btn bg-rose-500/20 border-rose-300/45 text-rose-100"
                >
                  Close
                </button>
              </div>

              <div class="remedial-summary-grid mt-3 mb-3">
                <div class="remedial-kpi">
                  <div class="l">Monthly Price</div>
                  <div class="v" id="remedialKpiPrice">TSh 0</div>
                </div>
                <div class="remedial-kpi">
                  <div class="l">Collected</div>
                  <div class="v" id="remedialKpiCollected">TSh 0</div>
                </div>
                <div class="remedial-kpi">
                  <div class="l">Debt To Date</div>
                  <div class="v" id="remedialKpiDebtNow">TSh 0</div>
                </div>
                <div class="remedial-kpi">
                  <div class="l">Debt To August</div>
                  <div class="v" id="remedialKpiDebtAug">TSh 0</div>
                </div>
                <div class="remedial-kpi">
                  <div class="l">Expenses</div>
                  <div class="v" id="remedialKpiExpenses">TSh 0</div>
                </div>
                <div class="remedial-kpi">
                  <div class="l">Net</div>
                  <div class="v" id="remedialKpiNet">TSh 0</div>
                </div>
              </div>

              <div class="remedial-toolbar mb-3">
                <label class="text-xs text-slate-300">Price/Month</label>
                <input
                  id="remedialPriceInput"
                  class="remedial-input w-32"
                  type="number"
                  min="0"
                  step="100"
                />
                <label class="text-xs text-slate-300">Due Day</label>
                <input
                  id="remedialDueDayInput"
                  class="remedial-input w-24"
                  type="number"
                  min="1"
                  max="28"
                  step="1"
                />
                <button
                  id="remedialSaveSettingsBtn"
                  class="remedial-btn bg-indigo-500/30 text-indigo-100 border-indigo-300/45"
                >
                  Save Settings
                </button>
                <label class="ml-auto text-xs text-slate-300">Month</label>
                <select id="remedialMonthSelect" class="remedial-select"></select>
                <label class="text-xs text-slate-300">Class</label>
                <select id="remedialClassFilter" class="remedial-select">
                  <option value="all">All Classes</option>
                  <option value="class4">Class 4 only</option>
                  <option value="class7">Class 7 only</option>
                </select>
                <label class="text-xs text-slate-300">Filter</label>
                <select id="remedialStatusFilter" class="remedial-select">
                  <option value="all">All</option>
                  <option value="debtors">Debtors only</option>
                  <option value="paid">Paid up to date</option>
                </select>
              </div>

              <div class="remedial-toolbar mb-3">
                <button
                  id="remedialExportExcelAll"
                  class="remedial-btn bg-emerald-500/25 text-emerald-100 border-emerald-300/45"
                >
                  Excel All
                </button>
                <button
                  id="remedialExportExcelDebtors"
                  class="remedial-btn bg-amber-500/25 text-amber-100 border-amber-300/45"
                >
                  Excel Debtors
                </button>
                <button
                  id="remedialExportExcelPaid"
                  class="remedial-btn bg-sky-500/25 text-sky-100 border-sky-300/45"
                >
                  Excel Paid
                </button>
                <button
                  id="remedialExportPdfAll"
                  class="remedial-btn bg-fuchsia-500/25 text-fuchsia-100 border-fuchsia-300/45"
                >
                  PDF All
                </button>
                <button
                  id="remedialExportPdfDebtors"
                  class="remedial-btn bg-rose-500/25 text-rose-100 border-rose-300/45"
                >
                  PDF Debtors
                </button>
                <button
                  id="remedialExportPdfPaid"
                  class="remedial-btn bg-indigo-500/25 text-indigo-100 border-indigo-300/45"
                >
                  PDF Paid
                </button>
                <button
                  id="remedialExportExcelExpenses"
                  class="remedial-btn bg-teal-500/25 text-teal-100 border-teal-300/45"
                >
                  Excel Expenses
                </button>
                <button
                  id="remedialExportPdfExpenses"
                  class="remedial-btn bg-rose-600/30 text-rose-100 border-rose-300/45"
                >
                  PDF Expenses
                </button>
              </div>

              <div class="remedial-table-wrap mb-3">
                <table class="remedial-table">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Admission</th>
                      <th>Name</th>
                      <th>Class</th>
                      <th>Parent Contact</th>
                      <th>Paid Months</th>
                      <th>Debt To Date</th>
                      <th>Debt To August</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody id="remedialTableBody">
                    <tr>
                      <td colspan="10" class="text-center text-slate-400">
                        Loading...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <div class="remedial-exp-grid">
                <div class="rounded-lg border border-slate-600/40 p-3 bg-slate-900/45">
                  <h4 class="text-sm font-semibold text-rose-100 mb-2">
                    Add Expense
                  </h4>
                  <div class="remedial-toolbar">
                    <input
                      id="remedialExpenseLabel"
                      class="remedial-input flex-1"
                      placeholder="Description"
                    />
                    <input
                      id="remedialExpenseAmount"
                      class="remedial-input w-32"
                      type="number"
                      min="0"
                      step="100"
                      placeholder="Amount"
                    />
                    <button
                      id="remedialAddExpenseBtn"
                      class="remedial-btn bg-rose-500/30 text-rose-100 border-rose-300/45"
                    >
                      Add
                    </button>
                  </div>
                </div>
                <div class="rounded-lg border border-slate-600/40 p-3 bg-slate-900/45">
                  <h4 class="text-sm font-semibold text-emerald-100 mb-2">
                    Add Extra Income
                  </h4>
                  <div class="remedial-toolbar">
                    <input
                      id="remedialIncomeLabel"
                      class="remedial-input flex-1"
                      placeholder="Description"
                    />
                    <input
                      id="remedialIncomeAmount"
                      class="remedial-input w-32"
                      type="number"
                      min="0"
                      step="100"
                      placeholder="Amount"
                    />
                    <button
                      id="remedialAddIncomeBtn"
                      class="remedial-btn bg-emerald-500/30 text-emerald-100 border-emerald-300/45"
                    >
                      Add
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Fee Collection Trends Chart -->
          <section id="fee-trends" class="module-section">
            <h2>Fee Collection Trends</h2>
            <div class="chart-container">
              <canvas id="fee-chart"></canvas>
            </div>
          </section>
          <!-- Quick Actions -->
          <section id="quick-actions" class="module-section">
            <h2>Quick Actions</h2>
            <div class="row grid">
              <button
                class="btn quick-action-btn role-specific accountant-only"
              >
                New Admission
              </button>
              <button
                class="btn quick-action-btn role-specific accountant-only"
              >
                Record Payment
              </button>
              <button class="btn quick-action-btn">Send Announcement</button>
              <button class="btn quick-action-btn">Generate Reports</button>
              <a
                class="btn quick-action-btn"
                href="societycashbook/societycashbook.html"
                >Money Memory – Cashbook & Budgets</a
              >
              <a
                class="btn quick-action-btn role-specific admin-only"
                href="workershtml/workersadmission.html"
                >Open Workers Hub</a
              >
            </div>
          </section>
          <!-- Recent Activities -->
          <section id="activities" class="module-section">
            <h2>Recent Activities</h2>
            <ul class="events-list" id="activities-list">
              <li>Loading...</li>
            </ul>
            <button class="btn quick-action-btn">View All</button>
          </section>
          <!-- Upcoming Events -->
          <section id="upcoming-events" class="module-section">
            <h2>Upcoming Events</h2>
            <ul class="events-list" id="events-list">
              <li>Loading...</li>
            </ul>
            <button class="btn quick-action-btn">View Calendar</button>
          </section>
          <!-- Academic Module -->
          <section
            id="academic"
            class="module-section role-specific teacher-only admin-only"
          >
            <h2>Academic Management</h2>
            <div class="row grid">
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <h5>Class Assignment</h5>
                    <p>Manage student class assignments.</p>
                    <button class="btn quick-action-btn">
                      Assign Students
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <h5>Timetables</h5>
                    <p>Create and manage timetables.</p>
                    <button class="btn quick-action-btn">
                      Create Timetable
                    </button>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <div class="card-body">
                    <h5>Exam Management</h5>
                    <p>Schedule examinations.</p>
                    <button class="btn quick-action-btn">Schedule Exam</button>
                  </div>
                </div>
              </div>
            </div>
          </section>
          <!-- Attendance Module -->
          <section
            id="attendance"
            class="module-section role-specific teacher-only admin-only"
          >
            <h2>Attendance</h2>
            <div class="row grid">
              <div class="col-md-6">
                <div class="card attendance-trends">
                  <h5>Today's Attendance</h5>
                  <p id="today-attendance">Loading...</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="chart-container">
                  <h5>Attendance Trends</h5>
                  <canvas id="attendance-chart"></canvas>
                </div>
              </div>
            </div>
            <button class="btn quick-action-btn">Mark Attendance</button>
            <a
              class="btn quick-action-btn"
              href="Toattendancehtml/shiftedkids.html"
              >Shifted Students Hub</a
            >
          </section>
          <!-- Discipline Module -->
          <section
            id="discipline"
            class="module-section role-specific teacher-only admin-only"
          >
            <h2>Discipline Records</h2>
            <p>Track student discipline cases.</p>
            <ul class="events-list" id="discipline-list">
              <li>Loading...</li>
            </ul>
            <button class="btn quick-action-btn">Add Incident</button>
          </section>
          <!-- Finance Module -->
          <section
            id="finance"
            class="finance-overview module-section role-specific accountant-only admin-only"
          >
            <h2>Finance</h2>
            <div class="row grid">
              <div class="col-md-6">
                <div class="card">
                  <h5>Fee Collection Overview</h5>
                  <p id="fee-overview">Loading...</p>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <h5>Recent Fee Payments</h5>
                  <ul class="events-list" id="recent-payments">
                    <li>Loading...</li>
                  </ul>
                </div>
              </div>
            </div>
            <button class="btn quick-action-btn">Record Payment</button>
            <button class="btn quick-action-btn">Create New Admission</button>
          </section>
          <!-- Resources Module -->
          <section
            id="resources"
            class="resource-card module-section role-specific teacher-only admin-only"
          >
            <h2>Digital Resources</h2>
            <p>Access educational resources.</p>
            <div class="row grid">
              <div class="col-md-4">
                <div class="card">
                  <h5>Cell Biology</h5>
                  <p>PDF • 2.4 MB</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <h5>Algebra Problems</h5>
                  <p>PDF • 1.8 MB</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <h5>African History</h5>
                  <p>Video • 15:24 min</p>
                </div>
              </div>
            </div>
            <button class="btn quick-action-btn">Upload Resource</button>
            <div class="card mt-3">
              <h5>Resource Metrics</h5>
              <p id="resource-metrics">Loading...</p>
            </div>
          </section>
          <!-- Communications Module -->
          <section
            id="communications"
            class="communication-stats module-section"
          >
            <h2>Communications</h2>
            <div class="row grid">
              <div class="col-md-6">
                <div class="card">
                  <h5>Recent Messages</h5>
                  <ul class="events-list" id="recent-messages">
                    <li>Loading...</li>
                  </ul>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <h5>Communication Statistics</h5>
                  <p id="comm-stats">Loading...</p>
                </div>
              </div>
            </div>
            <button class="btn quick-action-btn">Send Announcement</button>
          </section>
          <!-- MarketingHub mount -->
          <section id="market" class="market-section">
            <div id="marketinghub-card-root"></div>
          </section>
          <!-- AI Insights -->
          <section id="ai-insights" class="ai-insights module-section">
            <h2>AI-Powered Insights</h2>
            <div class="row grid">
              <div class="col-md-4">
                <div class="card">
                  <h5>Students at Risk</h5>
                  <p id="students-at-risk">Loading...</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <h5>Financial Forecasts</h5>
                  <p id="financial-forecasts">Loading...</p>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card">
                  <h5>AI Assistant</h5>
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Ask about school data..."
                  />
                  <button class="btn quick-action-btn mt-2">Ask AI</button>
                </div>
              </div>
            </div>
          </section>
          <!-- Volunteers Module -->
          <section id="volunteers" class="volunteer-section module-section">
            <h2>Volunteers & Exchanges</h2>
            <div class="row grid">
              <div class="col-md-6">
                <div class="card">
                  <h5>Current Volunteers</h5>
                  <ul class="events-list" id="current-volunteers">
                    <li>Loading...</li>
                  </ul>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card">
                  <h5>Volunteer Hours</h5>
                  <p id="volunteer-hours">Loading...</p>
                </div>
              </div>
            </div>
            <button class="btn quick-action-btn role-specific admin-only">
              Manage Volunteers
            </button>
          </section>
          <!-- Events Planning -->
          <section id="events" class="module-section">
            <h2>Events Management</h2>
            <div class="calendar">
              <h5>September 2025 Calendar</h5>
              <p id="calendar-view">Loading...</p>
            </div>
            <div class="card mt-3">
              <h5>Upcoming Event</h5>
              <p id="upcoming-event-details">Loading...</p>
            </div>
            <button class="btn quick-action-btn role-specific admin-only">
              Create Event
            </button>
          </section>
          <!-- Admin Tools -->
          <section
            id="admin-tools"
            class="module-section role-specific admin-only"
          >
            <h2>Admin Tools</h2>
            <p>Manage schools, users, etc.</p>
            <div class="card">
              <h5>Add New School</h5>
              <form id="add-school-form">
                <input
                  type="text"
                  class="form-control mb-2"
                  id="school-name"
                  placeholder="School Name"
                />
                <button type="submit" class="btn quick-action-btn">
                  Add School
                </button>
              </form>
              <ul id="school-list">
                <li>Socrates School</li>
                <li>Mnyore Academy</li>
              </ul>
            </div>
            <div class="card mt-3">
              <h5>Transport Hub · Bwalo la Usafiri</h5>
              <p>
                Vehicle management, payments, fuel, maintenance — all transport
                controls in one place.
              </p>
              <div
                class="quick-action-group"
                style="display: flex; gap: 0.75rem; flex-wrap: wrap"
              >
                <a
                  class="btn quick-action-btn"
                  href="transporthtml/transport.html"
                >
                  Open Transport Hub
                </a>
                <a
                  class="btn quick-action-btn secondary"
                  href="transporthtml/transportattendance.html"
                >
                  Open Transport Attendance
                </a>
                <a
                  class="btn quick-action-btn"
                  href="Tofinancehtml/paymentedits.html"
                >
                  Payments Config (Plans, Fees & Overrides)
                </a>
              </div>
            </div>
          </section>
          <!-- Class Tools for Teachers -->
          <section
            id="class-tools"
            class="module-section role-specific teacher-only"
          >
            <h2>Class Tools</h2>
            <p>Manage your class: Attendance, Students, etc.</p>
            <select id="class-stream" class="form-select mb-3">
              <option>Select Stream (e.g., A or B)</option>
            </select>
            <button class="btn quick-action-btn">View Student List</button>
          </section>
          <!-- Finance Tools for Accountant -->
          <section
            id="finance-tools"
            class="module-section role-specific accountant-only"
          >
            <h2>Finance Tools</h2>
            <p>Manage admissions, fees.</p>
            <button class="btn quick-action-btn">Create New Admission</button>
            <button class="btn quick-action-btn">Check Fees</button>
          </section>
          <!-- Child Info for Parents -->
          <section
            id="child-info"
            class="module-section role-specific parent-only"
          >
            <h2>Your Child's Info</h2>
            <p>Details, attendance, fees, etc.</p>
            <div id="child-details">Loading...</div>
          </section>
          <!-- Footer -->
          <footer class="footer">
            <p>
              &copy; 2025 SoMAp - Built for excellence in education. Integrated
              with Firebase.
            </p>
          </footer>
        </div>
      </div>
    </div>
    <script>
      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const auth = firebase.auth();
      const db = firebase.database();

      // Ensure we have a current school context
      const currentSchool = window.SOMAP && SOMAP.getSchool();
      if (!currentSchool || !currentSchool.id) {
        window.location.href = "somapappv1multischool/multischool.html";
      }
      window.currentSchoolId = currentSchool?.id;
      const schoolLabel = document.getElementById("currentSchoolLabel");
      if (schoolLabel) {
        schoolLabel.textContent =
          currentSchool.name ||
          currentSchool.code ||
          currentSchool.id ||
          "School";
      }

      function schoolRef(subPath) {
        return db.ref(SOMAP.P(subPath));
      }
      const GRAD_EMAILS = new Set([
        "ssclass42023@gmail.com",
        "socratesschool2020@gmail.com",
      ]);
      // Language Translations
      const translations = {
        en: {
          welcomeTitle: "Welcome to SoMAp - The Best School Management System",
          welcomeText:
            "Transform your school with our integrated SuperApp. Manage academics, finances, attendance, and more effortlessly. Connect parents, boost performance, and explore SoMAp Market for uniforms, supplies, and essentials. Inspired by top systems for excellence in Tanzania's education.",
          getStarted: "Get Started",
          dashboard: "Dashboard",
          academic: "Academic",
          attendance: "Attendance",
          discipline: "Discipline",
          finance: "Finance",
          resources: "Resources",
          communications: "Communications",
          market: "Market",
          aiInsights: "AI Insights",
          volunteers: "Volunteers",
          events: "Events",
          adminTools: "Admin Tools",
          classTools: "Class Tools",
          financeTools: "Finance Tools",
          childInfo: "Child Info",
          logout: "Logout",
        },
        sw: {
          welcomeTitle: "Karibu kwa SoMAp - Mfumo Bora wa Usimamizi wa Shule",
          welcomeText:
            "Badilisha shule yako na SuperApp yetu iliyounganishwa. Simamia masomo, fedha, mahudhurio, na zaidi kwa urahisi. Unganisha wazazi, ongeza utendaji, na chunguza SoMAp Market kwa uniformu, vifaa, na mahitaji. Imechochewa na mifumo ya juu kwa ubora katika elimu ya Tanzania.",
          getStarted: "Anza",
          dashboard: "Dashibodi",
          academic: "Elimu",
          attendance: "Mahudhurio",
          discipline: "Nidhamu",
          finance: "Fedha",
          resources: "Rasilimali",
          communications: "Mawasiliano",
          market: "Soko",
          aiInsights: "Maarifa ya AI",
          volunteers: "Wajitolea",
          events: "Matukio",
          adminTools: "Zana za Admin",
          classTools: "Zana za Darasa",
          financeTools: "Zana za Fedha",
          childInfo: "Taarifa za Mtoto",
          logout: "Toka",
        },
      };
      // No language select in dashboard, but translations defined for sidebar
      // Get Class from Email
      function getClassFromEmail(email) {
        if (!email) return "";
        email = email.toLowerCase();
        if (email.includes("babyclass")) return "Baby Class";
        if (email.includes("middleclass")) return "Middle Class";
        if (email.includes("preunit")) return "Pre-Unit";
        if (email.includes("class1ab")) return "Class 1 AB";
        if (email.includes("class2ab")) return "Class 2 AB";
        if (email.includes("class32023")) return "Class 3";
        if (email.includes("class42023")) return "Class 4";
        if (email.includes("class52023")) return "Class 5";
        if (email.includes("class62023")) return "Class 6";
        if (email.includes("class72023")) return "Class 7";
        return "";
      }
      const formatTsh = (value) =>
        `TSh ${Math.round(Number(value) || 0).toLocaleString()}`;
      const yearManager = window.somapYearContext || null;
      const getSelectedYear = () => {
        if (yearManager && typeof yearManager.getSelectedYear === "function") {
          return String(yearManager.getSelectedYear());
        }
        return String(SOMAP_DEFAULT_YEAR);
      };
      function updateYearHint() {
        const year = getSelectedYear();
        const desktopHint = document.getElementById("somapYearHint");
        const mobileHint = document.getElementById("somapYearHintMobile");
        if (desktopHint) desktopHint.textContent = year;
        if (mobileHint) mobileHint.textContent = year;
      }
      let currentRole = "admin";
      let currentClassScope = "";
      let yearListenerBound = false;

      const withSchool = (path) => {
        const trimmed = String(path || "").replace(/^\/+/, "");
        if (!trimmed) return trimmed;
        return SOMAP.P(trimmed);
      };

      function scopeEntries(entriesMap, role, className) {
        const records = Object.entries(entriesMap || {}).map(([id, entry]) => ({
          id,
          ...entry,
        }));
        if (role === "teacher" && className) {
          const target = L(className);
          return records.filter(
            (rec) =>
              L(rec.student?.classLevel || rec.student?.className || "") ===
              target
          );
        }
        return records;
      }

      function resolveClassForYear(
        studentId,
        fallbackClass,
        year,
        anchorEnrollments,
        yearEnrollments
      ) {
        const overrides = (yearEnrollments || {})[studentId] || {};
        if (overrides && (overrides.className || overrides.classLevel)) {
          return overrides.className || overrides.classLevel;
        }
        const anchor = (anchorEnrollments || {})[studentId] || {};
        const baseClass =
          anchor.className || anchor.classLevel || fallbackClass || "";
        const delta = Number(year) - SOMAP_DEFAULT_YEAR;
        return shiftClass(baseClass, delta);
      }

      async function loadStudentRoster(year) {
        const yearStr = String(year || SOMAP_DEFAULT_YEAR);
        try {
          const [studentsSnap, anchorSnap, yearSnap] = await Promise.all([
            db.ref(withSchool("students")).once("value"),
            db
              .ref(withSchool(`enrollments/${SOMAP_DEFAULT_YEAR}`))
              .once("value"),
            db.ref(withSchool(`enrollments/${yearStr}`)).once("value"),
          ]);
          return {
            students: studentsSnap.val() || {},
            anchorEnrollments: anchorSnap.val() || {},
            yearEnrollments: yearSnap.val() || {},
          };
        } catch (error) {
          console.warn("Failed to load roster data", error);
          return { students: {}, anchorEnrollments: {}, yearEnrollments: {} };
        }
      }

      function buildActiveStudentRoster(rosterData, year, role, classScope) {
        const normalizedRole = L(role || "");
        const normalizedScope = classScope ? L(classScope) : "";
        const targetYear = String(year || SOMAP_DEFAULT_YEAR);
        const {
          students = {},
          anchorEnrollments = {},
          yearEnrollments = {},
        } = rosterData || {};
        return Object.entries(students).reduce((list, [id, student]) => {
          if (!student) return list;
          if (String(student.status || "").trim().toLowerCase() === "shifted") return list;
          const fallbackClass = student.classLevel || student.className || "";
          const resolved = (
            resolveClassForYear(
              id,
              fallbackClass,
              targetYear,
              anchorEnrollments,
              yearEnrollments
            ) || ""
          ).trim();
          if (resolved.toUpperCase() === "GRADUATED") return list;
          if (
            normalizedRole === "teacher" &&
            normalizedScope &&
            L(resolved) !== normalizedScope
          )
            return list;
          const gender = String(
            student.gender || student.sex || student.meta?.gender || ""
          )
            .trim()
            .toLowerCase();
          list.push({
            id,
            ...student,
            classLevel: resolved,
            className: resolved,
            gender,
          });
          return list;
        }, []);
      }

      function bindYearChangeListener() {
        if (
          yearListenerBound ||
          !yearManager ||
          typeof yearManager.onYearChanged !== "function"
        )
          return;
        yearListenerBound = true;
        yearManager.onYearChanged(() =>
          refreshDashboard(currentRole, currentClassScope)
        );
      }

      function buildDateKeys(year) {
        const today = new Date();
        today.setFullYear(Number(year) || SOMAP_DEFAULT_YEAR);
        const y = today.getFullYear();
        const m = String(today.getMonth() + 1).padStart(2, "0");
        const d = String(today.getDate()).padStart(2, "0");
        return {
          studentMonthKey: `${y}-${m}`,
          studentDayKey: `${y}-${m}-${d}`,
          workerMonthKey: `${y}${m}`,
          workerDayKey: `${y}${m}${d}`,
        };
      }

      async function refreshDashboard(role, className) {
        if (!window.SomapFinance) return;
        currentRole = role || currentRole || "admin";
        currentClassScope = className || currentClassScope || "";
        const year = getSelectedYear();
        updateYearHint();
        try {
          const rosterPromise = loadStudentRoster(year);
          const [entriesMap, payments, rosterData] = await Promise.all([
            window.SomapFinance.getYearFinanceEntries(year),
            window.SomapFinance.listRecentPayments(year, 6),
            rosterPromise,
          ]);
          const entries = scopeEntries(
            entriesMap,
            currentRole,
            currentClassScope
          );
          const roster = buildActiveStudentRoster(
            rosterData,
            year,
            currentRole,
            currentClassScope
          );
          await renderFinanceStats(entries, year);
          await renderStudentSnapshot(roster);
          await renderAttendanceSummary(roster, year);
          await loadWorkerSnapshot(year);
          await refreshRemedialModule(roster, year);
          renderRecentActivitiesFromPayments(
            payments,
            new Set(entries.map((entry) => entry.id))
          );
        } catch (error) {
          console.error("Error loading dashboard:", error);
          Swal.fire(
            "Error",
            "Failed to load dashboard data: " + error.message,
            "error"
          );
        }
      }

      async function renderFinanceStats(entries, year) {
        const totals = entries.reduce(
          (acc, entry) => {
            acc.due += Number(entry.due || 0);
            acc.paid += Number(entry.paid || 0);
            acc.outstanding += Number(entry.outstanding || 0);
            return acc;
          },
          { due: 0, paid: 0, outstanding: 0 }
        );
        const expensesTotal = await window.SomapFinance.loadExpensesTotal(year);
        document.getElementById("total-due").innerHTML = formatTsh(totals.due);
        document.getElementById("total-collected").innerHTML = formatTsh(
          totals.paid
        );
        document.getElementById("total-outstanding").innerHTML = formatTsh(
          totals.outstanding
        );
        document.getElementById("total-expenses").innerHTML =
          formatTsh(expensesTotal);
        document.getElementById("net-balance").innerHTML = formatTsh(
          totals.paid - expensesTotal
        );
        updateFeeChart(totals.paid, totals.due);
      }

      function renderStudentSnapshot(students) {
        const studentsArray = Array.isArray(students) ? students : [];
        const totalCount = studentsArray.length;
        const totalElement = document.getElementById("total-students");
        if (totalElement) {
          totalElement.innerHTML = `${totalCount} <small class="text-xs text-slate-300">Live count</small>`;
        }
        let boys = 0;
        let girls = 0;
        studentsArray.forEach((st) => {
          if (!st) return;
          const gender = String(st.gender || st.sex || st.meta?.gender || "")
            .trim()
            .toLowerCase();
          if (gender.startsWith("m")) boys++;
          else if (gender.startsWith("f")) girls++;
        });
        const boysElement = document.getElementById("students-boys-count");
        const girlsElement = document.getElementById("students-girls-count");
        if (boysElement) boysElement.textContent = boys;
        if (girlsElement) girlsElement.textContent = girls;
      }

      async function renderAttendanceSummary(students, year) {
        const studentsArray = Array.isArray(students) ? students : [];
        const { studentMonthKey, studentDayKey } = buildDateKeys(year);
        const classNames = Array.from(
          new Set(
            studentsArray
              .map((st) => (st.classLevel || st.className || "").trim())
              .filter(Boolean)
          )
        );
        let present = 0;
        let recordedAbsent = 0;
        await Promise.all(
          classNames.map(async (cls) => {
            if (!cls) return;
            const snap = await schoolRef(
              `attendance/${cls}/${studentMonthKey}/${studentDayKey}`
            ).once("value");
            const records = snap.val() || {};
            Object.values(records).forEach((rec) => {
              const status = String(rec?.daily || "").toUpperCase();
              if (status === "P") present++;
              else if (status.includes("A")) recordedAbsent++;
            });
          })
        );
        const totalStudents = studentsArray.length;
        const computedAbsent = Math.max(0, totalStudents - present);
        const absent = Math.max(recordedAbsent, computedAbsent);
        const presentElement = document.getElementById(
          "students-present-today"
        );
        const absentElement = document.getElementById("students-absent-today");
        if (presentElement) presentElement.textContent = present;
        if (absentElement) absentElement.textContent = absent;
        const rate = totalStudents
          ? Math.round((present / totalStudents) * 1000) / 10
          : 0;
        const rateElement = document.getElementById("attendance-rate");
        if (rateElement) {
          rateElement.innerHTML = `${rate}% <small class="text-xs text-slate-200">Live</small>`;
        }
      }

      async function loadWorkerSnapshot(year) {
        const { workerMonthKey, workerDayKey } = buildDateKeys(year);
        const [workersSnap, attendanceSnap] = await Promise.all([
          schoolRef("workers").once("value"),
          schoolRef("attendance").once("value"),
        ]);
        const workers = workersSnap.val() || {};
        const totalWorkers = Object.values(workers).filter(
          (w) => w?.profile?.active !== false
        ).length;
        let male = 0,
          female = 0;
        Object.values(workers).forEach((worker) => {
          const gender = String(worker?.profile?.gender || worker.gender || "")
            .trim()
            .toLowerCase();
          if (gender.startsWith("m")) male++;
          else if (gender.startsWith("f")) female++;
        });
        const attendance = attendanceSnap.val() || {};
        let present = 0;
        Object.values(attendance).forEach((record) => {
          const monthBucket = record?.[workerMonthKey];
          const dayEntry = monthBucket?.[workerDayKey];
          if (dayEntry?.checkInTs) present++;
        });
        const absent = Math.max(0, totalWorkers - present);
        document.getElementById("workers-total-count").textContent =
          totalWorkers;
        document.getElementById("workers-present-count").textContent = present;
        document.getElementById("workers-absent-count").textContent = absent;
        document.getElementById("workers-male-count").textContent = male;
        document.getElementById("workers-female-count").textContent = female;
      }

      const REMEDIAL_MONTHS = [
        { key: "01", label: "January" },
        { key: "02", label: "February" },
        { key: "03", label: "March" },
        { key: "04", label: "April" },
        { key: "05", label: "May" },
        { key: "06", label: "June" },
        { key: "07", label: "July" },
        { key: "08", label: "August" },
      ];
      const REMEDIAL_DEFAULT_SETTINGS = {
        monthlyPrice: 18000,
        dueDay: 5,
      };
      const remedialState = {
        year: String(SOMAP_DEFAULT_YEAR),
        students: [],
        paymentsByStudent: {},
        expenses: {},
        incomes: {},
        settings: { ...REMEDIAL_DEFAULT_SETTINGS },
        rows: [],
        open: false,
      };

      function parseMoney(value) {
        return Math.max(0, Math.round(Number(value) || 0));
      }

      function remedialEsc(v) {
        return String(v || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function isRemedialClass(className) {
        const normalized = L(className || "");
        return /^class\s*4\b/.test(normalized) || /^class\s*7\b/.test(normalized);
      }

      function getParentContact(student) {
        return (
          student?.primaryParentContact ||
          student?.parentContact ||
          student?.parentPhone ||
          student?.phone ||
          student?.tel ||
          student?.telephone ||
          ""
        );
      }

      function normalizeMonthKey(keyLike) {
        if (keyLike === null || keyLike === undefined) return null;
        const raw = String(keyLike).trim().toLowerCase();
        if (!raw) return null;
        if (/^\d{1,2}$/.test(raw)) {
          const monthNum = Number(raw);
          if (monthNum >= 1 && monthNum <= 8) return String(monthNum).padStart(2, "0");
        }
        const mmDash = raw.match(/^(\d{4})-(\d{1,2})(-\d{1,2})?$/);
        if (mmDash) {
          const monthNum = Number(mmDash[2]);
          if (monthNum >= 1 && monthNum <= 8) return String(monthNum).padStart(2, "0");
        }
        const names = {
          jan: "01",
          january: "01",
          feb: "02",
          february: "02",
          mar: "03",
          march: "03",
          apr: "04",
          april: "04",
          may: "05",
          jun: "06",
          june: "06",
          jul: "07",
          july: "07",
          aug: "08",
          august: "08",
        };
        return names[raw] || null;
      }

      function extractPaymentAmount(entry) {
        if (entry === null || entry === undefined) return 0;
        if (typeof entry === "number" || typeof entry === "string") return parseMoney(entry);
        if (typeof entry !== "object") return 0;
        if (entry.amount !== undefined) return parseMoney(entry.amount);
        return Object.values(entry).reduce((sum, item) => {
          if (item && typeof item === "object" && item.amount !== undefined) {
            return sum + parseMoney(item.amount);
          }
          if (typeof item === "number" || typeof item === "string") {
            return sum + parseMoney(item);
          }
          return sum;
        }, 0);
      }

      function monthPaidMapForStudent(rawStudentPayments) {
        const out = {};
        Object.entries(rawStudentPayments || {}).forEach(([rawMonth, value]) => {
          const mk = normalizeMonthKey(rawMonth);
          if (!mk) return;
          out[mk] = (out[mk] || 0) + extractPaymentAmount(value);
        });
        return out;
      }

      function dueMonthCountForYear(year, dueDay) {
        const y = Number(year);
        const now = new Date();
        const currentYear = now.getFullYear();
        if (Number.isFinite(y) && y < currentYear) return 8;
        if (Number.isFinite(y) && y > currentYear) return 0;
        const day = now.getDate();
        let due = now.getMonth() + 1;
        if (day <= Math.max(1, Math.min(28, Number(dueDay) || 5))) due -= 1;
        return Math.max(0, Math.min(8, due));
      }

      function remedialRowsFromState() {
        const monthlyPrice = parseMoney(remedialState.settings.monthlyPrice);
        const dueMonthCount = dueMonthCountForYear(
          remedialState.year,
          remedialState.settings.dueDay
        );
        return remedialState.students.map((st, idx) => {
          const monthPaid = monthPaidMapForStudent(
            remedialState.paymentsByStudent?.[st.id] || {}
          );
          const paidMonths = REMEDIAL_MONTHS.filter(
            (m) => parseMoney(monthPaid[m.key]) > 0
          ).map((m) => m.label);
          const totalPaidAug = REMEDIAL_MONTHS.reduce(
            (sum, m) => sum + parseMoney(monthPaid[m.key]),
            0
          );
          const paidToDate = REMEDIAL_MONTHS.slice(0, dueMonthCount).reduce(
            (sum, m) => sum + parseMoney(monthPaid[m.key]),
            0
          );
          const expectedToDate = dueMonthCount * monthlyPrice;
          const expectedToAug = 8 * monthlyPrice;
          const debtToDate = Math.max(0, expectedToDate - paidToDate);
          const debtToAugust = Math.max(0, expectedToAug - totalPaidAug);
          const isDebtor = debtToDate > 0;
          return {
            index: idx + 1,
            id: st.id,
            admission: st.admissionNumber || st.pupilId || "N/A",
            name:
              st.fullName ||
              `${st.firstName || ""} ${st.lastName || ""}`.trim() ||
              "N/A",
            className: st.classLevel || st.className || "N/A",
            parentContact: getParentContact(st) || "N/A",
            monthPaid,
            paidMonths,
            paidMonthsCount: paidMonths.length,
            paidToDate,
            totalPaidAug,
            expectedToDate,
            expectedToAug,
            debtToDate,
            debtToAugust,
            status: isDebtor ? "SEND HOME (UNPAID)" : "OK",
            isDebtor,
          };
        });
      }

      function remedialRowsFiltered(filterKey, classFilterKey) {
        let base = remedialState.rows || [];
        if (classFilterKey === "class4") {
          base = base.filter((r) => /^class\s*4\b/i.test(String(r.className || "")));
        } else if (classFilterKey === "class7") {
          base = base.filter((r) => /^class\s*7\b/i.test(String(r.className || "")));
        }
        if (filterKey === "debtors") return base.filter((r) => r.isDebtor);
        if (filterKey === "paid") return base.filter((r) => !r.isDebtor);
        return base;
      }

      function remedialTotals(rows) {
        const list = Array.isArray(rows) ? rows : [];
        const collected = list.reduce((sum, r) => sum + parseMoney(r.totalPaidAug), 0);
        const debtNow = list.reduce((sum, r) => sum + parseMoney(r.debtToDate), 0);
        const debtAug = list.reduce((sum, r) => sum + parseMoney(r.debtToAugust), 0);
        const debtors = list.filter((r) => r.isDebtor).length;
        const expensesTotal = Object.values(remedialState.expenses || {}).reduce(
          (sum, item) => sum + parseMoney(item?.amount),
          0
        );
        const extraIncomeTotal = Object.values(remedialState.incomes || {}).reduce(
          (sum, item) => sum + parseMoney(item?.amount),
          0
        );
        const net = collected + extraIncomeTotal - expensesTotal;
        return {
          collected,
          debtNow,
          debtAug,
          debtors,
          expensesTotal,
          extraIncomeTotal,
          net,
        };
      }

      function renderRemedialCard() {
        const totals = remedialTotals(remedialState.rows);
        const collectedEl = document.getElementById("remedialStatCollected");
        const debtNowEl = document.getElementById("remedialStatDebtNow");
        const studentsEl = document.getElementById("remedialStatStudents");
        const debtorsEl = document.getElementById("remedialStatDebtors");
        if (collectedEl) collectedEl.textContent = `Collected: ${formatTsh(totals.collected)}`;
        if (debtNowEl) debtNowEl.textContent = formatTsh(totals.debtNow);
        if (studentsEl) studentsEl.textContent = String(remedialState.rows.length);
        if (debtorsEl) debtorsEl.textContent = String(totals.debtors);
      }

      function renderRemedialModal() {
        const schoolText =
          currentSchool?.name || currentSchool?.code || currentSchool?.id || "School";
        const yearTag = document.getElementById("remedialYearTag");
        const schoolTag = document.getElementById("remedialSchoolTag");
        if (yearTag) yearTag.textContent = String(remedialState.year);
        if (schoolTag) schoolTag.textContent = schoolText;
        const totals = remedialTotals(remedialState.rows);
        const kpiMap = {
          remedialKpiPrice: formatTsh(remedialState.settings.monthlyPrice),
          remedialKpiCollected: formatTsh(totals.collected),
          remedialKpiDebtNow: formatTsh(totals.debtNow),
          remedialKpiDebtAug: formatTsh(totals.debtAug),
          remedialKpiExpenses: formatTsh(totals.expensesTotal),
          remedialKpiNet: formatTsh(totals.net),
        };
        Object.entries(kpiMap).forEach(([id, val]) => {
          const el = document.getElementById(id);
          if (el) el.textContent = val;
        });
        const priceInput = document.getElementById("remedialPriceInput");
        const dueDayInput = document.getElementById("remedialDueDayInput");
        if (priceInput) priceInput.value = String(remedialState.settings.monthlyPrice || 0);
        if (dueDayInput) dueDayInput.value = String(remedialState.settings.dueDay || 5);

        const monthSelect = document.getElementById("remedialMonthSelect");
        if (monthSelect && !monthSelect.options.length) {
          REMEDIAL_MONTHS.forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m.key;
            opt.textContent = m.label;
            monthSelect.appendChild(opt);
          });
          const now = new Date();
          const target = Math.max(1, Math.min(8, now.getMonth() + 1));
          monthSelect.value = String(target).padStart(2, "0");
        }

        const filterSelect = document.getElementById("remedialStatusFilter");
        const classFilterSelect = document.getElementById("remedialClassFilter");
        const filtered = remedialRowsFiltered(
          filterSelect?.value || "all",
          classFilterSelect?.value || "all"
        );
        const body = document.getElementById("remedialTableBody");
        if (!body) return;
        if (!filtered.length) {
          body.innerHTML =
            '<tr><td colspan="10" class="text-center text-slate-400">No remedial records for this filter.</td></tr>';
          return;
        }
        const selectedMonth = monthSelect?.value || "01";
        body.innerHTML = filtered
          .map((r) => {
            const currentMonthPaid = parseMoney(r.monthPaid[selectedMonth] || 0);
            const actionLabel = currentMonthPaid > 0 ? "Update Payment" : "Mark Paid";
            return `
            <tr class="${r.isDebtor ? "remedial-row-risk" : "remedial-row-ok"}">
              <td>${r.index}</td>
              <td>${remedialEsc(r.admission)}</td>
              <td>${remedialEsc(r.name)}</td>
              <td>${remedialEsc(r.className)}</td>
              <td>${remedialEsc(r.parentContact)}</td>
              <td>${r.paidMonthsCount} (${remedialEsc(r.paidMonths.join(", ") || "-")})</td>
              <td>${formatTsh(r.debtToDate)}</td>
              <td>${formatTsh(r.debtToAugust)}</td>
              <td>${remedialEsc(r.status)}</td>
              <td>
                <button class="remedial-btn bg-indigo-500/35 text-indigo-100 border-indigo-200/50" data-remedial-pay="${remedialEsc(
                  r.id
                )}">
                  ${remedialEsc(actionLabel)}
                </button>
              </td>
            </tr>`;
          })
          .join("");
      }

      async function loadRemedialYearData(year) {
        const y = String(year || SOMAP_DEFAULT_YEAR);
        remedialState.year = y;
        const [settingsSnap, paymentsSnap, expensesSnap, incomesSnap] =
          await Promise.all([
            schoolRef(`remedial/settings/${y}`).once("value"),
            schoolRef(`remedial/payments/${y}`).once("value"),
            schoolRef(`remedial/expenses/${y}`).once("value"),
            schoolRef(`remedial/incomeExtras/${y}`).once("value"),
          ]);
        const rawSettings = settingsSnap.val() || {};
        remedialState.settings = {
          monthlyPrice: parseMoney(
            rawSettings.monthlyPrice ?? REMEDIAL_DEFAULT_SETTINGS.monthlyPrice
          ),
          dueDay: Math.max(
            1,
            Math.min(28, Number(rawSettings.dueDay ?? REMEDIAL_DEFAULT_SETTINGS.dueDay) || 5)
          ),
        };
        remedialState.paymentsByStudent = paymentsSnap.val() || {};
        remedialState.expenses = expensesSnap.val() || {};
        remedialState.incomes = incomesSnap.val() || {};
      }

      async function refreshRemedialModule(students, year) {
        remedialState.students = (students || []).filter((st) =>
          isRemedialClass(st.classLevel || st.className || "")
        );
        await loadRemedialYearData(year);
        remedialState.rows = remedialRowsFromState();
        renderRemedialCard();
        if (remedialState.open) renderRemedialModal();
      }

      async function saveRemedialSettings() {
        const y = remedialState.year;
        const priceInput = document.getElementById("remedialPriceInput");
        const dueDayInput = document.getElementById("remedialDueDayInput");
        const payload = {
          monthlyPrice: parseMoney(priceInput?.value),
          dueDay: Math.max(1, Math.min(28, Number(dueDayInput?.value) || 5)),
          updatedAt: firebase.database.ServerValue.TIMESTAMP,
          updatedBy: auth.currentUser?.email || "system",
        };
        await schoolRef(`remedial/settings/${y}`).update(payload);
        await loadRemedialYearData(y);
        remedialState.rows = remedialRowsFromState();
        renderRemedialCard();
        renderRemedialModal();
      }

      async function upsertRemedialPayment(studentId) {
        const month = document.getElementById("remedialMonthSelect")?.value || "01";
        const existing = parseMoney(
          remedialState.rows.find((r) => r.id === studentId)?.monthPaid?.[month]
        );
        const monthLabel =
          REMEDIAL_MONTHS.find((m) => m.key === month)?.label || `Month ${month}`;
        const year = remedialState.year;
        const picked = await Swal.fire({
          title: `Remedial Payment - ${monthLabel} ${year}`,
          html:
            `<input id="remAmount" class="swal2-input" type="number" min="0" step="100" placeholder="Amount" value="${existing || parseMoney(
              remedialState.settings.monthlyPrice
            )}" />` +
            `<input id="remDate" class="swal2-input" type="date" value="${new Date()
              .toISOString()
              .slice(0, 10)}" />`,
          showCancelButton: true,
          confirmButtonText: "Save",
          preConfirm: () => {
            const amount = parseMoney(document.getElementById("remAmount")?.value);
            const paidAt = document.getElementById("remDate")?.value || "";
            if (!paidAt) {
              Swal.showValidationMessage("Payment date is required");
              return null;
            }
            return { amount, paidAt };
          },
        });
        if (!picked.isConfirmed || !picked.value) return;
        const { amount, paidAt } = picked.value;
        const ref = schoolRef(`remedial/payments/${year}/${studentId}/${month}`);
        if (amount <= 0) {
          await ref.remove();
        } else {
          await ref.set({
            amount,
            paidAt,
            recordedAt: firebase.database.ServerValue.TIMESTAMP,
            recordedBy: auth.currentUser?.email || "system",
          });
        }
        await loadRemedialYearData(year);
        remedialState.rows = remedialRowsFromState();
        renderRemedialCard();
        renderRemedialModal();
      }

      async function addRemedialLedger(type) {
        const isExpense = type === "expense";
        const labelInput = document.getElementById(
          isExpense ? "remedialExpenseLabel" : "remedialIncomeLabel"
        );
        const amountInput = document.getElementById(
          isExpense ? "remedialExpenseAmount" : "remedialIncomeAmount"
        );
        const label = String(labelInput?.value || "").trim();
        const amount = parseMoney(amountInput?.value);
        if (!label || amount <= 0) {
          Swal.fire("Missing data", "Enter description and amount.", "warning");
          return;
        }
        const path = isExpense ? "expenses" : "incomeExtras";
        await schoolRef(`remedial/${path}/${remedialState.year}`).push({
          label,
          amount,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          createdBy: auth.currentUser?.email || "system",
        });
        labelInput.value = "";
        amountInput.value = "";
        await loadRemedialYearData(remedialState.year);
        remedialState.rows = remedialRowsFromState();
        renderRemedialCard();
        renderRemedialModal();
      }

      function remedialExportRows(filterKey) {
        const classFilterKey =
          document.getElementById("remedialClassFilter")?.value || "all";
        const rows = remedialRowsFiltered(filterKey, classFilterKey);
        const generatedAt = new Date().toLocaleString();
        return rows.map((r) => ({
          School:
            currentSchool?.name || currentSchool?.code || currentSchool?.id || "School",
          Year: remedialState.year,
          Admission: r.admission,
          Name: r.name,
          Class: r.className,
          "Parent Contact": r.parentContact,
          "Monthly Price": parseMoney(remedialState.settings.monthlyPrice),
          "Paid Months Count": r.paidMonthsCount,
          "Paid Months": r.paidMonths.join(", "),
          "Total Paid (Jan-Aug)": r.totalPaidAug,
          "Debt To Date": r.debtToDate,
          "Debt To August": r.debtToAugust,
          "Class Filter Used": classFilterKey,
          Status: r.status,
          "Generated At": generatedAt,
        }));
      }

      function exportRemedialExcel(filterKey) {
        if (!window.XLSX) {
          Swal.fire("Library missing", "Excel library not loaded.", "error");
          return;
        }
        const rows = remedialExportRows(filterKey);
        const ws = XLSX.utils.json_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Remedial");
        const schoolSafe = String(
          currentSchool?.name || currentSchool?.id || "School"
        ).replace(/[^\w\-]+/g, "_");
        XLSX.writeFile(
          wb,
          `Remedial_${schoolSafe}_${remedialState.year}_${filterKey}.xlsx`
        );
      }

      function exportRemedialPdf(filterKey) {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          Swal.fire("Library missing", "PDF library not loaded.", "error");
          return;
        }
        const rows = remedialExportRows(filterKey);
        const doc = new window.jspdf.jsPDF({ orientation: "landscape", unit: "pt" });
        doc.setFillColor(59, 130, 246);
        doc.rect(0, 0, 1200, 52, "F");
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(15);
        doc.text("Remedial Report (Class 4 & 7)", 32, 32);
        doc.setTextColor(15, 23, 42);
        doc.setFontSize(10);
        const meta = `School: ${
          currentSchool?.name || currentSchool?.id || "School"
        } | Year: ${remedialState.year} | Generated: ${new Date().toLocaleString()}`;
        doc.text(meta, 32, 72);
        const body = rows.map((r, i) => [
          i + 1,
          r.Admission,
          r.Name,
          r.Class,
          r["Parent Contact"],
          r["Paid Months Count"],
          r["Total Paid (Jan-Aug)"],
          r["Debt To Date"],
          r["Debt To August"],
          r.Status,
        ]);
        doc.autoTable({
          startY: 86,
          head: [
            [
              "#",
              "Admission",
              "Name",
              "Class",
              "Parent Contact",
              "Paid Months",
              "Paid Amount",
              "Debt To Date",
              "Debt To August",
              "Status",
            ],
          ],
          body,
          styles: { fontSize: 8, cellPadding: 4 },
          headStyles: { fillColor: [79, 70, 229] },
          alternateRowStyles: { fillColor: [241, 245, 249] },
        });
        const schoolSafe = String(
          currentSchool?.name || currentSchool?.id || "School"
        ).replace(/[^\w\-]+/g, "_");
        doc.save(`Remedial_${schoolSafe}_${remedialState.year}_${filterKey}.pdf`);
      }

      function exportRemedialExpensesExcel() {
        if (!window.XLSX) {
          Swal.fire("Library missing", "Excel library not loaded.", "error");
          return;
        }
        const expenses = Object.entries(remedialState.expenses || {}).map(
          ([key, e]) => ({
            "#": 0,
            Description: e.label || "",
            Amount: parseMoney(e.amount),
            Date: e.createdAt
              ? new Date(typeof e.createdAt === "number" ? e.createdAt : e.createdAt).toLocaleDateString()
              : "-",
            "Recorded By": e.createdBy || "-",
          })
        );
        expenses.forEach((r, i) => (r["#"] = i + 1));
        const ws = XLSX.utils.json_to_sheet(expenses);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Expenses");
        const schoolSafe = String(
          currentSchool?.name || currentSchool?.id || "School"
        ).replace(/[^\w\-]+/g, "_");
        XLSX.writeFile(
          wb,
          `Remedial_Expenses_${schoolSafe}_${remedialState.year}.xlsx`
        );
      }

      async function exportRemedialExpensesPdf() {
        if (!window.jspdf || !window.jspdf.jsPDF) {
          Swal.fire("Library missing", "PDF library not loaded.", "error");
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: "portrait", unit: "mm", format: "a4" });
        const margin = 14;
        let y = 14;
        const schoolName =
          currentSchool?.name || currentSchool?.code || currentSchool?.id || "School";
        const expensesObj = remedialState.expenses || {};
        const expensesList = Object.entries(expensesObj).map(([key, e]) => ({
          key,
          label: e.label || "",
          amount: parseMoney(e.amount),
          createdAt: e.createdAt,
          createdBy: e.createdBy || "-",
        }));
        const totalExpenses = expensesList.reduce((s, e) => s + e.amount, 0);
        const totals = remedialTotals(remedialState.rows || []);
        const collected = totals.collected;
        const extraIncome = totals.extraIncomeTotal || 0;
        const balanceAfterExpenses = collected + extraIncome - totalExpenses;
        const mostExpense =
          expensesList.length > 0
            ? expensesList.reduce((a, b) => (a.amount >= b.amount ? a : b))
            : null;
        const leastExpense =
          expensesList.length > 0
            ? expensesList.reduce((a, b) => (a.amount <= b.amount ? a : b))
            : null;
        const dateFrom =
          expensesList.length > 0
            ? expensesList
                .map((e) =>
                  e.createdAt
                    ? new Date(
                        typeof e.createdAt === "number"
                          ? e.createdAt
                          : (e.createdAt.seconds || e.createdAt) * 1000
                      )
                    : null
                )
                .filter(Boolean)
                .sort((a, b) => a - b)[0]
            : null;
        const dateTo =
          expensesList.length > 0
            ? expensesList
                .map((e) =>
                  e.createdAt
                    ? new Date(
                        typeof e.createdAt === "number"
                          ? e.createdAt
                          : (e.createdAt.seconds || e.createdAt) * 1000
                      )
                    : null
                )
                .filter(Boolean)
                .sort((a, b) => b - a)[0]
            : null;
        const reportDateFrom = dateFrom
          ? dateFrom.toLocaleDateString("en-GB", {
              day: "numeric",
              month: "long",
              year: "numeric",
            })
          : "N/A";
        const reportDateTo = dateTo
          ? dateTo.toLocaleDateString("en-GB", {
              day: "numeric",
              month: "long",
              year: "numeric",
            })
          : "N/A";
        const downloadDate = new Date().toLocaleDateString("en-GB", {
          day: "numeric",
          month: "long",
          year: "numeric",
        });

        let logoDataUrl = null;
        try {
          const logoSnap = await schoolRef("profile/logoUrl").once("value");
          const logoUrl = logoSnap.val();
          if (logoUrl) {
            const img = await fetch(logoUrl).then((r) => r.blob());
            const reader = new FileReader();
            logoDataUrl = await new Promise((res, rej) => {
              reader.onload = () => res(reader.result);
              reader.onerror = rej;
              reader.readAsDataURL(img);
            });
          }
          if (!logoDataUrl) {
            const fallbacks = [
              "images/somap-logo.png.jpg",
              "images/socrates_logo.png",
            ];
            for (const p of fallbacks) {
              try {
                const img = await fetch(p).then((r) => r.blob());
                const reader = new FileReader();
                logoDataUrl = await new Promise((res, rej) => {
                  reader.onload = () => res(reader.result);
                  reader.onerror = rej;
                  reader.readAsDataURL(img);
                });
                if (logoDataUrl) break;
              } catch (_) {}
            }
          }
          if (logoDataUrl) {
            doc.addImage(logoDataUrl, "PNG", margin, y - 2, 20, 20);
          }
        } catch (_) {}
        doc.setFontSize(18);
        doc.text(schoolName, margin + (logoDataUrl ? 24 : 0), y + 10);
        y += 14;
        doc.setFontSize(14);
        doc.text("Expenditure Report — Remedial (Classes 4 & 7)", margin, y);
        y += 8;
        doc.setFontSize(10);
        doc.text(
          `Year: ${remedialState.year} | Report generated: ${downloadDate}`,
          margin,
          y
        );
        y += 10;
        doc.setFontSize(10);
        const introText =
          reportDateFrom !== "N/A" && reportDateTo !== "N/A"
            ? `This report shows that from ${reportDateFrom} until ${reportDateTo}, we have spent a total of ${formatTsh(totalExpenses)}.`
            : `This report shows that as of ${downloadDate}, we have spent a total of ${formatTsh(totalExpenses)}.`;
        const introLines = doc.splitTextToSize(introText, 180);
        doc.text(introLines, margin, y);
        y += introLines.length * 5 + 4;
        if (mostExpense && leastExpense && expensesList.length > 1) {
          doc.text(
            `The highest single expense is on: ${mostExpense.label} (${formatTsh(mostExpense.amount)}).`,
            margin,
            y
          );
          y += 5;
          doc.text(
            `The lowest single expense is on: ${leastExpense.label} (${formatTsh(leastExpense.amount)}).`,
            margin,
            y
          );
          y += 5;
        }
        const balanceDesc =
          extraIncome > 0
            ? `Collected: ${formatTsh(collected)} + Extra Income: ${formatTsh(extraIncome)} − Expenses: ${formatTsh(totalExpenses)}`
            : `Collected: ${formatTsh(collected)} − Expenses: ${formatTsh(totalExpenses)}`;
        const balanceLines = doc.splitTextToSize(
          `This report shows that the balance after expenses is ${formatTsh(balanceAfterExpenses)} (${balanceDesc}).`,
          180
        );
        doc.text(balanceLines, margin, y);
        y += balanceLines.length * 5 + 12;

        const tableBody =
          expensesList.length > 0
            ? expensesList.map((e, i) => [
                i + 1,
                e.label,
                formatTsh(e.amount),
                e.createdAt
                  ? new Date(
                      typeof e.createdAt === "number"
                        ? e.createdAt
                        : (e.createdAt.seconds || e.createdAt) * 1000
                    ).toLocaleDateString()
                  : "-",
                e.createdBy,
              ])
            : [["No expenses recorded for this period.", "", "", "", ""]];
        doc.autoTable({
          startY: y,
          head: [["#", "Description", "Amount", "Date", "Recorded By"]],
          body: tableBody,
          theme: "grid",
          margin: { left: margin },
          styles: { fontSize: 9 },
          headStyles: { fillColor: [79, 70, 229] },
          alternateRowStyles: { fillColor: [248, 250, 252] },
        });
        y = doc.lastAutoTable.finalY + 14;

        doc.setFontSize(9);
        doc.text("Prepared by:", margin, y);
        y += 5;
        doc.text(
          auth?.currentUser?.email || "—",
          margin,
          y
        );
        y += 10;
        doc.text("_________________________", margin, y);
        y += 5;
        doc.text("Headteacher signature", margin, y);

        const schoolSafe = String(schoolName).replace(/[^\w\-]+/g, "_");
        doc.save(
          `Remedial_Expenses_Report_${schoolSafe}_${remedialState.year}.pdf`
        );
      }

      function openRemedialModal() {
        remedialState.open = true;
        const modal = document.getElementById("remedialModal");
        if (modal) {
          modal.classList.add("open");
          modal.setAttribute("aria-hidden", "false");
        }
        renderRemedialModal();
      }

      function closeRemedialModal() {
        remedialState.open = false;
        const modal = document.getElementById("remedialModal");
        if (modal) {
          modal.classList.remove("open");
          modal.setAttribute("aria-hidden", "true");
        }
      }

      function bindRemedialUi() {
        const card = document.getElementById("remedialCard");
        if (card && !card.dataset.bound) {
          card.dataset.bound = "true";
          card.addEventListener("click", openRemedialModal);
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              openRemedialModal();
            }
          });
        }
        const closeBtn = document.getElementById("remedialCloseBtn");
        closeBtn?.addEventListener("click", closeRemedialModal);
        const modal = document.getElementById("remedialModal");
        modal?.addEventListener("click", (e) => {
          if (e.target === modal) closeRemedialModal();
        });
        document
          .getElementById("remedialSaveSettingsBtn")
          ?.addEventListener("click", () =>
            saveRemedialSettings().catch((err) =>
              Swal.fire("Error", err?.message || "Failed to save settings", "error")
            )
          );
        document
          .getElementById("remedialAddExpenseBtn")
          ?.addEventListener("click", () =>
            addRemedialLedger("expense").catch((err) =>
              Swal.fire("Error", err?.message || "Failed to add expense", "error")
            )
          );
        document
          .getElementById("remedialAddIncomeBtn")
          ?.addEventListener("click", () =>
            addRemedialLedger("income").catch((err) =>
              Swal.fire("Error", err?.message || "Failed to add income", "error")
            )
          );
        document
          .getElementById("remedialStatusFilter")
          ?.addEventListener("change", renderRemedialModal);
        document
          .getElementById("remedialMonthSelect")
          ?.addEventListener("change", renderRemedialModal);
        document
          .getElementById("remedialClassFilter")
          ?.addEventListener("change", renderRemedialModal);
        document
          .getElementById("remedialTableBody")
          ?.addEventListener("click", (e) => {
            const btn = e.target.closest("[data-remedial-pay]");
            if (!btn) return;
            const sid = btn.getAttribute("data-remedial-pay");
            if (!sid) return;
            upsertRemedialPayment(sid).catch((err) =>
              Swal.fire("Error", err?.message || "Failed to save payment", "error")
            );
          });
        document
          .getElementById("remedialExportExcelAll")
          ?.addEventListener("click", () => exportRemedialExcel("all"));
        document
          .getElementById("remedialExportExcelDebtors")
          ?.addEventListener("click", () => exportRemedialExcel("debtors"));
        document
          .getElementById("remedialExportExcelPaid")
          ?.addEventListener("click", () => exportRemedialExcel("paid"));
        document
          .getElementById("remedialExportPdfAll")
          ?.addEventListener("click", () => exportRemedialPdf("all"));
        document
          .getElementById("remedialExportPdfDebtors")
          ?.addEventListener("click", () => exportRemedialPdf("debtors"));
        document
          .getElementById("remedialExportPdfPaid")
          ?.addEventListener("click", () => exportRemedialPdf("paid"));
        document
          .getElementById("remedialExportExcelExpenses")
          ?.addEventListener("click", () => exportRemedialExpensesExcel());
        document
          .getElementById("remedialExportPdfExpenses")
          ?.addEventListener("click", () =>
            exportRemedialExpensesPdf().catch((err) =>
              Swal.fire(
                "Error",
                err?.message || "Failed to export expenses PDF",
                "error"
              )
            )
          );
      }

      function renderRecentActivitiesFromPayments(payments, allowedIds) {
        const list = document.getElementById("activities-list");
        if (!list) return;
        if (!allowedIds.size) {
          list.innerHTML = "<li>No recent activities.</li>";
          return;
        }
        const items = payments
          .filter((p) => allowedIds.has(p.studentId))
          .slice(0, 4);
        if (!items.length) {
          list.innerHTML = "<li>No recent activities.</li>";
          return;
        }
        list.innerHTML = items
          .map((p) => {
            const ts = p.timestamp
              ? new Date(p.timestamp).toLocaleString()
              : new Date().toLocaleString();
            return `<li>${p.fullName} paid ${formatTsh(p.amount)} via ${
              p.method || "-"
            } - ${ts}</li>`;
          })
          .join("");
      }
      function updateFeeChart(collected, due) {
        const ctx = document.getElementById("fee-chart")?.getContext("2d");
        if (ctx && Chart.getChart(ctx.canvas)) {
          Chart.getChart(ctx.canvas).data.datasets[0].data = [
            collected,
            due - collected,
          ];
          Chart.getChart(ctx.canvas).data.labels = ["Collected", "Outstanding"];
          Chart.getChart(ctx.canvas).update();
        }
      }
      // Load Parent Data for parent role
      function loadParentData(phone) {
        schoolRef("students")
          .orderByChild("parentPhone")
          .equalTo(phone)
          .once("value")
          .then((snapshot) => {
            const child = snapshot.val();
            document.getElementById("child-details").innerHTML = child
              ? Object.values(child)
                  .map(
                    (c) =>
                      `<p>${
                        c.name || c.firstName + " " + c.lastName
                      } - Class: ${c.classLevel} - Balance: TSh ${
                        c.balance
                      }</p>`
                  )
                  .join("")
              : "<p>No child found.</p>";
          });
      }
      // Add School
      document
        .getElementById("add-school-form")
        ?.addEventListener("submit", (e) => {
          e.preventDefault();
          const schoolName = document.getElementById("school-name").value;
          db.ref("schools").push({ name: schoolName });
          Swal.fire("Success", "School added!", "success");
        });
      // Logout
      document.getElementById("logout").addEventListener("click", () => {
        auth.signOut().then(() => location.reload());
      });
      // Charts (Fee Trends)
      const feeCtx = document.getElementById("fee-chart")?.getContext("2d");
      if (feeCtx) {
        new Chart(feeCtx, {
          type: "line",
          data: {
            labels: [
              "Jan",
              "Feb",
              "Mar",
              "Apr",
              "May",
              "Jun",
              "Jul",
              "Aug",
              "Sep",
            ],
            datasets: [
              {
                label: "Fee Collection (TSh)",
                data: [0, 0, 0, 0, 0, 0, 0, 0, 0],
                backgroundColor: "#20c997",
              },
            ],
          },
        });
      }
      // Attendance Chart
      const attendanceCtx = document
        .getElementById("attendance-chart")
        ?.getContext("2d");
      if (attendanceCtx) {
        new Chart(attendanceCtx, {
          type: "bar",
          data: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: [
              {
                label: "Attendance",
                data: [90, 92, 94, 93, 95, 80, 85],
                backgroundColor: "#20c997",
              },
            ],
          },
        });
      }
      // Load Market
      function loadMarket() {
        schoolRef("market/products")
          .once("value")
          .then((snapshot) => {
            // Populate if data
          });
      }
      // AI Ask
      document
        .querySelector("#ai-insights button")
        ?.addEventListener("click", () => {
          const query = document.querySelector("#ai-insights input").value;
          Swal.fire("AI Response", `Generating report for: ${query}`, "info");
        });
      bindRemedialUi();
      // Initial
      auth.onAuthStateChanged((user) => {
        if (user) {
          
          const ADMIN_EMAILS = new Set([
            "socratesschool2020@gmail.com",
            "ssclass42023@gmail.com",
          ]);

          if (user.email && ADMIN_EMAILS.has(user.email.toLowerCase())) {
            // Force admin role on every device/browser
            localStorage.setItem("role", "admin");

            // Ensure admin is not stuck in read-only mode
            sessionStorage.removeItem("dashboardReadOnly");
          }
          

          const role = localStorage.getItem("role") || "admin";

          // Check if accessed from Teacher Dashboard (workertasks.html) in read-only mode
          const isReadOnly =
            sessionStorage.getItem("dashboardReadOnly") === "true";
          const accessedBy = sessionStorage.getItem("dashboardAccessedBy");

          if (isReadOnly && accessedBy) {
            console.log("[READ-ONLY] Dashboard accessed by:", accessedBy);

            // HIDE THE ENTIRE SIDEBAR - teachers don't need to see it
            const sidebar = document.getElementById("sidebar");
            if (sidebar) {
              sidebar.style.display = "none";
            }

            // Remove workspace left margin since sidebar is hidden
            const workspace = document.querySelector(".workspace");
            if (workspace) {
              workspace.style.marginLeft = "0";
              workspace.style.maxWidth = "100%";
            }

            // Hide all role-specific elements first
            document
              .querySelectorAll(".role-specific")
              .forEach((el) => (el.style.display = "none"));

            // Show only stats and overview sections (no editing capabilities)
            document.querySelectorAll(".module-section").forEach((section) => {
              // Hide all sections by default
              section.style.display = "none";
            });

            // Show only the dashboard overview and statistics
            const dashboardSection = document.getElementById("dashboard");
            if (dashboardSection) {
              dashboardSection.style.display = "block";
            }

            // Hide charts to speed up loading
            const feeTrendsSection = document.getElementById("fee-trends");
            if (feeTrendsSection) feeTrendsSection.style.display = "none";

            // Hide attendance chart if it's in a module-section
            document
              .querySelectorAll(".chart-container")
              .forEach((container) => {
                const canvas = container.querySelector("canvas");
                if (
                  canvas &&
                  (canvas.id === "fee-chart" ||
                    canvas.id === "attendance-chart")
                ) {
                  container.style.display = "none";
                }
              });

            // Make all stat cards non-clickable
            document
              .querySelectorAll(".stat-card, .stats-card, .finance-card")
              .forEach((card) => {
                card.style.cursor = "default";
                card.style.pointerEvents = "none";
                card.style.transform = "none";
                // Remove hover effects
                card.addEventListener("mouseenter", (e) => {
                  e.currentTarget.style.transform = "none";
                });
              });

            // Show Quick Actions section but make it read-only
            const quickActionsSection =
              document.getElementById("quick-actions");
            if (quickActionsSection) {
              quickActionsSection.style.display = "block";

              // Disable all quick action buttons except for specific ones
              quickActionsSection
                .querySelectorAll(".quick-action-btn")
                .forEach((btn) => {
                  // Check if it's the Workers Hub button
                  if (btn.textContent.includes("Open Workers Hub")) {
                    // Only show Workers Hub for Head Teacher
                    if (accessedBy === "Head Teacher") {
                      btn.style.display = "inline-block";
                      btn.style.pointerEvents = "auto";
                      btn.style.cursor = "pointer";
                    } else {
                      btn.style.display = "none";
                    }
                  } else {
                    // Hide all other action buttons completely
                    btn.style.display = "none";
                  }
                });
            }

            // Add read-only banner
            if (workspace && !document.getElementById("readonly-banner")) {
              const banner = document.createElement("div");
              banner.id = "readonly-banner";
              banner.style.cssText = `
                        background: linear-gradient(135deg, #f59e0b, #ef4444);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        text-align: center;
                        font-weight: 600;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        position: sticky;
                        top: 0;
                        z-index: 100;
                    `;
              banner.innerHTML = `
                        <strong>READ-ONLY DASHBOARD</strong> - ${accessedBy} View
                        ${
                          accessedBy === "Head Teacher"
                            ? '<br><small style="font-size: 0.9em;">Head Teacher can access Workers Hub for staff registration</small>'
                            : '<br><small style="font-size: 0.9em;">View statistics only - No editing allowed</small>'
                        }
                        <button onclick="window.location.href='workershtml/workertasks.html'" 
                            style="margin-left: 20px; padding: 8px 16px; background: white; color: #ef4444; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                            Back to Teacher Dashboard
                        </button>
                    `;
              workspace.insertBefore(banner, workspace.firstChild);
            }

            // Add loading indicator
            const dashboardOverview = document.querySelector(
              "#dashboard .row.grid"
            );
            if (dashboardOverview) {
              dashboardOverview.style.opacity = "0.6";
              const loader = document.createElement("div");
              loader.id = "stats-loader";
              loader.style.cssText =
                "text-align: center; padding: 20px; color: white; font-size: 1.2rem;";
              loader.innerHTML =
                '<div class="loader" style="width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; margin: 0 auto; animation: spin 0.8s linear infinite;"></div><p style="margin-top: 16px;">Loading statistics...</p>';
              dashboardOverview.parentElement.insertBefore(
                loader,
                dashboardOverview
              );
            }

            // Load dashboard data in view-only mode (optimized - only load essential data)
            console.log("[READ-ONLY] Loading optimized dashboard data...");

            // Use a slight delay to ensure DOM is ready
            setTimeout(() => {
              refreshDashboard("admin", null);
              bindYearChangeListener();

              // Remove loader after data loads
              setTimeout(() => {
                const loader = document.getElementById("stats-loader");
                if (loader) loader.remove();
                if (dashboardOverview) dashboardOverview.style.opacity = "1";
              }, 1500);
            }, 100);
          } else {
            // Normal mode - regular user access
            const sidebarEl = document.getElementById("sidebar");
            if (sidebarEl) {
              sidebarEl.classList.remove("hidden");
            }
            document
              .querySelectorAll(".role-specific")
              .forEach((el) => (el.style.display = "none"));
            document
              .querySelectorAll(`.role-specific.${role}-only`)
              .forEach((el) => (el.style.display = "block"));
            const gradShortcut = document.getElementById("graduationShortcut");
            if (gradShortcut) {
              gradShortcut.style.display = GRAD_EMAILS.has(
                user.email.toLowerCase()
              )
                ? "flex"
                : "none";
            }
            refreshDashboard(role, getClassFromEmail(user.email));
            bindYearChangeListener();
            if (role === "parent") {
              const phone = localStorage.getItem("parentPhone");
              if (phone) loadParentData(phone);
            }
          }
        } else {
          // Check if accessed from teacher dashboard with workerId
          const workerId = localStorage.getItem("workerId");
          const isReadOnly =
            sessionStorage.getItem("dashboardReadOnly") === "true";

          if (workerId && isReadOnly) {
            // Teacher accessing - don't redirect, use anonymous access for viewing
            console.log("[Teacher] Viewing dashboard in read-only mode");

            const accessedBy = sessionStorage.getItem("dashboardAccessedBy");

            // HIDE THE ENTIRE SIDEBAR - teachers don't need to see it
            const sidebar = document.getElementById("sidebar");
            if (sidebar) {
              sidebar.style.display = "none";
            }

            // Remove workspace left margin since sidebar is hidden
            const workspace = document.querySelector(".workspace");
            if (workspace) {
              workspace.style.marginLeft = "0";
              workspace.style.maxWidth = "100%";
            }

            // Hide all role-specific elements
            document
              .querySelectorAll(".role-specific")
              .forEach((el) => (el.style.display = "none"));

            // Hide all sections except dashboard overview
            document.querySelectorAll(".module-section").forEach((section) => {
              section.style.display = "none";
            });

            // Show only the main dashboard
            const dashboardSection = document.getElementById("dashboard");
            if (dashboardSection) dashboardSection.style.display = "block";

            // Hide charts to speed up loading
            const feeTrendsSection = document.getElementById("fee-trends");
            if (feeTrendsSection) feeTrendsSection.style.display = "none";

            // Hide attendance chart if it's in a module-section
            document
              .querySelectorAll(".chart-container")
              .forEach((container) => {
                const canvas = container.querySelector("canvas");
                if (
                  canvas &&
                  (canvas.id === "fee-chart" ||
                    canvas.id === "attendance-chart")
                ) {
                  container.style.display = "none";
                }
              });

            // Make all stat cards non-clickable
            document
              .querySelectorAll(".stat-card, .stats-card, .finance-card")
              .forEach((card) => {
                card.style.cursor = "default";
                card.style.pointerEvents = "none";
                card.style.transform = "none";
                // Remove hover effects
                card.addEventListener("mouseenter", (e) => {
                  e.currentTarget.style.transform = "none";
                });
              });

            // Show Quick Actions for Head Teacher to access Workers Hub
            if (accessedBy === "Head Teacher") {
              const quickActionsSection =
                document.getElementById("quick-actions");
              if (quickActionsSection) {
                quickActionsSection.style.display = "block";
                quickActionsSection
                  .querySelectorAll(".quick-action-btn")
                  .forEach((btn) => {
                    if (btn.textContent.includes("Open Workers Hub")) {
                      btn.style.display = "inline-block";
                      btn.style.pointerEvents = "auto";
                      btn.style.cursor = "pointer";
                    } else {
                      btn.style.display = "none";
                    }
                  });
              }
            }

            // Add read-only banner
            if (workspace && !document.getElementById("readonly-banner")) {
              const banner = document.createElement("div");
              banner.id = "readonly-banner";
              banner.style.cssText = `
                        background: linear-gradient(135deg, #f59e0b, #ef4444);
                        color: white;
                        padding: 16px 24px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        text-align: center;
                        font-weight: 600;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                        position: sticky;
                        top: 0;
                        z-index: 100;
                    `;
              banner.innerHTML = `
                        <strong>READ-ONLY DASHBOARD</strong> - ${
                          accessedBy || "Teacher"
                        } View
                        ${
                          accessedBy === "Head Teacher"
                            ? '<br><small style="font-size: 0.9em;">Head Teacher can access Workers Hub for staff registration</small>'
                            : '<br><small style="font-size: 0.9em;">View statistics only - No editing allowed</small>'
                        }
                        <button onclick="window.location.href='workershtml/workertasks.html'" 
                            style="margin-left: 20px; padding: 8px 16px; background: white; color: #ef4444; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                            Back to Teacher Dashboard
                        </button>
                    `;
              workspace.insertBefore(banner, workspace.firstChild);
            }

            refreshDashboard("admin", null);
            bindYearChangeListener();
          } else {
            // Not logged in and not from teacher dashboard - redirect to login
            window.location.href = "index.html";
          }
        }
      });
      // Sidebar Clicks
      document
        .querySelector('[data-module="erp"]')
        .addEventListener("click", () => {
          window.location.href = "schoolerp.html";
        });
      document
        .querySelector('[data-module="finance"]')
        .addEventListener("click", () => {
          window.location.href = "finance.html";
        });
      const commandMenu = document.getElementById("commandMenu");
      const commandToggle = document.getElementById("commandMenuToggle");
      const commandMenuClose = document.getElementById("commandMenuClose");
      const openCommandMenu = () => {
        if (!commandMenu) return;
        commandMenu.classList.add("open");
        commandToggle?.setAttribute("aria-expanded", "true");
      };
      const closeCommandMenu = () => {
        if (!commandMenu) return;
        commandMenu.classList.remove("open");
        commandToggle?.setAttribute("aria-expanded", "false");
      };
      commandToggle?.addEventListener("click", () => {
        if (commandMenu?.classList.contains("open")) closeCommandMenu();
        else openCommandMenu();
      });
      commandMenuClose?.addEventListener("click", closeCommandMenu);
      commandMenu?.addEventListener("click", (event) => {
        if (event.target === commandMenu) closeCommandMenu();
      });
      commandMenu?.querySelectorAll(".command-tile").forEach((tile) => {
        tile.addEventListener("click", () => closeCommandMenu());
      });
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") closeCommandMenu();
      });
      document
        .querySelector('[data-module="dashboard"]')
        .addEventListener("click", () => {
          refreshDashboard(
            localStorage.getItem("role"),
            getClassFromEmail(auth.currentUser?.email)
          );
          bindYearChangeListener();
          document
            .getElementById("dashboard")
            .scrollIntoView({ behavior: "smooth" });
        });

      (function () {
        var shortcut = document.getElementById("schoolApprovalsShortcut");
        if (!shortcut || !window.SOMAP || !SOMAP.getSchoolId) return;

        var schoolId = SOMAP.getSchoolId();
        if (schoolId === "socrates-school") {
          shortcut.style.display = "";
        } else {
          shortcut.style.display = "none";
        }
      })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
