﻿﻿﻿<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SoMAp ΓÇö Parent Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="somapappv1multischool/js/context.js"></script>
    <script src="Todashboardhtml/yearContext.js"></script>

    <!-- PDFs / CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Alerts / Charts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script type="module">
      import { mountMarketingHubCard } from "./marketing/marketing.js";
      window.addEventListener("DOMContentLoaded", () => {
        const el = document.getElementById("marketinghub-card-root");
        if (el) mountMarketingHubCard({ el, context: "parent" });
      });
    </script>

    <style>
      /* ==== Theme (Codex vibe) ==== */
      :root {
        --glass: rgba(15, 23, 42, 0.82);
        --line: rgba(148, 163, 184, 0.22);
        --muted: rgba(226, 232, 240, 0.75);
        --text: #e2e8f0;
        --title: #fff;
        --sky: #0ea5e9;
        --orchid: #8b5cf6;
        --emerald: #10b981;
        --amber: #f59e0b;
        --accent: #6366f1;
      }
      html {
        scroll-behavior: smooth;
      }
      body {
        margin: 0;
        min-height: 100vh;
        color: var(--text);
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: radial-gradient(
            1200px 800px at -10% -10%,
            rgba(14, 165, 233, 0.35),
            transparent 40%
          ),
          radial-gradient(
            900px 700px at 110% -10%,
            rgba(139, 92, 246, 0.3),
            transparent 35%
          ),
          linear-gradient(180deg, #020617 0%, #0b1220 100%);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        touch-action: manipulation;
      }

      /* ==== Sidebar ==== */
      .sidebar {
        width: 78px;
        position: fixed;
        inset: 0 auto 0 0;
        z-index: 40;
        background: linear-gradient(
          180deg,
          rgba(2, 6, 23, 0.8),
          rgba(2, 6, 23, 0.55)
        );
        border-right: 1px solid var(--line);
        backdrop-filter: blur(10px);
        padding: 12px 10px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }
      .sb-logo {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        object-fit: cover;
      }
      .icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        background: rgba(148, 163, 184, 0.08);
        border: 1px solid transparent;
        transition: transform 0.15s ease, background 0.2s ease,
          border-color 0.2s ease;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      .icon:hover {
        transform: translateY(-3px);
        background: rgba(148, 163, 184, 0.14);
        border-color: var(--line);
      }

      /* ==== Main / Cards ==== */
      .main {
        margin-left: 98px;
        padding: 20px;
      }
      .glass {
        background: var(--glass);
        border: 1px solid var(--line);
        border-radius: 1.5rem;
        box-shadow: 0 30px 80px -40px rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(14px);
      }
      .card {
        background: var(--glass);
        border: 1px solid var(--line);
        border-radius: 1.25rem;
        box-shadow: 0 22px 40px -30px rgba(0, 0, 0, 0.55);
        padding: 18px;
        transition: transform 0.16s ease, box-shadow 0.2s ease,
          border-color 0.2s ease;
      }
      .card:hover {
        transform: translateY(-3px);
        border-color: rgba(148, 163, 184, 0.35);
        box-shadow: 0 30px 60px -35px rgba(14, 165, 233, 0.35);
      }
      .muted {
        color: var(--muted);
      }
      .title {
        color: var(--title);
      }
      .divider {
        border-top: 1px dashed var(--line);
      }

      /* ==== Buttons ==== */
      .btn {
        background: linear-gradient(
          120deg,
          rgba(99, 102, 241, 0.9),
          rgba(14, 165, 233, 0.9)
        );
        color: #fff;
        border: none;
        border-radius: 12px;
        font-weight: 800;
        letter-spacing: 0.2px;
        padding: 10px 14px;
        box-shadow: 0 10px 30px -12px rgba(14, 165, 233, 0.6);
      }
      .btn:hover {
        filter: brightness(1.05);
      }
      .btn-ghost {
        background: rgba(148, 163, 184, 0.12);
        color: #fff;
        border: 1px solid var(--line);
        border-radius: 12px;
        font-weight: 700;
        padding: 8px 12px;
      }

      /* ==== Stats ==== */
      .stat {
        background: linear-gradient(
          140deg,
          rgba(14, 165, 233, 0.18),
          rgba(99, 102, 241, 0.12)
        );
        border: 1px solid var(--line);
        border-radius: 1.25rem;
        padding: 16px;
      }
      .stat-label {
        font-size: 0.85rem;
        letter-spacing: 0.15em;
        text-transform: uppercase;
        color: var(--muted);
      }
      .stat-value {
        font-size: 1.6rem;
        font-weight: 800;
        color: #fff;
        letter-spacing: 0.2px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        border: 1px solid transparent;
        font-size: 0.78rem;
        font-weight: 800;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      .badge-ok {
        background: rgba(16, 185, 129, 0.15);
        color: #86efac;
        border-color: rgba(16, 185, 129, 0.35);
      }
      .badge-warn {
        background: rgba(245, 158, 11, 0.12);
        color: #fcd34d;
        border-color: rgba(245, 158, 11, 0.35);
      }
      .badge-risk {
        background: rgba(239, 68, 68, 0.12);
        color: #fca5a5;
        border-color: rgba(239, 68, 68, 0.35);
      }

      /* ==== Tables / Lists ==== */
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead th {
        text-align: left;
        padding: 10px 8px;
        color: rgba(226, 232, 240, 0.9);
        letter-spacing: 0.18em;
        font-size: 0.75rem;
        text-transform: uppercase;
      }
      tbody td {
        padding: 10px 8px;
        border-top: 1px solid rgba(148, 163, 184, 0.18);
        color: #e5e7eb;
      }
      .payments-list li {
        padding: 12px 0;
        border-bottom: 1px dashed var(--line);
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      #gradGalleryList figure {
        overflow: hidden;
        border-radius: 1.25rem;
        border: 1px solid var(--line);
        background: rgba(15, 23, 42, 0.12);
      }
      #gradGalleryList img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        display: block;
      }
      #gradGalleryList .gallery-meta {
        padding: 12px 14px 16px;
      }
      #gradGalleryList .caption {
        font-weight: 700;
        color: var(--title);
        font-size: 0.95rem;
      }
      #gradGalleryList .meta {
        font-size: 0.68rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--muted);
        margin-top: 4px;
      }

      /* ==== Skeleton ==== */
      .skeleton {
        position: relative;
        overflow: hidden;
        background: rgba(148, 163, 184, 0.12);
        border-radius: 10px;
        min-height: 16px;
      }
      .skeleton::after {
        content: "";
        position: absolute;
        inset: 0;
        transform: translateX(-100%);
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.25),
          transparent
        );
        animation: shimmer 1.4s infinite;
      }
      @keyframes shimmer {
        100% {
          transform: translateX(100%);
        }
      }

      /* ==== Responsive improvements (ONLY spacing/flow) ==== */
      /* Replace inline 1fr/360px with a clean class */
      .two-col {
        grid-template-columns: 1fr;
      }
      @media (min-width: 1280px) {
        .two-col {
          grid-template-columns: 1fr 360px;
        }
      }
      /* Tighter mobile spacing */
      @media (max-width: 768px) {
        .main {
          padding: 12px;
        }
        .card {
          padding: 14px;
        }
        .stat {
          padding: 12px;
        }
        section.grid.gap-4 {
          row-gap: 12px;
        }
      }
      /* Long phone numbers wonΓÇÖt overflow */
      #detailParentPhone {
        word-break: break-word;
      }

      /* Keep sidebar usable on small screens */
      @media (max-width: 1024px) {
        .main {
          margin-left: 0;
          padding: 14px;
        }
        .sidebar {
          position: sticky;
          top: 0;
          width: 100%;
          height: auto;
          flex-direction: row;
          justify-content: center;
          gap: 10px;
        }
      }
    </style>

    <script>
      /** Years: 2023..2042; default anchor year = 2025 */
      const SOMAP_ALLOWED_YEARS = Array.from(
        { length: 20 },
        (_, i) => 2023 + i
      );
      const SOMAP_DEFAULT_YEAR = 2025;

      /** Tanzania ladder (no Class 8). Labels must match RTDB exactly. */
      const CLASS_ORDER = [
        "Baby Class",
        "Middle Class",
        "Pre Unit Class",
        "Class 1",
        "Class 2",
        "Class 3",
        "Class 4",
        "Class 5",
        "Class 6",
        "Class 7",
      ];
      const CLASS_ALIASES = {
        middle: "Middle Class",
        "middle class": "Middle Class",
        nursery: "Baby Class",
        "pre unit": "Pre Unit Class",
        "pre-unit": "Pre Unit Class",
        preunit: "Pre Unit Class",
        "pre unit class": "Pre Unit Class",
        "preunit class": "Pre Unit Class",
        "pre-primary": "Middle Class",
        "pre primary": "Middle Class",
      };
      const L = (s) =>
        String(s || "")
          .trim()
          .toLowerCase();

      /** Shift base class by delta years from the 2025 anchor. */
      function shiftClass(baseClass, deltaYears) {
        const alias = CLASS_ALIASES[L(baseClass)] || baseClass || "";
        const i = CLASS_ORDER.findIndex((c) => L(c) === L(alias));
        if (i < 0) return baseClass || "";
        const j = i + Number(deltaYears || 0);
        if (j < 0) return "PRE-ADMISSION";
        if (j >= CLASS_ORDER.length) return "GRADUATED";
        return CLASS_ORDER[j];
      }

      /** Global year context shared across SoMAp pages. */
      window.somapYearContext =
        window.somapYearContext ||
        (function () {
          const allowed = SOMAP_ALLOWED_YEARS.map(String);
          const STORAGE_KEY = "somap_selected_year_v2";
          const LEGACY_KEYS = ["somap_selected_year"];
          const VERSION_KEY = "somap_year_ctx_version";
          const CURRENT_VERSION = "2";
          const defaultYear = String(SOMAP_DEFAULT_YEAR);

          const sanitize = (value) => {
            const str = String(value || defaultYear);
            return allowed.includes(str) ? str : defaultYear;
          };

          const bootYear = () => {
            let stored = sessionStorage.getItem(STORAGE_KEY);
            const version = sessionStorage.getItem(VERSION_KEY);
            if (!stored) {
              for (const legacyKey of LEGACY_KEYS) {
                const legacyVal = sessionStorage.getItem(legacyKey);
                if (legacyVal && allowed.includes(legacyVal)) {
                  stored = legacyVal;
                  break;
                }
              }
            }
            stored = sanitize(stored);
            if (version !== CURRENT_VERSION) {
              if (Number(stored) < Number(SOMAP_DEFAULT_YEAR)) {
                stored = defaultYear;
              }
              try {
                sessionStorage.setItem(STORAGE_KEY, stored);
                sessionStorage.setItem(VERSION_KEY, CURRENT_VERSION);
                LEGACY_KEYS.forEach((key) =>
                  sessionStorage.setItem(key, stored)
                );
              } catch (_err) {}
            }
            return stored;
          };

          let saved = bootYear();
          const listeners = new Set();

          return {
            getSelectedYear() {
              return saved;
            },
            setSelectedYear(y) {
              const next = sanitize(y);
              if (saved === next) return;
              saved = next;
              try {
                sessionStorage.setItem(STORAGE_KEY, next);
                sessionStorage.setItem(VERSION_KEY, CURRENT_VERSION);
                LEGACY_KEYS.forEach((key) => sessionStorage.setItem(key, next));
              } catch (_err) {}
              listeners.forEach((fn) => {
                try {
                  fn(next);
                } catch (_e) {}
              });
            },
            onYearChanged(fn) {
              if (typeof fn === "function") listeners.add(fn);
            },
          };
        })();
    </script>

    <script src="shared/finance_math.js"></script>
    <script src="shared/somap-books.js"></script>
    <script src="js/school-logo.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (window.SomapLogo) {
          SomapLogo.loadSchoolLogo({
            defaultLogo: "images/socrates_logo.png",
            fallbackLogo: "images/somap-logo.png.jpg",
          });
        }
      });
    </script>
  </head>
  <body>
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <img
        id="school-logo-display"
        src="images/somap-logo.png.jpg"
        alt="School Logo"
        class="sb-logo"
      />
      <div title="Market" class="icon" data-action="market">
        <i class="fas fa-store"></i>
      </div>
      <div title="Attendance" class="icon" data-action="attendance">
        <i class="fas fa-calendar-check"></i>
      </div>
      <div title="Finance" class="icon" id="parentFinanceIcon">
        <i class="fas fa-money-bill-wave"></i>
      </div>
      <div title="Transport" class="icon" id="parentTransportIcon">
        <i class="fas fa-bus"></i>
      </div>
      <div title="Books" class="icon" data-action="books">
        <i class="fas fa-book"></i>
      </div>
      <div
        id="preform-icon"
        title="Preform One"
        class="icon"
        style="display: none"
        onclick="if(localStorage.getItem('preformParentIcon')) window.location.href='preformonehtml/prefoneparent.html';"
      >
        <i class="fas fa-graduation-cap"></i>
      </div>
      <div style="flex: 1"></div>
      <div id="icon-logout" class="icon" title="Logout">
        <i class="fas fa-sign-out-alt"></i>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- HERO -->
      <section class="glass p-5 lg:p-7 mb-4">
        <div
          class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
        >
          <div>
            <p class="uppercase tracking-[0.35em] text-xs muted">
              Parent Experience Hub
            </p>
            <h1
              id="studentName"
              class="title text-3xl md:text-4xl font-extrabold"
            >
              Parent Dashboard
              <span
                id="parentSchoolLabel"
                class="ml-3 inline-flex items-center px-3 py-1 rounded-full bg-white/10 text-white border border-white/15 text-xs font-semibold align-middle"
              ></span>
            </h1>
            <p id="studentMeta" class="muted mt-1">
              Loading student detailsΓÇª
            </p>
            <p
              id="studentGradBadge"
              class="badge badge-risk mt-2"
              style="display: none"
            >
              Graduated
            </p>
          </div>
          <div
            class="flex flex-col items-end gap-3 md:flex-row md:items-center"
          >
            <div class="text-right md:text-right">
              <p class="muted text-xs uppercase tracking-[0.35em]">Role</p>
              <p class="title font-extrabold">Parent</p>
            </div>
            <div
              id="somapYearWrap"
              style="
                display: flex;
                gap: 0.5rem;
                align-items: center;
                margin: 6px 0;
              "
              class="flex w-full flex-col items-end gap-1 rounded-xl border border-slate-600/40 bg-slate-900/40 px-3 py-2 md:w-auto md:flex-row md:items-center md:border-transparent md:bg-transparent md:px-0 md:py-0"
            >
              <label
                class="muted text-[0.65rem] uppercase tracking-[0.35em] text-xs font-semibold"
                >Academic Year</label
              >
              <select
                data-somap-year-select
                class="w-full min-w-[130px] rounded-lg border border-slate-600/60 bg-slate-950/70 px-3 py-1 text-sm font-semibold text-slate-100 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-500/40 md:min-w-[140px] md:bg-slate-900/60"
              ></select>
              <span class="text-xs text-slate-300"
                >Working year: <b id="somapYearHint">--</b></span
              >
            </div>
            <button class="btn" id="openMarketTop">
              <i class="fas fa-bag-shopping mr-2"></i>Open Market
            </button>
          </div>
        </div>
      </section>

      <section class="mb-4">
        <div id="marketinghub-card-root"></div>
      </section>

      <!-- STATS (xl now fits 5 cards) -->
      <section
        class="grid gap-4 grid-cols-1 sm:grid-cols-2 xl:grid-cols-5 mb-4"
      >
        <article class="stat">
          <p class="stat-label">Total Fee (Year)</p>
          <p id="statFeeDue" class="stat-value">TSh 0</p>
          <p class="muted">Payment plan: <span id="statPaymentPlan">-</span></p>
        </article>

        <article class="stat">
          <p class="stat-label">Total Paid</p>
          <p id="statPaid" class="stat-value">TSh 0</p>
          <p class="muted">To date</p>
        </article>

        <article class="stat">
          <p class="stat-label">
            Balance
            <span id="balanceStatusBadge" class="badge badge-ok ml-2"
              >PAID</span
            >
          </p>
          <p id="statBalance" class="stat-value">TSh 0</p>
          <p class="muted">Outstanding</p>
        </article>

        <article class="stat">
          <p class="stat-label">Attendance (this student)</p>
          <p id="statAttendancePct" class="stat-value">0%</p>
          <p class="muted">Present / Total days</p>
        </article>

        <!-- NEW: RECEIPTS stat (child-only) -->
        <article class="stat">
          <p class="stat-label">Receipts</p>
          <p id="statReceiptCount" class="stat-value">0</p>
          <p id="statReceiptMeta" class="muted">No receipts yet</p>
          <div class="mt-2 flex gap-2">
            <button class="btn" id="openReceiptVaultTop">
              <i class="fas fa-file-invoice-dollar mr-2"></i>Open
            </button>
            <button class="btn-ghost" id="openReceiptNewTabTop">
              <i class="fas fa-up-right-from-square mr-2"></i>New tab
            </button>
          </div>
        </article>
      </section>

      <!-- GRID (responsive two-column) -->
      <section class="grid gap-4 two-col">
        <!-- LEFT COLUMN -->
        <div class="flex flex-col gap-4">
          <!-- RECENT PAYMENTS -->
          <article class="card">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="title text-xl font-extrabold m-0">
                  Recent Payments
                </h3>
                <p class="muted text-sm">Last 10 payments</p>
              </div>
              <button class="btn-ghost" id="refreshPayments">
                <i class="fas fa-rotate"></i> Refresh
              </button>
            </div>

            <ul id="paymentsList" class="payments-list mt-3">
              <li><div class="skeleton h-4 w-40"></div></li>
              <li><div class="skeleton h-4 w-56"></div></li>
              <li><div class="skeleton h-4 w-48"></div></li>
            </ul>
          </article>

          <!-- SCORES -->
          <article class="card">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="title text-xl font-extrabold m-0">
                  Exam Scores (latest)
                </h3>
                <p class="muted text-sm">Auto average ΓÇó Exportable</p>
              </div>
              <div class="flex gap-2">
                <button class="btn-ghost" id="exportCsvBtn">
                  <i class="fas fa-file-csv mr-2"></i>CSV
                </button>
                <button class="btn" id="exportPdfBtn">
                  <i class="fas fa-file-pdf mr-2"></i>PDF
                </button>
              </div>
            </div>

            <div
              class="overflow-auto mt-3 rounded-xl border border-[var(--line)]"
            >
              <table class="min-w-full" id="scoresTable">
                <thead class="bg-white/5">
                  <tr>
                    <th>Subject</th>
                    <th>Score</th>
                    <th>Max</th>
                    <th>%</th>
                  </tr>
                </thead>
                <tbody id="scoresTbody">
                  <tr>
                    <td colspan="4" class="muted p-4">No scores loaded.</td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="mt-3">
              <div class="card p-3">
                <canvas
                  id="scoresChart"
                  style="width: 100%; height: 200px"
                ></canvas>
              </div>
            </div>
          </article>

          <!-- REPORT CARD -->
          <article class="card">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="title text-xl font-extrabold m-0">Report Card</h3>
                <p class="muted text-sm">Generate downloadable report</p>
              </div>
              <div class="flex gap-2">
                <select id="reportExamSelect" class="btn-ghost px-3 py-2">
                  <option value="monthly">Monthly</option>
                  <option value="term">Term</option>
                </select>
                <select id="reportMonth" class="btn-ghost px-3 py-2">
                  <option value="08">August</option>
                  <option value="09">September</option>
                  <option value="01">January</option>
                </select>
                <button class="btn" id="genReportBtn">
                  <i class="fas fa-download mr-2"></i>Download
                </button>
              </div>
            </div>
            <div id="reportPreview" class="muted mt-3">
              Preview not available ΓÇö click Generate to create PDF.
            </div>
          </article>

          <!-- GRADUATION OVERVIEW -->
          <article id="graduationCard" class="card hidden">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="title text-xl font-extrabold m-0">
                  Graduation Payments
                </h3>
                <p class="muted text-sm">
                  Keeps gowns, photos, and celebrations funded.
                </p>
              </div>
              <span id="gradStatus" class="badge hidden">--</span>
            </div>
            <p class="muted text-xs uppercase tracking-[0.35em] mt-2">
              Year <span id="gradYearLabel"></span>
            </p>
            <div
              class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3"
              id="gradSummary"
            >
              <div
                class="glass bg-white/5 border border-white/10 rounded-xl p-3"
              >
                <p class="muted text-xs uppercase tracking-[0.28em]">
                  Expected
                </p>
                <p id="gradExpected" class="text-xl font-bold text-white mt-1">
                  TSh 0
                </p>
              </div>
              <div
                class="glass bg-white/5 border border-white/10 rounded-xl p-3"
              >
                <p class="muted text-xs uppercase tracking-[0.28em]">Paid</p>
                <p
                  id="gradPaid"
                  class="text-xl font-bold text-emerald-300 mt-1"
                >
                  TSh 0
                </p>
              </div>
              <div
                class="glass bg-white/5 border border-white/10 rounded-xl p-3"
              >
                <p class="muted text-xs uppercase tracking-[0.28em]">Balance</p>
                <p
                  id="gradBalance"
                  class="text-xl font-bold text-amber-300 mt-1"
                >
                  TSh 0
                </p>
              </div>
            </div>
            <p id="gradCertificateMessage" class="muted text-sm mt-4">
              Loading graduation status...
            </p>
            <div
              id="gradCertificateActions"
              class="flex flex-wrap gap-2 mt-3"
            ></div>
          </article>

          <!-- GRADUATION GALLERY -->
          <article id="graduationGalleryCard" class="card">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="title text-xl font-extrabold m-0">
                  Graduation Gallery
                </h3>
                <p class="muted text-sm">Highlights from recent ceremonies.</p>
              </div>
              <button class="btn-ghost" id="openGalleryFull">
                <i class="fas fa-up-right-from-square mr-2"></i>Open
              </button>
            </div>
            <div
              id="gradGalleryList"
              class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3"
            >
              <div class="skeleton h-24 rounded-xl"></div>
              <div class="skeleton h-24 rounded-xl"></div>
            </div>
          </article>
        </div>

        <!-- RIGHT COLUMN -->
        <aside class="flex flex-col gap-4">
          <!-- PROFILE / DETAILS -->
          <article class="card">
            <h4 class="title text-lg font-extrabold m-0">Student Details</h4>
            <div class="grid grid-cols-1 gap-3 mt-3 text-sm">
              <div class="divider"></div>
              <div>
                <strong class="muted">Class:</strong>
                <span id="detailClass">-</span>
              </div>
              <div>
                <strong class="muted">Stream:</strong>
                <span id="detailStream">-</span>
              </div>
              <div>
                <strong class="muted">Admission #:</strong>
                <span id="detailAdm">-</span>
              </div>
              <div>
                <strong class="muted">Parent phone:</strong>
                <span id="detailParentPhone">-</span>
              </div>
            </div>
          </article>

          <!-- ATTENDANCE TREND -->
          <article class="card">
            <h4 class="title text-lg font-extrabold m-0">Attendance Trend</h4>
            <canvas
              id="attendanceChart"
              class="mt-3"
              style="width: 100%; height: 180px"
            ></canvas>
          </article>

          <!-- Receipt Vault (shared receipt.html) -->
          <article class="card">
            <h4 class="title text-lg font-extrabold m-0">Receipt Vault</h4>
            <p class="muted mt-1 text-sm">
              View all this childΓÇÖs payments and download official receipts.
            </p>
            <div class="mt-3 flex gap-2">
              <button class="btn" id="openReceiptVault">
                <i class="fas fa-file-invoice-dollar mr-2"></i>Open Receipts
              </button>
              <button class="btn-ghost" id="openReceiptNewTab">
                <i class="fas fa-up-right-from-square mr-2"></i>Open in New Tab
              </button>
            </div>
          </article>

          <article class="card">
            <h4 class="title text-lg font-extrabold m-0">
              Cashbook ya Familia
            </h4>
            <p class="muted mt-1 text-sm">
              Bonyeza uone mapato, matumizi, akiba.
            </p>
            <div class="mt-3">
              <a
                href="societycashbook/societycashbook.html"
                class="btn w-full text-center"
              >
                <i class="fas fa-wallet mr-2"></i>Fungua Money Memory
              </a>
            </div>
          </article>
          <!-- PARENT REFERRALS -->
          <article class="card" id="parentReferralCard">
            <h4 class="title text-lg font-extrabold m-0">
              Invite Other Parents
            </h4>
            <p class="muted text-sm mt-1">
              Share this code to help others join Us.
            </p>

            <!-- Referral code + actions -->
            <div class="mt-3 flex flex-wrap items-center gap-3">
              <!-- Code -->
              <div
                id="parentReferralCode"
                class="px-4 py-2 rounded-lg bg-black/40 border border-white/10 text-sky-300 font-mono text-sm whitespace-nowrap"
              >
                ---
              </div>

              <!-- Copy -->
              <button
                id="copyReferralBtn"
                class="btn-ghost text-sm flex items-center gap-1"
              >
                <i class="fas fa-copy"></i>
                Copy
              </button>

              <!-- WhatsApp -->
              <button
                id="shareWhatsappBtn"
                class="btn-ghost text-sm flex items-center gap-1 text-green-400 hover:text-green-300"
              >
                <i class="fab fa-whatsapp"></i>
                WhatsApp
              </button>
            </div>

            <!-- Referral link -->
            <div class="mt-3">
              <p class="muted text-xs mb-1">Referral link:</p>
              <input
                id="parentReferralLink"
                readonly
                class="w-full px-3 py-2 rounded-lg bg-black/40 border border-white/10 text-xs text-slate-300"
                value=""
              />
            </div>

            <hr class="divider my-4" />

            <h4 class="title text-sm font-bold">
              Students Joined Using My Referral
            </h4>
            <div id="parentReferralList" class="mt-2 flex flex-col gap-2">
              <div class="muted text-sm">No referred students yet.</div>
            </div>

            <p class="muted text-xs mt-3">
              Students who join using your referral will appear after admin
              approval.
            </p>
          </article>

          <!-- QUICK ACTIONS -->
          <article class="card">
            <h4 class="title text-lg font-extrabold m-0">Quick Actions</h4>
            <div class="mt-3 flex flex-col gap-2">
              <button class="btn" id="quickGenerateId">
                <i class="fas fa-id-card-clip mr-2"></i>Generate ID
              </button>
              <button class="btn-ghost" id="quickReportCard">
                <i class="fas fa-file-pdf mr-2"></i>Open Current Report Card
              </button>
              <button class="btn-ghost" id="quickFees">
                <i class="fas fa-coins mr-2"></i>View Fees Info
              </button>
              <button class="btn-ghost hidden" id="quickTransport">
                <i class="fas fa-bus mr-2"></i>Open Transport Hub
              </button>
              <button class="btn-ghost" id="viewMarketSmall">
                <i class="fas fa-basket-shopping mr-2"></i>Open Market
              </button>
            </div>
          </article>

          <!-- CLASS BOOKS -->
          <article class="card" id="parentBooksCard">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h4 class="title text-lg font-extrabold m-0">Class Books</h4>
                <p class="muted text-sm">
                  Year <span id="parentBooksYear">--</span> |
                  <span id="parentBooksClass">--</span>
                </p>
              </div>
              <button class="btn-ghost text-xs" id="openBooksFull">
                <i class="fas fa-up-right-from-square mr-1"></i>Open Library
              </button>
            </div>
            <div id="parentBooksList" class="mt-3 flex flex-col gap-2">
              <div class="skeleton h-4 rounded-xl"></div>
              <div class="skeleton h-4 rounded-xl"></div>
              <div class="skeleton h-4 rounded-xl"></div>
            </div>
            <div id="parentBooksEmpty" class="hidden muted text-sm mt-3"></div>
            <button
              id="parentBooksReload"
              class="btn-ghost mt-3 w-full text-xs flex items-center justify-center gap-2 hidden"
            >
              <i class="fas fa-rotate"></i>Reload from uploads
            </button>
          </article>

          <!-- TRANSPORT PAYMENT SECTION -->
          <article id="parentTransportSection" class="card hidden">
            <h4 class="title text-lg font-extrabold m-0">
              🚐 Transport Payments
            </h4>
            <p class="muted mt-1 text-sm">
              View and pay transport fees for your child.
            </p>
            <div id="transportChildrenList" class="mt-3 flex flex-col gap-2">
              <div class="skeleton h-16 rounded-xl"></div>
              <div class="skeleton h-16 rounded-xl"></div>
            </div>
          </article>
        </aside>
      </section>

      <p class="muted mt-4 text-sm">
        SoMAp ΓÇö All monetary values are shown in Tanzanian shillings (TSh).
      </p>

      <!-- Embedded Receipt Modal -->
      <div
        id="receiptModal"
        class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center"
      >
        <div
          class="relative w-[90vw] h-[90vh] bg-slate-900 border border-white/10 rounded-2xl overflow-hidden"
        >
          <iframe id="receiptFrame" class="w-full h-full border-0"></iframe>
          <button
            id="closeReceiptModal"
            class="absolute top-3 right-3 px-3 py-1.5 rounded-lg bg-red-500 text-white"
          >
            Close
          </button>
        </div>
      </div>
    </main>

    <script>
      /*************************************************************************
       * Parent Dashboard (UI-upgraded, logic-compatible)
       *************************************************************************/
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
        measurementId: "G-4HKX7KN6Q3",
      };

      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const allowedYearStrings = SOMAP_ALLOWED_YEARS.map(String);
      const MIN_DATA_YEAR = SOMAP_ALLOWED_YEARS.length
        ? Math.min(...SOMAP_ALLOWED_YEARS)
        : 2023;
      const EARLIEST_CARRY_FORWARD_YEAR = 2025;
      const normalizeYear = (value) => {
        const str = String(value || SOMAP_DEFAULT_YEAR);
        return allowedYearStrings.includes(str)
          ? str
          : String(SOMAP_DEFAULT_YEAR);
      };
      const yearContext = window.somapYearContext || null;
      let activeYear = normalizeYear(
        yearContext?.getSelectedYear?.() ?? SOMAP_DEFAULT_YEAR
      );
      if (yearContext?.setSelectedYear) {
        yearContext.setSelectedYear(activeYear);
      }
      const db = (window.db = firebase.database());
      const currentSchool = window.SOMAP && SOMAP.getSchool();
      if (!currentSchool || !currentSchool.id) {
        window.location.href = "somapappv1multischool/multischool.html";
      }
      window.currentSchoolId = currentSchool?.id;
      const parentSchoolLabel = document.getElementById("parentSchoolLabel");
      if (parentSchoolLabel) {
        parentSchoolLabel.textContent =
          currentSchool.name ||
          currentSchool.code ||
          currentSchool.id ||
          "School";
      }

      function schoolRef(subPath) {
        return db.ref(SOMAP.P(subPath));
      }

      // Helpers
      const q = (s) => document.querySelector(s);
      const qa = (s) => Array.from(document.querySelectorAll(s));
      const safe = (s) => (s == null ? "" : String(s));
      const escapeHtml = (value) =>
        safe(value).replace(
          /[&<>"']/g,
          (ch) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[ch] || ch)
        );
      const fmtTsh = (n) => "TSh " + (Number(n) || 0).toLocaleString();
      const sanitizeKey = (s) => safe(s).replace(/[.#$/\[\]]/g, "_");
      const isGraduationClass = (cls) => {
        const c = safe(cls).toLowerCase();
        return (
          c.includes("preunit") ||
          c.includes("pre-unit") ||
          c.includes("class 7") ||
          c.includes("std 7") ||
          c.includes("grade 7")
        );
      };
      function generateReferralCode(phone) {
        const clean = phone.replace(/\D/g, "").slice(-6);
        return (
          "SOMAP-" +
          clean +
          "-" +
          Math.random().toString(36).slice(2, 6).toUpperCase()
        );
      }

      async function ensureParentReferralCode() {
        const codeEl = document.getElementById("parentReferralCode");
        const linkEl = document.getElementById("parentReferralLink");
        const copyBtn = document.getElementById("copyReferralBtn");

        const parentPhone = normalizePhone(
          currentStudent?.primaryParentContact ||
            localStorage.getItem("parentPhone")
        );

        if (!parentPhone) return;

        const snap = await schoolRef("parents")
          .orderByChild("phone")
          .equalTo(parentPhone)
          .once("value");

        let parentKey, parent;

        if (snap.exists()) {
          parentKey = Object.keys(snap.val())[0];
          parent = snap.val()[parentKey];
        } else {
          parentKey = schoolRef("parents").push().key;
          parent = { phone: parentPhone, createdAt: Date.now() };
          await schoolRef(`parents/${parentKey}`).set(parent);
        }

        if (!parent.referralCode) {
          parent.referralCode = generateReferralCode(parentPhone);
          await schoolRef(`parents/${parentKey}`).update({
            referralCode: parent.referralCode,
          });
        }

        if (codeEl) codeEl.textContent = parent.referralCode;

        const joinUrl =
          location.origin +
          "/join.html?ref=" +
          encodeURIComponent(parent.referralCode);

        if (linkEl) linkEl.value = joinUrl;

        if (copyBtn) {
          copyBtn.onclick = async () => {
            await navigator.clipboard.writeText(joinUrl);
            Swal.fire("Copied", "Referral link copied", "success");
          };
        }
        const whatsappBtn = document.getElementById("shareWhatsappBtn");

        if (whatsappBtn) {
          whatsappBtn.onclick = () => {
            const message = `Hello! Use my SoMAp referral code:\n\n${parent.referralCode}\n\nOr join directly using this link:\n${joinUrl}`;

            const waUrl = "https://wa.me/?text=" + encodeURIComponent(message);

            window.open(waUrl, "_blank");
          };
        }
      }

      // Refs
      const studentNameEl = q("#studentName");
      const studentMetaEl = q("#studentMeta");
      const studentGradBadge = q("#studentGradBadge");
      const statFeeDue = q("#statFeeDue");
      const statPaid = q("#statPaid");
      const statBalance = q("#statBalance");
      const statAttendancePct = q("#statAttendancePct");
      const statPaymentPlan = q("#statPaymentPlan");

      const paymentsList = q("#paymentsList");
      const parentBooksCard = q("#parentBooksCard");
      const parentBooksList = q("#parentBooksList");
      const parentBooksYear = q("#parentBooksYear");
      const parentBooksClass = q("#parentBooksClass");
      const parentBooksEmpty = q("#parentBooksEmpty");
      const parentBooksReload = q("#parentBooksReload");
      const openBooksFullBtn = q("#openBooksFull");
      const scoresTbody = q("#scoresTbody");
      const scoresChartCanvas = q("#scoresChart");
      const attendanceChartCanvas = q("#attendanceChart");

      const exportCsvBtn = q("#exportCsvBtn");
      const exportPdfBtn = q("#exportPdfBtn");
      const genReportBtn = q("#genReportBtn");

      const detailClass = q("#detailClass");
      const detailStream = q("#detailStream");
      const detailAdm = q("#detailAdm");
      const detailParentPhone = q("#detailParentPhone");
      const graduationCardEl = q("#graduationCard");
      const gradStatusEl = q("#gradStatus");
      const gradYearLabel = q("#gradYearLabel");
      const gradExpectedEl = q("#gradExpected");
      const gradPaidEl = q("#gradPaid");
      const gradBalanceEl = q("#gradBalance");
      const gradCertMessageEl = q("#gradCertificateMessage");
      const gradCertActionsEl = q("#gradCertificateActions");
      const gradGalleryCard = q("#graduationGalleryCard");
      const gradGalleryList = q("#gradGalleryList");
      const openGalleryFull = q("#openGalleryFull");

      const quickGenerateId = q("#quickGenerateId");
      const quickReportCard = q("#quickReportCard");
      const quickFees = q("#quickFees");
      const quickTransport = q("#quickTransport");
      const openMarketTop = q("#openMarketTop");
      const viewMarketSmall = q("#viewMarketSmall");

      // NEW: Receipt stat refs
      const statReceiptCount = q("#statReceiptCount");
      const statReceiptMeta = q("#statReceiptMeta");

      // Sidebar actions
      qa(".icon").forEach((el) =>
        el.addEventListener("click", (ev) =>
          handleAction(ev.currentTarget.dataset.action)
        )
      );
      q("#icon-logout").addEventListener("click", () => {
        localStorage.removeItem("studentKey");
        localStorage.removeItem("role");
        window.location.href = "index.html";
      });

      // Finance icon - opens finance.html with parent scope
      q("#parentFinanceIcon")?.addEventListener("click", () => {
        if (!currentStudent) {
          Swal.fire(
            "Error",
            "Student data not loaded. Please sign in again.",
            "error"
          );
          return;
        }
        const studentId = currentStudentKey;
        const admissionNo =
          currentStudent.admissionNumber || currentStudent.pupilId || "";
        const academicYear = getActiveYearString();
        const className = currentStudent.classLevel || "";

        let url = "finance.html?scope=parent";
        if (studentId) {
          url += `&student=${encodeURIComponent(studentId)}`;
        } else if (admissionNo) {
          url += `&adm=${encodeURIComponent(
            admissionNo
          )}&year=${encodeURIComponent(
            academicYear
          )}&class=${encodeURIComponent(className)}`;
        }

        // Store context in sessionStorage
        try {
          sessionStorage.setItem("parent_scope", "1");
          if (studentId) sessionStorage.setItem("parent_student", studentId);
          if (admissionNo) sessionStorage.setItem("parent_adm", admissionNo);
          if (academicYear) sessionStorage.setItem("parent_year", academicYear);
          if (className) sessionStorage.setItem("parent_class", className);
        } catch (_) {}

        window.location.href = url;
      });

      // Transport icon - show transport section or open transport payments
      q("#parentTransportIcon")?.addEventListener("click", async () => {
        await loadParentTransportHome();
        await refreshParentBooksPanel();
        // Scroll to transport section
        q("#parentTransportSection")?.scrollIntoView({ behavior: "smooth" });
      });

      // Load parent transport home - OPTIMIZED for speed
      async function loadParentTransportHome() {
        const transportSection = q("#parentTransportSection");
        const childrenList = q("#transportChildrenList");
        if (!transportSection || !childrenList) return;

        transportSection.classList.remove("hidden");
        childrenList.innerHTML = '<div class="skeleton h-16 rounded-xl"></div>';

        try {
          const year = getActiveYearString();

          // Get parent phone - use current student's data if available
          const user = firebase.auth().currentUser;
          let parentPhone = normalizePhone(
            user?.phoneNumber || localStorage.getItem("parentPhone") || ""
          );

          // If no phone yet, use currentStudent's parent contact
          if (!parentPhone && currentStudent) {
            parentPhone = normalizePhone(
              currentStudent.primaryParentContact || ""
            );
          }

          if (!parentPhone && !currentStudent) {
            childrenList.innerHTML =
              '<div class="muted text-sm">Please sign in to view transport information.</div>';
            return;
          }

          // For parent with current student, just check if current student uses transport
          if (currentStudent && currentStudentKey) {
            const currentStudentId = currentStudentKey;

            const transportCtx = await resolveTransportEnrollmentForStudent(
              year,
              currentStudentId,
              currentStudent
            );
            const enrollment = transportCtx?.enrollment;
            const transportStudentId = transportCtx?.studentId || currentStudentId;

            if (enrollment) {
              const fullName = `${currentStudent.firstName || ""} ${
                currentStudent.middleName || ""
              } ${currentStudent.lastName || ""}`
                .replace(/\s+/g, " ")
                .trim();
              const adm = currentStudent.admissionNumber || currentStudentId;
              const route = enrollment.route || enrollment.amStop || "—";
              const morningStop = enrollment.amStop || "—";
              const eveningStop = enrollment.pmStop || "—";
              const stopDisplay =
                morningStop !== "—" &&
                eveningStop !== "—" &&
                morningStop !== eveningStop
                  ? `${morningStop} / ${eveningStop}`
                  : morningStop !== "—"
                  ? morningStop
                  : eveningStop;

              childrenList.innerHTML = `
            <div class="glass bg-white/5 border border-white/10 rounded-xl p-4">
              <div class="flex items-center justify-between">
                <div>
                  <div class="title font-bold">${fullName || "—"}</div>
                  <div class="muted text-xs mt-1">Admission: ${adm}</div>
                  <div class="muted text-xs">Route: ${route} • Stop: ${stopDisplay}</div>
                </div>
                <button class="btn" data-student-id="${transportStudentId}" data-student-adm="${adm}">
                  <i class="fas fa-credit-card mr-2"></i>View Payments
                </button>
              </div>
            </div>
          `;

              // Attach click handler
              const btn = childrenList.querySelector("button[data-student-id]");
              if (btn) {
                btn.addEventListener("click", () => {
                  localStorage.setItem("parentFocusStudent", transportStudentId);
                  localStorage.setItem("parentFocusAdm", adm);
                  const schoolKey =
                    currentStudent.schoolId ||
                    currentStudent.school ||
                    localStorage.getItem("somap_school") ||
                    "socrates-school";
                  if (schoolKey)
                    localStorage.setItem("somap_school", schoolKey);
                  const schoolParam = encodeURIComponent(schoolKey);
                  window.location.href = `transporthtml/transportpayments.html?studentKey=${encodeURIComponent(
                    transportStudentId
                  )}&year=${year}&school=${schoolParam}`;
                });
              }
            } else {
              const adm = currentStudent.admissionNumber || currentStudentId;
              const schoolKey =
                currentStudent.schoolId ||
                currentStudent.school ||
                localStorage.getItem("somap_school") ||
                "socrates-school";
              const schoolParam = encodeURIComponent(schoolKey);
              childrenList.innerHTML = `
            <div class="glass bg-white/5 border border-white/10 rounded-xl p-4">
              <div class="flex items-center justify-between">
                <div>
                  <div class="title font-bold">${
                    `${currentStudent.firstName || ""} ${currentStudent.middleName || ""} ${currentStudent.lastName || ""}`
                      .replace(/\s+/g, " ")
                      .trim() || "—"
                  }</div>
                  <div class="muted text-xs mt-1">Admission: ${adm}</div>
                  <div class="muted text-xs">Transport enrollment could not be auto-confirmed from this dashboard. Open transport payments to view the current record.</div>
                </div>
                <button class="btn" data-open-transport-fallback="1" data-student-id="${currentStudentId}" data-student-adm="${adm}">
                  <i class="fas fa-credit-card mr-2"></i>Open Transport Payments
                </button>
              </div>
            </div>
          `;
              const fallbackBtn = childrenList.querySelector(
                "button[data-open-transport-fallback='1']"
              );
              if (fallbackBtn) {
                fallbackBtn.addEventListener("click", () => {
                  localStorage.setItem("parentFocusStudent", currentStudentId);
                  localStorage.setItem("parentFocusAdm", adm);
                  if (schoolKey) localStorage.setItem("somap_school", schoolKey);
                  window.location.href = `transporthtml/transportpayments.html?studentKey=${encodeURIComponent(
                    currentStudentId
                  )}&student=${encodeURIComponent(adm)}&year=${year}&school=${schoolParam}`;
                });
              }
            }
            return;
          }

          // Multi-child scenario (fallback to original logic but optimized)
          // This would only happen if parent has multiple children and not logged in via a specific student
          childrenList.innerHTML =
            '<div class="muted text-sm">Please sign in through your child\'s account.</div>';
        } catch (error) {
          console.error("Error loading transport:", error);
          childrenList.innerHTML =
            '<div class="text-red-300 text-sm">Error loading transport information. Please try again.</div>';
        }
      }

      // Helper to normalize phone
      function normalizePhone(p) {
        const s = String(p || "").replace(/[\s\-()]/g, "");
        return s.replace(/(?!^\+)[^\d]/g, "");
      }

      function normalizeIdentifier(value) {
        return String(value || "")
          .trim()
          .toUpperCase()
          .replace(/[^A-Z0-9]/g, "");
      }

      function isLegacyMergeSchool(extraHints = {}) {
        const id = String(currentSchool?.id || "").toLowerCase().trim();
        const name = String(
          currentSchool?.name || currentSchool?.code || ""
        ).toLowerCase().trim();
        const storedSchool = String(
          localStorage.getItem("somap_school") ||
            sessionStorage.getItem("somap_school") ||
            ""
        ).toLowerCase().trim();
        const hint = String(
          extraHints?.schoolName || extraHints?.schoolId || ""
        ).toLowerCase().trim();

        const looksLikeSocrates =
          id === "socrates-school" ||
          id === "default" ||
          id.includes("socrates") ||
          name.includes("socrates") ||
          storedSchool.includes("socrates") ||
          hint.includes("socrates");

        return looksLikeSocrates;
      }

      function normalizeNameForMatch(value) {
        return String(value || "")
          .toLowerCase()
          .replace(/[^a-z0-9]/g, " ")
          .replace(/\s+/g, " ")
          .trim();
      }

      function normalizePhoneForMatch(value) {
        return String(value || "").replace(/\D/g, "");
      }

      async function loadTransportMapsForYear(year, legacyAllowed = isLegacyMergeSchool()) {
        const y = String(year || getActiveYearString());
        const [
          enrollScopedSnap,
          registryScopedSnap,
          assignmentsScopedSnap,
          enrollRootYearSnap,
          registryRootYearSnap,
          assignmentsRootYearSnap,
        ] =
          await Promise.all([
            schoolRef(`years/${y}/transportEnrollments`)
              .once("value")
              .catch(() => ({ val: () => ({}) })),
            schoolRef(`years/${y}/transportRegistry`)
              .once("value")
              .catch(() => ({ val: () => ({}) })),
            schoolRef(`years/${y}/transportAssignments`)
              .once("value")
              .catch(() => ({ val: () => ({}) })),
            legacyAllowed
              ? db
                  .ref(`years/${y}/transportEnrollments`)
                  .once("value")
                  .catch(() => ({ val: () => ({}) }))
              : Promise.resolve({ val: () => ({}) }),
            legacyAllowed
              ? db
                  .ref(`years/${y}/transportRegistry`)
                  .once("value")
                  .catch(() => ({ val: () => ({}) }))
              : Promise.resolve({ val: () => ({}) }),
            legacyAllowed
              ? db
                  .ref(`years/${y}/transportAssignments`)
                  .once("value")
                  .catch(() => ({ val: () => ({}) }))
              : Promise.resolve({ val: () => ({}) }),
          ]);

        let enrollLegacy = {};
        let registryLegacy = {};
        let assignmentsLegacy = {};
        if (legacyAllowed) {
          const [enrollLegacySnap, registryLegacySnap, assignmentsLegacySnap] =
            await Promise.all([
              db.ref("transport_enrollments")
                .once("value")
                .catch(() => ({ val: () => ({}) })),
              db.ref(`transportRegistry/${y}`)
                .once("value")
                .catch(() => ({ val: () => ({}) })),
              db.ref(`transportAssignments/${y}`)
                .once("value")
                .catch(() => ({ val: () => ({}) })),
            ]);
          enrollLegacy = enrollLegacySnap.val() || {};
          registryLegacy = registryLegacySnap.val() || {};
          assignmentsLegacy = assignmentsLegacySnap.val() || {};
        }

        return {
          enrollments: {
            ...(enrollRootYearSnap.val() || {}),
            ...enrollLegacy,
            ...(enrollScopedSnap.val() || {}),
          },
          registry: {
            ...(registryRootYearSnap.val() || {}),
            ...registryLegacy,
            ...(registryScopedSnap.val() || {}),
          },
          assignments: {
            ...(assignmentsRootYearSnap.val() || {}),
            ...assignmentsLegacy,
            ...(assignmentsScopedSnap.val() || {}),
          },
        };
      }

      function pickMatchingRecord(
        records,
        preferredStudentId,
        admissionNorm,
        options = {}
      ) {
        const entries = Object.entries(records || {});
        if (!entries.length) return { key: null, record: null };
        const preferredNorm = normalizeIdentifier(preferredStudentId);
        const preferredNameNorm = normalizeNameForMatch(options.fullName || "");
        const preferredPhone = normalizePhoneForMatch(options.parentPhone || "");

        for (const [key, record] of entries) {
          if (normalizeIdentifier(key) === preferredNorm) return { key, record };
        }
        if (admissionNorm) {
          for (const [key, record] of entries) {
            if (normalizeIdentifier(key) === admissionNorm) return { key, record };
          }
        }
        if (!admissionNorm) return { key: null, record: null };
        for (const [key, record] of entries) {
          if (!record || typeof record !== "object") continue;
          const candidates = [
            record.admissionNo,
            record.admissionNumber,
            record.studentAdm,
            record.studentId,
            record.admission,
          ];
          if (
            candidates.some(
              (candidate) => normalizeIdentifier(candidate) === admissionNorm
            )
          ) {
            return { key, record };
          }
        }

        if (preferredNameNorm || preferredPhone) {
          let bestName = null;
          let bestPhone = null;
          for (const [key, record] of entries) {
            if (!record || typeof record !== "object") continue;
            const recName = normalizeNameForMatch(
              record.fullName ||
                record.studentName ||
                `${record.firstName || ""} ${record.middleName || ""} ${record.lastName || ""}`
            );
            const recPhone = normalizePhoneForMatch(
              record.parentContact ||
                record.primaryParentContact ||
                record.parentPhone ||
                record.guardianPhone ||
                ""
            );
            const simpleTokens = (s) =>
              String(s || "")
                .toLowerCase()
                .replace(/[^a-z0-9]/g, " ")
                .split(/\s+/)
                .filter(Boolean);
            const preferTokens = simpleTokens(options.fullName || "");
            const recTokens = simpleTokens(
              record.fullName ||
                record.studentName ||
                `${record.firstName || ""} ${record.middleName || ""} ${record.lastName || ""}`
            );

            const firstLastMatch = (() => {
              if (preferTokens.length < 2 || recTokens.length < 2) return false;
              const pFirst = preferTokens[0];
              const pLast = preferTokens[preferTokens.length - 1];
              const rFirst = recTokens[0];
              const rLast = recTokens[recTokens.length - 1];
              return pFirst === rFirst && pLast === rLast;
            })();

            const containsMatch = (() => {
              const p = preferTokens.join(" ");
              const r = recTokens.join(" ");
              return p && r && (r.includes(p) || p.includes(r));
            })();

            const nameMatch =
              preferredNameNorm &&
              (recName === preferredNameNorm || firstLastMatch || containsMatch);
            const phoneMatch =
              preferredPhone &&
              recPhone &&
              (recPhone.endsWith(preferredPhone.slice(-7)) ||
                preferredPhone.endsWith(recPhone.slice(-7)));
            if (nameMatch && phoneMatch) {
              return { key, record };
            }
            if (!bestName && nameMatch) bestName = { key, record };
            if (!bestPhone && phoneMatch) bestPhone = { key, record };
          }
          if (bestName) return bestName;
          if (bestPhone) return bestPhone;
        }

        return { key: null, record: null };
      }

      function pickRecordByCandidateNorms(records, candidateNorms) {
        const norms = new Set(
          (candidateNorms || []).map((v) => normalizeIdentifier(v)).filter(Boolean)
        );
        if (!norms.size) return { key: null, record: null };
        const entries = Object.entries(records || {});
        for (const [key, record] of entries) {
          if (norms.has(normalizeIdentifier(key))) return { key, record };
        }
        for (const [key, record] of entries) {
          if (!record || typeof record !== "object") continue;
          const candidates = [
            record.admissionNo,
            record.admissionNumber,
            record.studentAdm,
            record.studentId,
            record.admission,
            record.id,
          ];
          if (candidates.some((c) => norms.has(normalizeIdentifier(c)))) {
            return { key, record };
          }
        }
        return { key: null, record: null };
      }

      async function resolveTransportEnrollmentForStudent(
        year,
        studentId,
        studentRecord
      ) {
        const y = String(year || getActiveYearString());
        const legacyOk = isLegacyMergeSchool({
          schoolName: studentRecord?.schoolName,
          schoolId: studentRecord?.schoolId || studentRecord?.school,
        });
        const admissionKey =
          String(studentRecord?.admissionNumber || studentRecord?.pupilId || "").trim();
        const admissionNorm = normalizeIdentifier(
          admissionKey
        );

        const fullName = `${studentRecord?.firstName || ""} ${
          studentRecord?.middleName || ""
        } ${studentRecord?.lastName || ""}`.replace(/\s+/g, " ").trim();
        const parentPhone =
          studentRecord?.primaryParentContact ||
          studentRecord?.parentPhone ||
          studentRecord?.motherPhone ||
          "";
        const { assignments, enrollments, registry } =
          await loadTransportMapsForYear(y, legacyOk);

        const matchOptions = { fullName, parentPhone };
        let assignMatch = pickMatchingRecord(
          assignments,
          studentId,
          admissionNorm,
          matchOptions
        );
        let enrollMatch = pickMatchingRecord(
          enrollments,
          studentId,
          admissionNorm,
          matchOptions
        );
        let registryMatch = pickMatchingRecord(
          registry,
          studentId,
          admissionNorm,
          matchOptions
        );

        // If initial school-context detection missed legacy mode, force one retry against legacy+scoped merged maps.
        if (!legacyOk && !assignMatch.record && !enrollMatch.record && !registryMatch.record) {
          const retryMaps = await loadTransportMapsForYear(y, true);
          assignMatch = pickMatchingRecord(
            retryMaps.assignments,
            studentId,
            admissionNorm,
            matchOptions
          );
          enrollMatch = pickMatchingRecord(
            retryMaps.enrollments,
            studentId,
            admissionNorm,
            matchOptions
          );
          registryMatch = pickMatchingRecord(
            retryMaps.registry,
            studentId,
            admissionNorm,
            matchOptions
          );
        }

        // Align with transportpayments alias resolution:
        // resolve student key via students map, then rematch transport maps using key aliases.
        if (!assignMatch.record && !enrollMatch.record && !registryMatch.record) {
          let allStudents = {};
          try {
            const [scopedStudentsSnap, rootStudentsSnap] = await Promise.all([
              schoolRef("students").once("value").catch(() => ({ val: () => ({}) })),
              db.ref("students").once("value").catch(() => ({ val: () => ({}) })),
            ]);
            const scopedStudents = scopedStudentsSnap.val() || {};
            const rootStudents = rootStudentsSnap.val() || {};
            allStudents = { ...rootStudents, ...scopedStudents };
          } catch (_) {
            allStudents = {};
          }

          let resolvedStudentKey = null;
          if (admissionNorm || studentId) {
            const idNorm = normalizeIdentifier(studentId);
            for (const [k, rec] of Object.entries(allStudents || {})) {
              if (!rec || typeof rec !== "object") continue;
              const candidates = [
                k,
                rec.admissionNumber,
                rec.admissionNo,
                rec.studentAdm,
                rec.admission,
                rec.studentId,
              ];
              if (
                candidates.some((v) => {
                  const n = normalizeIdentifier(v);
                  return (admissionNorm && n === admissionNorm) || (idNorm && n === idNorm);
                })
              ) {
                resolvedStudentKey = k;
                break;
              }
            }
          }

          const candidateNorms = [
            studentId,
            admissionKey,
            resolvedStudentKey,
            studentRecord?.studentId,
            studentRecord?.id,
            studentRecord?.admissionNo,
            studentRecord?.admission,
          ];

          if (resolvedStudentKey && allStudents[resolvedStudentKey]) {
            const resolvedRec = allStudents[resolvedStudentKey];
            candidateNorms.push(
              resolvedRec.admissionNumber,
              resolvedRec.admissionNo,
              resolvedRec.studentAdm,
              resolvedRec.admission,
              resolvedRec.studentId
            );
          }

          const aliasAssign = pickRecordByCandidateNorms(assignments, candidateNorms);
          const aliasEnroll = pickRecordByCandidateNorms(enrollments, candidateNorms);
          const aliasRegistry = pickRecordByCandidateNorms(registry, candidateNorms);
          if (aliasAssign.record || aliasEnroll.record || aliasRegistry.record) {
            assignMatch = aliasAssign.record ? aliasAssign : assignMatch;
            enrollMatch = aliasEnroll.record ? aliasEnroll : enrollMatch;
            registryMatch = aliasRegistry.record ? aliasRegistry : registryMatch;
          }
        }

        let resolvedStudentId =
          assignMatch.key || enrollMatch.key || registryMatch.key || studentId;
        let assign = assignMatch.record || null;
        let enroll = enrollMatch.record || null;
        let reg = registryMatch.record || null;

        // Hard fallback: direct admission-key reads (AUTO-...) for mixed key systems.
        if ((!assign || !enroll || !reg) && admissionKey) {
          const [
            assignDirectScoped,
            enrollDirectScoped,
            regDirectScoped,
            assignDirectRootYear,
            enrollDirectRootYear,
            regDirectRootYear,
            assignDirectLegacy,
            enrollDirectLegacy,
            regDirectLegacy,
          ] = await Promise.all([
            schoolRef(`years/${y}/transportAssignments/${admissionKey}`)
              .once("value")
              .catch(() => ({ val: () => null })),
            schoolRef(`years/${y}/transportEnrollments/${admissionKey}`)
              .once("value")
              .catch(() => ({ val: () => null })),
            schoolRef(`years/${y}/transportRegistry/${admissionKey}`)
              .once("value")
              .catch(() => ({ val: () => null })),
            db
              .ref(`years/${y}/transportAssignments/${admissionKey}`)
              .once("value")
              .catch(() => ({ val: () => null })),
            db
              .ref(`years/${y}/transportEnrollments/${admissionKey}`)
              .once("value")
              .catch(() => ({ val: () => null })),
            db
              .ref(`years/${y}/transportRegistry/${admissionKey}`)
              .once("value")
              .catch(() => ({ val: () => null })),
            db
              .ref(`transportAssignments/${y}/${admissionKey}`)
              .once("value")
              .catch(() => ({ val: () => null })),
            db
              .ref(`transport_enrollments/${admissionKey}`)
              .once("value")
              .catch(() => ({ val: () => null })),
            db
              .ref(`transportRegistry/${y}/${admissionKey}`)
              .once("value")
              .catch(() => ({ val: () => null })),
          ]);
          assign =
            assign ||
            assignDirectScoped.val() ||
            assignDirectRootYear.val() ||
            assignDirectLegacy.val() ||
            null;
          enroll =
            enroll ||
            enrollDirectScoped.val() ||
            enrollDirectRootYear.val() ||
            enrollDirectLegacy.val() ||
            null;
          reg =
            reg ||
            regDirectScoped.val() ||
            regDirectRootYear.val() ||
            regDirectLegacy.val() ||
            null;
          if ((assign || enroll || reg) && admissionKey) {
            resolvedStudentId = admissionKey;
          }
        }

        const assignmentStatus = String(assign?.status || "").toLowerCase().trim();
        const assignmentHasExplicitStatus = Boolean(assignmentStatus);
        const assignmentExplicitlyInactive = [
          "not_using",
          "not using",
          "inactive",
          "stopped",
          "disabled",
          "cancelled",
          "canceled",
          "off",
        ].includes(assignmentStatus);

        if (
          assign &&
          assignmentHasExplicitStatus &&
          assignmentStatus !== "using" &&
          admissionKey
        ) {
          try {
            const [admissionAssignSnap, admissionAssignRootSnap] = await Promise.all([
              schoolRef(`years/${y}/transportAssignments/${admissionKey}`)
                .once("value")
                .catch(() => ({ val: () => null })),
              db
                .ref(`years/${y}/transportAssignments/${admissionKey}`)
                .once("value")
                .catch(() => ({ val: () => null })),
            ]);
            const admissionAssignScoped = admissionAssignSnap.val();
            const admissionAssignRoot = admissionAssignRootSnap.val();
            let admissionAssignLegacy = null;
            if (!admissionAssignScoped && legacyOk) {
              const s = await db
                .ref(`transportAssignments/${y}/${admissionKey}`)
                .once("value")
                .catch(() => ({ val: () => null }));
              admissionAssignLegacy = s.val();
            }
            const admissionAssign =
              admissionAssignScoped || admissionAssignRoot || admissionAssignLegacy || null;
            if (admissionAssign && String(admissionAssign.status || "").toLowerCase() === "using") {
              assign = admissionAssign;
              resolvedStudentId = admissionKey;
            } else {
              const registrySignalsUsing = reg && reg.using === true;
              const enrollmentSignalsUsing = !!enroll;
              if (
                assignmentExplicitlyInactive &&
                !registrySignalsUsing &&
                !enrollmentSignalsUsing
              ) {
                return { studentId: resolvedStudentId, enrollment: null };
              }
            }
          } catch (_) {
            const registrySignalsUsing = reg && reg.using === true;
            const enrollmentSignalsUsing = !!enroll;
            if (
              assignmentExplicitlyInactive &&
              !registrySignalsUsing &&
              !enrollmentSignalsUsing
            ) {
              return { studentId: resolvedStudentId, enrollment: null };
            }
          }
        } else if (
          assign &&
          assignmentHasExplicitStatus &&
          assignmentStatus !== "using"
        ) {
          const registrySignalsUsing = reg && reg.using === true;
          const enrollmentSignalsUsing = !!enroll;
          if (
            assignmentExplicitlyInactive &&
            !registrySignalsUsing &&
            !enrollmentSignalsUsing
          ) {
            return { studentId: resolvedStudentId, enrollment: null };
          }
        }

        // Last-resort key probe: check common key variants across scoped/root/legacy nodes.
        // This covers cases where enrollment exists but lives under a different student key shape.
        if (!assign && !enroll && !reg) {
          const probeIds = Array.from(
            new Set(
              [studentId, resolvedStudentId, admissionKey]
                .map((v) => String(v || "").trim())
                .filter(Boolean)
            )
          );
          if (probeIds.length) {
            const probes = [];
            for (const id of probeIds) {
              probes.push(
                schoolRef(`years/${y}/transportAssignments/${id}`)
                  .once("value")
                  .catch(() => ({ val: () => null })),
                schoolRef(`years/${y}/transportEnrollments/${id}`)
                  .once("value")
                  .catch(() => ({ val: () => null })),
                schoolRef(`years/${y}/transportRegistry/${id}`)
                  .once("value")
                  .catch(() => ({ val: () => null })),
                db.ref(`years/${y}/transportAssignments/${id}`)
                  .once("value")
                  .catch(() => ({ val: () => null })),
                db.ref(`years/${y}/transportEnrollments/${id}`)
                  .once("value")
                  .catch(() => ({ val: () => null })),
                db.ref(`years/${y}/transportRegistry/${id}`)
                  .once("value")
                  .catch(() => ({ val: () => null })),
                db.ref(`transportAssignments/${y}/${id}`)
                  .once("value")
                  .catch(() => ({ val: () => null })),
                db.ref(`transportRegistry/${y}/${id}`)
                  .once("value")
                  .catch(() => ({ val: () => null })),
                db.ref(`transport_enrollments/${id}`)
                  .once("value")
                  .catch(() => ({ val: () => null }))
              );
            }
            const probeSnaps = await Promise.all(probes);
            for (const snap of probeSnaps) {
              const value = snap?.val ? snap.val() : null;
              if (!value || typeof value !== "object") continue;
              const hasAssignSignals = !!(
                value.amStop ||
                value.pmStop ||
                value.morningRouteId ||
                value.eveningRouteId ||
                value.baseMonthlyFee ||
                String(value.status || "").toLowerCase().trim() === "using"
              );
              const hasRegSignals = !!(
                value.routeId ||
                value.stopName ||
                value.monthlyFee ||
                value.amStop ||
                value.pmStop ||
                value.using === true ||
                String(value.status || "").toLowerCase().trim() === "using"
              );
              if (!assign && hasAssignSignals) assign = value;
              if (!reg && hasRegSignals) reg = value;
              if (!enroll) enroll = value;
            }
            if ((assign || enroll || reg) && admissionKey) {
              resolvedStudentId = admissionKey;
            }
          }
        }

        const usingByAssignment =
          !!assign &&
          (
            assignmentStatus === "using" ||
            (!assignmentHasExplicitStatus &&
              !!(
                assign.amStop ||
                assign.pmStop ||
                assign.morningRouteId ||
                assign.eveningRouteId ||
                assign.baseMonthlyFee
              ))
          );
        const usingByRegistry =
          !!reg &&
          (
            reg.using === true ||
            reg.isUsing === true ||
            reg.active === true ||
            String(reg.status || "").toLowerCase().trim() === "using" ||
            !!(
              reg.routeId ||
              reg.stopName ||
              reg.monthlyFee ||
              reg.amStop ||
              reg.pmStop
            )
          );
        const usingByEnrollment = !!enroll;

        if (!usingByAssignment && !usingByRegistry && !usingByEnrollment) {
          return { studentId: resolvedStudentId, enrollment: null };
        }

        const merged = {
          ...(enroll && typeof enroll === "object" ? enroll : {}),
        };
        if (usingByRegistry) {
          merged.amStop = merged.amStop || reg.routeId || "";
          merged.pmStop = merged.pmStop || reg.stopName || "";
          merged.monthlyFee = merged.monthlyFee || reg.monthlyFee || 0;
        }
        if (usingByAssignment) {
          merged.startDate = assign.startDate || merged.startDate;
          merged.baseMonthlyFee = assign.baseMonthlyFee || merged.baseMonthlyFee;
          merged.amStop =
            merged.amStop || assign.amStop || assign.morningRouteId || "";
          merged.pmStop =
            merged.pmStop || assign.pmStop || assign.eveningRouteId || "";
          merged.status = "Using";
        }
        return { studentId: resolvedStudentId, enrollment: merged };
      }

      // State
      let currentStudentKey = null,
        currentStudent = null;
      let graduationGalleryLoaded = false;
      let graduationGalleryYear = null;
      let scoresChart = null,
        attendanceChart = null;
      let __allPaymentsSum = 0;
      let latestFinanceSnapshot = null;
      let latestYearHasFinanceRecord = false;
      const firstActiveYearCache = new Map();
      const yearRecordExistenceCache = new Map();
      const parentBooksClassCache = new Map();
      let parentYearDataCache = null;
      let parentYearDataKey = null;
      let latestBooksSnapshot = { year: null, className: null, items: [] };
      const getActiveYearString = () => activeYear;
      const getActiveYearNumber = () => Number(getActiveYearString());
      function requireStudentKey() {
        if (!currentStudentKey) {
          console.warn("Student key missing — aborting fetch");
          return false;
        }
        return true;
      }
      function updateYearBadge() {
        const yearStr = getActiveYearString();
        if (gradYearLabel) gradYearLabel.textContent = yearStr;
        const hint = document.getElementById("somapYearHint");
        if (hint) hint.textContent = yearStr;

        // Also update year selector if it exists
        const yearSelect = document.querySelector("[data-somap-year-select]");
        if (yearSelect && yearSelect.value !== yearStr) {
          yearSelect.value = yearStr;
        }
      }

      function handleYearChange(nextYear) {
        const normalized = normalizeYear(nextYear);
        if (normalized === activeYear) return;
        activeYear = normalized;
        parentBooksClassCache.clear();
        parentYearDataCache = null;
        parentYearDataKey = null;
        updateYearBadge();
        refreshYearDependentData().catch(console.error);
        refreshParentBooksPanel(true).catch(console.error);
      }

      if (yearContext && typeof yearContext.onYearChanged === "function") {
        yearContext.onYearChanged(handleYearChange);
      }

      // Initialize year selector on page load
      (function initYearSelector() {
        const sel = document.querySelector("[data-somap-year-select]");
        const hint = document.getElementById("somapYearHint");
        if (!sel) return;
        sel.innerHTML = SOMAP_ALLOWED_YEARS.map(
          (y) => `<option value="${y}">${y}</option>`
        ).join("");
        const current = getActiveYearString();
        sel.value = current;
        if (hint) hint.textContent = current;
        sel.addEventListener("change", (e) => {
          const normalized = normalizeYear(e.target.value);
          if (sel.value !== normalized) sel.value = normalized;
          if (hint) hint.textContent = normalized;
          if (yearContext?.setSelectedYear) {
            yearContext.setSelectedYear(normalized);
          } else {
            handleYearChange(normalized);
          }
        });
      })();

      function toggleGradBadge(isGraduated, yearStr) {
        if (!studentGradBadge) return;
        if (isGraduated) {
          studentGradBadge.style.display = "inline-flex";
          studentGradBadge.textContent = `Graduated (${yearStr})`;
        } else {
          studentGradBadge.style.display = "none";
        }
      }

      async function resolveCarryForwardDebt(
        studentKey,
        uptoYearStr,
        admissionOverride,
        firstActiveYearOverride = null
      ) {
        const fallback = { amount: 0, sourceYear: null };
        if (!studentKey || !window.SomapFinance) return fallback;
        const financeApi = window.SomapFinance;
        const targetYearNum = Number(uptoYearStr);
        const firstActiveYearNum = Number(firstActiveYearOverride);
        const earliestYear = Math.max(
          MIN_DATA_YEAR,
          EARLIEST_CARRY_FORWARD_YEAR,
          Number.isFinite(firstActiveYearNum) ? firstActiveYearNum : MIN_DATA_YEAR
        );
        if (!Number.isFinite(targetYearNum) || targetYearNum <= earliestYear)
          return fallback;
        const admKey = String(
          admissionOverride || currentStudent?.admissionNumber || ""
        ).trim();
        for (let year = targetYearNum - 1; year >= earliestYear; year--) {
          const yearStr = String(year);
          try {
            let outstanding = 0;
            if (typeof financeApi.getBalanceForYearAdmission === "function") {
              if (admKey) {
                outstanding = await financeApi.getBalanceForYearAdmission(
                  yearStr,
                  admKey
                );
              }
              if (!outstanding) {
                outstanding = await financeApi.getBalanceForYearAdmission(
                  yearStr,
                  studentKey
                );
              }
            } else if (typeof financeApi.loadStudentFinance === "function") {
              const fin = await financeApi.loadStudentFinance(
                yearStr,
                studentKey
              );
              if (!fin) continue;
              const due = Number(fin.due ?? fin.feePerYear ?? 0);
              const paid = Number(fin.paid ?? fin.paidAmount ?? 0);
              outstanding = Math.max(
                0,
                Number.isFinite(due - paid) ? due - paid : 0,
                Number(fin.outstanding ?? 0),
                Number(fin.balance ?? 0),
                Number(fin.record?.balance ?? 0)
              );
            } else {
              continue;
            }
            if (outstanding > 0) {
              return { amount: outstanding, sourceYear: yearStr };
            }
          } catch (err) {
            console.warn("Carry-forward debt lookup failed", {
              studentKey,
              year: yearStr,
              err,
            });
          }
        }
        return fallback;
      }

      function asNumberOrNaN(value) {
        const n = Number(value);
        return Number.isFinite(n) ? n : NaN;
      }

      function extractStudentStartYear(student) {
        if (!student || typeof student !== "object") return null;
        const candidates = [
          student.academicYear,
          student.year,
          student.admissionYear,
          student.startYear,
        ]
          .map(asNumberOrNaN)
          .filter(Number.isFinite);
        const createdTs = asNumberOrNaN(student.createdAt || student.joinedAt);
        if (Number.isFinite(createdTs) && createdTs > 0) {
          const createdYear = new Date(createdTs).getFullYear();
          if (Number.isFinite(createdYear)) candidates.push(createdYear);
        }
        if (!candidates.length) return null;
        return Math.min(...candidates);
      }

      function snapshotHasObjectData(snap) {
        const raw = snap?.val ? snap.val() : null;
        if (!raw) return false;
        if (typeof raw !== "object") return true;
        return Object.keys(raw).length > 0;
      }

      function valueHasPositiveAmount(raw) {
        const amount = Number(
          raw?.amount ??
            raw?.balance ??
            raw?.carry ??
            raw?.total ??
            raw?.value ??
            0
        );
        return Number.isFinite(amount) && amount > 0;
      }

      function objectContainsPositivePayment(raw) {
        if (!raw || typeof raw !== "object") return false;
        const stack = [raw];
        const visited = new Set();
        while (stack.length) {
          const current = stack.pop();
          if (!current || typeof current !== "object") continue;
          if (visited.has(current)) continue;
          visited.add(current);
          const directAmount = Number(
            current.amount ??
              current.amt ??
              current.paid ??
              current.value ??
              current.amountPaid ??
              0
          );
          if (Number.isFinite(directAmount) && directAmount > 0) return true;
          Object.values(current).forEach((child) => {
            if (child && typeof child === "object") stack.push(child);
          });
        }
        return false;
      }

      function hasYearTaggedStudentPayment(raw, yearStr) {
        const target = Number(yearStr);
        if (!raw || typeof raw !== "object" || !Number.isFinite(target))
          return false;
        return Object.values(raw).some((entry) => {
          if (!entry || typeof entry !== "object") return false;
          const directYear = Number(
            entry.academicYear ??
              entry.financeYear ??
              entry.feeYear ??
              entry.year ??
              entry._year ??
              entry.academic_session
          );
          if (Number.isFinite(directYear)) return directYear === target;
          return false;
        });
      }

      async function studentHasActualYearRecord(studentKey, admission, yearStr) {
        const cacheKey = `${studentKey || ""}|${admission || ""}|${yearStr}`;
        if (yearRecordExistenceCache.has(cacheKey)) {
          return yearRecordExistenceCache.get(cacheKey);
        }
        const cleanAdmission = String(admission || "").trim();
        const admissionKey = sanitizeKey(cleanAdmission);
        const paths = [
          `enrollments/${yearStr}/${studentKey}`,
          `financeLedgers/${yearStr}/${studentKey}`,
          cleanAdmission ? `financeLedgers/${yearStr}/${cleanAdmission}` : "",
          admissionKey ? `financeLedgers/${yearStr}/${admissionKey}` : "",
          `financeCarryForward/${yearStr}/${studentKey}`,
          cleanAdmission ? `financeCarryForward/${yearStr}/${cleanAdmission}` : "",
          admissionKey ? `financeCarryForward/${yearStr}/${admissionKey}` : "",
          `studentFees/${yearStr}/${studentKey}`,
          cleanAdmission ? `studentFees/${yearStr}/${cleanAdmission}` : "",
          admissionKey ? `studentFees/${yearStr}/${admissionKey}` : "",
          `students/${studentKey}/payments`,
        ].filter(Boolean);

        const snaps = await Promise.all(
          paths.map((path) =>
            schoolRef(path)
              .once("value")
              .catch(() => null)
          )
        );
        const [
          enrollmentSnap,
          ledgerByStudent,
          ledgerByAdmission,
          ledgerByAdmissionSanitized,
          carryByStudent,
          carryByAdmission,
          carryByAdmissionSanitized,
          feeByStudent,
          feeByAdmission,
          feeByAdmissionSanitized,
          studentPaymentsSnap,
        ] = snaps;

        const hasEnrollment = snapshotHasObjectData(enrollmentSnap);
        const hasLedgerPayments =
          objectContainsPositivePayment(ledgerByStudent?.val?.()) ||
          objectContainsPositivePayment(ledgerByAdmission?.val?.()) ||
          objectContainsPositivePayment(ledgerByAdmissionSanitized?.val?.());
        const hasCarry =
          valueHasPositiveAmount(carryByStudent?.val?.()) ||
          valueHasPositiveAmount(carryByAdmission?.val?.()) ||
          valueHasPositiveAmount(carryByAdmissionSanitized?.val?.());
        const hasStudentFeeConfig =
          snapshotHasObjectData(feeByStudent) ||
          snapshotHasObjectData(feeByAdmission) ||
          snapshotHasObjectData(feeByAdmissionSanitized);
        const hasTaggedStudentPayment = hasYearTaggedStudentPayment(
          studentPaymentsSnap?.val?.(),
          yearStr
        );

        const exists =
          hasEnrollment ||
          hasLedgerPayments ||
          hasCarry ||
          hasStudentFeeConfig ||
          hasTaggedStudentPayment;
        yearRecordExistenceCache.set(cacheKey, exists);
        return exists;
      }

      async function resolveFirstActiveYear(studentKey, admission, student) {
        const cacheKey = `${studentKey || ""}|${admission || ""}`;
        if (firstActiveYearCache.has(cacheKey)) {
          return firstActiveYearCache.get(cacheKey);
        }
        const sortedYears = SOMAP_ALLOWED_YEARS.map(Number)
          .filter(Number.isFinite)
          .sort((a, b) => a - b);
        for (const y of sortedYears) {
          const exists = await studentHasActualYearRecord(
            studentKey,
            admission,
            String(y)
          );
          if (exists) {
            firstActiveYearCache.set(cacheKey, y);
            return y;
          }
        }
        const hinted = extractStudentStartYear(student);
        if (Number.isFinite(hinted)) {
          firstActiveYearCache.set(cacheKey, hinted);
          return hinted;
        }
        const fallback = sortedYears.length ? sortedYears[0] : MIN_DATA_YEAR;
        firstActiveYearCache.set(cacheKey, fallback);
        return fallback;
      }

      function applyNoYearRecordState(yearStr) {
        latestFinanceSnapshot = null;
        latestYearHasFinanceRecord = false;
        statFeeDue.innerHTML = `${fmtTsh(0)}<span style="font-size: 0.65rem; color: var(--muted); display: block; margin-top: 2px;">No record for this year (${safe(
          yearStr
        )}).</span>`;
        statPaid.textContent = fmtTsh(0);
        statBalance.textContent = fmtTsh(0);
        statPaymentPlan.textContent = "-";
        applyFeeBadge(0, 0);
      }

      async function renderFinanceStats() {
        if (!currentStudentKey || !window.SomapFinance) return;
        const yearStr = getActiveYearString();
        const admissionRef =
          currentStudent?.admissionNumber || currentStudent?.pupilId || "";
        try {
          const [firstActiveYear, hasSelectedYearRecord] = await Promise.all([
            resolveFirstActiveYear(currentStudentKey, admissionRef, currentStudent),
            studentHasActualYearRecord(currentStudentKey, admissionRef, yearStr),
          ]);
          if (
            !hasSelectedYearRecord ||
            Number(yearStr) < Number(firstActiveYear || MIN_DATA_YEAR)
          ) {
            applyNoYearRecordState(yearStr);
            return;
          }
          latestYearHasFinanceRecord = true;
          const [fin, carryMeta] = await Promise.all([
            window.SomapFinance.loadStudentFinance(yearStr, currentStudentKey),
            resolveCarryForwardDebt(
              currentStudentKey,
              yearStr,
              admissionRef,
              firstActiveYear
            ),
          ]);
          if (!fin) {
            applyNoYearRecordState(yearStr);
            return;
          }
          latestFinanceSnapshot = fin;

          const currentFee = Number(fin.due || fin.record?.feePerYear || 0);
          const carryAmountFromRecord = Math.max(
            0,
            Number(fin.record?.carryAmount || fin.record?.carry || 0)
          );
          const carryAmountComputed = Math.max(
            0,
            Number(carryMeta.amount || 0)
          );
          const hasRecordedCarry = carryAmountFromRecord > 0;
          let carryForwardDebt = hasRecordedCarry
            ? carryAmountFromRecord
            : carryAmountComputed;
          let totalFeeDue = currentFee;
          if (!hasRecordedCarry && carryForwardDebt > 0) {
            totalFeeDue = currentFee + carryForwardDebt;
          }
          const fallbackPrevYear = (() => {
            const prev = Number(yearStr) - 1;
            if (prev >= EARLIEST_CARRY_FORWARD_YEAR) return String(prev);
            return String(EARLIEST_CARRY_FORWARD_YEAR);
          })();
          const carryYearLabel =
            carryForwardDebt > 0
              ? carryMeta.sourceYear || fallbackPrevYear
              : null;

          // Build debt note in small letters for parent understanding
          let debtNote = "";
          if (carryForwardDebt > 0) {
            if (currentFee === 0) {
              // Only debt, no current year fee
              debtNote = `<span style="font-size: 0.65rem; color: var(--muted); display: block; margin-top: 2px; text-transform: lowercase;">debt carried from ${
                carryYearLabel || "previous year"
              }</span>`;
            } else {
              // Both current fee and debt
              debtNote = `<span style="font-size: 0.65rem; color: var(--muted); display: block; margin-top: 2px; text-transform: lowercase;">includes ${fmtTsh(
                carryForwardDebt
              )} debt carried from ${carryYearLabel || "previous year"}</span>`;
            }
          }

          // Update display with debt note if applicable
          if (debtNote) {
            statFeeDue.innerHTML = fmtTsh(totalFeeDue) + debtNote;
          } else {
            statFeeDue.textContent = fmtTsh(totalFeeDue);
          }

          statPaid.textContent = fmtTsh(fin.paid);

          // Calculate total outstanding
          // Total outstanding = (current fee + previous debt) - payments made this year
          const currentPaid = Number(fin.paid || 0);
          let totalOutstanding = Math.max(0, totalFeeDue - currentPaid);

          statBalance.textContent = fmtTsh(totalOutstanding);

          // Use totalFeeDue (which includes carry-forward debt) for badge calculation
          applyFeeBadge(totalFeeDue, fin.paid);

          const planName =
            fin.record?.paymentPlan ||
            fin.paymentPlan ||
            currentStudent?.paymentPlan ||
            "-";
          statPaymentPlan.textContent = safe(planName);
          const displayClass =
            fin.classLevel ||
            fin.record?.classLevel ||
            currentStudent?.classLevel ||
            "-";
          const classLabel =
            displayClass === "GRADUATED"
              ? `Graduated (${yearStr})`
              : safe(displayClass);
          detailClass.textContent = classLabel;
          toggleGradBadge(
            fin.isGraduated || displayClass === "GRADUATED",
            yearStr
          );
        } catch (err) {
          console.error("Failed to sync finance stats", err);
        }
      }

      async function refreshYearDependentData() {
        if (!currentStudent) return;
        const adm =
          currentStudent.admissionNumber ||
          currentStudent.pupilId ||
          currentStudentKey;
        const classLevel = currentStudent.classLevel || "";
        await renderFinanceStats();
        await loadPaymentsAllSources(
          currentStudentKey,
          adm,
          classLevel,
          getActiveYearString()
        );
        await loadGraduationSummary(adm, classLevel, getActiveYearString());
        updateYearBadge();
      }

      function setParentBooksSkeleton() {
        if (!parentBooksList) return;
        parentBooksList.innerHTML = `
      <div class="skeleton h-4 rounded-xl"></div>
      <div class="skeleton h-4 rounded-xl"></div>
      <div class="skeleton h-4 rounded-xl"></div>`;
        parentBooksEmpty?.classList.add("hidden");
        parentBooksReload?.classList.add("hidden");
      }

      function showParentBooksEmpty(message, allowReload) {
        if (parentBooksList) parentBooksList.innerHTML = "";
        if (parentBooksEmpty) {
          parentBooksEmpty.textContent = message;
          parentBooksEmpty.classList.remove("hidden");
        }
        if (parentBooksReload) {
          parentBooksReload.classList.toggle("hidden", !allowReload);
          if (allowReload) {
            parentBooksReload.onclick = () => refreshParentBooksPanel(true);
          }
        }
      }

      async function ensureParentYearData(yearStr) {
        if (!window.SomapBooks?.loadCommonYear) return null;
        const target = yearStr || getActiveYearString();
        if (parentYearDataCache && parentYearDataKey === target) {
          return parentYearDataCache;
        }
        try {
          const data = await window.SomapBooks.loadCommonYear(target);
          parentYearDataCache = data;
          parentYearDataKey = data?.y || target;
          return data;
        } catch (err) {
          console.warn(
            "Unable to load enrollment context for parent view",
            err
          );
          parentYearDataCache = null;
          parentYearDataKey = null;
          return null;
        }
      }

      async function resolveParentDisplayClass(yearStr, force = false) {
        if (!currentStudentKey)
          return currentStudent?.classLevel || "Baby Class";
        const cacheKey = `${currentStudentKey}:${yearStr}`;
        if (force) {
          parentBooksClassCache.delete(cacheKey);
          parentYearDataCache = null;
          parentYearDataKey = null;
        }
        if (!force && parentBooksClassCache.has(cacheKey))
          return parentBooksClassCache.get(cacheKey);
        try {
          const yearData = await ensureParentYearData(yearStr);
          if (yearData && window.SomapBooks?.resolveClassForYear) {
            const resolved =
              window.SomapBooks.resolveClassForYear(
                currentStudentKey,
                yearData.enrollAnchor || {},
                yearData.enrollYear || {},
                yearStr
              ) ||
              currentStudent?.classLevel ||
              "Baby Class";
            parentBooksClassCache.set(cacheKey, resolved);
            return resolved;
          }
        } catch (err) {
          console.warn("Failed to resolve parent books class", err);
        }
        const fallback = currentStudent?.classLevel || "Baby Class";
        const delta = Number(yearStr) - SOMAP_DEFAULT_YEAR;
        const derived = shiftClass(fallback, delta);
        parentBooksClassCache.set(cacheKey, derived);
        return derived;
      }

      async function refreshParentBooksPanel(force = false) {
        if (!parentBooksCard) {
          return;
        }
        if (!window.SomapBooks?.fetchBooksForClass) {
          parentBooksCard.classList.add("hidden");
          return;
        }
        parentBooksCard.classList.remove("hidden");
        if (!currentStudentKey) {
          showParentBooksEmpty("Sign in to view class books.", false);
          openBooksFullBtn?.classList.add("hidden");
          return;
        }
        const yearStr = getActiveYearString();
        if (parentBooksYear) parentBooksYear.textContent = yearStr;
        setParentBooksSkeleton();
        try {
          const displayClass = await resolveParentDisplayClass(yearStr, force);
          if (parentBooksClass) parentBooksClass.textContent = displayClass;
          if (displayClass === "GRADUATED") {
            showParentBooksEmpty(
              `Graduated (${yearStr}). No class books for this year.`,
              false
            );
            openBooksFullBtn?.classList.add("hidden");
            return;
          }
          openBooksFullBtn?.classList.remove("hidden");
          const books = await window.SomapBooks.fetchBooksForClass(
            yearStr,
            displayClass,
            null,
            force ? { force: true } : {}
          );
          latestBooksSnapshot = {
            year: yearStr,
            className: displayClass,
            items: books,
          };
          if (!books.length) {
            showParentBooksEmpty(
              `No indexed books found for ${displayClass} in ${yearStr}.`,
              true
            );
            return;
          }
          parentBooksEmpty?.classList.add("hidden");
          parentBooksReload?.classList.add("hidden");
          const subset = books
            .slice(0, 3)
            .map((book) => {
              const link =
                book.url ||
                (typeof cloudinaryFileUrl === "function"
                  ? cloudinaryFileUrl(book.publicId)
                  : "");
              const safeLink = escapeHtml(link);
              const pageRange =
                book.pageFrom && book.pageTo
                  ? `<span class="text-[10px] text-slate-400">Pages ${escapeHtml(
                      book.pageFrom
                    )}-${escapeHtml(book.pageTo)}</span>`
                  : "";
              const openBtn = link
                ? `<a href="${safeLink}" target="_blank" rel="noopener" class="text-xs inline-flex items-center gap-1 text-sky-300 hover:underline">Read <i class="fas fa-arrow-up-right-from-square text-[10px]"></i></a>`
                : `<span class="text-[10px] text-slate-500">File pending</span>`;
              return `
          <div class="glass bg-white/5 border border-white/10 rounded-xl p-3 flex flex-col gap-1">
            <div class="flex items-center justify-between gap-2">
              <strong class="text-sm text-white truncate">${escapeHtml(
                book.title
              )}</strong>
              ${openBtn}
            </div>
            <div class="text-xs text-slate-300 flex items-center gap-2">
              <span>${escapeHtml(book.subject || "General")}</span>
              ${pageRange}
            </div>
          </div>`;
            })
            .join("");
          parentBooksList.innerHTML = subset;
        } catch (err) {
          console.error("Unable to load parent books panel", err);
          showParentBooksEmpty(
            "Unable to load class books. Tap reload to try again.",
            true
          );
        }
      }
      async function resolveStudentKeyForParent() {
        const urlKey = new URLSearchParams(window.location.search).get(
          "studentKey"
        );
        if (urlKey) return urlKey;

        const storedKey = localStorage.getItem("studentKey");
        if (storedKey) return storedKey;

        const rawPhone = localStorage.getItem("parentPhone");

        // NEVER block legacy behavior
        if (!rawPhone) {
          return localStorage.getItem("studentKey") || null;
        }

        const parentPhone = normalizePhone(rawPhone);

        const snap = await schoolRef(`parentReferrals/${parentPhone}`)
          .orderByChild("joinedAt")
          .limitToLast(1)
          .once("value");

        if (snap.exists()) {
          return Object.keys(snap.val())[0];
        }

        // 🔁 Final fallback — NEVER break old sessions
        const legacyKey = localStorage.getItem("studentKey");
        if (legacyKey) return legacyKey;

        return null;
      }

      // Init
      (async function init() {
        try {
          // resolve student
          currentStudentKey = await resolveStudentKeyForParent();

          if (!currentStudentKey) {
            Swal.fire(
              "No student linked",
              "Please contact the school to link your child.",
              "warning"
            );
            window.location.href = "index.html";
            return;
          }

          localStorage.setItem("studentKey", currentStudentKey);

          //  fetch student
          const snap = await schoolRef(`students/${currentStudentKey}`).once(
            "value"
          );
          if (!snap.exists()) {
            localStorage.removeItem("studentKey");
            window.location.href = "index.html";
            return;
          }

          currentStudent = snap.val();

          parentBooksClassCache.clear();
          parentYearDataCache = null;
          parentYearDataKey = null;
          attachStudentLiveListener();

          await showParentDashboard();
          bindUI();
          updateYearBadge();
        } catch (err) {
          console.error(err);
          Swal.fire(
            "Error",
            "Failed to initialize dashboard. Please refresh the page.",
            "error"
          );
        }
      })();

      async function showParentDashboard() {
        if (!requireStudentKey()) return;

        if (!currentStudent) {
          const s = await schoolRef(`students/${currentStudentKey}`).once(
            "value"
          );
          if (!s.exists()) {
            window.location.href = "index.html";
            return;
          }
          currentStudent = s.val();
        }

        // Header
        studentNameEl.textContent = `${safe(currentStudent.firstName)} ${safe(
          currentStudent.middleName || ""
        )} ${safe(currentStudent.lastName)}`
          .replace(/\s+/g, " ")
          .trim();
        studentMetaEl.textContent = `School: ${safe(
          currentStudent.schoolName || "-"
        )}`;
        updateYearBadge();

        detailClass.textContent = safe(currentStudent.classLevel || "-");
        detailStream.textContent = safe(currentStudent.stream || "-");
        detailAdm.textContent = safe(
          currentStudent.admissionNumber || currentStudent.pupilId || "-"
        );
        detailParentPhone.textContent = safe(
          currentStudent.primaryParentContact || "-"
        );
        // Persist parent phone for referral fallback (old behavior restoration)
        if (currentStudent.primaryParentContact) {
          try {
            localStorage.setItem(
              "parentPhone",
              normalizePhone(currentStudent.primaryParentContact)
            );
          } catch (_) {}
        }

        const adm =
          currentStudent.admissionNumber ||
          currentStudent.pupilId ||
          currentStudentKey;
        const classLevel = currentStudent.classLevel || "";
        await refreshYearDependentData();
        await loadAttendanceForStudent(currentStudent.admissionNumber);
        await loadScoresForStudent(currentStudent.admissionNumber);
        await checkTransportAccess(adm);
        await loadParentTransportHome();
        await refreshParentBooksPanel();

        loadGraduationGallery(getActiveYearString());

        renderAttendanceChart();
        renderScoresChart();
        await ensureParentReferralCode();
        await loadParentReferredStudents();
      }

      // Calculate local payments
      function calculateTotalPayments(student) {
        const payments = student?.payments || {};
        let sum = 0;
        Object.values(payments).forEach((p) => (sum += Number(p.amount || 0)));
        return sum;
      }

      // >>> Badge now belongs to BALANCE (no "DUE" on Total Paid)
      function applyFeeBadge(feeDue, paid) {
        const bal = Math.max(0, feeDue - paid);
        const els = [
          q("#balanceStatusBadge"),
          q("#feeStatusBadge") /* legacy, if ever present */,
        ];
        els.forEach((el) => {
          if (!el) return;
          el.classList.remove("badge-ok", "badge-warn", "badge-risk");
          if (bal <= 0) {
            el.classList.add("badge-ok");
            el.textContent = "PAID";
          } else if (bal / Math.max(1, feeDue) <= 0.25) {
            el.classList.add("badge-warn");
            el.textContent = "PARTIAL";
          } else {
            el.classList.add("badge-risk");
            el.textContent = "OUTSTANDING";
          }
        });
      }

      // Payments aggregator (pull from common finance paths)
      function normalizePayment(p, sourceKey, targetYear) {
        const amt = Number(p?.amount || 0);
        if (!amt || amt <= 0) return null;

        let ts = Number(p?.timestamp || 0);
        if (!ts && p?.date) {
          const t = Date.parse(p.date);
          if (!Number.isNaN(t)) ts = t;
        }
        if (!ts) ts = Date.now();

        // Determine payment year from payment record or timestamp
        let paymentYear = Number(
          p?.academicYear ??
            p?.financeYear ??
            p?.feeYear ??
            p?.year ??
            p?._year ??
            p?.academic_session
        );
        if (!Number.isFinite(paymentYear)) {
          const tsDate = new Date(ts);
          if (!Number.isNaN(tsDate.getTime()))
            paymentYear = tsDate.getFullYear();
        }

        // Filter by target year - only include payments for the selected year
        if (
          Number.isFinite(targetYear) &&
          Number.isFinite(paymentYear) &&
          paymentYear !== Number(targetYear)
        ) {
          return null; // Payment doesn't belong to the target year
        }

        return {
          amount: amt,
          timestamp: ts,
          academicYear: paymentYear,
          method: p?.method || p?.mode || "-",
          note: p?.note || p?.remarks || "",
          _src: sourceKey || "unknown",
        };
      }
      async function tryPathOnce(path) {
        try {
          const s = await schoolRef(path).once("value");
          return s.val() || null;
        } catch {
          return null;
        }
      }
      function dedupePayments(arr) {
        const seen = new Set();
        return arr.filter((p) => {
          if (!p) return false;
          const k = `${p.amount}|${new Date(p.timestamp).toDateString()}|${
            p.method
          }|${p.note}`;
          if (seen.has(k)) return false;
          seen.add(k);
          return true;
        });
      }

      async function loadPaymentsAllSources(
        studentKey,
        admNo,
        classLevel,
        year
      ) {
        if (!latestYearHasFinanceRecord) {
          paymentsList.innerHTML =
            '<li class="muted">No record for this year.</li>';
          __allPaymentsSum = 0;
          if (statReceiptCount) statReceiptCount.textContent = "0";
          if (statReceiptMeta) statReceiptMeta.textContent = "No receipts yet";
          return;
        }
        paymentsList.innerHTML = `
      <li><div class="skeleton h-4 w-40"></div></li>
      <li><div class="skeleton h-4 w-56"></div></li>
      <li><div class="skeleton h-4 w-48"></div></li>`;

        const targetYear = Number(year);
        const paths = [
          `students/${studentKey}/payments`,
          `finance/${year}/${classLevel}/${admNo}/payments`,
          `fees/${year}/${admNo}/payments`,
          `payments/${admNo}`,
          `feesPayments/${admNo}`,
        ];
        const results = await Promise.all(paths.map((p) => tryPathOnce(p)));

        let merged = [];
        results.forEach((obj, idx) => {
          if (!obj) return;
          Object.values(obj).forEach((v) => {
            const normalized = normalizePayment(v, paths[idx], targetYear);
            if (normalized) merged.push(normalized);
          });
        });
        merged = dedupePayments(merged).sort(
          (a, b) => b.timestamp - a.timestamp
        );

        if (!merged.length) {
          paymentsList.innerHTML =
            '<li class="muted">No payments recorded for this year.</li>';
        } else {
          const max = Math.min(merged.length, 50);
          paymentsList.innerHTML = merged
            .slice(0, max)
            .map(
              (p) => `
        <li>
          <div>
            <div class="title font-extrabold">${fmtTsh(p.amount)}</div>
            <div class="muted text-sm">${p.method || "-"} ΓÇó ${safe(
                p.note
              )}</div>
          </div>
          <div class="muted text-right text-sm">${new Date(
            p.timestamp
          ).toLocaleString()}</div>
        </li>
      `
            )
            .join("");
        }

        // Only count payments for the selected year
        const yearPaymentsSum = merged.reduce(
          (s, p) => s + (Number(p.amount) || 0),
          0
        );
        __allPaymentsSum = yearPaymentsSum;

        // The finance snapshot from renderFinanceStats() already handles:
        // - Year-filtered payments (via normalizePayments in finance_math.js)
        // - Carry-forward debt (via financeCarryForward in buildFinanceStudents)
        // - Correct due/paid/outstanding calculations
        // So we should NOT override those stats here - only update if finance snapshot is not available
        if (latestFinanceSnapshot && latestFinanceSnapshot.due !== undefined) {
          // Finance snapshot is available and correct - use it (stats already set by renderFinanceStats)
          // Just verify the paid amount matches what we see in payments list for consistency
          if (
            Math.abs(yearPaymentsSum - (latestFinanceSnapshot.paid || 0)) > 1
          ) {
            // Slight discrepancy - finance snapshot is the source of truth, but log for debugging
            console.debug("Payment sum discrepancy:", {
              yearPaymentsSum,
              snapshotPaid: latestFinanceSnapshot.paid,
              year,
            });
          }
        } else {
          // Fallback: finance snapshot not available, calculate manually
          const carryMeta = await resolveCarryForwardDebt(
            studentKey,
            year,
            admNo
          );
          const previousDebt = carryMeta.amount;
          const fallbackFeeDue = Number(
            currentStudent?.feePerYear || currentStudent?.feeDue || 0
          );
          const feeDue = fallbackFeeDue + previousDebt;
          const paidForYear = yearPaymentsSum;
          const computedOutstanding = Math.max(0, feeDue - paidForYear);

          // Build debt note in small letters if there's previous debt
          let debtNote = "";
          if (previousDebt > 0) {
            const fallbackPrevYear = (() => {
              const prev = Number(year) - 1;
              if (prev >= EARLIEST_CARRY_FORWARD_YEAR) return String(prev);
              return String(EARLIEST_CARRY_FORWARD_YEAR);
            })();
            const noteYear = carryMeta.sourceYear || fallbackPrevYear;
            if (fallbackFeeDue === 0) {
              debtNote = `<span style="font-size: 0.65rem; color: var(--muted); display: block; margin-top: 2px; text-transform: lowercase;">debt carried from ${noteYear}</span>`;
            } else {
              debtNote = `<span style="font-size: 0.65rem; color: var(--muted); display: block; margin-top: 2px; text-transform: lowercase;">includes ${fmtTsh(
                previousDebt
              )} debt carried from ${noteYear}</span>`;
            }
          }

          if (debtNote) {
            statFeeDue.innerHTML = fmtTsh(feeDue) + debtNote;
          } else {
            statFeeDue.textContent = fmtTsh(feeDue);
          }
          statPaid.textContent = fmtTsh(paidForYear);
          statBalance.textContent = fmtTsh(computedOutstanding);
          applyFeeBadge(feeDue, paidForYear);
        }

        // ---- Update Receipts stat card
        const recCount = merged.length;
        const lastTs = merged[0]?.timestamp || null; // merged is sorted desc above
        if (statReceiptCount) statReceiptCount.textContent = String(recCount);
        if (statReceiptMeta)
          statReceiptMeta.textContent = lastTs
            ? "Last: " + new Date(lastTs).toLocaleDateString()
            : "No receipts yet";
      }

      async function checkTransportAccess(studentId) {
        if (!quickTransport) return;
        quickTransport.classList.add("hidden");
        try {
          const resolved = await resolveTransportEnrollmentForStudent(
            getActiveYearString(),
            studentId,
            currentStudent || {}
          );
          const exists = !!resolved?.enrollment;
          if (exists) {
            quickTransport.classList.remove("hidden");
            if (!quickTransport.dataset.bound) {
              quickTransport.dataset.bound = "1";
              quickTransport.addEventListener("click", () => {
                const url = `transporthtml/parent/transporthub.html?student=${encodeURIComponent(
                  studentId
                )}`;
                window.location.href = url;
              });
            }
          }
        } catch (err) {
          console.warn("transport enrolment lookup failed", err);
        }
      }

      async function loadGraduationSummary(
        admNo,
        classLevel,
        yearArg = getActiveYearString()
      ) {
        if (!graduationCardEl) return;
        if (!graduationGalleryLoaded) loadGraduationGallery(yearArg);
        const admKey = sanitizeKey(admNo || "");
        if (!admKey) {
          graduationCardEl.classList.add("hidden");
          return;
        }

        if (!isGraduationClass(classLevel)) {
          graduationCardEl.classList.add("hidden");
          gradStatusEl?.classList.add("hidden");
          gradCertActionsEl.textContent = "";
          gradCertMessageEl.textContent =
            "Graduation fee is not required for this class.";
          return;
        }

        graduationCardEl.classList.remove("hidden");
        gradStatusEl?.classList.add("hidden");
        gradYearLabel.textContent = yearArg;
        gradExpectedEl.textContent = fmtTsh(0);
        gradPaidEl.textContent = fmtTsh(0);
        gradBalanceEl.textContent = fmtTsh(0);
        gradCertMessageEl.textContent = "Loading graduation status...";
        gradCertActionsEl.textContent = "";

        try {
          const snap = await schoolRef(
            `graduation/${yearArg}/students/${admKey}`
          ).once("value");
          const data = snap.val();
          if (data) {
            const expected = Number(data.expectedFee || 0);
            const paid = Number(data.paid || 0);
            const balance = Math.max(0, expected - paid);
            gradExpectedEl.textContent = fmtTsh(expected);
            gradPaidEl.textContent = fmtTsh(paid);
            gradBalanceEl.textContent = fmtTsh(balance);
            updateGradBadge(data.status || (balance > 0 ? "balance" : "paid"));
            gradCertMessageEl.textContent =
              balance > 0
                ? "Balance remaining for graduation is highlighted below. Kindly clear it before November 7."
                : "Thank you! Graduation contribution is fully cleared.";
          } else {
            gradCertMessageEl.textContent =
              "Graduation record not yet prepared. Please check with the class teacher.";
          }
        } catch (err) {
          console.warn("Graduation summary load error", err);
          gradCertMessageEl.textContent =
            "Could not load graduation summary at this time.";
        }

        try {
          const certSnap = await schoolRef(
            `graduation/${yearArg}/certificates/${admKey}`
          ).once("value");
          const cert = certSnap.val();
          gradCertActionsEl.textContent = "";
          if (cert && cert.urlPdf) {
            gradCertMessageEl.textContent =
              "Certificate ready. Download and celebrate!";
            const downloadBtn = document.createElement("a");
            downloadBtn.href = cert.urlPdf;
            downloadBtn.target = "_blank";
            downloadBtn.rel = "noopener";
            downloadBtn.className = "btn";
            downloadBtn.innerHTML =
              '<i class="fas fa-file-pdf mr-2"></i>Download Certificate';
            gradCertActionsEl.appendChild(downloadBtn);
            if (cert.urlPreview) {
              const previewBtn = document.createElement("a");
              previewBtn.href = cert.urlPreview;
              previewBtn.target = "_blank";
              previewBtn.rel = "noopener";
              previewBtn.className = "btn-ghost";
              previewBtn.textContent = "Preview";
              gradCertActionsEl.appendChild(previewBtn);
            }
          } else {
            gradCertMessageEl.textContent +=
              " Certificates publish on 18 October each year.";
          }
        } catch (err) {
          console.warn("Certificate lookup failed", err);
        }
      }

      async function loadGraduationGallery(year) {
        if (!gradGalleryList) return;
        const targetYear = String(year || getActiveYearString());
        if (graduationGalleryLoaded && graduationGalleryYear === targetYear)
          return;
        graduationGalleryLoaded = true;
        graduationGalleryYear = targetYear;
        try {
          const snap = await schoolRef(`graduation/${targetYear}/galleries`)
            .limitToLast(12)
            .once("value");
          const all = snap.val() || {};
          const photos = Object.entries(all)
            .map(([key, value]) => ({ key, ...(value || {}) }))
            .sort(
              (a, b) => Number(b.uploadedAt || 0) - Number(a.uploadedAt || 0)
            );
          if (!photos.length) {
            gradGalleryList.innerHTML =
              '<div class="muted text-sm col-span-full">No graduation photos uploaded yet.</div>';
          } else {
            gradGalleryList.innerHTML = photos
              .slice(0, 12)
              .map((photo) => {
                const caption = safe(photo.caption || "Graduation moment");
                const when = photo.uploadedAt
                  ? new Date(Number(photo.uploadedAt)).toLocaleDateString()
                  : "";
                return `
            <figure>
              <img src="${photo.url}" alt="${caption}" class="gallery-image">
              <div class="gallery-meta">
                <p class="caption">${caption}</p>
                <p class="meta">${when}</p>
              </div>
            </figure>`;
              })
              .join("");
          }
        } catch (err) {
          console.warn("Gallery load error", err);
          gradGalleryList.innerHTML =
            '<div class="text-red-300 text-sm col-span-full">Unable to load graduation gallery.</div>';
        }
      }

      function updateGradBadge(status) {
        if (!gradStatusEl) return;
        gradStatusEl.classList.remove(
          "hidden",
          "badge-ok",
          "badge-warn",
          "badge-risk"
        );
        const state = String(status || "").toLowerCase();
        if (!state || state === "paid") {
          gradStatusEl.classList.add("badge-ok");
          gradStatusEl.textContent = "PAID";
        } else if (state === "debt") {
          gradStatusEl.classList.add("badge-risk");
          gradStatusEl.textContent = "DEBT";
        } else {
          gradStatusEl.classList.add("badge-warn");
          gradStatusEl.textContent = state.toUpperCase();
        }
      } // Attendance loader
      async function loadParentReferredStudents() {
        const listEl = document.getElementById("parentReferralList");
        const codeEl = document.getElementById("parentReferralCode");
        if (!listEl || !codeEl) return;

        const parentPhone = normalizePhone(localStorage.getItem("parentPhone"));
        if (!parentPhone) {
          listEl.innerHTML =
            '<div class="muted text-sm">Parent phone not available.</div>';
          return;
        }

        // Show referral code (if exists in parents node)
        try {
          const pSnap = await schoolRef("parents")
            .orderByChild("phone")
            .equalTo(parentPhone)
            .once("value");

          if (pSnap.exists()) {
            const parent = Object.values(pSnap.val())[0];
            if (parent?.referralCode) {
              codeEl.textContent = `Referral code: ${parent.referralCode}`;
            }
          }
        } catch {}

        // Load referred students
        const snap = await schoolRef(`parentReferrals/${parentPhone}`).once(
          "value"
        );
        if (!snap.exists()) {
          listEl.innerHTML =
            '<div class="muted text-sm">No students referred yet.</div>';
          return;
        }
        const entries = Object.values(snap.val()).sort(
          (a, b) => (b.joinedAt || 0) - (a.joinedAt || 0)
        );

        listEl.innerHTML = entries
          .map(
            (r) => `
      <div class="glass bg-white/5 border border-white/10 rounded-lg p-3">
        <div class="font-semibold text-white">${r.studentName}</div>
        <div class="muted text-xs">
          ${r.classLevel} • ${r.academicYear}
        </div>
      </div>
    `
          )
          .join("");
      }

      async function loadAttendanceForStudent(admNo) {
        statAttendancePct.textContent = "Calculating...";
        try {
          const snap = await schoolRef("attendance").once("value");
          const obj = snap.val() || {};
          let present = 0,
            total = 0;
          const monthCounts = {};
          Object.values(obj).forEach((classObj) => {
            Object.values(classObj || {}).forEach((monthObj) => {
              Object.values(monthObj || {}).forEach((dayObj) => {
                Object.values(dayObj || {}).forEach((rec) => {
                  try {
                    const s = rec.snap;
                    if (s && String(s.admissionNo) === String(admNo)) {
                      total++;
                      const daily = rec.daily || "";
                      if (
                        daily === "P" ||
                        daily === "PS" ||
                        daily === "PA" ||
                        daily === "PS"
                      )
                        present++;
                      const ts = rec.timestamp || rec.ts || null;
                      if (ts) {
                        const d = new Date(ts);
                        const m = `${d.getFullYear()}-${String(
                          d.getMonth() + 1
                        ).padStart(2, "0")}`;
                        monthCounts[m] = monthCounts[m] || {
                          present: 0,
                          total: 0,
                        };
                        monthCounts[m].total++;
                        if (daily === "P" || daily === "PS")
                          monthCounts[m].present++;
                      }
                    }
                  } catch {}
                });
              });
            });
          });
          const pct = total ? Math.round((present / total) * 100) : 0;
          statAttendancePct.textContent = pct + "%";
          window.__soMap_attendance_months = monthCounts;
          renderAttendanceChart();
        } catch (err) {
          console.error("attendance error", err);
          statAttendancePct.textContent = "ΓÇö";
        }
      }

      // Scores (latest)
      async function loadScoresForStudent(admNo) {
        try {
          scoresTbody.innerHTML =
            '<tr><td colspan="4" class="muted p-3">Loading scoresΓÇª</td></tr>';
          const snap = await schoolRef("scores").once("value");
          const root = snap.val() || {};
          let found = null;
          outer: for (const year of Object.keys(root).sort().reverse()) {
            const classes = root[year] || {};
            for (const className of Object.keys(classes || {})) {
              const examKeys = classes[className] || {};
              for (const examKey of Object.keys(examKeys || {})) {
                const months = examKeys[examKey] || {};
                for (const monthKey of Object.keys(months || {})
                  .sort()
                  .reverse()) {
                  const mdata = months[monthKey] || {};
                  if (mdata && mdata[admNo]) {
                    found = {
                      year,
                      className,
                      examKey,
                      monthKey,
                      data: mdata[admNo],
                    };
                    break outer;
                  }
                }
              }
            }
          }
          if (!found) {
            scoresTbody.innerHTML =
              '<tr><td colspan="4" class="muted p-3">No scores found for this student.</td></tr>';
            window.__soMap_scores_for_chart = null;
            renderScoresChart();
            return;
          }
          const labels = [],
            values = [];
          let rows = "";
          Object.keys(found.data).forEach((subject) => {
            const subj = found.data[subject] || {};
            const score = Number(subj.score || 0),
              max = Number(subj.max || 100);
            const pct = max ? (score / max) * 100 : 0;
            rows += `<tr><td>${subject}</td><td>${score}</td><td>${max}</td><td>${pct.toFixed(
              1
            )}%</td></tr>`;
            labels.push(subject);
            values.push(Number(pct.toFixed(1)));
          });
          scoresTbody.innerHTML =
            rows ||
            '<tr><td colspan="4" class="muted p-3">No subjects found.</td></tr>';
          window.__soMap_scores_for_chart = { labels, values, meta: found };
          renderScoresChart();
        } catch (err) {
          console.error("scores error", err);
          scoresTbody.innerHTML =
            '<tr><td colspan="4" class="muted p-3">Error loading scores.</td></tr>';
        }
      }

      // Charts (dark ticks)
      function renderScoresChart() {
        const ctx = scoresChartCanvas.getContext("2d");
        if (scoresChart) scoresChart.destroy();
        const ds = window.__soMap_scores_for_chart || {
          labels: [],
          values: [],
        };
        scoresChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ds.labels,
            datasets: [
              {
                label: "% (score / max)",
                data: ds.values,
                borderWidth: 1,
                backgroundColor: ds.labels.map(() => "rgba(99,102,241,0.85)"),
                borderColor: ds.labels.map(() => "rgba(99,102,241,1)"),
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: { beginAtZero: true, max: 100, ticks: { color: "#cbd5f5" } },
              x: { ticks: { color: "#cbd5f5" } },
            },
            plugins: { legend: { display: false } },
          },
        });
      }
      function renderAttendanceChart() {
        const ctx = attendanceChartCanvas.getContext("2d");
        if (attendanceChart) attendanceChart.destroy();
        const months = window.__soMap_attendance_months || {};
        const keys = Object.keys(months).sort();
        const labels = keys,
          values = keys.map((k) => {
            const m = months[k] || {};
            return m.total && m.present
              ? Math.round((m.present / m.total) * 100)
              : 0;
          });
        attendanceChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Attendance %",
                data: values,
                tension: 0.35,
                fill: true,
                borderColor: "rgba(56,189,248,0.9)",
                backgroundColor: "rgba(14,165,233,0.22)",
                pointBackgroundColor: "#38bdf8",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: { color: "#cbd5f5", callback: (v) => v + "%" },
              },
              x: { ticks: { color: "#cbd5f5" } },
            },
            plugins: { legend: { display: false } },
          },
        });
      }

      // Export buttons
      exportCsvBtn.addEventListener("click", () => {
        if (!window.__soMap_scores_for_chart) {
          Swal.fire("No data", "No scores to export", "info");
          return;
        }
        const { labels, values } = window.__soMap_scores_for_chart;
        const arr = [["Subject", "%"]];
        for (let i = 0; i < labels.length; i++)
          arr.push([labels[i], values[i]]);
        const ws = XLSX.utils.aoa_to_sheet(arr),
          wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Scores");
        const wbout = XLSX.write(wb, { bookType: "csv", type: "array" });
        const blob = new Blob([wbout], { type: "text/csv;charset=utf-8;" });
        const name = `${
          currentStudent.admissionNumber || "student"
        }_scores.csv`;
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
        URL.revokeObjectURL(a.href);
      });
      exportPdfBtn.addEventListener("click", () => {
        if (!currentStudent) {
          Swal.fire("No student", "Please sign in first", "warning");
          return;
        }
        const rows = [];
        document.querySelectorAll("#scoresTbody tr").forEach((tr) => {
          const cols = Array.from(tr.querySelectorAll("td")).map((td) =>
            td.textContent.trim()
          );
          if (cols.length) rows.push(cols);
        });
        if (!rows.length) {
          Swal.fire("No scores", "No scores to export", "info");
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text(
          `${safe(currentStudent.firstName)} ${safe(
            currentStudent.lastName
          )} ΓÇö Scores`,
          14,
          20
        );
        doc.autoTable({
          startY: 30,
          head: [["Subject", "Score", "Max", "%"]],
          body: rows,
          styles: { fontSize: 10 },
        });
        doc.save(`${currentStudent.admissionNumber || "student"}_scores.pdf`);
      });

      // Report card (same route as your Quick Action)
      genReportBtn.addEventListener("click", openReportCard);
      quickReportCard.addEventListener("click", openReportCard);
      function openReportCard() {
        if (!currentStudent) {
          Swal.fire("No student", "Please sign in first", "warning");
          return;
        }
        const adm = encodeURIComponent(
          currentStudent.admissionNumber || currentStudent.pupilId || ""
        );
        const name = encodeURIComponent(
          `${currentStudent.firstName || ""} ${
            currentStudent.lastName || ""
          }`.trim()
        );
        const phone = encodeURIComponent(
          currentStudent.primaryParentContact || ""
        );
        const url = `Toacademichtml/generatereportform.html?adm=${adm}&name=${name}&phone=${phone}`;
        window.open(url, "_blank");
      }

      // Quick actions
      quickGenerateId.addEventListener("click", () => {
        if (!currentStudent) {
          Swal.fire("No student", "Please sign in first", "warning");
          return;
        }
        const phone = encodeURIComponent(
          currentStudent.primaryParentContact || ""
        );
        const firstName = encodeURIComponent(
          (currentStudent.firstName || "").toLowerCase().replace(/\s+/g, "")
        );
        const lastName = encodeURIComponent(
          (currentStudent.lastName || "").toLowerCase().replace(/\s+/g, "")
        );
        window.open(
          `ToSchoolerp/generateid.html?phone=${phone}&firstName=${firstName}&lastName=${lastName}`,
          "_blank"
        );
      });
      quickFees.addEventListener("click", () => {
        Swal.fire({
          title: "Fees",
          html: `<div style="text-align:left">${statFeeDue.textContent}<br>${statPaid.textContent}<br>${statBalance.textContent}</div>`,
        });
      });
      openMarketTop.addEventListener("click", () =>
        window.open("market.html", "_blank")
      );
      viewMarketSmall.addEventListener("click", () =>
        window.open("market.html", "_blank")
      );
      openGalleryFull?.addEventListener("click", () =>
        window.open("Tostaffhtml/gradgalleries.html", "_blank")
      );

      // Refresh payments
      q("#refreshPayments").addEventListener("click", () => {
        refreshYearDependentData().catch(console.error);
      });

      function handleAction(action) {
        switch (action) {
          case "market":
            window.open("market.html", "_blank");
            break;
          case "attendance":
            if (!currentStudent) {
              Swal.fire(
                "Error",
                "Student data not loaded. Please sign in again.",
                "error"
              );
              return;
            }
            const url = `Toattendancehtml/childattendance.html?class=${encodeURIComponent(
              currentStudent.classLevel || ""
            )}&adm=${encodeURIComponent(currentStudent.admissionNumber || "")}`;
            const w = window.open(url, "_blank");
            if (!w) {
              Swal.fire("Error", "Allow pop-ups to view attendance.", "error");
              return;
            }
            w.addEventListener(
              "load",
              () => {
                w.document.documentElement
                  .requestFullscreen?.()
                  .catch(() => {});
              },
              { once: true }
            );
            break;
          case "fees":
            Swal.fire({
              title: "Payments",
              html: paymentsList.innerHTML,
              width: 800,
            });
            break;
          case "books":
            if (!currentStudentKey) {
              Swal.fire(
                "Error",
                "Student data not loaded. Please sign in again.",
                "error"
              );
              return;
            }
            try {
              localStorage.setItem("studentKey", currentStudentKey);
            } catch (_e) {}
            window.open(
              `Bookshtml/classbook.html?student=${encodeURIComponent(
                currentStudentKey
              )}&year=${encodeURIComponent(getActiveYearString())}`,
              "_blank"
            );
            break;
        }
      }

      openBooksFullBtn?.addEventListener("click", () => handleAction("books"));

      // Live updates
      function attachStudentLiveListener() {
        if (!currentStudentKey) return;

        schoolRef("students")
          .child(currentStudentKey)
          .on("value", (snap) => {
            if (!snap.exists()) {
              Swal.fire(
                "Student removed",
                "Student data was removed. You will be redirected.",
                "warning"
              ).then(() => {
                localStorage.removeItem("studentKey");
                window.location.href = "index.html";
              });
              return;
            }

            currentStudent = snap.val();
            studentNameEl.textContent = `${safe(
              currentStudent.firstName
            )} ${safe(currentStudent.lastName)}`;
            detailClass.textContent = safe(currentStudent.classLevel || "-");
            detailStream.textContent = safe(currentStudent.stream || "-");
            detailAdm.textContent = safe(currentStudent.admissionNumber || "-");
            detailParentPhone.textContent = safe(
              currentStudent.primaryParentContact || "-"
            );

            refreshYearDependentData().catch(console.error);
            refreshParentBooksPanel().catch(console.error);
          });
      }

      function bindUI() {
        /* all wired */
      }

      // ===== Shared: build receipt URL for parent + finance views =====
      function resolveReceiptStudentIdentifier() {
        const candidates = [
          currentStudent?.admissionNumber,
          currentStudent?.admissionNo,
          currentStudent?.registrationNumber,
          currentStudent?.pupilId,
          currentStudent?.autoId,
          currentStudentKey,
          localStorage.getItem("studentKey"),
          localStorage.getItem("parentFocusStudent"),
          localStorage.getItem("parentFocusAdm"),
        ];
        const match = candidates.find((value) => value && String(value).trim());
        return match ? String(match).trim() : "";
      }

      function resolveReceiptSchoolIdentifier() {
        const fallback = (() => {
          try {
            return localStorage.getItem("somap_school");
          } catch (_e) {
            return "";
          }
        })();
        const candidates = [
          currentStudent?.schoolId,
          currentStudent?.school,
          currentStudent?.schoolSlug,
          currentStudent?.schoolKey,
          fallback,
        ];
        const match = candidates.find((value) => value && String(value).trim());
        if (match) {
          const normalized = String(match).trim();
          window.currentSchoolId = normalized;
          try {
            localStorage.setItem("somap_school", normalized);
          } catch (_e) {}
          return normalized;
        }
        return "";
      }

      function buildChildReceiptUrlGlobal() {
        const fallbackId = resolveReceiptStudentIdentifier();
        const schoolId = resolveReceiptSchoolIdentifier();
        const params = new URLSearchParams();
        if (fallbackId) params.set("student", fallbackId);
        const yr = getActiveYearString();
        if (yr) params.set("year", yr);
        if (schoolId) params.set("school", schoolId);
        params.set("scope", "parent");
        const query = params.toString();
        return `Tofinancehtml/receipt.html${query ? `?${query}` : ""}`;
      }

      if (yearContext) {
        yearContext.onYearChanged((year) => {
          const normalized = String(year);
          if (normalized === activeYear) return;
          activeYear = normalized;
          __allPaymentsSum = 0;
          graduationGalleryLoaded = false;
          graduationGalleryYear = null;
          updateYearBadge();
          refreshYearDependentData().catch(console.error);
          loadGraduationGallery(getActiveYearString());
          loadParentTransportHome().catch(console.error); // Refresh transport on year change
          refreshParentBooksPanel().catch(console.error);
        });
      }

      // === Receipt Vault (Parent) ===
      (function () {
        const openBtn = document.getElementById("openReceiptVault");
        const openNewTabBtn = document.getElementById("openReceiptNewTab");
        const modal = document.getElementById("receiptModal");
        const frame = document.getElementById("receiptFrame");
        const closeBtn = document.getElementById("closeReceiptModal");

        function openModal(url) {
          if (!modal || !frame) return;
          frame.src = url;
          modal.classList.remove("hidden");
          modal.classList.add("flex");
        }
        function closeModal() {
          if (!modal || !frame) return;
          frame.src = "";
          modal.classList.add("hidden");
          modal.classList.remove("flex");
        }

        function ensureReceiptUrl(openFn) {
          const identifier = resolveReceiptStudentIdentifier();
          const url = buildChildReceiptUrlGlobal();
          if (!url) {
            if (window.Swal) {
              Swal.fire(
                "Receipts not ready",
                "We are still loading student data. Please try again in a moment.",
                "info"
              );
            }
            return;
          }
          if (!identifier && window.Swal) {
            Swal.fire(
              "Pick a student",
              "Use the student directory inside the receipt center to select your child.",
              "info"
            );
          }
          openFn(url);
        }

        // Right-side card buttons
        openBtn?.addEventListener("click", () => ensureReceiptUrl(openModal));
        openNewTabBtn?.addEventListener("click", () =>
          ensureReceiptUrl((url) => window.open(url, "_blank"))
        );
        closeBtn?.addEventListener("click", closeModal);

        // TOP stat card buttons
        document
          .getElementById("openReceiptVaultTop")
          ?.addEventListener("click", () => {
            ensureReceiptUrl(openModal);
          });
        document
          .getElementById("openReceiptNewTabTop")
          ?.addEventListener("click", () => {
            ensureReceiptUrl((url) => window.open(url, "_blank"));
          });
      })();
    </script>
  </body>
</html>
