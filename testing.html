﻿<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SoMAp — Login</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Google reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  </head>

  <body
    class="min-h-screen flex flex-col bg-gradient-to-br from-blue-500 to-purple-600"
  >
    <!-- ================= HEADER ================= -->
    <!-- Responsive Header -->
    <header
      class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-gray-200"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6">
        <div class="flex items-center justify-between h-16">
          <!-- Left: Brand -->
          <div class="flex items-center gap-3 min-w-0">
            <h1
              id="page-title"
              class="text-base sm:text-lg font-semibold text-gray-800 truncate"
            >
              SoMAp — Society Management App
            </h1>
          </div>

          <!-- Desktop Actions -->
          <div class="hidden md:flex items-center gap-4">
            <!-- Search -->
            <div class="relative">
              <input
                type="text"
                placeholder="Search..."
                class="w-64 rounded-lg border border-gray-300 px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
              />
              <i
                class="fas fa-search absolute right-3 top-2.5 text-gray-400 text-sm"
              ></i>
            </div>

            <!-- Notifications -->
            <button class="relative p-2 rounded-lg hover:bg-gray-100">
              <i class="far fa-bell text-gray-600"></i>
              <span
                class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center"
                >3</span
              >
            </button>

            <!-- Auth Links -->
            <button
              id="sign-out"
              class="hidden p-2 rounded-lg hover:bg-gray-100"
              title="Sign out"
            >
              <i class="fas fa-sign-out-alt text-gray-600"></i>
            </button>

            <a
              href="#login"
              class="text-sm font-medium text-gray-600 hover:text-indigo-600"
            >
              Login
            </a>

            <a
              href="join.html?s=socrates"
              class="inline-flex items-center px-4 py-2 rounded-full text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 transition"
            >
              Join Us
            </a>
            <select
              id="langSelect"
              class="hidden sm:block text-sm border rounded-lg px-2 py-1"
            >
              <option value="en">English</option>
              <option value="sw">Swahili</option>
            </select>
          </div>

          <!-- Mobile Menu Button -->
          <button
            id="mobile-menu-btn"
            class="md:hidden p-2 rounded-lg hover:bg-gray-100"
            aria-label="Open menu"
          >
            <i class="fas fa-bars text-gray-700"></i>
          </button>
        </div>
      </div>

      <!-- Mobile Menu -->
      <div
        id="mobile-menu"
        class="md:hidden hidden border-t border-gray-200 bg-white"
      >
        <div class="px-4 py-3 space-y-3">
          <a href="#login" class="block text-gray-700 font-medium"> Login </a>

          <a
            href="join.html?s=socrates"
            class="block text-center px-4 py-2 rounded-lg font-bold text-white bg-indigo-600"
          >
            Join Us
          </a>

          <button
            id="mobile-sign-out"
            class="hidden w-full text-left text-gray-700 font-medium"
          >
            Sign out
          </button>
        </div>
      </div>
    </header>

    <script>
      // Mobile menu toggle (UI only, safe)
      document
        .getElementById("mobile-menu-btn")
        ?.addEventListener("click", () => {
          document.getElementById("mobile-menu")?.classList.toggle("hidden");
        });
    </script>

    <!-- ================= MAIN ================= -->
    <main class="flex-1">
      <div class="max-w-xl mx-auto px-4 py-16 space-y-6">
        <!-- Staff -->
        <section class="bg-white rounded-xl p-6 shadow">
          <h2 class="text-xl font-bold text-center mb-4" data-i18n="staffTitle">
            Staff Login
          </h2>

          <div
            class="g-recaptcha my-3"
            data-sitekey="6LekDsorAAAAAOkhrg-3PKJCHEpBN1HYQQzca83x"
          ></div>

          <button
            id="googleLogin"
            class="w-full flex items-center justify-center gap-3 px-6 py-3 bg-gray-100 rounded-lg font-semibold"
          >
            <img
              src="https://developers.google.com/identity/images/g-logo.png"
              class="h-5"
            />
            <span data-i18n="googleBtn">Sign in with Google</span>
          </button>
        </section>

        <!-- Parent -->
        <section class="bg-white rounded-xl p-6 shadow">
          <h2
            class="text-xl font-bold text-center mb-4"
            data-i18n="parentTitle"
          >
            Parent Login
          </h2>

          <form id="parentForm" class="space-y-4">
            <input
              id="childNames"
              required
              data-i18n-placeholder="childNames"
              class="w-full px-4 py-2 border rounded-lg"
            />

            <input
              id="parentPhone"
              required
              data-i18n-placeholder="parentPhone"
              class="w-full px-4 py-2 border rounded-lg"
            />

            <button
              class="w-full py-2 bg-green-600 text-white rounded-lg font-semibold"
              data-i18n="parentBtn"
            >
              Login as Parent
            </button>
          </form>

          <p
            id="parentError"
            class="hidden text-red-600 text-sm mt-2 text-center"
          ></p>
        </section>

        <!-- Worker -->
        <section class="bg-white rounded-xl p-6 shadow">
          <h2
            class="text-xl font-bold text-center mb-4"
            data-i18n="workerTitle"
          >
            Worker Login
          </h2>

          <form id="workerForm" class="space-y-4">
            <input
              id="workerName"
              required
              data-i18n-placeholder="workerName"
              class="w-full px-4 py-2 border rounded-lg"
            />

            <input
              id="workerPhone"
              required
              data-i18n-placeholder="workerPhone"
              class="w-full px-4 py-2 border rounded-lg"
            />

            <button
              class="w-full py-2 bg-indigo-600 text-white rounded-lg font-semibold"
              data-i18n="workerBtn"
            >
              Login as Worker
            </button>
          </form>

          <p
            id="workerError"
            class="hidden text-red-600 text-sm mt-2 text-center"
          ></p>
        </section>
      </div>
    </main>

    <!-- ================= FOOTER ================= -->
    <!-- Responsive Footer -->
    <footer class="mt-16 bg-gray-900 text-gray-300">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 py-10">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <!-- Brand -->
          <div>
            <h3 class="text-lg font-bold text-white">SoMAp</h3>
            <p class="mt-2 text-sm">
              School & Society Management Platform built for African
              institutions.
            </p>
          </div>

          <!-- Links -->
          <div>
            <h4
              class="text-sm font-semibold text-white uppercase tracking-wider"
            >
              Platform
            </h4>
            <ul class="mt-3 space-y-2 text-sm">
              <li>
                <a href="join.html" class="hover:text-white">Admissions</a>
              </li>
              <li><a href="#login" class="hover:text-white">Login</a></li>
              <li><a href="market.html" class="hover:text-white">Market</a></li>
              <li>
                <a
                  href="societycashbook/societycashbook.html"
                  class="hover:text-white"
                >
                  Cashbook
                </a>
              </li>
            </ul>
          </div>

          <!-- Meta -->
          <div>
            <h4
              class="text-sm font-semibold text-white uppercase tracking-wider"
            >
              Project Info
            </h4>
            <p class="mt-3 text-sm">
              Project: <span class="text-white">somaptestt</span>
            </p>
            <p class="text-sm">
              Contact: <span class="text-white">mnyorej@gmail.com</span>
            </p>
          </div>
        </div>

        <div class="mt-8 border-t border-gray-700 pt-4 text-center text-sm">
          © <span id="year"></span> SoMAp — Built for African schools
        </div>
      </div>
    </footer>

    <!-- ================= JS ================= -->
    <script>
      /* ---------- YEAR ---------- */
      document.getElementById("year").textContent = new Date().getFullYear();

      /* ---------- MULTISCHOOL CONTEXT ---------- */
      window.SOMAP = {
        getActiveSchool() {
          return localStorage.getItem("somap.school") || "default";
        },
        setActiveSchool(id) {
          localStorage.setItem("somap.school", id);
        },
        P(path) {
          const school = this.getActiveSchool();
          if (!school || school === "default") return path;
          return `schools/${school}/${path.replace(/^\/+/, "")}`;
        },
      };

      const params = new URLSearchParams(window.location.search);
      if (params.get("s")) SOMAP.setActiveSchool(params.get("s"));

      /* ---------- LANGUAGE ---------- */
      const translations = {
        en: {
          staffTitle: "Staff Login",
          googleBtn: "Sign in with Google",
          parentTitle: "Parent Login",
          parentBtn: "Login as Parent",
          workerTitle: "Worker Login",
          workerBtn: "Login as Worker",
          childNames: "At least TWO child names",
          parentPhone: "+2550XXXXXXXXX",
          workerName: "THREE names (e.g. John Doe Junior)",
          workerPhone: "+2550XXXXXXXXX",
        },
        sw: {
          staffTitle: "Kuingia kwa Wafanyakazi",
          googleBtn: "Ingia kwa Google",
          parentTitle: "Kuingia kwa Mzazi",
          parentBtn: "Ingia kama Mzazi",
          workerTitle: "Kuingia kwa Mfanyakazi",
          workerBtn: "Ingia kama Mfanyakazi",
          childNames: "Majina MAWILI ya mtoto",
          parentPhone: "Namba ya simu +2550XXXXXXXXX",
          workerName: "Majina MATATU (mf. John Doe Junior)",
          workerPhone: "Namba ya simu +2550XXXXXXXXX",
        },
      };

      function applyLang(lang) {
        document.querySelectorAll("[data-i18n]").forEach((el) => {
          el.textContent = translations[lang][el.dataset.i18n];
        });
        document.querySelectorAll("[data-i18n-placeholder]").forEach((el) => {
          el.placeholder = translations[lang][el.dataset.i18nPlaceholder];
        });
        localStorage.setItem("lang", lang);
      }

      const lang = localStorage.getItem("lang") || "en";
      document.getElementById("langSelect").value = lang;
      applyLang(lang);
      document.getElementById("langSelect").onchange = (e) =>
        applyLang(e.target.value);

      /* ---------- FIREBASE ---------- */
      firebase.initializeApp({
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
      });

      const auth = firebase.auth();
      const db = firebase.database();

      /* ---------- HELPERS ---------- */
      function namesMatch(studentData, inputNames) {
        const parts = inputNames
          .toLowerCase()
          .split(/\s+/)
          .filter((w) => w.length >= 2);
        if (parts.length < 2) return false;

        for (const st of Object.values(studentData)) {
          const full = `${st.firstName || ""} ${st.middleName || ""} ${
            st.lastName || ""
          }`.toLowerCase();
          let matches = 0;
          parts.forEach((p) => {
            if (full.includes(p)) matches++;
          });
          if (matches >= 2) return true;
        }
        return false;
      }
      function normalizePhone(phone) {
        if (!phone) return "";
        phone = phone.trim().replace(/[\s-()]/g, "");

        if (phone.match(/^0\d{9}$/)) return "+255" + phone.slice(1);
        if (phone.startsWith("+")) return phone;
        if (phone.match(/^255\d{9}$/)) return "+" + phone;

        return phone;
      }

      /* ---------- STAFF LOGIN ---------- */
      document.getElementById("googleLogin").onclick = async () => {
        if (!grecaptcha.getResponse()) {
          Swal.fire(
            "Verification required",
            "Please complete the CAPTCHA",
            "warning"
          );
          return;
        }
        await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
      };

      /* ---------- AUTH STATE ---------- */
      auth.onAuthStateChanged(async (user) => {
        // DEVICE-BASED WORKER AUTO-LOGIN
        if (user?.uid) {
          const d = await db.ref(`devices/${user.uid}/workerId`).once("value");
          if (d.exists()) {
            localStorage.setItem("role", "worker");
            localStorage.setItem("workerId", d.val());
            sessionStorage.setItem("workerDashboardActive", "true");
            location.href = "workershtml/workersdashboard.html";
            return;
          }
        }

        if (!user?.email) return;

        const key = user.email.replace(/\./g, "_");
        const snap = await db.ref(SOMAP.P("users/" + key)).once("value");
        const role = snap.val()?.role;

        if (role === "admin") location.href = "dashboard.html";
        else if (role === "teacher") location.href = "staff.html";
        else if (role === "accountant") location.href = "mhasibu.html";
      });

      /* ---------- PARENT LOGIN ---------- */
      document.getElementById("parentForm").onsubmit = async (e) => {
        e.preventDefault();

        const namesInput = document
          .getElementById("childNames")
          .value.trim()
          .toLowerCase();
        const rawPhone = document.getElementById("parentPhone").value;
        const normalizedPhone = normalizePhone(rawPhone);

        const names = namesInput.split(/\s+/).filter(Boolean);
        const err = document.getElementById("parentError");
        err.classList.add("hidden");

        // NORMAL STUDENTS
        const snap = await db.ref(SOMAP.P("students")).once("value");
        let found = null;

        snap.forEach((s) => {
          const st = s.val();
          const full = `${st.firstName || ""} ${st.middleName || ""} ${
            st.lastName || ""
          }`.toLowerCase();

          const dbPhone = normalizePhone(
            st.parentPhone ||
              st.parentContact ||
              st.primaryParentContact ||
              st.primaryParentPhone ||
              ""
          );

          if (
            names.every((n) => full.includes(n)) &&
            dbPhone === normalizedPhone
          ) {
            found = s.key;
          }
        });

        if (found) {
          localStorage.setItem("role", "parent");
          localStorage.setItem("studentKey", found);
          location.href = "parent.html";
          return;
        }

        // PREFORM ONE FALLBACK
        const year = new Date().getFullYear();
        const pre = await db
          .ref(`/schools/Socrates School Preform one/${year}/students`)
          .orderByChild("parentContact")
          .equalTo(normalizedPhone)

          .once("value");

        if (pre.exists() && namesMatch(pre.val(), namesInput)) {
          localStorage.setItem("role", "parent");
          localStorage.setItem("preformParent", "true");
          localStorage.setItem("studentKey", Object.keys(pre.val())[0]);
          Swal.fire("Welcome to Preform One", "Access granted", "success");
          setTimeout(
            () => (location.href = "preformonehtml/prefoneparent.html"),
            900
          );
          return;
        }

        err.textContent = "No matching student found";
        err.classList.remove("hidden");
      };

      /* ---------- WORKER LOGIN ---------- */
      document.getElementById("workerForm").onsubmit = async (e) => {
        e.preventDefault();
        const name = document
          .getElementById("workerName")
          .value.trim()
          .toUpperCase();
        const phone = document.getElementById("workerPhone").value.trim();
        const err = document.getElementById("workerError");
        err.classList.add("hidden");

        const snap = await db.ref(SOMAP.P("workers")).once("value");
        let found = null;
        snap.forEach((w) => {
          const p = w.val().profile || {};
          if (p.fullNameUpper === name && p.phone === phone) found = w.key;
        });

        if (!found) {
          err.textContent = "Worker not found";
          err.classList.remove("hidden");
          return;
        }

        localStorage.setItem("role", "worker");
        localStorage.setItem("workerId", found);
        location.href = "workershtml/workersdashboard.html";
      };

      /* ---------- QUICK PARENT TOAST ---------- */
      (function () {
        if (localStorage.getItem("role") !== "parent") return;
        if (!localStorage.getItem("studentKey")) return;

        const t = document.createElement("div");
        t.style.cssText =
          "position:fixed;right:12px;bottom:12px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;z-index:9999;font-size:13px";
        t.innerHTML = `Signed in as parent — <a href="parent.html" style="color:#60a5fa;font-weight:600">Open dashboard</a>`;
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 7000);
      })();
    </script>

    <!-- SERVICE WORKER -->
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then(() => console.log("SoMAp Service Worker registered"))
          .catch((err) => console.error("SW failed", err));
      }
    </script>
  </body>
</html>
