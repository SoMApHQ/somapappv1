<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SoMAp â€” Welcome</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      *,
      *::before,
      *::after {
        box-sizing: border-box;
      }
      .app-header h1,
      .app-header .title,
      .section h1,
      .section h2,
      .section h3,
      .section p,
      .card,
      .card *,
      .stat-card,
      .stat-card *,
      .badge,
      .pill,
      .menu-group h3,
      .workspace .grid,
      .workspace .grid * {
        white-space: normal !important;
        overflow-wrap: anywhere;
        word-break: break-word;
      }
      .workspace,
      .section,
      .card,
      .stat-card,
      .grid,
      .row {
        min-width: 0;
      }
      .layout-row,
      .grid,
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }
      .card,
      .stat-card {
        flex: 1 1 280px;
        min-width: 240px;
      }
      img,
      video,
      canvas {
        max-width: 100%;
        height: auto;
      }
      .workspace {
        margin-left: 0;
      }
      @media (max-width: 768px) {
        .workspace {
          margin-left: 0;
        }
      }
      @media (max-width: 560px) {
        .workspace {
          margin-left: 0;
        }
      }
      :root {
        --primary: #4f46e5;
        --secondary: #818cf8;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #06b6d4;
        --light-bg: #f9fafb;
        --border: #e5e7eb;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, sans-serif;
        overflow-x: hidden;
        background: linear-gradient(135deg, #007bff, #6610f2);
        color: #fff;
        min-height: 100vh;
      }
      .sidebar-icon {
        position: relative;
        transition: all 0.3s;
      }
      .sidebar-icon:hover {
        background-color: rgba(79, 70, 229, 0.1);
      }
      .sidebar-icon.active {
        background-color: var(--primary);
        color: white;
      }
      .sidebar-tooltip {
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        background: #1f2937;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        opacity: 0;
        pointer-events: none;
        transition: all 0.2s;
        z-index: 100;
        white-space: nowrap;
      }
      .sidebar-icon:hover .sidebar-tooltip {
        opacity: 1;
        transform: translateY(-50%) translateX(8px);
      }
      .module-panel {
        transition: transform 0.3s ease-in-out;
        transform: translateX(100%);
        box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
      }
      .module-panel.active {
        transform: translateX(0);
      }
      .card {
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        transition: all 0.3s;
        background: linear-gradient(135deg, #ffffff, #e5e7eb);
        color: #000;
      }
      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
          0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .stat-card {
        transition: all 0.3s;
        background: linear-gradient(135deg, #20c997, #0dcaf0);
        color: #fff;
      }
      .stat-card:hover {
        transform: translateY(-3px);
      }
      .btn {
        transition: all 0.2s;
      }
      .btn:hover {
        transform: translateY(-1px);
      }
      .btn:active {
        transform: translateY(0);
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      .loader {
        border-top-color: var(--primary);
        animation: spinner 0.6s linear infinite;
      }
      @keyframes spinner {
        to {
          transform: rotate(360deg);
        }
      }
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }
      .workspace {
        flex: 1 1 auto;
        min-width: 0;
        overflow-x: hidden;
        overflow-y: auto;
        background: linear-gradient(135deg, #007bff, #6610f2);
        padding: 1rem;
        transition: margin-left 0.3s ease;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        max-width: 100%;
        word-break: break-word;
      }
      .stat-card .mt-4,
      .card .mt-4 {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      @media (min-width: 1024px) {
        .grid {
          gap: 2rem;
        }
        .workspace {
          padding: 1.5rem;
        }
      }
      @media (max-width: 767px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .workspace {
          padding: 0.5rem;
        }
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.1);
        }
        100% {
          transform: scale(1);
        }
      }
      .badge-pulse {
        animation: pulse 2s infinite;
      }
      .sidebar-logo {
        height: 40px;
        width: auto;
        max-width: 100%;
        display: block;
        margin: 0 auto;
      }
      .sidebar-expanded .sidebar-logo {
        height: 48px;
      }
      @media (max-width: 480px) {
        .sidebar-logo {
          height: 32px;
        }
      }
      .navbar {
        background: linear-gradient(135deg, #28a745, #20c997);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .sidebar {
        background: linear-gradient(to bottom, #fd7e14, #ffc107);
        height: 100vh;
        padding: 20px;
        position: fixed;
        width: 64px;
        overflow-y: auto;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        transition: width 0.3s ease;
      }
      .sidebar-expanded .sidebar {
        width: 250px;
      }
      .sidebar a,
      .sidebar button {
        color: #fff;
        text-decoration: none;
        display: block;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        transition: background 0.3s;
      }
      .sidebar a:hover,
      .sidebar button:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      .main-content {
        margin-left: 64px;
        padding: 20px;
        transition: margin-left 0.3s ease;
      }
      .sidebar-expanded .main-content {
        margin-left: 250px;
      }
      .welcome-note {
        background: linear-gradient(135deg, #6f42c1, #d63384);
        padding: 50px;
        text-align: center;
        border-radius: 20px;
        margin: 50px auto;
        max-width: 800px;
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      }
      .market-section {
        background: linear-gradient(135deg, #dc3545, #fd7e14);
        padding: 30px;
        border-radius: 15px;
        color: #fff;
      }
      .market-img {
        width: 100%;
        height: 250px;
        object-fit: cover;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      }
      .quick-action-btn {
        background: linear-gradient(135deg, #198754, #20c997);
        color: #fff;
        border: none;
        margin: 10px;
        padding: 15px 30px;
        border-radius: 10px;
        font-weight: bold;
        transition: opacity 0.3s;
      }
      .quick-action-btn:hover {
        opacity: 0.9;
      }
      #language-select {
        margin: 20px auto;
        width: 200px;
        background: #fff;
        color: #000;
        border: 2px solid #ced4da;
        border-radius: 10px;
      }
      .events-list {
        list-style: none;
        padding: 0;
      }
      .events-list li {
        background: #fff;
        color: #000;
        padding: 15px;
        margin: 10px 0;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .chart-container {
        background: #fff;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
      }
      .footer {
        background-color: #343a40;
        color: #fff;
        padding: 20px;
        text-align: center;
        margin-top: 50px;
        border-top: 2px solid #fff;
      }
      .role-specific {
        display: none;
      }
      .module-section {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        color: #000;
      }
      .attendance-trends {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
      }
      .discipline-card {
        background: linear-gradient(135deg, #dc3545, #f55);
      }
      .finance-overview {
        background: linear-gradient(135deg, #28a745, #198754);
      }
      .resource-card {
        background: linear-gradient(135deg, #0dcaf0, #20c997);
      }
      .communication-stats {
        background: linear-gradient(135deg, #6610f2, #6f42c1);
      }
      .ai-insights {
        background: linear-gradient(135deg, #d63384, #dc3545);
        color: #fff;
      }
      .volunteer-section {
        background: linear-gradient(135deg, #ffc107, #ffca2c);
      }
      .calendar {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
      }
      .hidden {
        display: none;
      }
      .btn-custom {
        background-color: #6f42c1;
        color: #fff;
        border-radius: 50px;
        padding: 10px 20px;
      }
      .form-control-custom {
        border-radius: 10px;
        border: 2px solid #ced4da;
        transition: all 0.3s;
      }
      .form-control-custom:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
      }
      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        color: #fff;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }
      .card h5,
      .card p,
      .events-list li {
        color: #000;
        text-shadow: none;
      }
      p {
        line-height: 1.6;
      }
      .img-fluid {
        border-radius: 10px;
      }
      .section-padding {
        padding: 40px 0;
      }
      .card-body {
        padding: 20px;
      }
      .finance-card {
        background: linear-gradient(135deg, #28a745, #198754);
        color: #fff;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .finance-card h5 {
        color: #fff;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }
      .finance-card p {
        font-size: 1.5rem;
        font-weight: bold;
      }
      .btn-google {
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border: 1px solid #dadce0;
        border-radius: 10px;
        padding: 15px 30px;
        font-size: 1rem;
        color: #3c4043;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
        width: 100%;
        margin: 10px 0;
        font-weight: bold;
      }
      .btn-google:hover {
        background: #f1f3f4;
        transform: translateY(-1px);
      }
      .btn-google img {
        height: 20px;
        margin-right: 0.5rem;
      }
      .error {
        color: #d93025;
        font-size: 0.9rem;
        margin-top: 0.5rem;
      }
      .g-recaptcha {
        margin: 1rem auto;
      }
      #login-page .card {
        max-width: 500px;
        margin: 0 auto;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        border-radius: 1rem;
        overflow: hidden;
        animation: fadeIn 0.5s ease-in-out;
      }
      #login-page h2 {
        color: var(--primary);
        font-weight: bold;
      }
      #login-page h3 {
        color: #333;
      }
      #login-page .form-label {
        font-weight: 500;
        color: #444;
      }
      #login-page .input-group-text {
        background-color: #f8f9fa;
        border: 2px solid #ced4da;
        border-right: none;
        border-radius: 10px 0 0 10px;
        color: #6c757d;
      }
      #login-page .form-control-custom {
        border-left: none;
        border-radius: 0 10px 10px 0;
      }
      #login-page .quick-action-btn {
        background: linear-gradient(135deg, #4f46e5, #818cf8);
        transition: all 0.3s;
      }
      #login-page .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(79, 70, 229, 0.3);
      }
      #login-page hr {
        border-top: 1px solid #dee2e6;
      }
      #login-page .text-gray-600 {
        color: #6c757d !important;
      }
    </style>
  </head>

  <body class="bg-gradient-to-br from-blue-500 to-purple-600 overflow-hidden">
    <div class="flex h-screen overflow-hidden">
      <div
        class="workspace flex-1 min-w-0 overflow-x-hidden overflow-y-auto bg-gradient-to-br from-blue-500 to-purple-600 transition-all"
      >
        <header class="bg-white shadow-sm">
          <div class="flex items-center justify-between px-6 py-3">
            <div>
              <h1 id="page-title" class="text-xl font-semibold text-gray-800">
                SoMAp - SOCIETY MANAGEMENT APP
              </h1>
            </div>
            <div class="flex items-center space-x-4">
              <div class="relative">
                <input
                  type="text"
                  class="px-4 py-2 rounded-lg border focus:outline-none focus:ring-2 focus:ring-indigo-500 w-64"
                  placeholder="Search..."
                />
                <i
                  class="fas fa-search absolute right-3 top-3 text-gray-400"
                ></i>
              </div>
              <button class="p-2 rounded-lg hover:bg-gray-100">
                <i class="far fa-bell text-gray-500 relative">
                  <span
                    class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center"
                    >3</span
                  >
                </i>
              </button>
              <button
                id="sign-out"
                class="p-2 rounded-lg hover:bg-gray-100 hidden"
              >
                <i class="fas fa-sign-out-alt text-gray-500"></i>
              </button>
            </div>
          </div>
        </header>
        <div id="welcome-page" class="container section-padding">
          <div class="welcome-note">
            <h1 id="welcome-title">
              Welcome to SoMAp - The Best School Management System
            </h1>
            <p id="welcome-text">
              Transform your school with our integrated SuperApp. Manage
              academics, finances, attendance, and more effortlessly. Connect
              parents, boost performance, and explore SoMAp Market for uniforms,
              supplies, and essentials. Inspired by top systems for excellence
              in Tanzania's education.
            </p>
            <select
              id="language-select"
              class="form-select form-control-custom"
            >
              <option value="en">English</option>
              <option value="sw">Swahili</option>
            </select>
            <button
              id="get-started"
              class="btn btn-lg btn-custom quick-action-btn"
              onclick="window.location.href='somapappv1multischool/multischool.html'"
            >
              Get Started
            </button>
          </div>
          <section class="section-padding">
            <h2>Everything You Need to Run Your School</h2>
            <p>
              From admissions to graduation, SoMAp handles every aspect of
              school management
            </p>
            <div class="grid">
              <div class="card">
                <h3>Academic Management</h3>
                <p>
                  Manage admissions, classes, timetables, examinations, and
                  student records
                </p>
              </div>
              <div class="card">
                <h3>Financial Management</h3>
                <p>
                  Real-time fee tracking with M-Pesa, Airtel Money, and bank
                  integrations
                </p>
              </div>
              <div class="card">
                <h3>Digital Library</h3>
                <p>
                  Secure content repository with role-based access and version
                  control
                </p>
              </div>
              <div class="card">
                <h3>Communication Hub</h3>
                <p>
                  SMS alerts, announcements, and real-time messaging platform
                </p>
              </div>
              <div class="card">
                <h3>Marketplace</h3>
                <p>
                  Integrated store for uniforms, books, stationery, and
                  transport payments
                </p>
              </div>
              <div class="card">
                <h3>AI Analytics</h3>
                <p>
                  Smart insights for academic performance and fee collection
                  predictions
                </p>
              </div>
              <div class="card">
                <h3>Sponsorship</h3>
                <p>
                  Transparent donor management with impact tracking and
                  reporting
                </p>
              </div>
              <div class="card">
                <h3>Volunteer Management</h3>
                <p>
                  Track international volunteers with secure contact management
                </p>
              </div>
            </div>
          </section>
          <section class="section-padding text-center">
            <h2>Ready to Transform Your School Management?</h2>
            <p>
              Join hundreds of Tanzanian schools already using SoMAp to
              streamline their operations
            </p>
            <button
              id="start-trial"
              class="btn btn-lg btn-custom quick-action-btn"
            >
              Start Your Free Trial
            </button>
          </section>
          <p class="text-center">
            SoMAp - Empowering Tanzanian schools with comprehensive management
            solutions
          </p>
        </div>
        <section id="login-section">
          <div id="login-page" class="container section-padding hidden">
            <div class="card p-4">
              <h2 class="text-center mb-4">Sign In to SoMAp</h2>
              <div class="mb-4">
                <h3 class="text-lg font-semibold mb-2">Staff Sign-In</h3>
                <p class="text-center text-gray-600 mb-3">
                  Use your school Google account
                </p>
                <div
                  class="g-recaptcha mb-3"
                  data-sitekey="6LekDsorAAAAAOkhrg-3PKJCHEpBN1HYQQzca83x"
                ></div>
                <button id="google-signin" class="btn-google">
                  <img
                    src="https://developers.google.com/identity/images/g-logo.png"
                    alt="Google"
                  />
                  Sign in with Google
                </button>
              </div>
              <hr class="my-4" />
              <div>
                <h3 class="text-lg font-semibold mb-2">Parent Sign-In</h3>
                <p class="text-center text-gray-600 mb-3">
                  Use any two or more of your child's names and phone number
                </p>
                <form id="parent-signin">
                  <div class="mb-3">
                    <label for="child-name" class="form-label"
                      >Child's Names</label
                    >
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="fas fa-user"></i
                      ></span>
                      <input
                        type="text"
                        class="form-control form-control-custom"
                        id="child-name"
                        placeholder="e.g., Mnyore Joseph Omondi"
                        required
                      />
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="parent-phone" class="form-label"
                      >Parent Phone Number</label
                    >
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="fas fa-phone"></i
                      ></span>
                      <input
                        type="tel"
                        class="form-control form-control-custom"
                        id="parent-phone"
                        placeholder="e.g., +255123456789"
                        required
                      />
                    </div>
                  </div>
                  <button
                    type="submit"
                    class="btn btn-success btn-lg w-100 quick-action-btn"
                  >
                    Sign In as Parent
                  </button>
                </form>
              </div>
              <hr class="my-4" />
              <div>
                <h3 class="text-lg font-semibold mb-2">Worker Sign-In</h3>
                <p class="text-center text-gray-600 mb-3">
                  Enter THREE NAMES (any spacing, case-insensitive) and phone
                  starting with +2550.
                </p>
                <form id="worker-login-form">
                  <div class="mb-3">
                    <label for="worker-full-name" class="form-label"
                      >Full Name (Three Names)</label
                    >
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="fas fa-user-tie"></i
                      ></span>
                      <input
                        type="text"
                        class="form-control form-control-custom"
                        id="worker-full-name"
                        placeholder="e.g., John Doe Junior"
                        required
                      />
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="worker-phone" class="form-label"
                      >Phone Number (+2550xxxxxxxxx)</label
                    >
                    <div class="input-group">
                      <span class="input-group-text"
                        ><i class="fas fa-phone"></i
                      ></span>
                      <input
                        type="tel"
                        class="form-control form-control-custom"
                        id="worker-phone"
                        placeholder="+2550XXXXXXXXX"
                        required
                      />
                    </div>
                  </div>
                  <button
                    type="submit"
                    class="btn btn-primary btn-lg w-100 quick-action-btn"
                    id="worker-login-btn"
                  >
                    Sign In as Worker
                  </button>
                </form>
                <div
                  id="worker-error"
                  class="error hidden text-center mt-3"
                ></div>
              </div>
              <div id="error-message" class="error hidden text-center mt-3"></div>
            </div>
          </div>
        </section>
        <footer class="footer">
          <div class="container">
            <strong>SoMAp</strong> â€” School & Society Management
            <div class="text-sm mt-2">
              Project: somaptestt | Contact: mnyorej@gmail.com
            </div>
            <div class="mt-4 text-sm">
              &copy; <span id="year"></span> SoMAp â€” Built for African schools.
            </div>
          </div>
        </footer>
      </div>
    </div>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
        authDomain: "somaptestt.firebaseapp.com",
        databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
        projectId: "somaptestt",
        storageBucket: "somaptestt.appspot.com",
        messagingSenderId: "105526245138",
        appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      };
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      const auth = firebase.auth();
      const db = firebase.database();

      function hasLoginIntent() {
        const params = new URLSearchParams(window.location.search);
        // We only force login view if explicitly requested via URL (e.g. from multischool redirect)
        return (
          params.get("login") === "1" ||
          window.location.hash === "#login"
        );
      }

            // ƒo. Show login panel on this page (used when returning with ?login=1)
      function goToLogin() {
        const welcome = document.getElementById("welcome-page");
        const login = document.getElementById("login-page");
        const signoutBtn = document.getElementById("sign-out");
        if (welcome) welcome.classList.add("hidden");
        if (login) login.classList.remove("hidden");
        if (signoutBtn) signoutBtn.classList.remove("hidden");
      }

      // ƒo. Redirect to multischool hub after Get Started
      function goToHub() {
        window.location.href = "somapappv1multischool/multischool.html";
      }

      // Attach listeners safely after DOM is ready (covers Get Started + Start Trial)
      document.addEventListener("DOMContentLoaded", () => {
        const getStartedBtn = document.getElementById("get-started");
        const startTrialBtn = document.getElementById("start-trial");
        const shouldShowLogin = hasLoginIntent();

        if (shouldShowLogin) {
          goToLogin();
          const loginSection = document.getElementById("login-section");
          if (loginSection) {
            loginSection.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }

        [getStartedBtn, startTrialBtn].forEach((btn) => {
          if (btn) btn.addEventListener("click", goToHub);
        });
      });

      const WORKER_PHONE_REGEX = /^\+2550\d{9}$/;

      function normalizeThreeNames(rawName) {
        if (!rawName) throw new Error("Please enter your full name.");
        const tokens = rawName.trim().split(/\s+/).filter(Boolean);
        if (tokens.length !== 3) {
          throw new Error("Enter exactly three names (First Middle Last).");
        }
        return tokens.map((t) => t.toUpperCase()).join(" ");
      }

      async function sha256Hex(value) {
        const encoder = new TextEncoder();
        const data = encoder.encode(value);
        const hashBuffer = await crypto.subtle.digest("SHA-256", data);
        return Array.from(new Uint8Array(hashBuffer))
          .map((b) => b.toString(16).padStart(2, "0"))
          .join("");
      }

      const workerForm = document.getElementById("worker-login-form");
      if (workerForm) {
        workerForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const btn = document.getElementById("worker-login-btn");
          const errorEl = document.getElementById("worker-error");
          errorEl.classList.add("hidden");
          errorEl.textContent = "";

          const fullNameInput = document.getElementById("worker-full-name");
          const phoneInput = document.getElementById("worker-phone");
          const rawName = (fullNameInput.value || "").trim();
          const rawPhone = (phoneInput.value || "").trim();

          // Allow ANY spacing, force to CAPITALS, but still require THREE parts
          function normalizeThreeNamesLoose(name) {
            const s = String(name).toUpperCase().replace(/\s+/g, " ").trim(); // squish weird spaces
            const parts = s.split(" ");
            if (parts.length !== 3)
              throw new Error(
                "Enter THREE names (e.g., JOHN DOE JUNIOR). Spacing doesnâ€™t matter."
              );
            return parts.join(" ");
          }
          const WORKER_PHONE_REGEX = /^\+2550\d{9}$/;

          async function sha256Hex(value) {
            const encoder = new TextEncoder();
            const data = encoder.encode(value);
            const hashBuffer = await crypto.subtle.digest("SHA-256", data);
            return Array.from(new Uint8Array(hashBuffer))
              .map((b) => b.toString(16).padStart(2, "0"))
              .join("");
          }

          try {
            btn.disabled = true;
            btn.textContent = "Signing In...";

            const normalizedName = normalizeThreeNamesLoose(rawName); // JOHN DOE JUNIOR
            if (!WORKER_PHONE_REGEX.test(rawPhone)) {
              throw new Error(
                "Phone must start with +2550 followed by 9 digits."
              );
            }

            // Search directly in /workers/ by matching fullNameUpper and phone
            const workersSnap = await db.ref("workers").once("value");
            if (!workersSnap.exists()) {
              throw new Error("No workers in database. Contact admin.");
            }

            const workers = workersSnap.val();
            let foundWorkerId = null;

            // Find worker by matching fullNameUpper and phone
            for (const [id, worker] of Object.entries(workers)) {
              const profile = worker?.profile || {};
              if (
                profile.fullNameUpper === normalizedName &&
                profile.phone === rawPhone
              ) {
                foundWorkerId = id;
                break;
              }
            }

            if (!foundWorkerId) {
              throw new Error(
                "Worker not found. Confirm THREE NAMES and phone with HR."
              );
            }

            const workerId = foundWorkerId;

            // âœ… Clear any old data first, then save new login
            localStorage.clear(); // Remove any stale data
            localStorage.setItem("role", "worker");
            localStorage.setItem("workerId", workerId);

            console.log("âœ… Login successful! Worker ID:", workerId);
            window.location.href = "workershtml/workersdashboard.html";
          } catch (err) {
            errorEl.textContent = err.message || "Worker login failed.";
            errorEl.classList.remove("hidden");
          } finally {
            btn.disabled = false;
            btn.textContent = "Sign In as Worker";
          }
        });
      }

      // Helper function for Preform One: Match at least 2 names (case-insensitive) in student data
      function namesMatch(studentData, inputNames) {
        if (!studentData || !inputNames) return false;
        const inputs = inputNames
          .toLowerCase()
          .split(/\s+/)
          .filter((word) => word.length >= 2); // Split into words >=2 letters
        if (inputs.length < 2) return false;
        let totalMatches = 0;
        for (const student of Object.values(studentData)) {
          const fullName = `${student.firstName || ""} ${
            student.middleName || ""
          } ${student.lastName || ""}`.toLowerCase();
          let studentMatches = 0;
          for (const inputWord of inputs) {
            if (fullName.includes(inputWord)) studentMatches++;
          }
          if (studentMatches >= 2) {
            totalMatches += studentMatches; // Found a match
            break; // Stop on first full match
          }
        }
        return totalMatches >= 2;
      }
      function normalizePhone(phone) {
        if (!phone) return "";
        phone = phone.trim().replace(/[\s-()]/g, "");
        if (phone.match(/^0\d{9}$/)) return "+254" + phone.slice(1);
        if (phone.startsWith("+")) return phone;
        if (phone.match(/^254\d{9}$/) || phone.match(/^255\d{9}$/))
          return "+" + phone;
        return phone;
      }
      function nameFragments(name) {
        if (!name) return [];
        return name
          .toLowerCase()
          .split(/\s+/)
          .map((s) => s.trim())
          .filter(Boolean)
          .filter((s) => s.length >= 2);
      }
      document.getElementById("year").textContent = new Date().getFullYear();

      const translations = {
        en: {
          welcomeTitle: "Welcome to SoMAp - The Best School Management System",
          welcomeText:
            "Transform your school with our integrated SuperApp. Manage academics, finances, attendance, and more effortlessly. Connect parents, boost performance, and explore SoMAp Market for uniforms, supplies, and essentials. Inspired by top systems for excellence in Tanzania's education.",
          getStarted: "Get Started",
        },
        sw: {
          welcomeTitle: "Karibu kwa SoMAp - Mfumo Bora wa Usimamizi wa Shule",
          welcomeText:
            "Badilisha shule yako na SuperApp yetu iliyounganishwa. Simamia masomo, fedha, mahudhurio, na zaidi kwa urahisi. Unganisha wazazi, ongeza utendaji, na chunguza SoMAp Market kwa uniformu, vifaa, na mahitaji. Imechochewa na mifumo ya juu kwa ubora katika elimu ya Tanzania.",
          getStarted: "Anza",
        },
      };

      document
        .getElementById("language-select")
        .addEventListener("change", (e) => {
          const lang = e.target.value;
          document.getElementById("welcome-title").textContent =
            translations[lang].welcomeTitle;
          document.getElementById("welcome-text").textContent =
            translations[lang].welcomeText;
          document.getElementById("get-started").textContent =
            translations[lang].getStarted;
        });

      // (get-started click now handled by goToLogin)

      // (start-trial click now handled by goToLogin)

      document.getElementById("sign-out").addEventListener("click", () => {
        auth
          .signOut()
          .then(() => {
            localStorage.removeItem("role");
            localStorage.removeItem("class");
            localStorage.removeItem("studentKey");
            document.getElementById("login-page").classList.add("hidden");
            document.getElementById("welcome-page").classList.remove("hidden");
            document.getElementById("sign-out").classList.add("hidden");
            Swal.fire("Success", "You have been signed out.", "success");
          })
          .catch((err) => {
            Swal.fire("Error", "Sign-out failed: " + err.message, "error");
          });

      document
        .getElementById("google-signin")
        .addEventListener("click", async () => {
          try {
            const response = grecaptcha.getResponse();
            if (!response) {
              document.getElementById("error-message").textContent =
                "Please complete the CAPTCHA";
              document
                .getElementById("error-message")
                .classList.remove("hidden");
              return;
            }
            const provider = new firebase.auth.GoogleAuthProvider();
            const result = await auth.signInWithPopup(provider);
            const user = result.user;
            if (!user || !user.email) {
              Swal.fire(
                "Error",
                "Google sign-in failed to return user email",
                "error"
              );
              return;
            }
            const emailKey = user.email.replace(/\./g, "_");
            const snap = await db.ref("users/" + emailKey).once("value");
            const userData = snap.val();
            if (!userData) {
              Swal.fire(
                "Unauthorized",
                "Your Google account is not registered. Contact admin.",
                "error"
              );
              await auth.signOut();
              return;
            }
            localStorage.setItem("role", userData.role || "");
            if (userData.class) localStorage.setItem("class", userData.class);
            // Preform One access flags (safe addition - no route changes)
            const currentYear = new Date().getFullYear(); // Auto 2025
            if (user.email === "ssclass72023@gmail.com") {
              localStorage.setItem("preformAccess", "true"); // Enables icon in staff.html
            }
            if (user.email === "socratesschool2020@gmail.com") {
              localStorage.setItem("adminAccess", "true"); // Full access for dashboard.html
            }
            if (userData.role === "accountant") {
              window.location.href = "mhasibu.html";
            } else if (userData.role === "teacher") {
              window.location.href = "staff.html";
            } else if (userData.role === "admin") {
              window.location.href = "dashboard.html";
            }
          } catch (err) {
            document.getElementById("error-message").textContent =
              "Sign-in failed: " + err.message;
            document.getElementById("error-message").classList.remove("hidden");
          }
        });

      document
        .getElementById("parent-signin")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = document.querySelector("#parent-signin button");
          try {
            btn.disabled = true;
            btn.textContent = "Signing In...";
            const rawName = document.getElementById("child-name").value.trim();
            const rawPhone = document
              .getElementById("parent-phone")
              .value.trim();
            const msgEl = document.getElementById("error-message");
            if (!rawName || !rawPhone) {
              msgEl.textContent = "Please enter child names and parent phone.";
              msgEl.classList.remove("hidden");
              btn.disabled = false;
              btn.textContent = "Sign In as Parent";
              return;
            }
            const phone = normalizePhone(rawPhone);
            if (!phone.match(/^\+(254|255)\d{8,9}$/)) {
              msgEl.textContent =
                "Phone format invalid. Use +254 or +255. Example: +254724841852";
              msgEl.classList.remove("hidden");
              btn.disabled = false;
              btn.textContent = "Sign In as Parent";
              return;
            }
            const fragments = nameFragments(rawName);
            if (fragments.length < 2) {
              msgEl.textContent =
                "Enter at least two name parts of your child.";
              msgEl.classList.remove("hidden");
              btn.disabled = false;
              btn.textContent = "Sign In as Parent";
              return;
            }
            const studentsSnap = await db.ref("students").once("value");
            const studentsObj = studentsSnap.val() || {};
            let foundKey = null;
            let foundStudent = null;
            for (const [key, s] of Object.entries(studentsObj)) {
              const dbPhone = normalizePhone(
                s.primaryParentContact || s.primaryParentPhone || ""
              );
              if (!dbPhone || dbPhone !== phone) continue;
              const childNames = [
                (s.firstName || "").toLowerCase(),
                (s.middleName || "").toLowerCase(),
                (s.lastName || "").toLowerCase(),
              ].filter(Boolean);
              let matches = 0;
              for (const frag of fragments) {
                if (childNames.some((cn) => cn.includes(frag))) matches++;
              }
              if (matches >= 2) {
                foundKey = key;
                foundStudent = s;
                break;
              }
            }
            btn.disabled = false;
            btn.textContent = "Sign In as Parent";

            // Preform One check (parallel query - fallback to regular if no match)
            const currentYear2 = new Date().getFullYear(); // Auto 2025
            const phoneNorm = phone; // Use normalized phone
            const inputNamesFull = rawName; // Full input for matching

            const preformSnap = await db
              .ref(
                `/schools/Socrates School Preform one/${currentYear2}/students`
              )
              .orderByChild("parentContact")
              .equalTo(phoneNorm)
              .once("value");
            if (preformSnap.exists()) {
              const preformData = preformSnap.val();
              if (namesMatch(preformData, inputNamesFull)) {
                // Direct to Preform One parent dashboard
                localStorage.setItem("role", "parent");
                localStorage.setItem("preformParent", "true");
                // PF1 keys expected by prefoneparent.html
                localStorage.setItem("prefoneParent", "true");
                localStorage.setItem("prefoneParentContact", phoneNorm);
                localStorage.setItem("prefoneParentName", inputNamesFull);
                // Compatibility keys used elsewhere
                localStorage.setItem("parentContact", phoneNorm);
                localStorage.setItem("parentName", inputNamesFull);
                // Also set studentKey and default ADM for quick actions (use first match key)
                const preformKeys = Object.keys(preformData);
                if (preformKeys.length) {
                  localStorage.setItem("studentKey", preformKeys[0]);
                  localStorage.setItem("currentChildAdm", preformKeys[0]);
                }
                Swal.fire({
                  title: "Welcome to Preform One",
                  text: `Access granted for Preform One student`,
                  icon: "success",
                  timer: 1100,
                  showConfirmButton: false,
                });
                setTimeout(() => {
                  window.location.href = "preformonehtml/prefoneparent.html";
                }, 900);
                return; // Exit early - don't run regular logic
              }
            }

            if (!foundStudent) {
              msgEl.textContent =
                "No matching student found. Check names and phone.";
              msgEl.classList.remove("hidden");
              return;
            }

            localStorage.setItem("role", "parent");
            localStorage.setItem("studentKey", foundKey);
            // Enable Preform One icon for Class 7 parents (if applicable)
            if (
              foundStudent.classLevel === "Class 7" ||
              foundStudent.class === "Class 7"
            ) {
              // Adjust field if your DB uses 'class' instead
              localStorage.setItem("preformParentIcon", "true"); // Shows icon in parent.html
            }
            Swal.fire({
              title: "Welcome",
              text: `Signed in for ${foundStudent.firstName || ""} ${
                foundStudent.lastName || ""
              }`,
              icon: "success",
              timer: 1100,
              showConfirmButton: false,
            });
            setTimeout(() => {
              window.location.href = "parent.html";
            }, 900);
          } catch (err) {
            btn.disabled = false;
            btn.textContent = "Sign In as Parent";
            document.getElementById("error-message").textContent =
              "Sign-in failed: " + err.message;
            document.getElementById("error-message").classList.remove("hidden");
          }
        });

      auth.onAuthStateChanged(async (user) => {
        // Don't interfere if worker dashboard is active
        if (sessionStorage.getItem("workerDashboardActive") === "true") {
          console.log("Worker dashboard active, skipping auth check");
          return;
        }

        if (!user) {
          localStorage.removeItem("role");
          localStorage.removeItem("class");
          localStorage.removeItem("studentKey");
          
          // Check if we should show login page instead of welcome (e.g. redirected from multischool)
          const forceLoginView = hasLoginIntent();
          if (forceLoginView) {
            document.getElementById("welcome-page").classList.add("hidden");
            document.getElementById("login-page").classList.remove("hidden");
          } else {
            document.getElementById("welcome-page").classList.remove("hidden");
            document.getElementById("login-page").classList.add("hidden");
          }
          document.getElementById("sign-out").classList.add("hidden");
          return;
        }
        try {
          const workerDeviceSnap = await db
            .ref(`devices/${user.uid}/workerId`)
            .once("value");
          if (workerDeviceSnap.exists()) {
            localStorage.setItem("role", "worker");
            document.getElementById("sign-out").classList.remove("hidden");
            window.location.href = "workershtml/workersdashboard.html";
            return;
          }
          if (!user.email) {
            await auth.signOut();
            localStorage.removeItem("role");
            localStorage.removeItem("class");
            return;
          }
          const emailKey = user.email.replace(/\./g, "_");
          const snap = await db.ref("users/" + emailKey).once("value");
          const userData = snap.val();

          // Do NOT sign out if profile missing
          if (!userData) {
            console.warn("User profile not found yet, waiting...");
            return;
          }

          localStorage.setItem("role", userData.role || "");
          if (userData.class) localStorage.setItem("class", userData.class);
          // Preform One flags on reload (mirror Google sign-in)
          if (user.email === "ssclass72023@gmail.com") {
            localStorage.setItem("preformAccess", "true");
          }
          if (user.email === "socratesschool2020@gmail.com") {
            localStorage.setItem("adminAccess", "true");
          }
          document.getElementById("sign-out").classList.remove("hidden");
          if (userData.role === "accountant") {
            window.location.href = "mhasibu.html";
          } else if (userData.role === "teacher") {
            window.location.href = "staff.html";
          } else if (userData.role === "admin") {
            window.location.href = "dashboard.html";
          }
        } catch (err) {
          auth.signOut();
          localStorage.removeItem("role");
          localStorage.removeItem("class");
          document.getElementById("welcome-page").classList.remove("hidden");
          document.getElementById("login-page").classList.add("hidden");
          document.getElementById("sign-out").classList.add("hidden");
        }
      });

      (function quickParentLink() {
        const studentKey = localStorage.getItem("studentKey");
        if (!studentKey) return;
        const toast = document.createElement("div");
        toast.style.position = "fixed";
        toast.style.right = "12px";
        toast.style.bottom = "12px";
        toast.style.background = "rgba(17,24,39,0.9)";
        toast.style.color = "white";
        toast.style.padding = "10px 12px";
        toast.style.borderRadius = "8px";
        toast.style.boxShadow = "0 8px 30px rgba(2,6,23,0.3)";
        toast.style.zIndex = 9999;
        toast.innerHTML = `<div style="font-size:13px">Signed-in as parent â€” <a href="parent.html" style="color:#60a5fa">Open dashboard</a></div>`;
        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => toast.remove(), 800);
        }, 7000);
      })();
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (window.location.hash === "#login") {
          const loginSection = document.getElementById("login-section");
          if (loginSection) {
            loginSection.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        }
      });
    </script>
    <script>
      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("/service-worker.js")
          .then(() => console.log("SoMAp Service Worker registered"))
          .catch((err) => console.error("SW registration failed", err));
      }
    </script>
  </body>
</html>
