<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SoMAp &mdash; Attendance</title>

<!-- Tailwind for quick styling -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="Todashboardhtml/yearContext.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
<style>
  *{font-family:Inter,system-ui,Arial}
  .status-chip{min-width:44px;border-radius:9999px;padding:6px 10px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .chip-P{background:#dcfce7;color:#166534} /* green */
  .chip-A{background:#fee2e2;color:#991b1b} /* red */
  .chip-S{background:#fff7ed;color:#c2410c} /* amber */
  .chip-LE{background:#eef2ff;color:#3730a3} /* indigo */
  .chip-MT{background:#fff7f0;color:#9a3412} /* orange-ish */
  .chip-PG{background:#eef2ff;color:#0b69ff} /* permission blue */
  .chip-empty{background:#f3f4f6;color:#374151;border:1px dashed #e5e7eb}
  .status-pill{padding:4px 8px;border-radius:9999px;font-weight:700}
  .hidden{display:none!important}
  .table th, .table td{padding:8px;border-bottom:1px solid #e6e9ef;white-space:nowrap}
  .table thead th{background:#f8fafc;font-weight:700;position:sticky;top:0}
  .scroll{overflow:auto}
  .shift-list-table th, .shift-list-table td{padding:10px;border-bottom:1px solid #e6e9ef;white-space:nowrap}
  .shift-list-table thead th{background:#fff7ed;color:#9a3412}
  .badge-status{display:inline-flex;align-items:center;padding:4px 10px;border-radius:9999px;font-weight:600;font-size:12px}
  .badge-status.pending{background:#fef3c7;color:#b45309}
  .badge-status.shifted{background:#dcfce7;color:#15803d}
  .badge-status.review{background:#e0e7ff;color:#3730a3}
</style>
</head>
<body class="bg-slate-50 min-h-screen">

<header class="bg-white border-b sticky top-0 z-30">
  <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
    <div class="flex items-center gap-4">
      <a href="schoolerp.html" class="text-slate-700 hover:text-blue-600">Back to ERP</a>
      <h1 class="text-lg font-semibold">SoMAp &mdash; Attendance</h1>
    </div>
    <div class="flex items-center gap-3">
      <label class="flex items-center gap-2 rounded-md border border-slate-300 bg-white px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600">
        <span class="hidden sm:inline text-[0.7rem]">Academic Year</span>
        <select
          data-somap-year-select
          class="min-w-[110px] rounded border border-slate-300 bg-white px-2 py-1 text-sm font-medium text-slate-700 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
        >
        </select>
      </label>
      <button id="btnFullscreen" class="px-3 py-1 rounded-md border bg-slate-100">Enter Fullscreen</button>
      <div id="rtState" class="text-sm text-slate-500">Connecting...</div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-4 space-y-4">

  <!-- Top Analytics —->
  <section id="analytics" class="bg-white rounded-2xl p-4 shadow-sm border">
    <div class="flex items-start justify-between gap-4">
      <div class="flex-1">
        <div class="text-sm text-slate-500">Analytics — <span id="monthLabel">—</span></div>
        <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-3">
          <div class="p-3 rounded-xl border bg-[var(--muted,#fbfcfe)]">
            <div class="text-sm text-slate-500">Class Days (excl. weekends & holidays)</div>
            <div id="classDays" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-3 rounded-xl border bg-[var(--muted,#fbfcfe)]">
            <div class="text-sm text-slate-500">% Present (School Avg, selected day)</div>
            <div id="classPctPresent" class="text-2xl font-bold">—</div>
          </div>
          <div class="p-3 rounded-xl border bg-[var(--muted,#fbfcfe)]">
            <div class="text-sm text-slate-500">Yellow Alerts (&ge; 10 absences this month)</div>
            <div id="yellowCount" class="text-2xl font-bold">-</div>
          </div>
        </div>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
          <div class="p-3 rounded-xl border bg-[var(--muted,#f8fafc)]">
            <div class="text-sm text-slate-500">Registered Pupils (school)</div>
            <div id="schoolRegisteredTotal" class="text-2xl font-bold">—</div>
            <p id="schoolRegisteredBreakdown" class="text-xs text-slate-500 mt-1">Boys - &middot; Girls -</p>
          </div>
          <div class="p-3 rounded-xl border bg-[var(--muted,#f8fafc)]">
            <div class="text-sm text-slate-500">Present Today</div>
            <div id="schoolPresentTotal" class="text-2xl font-bold">—</div>
            <p id="schoolPresentBreakdown" class="text-xs text-slate-500 mt-1">Boys - &middot; Girls -</p>
          </div>
          <div class="p-3 rounded-xl border bg-[var(--muted,#f8fafc)]">
            <div class="text-sm text-slate-500">Absent Today</div>
            <div id="schoolAbsentTotal" class="text-2xl font-bold">—</div>
            <p id="schoolAbsentBreakdown" class="text-xs text-slate-500 mt-1">Boys - &middot; Girls -</p>
          </div>
          <div class="p-3 rounded-xl border bg-[var(--muted,#f8fafc)]">
            <div class="text-sm text-slate-500">Classes tracked</div>
            <div id="schoolClassCount" class="text-2xl font-bold">—</div>
            <p id="schoolClassBreakdown" class="text-xs text-slate-500 mt-1">Active classes —</p>
          </div>
        </div>
      </div>
      <div class="w-64">
        <div class="text-sm text-slate-500 mb-2">Archived query</div>
        <div class="grid grid-cols-1 gap-2">
          <input id="fromDate" type="date" class="px-3 py-2 border rounded" />
          <input id="toDate" type="date" class="px-3 py-2 border rounded" />
          <button id="btnRangeLoad" class="px-3 py-2 bg-indigo-600 text-white rounded">Load Range</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Daily Register -->
  <section id="daily-register" class="mt-6 bg-white/90 rounded-xl p-4 shadow border">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
      <div>
        <h2 class="text-lg font-semibold text-gray-800">Daily Register</h2>
        <p class="text-sm text-gray-500">
          Boys / girls per class for the selected day. Mirrors the paper register.
        </p>
      </div>
      <div class="flex items-center gap-2">
        <label for="registerDate" class="text-sm text-gray-700">Date:</label>
        <input id="registerDate" type="date" class="border rounded-lg px-3 py-1 text-sm" />
        <button id="btnLoadRegister" class="px-4 py-1 rounded-lg bg-indigo-600 text-white text-sm font-medium hover:bg-indigo-700">
          Load Daily Register
        </button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table id="daily-register-table" class="min-w-full border text-xs md:text-sm"></table>
    </div>

    <div id="absentees-panel" class="mt-4"></div>
  </section>

  <!-- Navigation Links -->
  <section class="bg-white rounded-2xl p-4 shadow-sm border">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <a href="Toattendancehtml/classattendance.html" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-center">Class Attendance</a>
      <a href="Toattendancehtml/perstudentattendance.html" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-center">Per-Student Attendance</a>
    </div>
  </section>

  <!-- Shift Alerts -->
  <section class="bg-white rounded-2xl p-4 shadow-sm border">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-3">
      <div>
        <h2 class="text-lg font-semibold text-rose-600">Shift Alerts</h2>
        <p class="text-sm text-slate-500">Students absent for 10+ consecutive school days. Admin action needed.</p>
      </div>
      <span id="shiftAlertsCount" class="badge-status review">0 pending</span>
    </div>
    <div class="overflow-auto">
      <table class="shift-list-table min-w-full">
        <thead>
          <tr>
            <th>Student</th>
            <th>Class</th>
            <th>Parent Contact</th>
            <th>Reason</th>
            <th>Info Source</th>
            <th>Date Shifted</th>
            <th>Probable School</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="shiftListBody">
          <tr>
            <td colspan="8" class="text-center text-slate-500 py-4">No shift alerts yet. Teachers will flag students here.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

</main>

<footer class="bg-white border-t py-3 sticky bottom-0">
  <div class="max-w-6xl mx-auto px-4 text-sm text-slate-500 flex items-center gap-3">
    <div>SoMAp &mdash; Attendance &middot; Mobile friendly</div>
    <div id="todayAlert" class="ml-auto text-sm text-yellow-700 hidden"></div>
  </div>
</footer>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

<script src="firebase.js"></script>

<script>
(async function(){
  // ---------- CONFIG ----------
  const TZ = 'Africa/Nairobi';
  const SCHOOL_DAY_CUTOFF_HOUR = 15;
  const HOLIDAYS = ['01-01','04-07','04-26','05-01','07-07','08-08','10-14','12-09','12-25','12-26'];
  const MOVABLE = ['2025-03-29','2025-04-01','2025-04-10','2025-04-11','2025-06-16'];

  // ---------- STATE ----------
  let students = [];
  let filtered = [];
  let currentClass = '';
  let currentDateStr = '';
  let monthKey = '';
  let attendanceCache = {};
  let monthAttendance = {};
  let db = null;
  let shiftReports = {};
  let shiftRef = null;

  // ---------- HELPERS ----------
  const el = id => document.getElementById(id);
  const shiftListBody = el('shiftListBody');
  const shiftAlertsCount = el('shiftAlertsCount');
  function fmtDate(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
  function toMonthKey(dStr){ const d = new Date(dStr + 'T00:00:00'); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`; }
  function isWeekend(d){ const day = d.getDay(); return day===0 || day===6; }
  function isHoliday(d){ const fixed = String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); const iso = fmtDate(d); return HOLIDAYS.includes(fixed) || MOVABLE.includes(iso); }
  function monthWorkingDays(dateStr){
    const d = new Date(dateStr + 'T00:00:00'); const y=d.getFullYear(), m=d.getMonth();
    let count=0;
    for(let day=1; day<=31; day++){
      const dt = new Date(y,m,day); if(dt.getMonth()!==m) break;
      if(isWeekend(dt) || isHoliday(dt)) continue; count++;
    }
    return count;
  }
  function setStatusElem(elm, val){
    if(!elm) return;
    elm.textContent = val || '-';
    elm.className = 'status-pill ' + (val==='P' ? 'bg-green-100 text-green-800' : (val||'').includes('A') ? 'bg-red-100 text-red-700' : (val||'').includes('S') ? 'bg-amber-100 text-amber-800' : 'bg-slate-100 text-slate-700');
  }

  function normalizeGender(g){
    const val = String(g || '').trim().toLowerCase();
    if (!val) return null;
    if (val.startsWith('m') || val.startsWith('b')) return 'boys';
    if (val.startsWith('f') || val.startsWith('g')) return 'girls';
    return null;
  }

  function classOrderKey(name){
    const n = String(name || '').toLowerCase();
    if (!n) return Number.MAX_SAFE_INTEGER;
    if (n.includes('baby')) return 0;
    if (n.includes('middle')) return 1;
    if (n.includes('pre') || n.includes('nursery')) return 2;
    const match = n.match(/(\d+)/);
    if (match) return 10 + parseInt(match[1], 10);
    return 1000 + n.charCodeAt(0);
  }

  // ---------- FIREBASE: initialize and load students ----------
  async function initializeFirebase() {
    try {
      if (!window.firebase || !window.firebase.apps.length) {
        await new Promise((resolve) => {
          const script = document.createElement('script');
          script.src = 'firebase.js';
          script.onload = resolve;
          script.onerror = () => {
            console.error('Failed to load firebase.js');
            el('rtState').textContent = 'Failed to load firebase.js';
            alert('Error: firebase.js not found. Please check the file path.');
          };
          document.head.appendChild(script);
        });
      }
      db = window.db || (window.firebase && firebase.database ? firebase.database() : null);
      if (!db) {
        throw new Error('Firebase database not initialized');
      }
      el('rtState').textContent = 'Connected to Firebase';
    } catch (e) {
      console.error('Firebase initialization error:', e.message);
      el('rtState').textContent = 'Firebase error: ' + e.message;
      alert('Firebase initialization failed: ' + e.message + '. Please check firebase.js and database rules.');
    }
  }

  async function loadStudentsFromDb() {
    if (!db) return [];
    const tryPaths = ['students', 'Students', 'StudentsList', 'Students_List'];
    for (const p of tryPaths) {
      try {
        const snap = await db.ref(p).get();
        if (snap.exists()) {
          const data = snap.val();
          return Object.keys(data).map(k => {
            const s = data[k] || {};
            const name = [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ').trim() || s.name || (s.fullName || '');
            const gender = s.gender || s.Gender || s.sex || s.Sex || s.genderType || '';
            const className = s.className || s.classLevel || s.class || s.grade || 'Unknown';
            const feeDue = Number(s.totalFee || s.feePerYear || s.feeDue || 0);
            const feePaid = Number(s.feesPaid || s.feePaid || s.paidAmount || 0);
            const balance = Number(s.balance || (feeDue - feePaid) || 0);
            const status = String(s.status || '').toLowerCase();
            if (status === 'shifted') return null;
            const parentName = s.primaryParentName || s.parentName || s.guardianName || '';
            const parentContact = s.primaryParentContact || s.parentPhone || s.parentContact || s.guardianContact || '';
            return {
              id: k,
              admissionNo: s.admissionNumber || s.admNo || s.admissionNo || '',
              name,
              class: className,
              className,
              gender,
              feeDue,
              feePaid,
              balance,
              parentName,
              parentContact,
              status: status || 'active'
            };
          }).filter(Boolean);
        }
      } catch (e) {
        console.warn('Failed to load path', p, ':', e.message);
      }
    }
    console.error('No students data found in any path');
    return [];
  }

  // ---------- Attendance CRUD ----------
  async function loadMonthAttendance(cls, yymm) {
    monthAttendance = {};
    if (!db || !cls) return;
    try {
      const snap = await db.ref(`attendance/${cls}/${yymm}`).get();
      const d = snap.exists() ? snap.val() : {};
      Object.keys(d).forEach(dateKey => {
        const byStu = d[dateKey] || {};
        Object.keys(byStu).forEach(stuId => {
          monthAttendance[stuId] = monthAttendance[stuId] || {};
          monthAttendance[stuId][dateKey] = byStu[stuId];
        });
      });
    } catch (e) {
      console.warn('Failed to load month attendance:', e.message);
    }
  }
  function subscribeShiftReports() {
    if (!db) return;
    if (shiftRef) shiftRef.off();
    shiftRef = db.ref('shiftReports');
    shiftRef.on('value', snap => {
      shiftReports = snap.exists() ? snap.val() : {};
      renderShiftList();
    });
  }
  function getShiftEntries() {
    const data = shiftReports || {};
    return Object.keys(data).map(key => ({ key, ...(data[key] || {}) }));
  }
  function updateShiftAlertsBadge(pendingCount, totalCount) {
    if (!shiftAlertsCount) return;
    const descriptor = totalCount ? `${pendingCount} pending / ${totalCount}` : `${pendingCount} pending`;
    shiftAlertsCount.textContent = descriptor;
    shiftAlertsCount.classList.remove('pending', 'shifted', 'review');
    if (pendingCount > 0) shiftAlertsCount.classList.add('pending');
    else if (totalCount > 0) shiftAlertsCount.classList.add('shifted');
    else shiftAlertsCount.classList.add('review');
  }
  function renderShiftList() {
    if (!shiftListBody) return;
    const entries = getShiftEntries();
    const pendingCount = entries.filter(e => (e.status || 'pending') !== 'shifted').length;
    if (!entries.length) {
      shiftListBody.innerHTML = `<tr><td colspan="8" class="text-center text-slate-500 py-4">No shift alerts yet. Teachers will flag students here.</td></tr>`;
      updateShiftAlertsBadge(0, 0);
      return;
    }
    entries.sort((a, b) => {
      const statusA = (a.status || 'pending') === 'shifted' ? 1 : 0;
      const statusB = (b.status || 'pending') === 'shifted' ? 1 : 0;
      if (statusA !== statusB) return statusA - statusB;
      const dateA = a.flaggedDate || a.teacherReportedAt || '';
      const dateB = b.flaggedDate || b.teacherReportedAt || '';
      return String(dateA).localeCompare(String(dateB));
    });
    shiftListBody.innerHTML = entries.map(entry => {
      const status = (entry.status || 'pending').toLowerCase();
      const statusClass = status === 'shifted' ? 'shifted' : status === 'pending' ? 'pending' : 'review';
      const debtStatus = entry.debtStatus || ((Number(entry.balance || 0) > 0) ? 'not cleared' : 'cleared');
      const statusText = status === 'shifted'
        ? `Shifted - Debt: ${debtStatus.replace(/\b\w/g, c => c.toUpperCase())}`
        : `Pending - Debt: ${debtStatus.replace(/\b\w/g, c => c.toUpperCase())}${entry.shiftChoice ? ` - Teacher: ${String(entry.shiftChoice).toUpperCase()}` : ''}`;
      const parentParts = [entry.parentName, entry.parentContact].filter(Boolean);
      const parentCell = parentParts.length ? parentParts.join(' | ') : '-';
      return `
        <tr>
          <td>${escapeHtml(entry.studentName || '')}</td>
          <td>${escapeHtml(entry.className || '')}</td>
          <td>${escapeHtml(parentCell)}</td>
          <td>${escapeHtml(entry.reason || '-')}</td>
          <td>${escapeHtml(entry.infoSource || '-')}</td>
          <td>${escapeHtml(entry.dateShifted || '-')}</td>
          <td>${escapeHtml(entry.probableSchool || '-')}</td>
          <td><span class="badge-status ${statusClass}">${escapeHtml(statusText)}</span></td>
        </tr>
      `;
    }).join('');
    updateShiftAlertsBadge(pendingCount, entries.length);
  }

  // ---------- Daily register + analytics helpers ----------
  function initialCounts() {
    return {
      registered: { boys: 0, girls: 0, total: 0 },
      present: { boys: 0, girls: 0, total: 0 },
      absent: { boys: 0, girls: 0, total: 0 },
      shifted: 0,
      newcomers: 0
    };
  }

  function buildRegisterTable(stats) {
    const table = el('daily-register-table');
    if (!table) return;
    const classNames = stats.classNames || [];
    const perClass = stats.perClass || {};

    if (!classNames.length) {
      table.innerHTML = `
        <thead>
          <tr><th class="px-3 py-2 border text-left text-xs font-semibold text-slate-700">Daily Register</th></tr>
        </thead>
        <tbody>
          <tr class="bg-white">
            <td class="px-3 py-3 border text-sm text-slate-600">No register data yet for ${escapeHtml(stats.date || '')}. Check connection or student records.</td>
          </tr>
        </tbody>`;
      return;
    }

    const headerCells = [''].concat(classNames, ['Total', 'Shifted', 'Newcomers']);
    const thead = `
      <thead class="bg-slate-50">
        <tr>
          ${headerCells.map((h, idx) => `<th class="px-3 py-2 border text-xs font-semibold text-slate-700 ${idx > 0 ? 'text-right' : 'text-left'}">${escapeHtml(h || '')}</th>`).join('')}
        </tr>
      </thead>
    `;

    const rows = [
      { label: 'Registered - Boys', getter: cls => perClass[cls]?.registered?.boys ?? 0 },
      { label: 'Registered - Girls', getter: cls => perClass[cls]?.registered?.girls ?? 0 },
      { label: 'Registered - Total', getter: cls => perClass[cls]?.registered?.total ?? 0 },
      { label: 'Present - Boys', getter: cls => perClass[cls]?.present?.boys ?? 0 },
      { label: 'Present - Girls', getter: cls => perClass[cls]?.present?.girls ?? 0 },
      { label: 'Present - Total', getter: cls => perClass[cls]?.present?.total ?? 0, showShift: true, showNew: true },
      { label: 'Absent - Boys', getter: cls => perClass[cls]?.absent?.boys ?? 0 },
      { label: 'Absent - Girls', getter: cls => perClass[cls]?.absent?.girls ?? 0 },
      { label: 'Absent - Total', getter: cls => perClass[cls]?.absent?.total ?? 0 },
      { label: 'Absentees (see panel)', getter: () => '—', forceDash: true }
    ];

    const bodyRows = rows.map(row => {
      let rowTotal = 0;
      const classCells = classNames.map(cls => {
        const val = row.getter(cls);
        if (!row.forceDash && typeof val === 'number') rowTotal += val;
        const display = row.forceDash ? '—' : (val ?? '—');
        return `<td class="px-3 py-2 border text-right">${display === '' ? '—' : display}</td>`;
      });
      const totalCell = row.forceDash ? '—' : rowTotal;
      const shiftedTotal = row.showShift ? classNames.reduce((sum, c) => sum + (perClass[c]?.shifted || 0), 0) : '—';
      const newcomersTotal = row.showNew ? classNames.reduce((sum, c) => sum + (perClass[c]?.newcomers || 0), 0) : '—';
      return `
        <tr class="odd:bg-white even:bg-slate-50">
          <th class="px-3 py-2 border text-left font-semibold text-slate-700">${escapeHtml(row.label)}</th>
          ${classCells.join('')}
          <td class="px-3 py-2 border text-right font-semibold">${row.forceDash ? '—' : totalCell}</td>
          <td class="px-3 py-2 border text-right">${row.showShift ? shiftedTotal : '—'}</td>
          <td class="px-3 py-2 border text-right">${row.showNew ? newcomersTotal : '—'}</td>
        </tr>
      `;
    }).join('');

    table.innerHTML = `${thead}<tbody>${bodyRows}</tbody>`;
  }

  function renderAbsenteesPanel(stats) {
    const panel = el('absentees-panel');
    if (!panel) return;
    const entries = Object.entries(stats.absenteesByClass || {}).filter(([, list]) => (list || []).length);
    if (!entries.length) {
      panel.innerHTML = `<div class="border border-green-100 bg-green-50 text-green-700 text-sm rounded-lg p-3">No absentees recorded for ${escapeHtml(stats.date || '')}.</div>`;
      return;
    }
    const cards = entries.map(([cls, list]) => `
      <div class="border rounded-lg p-3 bg-rose-50">
        <h3 class="font-semibold text-sm text-rose-800">${escapeHtml(cls)}</h3>
        <ul class="mt-2 space-y-1 text-sm text-rose-900">
          ${list.map(item => `<li>${escapeHtml(item.name || '')}${item.reason ? ' — ' + escapeHtml(item.reason) : ''}</li>`).join('')}
        </ul>
      </div>
    `).join('');
    panel.innerHTML = `<div class="grid gap-3 md:grid-cols-2 lg:grid-cols-3">${cards}</div>`;
  }

  async function computeYellowAlertsCount(classNames, monthKeyValue) {
    if (!db) return 0;
    const alertSet = new Set();
    for (const cls of classNames) {
      try {
        const snap = await db.ref(`attendance/${cls}/${monthKeyValue}`).get();
        const monthData = snap.exists() ? snap.val() : {};
        const counts = {};
        Object.keys(monthData).forEach(dateKey => {
          const dayRecs = monthData[dateKey] || {};
          Object.keys(dayRecs).forEach(stuId => {
            const rec = dayRecs[stuId] || {};
            const status = String(rec.status || rec.daily || '').toUpperCase();
            const isAbsent = status === 'A' || status === 'ABSENT' || (String(rec.daily || '').toUpperCase().includes('A'));
            if (isAbsent) counts[stuId] = (counts[stuId] || 0) + 1;
          });
        });
        Object.keys(counts).forEach(stuId => {
          if (counts[stuId] >= 10) alertSet.add(`${cls}::${stuId}`);
        });
      } catch (e) {
        console.warn('Failed to compute yellow alerts for', cls, e.message);
      }
    }
    return alertSet.size;
  }

  async function computeDailyRegisterStats(dateStr) {
    const todayIso = new Date().toISOString().slice(0, 10);
    const targetDate = (dateStr || todayIso).slice(0, 10);
    const monthKeyLocal = toMonthKey(targetDate);
    if (!db) return { date: targetDate, classNames: [], perClass: {}, schoolTotals: initialCounts(), schoolAvgPct: 0, yellowAlertsCount: 0, absenteesByClass: {} };

    const studentData = (students && students.length) ? students : await loadStudentsFromDb();
    const studentIndex = {};
    const classNamesSet = new Set();

    (studentData || []).forEach(s => {
      const className = s.className || s.classLevel || s.class || s.grade || '';
      if (!className) return;
      const gender = normalizeGender(s.gender || s.sex || s.genderType);
      const studentId = s.id || s.studentId || s.studentID || s.admissionNo || s.admissionNumber || s.admission || '';
      const fullName = [s.firstName, s.middleName, s.lastName].filter(Boolean).join(' ').trim() || s.name || s.fullName || studentId || 'Unknown';
      const key = studentId || fullName;
      studentIndex[key] = { name: fullName, gender, className };
      classNamesSet.add(className);
    });

    if (!classNamesSet.size && db) {
      try {
        const attRoot = await db.ref('attendance').limitToFirst(20).get();
        const attObj = attRoot.exists() ? attRoot.val() : {};
        Object.keys(attObj || {}).forEach(cls => classNamesSet.add(cls));
      } catch (e) {
        console.warn('No classes inferred from attendance:', e.message);
      }
    }

    const classNames = Array.from(classNamesSet).sort((a, b) => classOrderKey(a) - classOrderKey(b));
    const perClass = {};
    classNames.forEach(cls => { perClass[cls] = initialCounts(); });
    const absenteesByClass = {};
    classNames.forEach(cls => { absenteesByClass[cls] = []; });
    const schoolTotals = initialCounts();

    Object.entries(studentIndex).forEach(([, info]) => {
      const cls = info.className;
      if (!perClass[cls]) perClass[cls] = initialCounts();
      perClass[cls].registered.total += 1;
      schoolTotals.registered.total += 1;
      if (info.gender === 'boys') { perClass[cls].registered.boys += 1; schoolTotals.registered.boys += 1; }
      if (info.gender === 'girls') { perClass[cls].registered.girls += 1; schoolTotals.registered.girls += 1; }
    });

    for (const cls of classNames) {
      try {
        const snap = await db.ref('attendance').child(cls).child(monthKeyLocal).child(targetDate).get();
        const records = snap.exists() ? snap.val() : {};
        Object.keys(records || {}).forEach(stuId => {
          const record = records[stuId] || {};
          const info = studentIndex[stuId] || { name: stuId, gender: null, className: cls };
          const statusRaw = String(record.status || record.daily || '').toUpperCase();
          const isPresent = statusRaw === 'P' || statusRaw === 'PRESENT' || statusRaw === 'PR';
          if (isPresent) {
            perClass[cls].present.total += 1;
            schoolTotals.present.total += 1;
            if (info.gender === 'boys') { perClass[cls].present.boys += 1; schoolTotals.present.boys += 1; }
            if (info.gender === 'girls') { perClass[cls].present.girls += 1; schoolTotals.present.girls += 1; }
          } else {
            perClass[cls].absent.total += 1;
            schoolTotals.absent.total += 1;
            if (info.gender === 'boys') { perClass[cls].absent.boys += 1; schoolTotals.absent.boys += 1; }
            if (info.gender === 'girls') { perClass[cls].absent.girls += 1; schoolTotals.absent.girls += 1; }
            absenteesByClass[cls].push({ name: info.name, gender: info.gender, reason: record.reason || record.comment || record.note || '' });
          }

          if (record.shifted === true || record.dateShifted) {
            perClass[cls].shifted += 1;
            schoolTotals.shifted += 1;
          }
          if (record.isNew === true || record.newComer === true) {
            perClass[cls].newcomers += 1;
            schoolTotals.newcomers += 1;
          }
        });
      } catch (e) {
        console.warn('Failed to load attendance for class', cls, e.message);
      }

      perClass[cls].absent.total = Math.max(0, perClass[cls].registered.total - perClass[cls].present.total);
      perClass[cls].absent.boys = Math.max(0, perClass[cls].registered.boys - perClass[cls].present.boys);
      perClass[cls].absent.girls = Math.max(0, perClass[cls].registered.girls - perClass[cls].present.girls);
    }

    schoolTotals.absent = { boys: 0, girls: 0, total: 0 };
    schoolTotals.present = schoolTotals.present || { boys: 0, girls: 0, total: 0 };
    schoolTotals.registered = schoolTotals.registered || { boys: 0, girls: 0, total: 0 };
    classNames.forEach(cls => {
      ['boys', 'girls', 'total'].forEach(key => {
        schoolTotals.absent[key] += perClass[cls].absent[key] || 0;
      });
    });

    let sumPct = 0, classesWithData = 0;
    classNames.forEach(cls => {
      const reg = perClass[cls].registered.total;
      const pres = perClass[cls].present.total;
      if (reg > 0) {
        sumPct += (pres / reg) * 100;
        classesWithData++;
      }
    });
    const schoolAvgPct = classesWithData ? (sumPct / classesWithData) : 0;

    const yellowAlertsCount = await computeYellowAlertsCount(classNames, monthKeyLocal);

    return { date: targetDate, classNames, perClass, schoolTotals, schoolAvgPct, yellowAlertsCount, absenteesByClass };
  }

  async function refreshDailyRegisterUI(dateStr) {
    const targetDate = (dateStr || fmtDate(new Date())).slice(0, 10);
    currentDateStr = targetDate;
    monthKey = toMonthKey(targetDate);
    const stats = await computeDailyRegisterStats(targetDate);
    const workdays = monthWorkingDays(targetDate);
    const monthLabel = monthKey;

    el('monthLabel').textContent = monthLabel;
    el('classDays').textContent = workdays || '—';
    el('classPctPresent').textContent = `${Math.round(stats.schoolAvgPct || 0)}%`;
    el('yellowCount').textContent = typeof stats.yellowAlertsCount === 'number' ? stats.yellowAlertsCount : '—';

    const reg = stats.schoolTotals.registered || {};
    const pres = stats.schoolTotals.present || {};
    const abs = stats.schoolTotals.absent || {};
    const setCard = (id, value) => { const node = el(id); if (node) node.textContent = value; };
    setCard('schoolRegisteredTotal', (reg.total ?? 0).toString());
    setCard('schoolPresentTotal', (pres.total ?? 0).toString());
    setCard('schoolAbsentTotal', (abs.total ?? 0).toString());
    setCard('schoolClassCount', (stats.classNames?.length ?? 0).toString());

    const breakdown = (boys, girls) => `Boys ${boys ?? 0} \u00b7 Girls ${girls ?? 0}`;
    const setBreakdown = (id, boys, girls, fallback) => {
      const node = el(id);
      if (node) node.textContent = fallback || breakdown(boys, girls);
    };
    setBreakdown('schoolRegisteredBreakdown', reg.boys, reg.girls);
    setBreakdown('schoolPresentBreakdown', pres.boys, pres.girls);
    setBreakdown('schoolAbsentBreakdown', abs.boys, abs.girls);
    const classLabel = stats.classNames && stats.classNames.length ? `${stats.classNames.length} active class(es)` : 'Active classes —';
    setBreakdown('schoolClassBreakdown', '', '', classLabel);

    buildRegisterTable(stats);
    renderAbsenteesPanel(stats);
  }

  // ---------- Analytics compute ----------
  async function computeAnalytics(dateStr) {
    return refreshDailyRegisterUI(dateStr || currentDateStr || fmtDate(new Date()));
  }

  // ---------- Archive load range ----------
  async function loadRangeBetween(from, to, cls) {
    if (!db || !cls) return alert('Pick class and ensure connection');
    const start = new Date(from + 'T00:00:00');
    const end = new Date(to + 'T00:00:00');
    const days = [];
    for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
      if (isWeekend(d) || isHoliday(d)) continue;
      days.push(fmtDate(new Date(d)));
    }
    const results = {};
    for (const day of days) {
      const mon = toMonthKey(day);
      try {
        const snap = await db.ref(`attendance/${cls}/${mon}/${day}`).get();
        const d = snap.exists() ? snap.val() : {};
        let present = 0, absent = 0;
        Object.keys(d || {}).forEach(k => {
          const rec = d[k];
          if (rec && rec.daily === 'P') present++;
          if (rec && (rec.daily || '').includes('A')) absent++;
        });
        results[day] = { present, absent };
      } catch (e) {
        console.warn(`Failed to load attendance for ${day}:`, e.message);
      }
    }
    let text = `Attendance summary for ${cls} from ${from} to ${to}:\n`;
    Object.keys(results).forEach(k => text += `${k}: P=${results[k].present} A=${results[k].absent}\n`);
    alert(text);
  }

  // ---------- UI wiring ----------
  function wireUI() {
    el('btnRangeLoad').addEventListener('click', () => loadRangeBetween(el('fromDate').value, el('toDate').value, currentClass));
    el('btnFullscreen').addEventListener('click', () => {
      if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(() => {});
      else document.exitFullscreen().catch(() => {});
    });
    setInterval(check3pmAlert, 60 * 1000);
  }

  function setupDailyRegisterControls() {
    const dateInput = el('registerDate');
    const btnLoad = el('btnLoadRegister');
    const todayIso = new Date().toISOString().slice(0, 10);
    if (dateInput && !dateInput.value) {
      dateInput.value = todayIso;
    }
    const reload = async () => {
      const val = (dateInput && dateInput.value) ? dateInput.value : todayIso;
      await refreshDailyRegisterUI(val);
    };
    if (btnLoad) btnLoad.addEventListener('click', reload);
    if (dateInput) dateInput.addEventListener('change', reload);
    return reload();
  }

  // ---------- 3PM alert ----------
  function check3pmAlert() {
    const now = new Date();
    const cut = new Date(now);
    cut.setHours(SCHOOL_DAY_CUTOFF_HOUR, 0, 0, 0);
    const box = el('todayAlert');
    if (now > cut) {
      const need = filtered.some(s => {
        const rec = attendanceCache[s.id] || {};
        return !(rec.am && rec.pm);
      });
      if (need) {
        box.textContent = 'After 3:00 PM: Attendance not fully marked for today';
        box.classList.remove('hidden');
      } else {
        box.classList.add('hidden');
      }
    } else {
      box.classList.add('hidden');
    }
  }

  // ---------- Utilities ----------
  function escapeHtml(s) {
    if (!s) return '';
    return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]);
  }

  // ---------- Start ----------
  async function init() {
    const now = new Date();
    currentDateStr = fmtDate(now);
    monthKey = toMonthKey(currentDateStr);
    el('fromDate').value = currentDateStr;
    el('toDate').value = currentDateStr;

    el('rtState').textContent = 'Connecting...';
    await initializeFirebase();
    el('rtState').textContent = 'Loading students...';
    if (db) {
      for (let attempt = 1; attempt <= 3; attempt++) {
        students = await loadStudentsFromDb();
        if (students.length) break;
        console.warn(`Attempt ${attempt} failed to load students. Retrying...`);
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      filtered = students.slice();
      if (!students.length) {
        console.warn('No students found in database; rendering empty register.');
        el('rtState').textContent = 'No students found';
      }
      if (students.length && !currentClass) {
        const classes = Array.from(new Set(students.map(s => s.class || s.classLevel || s.grade || s.className).filter(Boolean))).sort((a, b) => classOrderKey(a) - classOrderKey(b));
        currentClass = classes[0] || '';
      }
    } else {
      console.warn('DB not connected; rendering empty register.');
      el('rtState').textContent = 'Offline';
    }
    el('rtState').textContent = el('rtState').textContent || 'Ready';
    wireUI();
    await setupDailyRegisterControls();
    subscribeShiftReports();
    renderShiftList();
    await computeAnalytics(currentDateStr);
  }

  await init();
  el('rtState').textContent = db ? 'Connected' : 'No DB';
})();
</script>
</body>
</html>
