<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SoMAp - Receipt Center</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter','system-ui','-apple-system','BlinkMacSystemFont','Segoe UI','sans-serif']
          }
        }
      }
    };
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-5A8nDU6AE2aVdM3mV0NHQW1+6RyXUGFaJq6Digw1k3D6Z0fjQX+0Gooy2cuglRez2oJ6TP2PzYDs2kP2T0b3A==" crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="../shared/finance_math.js"></script>

  <style>
    :root{
      color-scheme: dark;
    }
    body{
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      min-height:100vh;
      background:
        radial-gradient(1200px 800px at -10% -10%, rgba(14,165,233,.35), transparent 40%),
        radial-gradient(900px 700px at 110% -10%, rgba(139,92,246,.25), transparent 35%),
        radial-gradient(1200px 900px at 20% 120%, rgba(59,130,246,.25), transparent 45%),
        #020617;
      color:#e2e8f0;
    }
    .glass-card{
      background:rgba(15,23,42,.75);
      border:1px solid rgba(148,163,184,.25);
      border-radius:24px;
      backdrop-filter:blur(20px);
      box-shadow:0 25px 60px -40px rgba(2,6,23,.9);
    }
    .receipt-sheet{
      background:rgba(255,255,255,.98);
      color:#0f172a;
      border-radius:30px;
      border:1px solid rgba(148,163,184,.3);
      box-shadow:0 40px 120px -80px rgba(15,23,42,.9);
      position:relative;
      overflow:hidden;
    }
    .receipt-sheet::before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      background:radial-gradient(circle at top right, rgba(14,165,233,.2), transparent 45%);
      opacity:.7;
    }
    .receipt-sheet > .inner{
      position:relative;
      padding:2.5rem;
    }
    .identity-card{
      border-radius:24px;
      background:linear-gradient(135deg, rgba(244,249,255,1), rgba(222,242,255,.8));
      border:1px solid rgba(14,165,233,.15);
      box-shadow:0 15px 40px -30px rgba(14,165,233,.7);
      padding:1.5rem;
    }
    .avatar-frame{
      width:110px;
      height:110px;
      border-radius:28px;
      background:linear-gradient(145deg, rgba(14,165,233,.2), rgba(59,130,246,.35));
      border:1px solid rgba(14,165,233,.35);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      position:relative;
    }
    .avatar-frame img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .avatar-initials{
      font-size:1.7rem;
      font-weight:700;
      color:#0f172a;
    }
    .form-line{
      display:flex;
      gap:0.9rem;
      align-items:flex-start;
      font-size:0.95rem;
      color:#0f172a;
    }
    .form-line label{
      font-size:0.68rem;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.22em;
      color:#94a3b8;
      min-width:150px;
    }
    .form-line .value{
      flex:1;
      position:relative;
      padding-bottom:0.35rem;
    }
    .form-line .value::after{
      content:"";
      position:absolute;
      left:0;
      right:0;
      bottom:0;
      border-bottom:1px dotted rgba(15,23,42,.25);
    }
    .form-line .value span{
      position:relative;
      display:inline-flex;
      padding:0.15rem 0.4rem;
      border-radius:6px;
      background:rgba(255,255,255,.9);
      min-height:1.5rem;
      align-items:center;
      font-weight:600;
    }
    .status-pill{
      display:inline-flex;
      align-items:center;
      font-size:0.75rem;
      padding:0.2rem 0.65rem;
      border-radius:999px;
      font-weight:600;
      border:1px solid rgba(15,23,42,.15);
    }
    .list-card{
      border-radius:18px;
      border:1px solid rgba(148,163,184,.2);
      padding:1rem;
      background:rgba(15,23,42,.5);
      transition:all .2s ease;
      cursor:pointer;
    }
    .list-card:hover{
      border-color:rgba(59,130,246,.65);
    }
    .summary-scroll{
      overflow-x:auto;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.5);
      background:#fff;
      max-width:100%;
    }
    @media (min-width:768px){
      .summary-scroll{
        overflow:visible;
      }
    }
    .summary-table{
      width:100%;
      border-collapse:collapse;
      table-layout:auto;
      font-size:0.78rem;
      min-width:0;
      background:#fff;
    }
    .summary-table th,
    .summary-table td{
      padding:0.4rem 0.65rem;
      border:1px solid #e2e8f0;
      word-break:break-word;
    }
    .summary-table th{
      font-size:0.65rem;
      letter-spacing:0.2em;
      text-transform:none;
      color:#475569;
      background:#f1f5f9;
      white-space:normal;
    }
    .summary-header-text{
      display:flex;
      flex-direction:column;
      gap:0.2rem;
      font-weight:700;
      line-height:1.1;
    }
    .summary-table td{
      font-size:0.78rem;
      color:#0f172a;
      white-space:normal;
      overflow-wrap:break-word;
    }
    .summary-table td:first-child{
      min-width:170px;
      white-space:normal;
    }
    .summary-table td .status-pill{
      font-size:0.65rem;
    }
    @media print{
      .summary-table th,
      .summary-table td{
        padding:0.25rem 0.35rem;
        font-size:0.62rem;
      }
      .summary-table td:first-child{
        min-width:120px;
      }
    }
    .print\:hidden{@media print{display:none!important;}}
    @media print{
      @page{
        size: A4;
        margin: 10mm;
      }
      body{
        background:#fff;
        color:#0f172a;
        width: 210mm;
      }
      header, #receiptsPanel, .print-hidden, .page-chrome{ display:none !important; }
      .receipt-sheet{
        box-shadow:none;
        border:1px solid #cbd5f5;
        width: 190mm;
        min-height: 277mm;
        margin: 0 auto;
        box-sizing: border-box;
      }
    }
    body.pdf-capture{
      width: 210mm;
      background:#fff;
      color:#0f172a;
    }
    body.pdf-capture .receipt-sheet{
      width: 190mm;
      min-height: 277mm;
      margin: 0 auto;
      box-sizing: border-box;
    }
  </style>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    window.firebaseApp = firebase.app();
    window.db = firebase.database();
  </script>

  <script>
    /** Year range + anchor **/
    const SOMAP_ALLOWED_YEARS = Array.from({length: 20}, (_,i)=>2023+i); // 2023..2042
    const SOMAP_DEFAULT_YEAR = 2025;

    /** Tanzania class ladder (no Class 8). Keep labels EXACTLY. */
    const CLASS_ORDER = ['Baby Class','Class 1','Class 2','Class 3','Class 4','Class 5','Class 6','Class 7'];
    const L = s => String(s||'').trim().toLowerCase();

    /** Shift a base class by delta years relative to anchor (2025). */
    function shiftClass(baseClass, deltaYears){
      const i = CLASS_ORDER.findIndex(c => L(c)===L(baseClass));
      if (i<0) return baseClass||'';
      const j = i + Number(deltaYears||0);
      if (j < 0) return 'PRE-ADMISSION';
      if (j >= CLASS_ORDER.length) return 'GRADUATED';
      return CLASS_ORDER[j];
    }
    window.shiftClass = shiftClass;
  </script>

  <script>
    /** Reuse shared year context if present, else create a light fallback. */
    window.somapYearContext = window.somapYearContext || (function(){
      let selected = (sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR)+'';
      const listeners = new Set();
      return {
        getSelectedYear(){ return selected; },
        setSelectedYear(y){
          y = String(y);
          if (selected===y) return;
          selected = y;
          try{ sessionStorage.setItem('somap_selected_year', y); }catch{}
          listeners.forEach(fn=>{ try{ fn(y); }catch{} });
        },
        onYearChanged(fn){ if (typeof fn==='function') listeners.add(fn); }
      };
    })();
  </script>

  <script>
    const db = window.db || (firebase?.database ? firebase.database() : null);
    if (!db) console.error('DB not initialized; ensure firebase.js loaded earlier.');

    async function loadYearData(targetYear){
      const y = String(targetYear || window.somapYearContext.getSelectedYear() || SOMAP_DEFAULT_YEAR);
      const anchorY = String(SOMAP_DEFAULT_YEAR);

      const [studentsSnap, anchorEnrollSnap, yearEnrollSnap] = await Promise.all([
        fetchScoped('students'),
        fetchScoped(`enrollments/${anchorY}`),
        fetchScoped(`enrollments/${y}`)
      ]);

      const students = (studentsSnap && studentsSnap.val && studentsSnap.val()) || {};
      const enrollAnchor = (anchorEnrollSnap && anchorEnrollSnap.val && anchorEnrollSnap.val()) || {};
      const enrollYear   = (yearEnrollSnap && yearEnrollSnap.val && yearEnrollSnap.val()) || {};

      return { y, students, enrollAnchor, enrollYear };
    }

    function resolveClassForYear(studentId, anchorMap, yearMap, targetYear, fallbackClass){
      const yearRecord = (yearMap||{})[studentId];
      if (yearRecord && (yearRecord.className || yearRecord.classLevel)){
        return yearRecord.className || yearRecord.classLevel;
      }
      const anchor = (anchorMap||{})[studentId] || {};
      const baseClass = anchor.className || anchor.classLevel || fallbackClass || '';
      if (!baseClass) return '';
      const delta = Number(targetYear) - SOMAP_DEFAULT_YEAR;
      if (!Number.isFinite(delta)) return baseClass;
      return shiftClass(baseClass, delta);
    }

  </script>
</head>
<body class="antialiased">
  <div class="min-h-screen pb-16">
    <header class="page-chrome sticky top-0 z-30 border-b border-white/10 bg-slate-900/80 backdrop-blur-xl">
      <div class="mx-auto flex max-w-6xl flex-wrap items-center justify-between gap-4 px-4 py-4">
        <div class="flex items-center gap-3">
          <img src="../images/somap-logo.png.jpg" alt="SoMAp logo" class="h-12 w-12 rounded-2xl border border-white/20 object-contain shadow-lg"/>
          <div>
            <p class="text-lg font-semibold text-white">SoMAp Receipt Center</p>
            <p class="text-sm text-slate-300">Finance - Parents - Approvals</p>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <div id="somapYearWrap" class="flex items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-sm text-white">
            <label class="text-xs font-semibold uppercase tracking-[0.25em] text-slate-300">Academic Year</label>
            <select data-somap-year-select class="rounded-lg border border-white/30 bg-slate-900/80 px-2 py-1 text-sm text-white focus:outline-none"></select>
            <span class="text-xs text-slate-400">Working year: <b id="somapYearHint">--</b></span>
          </div>
          <form id="receiptLookupForm" class="print:hidden flex flex-wrap items-center gap-2 rounded-2xl border border-white/10 bg-white/5 px-3 py-2 text-xs text-white">
            <label class="text-[10px] font-semibold uppercase tracking-[0.35em] text-slate-300">Lookup</label>
            <select id="receiptLookupMode" class="rounded-lg border border-white/30 bg-slate-900/80 px-2 py-1 text-xs text-white focus:outline-none">
              <option value="student" selected>Student</option>
              <option value="receipt">Receipt Ref</option>
            </select>
            <input id="receiptLookupInput" type="text" autocomplete="off" placeholder="Admission number or student name" class="w-48 rounded-lg border border-white/30 bg-slate-900/70 px-2 py-1 text-sm text-white placeholder:text-slate-400 focus:outline-none" />
            <button type="submit" class="rounded-full border border-sky-400 px-3 py-1 text-xs font-semibold text-sky-100 transition hover:bg-sky-500/20">Load</button>
          </form>
          <div class="flex items-center gap-2">
            <button id="printReceiptBtn" class="print:hidden inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-3 py-2 text-sm font-semibold text-white transition hover:border-sky-400 hover:text-sky-100"><i class="fa-solid fa-print"></i><span>Print</span></button>
            <button id="downloadReceiptBtn" class="print:hidden inline-flex items-center gap-2 rounded-full border border-sky-500 bg-sky-500/20 px-3 py-2 text-sm font-semibold text-sky-100 transition hover:bg-sky-500/30"><i class="fa-solid fa-file-arrow-down"></i><span>PDF</span></button>
          </div>
        </div>
      </div>
    </header>

    <main class="px-4 py-8">
      <div class="mx-auto grid max-w-6xl gap-6 lg:grid-cols-[minmax(0,1fr),320px]">
        <section id="receiptCanvas" class="receipt-sheet">
          <div class="inner space-y-8">
            <div class="flex flex-wrap items-start gap-6 border-b border-slate-200 pb-6">
            <div class="flex items-center gap-4">
              <img src="../images/somap-logo.png.jpg" alt="School logo" class="h-16 w-16 rounded-2xl border border-slate-200 bg-white object-contain shadow"/>
              <div class="space-y-1">
                <p class="text-sm font-extrabold tracking-[0.6em] text-slate-600">SOCRATES INVESTMENT LIMITED</p>
                <p class="text-xs font-semibold uppercase tracking-[0.35em] text-slate-500">Socrates School Arusha</p>
                <p class="text-xs text-slate-500">TIN 135-547-565 &bull; P.O Box 14256 Arusha</p>
                <p class="text-xs text-slate-500">Contacts: +255 686 828 732 / +255 689 649 822</p>
              </div>
            </div>
            <div class="ml-auto text-right">
              <p class="text-xs font-semibold uppercase tracking-[0.3em] text-slate-500">Receipt</p>
              <p id="receiptNumber" class="text-2xl font-black text-slate-900">--</p>
              <p id="receiptDate" class="text-sm text-slate-500">--</p>
            </div>
          </div>

            <div id="receiptEmptyState" class="hidden rounded-2xl border border-dashed border-slate-300 bg-slate-50/80 px-5 py-4 text-slate-700">
              <p class="text-base font-semibold text-slate-900">Ready to view receipts</p>
              <p class="text-sm text-slate-600" data-empty-message>Use the lookup bar above to search by admission number, student name, or receipt reference.</p>
              <p class="text-xs text-slate-500 mt-1">Tip: Opening this page from Parent or Approvals will auto-load the correct receipt.</p>
            </div>

            <div class="identity-card grid gap-6 md:grid-cols-[auto,1fr]">
              <div class="avatar-frame">
                <img id="avatarImage" class="hidden" alt="Student portrait"/>
                <span id="avatarInitials" class="avatar-initials">--</span>
              </div>
              <div class="space-y-1">
                <div class="flex flex-wrap items-center gap-3">
                  <h2 id="studentName" class="text-2xl font-semibold text-slate-900">Student Name</h2>
                  <span id="studentClass" class="rounded-full bg-sky-100 px-3 py-1 text-sm font-semibold text-sky-700">Class</span>
                  <span id="graduatedBadge" class="hidden rounded-full bg-rose-100 px-3 py-1 text-xs font-semibold uppercase tracking-[0.2em] text-rose-600">Graduated</span>
                </div>
                <p id="studentAdmission" class="text-sm font-medium text-slate-600">Admission: --</p>
                <p class="text-sm text-slate-500 flex flex-wrap items-center gap-2"><i class="fa-solid fa-phone text-slate-400"></i><span id="motherContact">+255 ...</span></p>
              </div>
            </div>

            <div class="grid gap-4 md:grid-cols-2">
              <div class="space-y-3">
                <div class="form-line"><label>Received From</label><span class="value"><span id="fieldReceivedFrom">--</span></span></div>
                <div class="form-line"><label>Being Payment Of</label><span class="value"><span id="fieldPaymentOf">--</span></span></div>
                <div class="form-line"><label>Paid By (Name)</label><span class="value"><span id="fieldPaidBy">--</span></span></div>
                <div class="form-line"><label>Contact of Payer</label><span class="value"><span id="fieldPayerContact">--</span></span></div>
              </div>
              <div class="space-y-3">
                <div class="form-line"><label>Amount in Figures (TSh)</label><span class="value"><span id="fieldAmountFigures">--</span></span></div>
                <div class="form-line"><label>Money in Words</label><span class="value"><span id="fieldAmountWords">--</span></span></div>
                <div class="form-line"><label>Reference Number</label><span class="value"><span id="fieldReference">--</span></span></div>
                <div class="form-line"><label>Payment Date</label><span class="value"><span id="fieldPaymentDate">--</span></span></div>
              </div>
            </div>

            <div class="flex flex-wrap items-center gap-4 rounded-2xl border border-slate-200 bg-white/70 px-6 py-4">
              <div class="flex-1">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Being Payment Of</p>
                <p id="paymentLabel" class="text-xl font-semibold text-slate-900">--</p>
                <p id="paymentPathLabel" class="text-xs text-slate-500">Source --</p>
              </div>
              <div class="text-right">
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Status</p>
                <span id="statusBadge" class="status-pill bg-amber-50 text-amber-600 border border-amber-200">Awaiting</span>
              </div>
            </div>

            <div class="space-y-3">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Year Summary</p>
                  <h3 class="text-xl font-semibold text-slate-900">Fee Summary Table</h3>
                </div>
                <button id="tablePeekBtn" class="flex items-center gap-2 text-sm font-semibold text-slate-500 hover:text-slate-900"><i class="fa-regular fa-eye"></i><span>View</span></button>
              </div>
              <div class="summary-scroll rounded-2xl border border-slate-200">
                <table id="yearSummaryTable" class="summary-table text-xs">
                  <thead class="bg-slate-50 text-xs uppercase tracking-[0.2em] text-slate-500">
                    <tr>
                      <th class="px-3 py-2 text-left"><span class="summary-header-text"><span>Being Payment</span><span>Of</span></span></th>
                      <th class="px-3 py-2 text-right"><span class="summary-header-text"><span>Paid</span><span>Now</span></span></th>
                      <th class="px-3 py-2 text-left"><span class="summary-header-text"><span>Reference</span></span></th>
                      <th class="px-3 py-2 text-left"><span class="summary-header-text"><span>Receipt</span><span>Updated</span></span></th>
                      <th class="px-3 py-2 text-left"><span class="summary-header-text"><span>Payment</span><span>Date</span></span></th>
                      <th class="px-3 py-2 text-right"><span class="summary-header-text"><span>Total Paid</span><span>(YTD)</span></span></th>
                      <th class="px-3 py-2 text-right"><span class="summary-header-text"><span>Year</span><span>Required</span></span></th>
                      <th class="px-3 py-2 text-right"><span class="summary-header-text"><span>Balance</span></span></th>
                      <th class="px-3 py-2 text-left"><span class="summary-header-text"><span>Plan</span></span></th>
                      <th class="px-3 py-2 text-left"><span class="summary-header-text"><span>Debt</span><span>Stage</span></span></th>
                      <th class="px-3 py-2 text-left"><span class="summary-header-text"><span>Due</span><span>Date</span></span></th>
                    </tr>
                  </thead>
                  <tbody id="summaryBody" class="bg-white"></tbody>
                </table>
              </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
              <div class="space-y-3">
                <div class="form-line"><label>Cash / Cheque / Bank / Mpesa / Airtel Money</label><span class="value"><span id="fieldMethod">--</span></span></div>
                <div class="form-line"><label>Tanzanian Shillings</label><span class="value"><span id="fieldFiguresFooter">--</span></span></div>
                <div class="form-line"><label>Money in Words</label><span class="value"><span id="fieldWordsFooter">--</span></span></div>
              </div>
              <div class="space-y-3">
                <div class="form-line"><label>Approved On</label><span class="value"><span id="approvedOn">--</span></span></div>
                <div class="form-line"><label>Approved By</label><span class="value"><span id="approvedBy">--</span></span></div>
                <div class="form-line"><label>Signature</label><span class="value"><span class="text-slate-400">_____________________________</span></span></div>
              </div>
            </div>
          </div>
        </section>

        <aside id="receiptsPanel" class="glass-card h-fit space-y-4 p-5">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Receipts</p>
              <h3 class="text-xl font-semibold text-white">Year History</h3>
            </div>
            <span class="text-slate-300"><i class="fa-regular fa-eye"></i></span>
          </div>
          <div id="receiptsList" class="max-h-[70vh] space-y-3 overflow-auto pr-1"></div>
          <p id="listEmpty" class="text-sm text-slate-400 hidden">No approved receipts for this learner in the selected year.</p>
        </aside>
      </div>
    </main>
  </div>

  <section id="studentsDirectory" class="mx-auto mt-10 max-w-6xl px-4">
    <div class="glass-card space-y-4 rounded-3xl border border-white/10 bg-white/5 p-5">
      <div class="flex flex-wrap items-start gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.35em] text-slate-300">Learners</p>
          <h3 class="text-2xl font-semibold text-white">Student Receipt Directory</h3>
          <p id="studentsDirectoryYearHint" class="text-sm text-slate-400">Working year --</p>
        </div>
        <div class="ml-auto flex flex-wrap items-center gap-3">
          <div class="rounded-2xl border border-white/15 px-3 py-1 text-xs font-semibold text-slate-200">
            Total <span id="studentsDirectoryCount" class="ml-1 text-white">0</span>
          </div>
          <input
            id="studentsDirectorySearch"
            type="text"
            autocomplete="off"
            placeholder="Search admission or name"
            class="w-64 rounded-2xl border border-white/15 bg-slate-900/60 px-3 py-2 text-sm text-white placeholder:text-slate-400 focus:outline-none"
          />
        </div>
      </div>
      <div class="overflow-hidden rounded-2xl border border-white/10">
        <div class="max-h-[480px] overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5 text-left text-xs uppercase tracking-[0.3em] text-slate-400">
              <tr>
                <th class="px-4 py-3 font-semibold">Admission</th>
                <th class="px-4 py-3 font-semibold">Student</th>
                <th class="px-4 py-3 font-semibold">Class</th>
                <th class="px-4 py-3 font-semibold">Parent Contact</th>
                <th class="px-4 py-3 text-right font-semibold">Action</th>
              </tr>
            </thead>
            <tbody id="studentsDirectoryBody" class="bg-slate-900/30">
              <tr>
                <td colspan="5" class="px-4 py-6 text-center text-sm text-slate-400">Loading students...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <p id="studentsDirectoryEmpty" class="text-center text-sm text-slate-400 hidden">
        Students will appear here as soon as we finish loading the list.
      </p>
    </div>
  </section>

  <div id="loadingState" class="fixed inset-0 hidden items-center justify-center bg-slate-900/70 text-lg font-semibold text-white backdrop-blur-xl">Loading receipt...</div>
  <div id="errorBanner" class="fixed bottom-4 left-1/2 hidden w-[90%] max-w-xl -translate-x-1/2 rounded-2xl border border-rose-400 bg-rose-500/20 px-4 py-3 text-center text-sm text-rose-100"></div>
  <script>
    (function initYearSelector(){
      const sel = document.querySelector('[data-somap-year-select]');
      const hint = document.getElementById('somapYearHint');
      if (!sel) return;
      sel.innerHTML = SOMAP_ALLOWED_YEARS.map(y=>`<option value="${y}">${y}</option>`).join('');
      const current = window.somapYearContext.getSelectedYear();
      sel.value = current;
      if (hint) hint.textContent = current;
      sel.addEventListener('change', e=>{
        const y = String(e.target.value);
        window.somapYearContext.setSelectedYear(y);
        if (hint) hint.textContent = y;
      });
      window.somapYearContext.onYearChanged(y => {
        sel.value = String(y);
        if (hint) hint.textContent = String(y);
      });
    })();
  </script>
  <script>
    const urlParams = new URLSearchParams(location.search);
    const initialYearParam = urlParams.get('year');
    if (initialYearParam && SOMAP_ALLOWED_YEARS.includes(Number(initialYearParam))) {
      window.somapYearContext.setSelectedYear(initialYearParam);
    } else if (!initialYearParam) {
      urlParams.set('year', window.somapYearContext.getSelectedYear());
      syncUrlParams();
    }

    const VIEW_KIND = (urlParams.get('scope') || '').toLowerCase() === 'parent' ? 'parent' : 'detail';

    const scopedPath = path => {
      if (!path) return '';
      const schoolId = window.currentSchoolId;
      return schoolId ? `schools/${schoolId}/${path}` : path;
    };

    const PAYMENT_ROWS = [
      { key:'schoolFees', label:'School Fees', modules:['finance','schoolfees','school-fees','tuition','fees'], path:'finance.html' },
      { key:'transport', label:'Transport', modules:['transport','transportpayment','schoolbus','bus'], path:'transporthtml/transportpayment.html' },
      { key:'graduation', label:'Graduation', modules:['graduation','grad'], path:'Tostaffhtml/graduation.html' },
      { key:'friday', label:'Friday Money', modules:['fridaymoney','friday','pocketmoney'], path:'Tofinancehtml/fridaymoney.html' },
      { key:'other', label:'Other (Clothing / Remedials)', modules:['other','others','clothing','remedials','uniform','misc'], path:'upcoming' }
    ];
    const MODULE_LOOKUP = PAYMENT_ROWS.reduce((acc,row)=>{ row.modules.forEach(m=> acc[m.toLowerCase()] = row.key); return acc; },{});
    const CLOUDINARY_FALLBACK = 'dg7vnrkgd';

    const state = {
      year: window.somapYearContext.getSelectedYear(),
      queryStudent: urlParams.get('student') || '',
      queryApproval: urlParams.get('approvalId') || '',
      students:{},
      enrollAnchor:{},
      enrollYear:{},
      studentId:null,
      studentRecord:null,
      approvals:[],
      activeApproval:null,
      targets: createEmptyTargets(),
      summaryRows:{},
      loading:false,
      studentFilter:'',
      receiptNumbers:{}
    };

    let renderToken = 0;
    const approvalsHistoryCache = new Map();
    const approvalsByYearCache = new Map();
    const monthCache = window.__somapReceiptMonthCache || new Map();
    window.__somapReceiptMonthCache = monthCache;

    const approvalsScopeKey = () => {
      return window.currentSchoolId ? `school::${window.currentSchoolId}` : 'global';
    };

    async function fetchApprovalsHistoryTree(){
      const scopeKey = approvalsScopeKey();
      if (approvalsHistoryCache.has(scopeKey)){
        return approvalsHistoryCache.get(scopeKey);
      }
      let snapshot = null;
      try{
        snapshot = await fetchScoped('approvalsHistory');
      }catch(err){
        console.warn('Receipt: failed to fetch approvals history tree', err);
      }
      const tree = snapshot && typeof snapshot.val === 'function' ? (snapshot.val() || {}) : {};
      approvalsHistoryCache.set(scopeKey, tree);
      return tree;
    }

    function extractApprovalYear(raw){
      if (!raw) return null;
      const direct = raw.forYear ?? raw.academicYear ?? raw.year ?? raw.paymentYear ?? raw.approvedYear ?? raw.receiptYear;
      if (direct != null && direct !== ''){
        const numeric = Number(direct);
        if (Number.isFinite(numeric)) return numeric;
      }
      let payload = raw.modulePayload;
      if (typeof payload === 'string'){
        try{
          payload = JSON.parse(payload);
        }catch(_){
          payload = null;
        }
      }
      if (payload && typeof payload === 'object'){
        const payloadYear = payload.forYear ?? payload.academicYear ?? payload.year ?? payload.paymentYear ?? payload.approvedYear;
        if (payloadYear != null && payloadYear !== ''){
          const numeric = Number(payloadYear);
          if (Number.isFinite(numeric)) return numeric;
        }
      }
      const timestamp = Number(raw.approvedAt || raw.paymentDate || raw.paymentTimestamp || raw.timestamp || raw.createdAt || raw.updatedAt);
      if (Number.isFinite(timestamp)){
        const derived = new Date(timestamp).getFullYear();
        if (Number.isFinite(derived)) return derived;
      }
      return null;
    }

    function matchesApprovalYear(raw, targetYear, bucketYear){
      const normalizedTarget = Number(targetYear);
      if (!Number.isFinite(normalizedTarget)) return false;
      const recordYear = extractApprovalYear(raw);
      if (Number.isFinite(recordYear)){
        return recordYear === normalizedTarget;
      }
      const numericBucketYear = Number(bucketYear);
      if (Number.isFinite(numericBucketYear)){
        return numericBucketYear === normalizedTarget;
      }
      return false;
    }

    function cloneApprovalRecord(record){
      if (!record) return record;
      return { ...record };
    }

    async function loadApprovalsForYear(year){
      const targetYear = String(year || window.somapYearContext.getSelectedYear() || SOMAP_DEFAULT_YEAR);
      const scopeKey = approvalsScopeKey();
      const cacheKey = `${scopeKey}::${targetYear}`;
      if (approvalsByYearCache.has(cacheKey)){
        const cached = approvalsByYearCache.get(cacheKey) || [];
        return cached.map(cloneApprovalRecord);
      }
      const historyTree = await fetchApprovalsHistoryTree();
      const normalizedYear = Number(targetYear);
      const collected = [];
      Object.entries(historyTree || {}).forEach(([bucketYear, months]) => {
        Object.entries(months || {}).forEach(([bucketMonth, records]) => {
          Object.entries(records || {}).forEach(([id, raw]) => {
            if (!raw) return;
            if (!matchesApprovalYear(raw, normalizedYear, bucketYear)) return;
            const normalized = normalizeApprovalRecord(id, raw, { year: targetYear });
            if (!normalized) return;
            normalized.__bucketYear = bucketYear;
            normalized.__month = bucketMonth;
            collected.push(normalized);
          });
        });
      });
      collected.sort((a,b)=>(Number(b.approvedAt||0) - Number(a.approvedAt||0)));
      const stored = collected.map(cloneApprovalRecord);
      approvalsByYearCache.set(cacheKey, stored);
      return stored.map(cloneApprovalRecord);
    }

    function clearApprovalsCaches(){
      approvalsHistoryCache.clear();
      approvalsByYearCache.clear();
      monthCache.clear();
    }

    function normalizeSchoolId(value){
      return String(value || '').trim();
    }

    function applySchoolContext(candidate){
      const normalized = normalizeSchoolId(candidate);
      if (!normalized) return false;
      if (window.currentSchoolId === normalized) return false;
      window.currentSchoolId = normalized;
      try{ localStorage.setItem('somap_school', normalized); }catch{}
      clearApprovalsCaches();
      return true;
    }

    (function seedSchoolContext(){
      const paramSchool = urlParams.get('school') || urlParams.get('schoolId');
      let storedSchool = '';
      try{ storedSchool = localStorage.getItem('somap_school') || ''; }catch{}
      applySchoolContext(paramSchool || storedSchool);
    })();

    async function fetchScoped(path){
      const primary = scopedPath(path);
      let snap = null;
      try{
        snap = await db.ref(primary).once('value');
      }catch(err){
        console.warn('Scoped fetch failed', primary, err);
      }
      const needsFallback = (!snap || !snap.exists()) && primary !== path;
      if (needsFallback){
        try{
          const fallback = await db.ref(path).once('value');
          return fallback;
        }catch(err){
          console.warn('Fallback fetch failed', path, err);
        }
      }
      return snap;
    }

    function createEmptyTargets(){
      const base = {};
      PAYMENT_ROWS.forEach(row => {
        base[row.key] = { required:0, planLabel:'', debtStage:'', dueDate:'', colorTone:'warn' };
      });
      return base;
    }

    const formatCurrency = v => {
      if (v == null || v === '') return '--';
      const num = Number(v) || 0;
      return `TSh ${num.toLocaleString('en-US',{maximumFractionDigits:0})}`;
    };
    const formatDateTime = v => {
      const d = new Date(Number(v));
      if (Number.isNaN(d.getTime())) return '--';
      return d.toLocaleString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'});
    };
    const formatDateOnly = v => {
      const d = new Date(Number(v));
      if (Number.isNaN(d.getTime())) return '--';
      return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});
    };
    const toNumber = val => {
      if (typeof val === 'number') return val;
      if (typeof val === 'string'){
        const cleaned = val.replace(/[^0-9.-]/g,'');
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : 0;
      }
      return Number(val)||0;
    };

    function parseMoneyValue(val){
      if (typeof val === 'number') return Number.isFinite(val) ? val : 0;
      if (typeof val === 'string'){
        const cleaned = val.replace(/[^0-9.-]/g,'');
        const n = Number(cleaned);
        return Number.isFinite(n) ? n : 0;
      }
      return Number(val) || 0;
    }

    function parseTimestampLike(value){
      const numeric = Number(value);
      if (Number.isFinite(numeric) && numeric > 0) return numeric;
      if (typeof value === 'string' && value.trim()){
        const parsed = Date.parse(value);
        if (!Number.isNaN(parsed)) return parsed;
      }
      return 0;
    }

    function numberToWordsTZS(val){
      const belowTwenty=['Zero','One','Two','Three','Four','Five','Six','Seven','Eight','Nine','Ten','Eleven','Twelve','Thirteen','Fourteen','Fifteen','Sixteen','Seventeen','Eighteen','Nineteen'];
      const tens=['','','Twenty','Thirty','Forty','Fifty','Sixty','Seventy','Eighty','Ninety'];
      const num = Math.abs(Math.floor(Number(val)||0));
      if (num<20) return `${belowTwenty[num]} Tanzanian Shillings only`;
      function helper(n){
        if(n<20) return belowTwenty[n];
        if(n<100) return tens[Math.floor(n/10)] + (n%10?` ${belowTwenty[n%10]}`:'');
        if(n<1000) return `${helper(Math.floor(n/100))} Hundred${n%100?` ${helper(n%100)}`:''}`;
        if(n<1e6) return `${helper(Math.floor(n/1000))} Thousand${n%1000?` ${helper(n%1000)}`:''}`;
        if(n<1e9) return `${helper(Math.floor(n/1e6))} Million${n%1e6?` ${helper(n%1e6)}`:''}`;
        return `${helper(Math.floor(n/1e9))} Billion${n%1e9?` ${helper(n%1e9)}`:''}`;
      }
      return `${helper(num)} Tanzanian Shillings only`;
    }

    function buildFullName(s){
      if (!s) return '';
      return `${s.firstName||''} ${s.middleName||''} ${s.lastName||''}`.replace(/\s+/g,' ').trim();
    }

    function escapeHtml(value){
      return String(value ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function getInitials(name, max=2){
      if (!name) return '--';
      const parts = name.trim().split(/\s+/).filter(Boolean).slice(0,max);
      return parts.map(p=>p[0]?.toUpperCase()||'').join('') || '--';
    }

    function collectPrimaryContact(student){
      if (!student) return '';
      const fields = [student.motherPhone, student.parentPhone, student.primaryParentContact, student.guardianPhone, student.phone1, student.phone2, student.whatsapp];
      const val = fields.find(Boolean);
      return val ? String(val) : '';
    }

    function resolveAdmissionNumber(student, fallback){
      const candidates = [
        student?.admissionNumber,
        student?.admissionNo,
        student?.registrationNumber,
        student?.admNo,
        student?.pupilId,
        student?.autoId,
        fallback
      ];
      const found = candidates.find(val => val && String(val).trim());
      return found ? String(found).trim() : '';
    }

    function normalizeAdmission(value){
      return String(value || '').trim().toLowerCase();
    }

    function resolveStudentKeyFromAdmission(admission, studentsMap, enrollAnchorMap, enrollYearMap){
      const needle = normalizeAdmission(admission);
      if (!needle) return '';
      const admissionFields = ['admissionNumber','admissionNo','admNo','registrationNumber','autoId','pupilId','studentAdm'];
      const scan = (mapObj) => {
        if (!mapObj || typeof mapObj !== 'object') return '';
        for (const [key, row] of Object.entries(mapObj)){
          if (!row || typeof row !== 'object') continue;
          for (const field of admissionFields){
            const candidate = normalizeAdmission(row[field]);
            if (candidate && candidate === needle) return String(key);
          }
        }
        return '';
      };
      return scan(studentsMap) || scan(enrollYearMap) || scan(enrollAnchorMap) || '';
    }

    function resolvePhotoUrl(student, fallbackUrl){
      if (!student && !fallbackUrl) return '';
      const direct = student?.photoUrl
        || student?.passportPhotoUrl
        || student?.passportPhotoURL
        || student?.passportPhoto
        || student?.passport
        || student?.imageUrl
        || student?.image
        || student?.avatar
        || student?.avatarUrl
        || student?.profilePhoto
        || fallbackUrl;
      if (direct) return direct;
      const publicId = student?.cloudinaryPublicId || student?.cloudinaryId || student?.passportPublicId || student?.photoPublicId;
      const cloud = student?.cloudinaryCloud || window.SOMAP_CLOUDINARY_CLOUD || CLOUDINARY_FALLBACK;
      if (publicId) {
        return `https://res.cloudinary.com/${cloud}/image/upload/c_thumb,w_180,h_180,g_face,r_max/${publicId}.jpg`;
      }
      return '';
    }

    function deriveReceiptInitials(approval){
      const baseName = approval?.studentName || buildFullName(state.studentRecord);
      const initials = getInitials(baseName, 3).replace(/[^A-Z]/gi,'');
      if (initials) return initials;
      const fallbackAdm = resolveAdmissionNumber(state.studentRecord, state.studentId) || approval?.studentAdm || '';
      const cleanFallback = String(fallbackAdm || '').replace(/[^A-Z]/gi,'');
      return cleanFallback ? cleanFallback.slice(0,3).toUpperCase() : 'SIA';
    }

    function formatReceiptSequence(seq){
      if (!seq) return '000';
      const numeric = Number(seq);
      if (!Number.isFinite(numeric) || numeric <= 0) return '000';
      return numeric.toString().padStart(3,'0');
    }

    function formatReceiptNumber(approval){
      if (!approval) return '--';
      const seq = state.receiptNumbers?.[approval.id];
      if (!seq) return approval.id || '--';
      const initials = deriveReceiptInitials(approval);
      const receiptYear = approval.receiptYear || state.year || SOMAP_DEFAULT_YEAR;
      return `${initials}${receiptYear}${formatReceiptSequence(seq)}`;
    }

    function normalizeFingerprintToken(value){
      return String(value == null ? '' : value)
        .trim()
        .toLowerCase()
        .replace(/\s+/g,' ');
    }

    function buildReceiptFingerprint(entry, financeYear){
      const studentToken = normalizeFingerprintToken(
        entry?.studentId || entry?.studentAdm || state.studentId || state.queryStudent || ''
      );
      const yearToken = normalizeFingerprintToken(
        entry?.receiptYear || entry?.financeYear || financeYear || state.year || SOMAP_DEFAULT_YEAR
      );
      const amountToken = parseMoneyValue(entry?.amountPaidNow || entry?.amount || 0).toFixed(2);
      const timeToken = String(parseTimestampLike(entry?.paymentDate || entry?.approvedAt || 0) || 0);
      const methodToken = normalizeFingerprintToken(entry?.paymentMethod || entry?.method || '');
      const refToken = normalizeFingerprintToken(
        entry?.paymentReferenceCode || entry?.referenceCode || entry?.reference || entry?.note || ''
      );
      return `${studentToken}|${yearToken}|${amountToken}|${timeToken}|${methodToken}|${refToken}`;
    }

    function buildReceiptNumberMap(approvals){
      if (!Array.isArray(approvals) || !approvals.length) return {};
      const sorted = approvals.slice().sort((a,b)=>{
        const aTime = Number(a.approvedAt || a.paymentDate || a.receiptUpdatedAt || 0);
        const bTime = Number(b.approvedAt || b.paymentDate || b.receiptUpdatedAt || 0);
        if (aTime === bTime){
          return (a.id || '').localeCompare(b.id || '');
        }
        return aTime - bTime;
      });
      const map = {};
      sorted.forEach((item, index) => {
        if (!item?.id) return;
        map[item.id] = index + 1;
      });
      return map;
    }

    function moduleToRowKey(module){
      if (!module) return 'other';
      const key = module.toString().toLowerCase();
      return MODULE_LOOKUP[key] || 'other';
    }

    function parseBreakdown(entries){
      const arr = Array.isArray(entries) ? entries : Object.values(entries||{});
      const map = {};
      arr.forEach(item => {
        if (!item) return;
        const label = (item.label || item.title || item.name || '').toString().trim();
        if (!label) return;
        const lower = label.toLowerCase();
        map[lower] = {
          numeric: toNumber(item.value ?? item.amount ?? item.total ?? item.display ?? 0),
          text: item.display || item.value || item.amount || item.total || ''
        };
      });
      return map;
    }

    function extractFromBreakdown(map, needle){
      if (!map) return { numeric:0, text:'' };
      const key = Object.keys(map).find(k => k.includes(needle));
      return key ? map[key] : { numeric:0, text:'' };
    }
    function normalizeApprovalRecord(id, raw, context = {}){
      if (!raw) return null;
      const payload = (()=>{
        if (!raw.modulePayload) return {};
        if (typeof raw.modulePayload === 'string'){
          try{ return JSON.parse(raw.modulePayload); }catch{return {}; }
        }
        return raw.modulePayload;
      })();
      const breakdown = parseBreakdown(payload.breakdown || raw.breakdown);
      const sourceModule = raw.sourceModule || raw.module || raw.paymentModule || 'other';
      const rowKey = moduleToRowKey(sourceModule);
      const amountPaidNow = Number(raw.amountPaidNow ?? raw.amount ?? payload.amount ?? 0);
      const paymentInfo = payload.payment || raw.payment || {};
      const paymentMethod = raw.paymentMethod || paymentInfo.method || raw.method || 'Cash';
      const approvedAt = Number(raw.approvedAt || raw.approved_on || raw.timestamp || raw.createdAt || raw.updatedAt || Date.now());
      const paymentTimestamp = Number(paymentInfo.timestamp || paymentInfo.time || raw.paymentDate || raw.datePaid || payload.timestamp || approvedAt);
      const referenceCode = raw.paymentReferenceCode || paymentInfo.referenceCode || paymentInfo.reference || raw.referenceCode || raw.reference || raw.ref || '';
      const paidBy = raw.paidBy || paymentInfo.paidBy || paymentInfo.by || raw.payer || raw.parentName || raw.guardianName || 'Parent/Guardian';
      const payerContact = raw.payerContact || paymentInfo.contact || raw.contactOfPayer || raw.parentPhone || raw.guardianPhone || '';
      const totalRequired = Number(raw.totalRequired || extractFromBreakdown(breakdown,'fee').numeric || extractFromBreakdown(breakdown,'year').numeric || payload.totalRequired || 0);
      const totalPaidBefore = Number(raw.totalPaidBefore || extractFromBreakdown(breakdown,'total paid before').numeric || 0);
      const balanceAfter = Number(raw.newBalanceAfterThis || extractFromBreakdown(breakdown,'balance after').numeric || raw.balance || 0);
      const planEntry = extractFromBreakdown(breakdown,'plan');
      const debtEntry = extractFromBreakdown(breakdown,'debt');
      const dueEntry = extractFromBreakdown(breakdown,'due');
      const planLabel = raw.planLabel || payload.planLabel || payload.plan?.name || planEntry.text || (planEntry.numeric ? `${planEntry.numeric}` : '');
      const debtStage = raw.debtStage || payload.debtStage || debtEntry.text || (debtEntry.numeric ? `Debt till ${debtEntry.numeric}` : '');
      const dueDate = raw.dueDate || payload.dueDate || payload.plan?.nextDueDate || dueEntry.text || dueEntry.numeric;
      const studentId = raw.studentKey || raw.studentId || raw.student_id || raw.studentUID || raw.studentKeyId || payload.studentKey;
      const studentAdm = raw.studentAdm || raw.studentAdmission || raw.admissionNumber || raw.admissionNo || payload.studentAdm || payload.studentAdmission;
      const className = raw.className || raw.studentClass || raw.classLevel || payload.className;
      const motherPhone = raw.motherPhone || raw.parentPhone || payload.parentPhone;
      const amountWords = numberToWordsTZS(amountPaidNow);
      const resolvedYearCandidate = context.year || raw.year || raw.paymentYear || raw.academicYear || raw.academic_year || raw.approvalYear || raw.approvedYear || raw.yearId;
      const derivedYear = Number.isFinite(approvedAt) ? new Date(approvedAt).getFullYear() : null;
      const receiptYear = String(resolvedYearCandidate || derivedYear || SOMAP_DEFAULT_YEAR);
      return {
        id: id || raw.id || raw.approvalId || raw.receiptId || raw.uid,
        sourceModule,
        rowKey,
        moduleLabel: (PAYMENT_ROWS.find(r=>r.key===rowKey)?.label) || 'Other',
        modulePath: PAYMENT_ROWS.find(r=>r.key===rowKey)?.path || '--',
        amountPaidNow,
        paymentMethod,
        paymentReferenceCode: referenceCode,
        paidBy,
        payerContact,
        approvedAt,
        approvedBy: raw.approvedBy || raw.approved_by || raw.approvedByName || '--',
        paymentDate: paymentTimestamp,
        receiptUpdatedAt: Number(raw.receiptUpdatedAt || raw.updatedAt || approvedAt),
        totalRequired,
        totalPaidBefore,
        totalPaidAfter: totalPaidBefore + amountPaidNow,
        balanceAfter,
        planLabel,
        debtStage,
        dueDate,
        studentId,
        studentAdm,
        studentName: raw.studentName || raw.student || raw.learnerName || payload.studentName,
        className,
        motherPhone,
        amountWords,
        breakdownMap: breakdown,
        note: raw.note || raw.description || payload.note || payload.reason || raw.reason || '',
        photoUrl: raw.studentPhoto || raw.photoUrl || payload.photoUrl || '',
        receiptYear,
      };
    }

    function normalizeLedgerReceiptRecord(rowKey, payment, context = {}){
      if (!payment) return null;
      const amountPaidNow = parseMoneyValue(payment.amount ?? payment.value ?? payment.paid ?? payment.total ?? 0);
      if (!Number.isFinite(amountPaidNow) || amountPaidNow <= 0) return null;
      const sourceModule = payment.sourceModule || payment.module || payment.paymentModule || 'finance';
      const approvedAt = parseTimestampLike(
        payment.timestamp || payment.datePaid || payment.paymentDate || payment.createdAt || payment.updatedAt || Date.now()
      );
      const paymentTimestamp = parseTimestampLike(
        payment.paymentDate || payment.timestamp || payment.datePaid || approvedAt
      );
      const referenceCode =
        payment.paymentReferenceCode ||
        payment.referenceCode ||
        payment.reference ||
        payment.ref ||
        payment.note ||
        payment.remarks ||
        '';
      const paymentMethod = payment.method || payment.mode || payment.paymentMethod || 'Cash';
      const rowKeyResolved = moduleToRowKey(sourceModule);
      const receiptYear = String(context.year || payment.academicYear || payment.financeYear || SOMAP_DEFAULT_YEAR);
      return {
        id: '',
        sourceModule,
        rowKey: rowKeyResolved,
        moduleLabel: (PAYMENT_ROWS.find(r=>r.key===rowKeyResolved)?.label) || 'School Fees',
        modulePath: 'finance.html',
        amountPaidNow,
        paymentMethod,
        paymentReferenceCode: referenceCode,
        paidBy: payment.paidBy || payment.payer || payment.parentName || context.studentName || 'Parent/Guardian',
        payerContact: payment.payerContact || payment.contact || context.payerContact || '',
        approvedAt,
        approvedBy: payment.approvedBy || 'Finance Ledger',
        paymentDate: paymentTimestamp,
        receiptUpdatedAt: Number(payment.updatedAt || approvedAt),
        totalRequired: Number(context.totalRequired || 0),
        totalPaidBefore: 0,
        totalPaidAfter: 0,
        balanceAfter: 0,
        planLabel: context.planLabel || '',
        debtStage: context.debtStage || '',
        dueDate: context.dueDate || '',
        studentId: context.studentId || '',
        studentAdm: context.studentAdm || '',
        studentName: context.studentName || '',
        className: context.className || '',
        motherPhone: context.payerContact || '',
        amountWords: numberToWordsTZS(amountPaidNow),
        breakdownMap: {},
        note: payment.note || payment.remarks || payment.description || '',
        photoUrl: '',
        receiptYear,
        financeYear: receiptYear,
        fromLedger: true,
        ledgerRowKey: rowKey || '',
      };
    }

    function mergeReceiptRecords(approvals, ledgerRows, financeYear){
      const merged = [];
      const byFingerprint = new Map();
      const addRow = (row) => {
        if (!row) return;
        const fingerprint = buildReceiptFingerprint(row, financeYear);
        const existing = byFingerprint.get(fingerprint);
        if (!existing){
          const base = {
            ...row,
            receiptYear: String(row.receiptYear || financeYear || state.year || SOMAP_DEFAULT_YEAR),
            financeYear: String(row.financeYear || row.receiptYear || financeYear || state.year || SOMAP_DEFAULT_YEAR),
            receiptFingerprint: fingerprint,
            ledgerDuplicateCount: row.fromLedger ? 1 : 0,
            possibleDuplicate: false,
          };
          if (!base.id) base.id = `RCPT-${fingerprint.slice(0,16).replace(/[^a-z0-9]/gi,'').toUpperCase()}`;
          byFingerprint.set(fingerprint, base);
          merged.push(base);
          return;
        }
        if (row.fromLedger){
          existing.ledgerDuplicateCount = Number(existing.ledgerDuplicateCount || 0) + 1;
          if (existing.ledgerDuplicateCount > 1){
            existing.possibleDuplicate = true;
          }
        }
        if (!existing.fromLedger && row.fromLedger){
          return;
        }
        if (existing.fromLedger && !row.fromLedger){
          const keepMeta = {
            receiptFingerprint: existing.receiptFingerprint,
            ledgerDuplicateCount: existing.ledgerDuplicateCount,
            possibleDuplicate: existing.possibleDuplicate,
          };
          Object.assign(existing, row, keepMeta);
          return;
        }
      };

      (approvals || []).forEach(addRow);
      (ledgerRows || []).forEach(addRow);

      merged.sort((a,b)=>{
        const aTime = Number(a.approvedAt || a.paymentDate || a.receiptUpdatedAt || 0);
        const bTime = Number(b.approvedAt || b.paymentDate || b.receiptUpdatedAt || 0);
        if (aTime === bTime) return String(a.id || '').localeCompare(String(b.id || ''));
        return bTime - aTime;
      });

      return merged;
    }

    function matchesStudent(approval, studentId, adm){
      if (!approval) return false;
      if (studentId && approval.studentId && String(approval.studentId).trim() === String(studentId).trim()) return true;
      if (adm && approval.studentAdm && String(approval.studentAdm).trim().toLowerCase() === String(adm).trim().toLowerCase()) return true;
      return false;
    }

    async function getApprovalsMonth(year, month){
      const key = `${year}-${month}`;
      if (monthCache.has(key)) return monthCache.get(key);
      const historyTree = await fetchApprovalsHistoryTree();
      const normalizedYear = Number(year);
      const normalizedMonth = String(month).padStart(2,'0');
      const bucket = {};
      Object.entries(historyTree || {}).forEach(([bucketYear, months]) => {
        const monthRecords = (months || {})[normalizedMonth];
        if (!monthRecords) return;
        Object.entries(monthRecords || {}).forEach(([id, raw]) => {
          if (!raw) return;
          if (!matchesApprovalYear(raw, normalizedYear, bucketYear)) return;
          bucket[id] = { ...raw };
        });
      });
      monthCache.set(key, bucket);
      return bucket;
    }

    async function findApprovalById(year, approvalId){
      if (!approvalId) return null;
      const approvals = await loadApprovalsForYear(year);
      const found = approvals.find(item => {
        if (!item) return false;
        if (String(item.id) === String(approvalId)) return true;
        if (item.approvalId && String(item.approvalId) === String(approvalId)) return true;
        if (item.receiptId && String(item.receiptId) === String(approvalId)) return true;
        return false;
      });
      return found ? { ...found } : null;
    }

    async function fetchApprovalsForStudent(year, studentId, adm){
      const approvals = await loadApprovalsForYear(year);
      const filtered = approvals.filter(rec => matchesStudent(rec, studentId, adm));
      return filtered;
    }

    async function fetchLedgerReceiptsForStudent(year, studentId, adm, studentRecord){
      const yearStr = String(year || state.year || SOMAP_DEFAULT_YEAR);
      const admission = String(adm || '').trim();
      const resolvedStudentKeyFromAdmission = resolveStudentKeyFromAdmission(
        admission,
        state.students || {},
        state.enrollAnchor || {},
        state.enrollYear || {}
      );
      const studentIdFromDirectory = (!studentId && admission)
        ? resolveStudentId(admission, state.students || {})
        : null;
      const identifierCandidates = Array.from(new Set([
        studentId,
        resolvedStudentKeyFromAdmission,
        studentIdFromDirectory,
        admission,
        sanitizeKey(admission),
        studentRecord?.admissionNumber,
        studentRecord?.admissionNo,
        studentRecord?.admNo,
        studentRecord?.registrationNumber,
        studentRecord?.autoId,
      ].filter(Boolean).map(v => String(v).trim()).filter(Boolean)));

      const mapRows = (paymentsMap, finance = null) => {
        const rows = Object.entries(paymentsMap || {})
          .map(([rowKey, payment]) => normalizeLedgerReceiptRecord(rowKey, payment, {
            year: yearStr,
            studentId: studentId || finance?.studentId || '',
            studentAdm: admission || finance?.admissionNumber || '',
            studentName: buildFullName(studentRecord) || finance?.fullName || '',
            className: studentRecord?.classLevel || finance?.classLevel || '',
            payerContact: collectPrimaryContact(studentRecord),
            totalRequired: Number(finance?.due || 0),
            planLabel: finance?.paymentPlan || '',
            debtStage: finance?.record?.debtStage || '',
            dueDate: finance?.record?.nextDueDate || '',
          }))
          .filter(Boolean);
        const sortedAsc = rows.slice().sort((a,b)=>Number(a.paymentDate||0)-Number(b.paymentDate||0));
        let runningTotal = 0;
        const due = Number(finance?.due || 0);
        sortedAsc.forEach(row => {
          row.totalPaidBefore = runningTotal;
          runningTotal += Number(row.amountPaidNow || 0);
          row.totalPaidAfter = runningTotal;
          row.balanceAfter = Math.max(0, due - runningTotal);
        });
        return rows;
      };

      if (window.SomapFinance && typeof window.SomapFinance.loadStudentFinance === 'function'){
        for (const identifier of identifierCandidates){
          try{
            const finance = await window.SomapFinance.loadStudentFinance(yearStr, identifier);
            const paymentsMap = finance?.record?.payments || {};
            const rows = mapRows(paymentsMap, finance);
            if (rows.length) return rows;
          }catch(err){
            console.warn('Receipt: finance helper lookup failed', { identifier, year: yearStr, err });
          }
        }
      }

      // Fallback: read ledger paths directly (same year scope), useful when student/admission mapping is inconsistent.
      const aggregated = {};
      const matchesFinanceYear = (payment, allowUnknown = false) => {
        const directYear = Number(
          payment?.academicYear ??
          payment?.financeYear ??
          payment?.feeYear ??
          payment?.year ??
          payment?._year
        );
        if (Number.isFinite(directYear)) return String(directYear) === yearStr;
        const ts = parseTimestampLike(
          payment?.paymentDate ||
          payment?.timestamp ||
          payment?.datePaid ||
          payment?.createdAt ||
          payment?.date ||
          payment?.time ||
          0
        );
        if (Number.isFinite(ts) && ts > 0){
          return String(new Date(ts).getFullYear()) === yearStr;
        }
        return Boolean(allowUnknown);
      };
      const injectPaymentMap = (paymentsObj, prefix, allowUnknownYear = false) => {
        Object.entries(paymentsObj || {}).forEach(([payKey, payVal]) => {
          if (!payVal || typeof payVal !== 'object') return;
          if (!matchesFinanceYear(payVal, allowUnknownYear)) return;
          const dedupeKey = `${prefix}:${payKey}`;
          aggregated[dedupeKey] = payVal;
        });
      };
      for (const identifier of identifierCandidates){
        const rawKey = String(identifier || '').trim();
        if (!rawKey) continue;
        const possibleKeys = Array.from(new Set([rawKey, sanitizeKey(rawKey)]));
        for (const key of possibleKeys){
          try{
            const snap = await fetchScoped(`financeLedgers/${yearStr}/${key}`);
            const raw = snap?.val?.() || null;
            if (!raw || typeof raw !== 'object') continue;
            const bucket = raw.payments || raw.entries || raw.records || raw;
            injectPaymentMap(bucket || {}, `${key}`, true);
          }catch(_){}
          try{
            const studentSnap = await fetchScoped(`students/${key}/payments`);
            const studentPayments = studentSnap?.val?.() || {};
            injectPaymentMap(studentPayments, `students:${key}`);
          }catch(_){}
          try{
            const feePaymentsSnap = await fetchScoped(`fees/${yearStr}/${key}/payments`);
            injectPaymentMap(feePaymentsSnap?.val?.() || {}, `fees:${yearStr}:${key}`, true);
          }catch(_){}
          try{
            const paymentsSnap = await fetchScoped(`payments/${key}`);
            injectPaymentMap(paymentsSnap?.val?.() || {}, `payments:${key}`);
          }catch(_){}
          try{
            const feesPaymentsSnap = await fetchScoped(`feesPayments/${key}`);
            injectPaymentMap(feesPaymentsSnap?.val?.() || {}, `feesPayments:${key}`);
          }catch(_){}
        }
      }
      let rows = mapRows(aggregated, null);
      if (rows.length) return rows;

      // Last-resort: scan finance/{year} class buckets for this admission if class is unknown.
      const admissionKeys = Array.from(new Set([
        admission,
        sanitizeKey(admission),
      ].filter(Boolean)));
      try{
        const financeYearSnap = await fetchScoped(`finance/${yearStr}`);
        const financeYearTree = financeYearSnap?.val?.() || {};
        Object.entries(financeYearTree || {}).forEach(([classKey, classNode]) => {
          if (!classNode || typeof classNode !== 'object') return;
          admissionKeys.forEach((admKey) => {
            const entry = classNode?.[admKey];
            if (!entry || typeof entry !== 'object') return;
            const paymentMap = entry.payments || entry.entries || entry.records || {};
            injectPaymentMap(paymentMap, `finance:${yearStr}:${classKey}:${admKey}`, true);
          });
        });
      }catch(_){}
      rows = mapRows(aggregated, null);
      if (rows.length) return rows;

      // Final fallback: scan all financeLedgers/{year} entries and match by internal admission fields.
      try{
        const ledgerYearSnap = await fetchScoped(`financeLedgers/${yearStr}`);
        const ledgerYearTree = ledgerYearSnap?.val?.() || {};
        const admissionNeedle = normalizeAdmission(admission);
        Object.entries(ledgerYearTree || {}).forEach(([nodeKey, nodeVal]) => {
          if (!nodeVal || typeof nodeVal !== 'object') return;
          const admissionCandidates = [
            nodeVal.admissionNumber,
            nodeVal.admissionNo,
            nodeVal.admNo,
            nodeVal.registrationNumber,
            nodeVal.studentAdm,
          ].map(normalizeAdmission).filter(Boolean);
          const keyMatchesAdmission = normalizeAdmission(nodeKey) === admissionNeedle;
          const bodyMatchesAdmission = admissionCandidates.includes(admissionNeedle);
          if (!keyMatchesAdmission && !bodyMatchesAdmission) return;
          const paymentMap = nodeVal.payments || nodeVal.entries || nodeVal.records || {};
          injectPaymentMap(paymentMap, `financeLedgers:${yearStr}:${nodeKey}`, true);
        });
      }catch(_){}
      rows = mapRows(aggregated, null);
      return rows;
    }

    async function fetchReceiptRecordsForStudent(year, studentId, adm, studentRecord){
      const [approvals, ledgerRows] = await Promise.all([
        fetchApprovalsForStudent(year, studentId, adm),
        fetchLedgerReceiptsForStudent(year, studentId, adm, studentRecord),
      ]);
      return mergeReceiptRecords(approvals, ledgerRows, String(year));
    }

    function resolveStudentId(query, students){
      if (!query) return null;
      const normalized = String(query).trim().toLowerCase();
      if (students[query]) return query;
      const match = Object.keys(students).find(key => {
        const s = students[key];
        const admissions = [s.admissionNumber, s.admissionNo, s.admNo, s.registrationNumber, s.autoId];
        return admissions.some(adm => adm && String(adm).trim().toLowerCase() === normalized);
      });
      return match || null;
    }

    function findStudentByName(name, students){
      if (!name) return null;
      const normalized = name.trim().toLowerCase();
      return Object.keys(students).find(key => buildFullName(students[key]).toLowerCase() === normalized) || null;
    }

    function performLookup(value, mode){
      const trimmed = String(value || '').trim();
      if (!trimmed) return;
      const lookupMode = mode === 'receipt' ? 'receipt' : 'student';
      if (lookupMode === 'receipt'){
        urlParams.set('approvalId', trimmed);
        urlParams.delete('student');
        state.queryApproval = trimmed;
        state.queryStudent = '';
        syncUrlParams();
        hydrateState();
        return;
      }
      const students = state.students || {};
      let studentId = resolveStudentId(trimmed, students);
      if (!studentId) studentId = findStudentByName(trimmed, students);
      const admission = studentId ? (students[studentId]?.admissionNumber || students[studentId]?.admissionNo || trimmed) : trimmed;
      state.queryStudent = admission;
      state.queryApproval = '';
      urlParams.set('student', admission);
      urlParams.delete('approvalId');
      if (window.currentSchoolId){
        urlParams.set('school', window.currentSchoolId);
      }
      syncUrlParams();
      hydrateState();
    }

    function buildStudentIdentifierCandidates(studentId, admission, studentRecord){
      const bucket = new Set();
      const add = value => {
        if (!value) return;
        const trimmed = String(value || '').trim();
        if (!trimmed) return;
        bucket.add(trimmed);
      };
      add(studentId);
      add(admission);
      add(studentRecord?.admissionNumber);
      add(studentRecord?.admissionNo);
      add(studentRecord?.admNo);
      add(studentRecord?.registrationNumber);
      add(studentRecord?.autoId);
      add(studentRecord?.pupilId);
      add(studentRecord?.studentKey);
      add(studentRecord?.autoRef);
      return Array.from(bucket);
    }

    async function fetchFirstMatch(keys, pathBuilder){
      if (!Array.isArray(keys)) return null;
      for (const rawKey of keys){
        const sanitized = sanitizeKey(String(rawKey || ''));
        if (!sanitized) continue;
        try{
          const snap = await fetchScoped(pathBuilder(sanitized));
          if (snap && snap.exists()) return snap;
        }catch(_){}
      }
      return null;
    }

    async function ensureApprovalYear(approvalId, preferredYear){
      if (!approvalId) return null;
      const base = String(preferredYear || window.somapYearContext.getSelectedYear() || SOMAP_DEFAULT_YEAR);
      const yearsToCheck = [base, ...SOMAP_ALLOWED_YEARS.map(String).filter(y=>y!==base)];
      for (const candidateYear of yearsToCheck){
        const result = await findApprovalById(candidateYear, approvalId);
        if (result) return candidateYear;
      }
      return null;
    }

    async function fetchStudentFeeSnapshot(year, keys){
      if (!Array.isArray(keys)) return null;
      for (const rawKey of keys){
        const sanitized = sanitizeKey(String(rawKey || ''));
        if (!sanitized) continue;
        try{
          const snap = await fetchScoped(`studentFees/${year}/${sanitized}`);
          if (snap && snap.exists()) return snap;
        }catch(_){}
        try{
          const legacy = await fetchScoped(`finance/${year}/studentFees/${sanitized}`);
          if (legacy && legacy.exists()) return legacy;
        }catch(_){}
      }
      return null;
    }

    async function loadTargetAmounts(year, studentId, admission, studentRecord){
      const targets = createEmptyTargets();
      const recordFee = Number(studentRecord?.feePerYear || studentRecord?.feeDue || studentRecord?.totalFee || 0);
      if (!studentId){
        if (recordFee > 0) targets.schoolFees.required = recordFee;
        if (!targets.schoolFees.planLabel && studentRecord?.paymentPlan){
          targets.schoolFees.planLabel = studentRecord.paymentPlan;
        }
        if (!targets.schoolFees.debtStage && studentRecord?.debtStage){
          targets.schoolFees.debtStage = studentRecord.debtStage;
        }
        return targets;
      }
      const identifierCandidates = buildStudentIdentifierCandidates(studentId, admission, studentRecord);
      const feePromise = fetchStudentFeeSnapshot(year, identifierCandidates);
      const gradPromise = fetchFirstMatch(identifierCandidates, key => `graduation/${year}/students/${key}`);
      const carryPromise = fetchFirstMatch(identifierCandidates, key => `financeCarryForward/${year}/${key}`);
      const [feeSnap,statusSnap,transportSnap,fridaySnap,gradSnap,carrySnap] = await Promise.all([
        feePromise,
        fetchScoped(`financeStatuses/${year}/${studentId}`),
        fetchScoped(`transportExpected/${year}/${studentId}`),
        fetchScoped(`fridayPlans/${year}/${studentId}`),
        gradPromise,
        carryPromise
      ]);
      const fee = feeSnap?.val() || {};
      if (fee && Object.keys(fee).length){
        targets.schoolFees.required = Number(fee.feePerYear || fee.annualFee || fee.required || 0);
        targets.schoolFees.planLabel = fee.planLabel || fee.paymentPlan || fee.plan || targets.schoolFees.planLabel;
        targets.schoolFees.debtStage = fee.debtStage || targets.schoolFees.debtStage;
        targets.schoolFees.dueDate = fee.nextDueDate || targets.schoolFees.dueDate;
      }
      const status = statusSnap?.val() || {};
      if (status && Object.keys(status).length){
        targets.schoolFees.debtStage = status.debtTill || status.debtStage || targets.schoolFees.debtStage;
        targets.schoolFees.dueDate = status.nextDue || status.nextDueDate || targets.schoolFees.dueDate;
      }
      const transport = transportSnap?.val() || {};
      if (transport && Object.keys(transport).length){
        targets.transport.required = Number(transport.expected || transport.annualFee || transport.target || 0);
        targets.transport.planLabel = transport.plan || transport.schedule || targets.transport.planLabel;
        targets.transport.debtStage = transport.debtStage || targets.transport.debtStage;
        targets.transport.dueDate = transport.nextDue || targets.transport.dueDate;
      }
      const friday = fridaySnap?.val() || {};
      if (friday && Object.keys(friday).length){
        targets.friday.required = Number(friday.expected || friday.target || friday.total || 0);
        targets.friday.planLabel = friday.plan || friday.frequency || targets.friday.planLabel;
      }
      const grad = gradSnap?.val() || {};
      if (grad && Object.keys(grad).length){
        targets.graduation.required = Number(grad.expectedFee || grad.expected || 0);
        targets.graduation.planLabel = grad.plan || targets.graduation.planLabel;
        targets.graduation.debtStage = grad.debtStage || targets.graduation.debtStage;
        targets.graduation.dueDate = grad.dueDate || targets.graduation.dueDate;
      }
      let baseFee = Number(targets.schoolFees.required) || 0;
      if (baseFee <= 0 && recordFee > 0){
        baseFee = recordFee;
      }
      const carryRaw = carrySnap?.val() || null;
      const carryAmount = Number(
        typeof carryRaw === 'number'
          ? carryRaw
          : (carryRaw?.amount ?? carryRaw?.balance ?? carryRaw?.carry ?? carryRaw?.total ?? 0)
      ) || 0;
      if (carryAmount > 0){
        targets.schoolFees.carryForward = carryAmount;
      }
      targets.schoolFees.required = Math.max(0, baseFee + carryAmount);
      if (!targets.schoolFees.planLabel && studentRecord?.paymentPlan){
        targets.schoolFees.planLabel = studentRecord.paymentPlan;
      }
      if (!targets.schoolFees.debtStage && studentRecord?.debtStage){
        targets.schoolFees.debtStage = studentRecord.debtStage;
      }
      if ((studentId || admission) && typeof window.SomapFinance?.loadStudentFinance === 'function'){
        try{
          const identifier = studentId || admission;
          const financeSnapshot = await window.SomapFinance.loadStudentFinance(year, identifier);
          if (financeSnapshot){
            const due = Number(financeSnapshot.due || 0);
            if (due > 0){
              targets.schoolFees.required = due;
            }
            if (!targets.schoolFees.planLabel && financeSnapshot.paymentPlan){
              targets.schoolFees.planLabel = financeSnapshot.paymentPlan;
            }
            const record = financeSnapshot.record || {};
            const recordCarry = Number(record.carryAmount || 0);
            if (recordCarry > 0){
              targets.schoolFees.carryForward = recordCarry;
            }
            if (!targets.schoolFees.debtStage && record.debtStage){
              targets.schoolFees.debtStage = record.debtStage;
            }
            if (!targets.schoolFees.dueDate && record.nextDueDate){
              targets.schoolFees.dueDate = record.nextDueDate;
            }
          }
        }catch(err){
          console.warn('Receipt: unable to sync finance snapshot', err);
        }
      }
      return targets;
    }

    function sanitizeKey(val){
      return String(val||'').replace(/[.#$/\[\]]/g,'_');
    }

    function deriveStatusTone(balance, stage){
      if (balance <= 0) return { text: stage || 'Cleared', tone:'good' };
      if (stage && /overdue|dirisha|late|mk|debt/i.test(stage)) return { text: stage, tone:'bad' };
      return { text: stage || 'In progress', tone:'warn' };
    }

    function buildSummaryRows(approvals, activeApproval, targets){
      const rows = {};
      PAYMENT_ROWS.forEach(row => {
        rows[row.key] = {
          label: row.label,
          paidNow: activeApproval && activeApproval.rowKey === row.key ? activeApproval.amountPaidNow : 0,
          reference: activeApproval && activeApproval.rowKey === row.key ? (activeApproval.paymentReferenceCode || '--') : '--',
          receiptUpdated: activeApproval && activeApproval.rowKey === row.key ? formatDateOnly(activeApproval.receiptUpdatedAt) : '--',
          paymentDate: activeApproval && activeApproval.rowKey === row.key ? formatDateOnly(activeApproval.paymentDate) : '--',
          totalPaid: 0,
          required: targets[row.key]?.required || 0,
          plan: targets[row.key]?.planLabel || '',
          debtStage: targets[row.key]?.debtStage || '',
          dueDate: targets[row.key]?.dueDate || '',
          balance: 0,
          tone:'warn'
        };
      });

      approvals.forEach(rec => {
        const bucket = rows[rec.rowKey] || rows.other;
        bucket.totalPaid += Number(rec.amountPaidNow || 0);
        if (!bucket.plan && rec.planLabel) bucket.plan = rec.planLabel;
        if (!bucket.debtStage && rec.debtStage) bucket.debtStage = rec.debtStage;
        if (!bucket.dueDate && rec.dueDate) bucket.dueDate = rec.dueDate;
        if (!bucket.required && rec.totalRequired) bucket.required = rec.totalRequired;
      });

      PAYMENT_ROWS.forEach(row => {
        const bucket = rows[row.key];
        bucket.balance = bucket.required ? Math.max(bucket.required - bucket.totalPaid, 0) : (activeApproval && activeApproval.rowKey === row.key ? Math.max(activeApproval.balanceAfter,0) : 0);
        const tone = deriveStatusTone(bucket.balance, bucket.debtStage);
        bucket.tone = tone.tone;
        bucket.debtStageLabel = tone.text || bucket.debtStage || '--';
      });

      return rows;
    }
    function setField(id, value){
      const el = document.getElementById(id);
      if (el) el.textContent = value ?? '--';
    }

    function toggle(el, condition){
      if (!el) return;
      el.classList.toggle('hidden', !condition);
    }

    function setEmptyStateVisible(show, message){
      const card = document.getElementById('receiptEmptyState');
      if (!card) return;
      card.classList.toggle('hidden', !show);
      if (show && message){
        const msg = card.querySelector('[data-empty-message]');
        if (msg) msg.textContent = message;
      }
    }

    function setLoading(isLoading){
      const loader = document.getElementById('loadingState');
      if (!loader) return;
      loader.classList.toggle('hidden', !isLoading);
    }

    function showError(message){
      const banner = document.getElementById('errorBanner');
      if (!banner) return;
      if (!message){ banner.classList.add('hidden'); return; }
      banner.textContent = message;
      banner.classList.remove('hidden');
      setTimeout(()=>banner.classList.add('hidden'), 6000);
    }

    function syncUrlParams(){
      const query = urlParams.toString();
      const nextUrl = query ? `${location.pathname}?${query}` : location.pathname;
      history.replaceState({}, '', nextUrl);
    }

    async function hydrateState(){
      const token = ++renderToken;
      setLoading(true);
      showError('');
      try{
        const currentYear = window.somapYearContext.getSelectedYear();
        let approvalLookupFailed = false;
        if (state.queryApproval){
          const resolvedYear = await ensureApprovalYear(state.queryApproval, currentYear);
          if (token !== renderToken) return;
          if (resolvedYear){
            if (String(resolvedYear) !== String(currentYear)){
              window.somapYearContext.setSelectedYear(resolvedYear);
              return;
            }
          } else {
            approvalLookupFailed = true;
            showError('Receipt not found for any supported year.');
          }
        }
        const { y, students, enrollAnchor, enrollYear } = await loadYearData(window.somapYearContext.getSelectedYear());
        if (token !== renderToken) return;
        state.year = y;
        state.students = students;
        state.enrollAnchor = enrollAnchor;
        state.enrollYear = enrollYear;

        let normalizedApproval = null;
        if (state.queryApproval && !approvalLookupFailed){
          const approvalRecord = await findApprovalById(state.year, state.queryApproval);
          if (token !== renderToken) return;
          if (approvalRecord) normalizedApproval = approvalRecord;
          else showError('Receipt not found in this year.');
        }

        let studentId = resolveStudentId(state.queryStudent, students);
        if (!studentId && normalizedApproval?.studentId && students[normalizedApproval.studentId]) studentId = normalizedApproval.studentId;
        if (!studentId && normalizedApproval?.studentAdm) studentId = resolveStudentId(normalizedApproval.studentAdm, students);
        if (!studentId && normalizedApproval?.studentName) studentId = findStudentByName(normalizedApproval.studentName, students);

        state.studentId = studentId;
        state.studentRecord = studentId ? students[studentId] : null;
        if (!state.studentRecord && normalizedApproval){
          state.studentRecord = {
            firstName: normalizedApproval.studentName || 'Student',
            lastName: '',
            admissionNumber: normalizedApproval.studentAdm || state.queryStudent || '',
            motherPhone: normalizedApproval.motherPhone || normalizedApproval.payerContact || '',
            primaryParentContact: normalizedApproval.motherPhone || normalizedApproval.payerContact || '',
            classLevel: normalizedApproval.className || ''
          };
        }
        const candidateSchool = state.studentRecord?.schoolId || state.studentRecord?.school || state.studentRecord?.schoolKey || normalizedApproval?.schoolId || normalizedApproval?.school || urlParams.get('school') || '';
        const changedSchool = applySchoolContext(candidateSchool);
        if (changedSchool){
          const refreshed = await loadYearData(state.year);
          if (token !== renderToken) return;
          state.students = refreshed.students;
          state.enrollAnchor = refreshed.enrollAnchor;
          state.enrollYear = refreshed.enrollYear;
          if (state.studentId && !state.students[state.studentId]){
            state.studentId = resolveStudentId(state.queryStudent, state.students);
          }
          if (!state.studentId && state.queryStudent){
            state.studentId = resolveStudentId(state.queryStudent, state.students);
          }
          state.studentRecord = state.studentId ? state.students[state.studentId] : state.studentRecord;
        }
        if (window.currentSchoolId){
          urlParams.set('school', window.currentSchoolId);
          syncUrlParams();
        }
        const admission = state.studentRecord?.admissionNumber || normalizedApproval?.studentAdm || state.queryStudent || '';

        if (!state.queryStudent && admission){
          urlParams.set('student', admission);
          syncUrlParams();
          state.queryStudent = admission;
        }

        const receipts = (studentId || admission)
          ? await fetchReceiptRecordsForStudent(state.year, studentId, admission, state.studentRecord)
          : [];
        if (token !== renderToken) return;
        state.approvals = receipts;

        if (normalizedApproval){
          const exists = receipts.find(a=>a.id === normalizedApproval.id);
          if (!exists) state.approvals.unshift(normalizedApproval);
          state.activeApproval = normalizedApproval;
        } else {
          state.activeApproval = receipts[0] || null;
        }

        state.receiptNumbers = buildReceiptNumberMap(state.approvals);

        state.targets = await loadTargetAmounts(state.year, state.studentId, admission, state.studentRecord);
        if (token !== renderToken) return;
        state.summaryRows = buildSummaryRows(state.approvals, state.activeApproval, state.targets);
        renderPage();
      }catch(err){
        console.error(err);
        showError(err?.message || 'Failed to load receipt.');
      }finally{
        if (token === renderToken) setLoading(false);
      }
    }

    function renderPage(){
      renderIdentity();
      renderReceiptDetails();
      renderSummaryTable();
      renderReceiptsList();
      if (VIEW_KIND !== 'parent') renderStudentDirectory();
      updateActionButtons();
    }

    function renderIdentity(){
      const name = state.studentRecord ? buildFullName(state.studentRecord) : (state.activeApproval?.studentName || 'Student');
      setField('studentName', name || 'Student');
      const admission = state.studentRecord?.admissionNumber || state.activeApproval?.studentAdm || state.queryStudent || '--';
      setField('studentAdmission', `Admission: ${admission || '--'}`);
      const contact = collectPrimaryContact(state.studentRecord) || state.activeApproval?.motherPhone || state.activeApproval?.payerContact || '--';
      setField('motherContact', contact || '--');
      const fallbackClass = state.studentRecord?.classLevel || state.studentRecord?.className || state.activeApproval?.className || '';
      const classLabel = state.studentId
        ? (resolveClassForYear(state.studentId, state.enrollAnchor, state.enrollYear, state.year, fallbackClass) || fallbackClass)
        : (fallbackClass || '--');
      setField('studentClass', classLabel || '--');
      const graduated = classLabel && classLabel.toUpperCase().includes('GRADUATED');
      toggle(document.getElementById('graduatedBadge'), graduated);
      if (graduated) setField('graduatedBadge', `Graduated (${state.year})`);
      const photo = resolvePhotoUrl(state.studentRecord, state.activeApproval?.photoUrl);
      const avatarImage = document.getElementById('avatarImage');
      const avatarInitials = document.getElementById('avatarInitials');
      if (photo){
        avatarImage.src = photo;
        avatarImage.classList.remove('hidden');
        avatarInitials.classList.add('hidden');
      } else {
        avatarImage.classList.add('hidden');
        avatarInitials.classList.remove('hidden');
        avatarInitials.textContent = getInitials(name);
      }
    }

    function renderReceiptDetails(){
      const approval = state.activeApproval;
      setEmptyStateVisible(!approval, !approval ? `Use the lookup to load receipts for ${state.year}.` : '');
      if (!approval){
        setField('receiptNumber','--');
        setField('receiptDate','--');
        ['fieldReceivedFrom','fieldPaymentOf','fieldPaidBy','fieldPayerContact','fieldAmountFigures','fieldAmountWords','fieldReference','fieldPaymentDate','paymentLabel','paymentPathLabel','fieldMethod','fieldFiguresFooter','fieldWordsFooter','approvedOn','approvedBy'].forEach(id=>setField(id,'--'));
        const badge = document.getElementById('statusBadge');
        badge.textContent = 'Pending';
        badge.className = 'status-pill bg-amber-50 text-amber-600 border border-amber-200';
        return;
      }
      setField('receiptNumber', formatReceiptNumber(approval));
      setField('receiptDate', formatDateTime(approval.approvedAt));
      setField('fieldReceivedFrom', approval.paidBy || 'Parent/Guardian');
      setField('fieldPaymentOf', approval.moduleLabel || '--');
      setField('fieldPaidBy', approval.paidBy || '--');
      setField('fieldPayerContact', approval.payerContact || '--');
      setField('fieldAmountFigures', formatCurrency(approval.amountPaidNow));
      setField('fieldAmountWords', approval.amountWords || numberToWordsTZS(approval.amountPaidNow));
      setField('fieldReference', `${approval.paymentReferenceCode || '--'}${approval.possibleDuplicate ? ' (Possible duplicate)' : ''}`);
      setField('fieldPaymentDate', formatDateOnly(approval.paymentDate));
      setField('paymentLabel', `${approval.moduleLabel || 'Payment'} -- ${formatCurrency(approval.amountPaidNow)}`);
      setField('paymentPathLabel', `Source: ${approval.modulePath}`);
      setField('fieldMethod', approval.paymentMethod || 'Cash');
      setField('fieldFiguresFooter', formatCurrency(approval.amountPaidNow));
      setField('fieldWordsFooter', approval.amountWords || numberToWordsTZS(approval.amountPaidNow));
      setField('approvedOn', formatDateTime(approval.approvedAt));
      setField('approvedBy', approval.approvedBy || '--');
      const badge = document.getElementById('statusBadge');
      const tone = deriveStatusTone(Math.max(approval.balanceAfter||0,0), approval.debtStage);
      badge.textContent = tone.text;
      const toneClass = tone.tone==='good' ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' : tone.tone==='bad' ? 'bg-rose-50 text-rose-600 border border-rose-200' : 'bg-amber-50 text-amber-600 border border-amber-200';
      badge.className = `status-pill ${toneClass}`;
    }

    function renderSummaryTable(){
      state.summaryRows = buildSummaryRows(state.approvals, state.activeApproval, state.targets);
      const tbody = document.getElementById('summaryBody');
      if (!tbody) return;
      tbody.innerHTML = PAYMENT_ROWS.map(row => {
        const bucket = state.summaryRows[row.key];
        const toneClass = bucket.tone==='good' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : bucket.tone==='bad' ? 'bg-rose-50 text-rose-600 border-rose-200' : 'bg-amber-50 text-amber-600 border-amber-200';
        return `
          <tr class="border-t border-slate-100 text-slate-700">
            <td class="px-3 py-3 font-semibold">${row.label}</td>
            <td class="px-3 py-3 text-right">${bucket.paidNow ? formatCurrency(bucket.paidNow) : '--'}</td>
            <td class="px-3 py-3">${bucket.reference || '--'}</td>
            <td class="px-3 py-3">${bucket.receiptUpdated || '--'}</td>
            <td class="px-3 py-3">${bucket.paymentDate || '--'}</td>
            <td class="px-3 py-3 text-right">${bucket.totalPaid ? formatCurrency(bucket.totalPaid) : '--'}</td>
            <td class="px-3 py-3 text-right">${bucket.required ? formatCurrency(bucket.required) : '--'}</td>
            <td class="px-3 py-3 text-right">${bucket.balance ? formatCurrency(bucket.balance) : (bucket.required ? 'Cleared' : '--')}</td>
            <td class="px-3 py-3">${bucket.plan || '--'}</td>
            <td class="px-3 py-3"><span class="status-pill ${toneClass}">${bucket.debtStageLabel || '--'}</span></td>
            <td class="px-3 py-3">${bucket.dueDate ? formatDateOnly(bucket.dueDate) : '--'}</td>
          </tr>`;
      }).join('');
    }

    function renderReceiptsList(){
      const panel = document.getElementById('receiptsPanel');
      if (!panel) return;
      const list = document.getElementById('receiptsList');
      const empty = document.getElementById('listEmpty');
      const shouldShow = state.approvals.length > 1 || Boolean(state.queryStudent);
      panel.classList.toggle('hidden', !shouldShow);
      if (!shouldShow) return;
      if (!state.approvals.length){
        if (list) list.innerHTML = '';
        if (empty){
          empty.textContent = state.queryStudent
            ? `No receipts for ${state.queryStudent} in ${state.year}.`
            : `No receipts in ${state.year}.`;
          empty.classList.remove('hidden');
        }
        return;
      }
      if (empty) empty.classList.add('hidden');
      if (!list) return;
      list.innerHTML = state.approvals.map(item => {
        const active = state.activeApproval && item.id === state.activeApproval.id;
        const receiptNo = formatReceiptNumber(item);
        const duplicateFlag = item.possibleDuplicate ? '<span class="ml-2 rounded-full border border-amber-300 bg-amber-100 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-amber-700">Possible duplicate</span>' : '';
        return `
          <div class="list-card ${active ? 'border-sky-400 ring-2 ring-sky-500/40' : ''}" data-id="${item.id}">
            <div class="flex items-center justify-between gap-3">
              <div>
                <p class="text-sm font-semibold text-white">${item.moduleLabel}${duplicateFlag}</p>
                <p class="text-xs text-slate-300">${receiptNo} &bull; ${formatDateOnly(item.approvedAt)} &bull; Ref ${item.paymentReferenceCode || '--'}</p>
              </div>
              <div class="text-right">
                <p class="text-base font-semibold text-emerald-300">${formatCurrency(item.amountPaidNow)}</p>
                <button class="mt-1 inline-flex items-center gap-1 rounded-full border border-white/30 px-3 py-1 text-xs text-white" data-view="${item.id}"><i class="fa-regular fa-eye"></i><span>View</span></button>
              </div>
            </div>
          </div>`;
      }).join('');
      list.querySelectorAll('button[data-view]').forEach(btn => {
        btn.addEventListener('click', e => {
          const id = e.currentTarget.getAttribute('data-view');
          const found = state.approvals.find(a=>a.id===id);
          if (!found) return;
          state.activeApproval = found;
          state.summaryRows = buildSummaryRows(state.approvals, state.activeApproval, state.targets);
          urlParams.set('approvalId', id);
          syncUrlParams();
          renderPage();
        });
      });
    }

    function buildStudentDirectoryRows(){
      const dataset = state.students || {};
      const filter = String(state.studentFilter || '').trim().toLowerCase();
      const rows = Object.entries(dataset).map(([id, student]) => {
        const admission = resolveAdmissionNumber(student, id);
        const fullName = buildFullName(student) || 'Student';
        const baseClass = student?.classLevel || student?.className || '';
        const classLabel = resolveClassForYear(id, state.enrollAnchor, state.enrollYear, state.year, baseClass) || baseClass || '--';
        const contact = collectPrimaryContact(student) || '--';
        const searchBlob = `${admission} ${fullName} ${classLabel}`.toLowerCase();
        return { id, admission, fullName, classLabel, contact, searchBlob };
      });
      const filtered = filter ? rows.filter(row => row.searchBlob.includes(filter)) : rows;
      filtered.sort((a,b)=>a.fullName.localeCompare(b.fullName));
      return filtered;
    }

    function renderStudentDirectory(){
      if (VIEW_KIND === 'parent') return;
      const tbody = document.getElementById('studentsDirectoryBody');
      if (!tbody) return;
      const countEl = document.getElementById('studentsDirectoryCount');
      const yearHint = document.getElementById('studentsDirectoryYearHint');
      if (yearHint) yearHint.textContent = `Working year ${state.year || SOMAP_DEFAULT_YEAR}`;
      const rows = buildStudentDirectoryRows();
      if (countEl) countEl.textContent = rows.length.toLocaleString('en-US');
      const emptyMsg = document.getElementById('studentsDirectoryEmpty');
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-6 text-center text-sm text-slate-400">${state.studentFilter ? 'No students match your search.' : 'Students will appear here once loaded.'}</td></tr>`;
        if (emptyMsg) emptyMsg.classList.remove('hidden');
        return;
      }
      if (emptyMsg) emptyMsg.classList.add('hidden');
      const activeAdmission = (state.studentRecord?.admissionNumber || state.queryStudent || '').trim().toLowerCase();
      const printable = rows;
      tbody.innerHTML = printable.map(row => {
        const normalizedAdm = String(row.admission || '').trim().toLowerCase();
        const isActive = (state.studentId && state.studentId === row.id) || (activeAdmission && normalizedAdm && normalizedAdm === activeAdmission);
        const toneClass = isActive ? 'bg-sky-500/10 text-white' : 'text-slate-200';
        const label = isActive ? 'Active' : 'View';
        return `
          <tr class="${toneClass} border-b border-white/5 last:border-0">
            <td class="px-4 py-3 font-semibold">${escapeHtml(row.admission || '--')}</td>
            <td class="px-4 py-3">
              <p class="font-semibold">${escapeHtml(row.fullName)}</p>
              <p class="text-xs text-slate-400">#${escapeHtml(row.id)}</p>
            </td>
            <td class="px-4 py-3">${escapeHtml(row.classLabel || '--')}</td>
            <td class="px-4 py-3">${escapeHtml(row.contact || '--')}</td>
            <td class="px-4 py-3 text-right">
              <button type="button" class="inline-flex items-center gap-2 rounded-full border border-sky-400/70 px-3 py-1 text-xs font-semibold text-sky-100 transition hover:bg-sky-500/20" data-student-action="view" data-student-id="${escapeHtml(row.id)}" data-student-adm="${escapeHtml(row.admission)}">
                <i class="fa-regular fa-eye"></i><span>${label}</span>
              </button>
            </td>
          </tr>`;
      }).join('');
    }

    function focusStudentFromDirectory(studentId, admission){
      const dataset = state.students || {};
      const student = dataset[studentId];
      const admissionValue = (admission && admission !== '--' ? admission : '') || resolveAdmissionNumber(student, studentId);
      const target = (admissionValue || studentId || '').trim();
      if (!target){
        showError('Student record is missing an admission number.');
        return;
      }
      state.queryApproval = '';
      state.queryStudent = target;
      urlParams.set('student', target);
      urlParams.delete('approvalId');
      if (window.currentSchoolId){
        urlParams.set('school', window.currentSchoolId);
      }
      syncUrlParams();
      window.scrollTo({ top:0, behavior:'smooth' });
      hydrateState();
    }

    function updateActionButtons(){
      const downloadBtn = document.getElementById('downloadReceiptBtn');
      if (downloadBtn){
        downloadBtn.disabled = !state.activeApproval;
        downloadBtn.classList.toggle('opacity-50', !state.activeApproval);
      }
    }

    async function downloadReceiptPdf(){
      if (!state.activeApproval) return;
      const canvasEl = document.getElementById('receiptCanvas');
      if (!canvasEl) return;
      document.body.classList.add('pdf-capture');
      const summaryScrollEl = canvasEl.querySelector('.summary-scroll');
      const summaryTableEl = canvasEl.querySelector('.summary-table');
      const originalSummaryOverflow = summaryScrollEl?.style.overflow;
      const originalSummaryMaxWidth = summaryScrollEl?.style.maxWidth;
      const originalSummaryWidth = summaryScrollEl?.style.width;
      const originalTableWidth = summaryTableEl?.style.width;
      const originalCanvasWidth = canvasEl.style.width;
      const originalCanvasMaxWidth = canvasEl.style.maxWidth;
      if (summaryScrollEl){
        summaryScrollEl.style.overflow = 'visible';
        summaryScrollEl.style.maxWidth = '100%';
        summaryScrollEl.style.width = '100%';
      }
      if (summaryTableEl){
        summaryTableEl.style.width = '100%';
      }
      canvasEl.style.width = '210mm';
      canvasEl.style.maxWidth = '210mm';
      const originalScroll = canvasEl.style.scrollBehavior;
      canvasEl.style.scrollBehavior = 'auto';
      const canvas = await html2canvas(canvasEl, {
        scale:3,
        useCORS:true,
        backgroundColor:'#ffffff',
        windowWidth: canvasEl.scrollWidth,
        windowHeight: canvasEl.scrollHeight
      });
      canvasEl.style.scrollBehavior = originalScroll;
      canvasEl.style.width = originalCanvasWidth || '';
      canvasEl.style.maxWidth = originalCanvasMaxWidth || '';
      if (summaryScrollEl){
        summaryScrollEl.style.overflow = originalSummaryOverflow || '';
        summaryScrollEl.style.maxWidth = originalSummaryMaxWidth || '';
        summaryScrollEl.style.width = originalSummaryWidth || '';
      }
      if (summaryTableEl){
        summaryTableEl.style.width = originalTableWidth || '';
      }
      document.body.classList.remove('pdf-capture');
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jspdf.jsPDF('p','pt','a4');
      const margin = 12;
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = pageWidth - margin * 2;
      const imgHeight = canvas.height * (imgWidth / canvas.width);
      const pageContentHeight = pageHeight - margin * 2;
      if (imgHeight <= pageContentHeight){
        const offsetX = (pageWidth - imgWidth) / 2;
        const offsetY = (pageHeight - imgHeight) / 2;
        pdf.addImage(imgData,'PNG', offsetX, offsetY, imgWidth, imgHeight);
      } else {
        let remainingHeight = imgHeight;
        let position = margin;
        pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
        remainingHeight -= pageContentHeight;
        while (remainingHeight > 0){
          pdf.addPage();
          position = margin - (imgHeight - remainingHeight);
          pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
          remainingHeight -= pageContentHeight;
        }
      }
      const receiptNo = formatReceiptNumber(state.activeApproval) || state.activeApproval.id || `receipt_${Date.now()}`;
      const safeReceipt = receiptNo.replace(/[^A-Za-z0-9_-]/g,'');
      const receiptYear = state.activeApproval?.receiptYear || state.year || SOMAP_DEFAULT_YEAR;
      const filename = `${safeReceipt}_${receiptYear}.pdf`;
      pdf.save(filename);
    }

    function bindUiEvents(){
      const printBtn = document.getElementById('printReceiptBtn');
      if (printBtn) printBtn.addEventListener('click', ()=>window.print());
      const downloadBtn = document.getElementById('downloadReceiptBtn');
      if (downloadBtn) downloadBtn.addEventListener('click', downloadReceiptPdf);
      const tableBtn = document.getElementById('tablePeekBtn');
      if (tableBtn) tableBtn.addEventListener('click', ()=>{
        const table = document.getElementById('yearSummaryTable');
        if (table) table.scrollIntoView({behavior:'smooth'});
      });
      const lookupForm = document.getElementById('receiptLookupForm');
      const lookupInput = document.getElementById('receiptLookupInput');
      const lookupMode = document.getElementById('receiptLookupMode');
      if (lookupForm){
        lookupForm.addEventListener('submit', e=>{
          e.preventDefault();
          const raw = lookupInput?.value?.trim();
          if (!raw){
            lookupInput?.focus();
            return;
          }
          performLookup(raw, lookupMode?.value);
        });
      }
      if (lookupMode && lookupInput){
        lookupMode.addEventListener('change', ()=>{
          lookupInput.placeholder = lookupMode.value === 'receipt'
            ? 'Receipt / approval reference'
            : 'Admission number or student name';
        });
      }
      if (VIEW_KIND !== 'parent'){
        const directorySearch = document.getElementById('studentsDirectorySearch');
        if (directorySearch){
          directorySearch.addEventListener('input', e=>{
            state.studentFilter = e.target.value || '';
            renderStudentDirectory();
          });
        }
        const directoryBody = document.getElementById('studentsDirectoryBody');
        if (directoryBody){
          directoryBody.addEventListener('click', e=>{
            const btn = e.target.closest('[data-student-action="view"]');
            if (!btn) return;
            const studentId = btn.getAttribute('data-student-id') || '';
            const admission = btn.getAttribute('data-student-adm') || '';
            focusStudentFromDirectory(studentId, admission);
          });
        }
      }
    }

    function applyViewKindVisibility(){
      if (VIEW_KIND !== 'parent') return;
      document.getElementById('studentsDirectory')?.classList.add('hidden');
      document.getElementById('studentsDirectory')?.setAttribute('aria-hidden','true');
      document.getElementById('receiptLookupForm')?.classList.add('hidden');
    }

    window.somapYearContext.onYearChanged(year => {
      urlParams.set('year', year);
      syncUrlParams();
      state.year = year;
      monthCache.clear();
      hydrateState();
    });

    document.addEventListener('DOMContentLoaded', () => {
      applyViewKindVisibility();
      bindUiEvents();
      hydrateState();
    });
  </script>
  <script src="../js/finance_plans.js"></script>
</body>
</html>
