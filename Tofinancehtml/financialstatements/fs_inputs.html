<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Statements Inputs</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../../firebase.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div class="max-w-5xl mx-auto px-4 py-6">
    <header class="flex items-start justify-between flex-col md:flex-row md:items-center gap-3 mb-4">
      <div>
        <p class="text-xs uppercase tracking-widest text-indigo-500">SoMAp</p>
        <h1 class="text-3xl font-semibold text-slate-900">Financial Statements Inputs</h1>
        <p class="text-sm text-slate-600">Mwaka: <span id="fsInputsYear"></span>. Jaza, kisha hifadhi.</p>
        <div id="fsStatus" class="text-xs text-emerald-600 mt-1"></div>
      </div>
      <div class="flex items-center gap-3">
        <a href="fs_dashboard.html" class="px-3 py-2 rounded bg-slate-200">Back</a>
        <a id="toPreviewLink" href="#" class="px-3 py-2 rounded bg-indigo-100 text-indigo-700">Preview</a>
      </div>
    </header>

    <div class="mb-4 p-4 bg-white rounded border border-indigo-100 shadow-sm">
      <div id="fsAggregates" class="text-sm text-slate-700">Loading finance summary...</div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-slate-100">
      <div class="flex overflow-auto border-b">
        <button data-tab="setup" class="px-4 py-3 text-sm font-semibold border-b-2 border-indigo-600 active">Setup</button>
        <button data-tab="fees" class="px-4 py-3 text-sm font-semibold text-slate-600">Students & Fees</button>
        <button data-tab="income" class="px-4 py-3 text-sm font-semibold text-slate-600">Income & Expenses</button>
        <button data-tab="assets" class="px-4 py-3 text-sm font-semibold text-slate-600">Assets & Liabilities</button>
        <button data-tab="tax" class="px-4 py-3 text-sm font-semibold text-slate-600">Tax & Equity</button>
      </div>

      <form id="fsForm" class="p-5 space-y-6">
        <section data-tab-panel="setup">
          <h2 class="text-xl font-semibold text-slate-900 mb-2">School setup</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <input data-model="schoolSetup.schoolName" class="w-full border rounded px-3 py-2" placeholder="School name">
            <input data-model="schoolSetup.tin" class="w-full border rounded px-3 py-2" placeholder="TIN">
            <input data-model="schoolSetup.registrationNo" class="w-full border rounded px-3 py-2" placeholder="Registration No">
            <input data-model="schoolSetup.bankName" class="w-full border rounded px-3 py-2" placeholder="Bank name">
            <input data-model="schoolSetup.bankBranch" class="w-full border rounded px-3 py-2" placeholder="Bank branch">
            <input data-model="schoolSetup.accountNo" class="w-full border rounded px-3 py-2" placeholder="Account number">
            <input data-model="yearMeta.preparedBy" class="w-full border rounded px-3 py-2" placeholder="Prepared by">
            <input data-model="yearMeta.approvedBy" class="w-full border rounded px-3 py-2" placeholder="Approved by">
          </div>
        </section>

        <section data-tab-panel="fees" class="hidden">
          <h2 class="text-xl font-semibold text-slate-900 mb-2">Students & Fees</h2>
          <div class="overflow-auto">
            <table class="min-w-full text-sm border">
              <thead class="bg-slate-100">
                <tr>
                  <th class="p-2 border text-left">Class</th>
                  <th class="p-2 border text-right">Students (__CURRENT__)</th>
                  <th class="p-2 border text-right">Fee (__CURRENT__)</th>
                  <th class="p-2 border text-right">Students (__PREV__)</th>
                  <th class="p-2 border text-right">Fee (__PREV__)</th>
                </tr>
              </thead>
              <tbody id="classFeesBody"></tbody>
            </table>
          </div>
        </section>

        <section data-tab-panel="income" class="hidden">
          <h2 class="text-xl font-semibold text-slate-900 mb-2">Income & Expenses</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Income (Note 1)</h3>
              <input data-type="number" data-model="incomeManual.transportIncome__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Transport (__CURRENT__)">
              <input data-type="number" data-model="incomeManual.otherIncome__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Other (__CURRENT__)">
              <input data-type="number" data-model="incomeManual.transportIncome__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Transport (__PREV__)">
              <input data-type="number" data-model="incomeManual.otherIncome__PREV__" class="w-full border rounded px-3 py-2" placeholder="Other (__PREV__)">
            </div>
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Personnel (Note 4)</h3>
              <input data-type="number" data-model="expensesManual.personnelExpenses.payroll__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Payroll (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.personnelExpenses.payroll__PREV__" class="w-full border rounded px-3 py-2" placeholder="Payroll (__PREV__)">
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 mt-4">
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Direct expenses (Note 2)</h3>
              <input data-type="number" data-model="expensesManual.directExpenses.foodPurchases__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Food (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.directExpenses.fuel__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Fuel (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.directExpenses.depreciation__CURRENT__Override" class="w-full border rounded px-3 py-2 mb-2" placeholder="Depreciation override">
              <input data-type="number" data-model="expensesManual.directExpenses.foodPurchases__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Food (__PREV__)">
              <input data-type="number" data-model="expensesManual.directExpenses.fuel__PREV__" class="w-full border rounded px-3 py-2" placeholder="Fuel (__PREV__)">
            </div>
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Admin (Note 3)</h3>
              <input data-type="number" data-model="expensesManual.adminExpenses.rent__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Rent (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.adminExpenses.repairs__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Repairs (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.adminExpenses.stationery__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Stationery (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.adminExpenses.rent__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Rent (__PREV__)">
              <input data-type="number" data-model="expensesManual.adminExpenses.repairs__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Repairs (__PREV__)">
              <input data-type="number" data-model="expensesManual.adminExpenses.stationery__PREV__" class="w-full border rounded px-3 py-2" placeholder="Stationery (__PREV__)">
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 mt-4">
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Professional (Note 5)</h3>
              <input data-type="number" data-model="expensesManual.professionalExpenses.auditFees__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Audit fees (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.professionalExpenses.other__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Other (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.professionalExpenses.auditFees__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Audit fees (__PREV__)">
              <input data-type="number" data-model="expensesManual.professionalExpenses.other__PREV__" class="w-full border rounded px-3 py-2" placeholder="Other (__PREV__)">
            </div>
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Financial (Note 6)</h3>
              <input data-type="number" data-model="expensesManual.financialExpenses.bankCharges__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Bank charges (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.financialExpenses.interest__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Interest (__CURRENT__)">
              <input data-type="number" data-model="expensesManual.financialExpenses.bankCharges__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Bank charges (__PREV__)">
              <input data-type="number" data-model="expensesManual.financialExpenses.interest__PREV__" class="w-full border rounded px-3 py-2" placeholder="Interest (__PREV__)">
            </div>
          </div>
        </section>

        <section data-tab-panel="assets" class="hidden">
          <h2 class="text-xl font-semibold text-slate-900 mb-2">Assets & Liabilities</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">PPE</h3>
              <input data-type="number" data-model="assetsManual.ppe.motorVehicles.count" class="w-full border rounded px-3 py-2 mb-2" placeholder="Motor vehicles - count">
              <input data-type="number" data-model="assetsManual.ppe.motorVehicles.costPerUnit" class="w-full border rounded px-3 py-2 mb-2" placeholder="Motor vehicles - cost per unit">
              <input data-type="number" data-model="assetsManual.ppe.motorVehicles.openingCost" class="w-full border rounded px-3 py-2 mb-2" placeholder="Motor vehicles - opening cost">
              <input data-type="number" data-model="assetsManual.ppe.motorVehicles.openingAccumDep" class="w-full border rounded px-3 py-2 mb-2" placeholder="Motor vehicles - opening accum dep">
              <input data-type="number" data-model="assetsManual.ppe.motorVehicles.depRate" class="w-full border rounded px-3 py-2 mb-2" placeholder="Motor vehicles - dep %">
            </div>
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Furniture / Computers</h3>
              <input data-type="number" data-model="assetsManual.ppe.furnitureFittings.count" class="w-full border rounded px-3 py-2 mb-2" placeholder="Furniture count">
              <input data-type="number" data-model="assetsManual.ppe.furnitureFittings.costPerUnit" class="w-full border rounded px-3 py-2 mb-2" placeholder="Furniture cost per unit">
              <input data-type="number" data-model="assetsManual.ppe.furnitureFittings.depRate" class="w-full border rounded px-3 py-2 mb-2" placeholder="Furniture dep %">
              <input data-type="number" data-model="assetsManual.ppe.computerAccessories.count" class="w-full border rounded px-3 py-2 mb-2" placeholder="Computer accessories count">
              <input data-type="number" data-model="assetsManual.ppe.computerAccessories.costPerUnit" class="w-full border rounded px-3 py-2 mb-2" placeholder="Computer accessories cost">
              <input data-type="number" data-model="assetsManual.ppe.computerAccessories.depRate" class="w-full border rounded px-3 py-2 mb-2" placeholder="Computer dep %">
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 mt-4">
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Land & Buildings</h3>
              <input data-type="number" data-model="assetsManual.ppe.land.cost" class="w-full border rounded px-3 py-2 mb-2" placeholder="Land cost">
              <input data-type="number" data-model="assetsManual.ppe.buildings.cost" class="w-full border rounded px-3 py-2 mb-2" placeholder="Building cost">
              <input data-type="number" data-model="assetsManual.ppe.buildings.openingAccumDep" class="w-full border rounded px-3 py-2 mb-2" placeholder="Building opening accum dep">
              <input data-type="number" data-model="assetsManual.ppe.buildings.depRate" class="w-full border rounded px-3 py-2" placeholder="Building dep %">
            </div>
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Current assets</h3>
              <input data-type="number" data-model="assetsManual.currentAssets.debtorsFees__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Debtors fees (__CURRENT__)">
              <input data-type="number" data-model="assetsManual.currentAssets.debtorsBusFees__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Debtors bus (__CURRENT__)">
              <input data-type="number" data-model="assetsManual.currentAssets.otherReceivables__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Other receivables (__CURRENT__)">
              <input data-type="number" data-model="assetsManual.currentAssets.bankNMB__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Bank NMB (__CURRENT__)">
              <input data-type="number" data-model="assetsManual.currentAssets.cashInHand__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Cash in hand (__CURRENT__)">
              <input data-type="number" data-model="assetsManual.currentAssets.otherBankAccounts__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Other bank (__CURRENT__)">
              <input data-type="number" data-model="assetsManual.currentAssets.debtorsFees__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Debtors fees (__PREV__)">
              <input data-type="number" data-model="assetsManual.currentAssets.debtorsBusFees__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Debtors bus (__PREV__)">
              <input data-type="number" data-model="assetsManual.currentAssets.otherReceivables__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Other receivables (__PREV__)">
              <input data-type="number" data-model="assetsManual.currentAssets.bankNMB__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Bank NMB (__PREV__)">
              <input data-type="number" data-model="assetsManual.currentAssets.cashInHand__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Cash in hand (__PREV__)">
              <input data-type="number" data-model="assetsManual.currentAssets.otherBankAccounts__PREV__" class="w-full border rounded px-3 py-2" placeholder="Other bank (__PREV__)">
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4 mt-4">
            <div class="p-3 border rounded">
              <h3 class="font-semibold text-slate-800 mb-2">Liabilities</h3>
              <input data-type="number" data-model="liabilitiesManual.tradeCreditors__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Trade creditors (__CURRENT__)">
              <input data-type="number" data-model="liabilitiesManual.auditFeesPayable__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Audit fees payable (__CURRENT__)">
              <input data-type="number" data-model="liabilitiesManual.taxPayable__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Tax payable (__CURRENT__)">
              <input data-type="number" data-model="liabilitiesManual.otherPayables__CURRENT__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Other payables (__CURRENT__)">
              <input data-type="number" data-model="liabilitiesManual.tradeCreditors__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Trade creditors (__PREV__)">
              <input data-type="number" data-model="liabilitiesManual.auditFeesPayable__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Audit fees payable (__PREV__)">
              <input data-type="number" data-model="liabilitiesManual.taxPayable__PREV__" class="w-full border rounded px-3 py-2 mb-2" placeholder="Tax payable (__PREV__)">
              <input data-type="number" data-model="liabilitiesManual.otherPayables__PREV__" class="w-full border rounded px-3 py-2" placeholder="Other payables (__PREV__)">
            </div>
          </div>
        </section>

        <section data-tab-panel="tax" class="hidden">
          <h2 class="text-xl font-semibold text-slate-900 mb-2">Tax & Equity</h2>
          <div class="grid md:grid-cols-3 gap-4">
            <input data-type="number" data-model="taxManual.taxRate" class="w-full border rounded px-3 py-2" placeholder="Tax rate %" value="30">
            <input data-type="number" data-model="taxManual.taxPaidInAdvance__CURRENT__" class="w-full border rounded px-3 py-2" placeholder="Tax paid advance (__CURRENT__)">
            <input data-type="number" data-model="taxManual.wearAndTearDeductionOverride" class="w-full border rounded px-3 py-2" placeholder="Wear & tear override">
            <input data-type="number" data-model="taxManual.shareCapital" class="w-full border rounded px-3 py-2" placeholder="Share capital">
            <input data-type="number" data-model="taxManual.openingRetainedEarnings" class="w-full border rounded px-3 py-2" placeholder="Opening retained earnings">
            <input data-type="number" data-model="taxManual.drawings" class="w-full border rounded px-3 py-2" placeholder="Drawings">
          </div>
        </section>

        <div class="flex justify-end">
          <button id="fsSaveBtn" type="button" class="px-4 py-2 rounded bg-indigo-600 text-white">Save & Recompute</button>
        </div>
      </form>
    </div>
  </div>

  <script src="../../Tojs/financialstatements/fs_engine.js"></script>
  <script src="../../Tojs/financialstatements/fs_mapping.js"></script>
  <script src="../../Tojs/financialstatements/fs_ui.js"></script>
  <script>
    function buildClassRows() {
      const tbody = document.getElementById('classFeesBody');
      if (!tbody || !window.FinancialStatementsUI?.classKeys) return;
      const rows = window.FinancialStatementsUI.classKeys.map((cls) => `
        <tr>
          <td class="p-2 border">${cls.label}</td>
          <td class="p-2 border"><input data-type="number" data-model="classFees.__CURRENT__.${cls.key}.students" class="w-full border rounded px-2 py-1 text-right"></td>
          <td class="p-2 border"><input data-type="number" data-model="classFees.__CURRENT__.${cls.key}.feePerStudent" class="w-full border rounded px-2 py-1 text-right"></td>
          <td class="p-2 border"><input data-type="number" data-model="classFees.__PREV__.${cls.key}.students" class="w-full border rounded px-2 py-1 text-right"></td>
          <td class="p-2 border"><input data-type="number" data-model="classFees.__PREV__.${cls.key}.feePerStudent" class="w-full border rounded px-2 py-1 text-right"></td>
        </tr>
      `).join('');
      tbody.innerHTML = rows;
    }
    document.addEventListener('DOMContentLoaded', () => {
      buildClassRows();
      const year = window.FinancialStatementsUI?.resolveYear?.() || new Date().getFullYear();
      const school = window.FinancialStatementsUI?.resolveSchoolId?.() || 'socrates';
      const previewLink = document.getElementById('toPreviewLink');
      if (previewLink) {
        previewLink.href = `fs_preview.html?schoolId=${encodeURIComponent(school)}&year=${encodeURIComponent(year)}`;
      }
      if (window.FinancialStatementsUI?.wireInputsPage) {
        window.FinancialStatementsUI.wireInputsPage();
      }
    });
  </script>
</body>
</html>
