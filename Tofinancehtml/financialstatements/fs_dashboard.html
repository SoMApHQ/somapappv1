<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Financial Statements Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="../../firebase.js"></script>
  <script src="../../somapappv1multischool/js/context.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
  <div id="fsShell" class="max-w-5xl mx-auto px-4 py-6">
    <header class="flex items-start justify-between flex-col md:flex-row md:items-center gap-3 mb-6">
      <div>
        <p class="text-xs uppercase tracking-widest text-indigo-500">SoMAp</p>
        <h1 class="text-3xl font-semibold text-slate-900">Financial Statements</h1>
        <p class="text-sm text-slate-600">Karibu! Chagua mwaka na endelea kujaza au ku-preview ripoti.</p>
      </div>
      <div class="flex items-center gap-3">
        <select id="fsYearSelect" class="rounded border px-3 py-2 bg-white shadow">
        </select>
        <div class="px-3 py-2 rounded bg-emerald-50 text-emerald-700 text-sm">
          Status: <span id="fsYearStatus" class="font-semibold">--</span>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
        <p class="text-xs uppercase tracking-wide text-slate-500 mb-1">Step 1</p>
        <h2 class="text-lg font-semibold text-slate-900 mb-2">Collect Inputs</h2>
        <p class="text-sm text-slate-600 mb-3">Jaza taarifa za shule, ada kwa kila darasa, mapato na matumizi.</p>
        <button id="gotoInputs" class="w-full px-3 py-2 rounded bg-indigo-600 text-white">Fill inputs</button>
      </div>
      <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-100">
        <p class="text-xs uppercase tracking-wide text-slate-500 mb-1">Step 2</p>
        <h2 class="text-lg font-semibold text-slate-900 mb-2">Preview Statements</h2>
        <p class="text-sm text-slate-600 mb-3">Tazama P&L, Balance Sheet, Cash Flow, Equity na Notes.</p>
        <button id="gotoPreview" class="w-full px-3 py-2 rounded bg-emerald-600 text-white">Open preview</button>
      </div>
      <div class="bg-indigo-700 text-white rounded-xl p-4 shadow-sm border border-indigo-400">
        <p class="text-xs uppercase tracking-wide text-indigo-100 mb-1">Info</p>
        <h2 id="fsSchoolName" class="text-lg font-semibold mb-2">Socrates audited format</h2>
        <p class="text-sm text-indigo-100">Ripoti zitafuata mpangilio wa TRA/Socrates. Unaweza kuzifunga (final) ukikamilisha.</p>
      </div>
    </div>
  </div>

  <div id="fsRestricted" class="max-w-3xl mx-auto px-4 py-12 hidden">
    <div class="rounded-xl border border-slate-200 bg-white p-8 shadow-sm text-center">
      <h2 class="text-2xl font-semibold text-slate-900">Restricted</h2>
      <p class="mt-2 text-slate-600">Financial statements are only available to this school&apos;s admins or accountants.</p>
      <a href="../../somapappv1multischool/multischool.html" class="mt-4 inline-flex items-center justify-center rounded-lg bg-indigo-600 px-4 py-2 text-white font-semibold shadow hover:bg-indigo-700">Switch School</a>
    </div>
  </div>

  <script src="../../Tojs/financialstatements/fs_engine.js"></script>
  <script src="../../Tojs/financialstatements/fs_mapping.js"></script>
  <script src="../../Tojs/financialstatements/fs_ui.js"></script>
  <script>
    (function () {
      const shell = document.getElementById('fsShell');
      const restricted = document.getElementById('fsRestricted');
      const schoolNameEl = document.getElementById('fsSchoolName');
      if (shell) shell.classList.add('hidden');

      const db = firebase.database();
      const auth = firebase.auth();

      const buildEmailKeys = (email) => {
        const safe = String(email || '').toLowerCase();
        if (!safe) return [];
        return Array.from(new Set([
          safe.replace(/\./g, '_'),
          safe.replace(/[@.]/g, '_'),
        ]));
      };

      async function fetchUserProfile(email) {
        const keys = buildEmailKeys(email);
        for (let i = 0; i < keys.length; i += 1) {
          const key = keys[i];
          const snap = await db.ref(`users/${key}`).once('value');
          if (snap.exists()) {
            return { key, data: snap.val() };
          }
        }
        return null;
      }

      function showRestricted(message) {
        if (shell) shell.classList.add('hidden');
        if (restricted) {
          const msg = restricted.querySelector('p.text-slate-600');
          if (msg && message) msg.textContent = message;
          restricted.classList.remove('hidden');
        }
      }

      auth.onAuthStateChanged(async (user) => {
        const school = window.SOMAP?.getSchool?.();
        if (!school || !school.id) {
          window.location.href = '../../somapappv1multischool/multischool.html';
          return;
        }
        if (!user) {
          showRestricted('Please sign in with your admin or accountant account.');
          return;
        }
        try {
          const profileRes = await fetchUserProfile(user.email);
          const profile = profileRes?.data || {};
          const role = String(profile.role || '').toLowerCase();
          const allowed = role === 'admin' || role === 'accountant';
          if (!allowed || profile.schoolId !== school.id) {
            showRestricted('Financial statements are only available to this school\'s admins or accountants.');
            return;
          }
          if (restricted) restricted.classList.add('hidden');
          if (shell) shell.classList.remove('hidden');
          if (schoolNameEl) {
            const label = school.name || school.code || school.id || 'School';
            schoolNameEl.textContent = `${label} audited format`;
          }
          if (window.FinancialStatementsUI?.wireDashboardPage) {
            window.FinancialStatementsUI.wireDashboardPage();
          }
        } catch (err) {
          console.error('FS Dashboard auth gate failed', err);
          showRestricted('Restricted. Please try again or contact support.');
        }
      });
    })();
  </script>
</body>
</html>
