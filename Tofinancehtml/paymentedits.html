<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payments & Installments Console</title>

  <!-- Tailwind CDN for quick layout primitives -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="../shared/finance_math.js"></script>
  <!-- Unified Finance Plans Service -->
  <script type="module" src="../js/financeplans.js"></script>

  <style>
    :root {
      color-scheme: dark;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top, rgba(79, 70, 229, 0.35), rgba(15, 23, 42, 0.95));
      min-height: 100vh;
    }
    .glass-shell {
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.16);
      border-radius: 28px;
      padding: 32px;
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      box-shadow: 0 25px 50px -12px rgba(15, 23, 42, 0.7);
    }
    .glass-panel {
      background: rgba(17, 25, 40, 0.65);
      border: 1px solid rgba(148, 163, 184, 0.18);
      border-radius: 22px;
      padding: 24px;
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.12), 0 18px 40px rgba(2, 6, 23, 0.45);
    }
    .glass-panel-light {
      background: rgba(30, 41, 59, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.12);
      border-radius: 18px;
      padding: 18px;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      font-size: 0.78rem;
      font-weight: 600;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.55rem 1.1rem;
      transition: transform 0.12s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    .btn:active {
      transform: translateY(1px) scale(0.99);
    }
    .btn-primary {
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.85), rgba(79, 70, 229, 0.85));
      border-color: rgba(99, 102, 241, 0.35);
      color: #e0e7ff;
      box-shadow: 0 8px 20px rgba(79, 70, 229, 0.35);
    }
    .btn-primary:hover {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(99, 102, 241, 0.9));
    }
    .btn-ghost {
      background: rgba(30, 41, 59, 0.4);
      border-color: rgba(148, 163, 184, 0.25);
      color: #cbd5f5;
    }
    .btn-ghost:hover {
      background: rgba(30, 41, 59, 0.55);
    }
    .btn-danger {
      background: linear-gradient(135deg, rgba(248, 113, 113, 0.85), rgba(239, 68, 68, 0.85));
      border-color: rgba(248, 113, 113, 0.35);
      color: #fee2e2;
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.35);
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.68rem;
      letter-spacing: 0.01em;
      text-transform: uppercase;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 0.18rem 0.55rem;
      border-radius: 0.85rem;
      font-size: 0.65rem;
      letter-spacing: 0.02em;
    }
    .input {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: rgba(15, 23, 42, 0.55);
      padding: 0.55rem 0.9rem;
      font-size: 0.9rem;
      color: #e2e8f0;
      transition: border 0.18s ease, background 0.18s ease;
    }
    .input:focus {
      outline: none;
      border-color: rgba(129, 140, 248, 0.75);
      background: rgba(30, 41, 59, 0.65);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.25);
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.2rem;
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.63rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }
    #toast {
      position: fixed;
      inset-inline-start: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      z-index: 90;
      background: rgba(34, 197, 94, 0.9);
      color: #022c22;
      padding: 0.7rem 1.3rem;
      border-radius: 999px;
      font-size: 0.82rem;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(16, 185, 129, 0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
    }
    #toast.show {
      opacity: 1;
      transform: translate(-50%, -12px);
    }
    .scroll-area {
      max-height: 540px;
      overflow-y: auto;
      overscroll-behavior: contain;
      scrollbar-width: thin;
    }
    .scroll-area::-webkit-scrollbar {
      width: 6px;
    }
    .scroll-area::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.35);
      border-radius: 999px;
    }
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.65);
      display: none;
      place-items: center;
      z-index: 100;
    }
    .modal-backdrop.show {
      display: grid;
    }
    .modal-card {
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 20px;
      width: min(640px, calc(100% - 32px));
      max-height: 84vh;
      overflow-y: auto;
      padding: 24px;
      box-shadow: 0 22px 45px rgba(2, 6, 23, 0.65);
    }
    .grid-mincard {
      display: grid;
      gap: 18px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }
  </style>
</head>
<body class="text-slate-100">
  <div class="max-w-7xl mx-auto py-10 px-4 md:px-8 space-y-6">
    <header class="glass-shell space-y-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
        <div class="space-y-2">
          <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Payments & Installments Console</h1>
          <p class="text-sm text-slate-300 max-w-2xl">
            Manage per-class school fees, reusable installment templates, and student-specific overrides for any academic year.
            All updates save instantly to Firebase once you confirm.
          </p>
        </div>
        <div class="glass-panel-light flex flex-wrap items-center gap-3 min-w-[240px]">
          <div class="space-y-1">
            <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Academic Year</p>
            <select data-somap-year-select class="input bg-slate-900/40 !rounded-lg !py-2 !pl-3 !pr-9 text-sm"></select>
          </div>
          <div>
            <p class="text-[10px] uppercase tracking-[0.3em] text-slate-400">Working Year</p>
            <p class="text-base font-semibold text-indigo-300" id="somapYearHint">â€”</p>
          </div>
        </div>
      </div>

      <div class="glass-panel-light flex flex-col lg:flex-row lg:items-center gap-4">
        <div class="flex flex-1 flex-col md:flex-row md:items-center gap-3">
          <div class="flex-1 flex gap-3">
            <div class="flex-1 relative">
              <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-xs text-slate-400"></i>
              <input id="searchClass" type="search" placeholder="Search classâ€¦" class="input pl-9 bg-slate-900/40 border-slate-700/60" />
            </div>
            <select id="classPicker" class="input flex-none w-44 bg-slate-900/40 border-slate-700/60">
              <option value="">All Classes</option>
            </select>
          </div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <button id="btnImportAllYears" class="btn btn-ghost"><i class="fa-solid fa-cloud-arrow-down"></i> Import All Years</button>
          <button id="btnImportThisYear" class="btn btn-ghost"><i class="fa-solid fa-copy"></i> Import This Year</button>
          <button id="btnAddClass" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Add / Update Class</button>
        </div>
      </div>
    </header>

    <div class="grid gap-6 xl:grid-cols-[2fr,1fr]">
      <section class="glass-panel space-y-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <h2 class="text-xl font-semibold tracking-tight">Class Fees & Defaults</h2>
            <p class="text-sm text-slate-300">Each card represents one class for the selected year. Adjust yearly fees, default plans, or installment windows.</p>
          </div>
          <div id="classesSummary" class="text-xs text-slate-400"></div>
        </div>
        <div id="emptyState" class="hidden text-sm text-slate-300 bg-slate-900/40 border border-slate-700/40 rounded-xl px-4 py-5 text-center">
          No class fee structure yet for this year. Use the import buttons or â€œAdd / Update Classâ€ to seed the data.
        </div>
        <div id="classesWrap" class="grid-mincard"></div>
      </section>

      <aside class="glass-panel space-y-5">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-semibold tracking-tight">Per-Student Overrides</h2>
            <p class="text-xs text-slate-300">Search a student by admission number or name to customize their fee or plan for this year.</p>
          </div>
          <button id="btnClearStudent" class="btn btn-ghost text-xs px-3"><i class="fa-solid fa-broom"></i> Clear</button>
        </div>
        <div class="flex gap-2">
          <input id="studentQuery" type="search" placeholder="Search admission/nameâ€¦" class="input flex-1 bg-slate-900/40 border-slate-700/50" />
          <button id="btnFindStudent" class="btn btn-primary text-xs px-4"><i class="fa-solid fa-search"></i></button>
        </div>
        <div id="studentPanel" class="scroll-area space-y-4 text-sm text-slate-200"></div>
      </aside>
    </div>

    <section class="glass-panel space-y-5">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold tracking-tight">Installment Plans Library</h2>
          <p class="text-sm text-slate-300">Reusable templates shared by multiple classes or students. A classâ€™s default plan should point to one of these.</p>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="btnAddPlan" class="btn btn-primary"><i class="fa-solid fa-plus"></i> New Plan</button>
          <button id="btnRefresh" class="btn btn-ghost"><i class="fa-solid fa-rotate"></i> Refresh</button>
        </div>
      </div>
      <div id="plansWrap" class="grid-mincard"></div>
    </section>
  </div>

  <div id="toast"><span id="toastMsg"></span></div>

  <div id="modalRoot" class="modal-backdrop">
    <div class="modal-card"></div>
  </div>

  <!-- Monthly Plan Modal (hidden by default) -->
  <div id="monthlyPlanModal" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-50" style="display: none;">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-4 mx-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold text-slate-900">Build Monthly Plan</h3>
        <button id="mpClose" class="text-slate-500 hover:text-slate-700 text-xl">✕</button>
      </div>
      <div id="mpContext" class="text-xs text-slate-600 mb-3"></div>
      <div class="grid grid-cols-2 gap-3 mb-3">
        <label class="text-sm text-slate-700">Plan ID
          <input id="mpPlanId" class="border rounded px-2 py-1 w-full text-sm" placeholder="monthly-40k-standard"/>
        </label>
        <label class="text-sm text-slate-700">Plan Name
          <input id="mpPlanName" class="border rounded px-2 py-1 w-full text-sm" placeholder="Monthly (40k) — Standard"/>
        </label>
        <label class="text-sm text-slate-700">Monthly Amount (TSh)
          <input id="mpAmount" type="number" inputmode="numeric" min="0" max="9999999" step="1" class="border rounded px-2 py-1 w-full text-sm" placeholder="e.g. 7000 or 40000" title="Enter amount without commas (e.g. 7000 for 7,000 TSh)"/>
        </label>
        <label class="text-sm text-slate-700">Due Day Start
          <input id="mpFromDay" type="number" class="border rounded px-2 py-1 w-full text-sm" value="1" min="1" max="28"/>
        </label>
        <label class="text-sm text-slate-700">Window Length (days)
          <input id="mpWindowLen" type="number" class="border rounded px-2 py-1 w-full text-sm" value="10" min="3" max="20"/>
        </label>
        <div class="text-sm text-slate-700 col-span-2">
          Double Months (cover 2 months in one payment)
          <div class="grid grid-cols-3 gap-1 mt-1 text-xs" id="mpDoubles">
            <!-- checkboxes will be populated by JS -->
          </div>
        </div>
        <div class="text-sm text-slate-700 col-span-2">
          Exclude Months (mark months that should NOT be paid)
          <div class="grid grid-cols-3 gap-1 mt-1 text-xs text-slate-800" id="mpExcluded">
            <!-- checkboxes will be populated by JS -->
          </div>
        </div>
      </div>
      <div class="mb-3">
        <label class="text-sm inline-flex items-center gap-2 text-slate-700">
          <input id="mpAssignClass" type="checkbox" class="scale-110">
          Assign as default plan to this class
        </label>
      </div>
      <div class="flex items-center gap-2 mb-3">
        <button id="mpPreview" class="px-3 py-1 text-xs rounded bg-slate-700 text-white hover:bg-slate-800">Preview</button>
        <button id="mpSave" class="px-3 py-1 text-xs rounded bg-emerald-600 text-white hover:bg-emerald-700">Save Plan</button>
        <button id="mpSaveAndApply" class="px-3 py-1 text-xs rounded bg-indigo-600 text-white hover:bg-indigo-700">Save + Apply to Student</button>
      </div>
      <div id="mpPreviewBox" class="mt-3 max-h-48 overflow-auto text-sm border rounded p-2 hidden"></div>
    </div>
  </div>

  <script>
    (function () {
    const SOMAP_ALLOWED_YEARS = Array.from({ length: 20 }, (_, i) => 2023 + i);
    const SOMAP_DEFAULT_YEAR = 2025;
    const CLASS_ORDER = [
      'Baby Class',
      'Middle Class',
      'Pre Unit Class',
      'Class 1',
      'Class 2',
      'Class 3',
      'Class 4',
      'Class 5',
      'Class 6',
      'Class 7'
    ];
    const CLASS_SYNONYMS = (() => {
      const normalize = (s) => String(s ?? '').trim().toLowerCase();
      const map = {};
      CLASS_ORDER.forEach((cls) => {
        map[normalize(cls)] = cls;
      });
      const extras = {
        'baby': 'Baby Class',
        'babyclass': 'Baby Class',
        'middle': 'Middle Class',
        'middleclass': 'Middle Class',
        'preunit': 'Pre Unit Class',
        'pre-unit': 'Pre Unit Class',
        'pre unit': 'Pre Unit Class',
        'preunit class': 'Pre Unit Class',
        'pre-unit class': 'Pre Unit Class',
        'pre unit class': 'Pre Unit Class',
        'class1': 'Class 1',
        'class2': 'Class 2',
        'class3': 'Class 3',
        'class4': 'Class 4',
        'class5': 'Class 5',
        'class6': 'Class 6',
        'class7': 'Class 7'
      };
      Object.entries(extras).forEach(([key, value]) => { map[normalize(key)] = value; });
      return map;
    })();
    const DEFAULT_PLAN_ID = '6-instalments';
    const DEFAULT_PLAN_NAME = 'Dirisha la Malipo (6)';
    const DEFAULT_INSTALLMENT_TEMPLATE = [
      { id: 'mku1', label: 'Dirisha la malipo: Mku.1', from: [12, 1], to: [1, 10], weight: 18 },
      { id: 'mku2', label: 'Dirisha la malipo: Mku.2', from: [3, 1], to: [3, 15], weight: 16 },
      { id: 'mku3', label: 'Dirisha la malipo: Mku.3', from: [4, 1], to: [4, 15], weight: 16 },
      { id: 'mku4', label: 'Dirisha la malipo: Mku.4', from: [5, 1], to: [5, 15], weight: 16 },
      { id: 'mku5', label: 'Dirisha la malipo: Mku.5', from: [7, 1], to: [7, 15], weight: 17 },
      { id: 'mku6', label: 'Dirisha la malipo: Mku.6', from: [9, 1], to: [9, 15], weight: 17 }
    ];

    const norm = (s) => String(s ?? '').trim().toLowerCase();
    const canonicalClass = (label) => CLASS_SYNONYMS[norm(label)] || label || '';
    const now = () => Date.now();
    const currentUser = () => window.currentUserId || 'admin';

    function shiftClass(baseClass, deltaYears) {
      const canonical = canonicalClass(baseClass);
      const idx = CLASS_ORDER.findIndex((c) => norm(c) === norm(canonical));
      if (idx < 0) return baseClass || '';
      const target = idx + Number(deltaYears || 0);
      if (target < 0) return 'PRE-ADMISSION';
      if (target >= CLASS_ORDER.length) return 'GRADUATED';
      return CLASS_ORDER[target];
    }

    window.somapYearContext = window.somapYearContext || (function () {
      let selected = String(sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR);
      const listeners = new Set();
      return {
        getSelectedYear() { return selected; },
        setSelectedYear(y) {
          const val = String(y);
          if (val === selected) return;
          selected = val;
          try { sessionStorage.setItem('somap_selected_year', val); } catch (e) { console.warn(e); }
          listeners.forEach((fn) => { try { fn(val); } catch (err) { console.error(err); } });
        },
        onYearChanged(fn) { if (typeof fn === 'function') listeners.add(fn); }
      };
    })();

    (function initYearSelector() {
      const select = document.querySelector('[data-somap-year-select]');
      const hint = document.getElementById('somapYearHint');
      if (!select) return;
      select.innerHTML = SOMAP_ALLOWED_YEARS.map((y) => `<option value="${y}">${y}</option>`).join('');
      const current = window.somapYearContext.getSelectedYear();
      select.value = current;
      if (hint) hint.textContent = current;
      select.addEventListener('change', (ev) => {
        const chosen = String(ev.target.value);
        window.somapYearContext.setSelectedYear(chosen);
        if (hint) hint.textContent = chosen;
      });
    })();

    const firebaseConfig = {
      apiKey: "AIzaSyBhONntRE_aRsU0y1YcPZzWud3CBfwH_a8",
      authDomain: "somaptestt.firebaseapp.com",
      databaseURL: "https://somaptestt-default-rtdb.firebaseio.com",
      projectId: "somaptestt",
      storageBucket: "somaptestt.appspot.com",
      messagingSenderId: "105526245138",
      appId: "1:105526245138:web:b8e7c0cb82a46e861965cb",
      measurementId: "G-4HKX7KN6Q3"
    };
    try {
      if (!firebase?.apps?.length) firebase.initializeApp(firebaseConfig);
    } catch (err) {
      console.error('Firebase init error', err);
    }
    const db = (() => { try { return firebase.database(); } catch { return null; } })();
    if (!db) {
      console.error('Firebase database not initialized.');
    } else {
      // Make db available globally for the service
      window.db = db;
    }

    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const fmtMoney = (n) => (Number(n) || 0).toLocaleString('en-US');

    function openModal(html) {
      const root = document.getElementById('modalRoot');
      const card = root.querySelector('.modal-card');
      card.innerHTML = html;
      root.classList.add('show');
    }
    function closeModal() {
      const root = document.getElementById('modalRoot');
      const card = root.querySelector('.modal-card');
      card.innerHTML = '';
      root.classList.remove('show');
    }
    document.getElementById('modalRoot').addEventListener('click', (ev) => {
      if (ev.target.id === 'modalRoot') closeModal();
    });

    let toastTimer = null;
    function toast(message, tone = 'success') {
      const node = document.getElementById('toast');
      const label = document.getElementById('toastMsg');
      label.textContent = message;
      node.classList.add('show');
      node.style.background = tone === 'error'
        ? 'rgba(248, 113, 113, 0.9)'
        : tone === 'warn'
          ? 'rgba(234, 179, 8, 0.9)'
          : 'rgba(34, 197, 94, 0.9)';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => node.classList.remove('show'), 2600);
    }

    const pathPlans = (y) => `installmentPlans/${y}`;
    const pathFees = (y) => `feesStructure/${y}`;
    const pathOverrides = (y) => `studentOverrides/${y}`;
    const pathHistory = (y) => `financeConfigHistory/${y}`;

    const reader = (path) => db.ref(path).once('value').then((snap) => snap.val());
    const writer = (path, payload) => db.ref(path).set(payload);
    const updater = (path, payload) => db.ref(path).update(payload);

    async function writeHistory(year, category, id, action, before, after) {
      const entry = {
        action,
        before: before ?? null,
        after: after ?? null,
        at: now(),
        by: currentUser()
      };
      const ref = db.ref(`${pathHistory(year)}/${category}/${id}`).push();
      await ref.set(entry);
    }

    function clone(obj) {
      return JSON.parse(JSON.stringify(obj ?? {}));
    }
    function makeDefaultInstallments() {
      const out = {};
      DEFAULT_INSTALLMENT_TEMPLATE.forEach((item, idx) => {
        const key = item.id || `inst${idx + 1}`;
        out[key] = {
          label: item.label,
          amount: 0,
          weight: item.weight ?? 1,
          active: true,
          window: { from: item.from.slice(), to: item.to.slice() },
          createdAt: now(),
          createdBy: currentUser()
        };
      });
      return out;
    }
    function makeDefaultPlanPayload() {
      return {
        name: DEFAULT_PLAN_NAME,
        description: 'Default six-instalment schedule (Dirisha la Malipo). Adjust weights and dates as needed.',
        appliesTo: [...CLASS_ORDER],
        isActive: true,
        schedule: DEFAULT_INSTALLMENT_TEMPLATE.map((item) => ({
          id: item.id,
          label: item.label,
          from: `${String(item.from[0]).padStart(2, '0')}-${String(item.from[1]).padStart(2, '0')}`,
          to: `${String(item.to[0]).padStart(2, '0')}-${String(item.to[1]).padStart(2, '0')}`,
          weight: item.weight ?? 1
        })),
        createdAt: now(),
        updatedAt: now(),
        updatedBy: currentUser()
      };
    }
    function canonicalizeFees(raw) {
      const out = {};
      Object.entries(raw || {}).forEach(([key, val]) => {
        const canonical = canonicalClass(key);
        out[canonical] = { ...(val || {}), className: canonical };
      });
      return out;
    }

    async function ensureYearScaffold(year) {
      try {
        const [feesSnap, plansSnap] = await Promise.all([
          db.ref(pathFees(year)).once('value').catch(() => ({ val: () => null })),
          db.ref(pathPlans(year)).once('value').catch(() => ({ val: () => null }))
        ]);
        let fees = canonicalizeFees(feesSnap?.val() || {});
        let plans = plansSnap?.val() || {};

      let baseFees = fees;
      let basePlans = plans;

      if (!Object.keys(fees).length && year !== String(SOMAP_DEFAULT_YEAR)) {
        const base = await reader(pathFees(SOMAP_DEFAULT_YEAR));
        baseFees = canonicalizeFees(base || {});
      }
      if (!Object.keys(plans).length && year !== String(SOMAP_DEFAULT_YEAR)) {
        const base = await reader(pathPlans(SOMAP_DEFAULT_YEAR));
        basePlans = base || {};
      }

      const updates = {};

      if (!plans[DEFAULT_PLAN_ID]) {
        const template = clone(basePlans[DEFAULT_PLAN_ID]) || makeDefaultPlanPayload();
        updates[`${pathPlans(year)}/${DEFAULT_PLAN_ID}`] = {
          ...template,
          name: template.name || DEFAULT_PLAN_NAME,
          appliesTo: Array.isArray(template.appliesTo) && template.appliesTo.length ? template.appliesTo : [...CLASS_ORDER],
          isActive: template.isActive !== false,
          createdAt: template.createdAt || now(),
          updatedAt: now(),
          updatedBy: currentUser()
        };
      }

      CLASS_ORDER.forEach((cls) => {
        const existing = fees[cls];
        if (!existing) {
          const base = baseFees[cls] || {};
          updates[`${pathFees(year)}/${cls}`] = {
            feePerYear: Number(base.feePerYear ?? 0),
            defaultPlanId: base.defaultPlanId || base.defaultPlan || DEFAULT_PLAN_ID,
            defaultPlan: base.defaultPlan || base.defaultPlanId || DEFAULT_PLAN_ID,
            active: base.active !== false,
            installments: clone(base.installments) || makeDefaultInstallments(),
            createdAt: base.createdAt || now(),
            updatedAt: now(),
            updatedBy: currentUser(),
            seededFrom: base && Object.keys(base).length ? `clone-${SOMAP_DEFAULT_YEAR}` : 'default-template'
          };
        } else {
          const patch = { ...existing };
          let mutated = false;
          if (!patch.defaultPlanId) {
            patch.defaultPlanId = existing.defaultPlan || DEFAULT_PLAN_ID;
            mutated = true;
          }
          if (!patch.defaultPlan) {
            patch.defaultPlan = patch.defaultPlanId;
            mutated = true;
          }
          if (!patch.installments || !Object.keys(patch.installments).length) {
            patch.installments = clone(baseFees[cls]?.installments) || makeDefaultInstallments();
            mutated = true;
          }
          if (mutated) {
            patch.updatedAt = now();
            patch.updatedBy = currentUser();
            updates[`${pathFees(year)}/${cls}`] = patch;
          }
        }
      });

        if (Object.keys(updates).length) {
          await db.ref().update(updates);
          const [feesRefreshed, plansRefreshed] = await Promise.all([
            db.ref(pathFees(year)).once('value').catch(() => ({ val: () => null })),
            db.ref(pathPlans(year)).once('value').catch(() => ({ val: () => null }))
          ]);
          fees = canonicalizeFees(feesRefreshed?.val() || {});
          plans = plansRefreshed?.val() || {};
        }
        return { fees, plans };
      } catch (err) {
        console.error('Error in ensureYearScaffold:', err);
        // Return empty objects on error but don't crash
        return { fees: {}, plans: {} };
      }
    }

    const state = {
      year: String(SOMAP_DEFAULT_YEAR),
      fees: {},
      plans: {},
      studentsCache: []
    };

    function classSort(a, b) {
      const ai = CLASS_ORDER.indexOf(a);
      const bi = CLASS_ORDER.indexOf(b);
      if (ai === -1 && bi === -1) return a.localeCompare(b);
      if (ai === -1) return 1;
      if (bi === -1) return -1;
      return ai - bi;
    }
    function windowLabelFromInstallment(inst) {
      const year = Number(state?.year || SOMAP_DEFAULT_YEAR);
      const fromPair = inst?.window?.from || [];
      const toPair = inst?.window?.to || [];
      const resolveYear = (pair) => (pair[0] === 12 ? year - 1 : year);
      const fmt = (pair, y) => {
        const [m = 1, d = 1] = pair;
        return `${m}/${d}/${y}`;
      };
      return `${fmt(fromPair, resolveYear(fromPair))} - ${fmt(toPair, resolveYear(toPair))}`;
    }
    function sortInstallments(entries) {
      const comparator = window.SomapFinance?.installmentCompare;
      if (typeof comparator === 'function') {
        return entries.sort(([, A], [, B]) => comparator(
          { label: A?.label, window: windowLabelFromInstallment(A || {}) },
          { label: B?.label, window: windowLabelFromInstallment(B || {}) }
        ));
      }
      return entries.sort(([, A], [, B]) => {
        const af = A?.window?.from || [];
        const bf = B?.window?.from || [];
        if (!af.length && !bf.length) return 0;
        if (!af.length) return 1;
        if (!bf.length) return -1;
        if (af[0] !== bf[0]) return af[0] - bf[0];
        return af[1] - bf[1];
      });
    }

    function renderClassCard(className, cfg) {
      const planId = cfg?.defaultPlanId || cfg?.defaultPlan || DEFAULT_PLAN_ID;
      const plan = state.plans?.[planId];
      let planName = plan?.name || planId || 'â€”';
      let displayFee = cfg?.feePerYear || 0;
      
      // Check if this is a monthly plan (schedule has "Monthly:" labels)
      const isMonthlyPlan = plan?.schedule && Array.isArray(plan.schedule) && 
        plan.schedule.length > 0 && 
        plan.schedule.some(row => String(row.label || '').includes('Monthly:'));
      
      if (isMonthlyPlan) {
        planName = 'Malipo kwa mwezi';
        // Calculate total from monthly schedule
        const totalFromSchedule = plan.schedule.reduce((sum, row) => sum + (Number(row.amount) || 0), 0);
        if (totalFromSchedule > 0) {
          displayFee = totalFromSchedule;
        }
      }
      
      const badge = cfg?.active === false
        ? '<span class="tag bg-rose-500/20 border border-rose-400/30 text-rose-200">Inactive</span>'
        : '<span class="tag bg-emerald-500/15 border border-emerald-400/25 text-emerald-200">Active</span>';
      const installments = sortInstallments(Object.entries(cfg?.installments || {}));
      const instMarkup = installments.length
        ? installments.map(([id, inst]) => `
            <div class="glass-panel-light flex flex-col gap-2 border border-slate-700/40" data-class="${className}" data-id="${id}">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <p class="font-semibold text-sm">${inst?.label || 'Installment'}</p>
                  <p class="text-[11px] text-slate-400">
                    ${inst?.window?.from ? `Due ${String(inst.window.from[0]).padStart(2, '0')}/${String(inst.window.from[1]).padStart(2, '0')} â€“ ${String(inst.window.to?.[0] ?? '').padStart(2, '0')}/${String(inst.window.to?.[1] ?? '').padStart(2, '0')}` : 'No window set'}
                  </p>
                </div>
                <div class="text-right space-y-1">
                  <div class="text-xs text-slate-300">TSh <span class="font-semibold">${fmtMoney(inst?.amount || 0)}</span></div>
                  <div>${inst?.active === false
                    ? '<span class="pill bg-rose-500/10 border border-rose-500/40 text-rose-200">Paused</span>'
                    : '<span class="pill bg-emerald-500/10 border border-emerald-500/40 text-emerald-200">Live</span>'}</div>
                </div>
              </div>
              <div class="flex flex-wrap gap-2 text-[11px] text-slate-300">
                ${inst?.weight ? `<span class="chip border-slate-700/50 text-slate-300">Weight ${inst.weight}</span>` : ''}
              </div>
              <div class="flex flex-wrap gap-2 text-[11px]">
                <button class="btn btn-ghost px-3 py-[0.35rem]" data-action="inst-edit" data-class="${className}" data-id="${id}"><i class="fa-solid fa-pen"></i> Edit</button>
                <button class="btn btn-ghost px-3 py-[0.35rem]" data-action="inst-history" data-class="${className}" data-id="${id}"><i class="fa-regular fa-clock"></i> History</button>
                <button class="btn btn-ghost px-3 py-[0.35rem]" data-action="inst-toggle" data-class="${className}" data-id="${id}"><i class="fa-solid fa-toggle-on"></i> ${inst?.active === false ? 'Activate' : 'Pause'}</button>
                <button class="btn btn-danger px-3 py-[0.35rem]" data-action="inst-delete" data-class="${className}" data-id="${id}"><i class="fa-solid fa-trash"></i> Delete</button>
              </div>
            </div>
          `).join('')
        : '<div class="text-sm text-slate-400 bg-slate-900/30 border border-slate-700/30 rounded-xl px-4 py-3">No installments defined yet.</div>';

      return `
        <article class="glass-panel-light border border-slate-700/45 space-y-4" data-class-card="${className}">
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 class="text-lg font-semibold">${className}</h3>
              <p class="text-xs text-slate-400 mt-1">Default plan: <span class="font-medium text-slate-200">${planName}</span></p>
              <p class="text-xs text-slate-400">Fee (year): <span class="font-medium text-indigo-200">TSh ${fmtMoney(displayFee)}</span></p>
            </div>
            <div class="flex flex-col items-end gap-2">
              ${badge}
              <div class="flex flex-wrap justify-end gap-2 text-xs">
                <button class="btn btn-ghost px-3" data-action="class-edit" data-class="${className}"><i class="fa-solid fa-pen-to-square"></i> Edit</button>
                <button class="btn btn-ghost px-3" data-action="class-history" data-class="${className}"><i class="fa-regular fa-clock"></i> History</button>
                <button class="btn btn-ghost px-3" data-action="class-toggle" data-class="${className}"><i class="fa-solid fa-toggle-on"></i> ${cfg?.active === false ? 'Activate' : 'Pause'}</button>
                <button class="btn btn-danger px-3" data-action="class-delete" data-class="${className}"><i class="fa-solid fa-trash"></i> Delete</button>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <h4 class="text-sm font-semibold text-slate-200">Installments</h4>
            <div class="flex gap-2">
              <button class="btn btn-ghost px-3 bg-amber-600/20 text-amber-200" data-action="class-monthly" data-class="${className}"><i class="fa-solid fa-calendar-alt"></i> Monthly Plan…</button>
              <button class="btn btn-primary px-3" data-action="inst-add" data-class="${className}"><i class="fa-solid fa-plus"></i> Add installment</button>
            </div>
          </div>
          <div class="space-y-3">${instMarkup}</div>
        </article>
      `;
    }

    function renderPlanCard(planId, plan) {
      const status = plan?.isActive === false
        ? '<span class="tag bg-rose-500/15 border border-rose-500/35 text-rose-200">Inactive</span>'
        : '<span class="tag bg-emerald-500/15 border border-emerald-500/35 text-emerald-100">Active</span>';
      const schedule = (plan?.schedule || []).map((item, idx) => `
        <div class="flex justify-between text-xs text-slate-200 border border-slate-700/40 rounded-lg px-3 py-2 bg-slate-900/30">
          <span class="font-medium">${item.label || `Inst ${idx + 1}`}</span>
          <span>${item.from || 'â€”'} â†’ ${item.to || 'â€”'} <span class="text-slate-400">(${item.weight ?? 1})</span></span>
        </div>
      `).join('');
      const appliesCount = (plan?.appliesTo || []).length;
      return `
        <article class="glass-panel-light border border-slate-700/50 space-y-3" data-plan-card="${planId}">
          <div class="flex items-start justify-between gap-3">
            <div class="space-y-1">
              <h3 class="text-lg font-semibold">${plan?.name || planId}</h3>
              <p class="text-xs text-slate-300">${plan?.description || 'â€”'}</p>
              <div class="flex flex-wrap gap-2 text-[11px] text-slate-300">
                <span class="chip border-slate-600/40">Plan ID: ${planId}</span>
                <span class="chip border-slate-600/40">${appliesCount} classes</span>
                ${status}
              </div>
            </div>
            <div class="flex flex-col items-end gap-2 text-xs">
              <button class="btn btn-ghost px-3" data-action="plan-edit" data-plan="${planId}"><i class="fa-solid fa-pen"></i> Edit</button>
              <button class="btn btn-ghost px-3" data-action="plan-history" data-plan="${planId}"><i class="fa-regular fa-clock"></i> History</button>
              ${plan?.isActive === false
                ? `<button class="btn btn-primary px-3" data-action="plan-activate" data-plan="${planId}"><i class="fa-solid fa-bolt"></i> Activate</button>`
                : `<button class="btn btn-danger px-3" data-action="plan-deactivate" data-plan="${planId}"><i class="fa-solid fa-ban"></i> Pause</button>`}
            </div>
          </div>
          <div class="space-y-2">${schedule || '<div class="text-xs text-slate-400 bg-slate-900/30 border border-slate-700/30 rounded-lg px-3 py-2">No schedule entries yet.</div>'}</div>
        </article>
      `;
    }

    function renderClasses() {
      const wrap = $('#classesWrap');
      const empty = $('#emptyState');
      if (!wrap) return;
      const searchValue = norm($('#searchClass')?.value || '');
      const pickValue = $('#classPicker')?.value || '';
      const classNames = Object.keys(state.fees).sort(classSort);
      const filtered = classNames.filter((name) => {
        if (pickValue && name !== pickValue) return false;
        if (searchValue && !norm(name).includes(searchValue)) return false;
        return true;
      });
      $('#classesSummary').textContent = `${filtered.length}/${CLASS_ORDER.length} classes visible`;
      if (!filtered.length) {
        wrap.innerHTML = '';
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      wrap.innerHTML = filtered.map((name) => renderClassCard(name, state.fees[name])).join('');
    }

    function renderPlans() {
      const wrap = $('#plansWrap');
      if (!wrap) return;
      const ids = Object.keys(state.plans || {}).sort();
      if (!ids.length) {
        wrap.innerHTML = '<div class="text-sm text-slate-300 bg-slate-900/40 border border-slate-700/40 rounded-lg px-4 py-3">No plans available for this year.</div>';
        return;
      }
      wrap.innerHTML = ids.map((id) => renderPlanCard(id, state.plans[id])).join('');
    }

    async function refreshAll() {
      if (!db) {
        console.error('Database not available');
        const errorMsg = '<div class="text-sm text-red-300">Error: Database not initialized</div>';
        $('#plansWrap').innerHTML = errorMsg;
        $('#classesWrap').innerHTML = errorMsg;
        return;
      }
      
      try {
        const hint = $('#somapYearHint');
        const year = String(window.somapYearContext?.getSelectedYear() || SOMAP_DEFAULT_YEAR);
        state.year = year;
        if (hint) hint.textContent = year;
        $('#plansWrap').innerHTML = '<div class="text-sm text-slate-300">Loading…</div>';
        $('#classesWrap').innerHTML = '<div class="text-sm text-slate-300">Loading…</div>';

        const { fees, plans } = await ensureYearScaffold(year);
        state.fees = fees || {};
        state.plans = plans || {};
        populateClassPicker();
        renderClasses();
        renderPlans();
        const q = $('#studentQuery')?.value || '';
        if (q && q.length >= 2) {
          await renderOverrides(q);
        } else {
          $('#studentPanel').innerHTML = '<div class="text-sm text-slate-400">Search for a student to view overrides.</div>';
        }
      } catch (err) {
        console.error('Error in refreshAll:', err);
        const errorMsg = 'Error loading data: ' + (err.message || 'Unknown error');
        toast(errorMsg, 'error');
        $('#plansWrap').innerHTML = '<div class="text-sm text-red-300">' + errorMsg + '</div>';
        $('#classesWrap').innerHTML = '<div class="text-sm text-red-300">' + errorMsg + '</div>';
      }
    }

    function populateClassPicker() {
      const select = $('#classPicker');
      if (!select) return;
      const options = ['<option value="">All Classes</option>'].concat(CLASS_ORDER.map((c) => `<option value="${c}">${c}</option>`));
      select.innerHTML = options.join('');
    }

    async function openClassEditor(className) {
      const year = state.year;
      const data = state.fees[className] || {
        feePerYear: 0,
        defaultPlanId: DEFAULT_PLAN_ID,
        active: true
      };
      const planOptions = Object.keys(state.plans).map((id) => `<option value="${id}" ${id === (data.defaultPlanId || data.defaultPlan) ? 'selected' : ''}>${state.plans[id].name || id}</option>`).join('');
      openModal(`
        <div class="space-y-5 text-sm">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-slate-100">${className}</h3>
              <p class="text-xs text-slate-400">Academic year ${year}. Changes apply immediately.</p>
            </div>
            <button class="text-slate-400 hover:text-slate-100" onclick="(${closeModal.toString()})();"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Fee per Year (TSh)</span>
            <input id="modalFee" type="number" min="0" class="input bg-slate-900/40 border-slate-700/60" value="${data.feePerYear || 0}" />
          </label>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Default Plan</span>
            <select id="modalPlan" class="input bg-slate-900/40 border-slate-700/60">${planOptions}</select>
          </label>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Status</span>
            <select id="modalActive" class="input bg-slate-900/40 border-slate-700/60">
              <option value="true" ${data.active === false ? '' : 'selected'}>Active</option>
              <option value="false" ${data.active === false ? 'selected' : ''}>Inactive</option>
            </select>
          </label>
          <div class="flex justify-end gap-2">
            <button class="btn btn-ghost" onclick="(${closeModal.toString()})();">Cancel</button>
            <button class="btn btn-primary" id="modalSave">Save Changes</button>
          </div>
        </div>
      `);
      $('#modalSave').addEventListener('click', async () => {
        const feePerYear = Math.max(0, Number($('#modalFee').value || 0));
        const defaultPlanId = $('#modalPlan').value || DEFAULT_PLAN_ID;
        const active = $('#modalActive').value === 'true';
        const path = `${pathFees(year)}/${className}`;
        const before = await reader(path) || {};
        
        // Use unified service to write class defaults
        try {
          await window.financePlansService.setClassFeePerYear(className, feePerYear, { by: currentUser() });
          await window.financePlansService.setClassDefaultPlanId(className, defaultPlanId, { by: currentUser() });
          
          // Also update old structure for backward compatibility
          const payload = {
            ...before,
            feePerYear,
            defaultPlanId,
            defaultPlan: defaultPlanId,
            active,
            updatedAt: now(),
            updatedBy: currentUser()
          };
          await writer(path, payload);
          await writeHistory(year, 'classes', className, before ? 'update' : 'create', before, payload);
          closeModal();
          toast('Class saved');
          await refreshAll();
        } catch (err) {
          console.error('Error saving class:', err);
          toast('Error saving class', 'error');
        }
      });
    }

    async function addInstallment(className) {
      const year = state.year;
      const defaultWindow = DEFAULT_INSTALLMENT_TEMPLATE[0];
      openModal(`
        <div class="space-y-4 text-sm">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-slate-100">Add Installment</h3>
              <p class="text-xs text-slate-400">${className} Â· Academic year ${year}</p>
            </div>
            <button class="text-slate-400 hover:text-slate-100" onclick="(${closeModal.toString()})();"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Label</span>
            <input id="instLabel" class="input bg-slate-900/40 border-slate-700/60" value="${defaultWindow.label}" />
          </label>
          <div class="grid grid-cols-2 gap-3">
            <label class="space-y-2 block">
              <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Amount (TSh)</span>
              <input id="instAmount" type="number" class="input bg-slate-900/40 border-slate-700/60" value="0" />
            </label>
            <label class="space-y-2 block">
              <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Weight</span>
              <input id="instWeight" type="number" class="input bg-slate-900/40 border-slate-700/60" value="${defaultWindow.weight}" />
            </label>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <label class="space-y-2 block">
              <span class="text-xs uppercase tracking-[0.3em] text-slate-400">From (MM-DD)</span>
              <input id="instFrom" class="input bg-slate-900/40 border-slate-700/60" value="${String(defaultWindow.from[0]).padStart(2, '0')}-${String(defaultWindow.from[1]).padStart(2, '0')}" />
            </label>
            <label class="space-y-2 block">
              <span class="text-xs uppercase tracking-[0.3em] text-slate-400">To (MM-DD)</span>
              <input id="instTo" class="input bg-slate-900/40 border-slate-700/60" value="${String(defaultWindow.to[0]).padStart(2, '0')}-${String(defaultWindow.to[1]).padStart(2, '0')}" />
            </label>
          </div>
          <div class="flex justify-end gap-2">
            <button class="btn btn-ghost" onclick="(${closeModal.toString()})();">Cancel</button>
            <button class="btn btn-primary" id="instSave">Save Installment</button>
          </div>
        </div>
      `);
      $('#instSave').addEventListener('click', async () => {
        const label = $('#instLabel').value.trim() || 'Installment';
        const amount = Math.max(0, Number($('#instAmount').value || 0));
        const weight = Math.max(0, Number($('#instWeight').value || 1));
        const fromParts = ($('#instFrom').value || '').split('-').map((s) => Number(s.trim()));
        const toParts = ($('#instTo').value || '').split('-').map((s) => Number(s.trim()));
        const path = `${pathFees(year)}/${className}/installments`;
        const ref = db.ref(path).push();
        const id = ref.key;
        const payload = {
          label,
          amount,
          weight,
          window: { from: [fromParts[0] || 1, fromParts[1] || 1], to: [toParts[0] || 1, toParts[1] || 1] },
          active: true,
          createdAt: now(),
          createdBy: currentUser()
        };
        await ref.set(payload);
        await writeHistory(year, 'installments', `${className}::${id}`, 'create', null, payload);
        closeModal();
        toast('Installment added');
        await refreshAll();
      });
    }

    async function editInstallment(className, instId) {
      const year = state.year;
      const path = `${pathFees(year)}/${className}/installments/${instId}`;
      const before = await reader(path) || {};
      const from = before?.window?.from || [];
      const to = before?.window?.to || [];
      openModal(`
        <div class="space-y-4 text-sm">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-slate-100">Edit Installment</h3>
              <p class="text-xs text-slate-400">${className} Â· Academic year ${year}</p>
            </div>
            <button class="text-slate-400 hover:text-slate-100" onclick="(${closeModal.toString()})();"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Label</span>
            <input id="instLabel" class="input bg-slate-900/40 border-slate-700/60" value="${before.label || ''}" />
          </label>
          <div class="grid grid-cols-2 gap-3">
            <label class="space-y-2 block">
              <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Amount (TSh)</span>
              <input id="instAmount" type="number" class="input bg-slate-900/40 border-slate-700/60" value="${before.amount || 0}" />
            </label>
            <label class="space-y-2 block">
              <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Weight</span>
              <input id="instWeight" type="number" class="input bg-slate-900/40 border-slate-700/60" value="${before.weight || 1}" />
            </label>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <label class="space-y-2 block">
              <span class="text-xs uppercase tracking-[0.3em] text-slate-400">From (MM-DD)</span>
              <input id="instFrom" class="input bg-slate-900/40 border-slate-700/60" value="${from.length ? `${String(from[0]).padStart(2, '0')}-${String(from[1]).padStart(2, '0')}` : ''}" />
            </label>
            <label class="space-y-2 block">
              <span class="text-xs uppercase tracking-[0.3em] text-slate-400">To (MM-DD)</span>
              <input id="instTo" class="input bg-slate-900/40 border-slate-700/60" value="${to.length ? `${String(to[0]).padStart(2, '0')}-${String(to[1]).padStart(2, '0')}` : ''}" />
            </label>
          </div>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Status</span>
            <select id="instActive" class="input bg-slate-900/40 border-slate-700/60">
              <option value="true" ${before.active === false ? '' : 'selected'}>Active</option>
              <option value="false" ${before.active === false ? 'selected' : ''}>Inactive</option>
            </select>
          </label>
          <div class="flex justify-end gap-2">
            <button class="btn btn-ghost" onclick="(${closeModal.toString()})();">Cancel</button>
            <button class="btn btn-primary" id="instSave">Save Changes</button>
          </div>
        </div>
      `);
      $('#instSave').addEventListener('click', async () => {
        const label = $('#instLabel').value.trim() || 'Installment';
        const amount = Math.max(0, Number($('#instAmount').value || 0));
        const weight = Math.max(0, Number($('#instWeight').value || 1));
        const active = $('#instActive').value === 'true';
        const fromParts = ($('#instFrom').value || '').split('-').map((s) => Number(s.trim()));
        const toParts = ($('#instTo').value || '').split('-').map((s) => Number(s.trim()));
        const payload = {
          ...before,
          label,
          amount,
          weight,
          active,
          window: {
            from: [fromParts[0] || 1, fromParts[1] || 1],
            to: [toParts[0] || 1, toParts[1] || 1]
          },
          updatedAt: now(),
          updatedBy: currentUser()
        };
        await writer(path, payload);
        await writeHistory(year, 'installments', `${className}::${instId}`, 'update', before, payload);
        closeModal();
        toast('Installment updated');
        await refreshAll();
      });
    }

    async function toggleInstallment(className, instId) {
      const year = state.year;
      const path = `${pathFees(year)}/${className}/installments/${instId}`;
      const before = await reader(path) || {};
      const nextActive = before.active === false;
      const payload = { ...before, active: nextActive, updatedAt: now(), updatedBy: currentUser() };
      await writer(path, payload);
      await writeHistory(year, 'installments', `${className}::${instId}`, nextActive ? 'activate' : 'deactivate', before, payload);
      toast(nextActive ? 'Installment activated' : 'Installment paused');
      await refreshAll();
    }

    async function deleteInstallment(className, instId) {
      const year = state.year;
      const path = `${pathFees(year)}/${className}/installments/${instId}`;
      const before = await reader(path) || {};
      await writer(path, null);
      await writeHistory(year, 'installments', `${className}::${instId}`, 'delete', before, null);
      toast('Installment deleted', 'warn');
      await refreshAll();
    }

    async function showInstallmentHistory(className, instId) {
      const year = state.year;
      const hist = await reader(`${pathHistory(year)}/installments/${className}::${instId}`) || {};
      const rows = Object.values(hist).sort((a, b) => (a.at || 0) - (b.at || 0)).map((entry) => {
        const stamp = new Date(entry.at || Date.now()).toLocaleString();
        return `${stamp} Â· ${entry.action || 'change'} by ${entry.by || 'unknown'}`;
      }).join('\n') || 'No history available.';
      alert(`History for ${className} / ${instId}\n\n${rows}`);
    }

    async function toggleClassActive(className) {
      const year = state.year;
      const path = `${pathFees(year)}/${className}`;
      const before = await reader(path) || {};
      const nextActive = before.active === false;
      const payload = { ...before, active: nextActive, updatedAt: now(), updatedBy: currentUser() };
      await writer(path, payload);
      await writeHistory(year, 'classes', className, nextActive ? 'activate' : 'deactivate', before, payload);
      toast(nextActive ? 'Class activated' : 'Class paused');
      await refreshAll();
    }

    async function deleteClass(className) {
      const year = state.year;
      if (!confirm(`Remove ${className} for ${year}? This only affects this year.`)) return;
      const path = `${pathFees(year)}/${className}`;
      const before = await reader(path) || {};
      await writer(path, null);
      await writeHistory(year, 'classes', className, 'delete', before, null);
      toast('Class removed', 'warn');
      await refreshAll();
    }

    async function showClassHistory(className) {
      const year = state.year;
      const hist = await reader(`${pathHistory(year)}/classes/${className}`) || {};
      const rows = Object.values(hist).sort((a, b) => (a.at || 0) - (b.at || 0)).map((entry) => {
        const stamp = new Date(entry.at || Date.now()).toLocaleString();
        const details = entry.after ? `fee: ${fmtMoney(entry.after.feePerYear || 0)} Â· plan: ${entry.after.defaultPlanId || entry.after.defaultPlan || 'â€”'}` : '';
        return `${stamp} Â· ${entry.action || 'change'} by ${entry.by || 'unknown'} ${details}`;
      }).join('\n') || 'No history yet.';
      alert(`History for ${className} (${year})\n\n${rows}`);
    }

    function parseScheduleText(text) {
      return String(text || '').split(/\n+/).map((line) => {
        const [label, from, to, weight] = line.split('|').map((s) => String(s || '').trim());
        if (!label) return null;
        return { label, from, to, weight: Number(weight) || 1 };
      }).filter(Boolean);
    }

    async function openPlanEditor(planId = null) {
      const year = state.year;
      const existing = planId ? clone(state.plans[planId] || {}) : {};
      openModal(`
        <div class="space-y-4 text-sm">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-slate-100">${planId ? 'Edit Plan' : 'New Plan'}</h3>
              <p class="text-xs text-slate-400">${planId || 'auto-generated id'} Â· Academic year ${year}</p>
            </div>
            <button class="text-slate-400 hover:text-slate-100" onclick="(${closeModal.toString()})();"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Plan Name</span>
            <input id="planName" class="input bg-slate-900/40 border-slate-700/60" value="${existing.name || DEFAULT_PLAN_NAME}" />
          </label>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Description</span>
            <textarea id="planDesc" rows="2" class="input bg-slate-900/40 border-slate-700/60">${existing.description || ''}</textarea>
          </label>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Applies to (comma separated)</span>
            <input id="planClasses" class="input bg-slate-900/40 border-slate-700/60" value="${(existing.appliesTo || CLASS_ORDER).join(', ')}" />
          </label>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Schedule (one per line: Label|MM-DD|MM-DD|Weight)</span>
            <textarea id="planSchedule" rows="6" class="input bg-slate-900/40 border-slate-700/60">${(existing.schedule || DEFAULT_INSTALLMENT_TEMPLATE.map((item) => `${item.label}|${String(item.from[0]).padStart(2, '0')}-${String(item.from[1]).padStart(2, '0')}|${String(item.to[0]).padStart(2, '0')}-${String(item.to[1]).padStart(2, '0')}|${item.weight}`)).join('\n')}</textarea>
          </label>
          <div class="flex justify-end gap-2">
            <button class="btn btn-ghost" onclick="(${closeModal.toString()})();">Cancel</button>
            <button class="btn btn-primary" id="planSave">${planId ? 'Save Plan' : 'Create Plan'}</button>
          </div>
        </div>
      `);
      $('#planSave').addEventListener('click', async () => {
        const name = $('#planName').value.trim() || DEFAULT_PLAN_NAME;
        const description = $('#planDesc').value.trim();
        const appliesTo = $('#planClasses').value.split(',').map((s) => canonicalClass(s.trim())).filter(Boolean);
        const schedule = parseScheduleText($('#planSchedule').value);
        const payload = {
          name,
          description,
          appliesTo,
          schedule,
          isActive: existing.isActive !== false,
          updatedAt: now(),
          updatedBy: currentUser(),
          createdAt: existing.createdAt || now()
        };
        let id = planId;
        if (!id) {
          id = state.plans[name] ? `${DEFAULT_PLAN_ID}-${Date.now()}` : name.toLowerCase().replace(/\s+/g, '-');
        }
        
        // Use unified service to write plan
        try {
          await window.financePlansService.upsertPlan(id, payload);
          // Also write to old structure for backward compatibility
          await writer(`${pathPlans(year)}/${id}`, payload);
          await writeHistory(year, 'plans', id, planId ? 'update' : 'create', planId ? existing : null, payload);
          closeModal();
          toast('Plan saved');
          await refreshAll();
        } catch (err) {
          console.error('Error saving plan:', err);
          toast('Error saving plan', 'error');
        }
      });
    }

    async function togglePlan(planId, activate) {
      const year = state.year;
      const path = `${pathPlans(year)}/${planId}`;
      const before = await reader(path) || {};
      const payload = { ...before, isActive: activate, updatedAt: now(), updatedBy: currentUser() };
      await writer(path, payload);
      await writeHistory(year, 'plans', planId, activate ? 'activate' : 'deactivate', before, payload);
      toast(activate ? 'Plan activated' : 'Plan paused');
      await refreshAll();
    }

    async function showPlanHistory(planId) {
      const year = state.year;
      const hist = await reader(`${pathHistory(year)}/plans/${planId}`) || {};
      const rows = Object.values(hist).sort((a, b) => (a.at || 0) - (b.at || 0)).map((entry) => {
        const stamp = new Date(entry.at || Date.now()).toLocaleString();
        return `${stamp} · ${entry.action || 'change'} by ${entry.by || 'unknown'}`;
      }).join('\n') || 'No history available.';
      alert(`History for plan ${planId} (${year})\n\n${rows}`);
    }

    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-action]');
      if (!btn) return;
      const action = btn.getAttribute('data-action');
      const className = btn.getAttribute('data-class');
      const instId = btn.getAttribute('data-id');
      const planId = btn.getAttribute('data-plan');
      if (action === 'class-edit' && className) openClassEditor(className);
      if (action === 'class-history' && className) showClassHistory(className);
      if (action === 'class-toggle' && className) toggleClassActive(className);
      if (action === 'class-delete' && className) deleteClass(className);
      if (action === 'class-monthly' && className) openMonthlyPlanModal({ attachTo: 'class', className });
      if (action === 'inst-add' && className) addInstallment(className);
      if (action === 'inst-edit' && className && instId) editInstallment(className, instId);
      if (action === 'inst-toggle' && className && instId) toggleInstallment(className, instId);
      if (action === 'inst-delete' && className && instId) deleteInstallment(className, instId);
      if (action === 'inst-history' && className && instId) showInstallmentHistory(className, instId);
      if (action === 'plan-edit' && planId) openPlanEditor(planId);
      if (action === 'plan-activate' && planId) togglePlan(planId, true);
      if (action === 'plan-deactivate' && planId) togglePlan(planId, false);
      if (action === 'plan-history' && planId) showPlanHistory(planId);
    });

    async function listAvailableYears() {
      const results = [];
      for (const year of SOMAP_ALLOWED_YEARS) {
        const val = await reader(pathFees(year));
        if (val && Object.keys(val).length) results.push(year);
      }
      return results;
    }
    async function findNearestSourceYear(target) {
      const targetNum = Number(target);
      for (let yr = targetNum - 1; yr >= SOMAP_ALLOWED_YEARS[0]; yr--) {
        const data = await reader(pathFees(yr));
        if (data && Object.keys(data).length) return yr;
      }
      return null;
    }

    function renderPreviewTable(map) {
      const rows = Object.entries(map || {}).map(([cls, cfg]) => `
        <tr>
          <td class="px-3 py-2 text-left border border-slate-700/40">${cls}</td>
          <td class="px-3 py-2 text-right border border-slate-700/40">TSh ${fmtMoney(cfg?.feePerYear || 0)}</td>
          <td class="px-3 py-2 text-left border border-slate-700/40">${cfg?.defaultPlanId || cfg?.defaultPlan || 'Not set'}</td>
          <td class="px-3 py-2 text-center border border-slate-700/40">${Object.keys(cfg?.installments || {}).length}</td>
        </tr>
      `).join('') || '<tr><td colspan="4" class="px-3 py-4 text-center text-slate-400 border border-slate-700/40">No classes found.</td></tr>';
      return `
        <div class="max-h-72 overflow-y-auto border border-slate-700/40 rounded-xl">
          <table class="w-full text-xs text-slate-200">
            <thead class="bg-slate-900/50">
              <tr>
                <th class="px-3 py-2 text-left border border-slate-700/40">Class</th>
                <th class="px-3 py-2 text-right border border-slate-700/40">Fee / Year</th>
                <th class="px-3 py-2 text-left border border-slate-700/40">Default Plan</th>
                <th class="px-3 py-2 text-center border border-slate-700/40">Installments</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `;
    }

    async function performImport(sourceYear, targetYear, includeAmounts) {
      const source = await reader(pathFees(sourceYear)) || {};
      const payload = {};
      Object.entries(source).forEach(([cls, cfg]) => {
        const canonical = canonicalClass(cls);
        if (includeAmounts) {
          payload[canonical] = {
            ...(cfg || {}),
            defaultPlanId: cfg?.defaultPlanId || cfg?.defaultPlan || DEFAULT_PLAN_ID,
            defaultPlan: cfg?.defaultPlan || cfg?.defaultPlanId || DEFAULT_PLAN_ID,
            updatedAt: now(),
            updatedBy: currentUser()
          };
        } else {
          const installments = {};
          Object.entries(cfg?.installments || {}).forEach(([id, inst]) => {
            installments[id] = {
              ...inst,
              amount: 0,
              updatedAt: now(),
              updatedBy: currentUser()
            };
          });
          payload[canonical] = {
            feePerYear: 0,
            defaultPlanId: cfg?.defaultPlanId || cfg?.defaultPlan || DEFAULT_PLAN_ID,
            defaultPlan: cfg?.defaultPlan || cfg?.defaultPlanId || DEFAULT_PLAN_ID,
            installments,
            active: cfg?.active !== false,
            updatedAt: now(),
            updatedBy: currentUser()
          };
        }
      });
      await writer(pathFees(targetYear), payload);
      await writeHistory(targetYear, 'classes', '_bulk_import_', 'import', { sourceYear, includeAmounts }, { classes: Object.keys(payload).length });
      toast(`Imported ${Object.keys(payload).length} classes`);
      await refreshAll();
    }

    $('#btnImportThisYear').addEventListener('click', async () => {
      const year = state.year;
      const nearest = await findNearestSourceYear(year);
      const srcYear = nearest || SOMAP_DEFAULT_YEAR;
      const data = await reader(pathFees(srcYear)) || {};
      openModal(`
        <div class="space-y-4 text-sm">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-slate-100">Import Classes for ${year}</h3>
              <p class="text-xs text-slate-400">Copy structure from ${srcYear}. You can choose to copy fee amounts as well.</p>
            </div>
            <button class="text-slate-400 hover:text-slate-100" onclick="(${closeModal.toString()})();"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Source Year</span>
            <select id="importSource" class="input bg-slate-900/40 border-slate-700/60"></select>
          </label>
          <div class="flex items-center gap-4 text-xs">
            <label class="inline-flex items-center gap-2">
              <input id="importIncludeAmounts" type="checkbox" class="accent-indigo-500" checked /> Copy fee amounts
            </label>
            <label class="inline-flex items-center gap-2">
              <input id="importStructureOnly" type="checkbox" class="accent-indigo-500" /> Structure only
            </label>
          </div>
          <div id="importPreview">${renderPreviewTable(data)}</div>
          <div class="flex justify-end gap-2">
            <button class="btn btn-ghost" onclick="(${closeModal.toString()})();">Cancel</button>
            <button class="btn btn-primary" id="importConfirm">Import into ${year}</button>
          </div>
        </div>
      `);
      const selector = $('#importSource');
      const yearsAvailable = await listAvailableYears();
      selector.innerHTML = yearsAvailable.map((yr) => `<option value="${yr}" ${yr === srcYear ? 'selected' : ''}>${yr}</option>`).join('');
      selector.addEventListener('change', async (ev) => {
        const chosen = ev.target.value;
        const d = await reader(pathFees(chosen)) || {};
        $('#importPreview').innerHTML = renderPreviewTable(d);
      });
      const amounts = $('#importIncludeAmounts');
      const structure = $('#importStructureOnly');
      structure.addEventListener('change', () => { if (structure.checked) amounts.checked = false; });
      amounts.addEventListener('change', () => { if (amounts.checked) structure.checked = false; });
      $('#importConfirm').addEventListener('click', async () => {
        const sourceYear = selector.value;
        const include = amounts.checked && !structure.checked;
        await performImport(sourceYear, year, include);
        closeModal();
      });
    });

    $('#btnImportAllYears').addEventListener('click', async () => {
      const year = state.year;
      const have = await listAvailableYears();
      openModal(`
        <div class="space-y-4 text-sm">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-slate-100">Import from Any Year</h3>
              <p class="text-xs text-slate-400">Copy a full class structure into ${year}.</p>
            </div>
            <button class="text-slate-400 hover:text-slate-100" onclick="(${closeModal.toString()})();"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          <label class="space-y-2 block">
            <span class="text-xs uppercase tracking-[0.3em] text-slate-400">Source Year</span>
            <select id="importAnySource" class="input bg-slate-900/40 border-slate-700/60">${have.map((yr) => `<option value="${yr}">${yr}</option>`).join('')}</select>
          </label>
          <div class="flex items-center gap-4 text-xs">
            <label class="inline-flex items-center gap-2">
              <input id="importAnyAmounts" type="checkbox" class="accent-indigo-500" checked /> Copy fee amounts
            </label>
            <label class="inline-flex items-center gap-2">
              <input id="importAnyStructure" type="checkbox" class="accent-indigo-500" /> Structure only
            </label>
          </div>
          <div class="flex justify-end gap-2">
            <button class="btn btn-ghost" onclick="(${closeModal.toString()})();">Cancel</button>
            <button class="btn btn-primary" id="importAnyConfirm">Import into ${year}</button>
          </div>
        </div>
      `);
      const amounts = $('#importAnyAmounts');
      const structure = $('#importAnyStructure');
      structure.addEventListener('change', () => { if (structure.checked) amounts.checked = false; });
      amounts.addEventListener('change', () => { if (amounts.checked) structure.checked = false; });
      $('#importAnyConfirm').addEventListener('click', async () => {
        const src = $('#importAnySource').value;
        const include = amounts.checked && !structure.checked;
        await performImport(src, year, include);
        closeModal();
      });
    });

    $('#btnAddClass').addEventListener('click', () => {
      const select = document.createElement('select');
      select.innerHTML = CLASS_ORDER.map((cls) => `<option value="${cls}">${cls}</option>`).join('');
      const defaultClass = select.querySelector('option')?.value || CLASS_ORDER[0];
      openClassEditor(defaultClass);
    });

    $('#btnAddPlan').addEventListener('click', () => openPlanEditor(null));
    $('#btnRefresh').addEventListener('click', () => refreshAll());

    $('#searchClass').addEventListener('input', () => renderClasses());
    $('#classPicker').addEventListener('change', () => renderClasses());

    // Cache for student search (60s TTL)
    let studentsCache = { data: null, ts: 0 };
    let lastSearchToken = 0;

    async function loadStudentsCache() {
      const now = Date.now();
      if (studentsCache.data && (now - studentsCache.ts) < 60000) return studentsCache.data;
      try {
        const data = await window.financePlansService.fetchStudentsAll();
        studentsCache = { data, ts: now };
        return data;
      } catch (err) {
        console.error('Error loading students cache:', err);
        return {};
      }
    }

    function matchStudent(S, q) {
      const ql = q.toLowerCase();
      const name = `${S.firstName || ''} ${S.middleName || ''} ${S.lastName || ''}`.toLowerCase();
      const adm = String(S.admissionNumber || '').toLowerCase();
      const phone = String(S.motherPhone || S.parentPhone || '').toLowerCase();
      return name.includes(ql) || adm.includes(ql) || phone.includes(ql);
    }

    async function renderOverrides(query) {
      const panel = $('#studentPanel');
      if (!panel) return;
      if (!query || query.trim().length < 2) {
        panel.innerHTML = '<div class="text-sm text-slate-400">Type at least 2 characters to search.</div>';
        return;
      }
      
      const token = ++lastSearchToken;
      panel.innerHTML = '<div class="text-sm text-slate-300">Searching…</div>';
      
      try {
        const students = await loadStudentsCache();
        if (token !== lastSearchToken) return; // Stale response
        
        const q = norm(query);
        const list = Object.entries(students)
          .filter(([, S]) => matchStudent(S, q))
          .slice(0, 30);
        
        if (!list.length) {
          panel.innerHTML = '<div class="text-sm text-slate-400">No matches found.</div>';
          return;
        }
        
        // Compute class for selected year and render rows
        const year = state.year || window.somapYearContext?.getSelectedYear() || SOMAP_DEFAULT_YEAR;
        const rows = await Promise.all(list.map(async ([id, S]) => {
          let resolvedClass = '';
          let financeSnapshot = null;
          if (window.SomapFinance?.loadStudentFinance) {
            try {
              financeSnapshot = await window.SomapFinance.loadStudentFinance(year, id);
              resolvedClass = financeSnapshot?.classLevel || '';
            } catch (err) {
              console.warn('PaymentEdits: failed to load finance snapshot', id, err);
            }
          }
          if (!resolvedClass) {
            try {
              resolvedClass = await window.financePlansService.resolveClassForYearSimple(id, year);
            } catch (err) {
              console.warn('PaymentEdits: class resolve fallback failed', id, err);
            }
          }
          if (!resolvedClass) {
            resolvedClass =
              S?.enrollments?.[year]?.classLevel ||
              S?.enrollments?.[year]?.className ||
              S?.classLevel ||
              S?.className ||
              '';
          }
          const full = `${S.firstName || ''} ${S.middleName || ''} ${S.lastName || ''}`.replace(/\s+/g, ' ').trim();
          return {
            id,
            full,
            cls: resolvedClass,
            adm: (S.admissionNumber || id),
            data: S,
            financeSnapshot
          };
        }));
        
        if (token !== lastSearchToken) return; // Stale response
        rows.sort((a, b) => a.full.localeCompare(b.full));
        
        // Get overrides for the year
        const overrides = await reader(`${pathOverrides(year)}`) || {};
        
        panel.innerHTML = (await Promise.all(rows.map(async (r) => {
          const { id, full, cls, adm, financeSnapshot } = r;
          const ov = overrides[id] || {};
          
          // Get defaults from unified service using resolved class
          const classFee = cls ? await window.financePlansService.getClassFeePerYear(cls) : 0;
          const classPlanId = cls ? await window.financePlansService.getClassDefaultPlanId(cls) : null;
          const classPlan = classPlanId ? (await window.financePlansService.getPlan(classPlanId)) : null;
          
          // Get overrides
          const feeOverride = await window.financePlansService.getStudentFee(id);
          const planOverrideId = await window.financePlansService.getStudentPlan(id);
          const customSchedule = await window.financePlansService.getCustomSchedule(id);
          
          const effectiveFee = feeOverride !== null ? feeOverride : classFee;
          const effectivePlanId = planOverrideId || classPlanId;
          const effectivePlan = effectivePlanId ? (state.plans[effectivePlanId] || await window.financePlansService.getPlan(effectivePlanId)) : null;
          const planName =
            effectivePlan?.name ||
            financeSnapshot?.paymentPlan ||
            effectivePlanId ||
            'No plan set';
          
          const hasCustomSchedule = customSchedule && Array.isArray(customSchedule.rows) && customSchedule.rows.length > 0;
          
          return `
            <article class="glass-panel-light border border-slate-700/45 space-y-3" data-student="${id}">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <h3 class="text-sm font-semibold text-slate-100">${full || adm}</h3>
                  <p class="text-xs text-slate-400">Adm: ${adm}</p>
                  <p class="text-xs text-slate-400">Class: ${cls || '—'} · Year: ${year}</p>
                </div>
                <button class="btn btn-ghost px-3 text-xs" data-action="override-clear" data-student="${id}"><i class="fa-solid fa-eraser"></i> Clear</button>
              </div>
              <div class="bg-slate-900/30 border border-slate-700/45 rounded-lg px-3 py-2 text-xs text-slate-200 space-y-2">
                <div>
                  <p class="text-slate-400 mb-1">Default Fee (Class): <span class="text-slate-300">TSh ${fmtMoney(classFee)}</span></p>
                  <p class="${feeOverride !== null ? 'text-indigo-300' : 'text-slate-400'}">Fee Override: <span class="font-semibold">${feeOverride !== null ? `TSh ${fmtMoney(feeOverride)}` : 'None (using class default)'}</span></p>
                </div>
                <div>
                  <p class="text-slate-400 mb-1">Default Plan (Class): <span class="text-slate-300">${classPlan?.name || classPlanId || 'Not set'}</span></p>
                  <p class="${planOverrideId ? 'text-indigo-300' : 'text-slate-400'}">Plan Override: <span class="font-semibold">${planOverrideId ? (effectivePlan?.name || planOverrideId) : 'None (using class default)'}</span></p>
                </div>
                ${hasCustomSchedule ? `<p class="text-amber-300"><i class="fa-solid fa-calendar-check"></i> Custom Schedule: ${customSchedule.rows.length} payment(s) defined</p>` : ''}
              </div>
              <div class="flex flex-wrap gap-2 text-xs">
                <button class="btn btn-ghost px-3" data-action="override-fee" data-student="${id}"><i class="fa-solid fa-money-bill"></i> Set Fee</button>
                <button class="btn btn-ghost px-3" data-action="override-plan" data-student="${id}"><i class="fa-solid fa-diagram-project"></i> Set Plan</button>
                <button class="btn btn-ghost px-3" data-action="override-custom" data-student="${id}"><i class="fa-solid fa-calendar-days"></i> ${hasCustomSchedule ? 'Edit' : 'Custom'} Schedule</button>
                <button class="btn btn-ghost px-3 bg-amber-600/20 text-amber-200" data-action="override-monthly" data-student="${id}"><i class="fa-solid fa-calendar-alt"></i> Monthly Plan…</button>
              </div>
            </article>
          `;
        }))).join('');
      } catch (err) {
        console.error('Error in renderOverrides:', err);
        panel.innerHTML = '<div class="text-sm text-red-300">Error searching. Check console.</div>';
      }
    }

    async function setStudentOverride(studentId, payload, options = {}) {
      const year = state.year;
      const path = `${pathOverrides(year)}/${studentId}`;
      const before = await reader(path) || {};
      const merged = { ...before, ...payload, updatedAt: now(), updatedBy: currentUser() };
      await writer(path, merged);
      await writeHistory(year, 'overrides', studentId, 'update', before, merged);
      if (!options.silent) {
        const message = options.toastMessage || 'Override saved';
        toast(message);
      }
      const q = $('#studentQuery').value;
      renderOverrides(q);
    }

    async function clearStudentOverride(studentId) {
      const year = state.year;
      const path = `${pathOverrides(year)}/${studentId}`;
      const before = await reader(path) || {};
      await writer(path, null);
      await writeHistory(year, 'overrides', studentId, 'delete', before, null);
      toast('Override cleared', 'warn');
      const q = $('#studentQuery').value;
      renderOverrides(q);
    }

    async function setOverrideFee(studentId) {
      const year = state.year;
      const student = await db.ref(`students/${studentId}`).once('value').then(s => s.val());
      const studentClass = student?.classLevel || student?.className || '';
      const classFee = await window.financePlansService.getClassFeePerYear(studentClass);
      const currentOverride = await window.financePlansService.getStudentFee(studentId);
      
      const defaultText = currentOverride !== null ? `Current override: ${fmtMoney(currentOverride)}` : `Class default: ${fmtMoney(classFee)}`;
      const value = prompt(`Enter fee override amount (TSh):\n${defaultText}\n\nLeave empty to use class default.`);
      if (value == null) return;
      
      if (value.trim() === '') {
        // Clear override - remove from new structure, keep in old for history
        const path = `${pathOverrides(year)}/${studentId}`;
        const before = await reader(path) || {};
        const updated = { ...before };
        delete updated.feePerYear;
        await writer(path, updated);
        await writeHistory(year, 'overrides', studentId, 'update', before, updated);
        toast('Fee override cleared');
      } else {
        const fee = Math.max(0, Number(value) || 0);
        // Use unified service
        await window.financePlansService.setStudentFee(studentId, fee, { by: currentUser() });
        // Also update old structure
        await setStudentOverride(studentId, { feePerYear: fee }, { toastMessage: 'Fee override saved' });
      }
      const q = $('#studentQuery').value;
      renderOverrides(q);
    }

    async function setOverridePlan(studentId) {
      const year = state.year;
      const student = await db.ref(`students/${studentId}`).once('value').then(s => s.val());
      const studentClass = student?.classLevel || student?.className || '';
      const classPlanId = await window.financePlansService.getClassDefaultPlanId(studentClass);
      const classPlan = classPlanId ? (await window.financePlansService.getPlan(classPlanId)) : null;
      const currentOverride = await window.financePlansService.getStudentPlan(studentId);
      
      const planOptions = Object.keys(state.plans).map((id) => {
        const plan = state.plans[id];
        const isDefault = id === classPlanId;
        const isCurrent = id === currentOverride;
        return `${isCurrent ? '→ ' : ''}${id} · ${plan.name || id}${isDefault ? ' (Class Default)' : ''}`;
      }).join('\n');
      
      const defaultText = classPlan ? `\nClass default: ${classPlan.name || classPlanId}\n` : '';
      const currentText = currentOverride ? `Current override: ${currentOverride}\n` : '';
      const pick = prompt(`Select plan ID:\n${currentText}${defaultText}\n${planOptions}\n\nLeave empty to use class default.`);
      if (pick == null) return;
      
      if (pick.trim() === '') {
        // Clear override
        const path = `${pathOverrides(year)}/${studentId}`;
        const before = await reader(path) || {};
        const updated = { ...before };
        delete updated.planId;
        delete updated.planName;
        delete updated.paymentPlan;
        await writer(path, updated);
        await writeHistory(year, 'overrides', studentId, 'update', before, updated);
        toast('Plan override cleared');
      } else {
        const id = pick.trim();
        if (!id) return;
        // Use unified service
        await window.financePlansService.assignStudentPlan(studentId, id, { by: currentUser() });
        // Also update old structure
        const plan = state.plans[id] || await window.financePlansService.getPlan(id);
        const planName = plan?.name || id;
        await setStudentOverride(
          studentId,
          { planId: id, planName, paymentPlan: planName },
          { toastMessage: 'Plan override saved' }
        );
      }
      const q = $('#studentQuery').value;
      renderOverrides(q);
    }

    async function setOverrideCustom(studentId) {
      const year = state.year;
      const customData = await window.financePlansService.getCustomSchedule(studentId);
      const existingRows = customData?.rows || [];
      
      // Build table editor UI
      const rowsHTML = existingRows.map((row, idx) => `
        <tr data-row="${idx}">
          <td class="px-2 py-1 border border-slate-700/40">
            <input type="text" class="custom-label input bg-slate-900/40 border-slate-700/60 text-xs" value="${(row.label || '').replace(/"/g, '&quot;')}" placeholder="Label" />
          </td>
          <td class="px-2 py-1 border border-slate-700/40">
            <input type="date" class="custom-from input bg-slate-900/40 border-slate-700/60 text-xs" value="${row.from || ''}" />
          </td>
          <td class="px-2 py-1 border border-slate-700/40">
            <input type="date" class="custom-to input bg-slate-900/40 border-slate-700/60 text-xs" value="${row.to || ''}" />
          </td>
          <td class="px-2 py-1 border border-slate-700/40">
            <input type="number" class="custom-amount input bg-slate-900/40 border-slate-700/60 text-xs" value="${row.amount || 0}" min="0" placeholder="Amount" />
          </td>
          <td class="px-2 py-1 border border-slate-700/40 text-center">
            <button type="button" class="btn btn-danger px-2 py-1 text-xs remove-row" data-row="${idx}"><i class="fa-solid fa-trash"></i></button>
          </td>
        </tr>
      `).join('');
      
      openModal(`
        <div class="space-y-4 text-sm">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-lg font-semibold text-slate-100">Custom Payment Schedule</h3>
              <p class="text-xs text-slate-400">Define individual payment windows for this student. This overrides the class plan.</p>
            </div>
            <button class="text-slate-400 hover:text-slate-100" onclick="(${closeModal.toString()})();"><i class="fa-solid fa-xmark text-lg"></i></button>
          </div>
          
          <div class="bg-slate-900/30 border border-slate-700/40 rounded-lg p-3 text-xs text-slate-300">
            <p><strong>Instructions:</strong></p>
            <ul class="list-disc list-inside mt-1 space-y-1">
              <li>Label: Name for this payment (e.g., "Term 1", "First Installment")</li>
              <li>From/To: Payment window dates</li>
              <li>Amount: Payment amount in TSh</li>
              <li>Click "Add Row" to add more payments</li>
            </ul>
          </div>
          
          <div class="overflow-x-auto">
            <table class="w-full text-xs border border-slate-700/40">
              <thead>
                <tr class="bg-slate-900/50">
                  <th class="px-2 py-2 border border-slate-700/40 text-left">Label</th>
                  <th class="px-2 py-2 border border-slate-700/40 text-left">From Date</th>
                  <th class="px-2 py-2 border border-slate-700/40 text-left">To Date</th>
                  <th class="px-2 py-2 border border-slate-700/40 text-left">Amount (TSh)</th>
                  <th class="px-2 py-2 border border-slate-700/40 text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="customScheduleRows">
                ${rowsHTML || '<tr><td colspan="5" class="px-2 py-4 text-center text-slate-400 border border-slate-700/40">No rows yet. Click "Add Row" to start.</td></tr>'}
              </tbody>
            </table>
          </div>
          
          <div class="flex justify-between items-center">
            <button type="button" class="btn btn-primary px-3" id="addCustomRow"><i class="fa-solid fa-plus"></i> Add Row</button>
            <div class="flex gap-2">
              <button class="btn btn-ghost" onclick="(${closeModal.toString()})();">Cancel</button>
              <button class="btn btn-primary" id="saveCustomSchedule">Save Custom Schedule</button>
            </div>
          </div>
        </div>
      `);
      
      // Add row functionality
      let rowCounter = existingRows.length;
      $('#addCustomRow').addEventListener('click', () => {
        const tbody = document.getElementById('customScheduleRows');
        if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
        const tr = document.createElement('tr');
        tr.setAttribute('data-row', rowCounter);
        tr.innerHTML = `
          <td class="px-2 py-1 border border-slate-700/40">
            <input type="text" class="custom-label input bg-slate-900/40 border-slate-700/60 text-xs" placeholder="Label" />
          </td>
          <td class="px-2 py-1 border border-slate-700/40">
            <input type="date" class="custom-from input bg-slate-900/40 border-slate-700/60 text-xs" />
          </td>
          <td class="px-2 py-1 border border-slate-700/40">
            <input type="date" class="custom-to input bg-slate-900/40 border-slate-700/60 text-xs" />
          </td>
          <td class="px-2 py-1 border border-slate-700/40">
            <input type="number" class="custom-amount input bg-slate-900/40 border-slate-700/60 text-xs" value="0" min="0" placeholder="Amount" />
          </td>
          <td class="px-2 py-1 border border-slate-700/40 text-center">
            <button type="button" class="btn btn-danger px-2 py-1 text-xs remove-row" data-row="${rowCounter}"><i class="fa-solid fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
        rowCounter++;
      });
      
      // Remove row functionality
      document.getElementById('modalRoot').addEventListener('click', (ev) => {
        if (ev.target.closest('.remove-row')) {
          const btn = ev.target.closest('.remove-row');
          const rowIdx = btn.getAttribute('data-row');
          const row = document.querySelector(`tr[data-row="${rowIdx}"]`);
          if (row) row.remove();
          const tbody = document.getElementById('customScheduleRows');
          if (!tbody.children.length) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-2 py-4 text-center text-slate-400 border border-slate-700/40">No rows yet. Click "Add Row" to start.</td></tr>';
          }
        }
      });
      
      // Save functionality
      $('#saveCustomSchedule').addEventListener('click', async () => {
        const rows = [];
        document.querySelectorAll('#customScheduleRows tr[data-row]').forEach((tr) => {
          const label = tr.querySelector('.custom-label')?.value?.trim();
          const from = tr.querySelector('.custom-from')?.value?.trim();
          const to = tr.querySelector('.custom-to')?.value?.trim();
          const amount = Math.max(0, Number(tr.querySelector('.custom-amount')?.value || 0));
          if (label && from && to) {
            rows.push({ label, from, to, amount });
          }
        });
        
        if (rows.length === 0) {
          // Clear custom schedule
          await window.financePlansService.setCustomSchedule(studentId, [], 'Cleared', { by: currentUser() });
          const path = `${pathOverrides(year)}/${studentId}`;
          const before = await reader(path) || {};
          const updated = { ...before };
          delete updated.customSchedule;
          await writer(path, updated);
          await writeHistory(year, 'overrides', studentId, 'update', before, updated);
          toast('Custom schedule cleared successfully');
        } else {
          // Save custom schedule
          await window.financePlansService.setCustomSchedule(studentId, rows, 'Custom schedule', { by: currentUser() });
          await setStudentOverride(
            studentId,
            { customSchedule: rows },
            { toastMessage: 'Custom schedule saved successfully' }
          );
        }
        closeModal();
        const q = $('#studentQuery').value;
        renderOverrides(q);
      });
    }

    $('#studentQuery').addEventListener('input', (ev) => {
      const q = ev.target.value.trim();
      if (q.length < 2) {
        $('#studentPanel').innerHTML = '<div class="text-sm text-slate-400">Type at least 2 characters to search.</div>';
        return;
      }
      renderOverrides(q);
    });

    $('#btnFindStudent').addEventListener('click', () => {
      const q = $('#studentQuery').value.trim();
      if (q.length < 2) {
        toast('Enter at least 2 characters', 'warn');
        return;
      }
      renderOverrides(q);
    });

    $('#btnClearStudent').addEventListener('click', () => {
      $('#studentQuery').value = '';
      $('#studentPanel').innerHTML = '<div class="text-sm text-slate-400">Search for a student to view overrides.</div>';
    });

    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-action^="override"]');
      if (!btn) return;
      const studentId = btn.getAttribute('data-student');
      const action = btn.getAttribute('data-action');
      if (action === 'override-clear') clearStudentOverride(studentId);
      if (action === 'override-fee') setOverrideFee(studentId);
      if (action === 'override-plan') setOverridePlan(studentId);
      if (action === 'override-custom') setOverrideCustom(studentId);
      if (action === 'override-monthly') {
        (async () => {
          const studentData = await db.ref(`students/${studentId}`).once('value').then(s => s.val()).catch(() => null);
          const studentName = studentData ? `${studentData.firstName || ''} ${studentData.lastName || ''}`.trim() : studentId;
          const year = state.year || window.somapYearContext?.getSelectedYear() || SOMAP_DEFAULT_YEAR;
          const studentClass = await window.financePlansService.resolveClassForYearSimple(studentId, year);
          openMonthlyPlanModal({ attachTo: 'student', studentId, studentName, className: studentClass });
        })();
      }
    });

    // Ensure year context is initialized before using service
    if (!window.somapYearContext) {
      window.somapYearContext = (function () {
        let selected = String(sessionStorage.getItem('somap_selected_year') || SOMAP_DEFAULT_YEAR);
        const listeners = new Set();
        return {
          getSelectedYear() { return selected; },
          setSelectedYear(y) {
            const val = String(y);
            if (val === selected) return;
            selected = val;
            try { sessionStorage.setItem('somap_selected_year', val); } catch (e) { console.warn(e); }
            listeners.forEach((fn) => { try { fn(val); } catch (err) { console.error(err); } });
          },
          onYearChanged(fn) { if (typeof fn === 'function') listeners.add(fn); }
        };
      })();
    }

    window.somapYearContext.onYearChanged(() => {
      refreshAll();
      // Re-run search if there's a query
      const q = $('#studentQuery')?.value?.trim();
      if (q && q.length >= 2) {
        renderOverrides(q);
      }
    });

    // Monthly Plan Modal functionality
    const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    let modal, ctx, elPlanId, elPlanName, elAmt, elFrom, elLen, elDbl, elAssignClass, prevBtn, saveBtn, saveApplyBtn, prevBox;
    let MP_STATE = { attachTo: null, className: null, studentId: null, studentName: null };

    let elExcluded;
    
    function initMonthlyPlanModal() {
      modal = document.getElementById('monthlyPlanModal');
      ctx = document.getElementById('mpContext');
      elPlanId = document.getElementById('mpPlanId');
      elPlanName = document.getElementById('mpPlanName');
      elAmt = document.getElementById('mpAmount');
      elFrom = document.getElementById('mpFromDay');
      elLen = document.getElementById('mpWindowLen');
      elDbl = document.getElementById('mpDoubles');
      elExcluded = document.getElementById('mpExcluded');
      elAssignClass = document.getElementById('mpAssignClass');
      prevBtn = document.getElementById('mpPreview');
      saveBtn = document.getElementById('mpSave');
      saveApplyBtn = document.getElementById('mpSaveAndApply');
      prevBox = document.getElementById('mpPreviewBox');
      
      fillDoubleMonthChecks();
      fillExcludedMonthChecks();
      
      if (document.getElementById('mpClose')) {
        document.getElementById('mpClose').onclick = closeMonthlyPlanModal;
      }
      
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeMonthlyPlanModal();
          }
        });
      }
      
      if (prevBtn) {
        prevBtn.onclick = () => previewSchedule();
      }
      
      if (saveBtn) {
        saveBtn.onclick = () => savePlan({ applyToStudent: false });
      }
      
      if (saveApplyBtn) {
        saveApplyBtn.onclick = () => savePlan({ applyToStudent: true });
      }
    }

    function fillDoubleMonthChecks() {
      if (!elDbl) return;
      elDbl.innerHTML = MONTHS.map((m, i) => `
        <label class="inline-flex items-center gap-1 text-xs">
          <input type="checkbox" value="${i + 1}" class="mpDbl">
          ${m}
        </label>
      `).join('');
    }

    function fillExcludedMonthChecks() {
      if (!elExcluded) return;
      elExcluded.innerHTML = MONTHS.map((m, i) => `
        <label class="inline-flex items-center gap-1 text-xs font-medium text-slate-100 cursor-pointer">
          <input type="checkbox" value="${i + 1}" class="mpExcluded" title="Exclude ${m} from payment">
          <span class="text-rose-400">✕</span> <span>${m}</span>
        </label>
      `).join('');
    }

    async function openMonthlyPlanModal({ attachTo, className = null, studentId = null, studentName = null }) {
      MP_STATE = { attachTo, className, studentId, studentName };
      const year = state.year || window.somapYearContext?.getSelectedYear() || SOMAP_DEFAULT_YEAR;
      
      if (ctx) {
        let hint = attachTo === 'class'
          ? `Target: Class ${className} · Year ${year}`
          : `Target: Student ${studentName || studentId} · Year ${year}`;
        if (attachTo === 'student' && studentId && window.financePlansService) {
          try {
            const studentClass = (await db.ref(`students/${studentId}`).once('value')).val()?.classLevel || '';
            const classPlanId = studentClass ? await window.financePlansService.getClassDefaultPlanId(studentClass) : null;
            const overridePlanId = await window.financePlansService.getStudentPlan(studentId);
            const effectivePlanId = overridePlanId || classPlanId;
            const plan = effectivePlanId ? (state.plans[effectivePlanId] || await window.financePlansService.getPlan(effectivePlanId)) : null;
            const currentPlanName = plan?.name || effectivePlanId || 'Class default';
            hint += ` · Current effective plan: ${currentPlanName}`;
            const isMonthly = String(currentPlanName || '').toLowerCase().includes('monthly');
            if (!isMonthly) hint += ' · Switching to monthly plan';
          } catch (_) {}
        }
        ctx.textContent = hint;
      }
      
      if (elPlanId) elPlanId.value = elPlanId.value || 'monthly-40k-standard';
      if (elPlanName) elPlanName.value = elPlanName.value || 'Monthly (40k) — Standard';
      if (elAmt) elAmt.value = elAmt.value || 40000;
      if (elFrom) elFrom.value = elFrom.value || 1;
      if (elLen) elLen.value = elLen.value || 10;
      if (elAssignClass) elAssignClass.checked = (attachTo === 'class');
      if (prevBox) prevBox.classList.add('hidden');
      
      fillDoubleMonthChecks();
      fillExcludedMonthChecks();
      
      if (modal) {
        modal.style.display = 'flex';
        modal.classList.remove('hidden');
      }
    }
    window.openMonthlyPlanModal = openMonthlyPlanModal;

    function closeMonthlyPlanModal() {
      if (modal) {
        modal.style.display = 'none';
        modal.classList.add('hidden');
      }
    }

    function getSelectedDoubleMonths() {
      if (!elDbl) return [];
      return Array.from(elDbl.querySelectorAll('.mpDbl'))
        .filter(x => x.checked)
        .map(x => Number(x.value)); // 1..12
    }

    function getExcludedMonths() {
      if (!elExcluded) return [];
      return Array.from(elExcluded.querySelectorAll('.mpExcluded'))
        .filter(x => x.checked)
        .map(x => Number(x.value)); // 1..12
    }

    function buildMonthlySchedule(monthlyAmount, fromDay, winLen, doubleMonths, excludedMonths) {
      monthlyAmount = parseAmountInput(monthlyAmount);
      const pad = (n) => String(n).padStart(2, '0');
      const rows = [];
      for (let m = 1; m <= 12; m++) {
        // Skip excluded months
        if (excludedMonths && excludedMonths.includes(m)) {
          continue;
        }
        const amt = monthlyAmount * (doubleMonths.includes(m) ? 2 : 1);
        const from = `${pad(m)}-${pad(fromDay)}`;
        const toDay = Math.min(fromDay + winLen - 1, 28);
        const to = `${pad(m)}-${pad(toDay)}`;
        rows.push({
          label: `Monthly: ${MONTHS[m - 1]}`,
          from, to, amount: amt, weight: 1
        });
      }
      return rows;
    }

    function parseAmountInput(val) {
      // Accept formats like "7000", "7,000", "7k", "40K"
      let raw = String(val || '').trim().toLowerCase();
      if (!raw) return 0;
      raw = raw.replace(/,/g, '').replace(/\s+/g, '');
      let mult = 1;
      if (raw.endsWith('k')) {
        mult = 1000;
        raw = raw.slice(0, -1);
      }
      const num = Number(raw.replace(/[^\d.-]/g, ''));
      const out = (Number.isFinite(num) ? num : 0) * mult;
      return Math.max(0, Math.round(out));
    }

    function previewSchedule() {
      if (!elPlanId || !elPlanName || !elAmt || !elFrom || !elLen || !prevBox) return null;
      
      const planId = elPlanId.value.trim();
      const planName = elPlanName.value.trim();
      const monthlyAmount = parseAmountInput(elAmt.value);
      const fromDay = Math.max(1, Math.min(28, Number(elFrom.value || 1)));
      const winLen = Math.max(3, Math.min(20, Number(elLen.value || 10)));
      const dbl = getSelectedDoubleMonths();
      const excluded = getExcludedMonths();
      const rows = buildMonthlySchedule(monthlyAmount, fromDay, winLen, dbl, excluded);
      const total = rows.reduce((a, b) => a + Number(b.amount || 0), 0);
      
      prevBox.innerHTML = `
        <div class="text-xs text-slate-600 mb-1">Plan ID: <b>${planId}</b> · Name: <b>${planName}</b> · Rows: ${rows.length} · Total: ${total.toLocaleString('en-KE')}</div>
        <table class="w-full text-xs border">
          <thead><tr class="bg-slate-100"><th class="p-1 text-left">Label</th><th class="p-1">Window</th><th class="p-1">Amount</th></tr></thead>
          <tbody>
            ${rows.map(r => `<tr><td class="p-1">${r.label}</td><td class="p-1">${r.from} → ${r.to}</td><td class="p-1">${Number(r.amount).toLocaleString('en-KE')}</td></tr>`).join('')}
          </tbody>
        </table>
      `;
      prevBox.classList.remove('hidden');
      return { planId, planName, rows };
    }

    async function savePlan({ applyToStudent = false } = {}) {
      const preview = previewSchedule();
      if (!preview) return;
      
      const { planId, planName, rows } = preview;
      const year = state.year || window.somapYearContext?.getSelectedYear() || SOMAP_DEFAULT_YEAR;
      
      try {
        // Save plan blueprint
        const payload = {
          name: planName,
          isActive: true,
          schedule: rows,
          updatedAt: Date.now(),
          updatedBy: currentUser()
        };
        
        await window.financePlansService.upsertPlan(planId, payload, { year });
        await writer(`${pathPlans(year)}/${planId}`, payload);
        
        if (MP_STATE.attachTo === 'class' && elAssignClass?.checked && MP_STATE.className) {
          // Calculate total fee from monthly schedule
          const totalFee = rows.reduce((sum, row) => sum + (Number(row.amount) || 0), 0);
          // Update class with monthly plan and total fee
          await window.financePlansService.upsertClassFeeAndPlan(MP_STATE.className, totalFee, planId, { year, by: currentUser() });
          // Also update the old structure
          const classPath = `${pathFees(year)}/${MP_STATE.className}`;
          const classData = await reader(classPath) || {};
          await writer(classPath, {
            ...classData,
            feePerYear: totalFee,
            defaultPlanId: planId,
            defaultPlan: planId,
            updatedAt: Date.now(),
            updatedBy: currentUser()
          });
        }
        
        if (applyToStudent && MP_STATE.studentId) {
          await window.financePlansService.setStudentPlanOverride(MP_STATE.studentId, planId, { year, by: currentUser() });
          await setStudentOverride(MP_STATE.studentId, { planId, planName, paymentPlan: planName }, { silent: true });
        }
        
        toast('Monthly plan saved.');
        
        closeMonthlyPlanModal();
        
        await refreshAll();
        const q = $('#studentQuery')?.value?.trim();
        if (q && q.length >= 2) {
          renderOverrides(q);
        }
      } catch (err) {
        console.error('Error saving monthly plan:', err);
        toast('Error saving plan', 'error');
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize Monthly Plan Modal
      initMonthlyPlanModal();
      try {
        // Ensure year selector is initialized
        const select = document.querySelector('[data-somap-year-select]');
        const hint = document.getElementById('somapYearHint');
        if (select && !select.innerHTML) {
          select.innerHTML = SOMAP_ALLOWED_YEARS.map((y) => `<option value="${y}">${y}</option>`).join('');
          const current = window.somapYearContext.getSelectedYear();
          select.value = current;
          if (hint) hint.textContent = current;
          select.addEventListener('change', (ev) => {
            const chosen = String(ev.target.value);
            window.somapYearContext.setSelectedYear(chosen);
            if (hint) hint.textContent = chosen;
          });
        }
        
        populateClassPicker();
        // Small delay to ensure everything is initialized
        await new Promise(resolve => setTimeout(resolve, 200));
        await refreshAll();
      } catch (err) {
        console.error('Error on page load:', err);
        toast('Error loading page data: ' + (err.message || 'Unknown'), 'error');
      }
    });
    })();
  </script>
</body>
</html>


